(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const l of a)if(l.type==="childList")for(const n of l.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function r(a){const l={};return a.integrity&&(l.integrity=a.integrity),a.referrerPolicy&&(l.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?l.credentials="include":a.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(a){if(a.ep)return;a.ep=!0;const l=r(a);fetch(a.href,l)}})();/**
* @vue/shared v3.5.13
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**//*! #__NO_SIDE_EFFECTS__ */function makeMap(t){const e=Object.create(null);for(const r of t.split(","))e[r]=1;return r=>r in e}const EMPTY_OBJ={},EMPTY_ARR=[],NOOP=()=>{},NO=()=>!1,isOn=t=>t.charCodeAt(0)===111&&t.charCodeAt(1)===110&&(t.charCodeAt(2)>122||t.charCodeAt(2)<97),isModelListener=t=>t.startsWith("onUpdate:"),extend=Object.assign,remove=(t,e)=>{const r=t.indexOf(e);r>-1&&t.splice(r,1)},hasOwnProperty$1=Object.prototype.hasOwnProperty,hasOwn=(t,e)=>hasOwnProperty$1.call(t,e),isArray=Array.isArray,isMap=t=>toTypeString(t)==="[object Map]",isSet=t=>toTypeString(t)==="[object Set]",isFunction=t=>typeof t=="function",isString=t=>typeof t=="string",isSymbol=t=>typeof t=="symbol",isObject=t=>t!==null&&typeof t=="object",isPromise=t=>(isObject(t)||isFunction(t))&&isFunction(t.then)&&isFunction(t.catch),objectToString=Object.prototype.toString,toTypeString=t=>objectToString.call(t),toRawType=t=>toTypeString(t).slice(8,-1),isPlainObject=t=>toTypeString(t)==="[object Object]",isIntegerKey=t=>isString(t)&&t!=="NaN"&&t[0]!=="-"&&""+parseInt(t,10)===t,isReservedProp=makeMap(",key,ref,ref_for,ref_key,onVnodeBeforeMount,onVnodeMounted,onVnodeBeforeUpdate,onVnodeUpdated,onVnodeBeforeUnmount,onVnodeUnmounted"),cacheStringFunction=t=>{const e=Object.create(null);return r=>e[r]||(e[r]=t(r))},camelizeRE=/-(\w)/g,camelize=cacheStringFunction(t=>t.replace(camelizeRE,(e,r)=>r?r.toUpperCase():"")),hyphenateRE=/\B([A-Z])/g,hyphenate=cacheStringFunction(t=>t.replace(hyphenateRE,"-$1").toLowerCase()),capitalize=cacheStringFunction(t=>t.charAt(0).toUpperCase()+t.slice(1)),toHandlerKey=cacheStringFunction(t=>t?`on${capitalize(t)}`:""),hasChanged=(t,e)=>!Object.is(t,e),invokeArrayFns=(t,...e)=>{for(let r=0;r<t.length;r++)t[r](...e)},def=(t,e,r,i=!1)=>{Object.defineProperty(t,e,{configurable:!0,enumerable:!1,writable:i,value:r})},looseToNumber=t=>{const e=parseFloat(t);return isNaN(e)?t:e};let _globalThis;const getGlobalThis=()=>_globalThis||(_globalThis=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{});function normalizeStyle(t){if(isArray(t)){const e={};for(let r=0;r<t.length;r++){const i=t[r],a=isString(i)?parseStringStyle(i):normalizeStyle(i);if(a)for(const l in a)e[l]=a[l]}return e}else if(isString(t)||isObject(t))return t}const listDelimiterRE=/;(?![^(]*\))/g,propertyDelimiterRE=/:([^]+)/,styleCommentRE=/\/\*[^]*?\*\//g;function parseStringStyle(t){const e={};return t.replace(styleCommentRE,"").split(listDelimiterRE).forEach(r=>{if(r){const i=r.split(propertyDelimiterRE);i.length>1&&(e[i[0].trim()]=i[1].trim())}}),e}function normalizeClass(t){let e="";if(isString(t))e=t;else if(isArray(t))for(let r=0;r<t.length;r++){const i=normalizeClass(t[r]);i&&(e+=i+" ")}else if(isObject(t))for(const r in t)t[r]&&(e+=r+" ");return e.trim()}const specialBooleanAttrs="itemscope,allowfullscreen,formnovalidate,ismap,nomodule,novalidate,readonly",isSpecialBooleanAttr=makeMap(specialBooleanAttrs);function includeBooleanAttr(t){return!!t||t===""}/**
* @vue/reactivity v3.5.13
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**/let activeEffectScope;class EffectScope{constructor(e=!1){this.detached=e,this._active=!0,this.effects=[],this.cleanups=[],this._isPaused=!1,this.parent=activeEffectScope,!e&&activeEffectScope&&(this.index=(activeEffectScope.scopes||(activeEffectScope.scopes=[])).push(this)-1)}get active(){return this._active}pause(){if(this._active){this._isPaused=!0;let e,r;if(this.scopes)for(e=0,r=this.scopes.length;e<r;e++)this.scopes[e].pause();for(e=0,r=this.effects.length;e<r;e++)this.effects[e].pause()}}resume(){if(this._active&&this._isPaused){this._isPaused=!1;let e,r;if(this.scopes)for(e=0,r=this.scopes.length;e<r;e++)this.scopes[e].resume();for(e=0,r=this.effects.length;e<r;e++)this.effects[e].resume()}}run(e){if(this._active){const r=activeEffectScope;try{return activeEffectScope=this,e()}finally{activeEffectScope=r}}}on(){activeEffectScope=this}off(){activeEffectScope=this.parent}stop(e){if(this._active){this._active=!1;let r,i;for(r=0,i=this.effects.length;r<i;r++)this.effects[r].stop();for(this.effects.length=0,r=0,i=this.cleanups.length;r<i;r++)this.cleanups[r]();if(this.cleanups.length=0,this.scopes){for(r=0,i=this.scopes.length;r<i;r++)this.scopes[r].stop(!0);this.scopes.length=0}if(!this.detached&&this.parent&&!e){const a=this.parent.scopes.pop();a&&a!==this&&(this.parent.scopes[this.index]=a,a.index=this.index)}this.parent=void 0}}}function getCurrentScope(){return activeEffectScope}let activeSub;const pausedQueueEffects=new WeakSet;class ReactiveEffect{constructor(e){this.fn=e,this.deps=void 0,this.depsTail=void 0,this.flags=5,this.next=void 0,this.cleanup=void 0,this.scheduler=void 0,activeEffectScope&&activeEffectScope.active&&activeEffectScope.effects.push(this)}pause(){this.flags|=64}resume(){this.flags&64&&(this.flags&=-65,pausedQueueEffects.has(this)&&(pausedQueueEffects.delete(this),this.trigger()))}notify(){this.flags&2&&!(this.flags&32)||this.flags&8||batch(this)}run(){if(!(this.flags&1))return this.fn();this.flags|=2,cleanupEffect(this),prepareDeps(this);const e=activeSub,r=shouldTrack;activeSub=this,shouldTrack=!0;try{return this.fn()}finally{cleanupDeps(this),activeSub=e,shouldTrack=r,this.flags&=-3}}stop(){if(this.flags&1){for(let e=this.deps;e;e=e.nextDep)removeSub(e);this.deps=this.depsTail=void 0,cleanupEffect(this),this.onStop&&this.onStop(),this.flags&=-2}}trigger(){this.flags&64?pausedQueueEffects.add(this):this.scheduler?this.scheduler():this.runIfDirty()}runIfDirty(){isDirty(this)&&this.run()}get dirty(){return isDirty(this)}}let batchDepth=0,batchedSub,batchedComputed;function batch(t,e=!1){if(t.flags|=8,e){t.next=batchedComputed,batchedComputed=t;return}t.next=batchedSub,batchedSub=t}function startBatch(){batchDepth++}function endBatch(){if(--batchDepth>0)return;if(batchedComputed){let e=batchedComputed;for(batchedComputed=void 0;e;){const r=e.next;e.next=void 0,e.flags&=-9,e=r}}let t;for(;batchedSub;){let e=batchedSub;for(batchedSub=void 0;e;){const r=e.next;if(e.next=void 0,e.flags&=-9,e.flags&1)try{e.trigger()}catch(i){t||(t=i)}e=r}}if(t)throw t}function prepareDeps(t){for(let e=t.deps;e;e=e.nextDep)e.version=-1,e.prevActiveLink=e.dep.activeLink,e.dep.activeLink=e}function cleanupDeps(t){let e,r=t.depsTail,i=r;for(;i;){const a=i.prevDep;i.version===-1?(i===r&&(r=a),removeSub(i),removeDep(i)):e=i,i.dep.activeLink=i.prevActiveLink,i.prevActiveLink=void 0,i=a}t.deps=e,t.depsTail=r}function isDirty(t){for(let e=t.deps;e;e=e.nextDep)if(e.dep.version!==e.version||e.dep.computed&&(refreshComputed(e.dep.computed)||e.dep.version!==e.version))return!0;return!!t._dirty}function refreshComputed(t){if(t.flags&4&&!(t.flags&16)||(t.flags&=-17,t.globalVersion===globalVersion))return;t.globalVersion=globalVersion;const e=t.dep;if(t.flags|=2,e.version>0&&!t.isSSR&&t.deps&&!isDirty(t)){t.flags&=-3;return}const r=activeSub,i=shouldTrack;activeSub=t,shouldTrack=!0;try{prepareDeps(t);const a=t.fn(t._value);(e.version===0||hasChanged(a,t._value))&&(t._value=a,e.version++)}catch(a){throw e.version++,a}finally{activeSub=r,shouldTrack=i,cleanupDeps(t),t.flags&=-3}}function removeSub(t,e=!1){const{dep:r,prevSub:i,nextSub:a}=t;if(i&&(i.nextSub=a,t.prevSub=void 0),a&&(a.prevSub=i,t.nextSub=void 0),r.subs===t&&(r.subs=i,!i&&r.computed)){r.computed.flags&=-5;for(let l=r.computed.deps;l;l=l.nextDep)removeSub(l,!0)}!e&&!--r.sc&&r.map&&r.map.delete(r.key)}function removeDep(t){const{prevDep:e,nextDep:r}=t;e&&(e.nextDep=r,t.prevDep=void 0),r&&(r.prevDep=e,t.nextDep=void 0)}let shouldTrack=!0;const trackStack=[];function pauseTracking(){trackStack.push(shouldTrack),shouldTrack=!1}function resetTracking(){const t=trackStack.pop();shouldTrack=t===void 0?!0:t}function cleanupEffect(t){const{cleanup:e}=t;if(t.cleanup=void 0,e){const r=activeSub;activeSub=void 0;try{e()}finally{activeSub=r}}}let globalVersion=0;class Link{constructor(e,r){this.sub=e,this.dep=r,this.version=r.version,this.nextDep=this.prevDep=this.nextSub=this.prevSub=this.prevActiveLink=void 0}}class Dep{constructor(e){this.computed=e,this.version=0,this.activeLink=void 0,this.subs=void 0,this.map=void 0,this.key=void 0,this.sc=0}track(e){if(!activeSub||!shouldTrack||activeSub===this.computed)return;let r=this.activeLink;if(r===void 0||r.sub!==activeSub)r=this.activeLink=new Link(activeSub,this),activeSub.deps?(r.prevDep=activeSub.depsTail,activeSub.depsTail.nextDep=r,activeSub.depsTail=r):activeSub.deps=activeSub.depsTail=r,addSub(r);else if(r.version===-1&&(r.version=this.version,r.nextDep)){const i=r.nextDep;i.prevDep=r.prevDep,r.prevDep&&(r.prevDep.nextDep=i),r.prevDep=activeSub.depsTail,r.nextDep=void 0,activeSub.depsTail.nextDep=r,activeSub.depsTail=r,activeSub.deps===r&&(activeSub.deps=i)}return r}trigger(e){this.version++,globalVersion++,this.notify(e)}notify(e){startBatch();try{for(let r=this.subs;r;r=r.prevSub)r.sub.notify()&&r.sub.dep.notify()}finally{endBatch()}}}function addSub(t){if(t.dep.sc++,t.sub.flags&4){const e=t.dep.computed;if(e&&!t.dep.subs){e.flags|=20;for(let i=e.deps;i;i=i.nextDep)addSub(i)}const r=t.dep.subs;r!==t&&(t.prevSub=r,r&&(r.nextSub=t)),t.dep.subs=t}}const targetMap=new WeakMap,ITERATE_KEY=Symbol(""),MAP_KEY_ITERATE_KEY=Symbol(""),ARRAY_ITERATE_KEY=Symbol("");function track(t,e,r){if(shouldTrack&&activeSub){let i=targetMap.get(t);i||targetMap.set(t,i=new Map);let a=i.get(r);a||(i.set(r,a=new Dep),a.map=i,a.key=r),a.track()}}function trigger(t,e,r,i,a,l){const n=targetMap.get(t);if(!n){globalVersion++;return}const c=s=>{s&&s.trigger()};if(startBatch(),e==="clear")n.forEach(c);else{const s=isArray(t),d=s&&isIntegerKey(r);if(s&&r==="length"){const u=Number(i);n.forEach((h,o)=>{(o==="length"||o===ARRAY_ITERATE_KEY||!isSymbol(o)&&o>=u)&&c(h)})}else switch((r!==void 0||n.has(void 0))&&c(n.get(r)),d&&c(n.get(ARRAY_ITERATE_KEY)),e){case"add":s?d&&c(n.get("length")):(c(n.get(ITERATE_KEY)),isMap(t)&&c(n.get(MAP_KEY_ITERATE_KEY)));break;case"delete":s||(c(n.get(ITERATE_KEY)),isMap(t)&&c(n.get(MAP_KEY_ITERATE_KEY)));break;case"set":isMap(t)&&c(n.get(ITERATE_KEY));break}}endBatch()}function reactiveReadArray(t){const e=toRaw(t);return e===t?e:(track(e,"iterate",ARRAY_ITERATE_KEY),isShallow(t)?e:e.map(toReactive))}function shallowReadArray(t){return track(t=toRaw(t),"iterate",ARRAY_ITERATE_KEY),t}const arrayInstrumentations={__proto__:null,[Symbol.iterator](){return iterator(this,Symbol.iterator,toReactive)},concat(...t){return reactiveReadArray(this).concat(...t.map(e=>isArray(e)?reactiveReadArray(e):e))},entries(){return iterator(this,"entries",t=>(t[1]=toReactive(t[1]),t))},every(t,e){return apply(this,"every",t,e,void 0,arguments)},filter(t,e){return apply(this,"filter",t,e,r=>r.map(toReactive),arguments)},find(t,e){return apply(this,"find",t,e,toReactive,arguments)},findIndex(t,e){return apply(this,"findIndex",t,e,void 0,arguments)},findLast(t,e){return apply(this,"findLast",t,e,toReactive,arguments)},findLastIndex(t,e){return apply(this,"findLastIndex",t,e,void 0,arguments)},forEach(t,e){return apply(this,"forEach",t,e,void 0,arguments)},includes(...t){return searchProxy(this,"includes",t)},indexOf(...t){return searchProxy(this,"indexOf",t)},join(t){return reactiveReadArray(this).join(t)},lastIndexOf(...t){return searchProxy(this,"lastIndexOf",t)},map(t,e){return apply(this,"map",t,e,void 0,arguments)},pop(){return noTracking(this,"pop")},push(...t){return noTracking(this,"push",t)},reduce(t,...e){return reduce(this,"reduce",t,e)},reduceRight(t,...e){return reduce(this,"reduceRight",t,e)},shift(){return noTracking(this,"shift")},some(t,e){return apply(this,"some",t,e,void 0,arguments)},splice(...t){return noTracking(this,"splice",t)},toReversed(){return reactiveReadArray(this).toReversed()},toSorted(t){return reactiveReadArray(this).toSorted(t)},toSpliced(...t){return reactiveReadArray(this).toSpliced(...t)},unshift(...t){return noTracking(this,"unshift",t)},values(){return iterator(this,"values",toReactive)}};function iterator(t,e,r){const i=shallowReadArray(t),a=i[e]();return i!==t&&!isShallow(t)&&(a._next=a.next,a.next=()=>{const l=a._next();return l.value&&(l.value=r(l.value)),l}),a}const arrayProto=Array.prototype;function apply(t,e,r,i,a,l){const n=shallowReadArray(t),c=n!==t&&!isShallow(t),s=n[e];if(s!==arrayProto[e]){const h=s.apply(t,l);return c?toReactive(h):h}let d=r;n!==t&&(c?d=function(h,o){return r.call(this,toReactive(h),o,t)}:r.length>2&&(d=function(h,o){return r.call(this,h,o,t)}));const u=s.call(n,d,i);return c&&a?a(u):u}function reduce(t,e,r,i){const a=shallowReadArray(t);let l=r;return a!==t&&(isShallow(t)?r.length>3&&(l=function(n,c,s){return r.call(this,n,c,s,t)}):l=function(n,c,s){return r.call(this,n,toReactive(c),s,t)}),a[e](l,...i)}function searchProxy(t,e,r){const i=toRaw(t);track(i,"iterate",ARRAY_ITERATE_KEY);const a=i[e](...r);return(a===-1||a===!1)&&isProxy(r[0])?(r[0]=toRaw(r[0]),i[e](...r)):a}function noTracking(t,e,r=[]){pauseTracking(),startBatch();const i=toRaw(t)[e].apply(t,r);return endBatch(),resetTracking(),i}const isNonTrackableKeys=makeMap("__proto__,__v_isRef,__isVue"),builtInSymbols=new Set(Object.getOwnPropertyNames(Symbol).filter(t=>t!=="arguments"&&t!=="caller").map(t=>Symbol[t]).filter(isSymbol));function hasOwnProperty(t){isSymbol(t)||(t=String(t));const e=toRaw(this);return track(e,"has",t),e.hasOwnProperty(t)}class BaseReactiveHandler{constructor(e=!1,r=!1){this._isReadonly=e,this._isShallow=r}get(e,r,i){if(r==="__v_skip")return e.__v_skip;const a=this._isReadonly,l=this._isShallow;if(r==="__v_isReactive")return!a;if(r==="__v_isReadonly")return a;if(r==="__v_isShallow")return l;if(r==="__v_raw")return i===(a?l?shallowReadonlyMap:readonlyMap:l?shallowReactiveMap:reactiveMap).get(e)||Object.getPrototypeOf(e)===Object.getPrototypeOf(i)?e:void 0;const n=isArray(e);if(!a){let s;if(n&&(s=arrayInstrumentations[r]))return s;if(r==="hasOwnProperty")return hasOwnProperty}const c=Reflect.get(e,r,isRef(e)?e:i);return(isSymbol(r)?builtInSymbols.has(r):isNonTrackableKeys(r))||(a||track(e,"get",r),l)?c:isRef(c)?n&&isIntegerKey(r)?c:c.value:isObject(c)?a?readonly(c):reactive(c):c}}class MutableReactiveHandler extends BaseReactiveHandler{constructor(e=!1){super(!1,e)}set(e,r,i,a){let l=e[r];if(!this._isShallow){const s=isReadonly(l);if(!isShallow(i)&&!isReadonly(i)&&(l=toRaw(l),i=toRaw(i)),!isArray(e)&&isRef(l)&&!isRef(i))return s?!1:(l.value=i,!0)}const n=isArray(e)&&isIntegerKey(r)?Number(r)<e.length:hasOwn(e,r),c=Reflect.set(e,r,i,isRef(e)?e:a);return e===toRaw(a)&&(n?hasChanged(i,l)&&trigger(e,"set",r,i):trigger(e,"add",r,i)),c}deleteProperty(e,r){const i=hasOwn(e,r);e[r];const a=Reflect.deleteProperty(e,r);return a&&i&&trigger(e,"delete",r,void 0),a}has(e,r){const i=Reflect.has(e,r);return(!isSymbol(r)||!builtInSymbols.has(r))&&track(e,"has",r),i}ownKeys(e){return track(e,"iterate",isArray(e)?"length":ITERATE_KEY),Reflect.ownKeys(e)}}class ReadonlyReactiveHandler extends BaseReactiveHandler{constructor(e=!1){super(!0,e)}set(e,r){return!0}deleteProperty(e,r){return!0}}const mutableHandlers=new MutableReactiveHandler,readonlyHandlers=new ReadonlyReactiveHandler,shallowReactiveHandlers=new MutableReactiveHandler(!0),shallowReadonlyHandlers=new ReadonlyReactiveHandler(!0),toShallow=t=>t,getProto=t=>Reflect.getPrototypeOf(t);function createIterableMethod(t,e,r){return function(...i){const a=this.__v_raw,l=toRaw(a),n=isMap(l),c=t==="entries"||t===Symbol.iterator&&n,s=t==="keys"&&n,d=a[t](...i),u=r?toShallow:e?toReadonly:toReactive;return!e&&track(l,"iterate",s?MAP_KEY_ITERATE_KEY:ITERATE_KEY),{next(){const{value:h,done:o}=d.next();return o?{value:h,done:o}:{value:c?[u(h[0]),u(h[1])]:u(h),done:o}},[Symbol.iterator](){return this}}}}function createReadonlyMethod(t){return function(...e){return t==="delete"?!1:t==="clear"?void 0:this}}function createInstrumentations(t,e){const r={get(a){const l=this.__v_raw,n=toRaw(l),c=toRaw(a);t||(hasChanged(a,c)&&track(n,"get",a),track(n,"get",c));const{has:s}=getProto(n),d=e?toShallow:t?toReadonly:toReactive;if(s.call(n,a))return d(l.get(a));if(s.call(n,c))return d(l.get(c));l!==n&&l.get(a)},get size(){const a=this.__v_raw;return!t&&track(toRaw(a),"iterate",ITERATE_KEY),Reflect.get(a,"size",a)},has(a){const l=this.__v_raw,n=toRaw(l),c=toRaw(a);return t||(hasChanged(a,c)&&track(n,"has",a),track(n,"has",c)),a===c?l.has(a):l.has(a)||l.has(c)},forEach(a,l){const n=this,c=n.__v_raw,s=toRaw(c),d=e?toShallow:t?toReadonly:toReactive;return!t&&track(s,"iterate",ITERATE_KEY),c.forEach((u,h)=>a.call(l,d(u),d(h),n))}};return extend(r,t?{add:createReadonlyMethod("add"),set:createReadonlyMethod("set"),delete:createReadonlyMethod("delete"),clear:createReadonlyMethod("clear")}:{add(a){!e&&!isShallow(a)&&!isReadonly(a)&&(a=toRaw(a));const l=toRaw(this);return getProto(l).has.call(l,a)||(l.add(a),trigger(l,"add",a,a)),this},set(a,l){!e&&!isShallow(l)&&!isReadonly(l)&&(l=toRaw(l));const n=toRaw(this),{has:c,get:s}=getProto(n);let d=c.call(n,a);d||(a=toRaw(a),d=c.call(n,a));const u=s.call(n,a);return n.set(a,l),d?hasChanged(l,u)&&trigger(n,"set",a,l):trigger(n,"add",a,l),this},delete(a){const l=toRaw(this),{has:n,get:c}=getProto(l);let s=n.call(l,a);s||(a=toRaw(a),s=n.call(l,a)),c&&c.call(l,a);const d=l.delete(a);return s&&trigger(l,"delete",a,void 0),d},clear(){const a=toRaw(this),l=a.size!==0,n=a.clear();return l&&trigger(a,"clear",void 0,void 0),n}}),["keys","values","entries",Symbol.iterator].forEach(a=>{r[a]=createIterableMethod(a,t,e)}),r}function createInstrumentationGetter(t,e){const r=createInstrumentations(t,e);return(i,a,l)=>a==="__v_isReactive"?!t:a==="__v_isReadonly"?t:a==="__v_raw"?i:Reflect.get(hasOwn(r,a)&&a in i?r:i,a,l)}const mutableCollectionHandlers={get:createInstrumentationGetter(!1,!1)},shallowCollectionHandlers={get:createInstrumentationGetter(!1,!0)},readonlyCollectionHandlers={get:createInstrumentationGetter(!0,!1)},shallowReadonlyCollectionHandlers={get:createInstrumentationGetter(!0,!0)},reactiveMap=new WeakMap,shallowReactiveMap=new WeakMap,readonlyMap=new WeakMap,shallowReadonlyMap=new WeakMap;function targetTypeMap(t){switch(t){case"Object":case"Array":return 1;case"Map":case"Set":case"WeakMap":case"WeakSet":return 2;default:return 0}}function getTargetType(t){return t.__v_skip||!Object.isExtensible(t)?0:targetTypeMap(toRawType(t))}function reactive(t){return isReadonly(t)?t:createReactiveObject(t,!1,mutableHandlers,mutableCollectionHandlers,reactiveMap)}function shallowReactive(t){return createReactiveObject(t,!1,shallowReactiveHandlers,shallowCollectionHandlers,shallowReactiveMap)}function readonly(t){return createReactiveObject(t,!0,readonlyHandlers,readonlyCollectionHandlers,readonlyMap)}function shallowReadonly(t){return createReactiveObject(t,!0,shallowReadonlyHandlers,shallowReadonlyCollectionHandlers,shallowReadonlyMap)}function createReactiveObject(t,e,r,i,a){if(!isObject(t)||t.__v_raw&&!(e&&t.__v_isReactive))return t;const l=a.get(t);if(l)return l;const n=getTargetType(t);if(n===0)return t;const c=new Proxy(t,n===2?i:r);return a.set(t,c),c}function isReactive(t){return isReadonly(t)?isReactive(t.__v_raw):!!(t&&t.__v_isReactive)}function isReadonly(t){return!!(t&&t.__v_isReadonly)}function isShallow(t){return!!(t&&t.__v_isShallow)}function isProxy(t){return t?!!t.__v_raw:!1}function toRaw(t){const e=t&&t.__v_raw;return e?toRaw(e):t}function markRaw(t){return!hasOwn(t,"__v_skip")&&Object.isExtensible(t)&&def(t,"__v_skip",!0),t}const toReactive=t=>isObject(t)?reactive(t):t,toReadonly=t=>isObject(t)?readonly(t):t;function isRef(t){return t?t.__v_isRef===!0:!1}function ref(t){return createRef(t,!1)}function createRef(t,e){return isRef(t)?t:new RefImpl(t,e)}class RefImpl{constructor(e,r){this.dep=new Dep,this.__v_isRef=!0,this.__v_isShallow=!1,this._rawValue=r?e:toRaw(e),this._value=r?e:toReactive(e),this.__v_isShallow=r}get value(){return this.dep.track(),this._value}set value(e){const r=this._rawValue,i=this.__v_isShallow||isShallow(e)||isReadonly(e);e=i?e:toRaw(e),hasChanged(e,r)&&(this._rawValue=e,this._value=i?e:toReactive(e),this.dep.trigger())}}function unref(t){return isRef(t)?t.value:t}const shallowUnwrapHandlers={get:(t,e,r)=>e==="__v_raw"?t:unref(Reflect.get(t,e,r)),set:(t,e,r,i)=>{const a=t[e];return isRef(a)&&!isRef(r)?(a.value=r,!0):Reflect.set(t,e,r,i)}};function proxyRefs(t){return isReactive(t)?t:new Proxy(t,shallowUnwrapHandlers)}class ComputedRefImpl{constructor(e,r,i){this.fn=e,this.setter=r,this._value=void 0,this.dep=new Dep(this),this.__v_isRef=!0,this.deps=void 0,this.depsTail=void 0,this.flags=16,this.globalVersion=globalVersion-1,this.next=void 0,this.effect=this,this.__v_isReadonly=!r,this.isSSR=i}notify(){if(this.flags|=16,!(this.flags&8)&&activeSub!==this)return batch(this,!0),!0}get value(){const e=this.dep.track();return refreshComputed(this),e&&(e.version=this.dep.version),this._value}set value(e){this.setter&&this.setter(e)}}function computed$1(t,e,r=!1){let i,a;return isFunction(t)?i=t:(i=t.get,a=t.set),new ComputedRefImpl(i,a,r)}const INITIAL_WATCHER_VALUE={},cleanupMap=new WeakMap;let activeWatcher;function onWatcherCleanup(t,e=!1,r=activeWatcher){if(r){let i=cleanupMap.get(r);i||cleanupMap.set(r,i=[]),i.push(t)}}function watch$1(t,e,r=EMPTY_OBJ){const{immediate:i,deep:a,once:l,scheduler:n,augmentJob:c,call:s}=r,d=A=>a?A:isShallow(A)||a===!1||a===0?traverse(A,1):traverse(A);let u,h,o,f,m=!1,g=!1;if(isRef(t)?(h=()=>t.value,m=isShallow(t)):isReactive(t)?(h=()=>d(t),m=!0):isArray(t)?(g=!0,m=t.some(A=>isReactive(A)||isShallow(A)),h=()=>t.map(A=>{if(isRef(A))return A.value;if(isReactive(A))return d(A);if(isFunction(A))return s?s(A,2):A()})):isFunction(t)?e?h=s?()=>s(t,2):t:h=()=>{if(o){pauseTracking();try{o()}finally{resetTracking()}}const A=activeWatcher;activeWatcher=u;try{return s?s(t,3,[f]):t(f)}finally{activeWatcher=A}}:h=NOOP,e&&a){const A=h,R=a===!0?1/0:a;h=()=>traverse(A(),R)}const v=getCurrentScope(),O=()=>{u.stop(),v&&v.active&&remove(v.effects,u)};if(l&&e){const A=e;e=(...R)=>{A(...R),O()}}let T=g?new Array(t.length).fill(INITIAL_WATCHER_VALUE):INITIAL_WATCHER_VALUE;const C=A=>{if(!(!(u.flags&1)||!u.dirty&&!A))if(e){const R=u.run();if(a||m||(g?R.some((w,k)=>hasChanged(w,T[k])):hasChanged(R,T))){o&&o();const w=activeWatcher;activeWatcher=u;try{const k=[R,T===INITIAL_WATCHER_VALUE?void 0:g&&T[0]===INITIAL_WATCHER_VALUE?[]:T,f];s?s(e,3,k):e(...k),T=R}finally{activeWatcher=w}}}else u.run()};return c&&c(C),u=new ReactiveEffect(h),u.scheduler=n?()=>n(C,!1):C,f=A=>onWatcherCleanup(A,!1,u),o=u.onStop=()=>{const A=cleanupMap.get(u);if(A){if(s)s(A,4);else for(const R of A)R();cleanupMap.delete(u)}},e?i?C(!0):T=u.run():n?n(C.bind(null,!0),!0):u.run(),O.pause=u.pause.bind(u),O.resume=u.resume.bind(u),O.stop=O,O}function traverse(t,e=1/0,r){if(e<=0||!isObject(t)||t.__v_skip||(r=r||new Set,r.has(t)))return t;if(r.add(t),e--,isRef(t))traverse(t.value,e,r);else if(isArray(t))for(let i=0;i<t.length;i++)traverse(t[i],e,r);else if(isSet(t)||isMap(t))t.forEach(i=>{traverse(i,e,r)});else if(isPlainObject(t)){for(const i in t)traverse(t[i],e,r);for(const i of Object.getOwnPropertySymbols(t))Object.prototype.propertyIsEnumerable.call(t,i)&&traverse(t[i],e,r)}return t}/**
* @vue/runtime-core v3.5.13
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**/const stack=[];let isWarning=!1;function warn$1(t,...e){if(isWarning)return;isWarning=!0,pauseTracking();const r=stack.length?stack[stack.length-1].component:null,i=r&&r.appContext.config.warnHandler,a=getComponentTrace();if(i)callWithErrorHandling(i,r,11,[t+e.map(l=>{var n,c;return(c=(n=l.toString)==null?void 0:n.call(l))!=null?c:JSON.stringify(l)}).join(""),r&&r.proxy,a.map(({vnode:l})=>`at <${formatComponentName(r,l.type)}>`).join(`
`),a]);else{const l=[`[Vue warn]: ${t}`,...e];a.length&&l.push(`
`,...formatTrace(a)),console.warn(...l)}resetTracking(),isWarning=!1}function getComponentTrace(){let t=stack[stack.length-1];if(!t)return[];const e=[];for(;t;){const r=e[0];r&&r.vnode===t?r.recurseCount++:e.push({vnode:t,recurseCount:0});const i=t.component&&t.component.parent;t=i&&i.vnode}return e}function formatTrace(t){const e=[];return t.forEach((r,i)=>{e.push(...i===0?[]:[`
`],...formatTraceEntry(r))}),e}function formatTraceEntry({vnode:t,recurseCount:e}){const r=e>0?`... (${e} recursive calls)`:"",i=t.component?t.component.parent==null:!1,a=` at <${formatComponentName(t.component,t.type,i)}`,l=">"+r;return t.props?[a,...formatProps(t.props),l]:[a+l]}function formatProps(t){const e=[],r=Object.keys(t);return r.slice(0,3).forEach(i=>{e.push(...formatProp(i,t[i]))}),r.length>3&&e.push(" ..."),e}function formatProp(t,e,r){return isString(e)?(e=JSON.stringify(e),r?e:[`${t}=${e}`]):typeof e=="number"||typeof e=="boolean"||e==null?r?e:[`${t}=${e}`]:isRef(e)?(e=formatProp(t,toRaw(e.value),!0),r?e:[`${t}=Ref<`,e,">"]):isFunction(e)?[`${t}=fn${e.name?`<${e.name}>`:""}`]:(e=toRaw(e),r?e:[`${t}=`,e])}function callWithErrorHandling(t,e,r,i){try{return i?t(...i):t()}catch(a){handleError(a,e,r)}}function callWithAsyncErrorHandling(t,e,r,i){if(isFunction(t)){const a=callWithErrorHandling(t,e,r,i);return a&&isPromise(a)&&a.catch(l=>{handleError(l,e,r)}),a}if(isArray(t)){const a=[];for(let l=0;l<t.length;l++)a.push(callWithAsyncErrorHandling(t[l],e,r,i));return a}}function handleError(t,e,r,i=!0){const a=e?e.vnode:null,{errorHandler:l,throwUnhandledErrorInProduction:n}=e&&e.appContext.config||EMPTY_OBJ;if(e){let c=e.parent;const s=e.proxy,d=`https://vuejs.org/error-reference/#runtime-${r}`;for(;c;){const u=c.ec;if(u){for(let h=0;h<u.length;h++)if(u[h](t,s,d)===!1)return}c=c.parent}if(l){pauseTracking(),callWithErrorHandling(l,null,10,[t,s,d]),resetTracking();return}}logError(t,r,a,i,n)}function logError(t,e,r,i=!0,a=!1){if(a)throw t;console.error(t)}const queue=[];let flushIndex=-1;const pendingPostFlushCbs=[];let activePostFlushCbs=null,postFlushIndex=0;const resolvedPromise=Promise.resolve();let currentFlushPromise=null;function nextTick(t){const e=currentFlushPromise||resolvedPromise;return t?e.then(this?t.bind(this):t):e}function findInsertionIndex(t){let e=flushIndex+1,r=queue.length;for(;e<r;){const i=e+r>>>1,a=queue[i],l=getId(a);l<t||l===t&&a.flags&2?e=i+1:r=i}return e}function queueJob(t){if(!(t.flags&1)){const e=getId(t),r=queue[queue.length-1];!r||!(t.flags&2)&&e>=getId(r)?queue.push(t):queue.splice(findInsertionIndex(e),0,t),t.flags|=1,queueFlush()}}function queueFlush(){currentFlushPromise||(currentFlushPromise=resolvedPromise.then(flushJobs))}function queuePostFlushCb(t){isArray(t)?pendingPostFlushCbs.push(...t):activePostFlushCbs&&t.id===-1?activePostFlushCbs.splice(postFlushIndex+1,0,t):t.flags&1||(pendingPostFlushCbs.push(t),t.flags|=1),queueFlush()}function flushPreFlushCbs(t,e,r=flushIndex+1){for(;r<queue.length;r++){const i=queue[r];if(i&&i.flags&2){if(t&&i.id!==t.uid)continue;queue.splice(r,1),r--,i.flags&4&&(i.flags&=-2),i(),i.flags&4||(i.flags&=-2)}}}function flushPostFlushCbs(t){if(pendingPostFlushCbs.length){const e=[...new Set(pendingPostFlushCbs)].sort((r,i)=>getId(r)-getId(i));if(pendingPostFlushCbs.length=0,activePostFlushCbs){activePostFlushCbs.push(...e);return}for(activePostFlushCbs=e,postFlushIndex=0;postFlushIndex<activePostFlushCbs.length;postFlushIndex++){const r=activePostFlushCbs[postFlushIndex];r.flags&4&&(r.flags&=-2),r.flags&8||r(),r.flags&=-2}activePostFlushCbs=null,postFlushIndex=0}}const getId=t=>t.id==null?t.flags&2?-1:1/0:t.id;function flushJobs(t){try{for(flushIndex=0;flushIndex<queue.length;flushIndex++){const e=queue[flushIndex];e&&!(e.flags&8)&&(e.flags&4&&(e.flags&=-2),callWithErrorHandling(e,e.i,e.i?15:14),e.flags&4||(e.flags&=-2))}}finally{for(;flushIndex<queue.length;flushIndex++){const e=queue[flushIndex];e&&(e.flags&=-2)}flushIndex=-1,queue.length=0,flushPostFlushCbs(),currentFlushPromise=null,(queue.length||pendingPostFlushCbs.length)&&flushJobs()}}let currentRenderingInstance=null,currentScopeId=null;function setCurrentRenderingInstance(t){const e=currentRenderingInstance;return currentRenderingInstance=t,currentScopeId=t&&t.type.__scopeId||null,e}function withCtx(t,e=currentRenderingInstance,r){if(!e||t._n)return t;const i=(...a)=>{i._d&&setBlockTracking(-1);const l=setCurrentRenderingInstance(e);let n;try{n=t(...a)}finally{setCurrentRenderingInstance(l),i._d&&setBlockTracking(1)}return n};return i._n=!0,i._c=!0,i._d=!0,i}function withDirectives(t,e){if(currentRenderingInstance===null)return t;const r=getComponentPublicInstance(currentRenderingInstance),i=t.dirs||(t.dirs=[]);for(let a=0;a<e.length;a++){let[l,n,c,s=EMPTY_OBJ]=e[a];l&&(isFunction(l)&&(l={mounted:l,updated:l}),l.deep&&traverse(n),i.push({dir:l,instance:r,value:n,oldValue:void 0,arg:c,modifiers:s}))}return t}function invokeDirectiveHook(t,e,r,i){const a=t.dirs,l=e&&e.dirs;for(let n=0;n<a.length;n++){const c=a[n];l&&(c.oldValue=l[n].value);let s=c.dir[i];s&&(pauseTracking(),callWithAsyncErrorHandling(s,r,8,[t.el,c,t,e]),resetTracking())}}const TeleportEndKey=Symbol("_vte"),isTeleport=t=>t.__isTeleport;function setTransitionHooks(t,e){t.shapeFlag&6&&t.component?(t.transition=e,setTransitionHooks(t.component.subTree,e)):t.shapeFlag&128?(t.ssContent.transition=e.clone(t.ssContent),t.ssFallback.transition=e.clone(t.ssFallback)):t.transition=e}function markAsyncBoundary(t){t.ids=[t.ids[0]+t.ids[2]+++"-",0,0]}function setRef(t,e,r,i,a=!1){if(isArray(t)){t.forEach((m,g)=>setRef(m,e&&(isArray(e)?e[g]:e),r,i,a));return}if(isAsyncWrapper(i)&&!a){i.shapeFlag&512&&i.type.__asyncResolved&&i.component.subTree.component&&setRef(t,e,r,i.component.subTree);return}const l=i.shapeFlag&4?getComponentPublicInstance(i.component):i.el,n=a?null:l,{i:c,r:s}=t,d=e&&e.r,u=c.refs===EMPTY_OBJ?c.refs={}:c.refs,h=c.setupState,o=toRaw(h),f=h===EMPTY_OBJ?()=>!1:m=>hasOwn(o,m);if(d!=null&&d!==s&&(isString(d)?(u[d]=null,f(d)&&(h[d]=null)):isRef(d)&&(d.value=null)),isFunction(s))callWithErrorHandling(s,c,12,[n,u]);else{const m=isString(s),g=isRef(s);if(m||g){const v=()=>{if(t.f){const O=m?f(s)?h[s]:u[s]:s.value;a?isArray(O)&&remove(O,l):isArray(O)?O.includes(l)||O.push(l):m?(u[s]=[l],f(s)&&(h[s]=u[s])):(s.value=[l],t.k&&(u[t.k]=s.value))}else m?(u[s]=n,f(s)&&(h[s]=n)):g&&(s.value=n,t.k&&(u[t.k]=n))};n?(v.id=-1,queuePostRenderEffect(v,r)):v()}}}getGlobalThis().requestIdleCallback;getGlobalThis().cancelIdleCallback;const isAsyncWrapper=t=>!!t.type.__asyncLoader,isKeepAlive=t=>t.type.__isKeepAlive;function onActivated(t,e){registerKeepAliveHook(t,"a",e)}function onDeactivated(t,e){registerKeepAliveHook(t,"da",e)}function registerKeepAliveHook(t,e,r=currentInstance){const i=t.__wdc||(t.__wdc=()=>{let a=r;for(;a;){if(a.isDeactivated)return;a=a.parent}return t()});if(injectHook(e,i,r),r){let a=r.parent;for(;a&&a.parent;)isKeepAlive(a.parent.vnode)&&injectToKeepAliveRoot(i,e,r,a),a=a.parent}}function injectToKeepAliveRoot(t,e,r,i){const a=injectHook(e,t,i,!0);onUnmounted(()=>{remove(i[e],a)},r)}function injectHook(t,e,r=currentInstance,i=!1){if(r){const a=r[t]||(r[t]=[]),l=e.__weh||(e.__weh=(...n)=>{pauseTracking();const c=setCurrentInstance(r),s=callWithAsyncErrorHandling(e,r,t,n);return c(),resetTracking(),s});return i?a.unshift(l):a.push(l),l}}const createHook=t=>(e,r=currentInstance)=>{(!isInSSRComponentSetup||t==="sp")&&injectHook(t,(...i)=>e(...i),r)},onBeforeMount=createHook("bm"),onMounted=createHook("m"),onBeforeUpdate=createHook("bu"),onUpdated=createHook("u"),onBeforeUnmount=createHook("bum"),onUnmounted=createHook("um"),onServerPrefetch=createHook("sp"),onRenderTriggered=createHook("rtg"),onRenderTracked=createHook("rtc");function onErrorCaptured(t,e=currentInstance){injectHook("ec",t,e)}const NULL_DYNAMIC_COMPONENT=Symbol.for("v-ndc"),getPublicInstance=t=>t?isStatefulComponent(t)?getComponentPublicInstance(t):getPublicInstance(t.parent):null,publicPropertiesMap=extend(Object.create(null),{$:t=>t,$el:t=>t.vnode.el,$data:t=>t.data,$props:t=>t.props,$attrs:t=>t.attrs,$slots:t=>t.slots,$refs:t=>t.refs,$parent:t=>getPublicInstance(t.parent),$root:t=>getPublicInstance(t.root),$host:t=>t.ce,$emit:t=>t.emit,$options:t=>resolveMergedOptions(t),$forceUpdate:t=>t.f||(t.f=()=>{queueJob(t.update)}),$nextTick:t=>t.n||(t.n=nextTick.bind(t.proxy)),$watch:t=>instanceWatch.bind(t)}),hasSetupBinding=(t,e)=>t!==EMPTY_OBJ&&!t.__isScriptSetup&&hasOwn(t,e),PublicInstanceProxyHandlers={get({_:t},e){if(e==="__v_skip")return!0;const{ctx:r,setupState:i,data:a,props:l,accessCache:n,type:c,appContext:s}=t;let d;if(e[0]!=="$"){const f=n[e];if(f!==void 0)switch(f){case 1:return i[e];case 2:return a[e];case 4:return r[e];case 3:return l[e]}else{if(hasSetupBinding(i,e))return n[e]=1,i[e];if(a!==EMPTY_OBJ&&hasOwn(a,e))return n[e]=2,a[e];if((d=t.propsOptions[0])&&hasOwn(d,e))return n[e]=3,l[e];if(r!==EMPTY_OBJ&&hasOwn(r,e))return n[e]=4,r[e];shouldCacheAccess&&(n[e]=0)}}const u=publicPropertiesMap[e];let h,o;if(u)return e==="$attrs"&&track(t.attrs,"get",""),u(t);if((h=c.__cssModules)&&(h=h[e]))return h;if(r!==EMPTY_OBJ&&hasOwn(r,e))return n[e]=4,r[e];if(o=s.config.globalProperties,hasOwn(o,e))return o[e]},set({_:t},e,r){const{data:i,setupState:a,ctx:l}=t;return hasSetupBinding(a,e)?(a[e]=r,!0):i!==EMPTY_OBJ&&hasOwn(i,e)?(i[e]=r,!0):hasOwn(t.props,e)||e[0]==="$"&&e.slice(1)in t?!1:(l[e]=r,!0)},has({_:{data:t,setupState:e,accessCache:r,ctx:i,appContext:a,propsOptions:l}},n){let c;return!!r[n]||t!==EMPTY_OBJ&&hasOwn(t,n)||hasSetupBinding(e,n)||(c=l[0])&&hasOwn(c,n)||hasOwn(i,n)||hasOwn(publicPropertiesMap,n)||hasOwn(a.config.globalProperties,n)},defineProperty(t,e,r){return r.get!=null?t._.accessCache[e]=0:hasOwn(r,"value")&&this.set(t,e,r.value,null),Reflect.defineProperty(t,e,r)}};function normalizePropsOrEmits(t){return isArray(t)?t.reduce((e,r)=>(e[r]=null,e),{}):t}let shouldCacheAccess=!0;function applyOptions(t){const e=resolveMergedOptions(t),r=t.proxy,i=t.ctx;shouldCacheAccess=!1,e.beforeCreate&&callHook(e.beforeCreate,t,"bc");const{data:a,computed:l,methods:n,watch:c,provide:s,inject:d,created:u,beforeMount:h,mounted:o,beforeUpdate:f,updated:m,activated:g,deactivated:v,beforeDestroy:O,beforeUnmount:T,destroyed:C,unmounted:A,render:R,renderTracked:w,renderTriggered:k,errorCaptured:I,serverPrefetch:M,expose:P,inheritAttrs:S,components:y,directives:_,filters:b}=e;if(d&&resolveInjections(d,i,null),n)for(const D in n){const F=n[D];isFunction(F)&&(i[D]=F.bind(r))}if(a){const D=a.call(r,r);isObject(D)&&(t.data=reactive(D))}if(shouldCacheAccess=!0,l)for(const D in l){const F=l[D],V=isFunction(F)?F.bind(r,r):isFunction(F.get)?F.get.bind(r,r):NOOP,N=!isFunction(F)&&isFunction(F.set)?F.set.bind(r):NOOP,L=computed({get:V,set:N});Object.defineProperty(i,D,{enumerable:!0,configurable:!0,get:()=>L.value,set:U=>L.value=U})}if(c)for(const D in c)createWatcher(c[D],i,r,D);if(s){const D=isFunction(s)?s.call(r):s;Reflect.ownKeys(D).forEach(F=>{provide(F,D[F])})}u&&callHook(u,t,"c");function x(D,F){isArray(F)?F.forEach(V=>D(V.bind(r))):F&&D(F.bind(r))}if(x(onBeforeMount,h),x(onMounted,o),x(onBeforeUpdate,f),x(onUpdated,m),x(onActivated,g),x(onDeactivated,v),x(onErrorCaptured,I),x(onRenderTracked,w),x(onRenderTriggered,k),x(onBeforeUnmount,T),x(onUnmounted,A),x(onServerPrefetch,M),isArray(P))if(P.length){const D=t.exposed||(t.exposed={});P.forEach(F=>{Object.defineProperty(D,F,{get:()=>r[F],set:V=>r[F]=V})})}else t.exposed||(t.exposed={});R&&t.render===NOOP&&(t.render=R),S!=null&&(t.inheritAttrs=S),y&&(t.components=y),_&&(t.directives=_),M&&markAsyncBoundary(t)}function resolveInjections(t,e,r=NOOP){isArray(t)&&(t=normalizeInject(t));for(const i in t){const a=t[i];let l;isObject(a)?"default"in a?l=inject(a.from||i,a.default,!0):l=inject(a.from||i):l=inject(a),isRef(l)?Object.defineProperty(e,i,{enumerable:!0,configurable:!0,get:()=>l.value,set:n=>l.value=n}):e[i]=l}}function callHook(t,e,r){callWithAsyncErrorHandling(isArray(t)?t.map(i=>i.bind(e.proxy)):t.bind(e.proxy),e,r)}function createWatcher(t,e,r,i){let a=i.includes(".")?createPathGetter(r,i):()=>r[i];if(isString(t)){const l=e[t];isFunction(l)&&watch(a,l)}else if(isFunction(t))watch(a,t.bind(r));else if(isObject(t))if(isArray(t))t.forEach(l=>createWatcher(l,e,r,i));else{const l=isFunction(t.handler)?t.handler.bind(r):e[t.handler];isFunction(l)&&watch(a,l,t)}}function resolveMergedOptions(t){const e=t.type,{mixins:r,extends:i}=e,{mixins:a,optionsCache:l,config:{optionMergeStrategies:n}}=t.appContext,c=l.get(e);let s;return c?s=c:!a.length&&!r&&!i?s=e:(s={},a.length&&a.forEach(d=>mergeOptions(s,d,n,!0)),mergeOptions(s,e,n)),isObject(e)&&l.set(e,s),s}function mergeOptions(t,e,r,i=!1){const{mixins:a,extends:l}=e;l&&mergeOptions(t,l,r,!0),a&&a.forEach(n=>mergeOptions(t,n,r,!0));for(const n in e)if(!(i&&n==="expose")){const c=internalOptionMergeStrats[n]||r&&r[n];t[n]=c?c(t[n],e[n]):e[n]}return t}const internalOptionMergeStrats={data:mergeDataFn,props:mergeEmitsOrPropsOptions,emits:mergeEmitsOrPropsOptions,methods:mergeObjectOptions,computed:mergeObjectOptions,beforeCreate:mergeAsArray,created:mergeAsArray,beforeMount:mergeAsArray,mounted:mergeAsArray,beforeUpdate:mergeAsArray,updated:mergeAsArray,beforeDestroy:mergeAsArray,beforeUnmount:mergeAsArray,destroyed:mergeAsArray,unmounted:mergeAsArray,activated:mergeAsArray,deactivated:mergeAsArray,errorCaptured:mergeAsArray,serverPrefetch:mergeAsArray,components:mergeObjectOptions,directives:mergeObjectOptions,watch:mergeWatchOptions,provide:mergeDataFn,inject:mergeInject};function mergeDataFn(t,e){return e?t?function(){return extend(isFunction(t)?t.call(this,this):t,isFunction(e)?e.call(this,this):e)}:e:t}function mergeInject(t,e){return mergeObjectOptions(normalizeInject(t),normalizeInject(e))}function normalizeInject(t){if(isArray(t)){const e={};for(let r=0;r<t.length;r++)e[t[r]]=t[r];return e}return t}function mergeAsArray(t,e){return t?[...new Set([].concat(t,e))]:e}function mergeObjectOptions(t,e){return t?extend(Object.create(null),t,e):e}function mergeEmitsOrPropsOptions(t,e){return t?isArray(t)&&isArray(e)?[...new Set([...t,...e])]:extend(Object.create(null),normalizePropsOrEmits(t),normalizePropsOrEmits(e??{})):e}function mergeWatchOptions(t,e){if(!t)return e;if(!e)return t;const r=extend(Object.create(null),t);for(const i in e)r[i]=mergeAsArray(t[i],e[i]);return r}function createAppContext(){return{app:null,config:{isNativeTag:NO,performance:!1,globalProperties:{},optionMergeStrategies:{},errorHandler:void 0,warnHandler:void 0,compilerOptions:{}},mixins:[],components:{},directives:{},provides:Object.create(null),optionsCache:new WeakMap,propsCache:new WeakMap,emitsCache:new WeakMap}}let uid$1=0;function createAppAPI(t,e){return function(i,a=null){isFunction(i)||(i=extend({},i)),a!=null&&!isObject(a)&&(a=null);const l=createAppContext(),n=new WeakSet,c=[];let s=!1;const d=l.app={_uid:uid$1++,_component:i,_props:a,_container:null,_context:l,_instance:null,version,get config(){return l.config},set config(u){},use(u,...h){return n.has(u)||(u&&isFunction(u.install)?(n.add(u),u.install(d,...h)):isFunction(u)&&(n.add(u),u(d,...h))),d},mixin(u){return l.mixins.includes(u)||l.mixins.push(u),d},component(u,h){return h?(l.components[u]=h,d):l.components[u]},directive(u,h){return h?(l.directives[u]=h,d):l.directives[u]},mount(u,h,o){if(!s){const f=d._ceVNode||createVNode(i,a);return f.appContext=l,o===!0?o="svg":o===!1&&(o=void 0),t(f,u,o),s=!0,d._container=u,u.__vue_app__=d,getComponentPublicInstance(f.component)}},onUnmount(u){c.push(u)},unmount(){s&&(callWithAsyncErrorHandling(c,d._instance,16),t(null,d._container),delete d._container.__vue_app__)},provide(u,h){return l.provides[u]=h,d},runWithContext(u){const h=currentApp;currentApp=d;try{return u()}finally{currentApp=h}}};return d}}let currentApp=null;function provide(t,e){if(currentInstance){let r=currentInstance.provides;const i=currentInstance.parent&&currentInstance.parent.provides;i===r&&(r=currentInstance.provides=Object.create(i)),r[t]=e}}function inject(t,e,r=!1){const i=currentInstance||currentRenderingInstance;if(i||currentApp){const a=currentApp?currentApp._context.provides:i?i.parent==null?i.vnode.appContext&&i.vnode.appContext.provides:i.parent.provides:void 0;if(a&&t in a)return a[t];if(arguments.length>1)return r&&isFunction(e)?e.call(i&&i.proxy):e}}const internalObjectProto={},createInternalObject=()=>Object.create(internalObjectProto),isInternalObject=t=>Object.getPrototypeOf(t)===internalObjectProto;function initProps(t,e,r,i=!1){const a={},l=createInternalObject();t.propsDefaults=Object.create(null),setFullProps(t,e,a,l);for(const n in t.propsOptions[0])n in a||(a[n]=void 0);r?t.props=i?a:shallowReactive(a):t.type.props?t.props=a:t.props=l,t.attrs=l}function updateProps(t,e,r,i){const{props:a,attrs:l,vnode:{patchFlag:n}}=t,c=toRaw(a),[s]=t.propsOptions;let d=!1;if((i||n>0)&&!(n&16)){if(n&8){const u=t.vnode.dynamicProps;for(let h=0;h<u.length;h++){let o=u[h];if(isEmitListener(t.emitsOptions,o))continue;const f=e[o];if(s)if(hasOwn(l,o))f!==l[o]&&(l[o]=f,d=!0);else{const m=camelize(o);a[m]=resolvePropValue(s,c,m,f,t,!1)}else f!==l[o]&&(l[o]=f,d=!0)}}}else{setFullProps(t,e,a,l)&&(d=!0);let u;for(const h in c)(!e||!hasOwn(e,h)&&((u=hyphenate(h))===h||!hasOwn(e,u)))&&(s?r&&(r[h]!==void 0||r[u]!==void 0)&&(a[h]=resolvePropValue(s,c,h,void 0,t,!0)):delete a[h]);if(l!==c)for(const h in l)(!e||!hasOwn(e,h))&&(delete l[h],d=!0)}d&&trigger(t.attrs,"set","")}function setFullProps(t,e,r,i){const[a,l]=t.propsOptions;let n=!1,c;if(e)for(let s in e){if(isReservedProp(s))continue;const d=e[s];let u;a&&hasOwn(a,u=camelize(s))?!l||!l.includes(u)?r[u]=d:(c||(c={}))[u]=d:isEmitListener(t.emitsOptions,s)||(!(s in i)||d!==i[s])&&(i[s]=d,n=!0)}if(l){const s=toRaw(r),d=c||EMPTY_OBJ;for(let u=0;u<l.length;u++){const h=l[u];r[h]=resolvePropValue(a,s,h,d[h],t,!hasOwn(d,h))}}return n}function resolvePropValue(t,e,r,i,a,l){const n=t[r];if(n!=null){const c=hasOwn(n,"default");if(c&&i===void 0){const s=n.default;if(n.type!==Function&&!n.skipFactory&&isFunction(s)){const{propsDefaults:d}=a;if(r in d)i=d[r];else{const u=setCurrentInstance(a);i=d[r]=s.call(null,e),u()}}else i=s;a.ce&&a.ce._setProp(r,i)}n[0]&&(l&&!c?i=!1:n[1]&&(i===""||i===hyphenate(r))&&(i=!0))}return i}const mixinPropsCache=new WeakMap;function normalizePropsOptions(t,e,r=!1){const i=r?mixinPropsCache:e.propsCache,a=i.get(t);if(a)return a;const l=t.props,n={},c=[];let s=!1;if(!isFunction(t)){const u=h=>{s=!0;const[o,f]=normalizePropsOptions(h,e,!0);extend(n,o),f&&c.push(...f)};!r&&e.mixins.length&&e.mixins.forEach(u),t.extends&&u(t.extends),t.mixins&&t.mixins.forEach(u)}if(!l&&!s)return isObject(t)&&i.set(t,EMPTY_ARR),EMPTY_ARR;if(isArray(l))for(let u=0;u<l.length;u++){const h=camelize(l[u]);validatePropName(h)&&(n[h]=EMPTY_OBJ)}else if(l)for(const u in l){const h=camelize(u);if(validatePropName(h)){const o=l[u],f=n[h]=isArray(o)||isFunction(o)?{type:o}:extend({},o),m=f.type;let g=!1,v=!0;if(isArray(m))for(let O=0;O<m.length;++O){const T=m[O],C=isFunction(T)&&T.name;if(C==="Boolean"){g=!0;break}else C==="String"&&(v=!1)}else g=isFunction(m)&&m.name==="Boolean";f[0]=g,f[1]=v,(g||hasOwn(f,"default"))&&c.push(h)}}const d=[n,c];return isObject(t)&&i.set(t,d),d}function validatePropName(t){return t[0]!=="$"&&!isReservedProp(t)}const isInternalKey=t=>t[0]==="_"||t==="$stable",normalizeSlotValue=t=>isArray(t)?t.map(normalizeVNode):[normalizeVNode(t)],normalizeSlot=(t,e,r)=>{if(e._n)return e;const i=withCtx((...a)=>normalizeSlotValue(e(...a)),r);return i._c=!1,i},normalizeObjectSlots=(t,e,r)=>{const i=t._ctx;for(const a in t){if(isInternalKey(a))continue;const l=t[a];if(isFunction(l))e[a]=normalizeSlot(a,l,i);else if(l!=null){const n=normalizeSlotValue(l);e[a]=()=>n}}},normalizeVNodeSlots=(t,e)=>{const r=normalizeSlotValue(e);t.slots.default=()=>r},assignSlots=(t,e,r)=>{for(const i in e)(r||i!=="_")&&(t[i]=e[i])},initSlots=(t,e,r)=>{const i=t.slots=createInternalObject();if(t.vnode.shapeFlag&32){const a=e._;a?(assignSlots(i,e,r),r&&def(i,"_",a,!0)):normalizeObjectSlots(e,i)}else e&&normalizeVNodeSlots(t,e)},updateSlots=(t,e,r)=>{const{vnode:i,slots:a}=t;let l=!0,n=EMPTY_OBJ;if(i.shapeFlag&32){const c=e._;c?r&&c===1?l=!1:assignSlots(a,e,r):(l=!e.$stable,normalizeObjectSlots(e,a)),n=e}else e&&(normalizeVNodeSlots(t,e),n={default:1});if(l)for(const c in a)!isInternalKey(c)&&n[c]==null&&delete a[c]},queuePostRenderEffect=queueEffectWithSuspense;function createRenderer(t){return baseCreateRenderer(t)}function baseCreateRenderer(t,e){const r=getGlobalThis();r.__VUE__=!0;const{insert:i,remove:a,patchProp:l,createElement:n,createText:c,createComment:s,setText:d,setElementText:u,parentNode:h,nextSibling:o,setScopeId:f=NOOP,insertStaticContent:m}=t,g=(B,$,z,ie=null,Z=null,ee=null,ce=void 0,ae=null,ne=!!$.dynamicChildren)=>{if(B===$)return;B&&!isSameVNodeType(B,$)&&(ie=te(B),U(B,Z,ee,!0),B=null),$.patchFlag===-2&&(ne=!1,$.dynamicChildren=null);const{type:se,ref:he,shapeFlag:ue}=$;switch(se){case Text:v(B,$,z,ie);break;case Comment:O(B,$,z,ie);break;case Static:B==null&&T($,z,ie,ce);break;case Fragment:y(B,$,z,ie,Z,ee,ce,ae,ne);break;default:ue&1?R(B,$,z,ie,Z,ee,ce,ae,ne):ue&6?_(B,$,z,ie,Z,ee,ce,ae,ne):(ue&64||ue&128)&&se.process(B,$,z,ie,Z,ee,ce,ae,ne,K)}he!=null&&Z&&setRef(he,B&&B.ref,ee,$||B,!$)},v=(B,$,z,ie)=>{if(B==null)i($.el=c($.children),z,ie);else{const Z=$.el=B.el;$.children!==B.children&&d(Z,$.children)}},O=(B,$,z,ie)=>{B==null?i($.el=s($.children||""),z,ie):$.el=B.el},T=(B,$,z,ie)=>{[B.el,B.anchor]=m(B.children,$,z,ie,B.el,B.anchor)},C=({el:B,anchor:$},z,ie)=>{let Z;for(;B&&B!==$;)Z=o(B),i(B,z,ie),B=Z;i($,z,ie)},A=({el:B,anchor:$})=>{let z;for(;B&&B!==$;)z=o(B),a(B),B=z;a($)},R=(B,$,z,ie,Z,ee,ce,ae,ne)=>{$.type==="svg"?ce="svg":$.type==="math"&&(ce="mathml"),B==null?w($,z,ie,Z,ee,ce,ae,ne):M(B,$,Z,ee,ce,ae,ne)},w=(B,$,z,ie,Z,ee,ce,ae)=>{let ne,se;const{props:he,shapeFlag:ue,transition:J,dirs:X}=B;if(ne=B.el=n(B.type,ee,he&&he.is,he),ue&8?u(ne,B.children):ue&16&&I(B.children,ne,null,ie,Z,resolveChildrenNamespace(B,ee),ce,ae),X&&invokeDirectiveHook(B,null,ie,"created"),k(ne,B,B.scopeId,ce,ie),he){for(const ge in he)ge!=="value"&&!isReservedProp(ge)&&l(ne,ge,null,he[ge],ee,ie);"value"in he&&l(ne,"value",null,he.value,ee),(se=he.onVnodeBeforeMount)&&invokeVNodeHook(se,ie,B)}X&&invokeDirectiveHook(B,null,ie,"beforeMount");const le=needTransition(Z,J);le&&J.beforeEnter(ne),i(ne,$,z),((se=he&&he.onVnodeMounted)||le||X)&&queuePostRenderEffect(()=>{se&&invokeVNodeHook(se,ie,B),le&&J.enter(ne),X&&invokeDirectiveHook(B,null,ie,"mounted")},Z)},k=(B,$,z,ie,Z)=>{if(z&&f(B,z),ie)for(let ee=0;ee<ie.length;ee++)f(B,ie[ee]);if(Z){let ee=Z.subTree;if($===ee||isSuspense(ee.type)&&(ee.ssContent===$||ee.ssFallback===$)){const ce=Z.vnode;k(B,ce,ce.scopeId,ce.slotScopeIds,Z.parent)}}},I=(B,$,z,ie,Z,ee,ce,ae,ne=0)=>{for(let se=ne;se<B.length;se++){const he=B[se]=ae?cloneIfMounted(B[se]):normalizeVNode(B[se]);g(null,he,$,z,ie,Z,ee,ce,ae)}},M=(B,$,z,ie,Z,ee,ce)=>{const ae=$.el=B.el;let{patchFlag:ne,dynamicChildren:se,dirs:he}=$;ne|=B.patchFlag&16;const ue=B.props||EMPTY_OBJ,J=$.props||EMPTY_OBJ;let X;if(z&&toggleRecurse(z,!1),(X=J.onVnodeBeforeUpdate)&&invokeVNodeHook(X,z,$,B),he&&invokeDirectiveHook($,B,z,"beforeUpdate"),z&&toggleRecurse(z,!0),(ue.innerHTML&&J.innerHTML==null||ue.textContent&&J.textContent==null)&&u(ae,""),se?P(B.dynamicChildren,se,ae,z,ie,resolveChildrenNamespace($,Z),ee):ce||F(B,$,ae,null,z,ie,resolveChildrenNamespace($,Z),ee,!1),ne>0){if(ne&16)S(ae,ue,J,z,Z);else if(ne&2&&ue.class!==J.class&&l(ae,"class",null,J.class,Z),ne&4&&l(ae,"style",ue.style,J.style,Z),ne&8){const le=$.dynamicProps;for(let ge=0;ge<le.length;ge++){const fe=le[ge],me=ue[fe],Q=J[fe];(Q!==me||fe==="value")&&l(ae,fe,me,Q,Z,z)}}ne&1&&B.children!==$.children&&u(ae,$.children)}else!ce&&se==null&&S(ae,ue,J,z,Z);((X=J.onVnodeUpdated)||he)&&queuePostRenderEffect(()=>{X&&invokeVNodeHook(X,z,$,B),he&&invokeDirectiveHook($,B,z,"updated")},ie)},P=(B,$,z,ie,Z,ee,ce)=>{for(let ae=0;ae<$.length;ae++){const ne=B[ae],se=$[ae],he=ne.el&&(ne.type===Fragment||!isSameVNodeType(ne,se)||ne.shapeFlag&70)?h(ne.el):z;g(ne,se,he,null,ie,Z,ee,ce,!0)}},S=(B,$,z,ie,Z)=>{if($!==z){if($!==EMPTY_OBJ)for(const ee in $)!isReservedProp(ee)&&!(ee in z)&&l(B,ee,$[ee],null,Z,ie);for(const ee in z){if(isReservedProp(ee))continue;const ce=z[ee],ae=$[ee];ce!==ae&&ee!=="value"&&l(B,ee,ae,ce,Z,ie)}"value"in z&&l(B,"value",$.value,z.value,Z)}},y=(B,$,z,ie,Z,ee,ce,ae,ne)=>{const se=$.el=B?B.el:c(""),he=$.anchor=B?B.anchor:c("");let{patchFlag:ue,dynamicChildren:J,slotScopeIds:X}=$;X&&(ae=ae?ae.concat(X):X),B==null?(i(se,z,ie),i(he,z,ie),I($.children||[],z,he,Z,ee,ce,ae,ne)):ue>0&&ue&64&&J&&B.dynamicChildren?(P(B.dynamicChildren,J,z,Z,ee,ce,ae),($.key!=null||Z&&$===Z.subTree)&&traverseStaticChildren(B,$,!0)):F(B,$,z,he,Z,ee,ce,ae,ne)},_=(B,$,z,ie,Z,ee,ce,ae,ne)=>{$.slotScopeIds=ae,B==null?$.shapeFlag&512?Z.ctx.activate($,z,ie,ce,ne):b($,z,ie,Z,ee,ce,ne):E(B,$,ne)},b=(B,$,z,ie,Z,ee,ce)=>{const ae=B.component=createComponentInstance(B,ie,Z);if(isKeepAlive(B)&&(ae.ctx.renderer=K),setupComponent(ae,!1,ce),ae.asyncDep){if(Z&&Z.registerDep(ae,x,ce),!B.el){const ne=ae.subTree=createVNode(Comment);O(null,ne,$,z)}}else x(ae,B,$,z,Z,ee,ce)},E=(B,$,z)=>{const ie=$.component=B.component;if(shouldUpdateComponent(B,$,z))if(ie.asyncDep&&!ie.asyncResolved){D(ie,$,z);return}else ie.next=$,ie.update();else $.el=B.el,ie.vnode=$},x=(B,$,z,ie,Z,ee,ce)=>{const ae=()=>{if(B.isMounted){let{next:ue,bu:J,u:X,parent:le,vnode:ge}=B;{const _e=locateNonHydratedAsyncRoot(B);if(_e){ue&&(ue.el=ge.el,D(B,ue,ce)),_e.asyncDep.then(()=>{B.isUnmounted||ae()});return}}let fe=ue,me;toggleRecurse(B,!1),ue?(ue.el=ge.el,D(B,ue,ce)):ue=ge,J&&invokeArrayFns(J),(me=ue.props&&ue.props.onVnodeBeforeUpdate)&&invokeVNodeHook(me,le,ue,ge),toggleRecurse(B,!0);const Q=renderComponentRoot(B),ye=B.subTree;B.subTree=Q,g(ye,Q,h(ye.el),te(ye),B,Z,ee),ue.el=Q.el,fe===null&&updateHOCHostEl(B,Q.el),X&&queuePostRenderEffect(X,Z),(me=ue.props&&ue.props.onVnodeUpdated)&&queuePostRenderEffect(()=>invokeVNodeHook(me,le,ue,ge),Z)}else{let ue;const{el:J,props:X}=$,{bm:le,m:ge,parent:fe,root:me,type:Q}=B,ye=isAsyncWrapper($);toggleRecurse(B,!1),le&&invokeArrayFns(le),!ye&&(ue=X&&X.onVnodeBeforeMount)&&invokeVNodeHook(ue,fe,$),toggleRecurse(B,!0);{me.ce&&me.ce._injectChildStyle(Q);const _e=B.subTree=renderComponentRoot(B);g(null,_e,z,ie,B,Z,ee),$.el=_e.el}if(ge&&queuePostRenderEffect(ge,Z),!ye&&(ue=X&&X.onVnodeMounted)){const _e=$;queuePostRenderEffect(()=>invokeVNodeHook(ue,fe,_e),Z)}($.shapeFlag&256||fe&&isAsyncWrapper(fe.vnode)&&fe.vnode.shapeFlag&256)&&B.a&&queuePostRenderEffect(B.a,Z),B.isMounted=!0,$=z=ie=null}};B.scope.on();const ne=B.effect=new ReactiveEffect(ae);B.scope.off();const se=B.update=ne.run.bind(ne),he=B.job=ne.runIfDirty.bind(ne);he.i=B,he.id=B.uid,ne.scheduler=()=>queueJob(he),toggleRecurse(B,!0),se()},D=(B,$,z)=>{$.component=B;const ie=B.vnode.props;B.vnode=$,B.next=null,updateProps(B,$.props,ie,z),updateSlots(B,$.children,z),pauseTracking(),flushPreFlushCbs(B),resetTracking()},F=(B,$,z,ie,Z,ee,ce,ae,ne=!1)=>{const se=B&&B.children,he=B?B.shapeFlag:0,ue=$.children,{patchFlag:J,shapeFlag:X}=$;if(J>0){if(J&128){N(se,ue,z,ie,Z,ee,ce,ae,ne);return}else if(J&256){V(se,ue,z,ie,Z,ee,ce,ae,ne);return}}X&8?(he&16&&Y(se,Z,ee),ue!==se&&u(z,ue)):he&16?X&16?N(se,ue,z,ie,Z,ee,ce,ae,ne):Y(se,Z,ee,!0):(he&8&&u(z,""),X&16&&I(ue,z,ie,Z,ee,ce,ae,ne))},V=(B,$,z,ie,Z,ee,ce,ae,ne)=>{B=B||EMPTY_ARR,$=$||EMPTY_ARR;const se=B.length,he=$.length,ue=Math.min(se,he);let J;for(J=0;J<ue;J++){const X=$[J]=ne?cloneIfMounted($[J]):normalizeVNode($[J]);g(B[J],X,z,null,Z,ee,ce,ae,ne)}se>he?Y(B,Z,ee,!0,!1,ue):I($,z,ie,Z,ee,ce,ae,ne,ue)},N=(B,$,z,ie,Z,ee,ce,ae,ne)=>{let se=0;const he=$.length;let ue=B.length-1,J=he-1;for(;se<=ue&&se<=J;){const X=B[se],le=$[se]=ne?cloneIfMounted($[se]):normalizeVNode($[se]);if(isSameVNodeType(X,le))g(X,le,z,null,Z,ee,ce,ae,ne);else break;se++}for(;se<=ue&&se<=J;){const X=B[ue],le=$[J]=ne?cloneIfMounted($[J]):normalizeVNode($[J]);if(isSameVNodeType(X,le))g(X,le,z,null,Z,ee,ce,ae,ne);else break;ue--,J--}if(se>ue){if(se<=J){const X=J+1,le=X<he?$[X].el:ie;for(;se<=J;)g(null,$[se]=ne?cloneIfMounted($[se]):normalizeVNode($[se]),z,le,Z,ee,ce,ae,ne),se++}}else if(se>J)for(;se<=ue;)U(B[se],Z,ee,!0),se++;else{const X=se,le=se,ge=new Map;for(se=le;se<=J;se++){const Ee=$[se]=ne?cloneIfMounted($[se]):normalizeVNode($[se]);Ee.key!=null&&ge.set(Ee.key,se)}let fe,me=0;const Q=J-le+1;let ye=!1,_e=0;const Oe=new Array(Q);for(se=0;se<Q;se++)Oe[se]=0;for(se=X;se<=ue;se++){const Ee=B[se];if(me>=Q){U(Ee,Z,ee,!0);continue}let be;if(Ee.key!=null)be=ge.get(Ee.key);else for(fe=le;fe<=J;fe++)if(Oe[fe-le]===0&&isSameVNodeType(Ee,$[fe])){be=fe;break}be===void 0?U(Ee,Z,ee,!0):(Oe[be-le]=se+1,be>=_e?_e=be:ye=!0,g(Ee,$[be],z,null,Z,ee,ce,ae,ne),me++)}const Me=ye?getSequence(Oe):EMPTY_ARR;for(fe=Me.length-1,se=Q-1;se>=0;se--){const Ee=le+se,be=$[Ee],xe=Ee+1<he?$[Ee+1].el:ie;Oe[se]===0?g(null,be,z,xe,Z,ee,ce,ae,ne):ye&&(fe<0||se!==Me[fe]?L(be,z,xe,2):fe--)}}},L=(B,$,z,ie,Z=null)=>{const{el:ee,type:ce,transition:ae,children:ne,shapeFlag:se}=B;if(se&6){L(B.component.subTree,$,z,ie);return}if(se&128){B.suspense.move($,z,ie);return}if(se&64){ce.move(B,$,z,K);return}if(ce===Fragment){i(ee,$,z);for(let ue=0;ue<ne.length;ue++)L(ne[ue],$,z,ie);i(B.anchor,$,z);return}if(ce===Static){C(B,$,z);return}if(ie!==2&&se&1&&ae)if(ie===0)ae.beforeEnter(ee),i(ee,$,z),queuePostRenderEffect(()=>ae.enter(ee),Z);else{const{leave:ue,delayLeave:J,afterLeave:X}=ae,le=()=>i(ee,$,z),ge=()=>{ue(ee,()=>{le(),X&&X()})};J?J(ee,le,ge):ge()}else i(ee,$,z)},U=(B,$,z,ie=!1,Z=!1)=>{const{type:ee,props:ce,ref:ae,children:ne,dynamicChildren:se,shapeFlag:he,patchFlag:ue,dirs:J,cacheIndex:X}=B;if(ue===-2&&(Z=!1),ae!=null&&setRef(ae,null,z,B,!0),X!=null&&($.renderCache[X]=void 0),he&256){$.ctx.deactivate(B);return}const le=he&1&&J,ge=!isAsyncWrapper(B);let fe;if(ge&&(fe=ce&&ce.onVnodeBeforeUnmount)&&invokeVNodeHook(fe,$,B),he&6)W(B.component,z,ie);else{if(he&128){B.suspense.unmount(z,ie);return}le&&invokeDirectiveHook(B,null,$,"beforeUnmount"),he&64?B.type.remove(B,$,z,K,ie):se&&!se.hasOnce&&(ee!==Fragment||ue>0&&ue&64)?Y(se,$,z,!1,!0):(ee===Fragment&&ue&384||!Z&&he&16)&&Y(ne,$,z),ie&&H(B)}(ge&&(fe=ce&&ce.onVnodeUnmounted)||le)&&queuePostRenderEffect(()=>{fe&&invokeVNodeHook(fe,$,B),le&&invokeDirectiveHook(B,null,$,"unmounted")},z)},H=B=>{const{type:$,el:z,anchor:ie,transition:Z}=B;if($===Fragment){j(z,ie);return}if($===Static){A(B);return}const ee=()=>{a(z),Z&&!Z.persisted&&Z.afterLeave&&Z.afterLeave()};if(B.shapeFlag&1&&Z&&!Z.persisted){const{leave:ce,delayLeave:ae}=Z,ne=()=>ce(z,ee);ae?ae(B.el,ee,ne):ne()}else ee()},j=(B,$)=>{let z;for(;B!==$;)z=o(B),a(B),B=z;a($)},W=(B,$,z)=>{const{bum:ie,scope:Z,job:ee,subTree:ce,um:ae,m:ne,a:se}=B;invalidateMount(ne),invalidateMount(se),ie&&invokeArrayFns(ie),Z.stop(),ee&&(ee.flags|=8,U(ce,B,$,z)),ae&&queuePostRenderEffect(ae,$),queuePostRenderEffect(()=>{B.isUnmounted=!0},$),$&&$.pendingBranch&&!$.isUnmounted&&B.asyncDep&&!B.asyncResolved&&B.suspenseId===$.pendingId&&($.deps--,$.deps===0&&$.resolve())},Y=(B,$,z,ie=!1,Z=!1,ee=0)=>{for(let ce=ee;ce<B.length;ce++)U(B[ce],$,z,ie,Z)},te=B=>{if(B.shapeFlag&6)return te(B.component.subTree);if(B.shapeFlag&128)return B.suspense.next();const $=o(B.anchor||B.el),z=$&&$[TeleportEndKey];return z?o(z):$};let re=!1;const G=(B,$,z)=>{B==null?$._vnode&&U($._vnode,null,null,!0):g($._vnode||null,B,$,null,null,null,z),$._vnode=B,re||(re=!0,flushPreFlushCbs(),flushPostFlushCbs(),re=!1)},K={p:g,um:U,m:L,r:H,mt:b,mc:I,pc:F,pbc:P,n:te,o:t};return{render:G,hydrate:void 0,createApp:createAppAPI(G)}}function resolveChildrenNamespace({type:t,props:e},r){return r==="svg"&&t==="foreignObject"||r==="mathml"&&t==="annotation-xml"&&e&&e.encoding&&e.encoding.includes("html")?void 0:r}function toggleRecurse({effect:t,job:e},r){r?(t.flags|=32,e.flags|=4):(t.flags&=-33,e.flags&=-5)}function needTransition(t,e){return(!t||t&&!t.pendingBranch)&&e&&!e.persisted}function traverseStaticChildren(t,e,r=!1){const i=t.children,a=e.children;if(isArray(i)&&isArray(a))for(let l=0;l<i.length;l++){const n=i[l];let c=a[l];c.shapeFlag&1&&!c.dynamicChildren&&((c.patchFlag<=0||c.patchFlag===32)&&(c=a[l]=cloneIfMounted(a[l]),c.el=n.el),!r&&c.patchFlag!==-2&&traverseStaticChildren(n,c)),c.type===Text&&(c.el=n.el)}}function getSequence(t){const e=t.slice(),r=[0];let i,a,l,n,c;const s=t.length;for(i=0;i<s;i++){const d=t[i];if(d!==0){if(a=r[r.length-1],t[a]<d){e[i]=a,r.push(i);continue}for(l=0,n=r.length-1;l<n;)c=l+n>>1,t[r[c]]<d?l=c+1:n=c;d<t[r[l]]&&(l>0&&(e[i]=r[l-1]),r[l]=i)}}for(l=r.length,n=r[l-1];l-- >0;)r[l]=n,n=e[n];return r}function locateNonHydratedAsyncRoot(t){const e=t.subTree.component;if(e)return e.asyncDep&&!e.asyncResolved?e:locateNonHydratedAsyncRoot(e)}function invalidateMount(t){if(t)for(let e=0;e<t.length;e++)t[e].flags|=8}const ssrContextKey=Symbol.for("v-scx"),useSSRContext=()=>inject(ssrContextKey);function watch(t,e,r){return doWatch(t,e,r)}function doWatch(t,e,r=EMPTY_OBJ){const{immediate:i,deep:a,flush:l,once:n}=r,c=extend({},r),s=e&&i||!e&&l!=="post";let d;if(isInSSRComponentSetup){if(l==="sync"){const f=useSSRContext();d=f.__watcherHandles||(f.__watcherHandles=[])}else if(!s){const f=()=>{};return f.stop=NOOP,f.resume=NOOP,f.pause=NOOP,f}}const u=currentInstance;c.call=(f,m,g)=>callWithAsyncErrorHandling(f,u,m,g);let h=!1;l==="post"?c.scheduler=f=>{queuePostRenderEffect(f,u&&u.suspense)}:l!=="sync"&&(h=!0,c.scheduler=(f,m)=>{m?f():queueJob(f)}),c.augmentJob=f=>{e&&(f.flags|=4),h&&(f.flags|=2,u&&(f.id=u.uid,f.i=u))};const o=watch$1(t,e,c);return isInSSRComponentSetup&&(d?d.push(o):s&&o()),o}function instanceWatch(t,e,r){const i=this.proxy,a=isString(t)?t.includes(".")?createPathGetter(i,t):()=>i[t]:t.bind(i,i);let l;isFunction(e)?l=e:(l=e.handler,r=e);const n=setCurrentInstance(this),c=doWatch(a,l.bind(i),r);return n(),c}function createPathGetter(t,e){const r=e.split(".");return()=>{let i=t;for(let a=0;a<r.length&&i;a++)i=i[r[a]];return i}}const getModelModifiers=(t,e)=>e==="modelValue"||e==="model-value"?t.modelModifiers:t[`${e}Modifiers`]||t[`${camelize(e)}Modifiers`]||t[`${hyphenate(e)}Modifiers`];function emit(t,e,...r){if(t.isUnmounted)return;const i=t.vnode.props||EMPTY_OBJ;let a=r;const l=e.startsWith("update:"),n=l&&getModelModifiers(i,e.slice(7));n&&(n.trim&&(a=r.map(u=>isString(u)?u.trim():u)),n.number&&(a=r.map(looseToNumber)));let c,s=i[c=toHandlerKey(e)]||i[c=toHandlerKey(camelize(e))];!s&&l&&(s=i[c=toHandlerKey(hyphenate(e))]),s&&callWithAsyncErrorHandling(s,t,6,a);const d=i[c+"Once"];if(d){if(!t.emitted)t.emitted={};else if(t.emitted[c])return;t.emitted[c]=!0,callWithAsyncErrorHandling(d,t,6,a)}}function normalizeEmitsOptions(t,e,r=!1){const i=e.emitsCache,a=i.get(t);if(a!==void 0)return a;const l=t.emits;let n={},c=!1;if(!isFunction(t)){const s=d=>{const u=normalizeEmitsOptions(d,e,!0);u&&(c=!0,extend(n,u))};!r&&e.mixins.length&&e.mixins.forEach(s),t.extends&&s(t.extends),t.mixins&&t.mixins.forEach(s)}return!l&&!c?(isObject(t)&&i.set(t,null),null):(isArray(l)?l.forEach(s=>n[s]=null):extend(n,l),isObject(t)&&i.set(t,n),n)}function isEmitListener(t,e){return!t||!isOn(e)?!1:(e=e.slice(2).replace(/Once$/,""),hasOwn(t,e[0].toLowerCase()+e.slice(1))||hasOwn(t,hyphenate(e))||hasOwn(t,e))}function markAttrsAccessed(){}function renderComponentRoot(t){const{type:e,vnode:r,proxy:i,withProxy:a,propsOptions:[l],slots:n,attrs:c,emit:s,render:d,renderCache:u,props:h,data:o,setupState:f,ctx:m,inheritAttrs:g}=t,v=setCurrentRenderingInstance(t);let O,T;try{if(r.shapeFlag&4){const A=a||i,R=A;O=normalizeVNode(d.call(R,A,u,h,f,o,m)),T=c}else{const A=e;O=normalizeVNode(A.length>1?A(h,{attrs:c,slots:n,emit:s}):A(h,null)),T=e.props?c:getFunctionalFallthrough(c)}}catch(A){blockStack.length=0,handleError(A,t,1),O=createVNode(Comment)}let C=O;if(T&&g!==!1){const A=Object.keys(T),{shapeFlag:R}=C;A.length&&R&7&&(l&&A.some(isModelListener)&&(T=filterModelListeners(T,l)),C=cloneVNode(C,T,!1,!0))}return r.dirs&&(C=cloneVNode(C,null,!1,!0),C.dirs=C.dirs?C.dirs.concat(r.dirs):r.dirs),r.transition&&setTransitionHooks(C,r.transition),O=C,setCurrentRenderingInstance(v),O}const getFunctionalFallthrough=t=>{let e;for(const r in t)(r==="class"||r==="style"||isOn(r))&&((e||(e={}))[r]=t[r]);return e},filterModelListeners=(t,e)=>{const r={};for(const i in t)(!isModelListener(i)||!(i.slice(9)in e))&&(r[i]=t[i]);return r};function shouldUpdateComponent(t,e,r){const{props:i,children:a,component:l}=t,{props:n,children:c,patchFlag:s}=e,d=l.emitsOptions;if(e.dirs||e.transition)return!0;if(r&&s>=0){if(s&1024)return!0;if(s&16)return i?hasPropsChanged(i,n,d):!!n;if(s&8){const u=e.dynamicProps;for(let h=0;h<u.length;h++){const o=u[h];if(n[o]!==i[o]&&!isEmitListener(d,o))return!0}}}else return(a||c)&&(!c||!c.$stable)?!0:i===n?!1:i?n?hasPropsChanged(i,n,d):!0:!!n;return!1}function hasPropsChanged(t,e,r){const i=Object.keys(e);if(i.length!==Object.keys(t).length)return!0;for(let a=0;a<i.length;a++){const l=i[a];if(e[l]!==t[l]&&!isEmitListener(r,l))return!0}return!1}function updateHOCHostEl({vnode:t,parent:e},r){for(;e;){const i=e.subTree;if(i.suspense&&i.suspense.activeBranch===t&&(i.el=t.el),i===t)(t=e.vnode).el=r,e=e.parent;else break}}const isSuspense=t=>t.__isSuspense;function queueEffectWithSuspense(t,e){e&&e.pendingBranch?isArray(t)?e.effects.push(...t):e.effects.push(t):queuePostFlushCb(t)}const Fragment=Symbol.for("v-fgt"),Text=Symbol.for("v-txt"),Comment=Symbol.for("v-cmt"),Static=Symbol.for("v-stc"),blockStack=[];let currentBlock=null;function openBlock(t=!1){blockStack.push(currentBlock=t?null:[])}function closeBlock(){blockStack.pop(),currentBlock=blockStack[blockStack.length-1]||null}let isBlockTreeEnabled=1;function setBlockTracking(t,e=!1){isBlockTreeEnabled+=t,t<0&&currentBlock&&e&&(currentBlock.hasOnce=!0)}function setupBlock(t){return t.dynamicChildren=isBlockTreeEnabled>0?currentBlock||EMPTY_ARR:null,closeBlock(),isBlockTreeEnabled>0&&currentBlock&&currentBlock.push(t),t}function createElementBlock(t,e,r,i,a,l){return setupBlock(createBaseVNode(t,e,r,i,a,l,!0))}function isVNode(t){return t?t.__v_isVNode===!0:!1}function isSameVNodeType(t,e){return t.type===e.type&&t.key===e.key}const normalizeKey=({key:t})=>t??null,normalizeRef=({ref:t,ref_key:e,ref_for:r})=>(typeof t=="number"&&(t=""+t),t!=null?isString(t)||isRef(t)||isFunction(t)?{i:currentRenderingInstance,r:t,k:e,f:!!r}:t:null);function createBaseVNode(t,e=null,r=null,i=0,a=null,l=t===Fragment?0:1,n=!1,c=!1){const s={__v_isVNode:!0,__v_skip:!0,type:t,props:e,key:e&&normalizeKey(e),ref:e&&normalizeRef(e),scopeId:currentScopeId,slotScopeIds:null,children:r,component:null,suspense:null,ssContent:null,ssFallback:null,dirs:null,transition:null,el:null,anchor:null,target:null,targetStart:null,targetAnchor:null,staticCount:0,shapeFlag:l,patchFlag:i,dynamicProps:a,dynamicChildren:null,appContext:null,ctx:currentRenderingInstance};return c?(normalizeChildren(s,r),l&128&&t.normalize(s)):r&&(s.shapeFlag|=isString(r)?8:16),isBlockTreeEnabled>0&&!n&&currentBlock&&(s.patchFlag>0||l&6)&&s.patchFlag!==32&&currentBlock.push(s),s}const createVNode=_createVNode;function _createVNode(t,e=null,r=null,i=0,a=null,l=!1){if((!t||t===NULL_DYNAMIC_COMPONENT)&&(t=Comment),isVNode(t)){const c=cloneVNode(t,e,!0);return r&&normalizeChildren(c,r),isBlockTreeEnabled>0&&!l&&currentBlock&&(c.shapeFlag&6?currentBlock[currentBlock.indexOf(t)]=c:currentBlock.push(c)),c.patchFlag=-2,c}if(isClassComponent(t)&&(t=t.__vccOpts),e){e=guardReactiveProps(e);let{class:c,style:s}=e;c&&!isString(c)&&(e.class=normalizeClass(c)),isObject(s)&&(isProxy(s)&&!isArray(s)&&(s=extend({},s)),e.style=normalizeStyle(s))}const n=isString(t)?1:isSuspense(t)?128:isTeleport(t)?64:isObject(t)?4:isFunction(t)?2:0;return createBaseVNode(t,e,r,i,a,n,l,!0)}function guardReactiveProps(t){return t?isProxy(t)||isInternalObject(t)?extend({},t):t:null}function cloneVNode(t,e,r=!1,i=!1){const{props:a,ref:l,patchFlag:n,children:c,transition:s}=t,d=e?mergeProps(a||{},e):a,u={__v_isVNode:!0,__v_skip:!0,type:t.type,props:d,key:d&&normalizeKey(d),ref:e&&e.ref?r&&l?isArray(l)?l.concat(normalizeRef(e)):[l,normalizeRef(e)]:normalizeRef(e):l,scopeId:t.scopeId,slotScopeIds:t.slotScopeIds,children:c,target:t.target,targetStart:t.targetStart,targetAnchor:t.targetAnchor,staticCount:t.staticCount,shapeFlag:t.shapeFlag,patchFlag:e&&t.type!==Fragment?n===-1?16:n|16:n,dynamicProps:t.dynamicProps,dynamicChildren:t.dynamicChildren,appContext:t.appContext,dirs:t.dirs,transition:s,component:t.component,suspense:t.suspense,ssContent:t.ssContent&&cloneVNode(t.ssContent),ssFallback:t.ssFallback&&cloneVNode(t.ssFallback),el:t.el,anchor:t.anchor,ctx:t.ctx,ce:t.ce};return s&&i&&setTransitionHooks(u,s.clone(u)),u}function createTextVNode(t=" ",e=0){return createVNode(Text,null,t,e)}function normalizeVNode(t){return t==null||typeof t=="boolean"?createVNode(Comment):isArray(t)?createVNode(Fragment,null,t.slice()):isVNode(t)?cloneIfMounted(t):createVNode(Text,null,String(t))}function cloneIfMounted(t){return t.el===null&&t.patchFlag!==-1||t.memo?t:cloneVNode(t)}function normalizeChildren(t,e){let r=0;const{shapeFlag:i}=t;if(e==null)e=null;else if(isArray(e))r=16;else if(typeof e=="object")if(i&65){const a=e.default;a&&(a._c&&(a._d=!1),normalizeChildren(t,a()),a._c&&(a._d=!0));return}else{r=32;const a=e._;!a&&!isInternalObject(e)?e._ctx=currentRenderingInstance:a===3&&currentRenderingInstance&&(currentRenderingInstance.slots._===1?e._=1:(e._=2,t.patchFlag|=1024))}else isFunction(e)?(e={default:e,_ctx:currentRenderingInstance},r=32):(e=String(e),i&64?(r=16,e=[createTextVNode(e)]):r=8);t.children=e,t.shapeFlag|=r}function mergeProps(...t){const e={};for(let r=0;r<t.length;r++){const i=t[r];for(const a in i)if(a==="class")e.class!==i.class&&(e.class=normalizeClass([e.class,i.class]));else if(a==="style")e.style=normalizeStyle([e.style,i.style]);else if(isOn(a)){const l=e[a],n=i[a];n&&l!==n&&!(isArray(l)&&l.includes(n))&&(e[a]=l?[].concat(l,n):n)}else a!==""&&(e[a]=i[a])}return e}function invokeVNodeHook(t,e,r,i=null){callWithAsyncErrorHandling(t,e,7,[r,i])}const emptyAppContext=createAppContext();let uid=0;function createComponentInstance(t,e,r){const i=t.type,a=(e?e.appContext:t.appContext)||emptyAppContext,l={uid:uid++,vnode:t,type:i,parent:e,appContext:a,root:null,next:null,subTree:null,effect:null,update:null,job:null,scope:new EffectScope(!0),render:null,proxy:null,exposed:null,exposeProxy:null,withProxy:null,provides:e?e.provides:Object.create(a.provides),ids:e?e.ids:["",0,0],accessCache:null,renderCache:[],components:null,directives:null,propsOptions:normalizePropsOptions(i,a),emitsOptions:normalizeEmitsOptions(i,a),emit:null,emitted:null,propsDefaults:EMPTY_OBJ,inheritAttrs:i.inheritAttrs,ctx:EMPTY_OBJ,data:EMPTY_OBJ,props:EMPTY_OBJ,attrs:EMPTY_OBJ,slots:EMPTY_OBJ,refs:EMPTY_OBJ,setupState:EMPTY_OBJ,setupContext:null,suspense:r,suspenseId:r?r.pendingId:0,asyncDep:null,asyncResolved:!1,isMounted:!1,isUnmounted:!1,isDeactivated:!1,bc:null,c:null,bm:null,m:null,bu:null,u:null,um:null,bum:null,da:null,a:null,rtg:null,rtc:null,ec:null,sp:null};return l.ctx={_:l},l.root=e?e.root:l,l.emit=emit.bind(null,l),t.ce&&t.ce(l),l}let currentInstance=null,internalSetCurrentInstance,setInSSRSetupState;{const t=getGlobalThis(),e=(r,i)=>{let a;return(a=t[r])||(a=t[r]=[]),a.push(i),l=>{a.length>1?a.forEach(n=>n(l)):a[0](l)}};internalSetCurrentInstance=e("__VUE_INSTANCE_SETTERS__",r=>currentInstance=r),setInSSRSetupState=e("__VUE_SSR_SETTERS__",r=>isInSSRComponentSetup=r)}const setCurrentInstance=t=>{const e=currentInstance;return internalSetCurrentInstance(t),t.scope.on(),()=>{t.scope.off(),internalSetCurrentInstance(e)}},unsetCurrentInstance=()=>{currentInstance&&currentInstance.scope.off(),internalSetCurrentInstance(null)};function isStatefulComponent(t){return t.vnode.shapeFlag&4}let isInSSRComponentSetup=!1;function setupComponent(t,e=!1,r=!1){e&&setInSSRSetupState(e);const{props:i,children:a}=t.vnode,l=isStatefulComponent(t);initProps(t,i,l,e),initSlots(t,a,r);const n=l?setupStatefulComponent(t,e):void 0;return e&&setInSSRSetupState(!1),n}function setupStatefulComponent(t,e){const r=t.type;t.accessCache=Object.create(null),t.proxy=new Proxy(t.ctx,PublicInstanceProxyHandlers);const{setup:i}=r;if(i){pauseTracking();const a=t.setupContext=i.length>1?createSetupContext(t):null,l=setCurrentInstance(t),n=callWithErrorHandling(i,t,0,[t.props,a]),c=isPromise(n);if(resetTracking(),l(),(c||t.sp)&&!isAsyncWrapper(t)&&markAsyncBoundary(t),c){if(n.then(unsetCurrentInstance,unsetCurrentInstance),e)return n.then(s=>{handleSetupResult(t,s)}).catch(s=>{handleError(s,t,0)});t.asyncDep=n}else handleSetupResult(t,n)}else finishComponentSetup(t)}function handleSetupResult(t,e,r){isFunction(e)?t.type.__ssrInlineRender?t.ssrRender=e:t.render=e:isObject(e)&&(t.setupState=proxyRefs(e)),finishComponentSetup(t)}function finishComponentSetup(t,e,r){const i=t.type;t.render||(t.render=i.render||NOOP);{const a=setCurrentInstance(t);pauseTracking();try{applyOptions(t)}finally{resetTracking(),a()}}}const attrsProxyHandlers={get(t,e){return track(t,"get",""),t[e]}};function createSetupContext(t){const e=r=>{t.exposed=r||{}};return{attrs:new Proxy(t.attrs,attrsProxyHandlers),slots:t.slots,emit:t.emit,expose:e}}function getComponentPublicInstance(t){return t.exposed?t.exposeProxy||(t.exposeProxy=new Proxy(proxyRefs(markRaw(t.exposed)),{get(e,r){if(r in e)return e[r];if(r in publicPropertiesMap)return publicPropertiesMap[r](t)},has(e,r){return r in e||r in publicPropertiesMap}})):t.proxy}const classifyRE=/(?:^|[-_])(\w)/g,classify=t=>t.replace(classifyRE,e=>e.toUpperCase()).replace(/[-_]/g,"");function getComponentName(t,e=!0){return isFunction(t)?t.displayName||t.name:t.name||e&&t.__name}function formatComponentName(t,e,r=!1){let i=getComponentName(e);if(!i&&e.__file){const a=e.__file.match(/([^/\\]+)\.\w+$/);a&&(i=a[1])}if(!i&&t&&t.parent){const a=l=>{for(const n in l)if(l[n]===e)return n};i=a(t.components||t.parent.type.components)||a(t.appContext.components)}return i?classify(i):r?"App":"Anonymous"}function isClassComponent(t){return isFunction(t)&&"__vccOpts"in t}const computed=(t,e)=>computed$1(t,e,isInSSRComponentSetup),version="3.5.13";/**
* @vue/runtime-dom v3.5.13
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**/let policy;const tt=typeof window<"u"&&window.trustedTypes;if(tt)try{policy=tt.createPolicy("vue",{createHTML:t=>t})}catch{}const unsafeToTrustedHTML=policy?t=>policy.createHTML(t):t=>t,svgNS="http://www.w3.org/2000/svg",mathmlNS="http://www.w3.org/1998/Math/MathML",doc=typeof document<"u"?document:null,templateContainer=doc&&doc.createElement("template"),nodeOps={insert:(t,e,r)=>{e.insertBefore(t,r||null)},remove:t=>{const e=t.parentNode;e&&e.removeChild(t)},createElement:(t,e,r,i)=>{const a=e==="svg"?doc.createElementNS(svgNS,t):e==="mathml"?doc.createElementNS(mathmlNS,t):r?doc.createElement(t,{is:r}):doc.createElement(t);return t==="select"&&i&&i.multiple!=null&&a.setAttribute("multiple",i.multiple),a},createText:t=>doc.createTextNode(t),createComment:t=>doc.createComment(t),setText:(t,e)=>{t.nodeValue=e},setElementText:(t,e)=>{t.textContent=e},parentNode:t=>t.parentNode,nextSibling:t=>t.nextSibling,querySelector:t=>doc.querySelector(t),setScopeId(t,e){t.setAttribute(e,"")},insertStaticContent(t,e,r,i,a,l){const n=r?r.previousSibling:e.lastChild;if(a&&(a===l||a.nextSibling))for(;e.insertBefore(a.cloneNode(!0),r),!(a===l||!(a=a.nextSibling)););else{templateContainer.innerHTML=unsafeToTrustedHTML(i==="svg"?`<svg>${t}</svg>`:i==="mathml"?`<math>${t}</math>`:t);const c=templateContainer.content;if(i==="svg"||i==="mathml"){const s=c.firstChild;for(;s.firstChild;)c.appendChild(s.firstChild);c.removeChild(s)}e.insertBefore(c,r)}return[n?n.nextSibling:e.firstChild,r?r.previousSibling:e.lastChild]}},vtcKey=Symbol("_vtc");function patchClass(t,e,r){const i=t[vtcKey];i&&(e=(e?[e,...i]:[...i]).join(" ")),e==null?t.removeAttribute("class"):r?t.setAttribute("class",e):t.className=e}const vShowOriginalDisplay=Symbol("_vod"),vShowHidden=Symbol("_vsh"),CSS_VAR_TEXT=Symbol(""),displayRE=/(^|;)\s*display\s*:/;function patchStyle(t,e,r){const i=t.style,a=isString(r);let l=!1;if(r&&!a){if(e)if(isString(e))for(const n of e.split(";")){const c=n.slice(0,n.indexOf(":")).trim();r[c]==null&&setStyle(i,c,"")}else for(const n in e)r[n]==null&&setStyle(i,n,"");for(const n in r)n==="display"&&(l=!0),setStyle(i,n,r[n])}else if(a){if(e!==r){const n=i[CSS_VAR_TEXT];n&&(r+=";"+n),i.cssText=r,l=displayRE.test(r)}}else e&&t.removeAttribute("style");vShowOriginalDisplay in t&&(t[vShowOriginalDisplay]=l?i.display:"",t[vShowHidden]&&(i.display="none"))}const importantRE=/\s*!important$/;function setStyle(t,e,r){if(isArray(r))r.forEach(i=>setStyle(t,e,i));else if(r==null&&(r=""),e.startsWith("--"))t.setProperty(e,r);else{const i=autoPrefix(t,e);importantRE.test(r)?t.setProperty(hyphenate(i),r.replace(importantRE,""),"important"):t[i]=r}}const prefixes=["Webkit","Moz","ms"],prefixCache={};function autoPrefix(t,e){const r=prefixCache[e];if(r)return r;let i=camelize(e);if(i!=="filter"&&i in t)return prefixCache[e]=i;i=capitalize(i);for(let a=0;a<prefixes.length;a++){const l=prefixes[a]+i;if(l in t)return prefixCache[e]=l}return e}const xlinkNS="http://www.w3.org/1999/xlink";function patchAttr(t,e,r,i,a,l=isSpecialBooleanAttr(e)){i&&e.startsWith("xlink:")?r==null?t.removeAttributeNS(xlinkNS,e.slice(6,e.length)):t.setAttributeNS(xlinkNS,e,r):r==null||l&&!includeBooleanAttr(r)?t.removeAttribute(e):t.setAttribute(e,l?"":isSymbol(r)?String(r):r)}function patchDOMProp(t,e,r,i,a){if(e==="innerHTML"||e==="textContent"){r!=null&&(t[e]=e==="innerHTML"?unsafeToTrustedHTML(r):r);return}const l=t.tagName;if(e==="value"&&l!=="PROGRESS"&&!l.includes("-")){const c=l==="OPTION"?t.getAttribute("value")||"":t.value,s=r==null?t.type==="checkbox"?"on":"":String(r);(c!==s||!("_value"in t))&&(t.value=s),r==null&&t.removeAttribute(e),t._value=r;return}let n=!1;if(r===""||r==null){const c=typeof t[e];c==="boolean"?r=includeBooleanAttr(r):r==null&&c==="string"?(r="",n=!0):c==="number"&&(r=0,n=!0)}try{t[e]=r}catch{}n&&t.removeAttribute(a||e)}function addEventListener(t,e,r,i){t.addEventListener(e,r,i)}function removeEventListener(t,e,r,i){t.removeEventListener(e,r,i)}const veiKey=Symbol("_vei");function patchEvent(t,e,r,i,a=null){const l=t[veiKey]||(t[veiKey]={}),n=l[e];if(i&&n)n.value=i;else{const[c,s]=parseName(e);if(i){const d=l[e]=createInvoker(i,a);addEventListener(t,c,d,s)}else n&&(removeEventListener(t,c,n,s),l[e]=void 0)}}const optionsModifierRE=/(?:Once|Passive|Capture)$/;function parseName(t){let e;if(optionsModifierRE.test(t)){e={};let i;for(;i=t.match(optionsModifierRE);)t=t.slice(0,t.length-i[0].length),e[i[0].toLowerCase()]=!0}return[t[2]===":"?t.slice(3):hyphenate(t.slice(2)),e]}let cachedNow=0;const p=Promise.resolve(),getNow=()=>cachedNow||(p.then(()=>cachedNow=0),cachedNow=Date.now());function createInvoker(t,e){const r=i=>{if(!i._vts)i._vts=Date.now();else if(i._vts<=r.attached)return;callWithAsyncErrorHandling(patchStopImmediatePropagation(i,r.value),e,5,[i])};return r.value=t,r.attached=getNow(),r}function patchStopImmediatePropagation(t,e){if(isArray(e)){const r=t.stopImmediatePropagation;return t.stopImmediatePropagation=()=>{r.call(t),t._stopped=!0},e.map(i=>a=>!a._stopped&&i&&i(a))}else return e}const isNativeOn=t=>t.charCodeAt(0)===111&&t.charCodeAt(1)===110&&t.charCodeAt(2)>96&&t.charCodeAt(2)<123,patchProp=(t,e,r,i,a,l)=>{const n=a==="svg";e==="class"?patchClass(t,i,n):e==="style"?patchStyle(t,r,i):isOn(e)?isModelListener(e)||patchEvent(t,e,r,i,l):(e[0]==="."?(e=e.slice(1),!0):e[0]==="^"?(e=e.slice(1),!1):shouldSetAsProp(t,e,i,n))?(patchDOMProp(t,e,i),!t.tagName.includes("-")&&(e==="value"||e==="checked"||e==="selected")&&patchAttr(t,e,i,n,l,e!=="value")):t._isVueCE&&(/[A-Z]/.test(e)||!isString(i))?patchDOMProp(t,camelize(e),i,l,e):(e==="true-value"?t._trueValue=i:e==="false-value"&&(t._falseValue=i),patchAttr(t,e,i,n))};function shouldSetAsProp(t,e,r,i){if(i)return!!(e==="innerHTML"||e==="textContent"||e in t&&isNativeOn(e)&&isFunction(r));if(e==="spellcheck"||e==="draggable"||e==="translate"||e==="form"||e==="list"&&t.tagName==="INPUT"||e==="type"&&t.tagName==="TEXTAREA")return!1;if(e==="width"||e==="height"){const a=t.tagName;if(a==="IMG"||a==="VIDEO"||a==="CANVAS"||a==="SOURCE")return!1}return isNativeOn(e)&&isString(r)?!1:e in t}const getModelAssigner=t=>{const e=t.props["onUpdate:modelValue"]||!1;return isArray(e)?r=>invokeArrayFns(e,r):e};function onCompositionStart(t){t.target.composing=!0}function onCompositionEnd(t){const e=t.target;e.composing&&(e.composing=!1,e.dispatchEvent(new Event("input")))}const assignKey=Symbol("_assign"),vModelText={created(t,{modifiers:{lazy:e,trim:r,number:i}},a){t[assignKey]=getModelAssigner(a);const l=i||a.props&&a.props.type==="number";addEventListener(t,e?"change":"input",n=>{if(n.target.composing)return;let c=t.value;r&&(c=c.trim()),l&&(c=looseToNumber(c)),t[assignKey](c)}),r&&addEventListener(t,"change",()=>{t.value=t.value.trim()}),e||(addEventListener(t,"compositionstart",onCompositionStart),addEventListener(t,"compositionend",onCompositionEnd),addEventListener(t,"change",onCompositionEnd))},mounted(t,{value:e}){t.value=e??""},beforeUpdate(t,{value:e,oldValue:r,modifiers:{lazy:i,trim:a,number:l}},n){if(t[assignKey]=getModelAssigner(n),t.composing)return;const c=(l||t.type==="number")&&!/^0\d/.test(t.value)?looseToNumber(t.value):t.value,s=e??"";c!==s&&(document.activeElement===t&&t.type!=="range"&&(i&&e===r||a&&t.value.trim()===s)||(t.value=s))}},rendererOptions=extend({patchProp},nodeOps);let renderer;function ensureRenderer(){return renderer||(renderer=createRenderer(rendererOptions))}const createApp=(...t)=>{const e=ensureRenderer().createApp(...t),{mount:r}=e;return e.mount=i=>{const a=normalizeContainer(i);if(!a)return;const l=e._component;!isFunction(l)&&!l.render&&!l.template&&(l.template=a.innerHTML),a.nodeType===1&&(a.textContent="");const n=r(a,!1,resolveRootNamespace(a));return a instanceof Element&&(a.removeAttribute("v-cloak"),a.setAttribute("data-v-app","")),n},e};function resolveRootNamespace(t){if(t instanceof SVGElement)return"svg";if(typeof MathMLElement=="function"&&t instanceof MathMLElement)return"mathml"}function normalizeContainer(t){return isString(t)?document.querySelector(t):t}function getDefaultExportFromCjs(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var NERTC$1={exports:{}};/*! NeRTC 5.6.50|BUILD v5.6.50-0-gaaf117b6 production 20241225 */(function(module,exports){(function(t,e){module.exports=e()})(window,function(){return function(t){var e={};function r(i){if(e[i])return e[i].exports;var a=e[i]={i,l:!1,exports:{}};return t[i].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=t,r.c=e,r.d=function(i,a,l){r.o(i,a)||Object.defineProperty(i,a,{enumerable:!0,get:l})},r.r=function(i){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(i,"__esModule",{value:!0})},r.t=function(i,a){if(1&a&&(i=r(i)),8&a||4&a&&typeof i=="object"&&i&&i.__esModule)return i;var l=Object.create(null);if(r.r(l),Object.defineProperty(l,"default",{enumerable:!0,value:i}),2&a&&typeof i!="string")for(var n in i)r.d(l,n,(function(c){return i[c]}).bind(null,n));return l},r.n=function(i){var a=i&&i.__esModule?function(){return i.default}:function(){return i};return r.d(a,"a",a),a},r.o=function(i,a){return Object.prototype.hasOwnProperty.call(i,a)},r.p="",r(r.s=209)}([function(t,e){var r=t.exports=typeof window<"u"&&window.Math==Math?window:typeof self<"u"&&self.Math==Math?self:Function("return this")();typeof __g=="number"&&(__g=r)},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.getParameters=void 0;const i=r(84);let a={tracks:{audio:[],video:[]},logUpload:!1,reportWS:null,shimVideoOrientation:"never",shimCanvas:"ios151",clients:[],localStreams:[],debugG2:!1,passEnvCheck:!1,enableAlerter:"never",videoLowMaxWidth:320,videoLowMaxHeight:180,videoLowFramerate:15,videoLowCheckCanvasBlank:"ios",screenLowMaxWidth:320,screenLowMaxHeight:180,screenLowFramerate:15,controlOnPaused:!0,hideControlOnResume:!0,maxTransportRebuildCnt:Number.MAX_SAFE_INTEGER,logLevel:i.loglevels.INFO,forceLogLevel:-1,forceLogUpload:"default",forceGeofenceArea:"NONE",forceListenDeviceChange:!0,codecOptions:{audio:{opusStereo:!0,opusDtx:!0}},videoHighStartBitrate:1e3,videoHighMinBitrate:0,videoLowStartBitrate:500,videoLowMinBitrate:0,screenHighStartBitrate:2e3,screenHighMinBitrate:0,screenLowStartBitrate:500,screenLowMinBitrate:0,screenFocus:"no-focus-change",screenSurfaceSwitching:"default",screenDisplaySurface:"default",screenPreferCurrentTab:!1,screenSelfBrowserSurface:"default",allowEmptyMedia:!0,keepLocalstreamOnLeave:!1,joinFirstTimeout:2e3,joinMaxRetry:3,reconnectionFirstTimeout:2e3,reconnectionMaxRetry:3,signalProbeEnabled:!0,peerLeaveEventOnReconnect:!0,leaveOnUnload:!0,trustOnOnline:!0,trustOnOffline:!1,trustUnhandledrejection:!1,h264Wait:1e3,encoderWatermarkLimit:1,encoderWatermarkFontFamily:"Verdana",forceEncodedInsertableStreams:!1,forceCustomEncryptionOff:!1,h264StrictHigh:!1,disableH264Send:!1,disableVP8Send:!1,enableTcpCandidate:!0,enableUdpCandidate:!0,maxEventLoopLagWarning:3,enableCompatAudio:!1,audioInputcompatMode:"auto",fireBackupDelay:5e3,audioAslFlag:!0,keepAspectRatio:!1,disableLBSService:!1,lbsUseBuiltinOnly:!1,protooMessageTimeout:3e4,reuseMid:!0,playMediaTimeout:3e3,playMediaTimeoutForAutoplay:6e3,disableWebAudio:!1,disable2dContext:!1,disableWebGLContext:!1,disableAllReports:!1,reportPageBrowserId:!0,doHeartbeatInterval:1e3,deviceChangeInterval:0,h264ProfileLevel:"42e01f",h264ProfileLevelSignal:"42e01f",enableSdpRrtr:"chrome",forceBWE:"no",forceAGC:"no",forceANS:"no",forceAEC:"no",forceChannelCount:-1,forceLatency:-1,forceSampleRate:-1,revertSubstreamProduceType:!1,moreNotAllowedError:!1,replaceIdealConstraint:"safari16_screen",shimLocalCanvas:"safari",enableVSkip:!0,statsLogMaxCnt:3,showStatsLog:!1,chromeLegacyDefault:"unknown",audioLevelFittingAlgorithm:"log2",audioLevelRatioRemote:1,statsHistoryInterval:3e3,signalingMessageDelay:0,reconnectionMaxTimeout:0,reconnectionWaitTimeout:5e3,activeSpeakerMin:10,audioPlayoutDelayHint:0,videoPlayoutDelayHint:0,userType:3,forceDisplaySurface:"default"};try{if(location.search&&typeof URLSearchParams=="function"){const l=new URLSearchParams(location.search);let n;for(n in a){const c=a[n],s=l.get(n);if(s){let d=null;typeof c=="string"?d=s:typeof c=="boolean"?s!=="true"&&s!=="false"||(d=s==="true"):typeof c=="number"&&(d=Number(s),Number(s)>Number.MIN_SAFE_INTEGER&&(d=Number(s))),d!==null&&c!==d&&(console.warn(`NERTC 通过URL改变了私有化变量：${n}:`,c,"=>",d),a[n]=d)}}}}catch{}e.getParameters=()=>a},function(t,e,r){var i=r(36)("wks"),a=r(24),l=r(0).Symbol,n=typeof l=="function";(t.exports=function(c){return i[c]||(i[c]=n&&l[c]||(n?l:a)("Symbol."+c))}).store=i},function(t,e,r){var i=Object.prototype.hasOwnProperty,a="~";function l(){}function n(s,d,u){this.fn=s,this.context=d,this.once=u||!1}function c(){this._events=new l,this._eventsCount=0}Object.create&&(l.prototype=Object.create(null),new l().__proto__||(a=!1)),c.prototype.eventNames=function(){var s,d,u=[];if(this._eventsCount===0)return u;for(d in s=this._events)i.call(s,d)&&u.push(a?d.slice(1):d);return Object.getOwnPropertySymbols?u.concat(Object.getOwnPropertySymbols(s)):u},c.prototype.listeners=function(s,d){var u=a?a+s:s,h=this._events[u];if(d)return!!h;if(!h)return[];if(h.fn)return[h.fn];for(var o=0,f=h.length,m=new Array(f);o<f;o++)m[o]=h[o].fn;return m},c.prototype.emit=function(s,d,u,h,o,f){var m=a?a+s:s;if(!this._events[m])return!1;var g,v,O=this._events[m],T=arguments.length;if(O.fn){switch(O.once&&this.removeListener(s,O.fn,void 0,!0),T){case 1:return O.fn.call(O.context),!0;case 2:return O.fn.call(O.context,d),!0;case 3:return O.fn.call(O.context,d,u),!0;case 4:return O.fn.call(O.context,d,u,h),!0;case 5:return O.fn.call(O.context,d,u,h,o),!0;case 6:return O.fn.call(O.context,d,u,h,o,f),!0}for(v=1,g=new Array(T-1);v<T;v++)g[v-1]=arguments[v];O.fn.apply(O.context,g)}else{var C,A=O.length;for(v=0;v<A;v++)switch(O[v].once&&this.removeListener(s,O[v].fn,void 0,!0),T){case 1:O[v].fn.call(O[v].context);break;case 2:O[v].fn.call(O[v].context,d);break;case 3:O[v].fn.call(O[v].context,d,u);break;case 4:O[v].fn.call(O[v].context,d,u,h);break;default:if(!g)for(C=1,g=new Array(T-1);C<T;C++)g[C-1]=arguments[C];O[v].fn.apply(O[v].context,g)}}return!0},c.prototype.on=function(s,d,u){var h=new n(d,u||this),o=a?a+s:s;return this._events[o]?this._events[o].fn?this._events[o]=[this._events[o],h]:this._events[o].push(h):(this._events[o]=h,this._eventsCount++),this},c.prototype.once=function(s,d,u){var h=new n(d,u||this,!0),o=a?a+s:s;return this._events[o]?this._events[o].fn?this._events[o]=[this._events[o],h]:this._events[o].push(h):(this._events[o]=h,this._eventsCount++),this},c.prototype.removeListener=function(s,d,u,h){var o=a?a+s:s;if(!this._events[o])return this;if(!d)return--this._eventsCount==0?this._events=new l:delete this._events[o],this;var f=this._events[o];if(f.fn)f.fn!==d||h&&!f.once||u&&f.context!==u||(--this._eventsCount==0?this._events=new l:delete this._events[o]);else{for(var m=0,g=[],v=f.length;m<v;m++)(f[m].fn!==d||h&&!f[m].once||u&&f[m].context!==u)&&g.push(f[m]);g.length?this._events[o]=g.length===1?g[0]:g:--this._eventsCount==0?this._events=new l:delete this._events[o]}return this},c.prototype.removeAllListeners=function(s){var d;return s?(d=a?a+s:s,this._events[d]&&(--this._eventsCount==0?this._events=new l:delete this._events[d])):(this._events=new l,this._eventsCount=0),this},c.prototype.off=c.prototype.removeListener,c.prototype.addListener=c.prototype.on,c.prototype.setMaxListeners=function(){return this},c.prefixed=a,c.EventEmitter=c,t.exports=c},function(t,e){var r=t.exports={version:"2.6.12"};typeof __e=="number"&&(__e=r)},function(t,e,r){var i=r(11);t.exports=function(a){if(!i(a))throw TypeError(a+" is not an object!");return a}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.default={PAGE_UNLOAD:3e4,LOGIN_FAILED:30001,MEDIA_CONNECTION_DISCONNECTED:30204,SIGNAL_CONNECTION_DISCONNECTED:30205,CLIENT_BANNED:30206,CHANNEL_CLOSED:30207,UID_DUPLICATE:30209,PERMKEY_TIMEOUT:30902,AUTO_PLAY_NOT_ALLOWED:41030,INVALID_PARAMETER_ERROR:1e4,NOT_SUPPORT_ERROR:10001,NETWORK_ERROR:10002,NETWORK_REQUEST_ERROR:10003,INVALID_OPERATION_ERROR:10008,API_CALL_SEQUENCE_BEFORE_ERROR:10009,API_CALL_SEQUENCE_AFTER_ERROR:10010,LOCALSTREAM_NOT_FOUND_ERROR:10011,UNKNOWN_TYPE_ERROR:10012,LOGIN_REQUEST_ERROR:10017,RECONNECTING:10020,SERVER_UNKNOWN_ERROR:10099,JOIN_FAILED:10100,REPEAT_JOIN_ERROR:10101,USER_NOT_IN_CHANNEL_ERROR:10104,JOIN_PERMKEY_ERROR:10109,JOIN_WITHOUT_CHANNEL_NAME:10110,JOIN_RECORD_TYPE_ERROR:10111,JOIN_UID_TYPE_ERROR:10112,SERVER_AUTH_ERROR:10119,SET_CHANNEL_PROFILE_INVALID_PARAMETER_ERROR:10121,TASKS_ROLE_ERROR:10131,ADD_TASK_PARAMETER_ERROR:10132,ADD_TASK_FAILED_ERROR:10133,DELETE_TASK_PARAMETER_ERROR:10134,DELETE_TASK_FAILED_ERROR:10135,UPDATE_TASK_PARAMETER_ERROR:10136,UPDATE_TASKS_FAILED_ERROR:10137,STREAM_UID_ERROR:10210,STREAM_PROFILE_ERROR:10211,MEDIA_DEVICE_ERROR:10212,STREAM_PLAY_ARGUMENT_ERROR:10215,STREAM_RENDER_ARGUMENT_ERROR:10216,STREAM_ISPLAYING_ARGUMENT_ERROR:10218,STREAM_OPTN_NO_TYPE_ERROR:10220,REPEAT_OPEN_MIC_ERROR:10221,REPEAT_OPEN_AUDIO_SLAVE_ERROR:10222,REPEAT_OPEN_CAMERA_ERROR:10223,REPEAT_OPEN_SCREEN_ERROR:10224,STREAM_CLOSE_ARGUMENT_ERROR:10228,STREAM_CLOSE_AUDIO_ERROR:10229,STREAM_CLOSE_AUDIO_SLAVE_ERROR:10230,STREAM_CLOSE_CAMERA_ERROR:10231,STREAM_CLOSE_SCREEN_ERROR:10232,STREAM_NOT_SUBSCRIBE_AUDIO:10240,STREAM_NOT_SUBSCRIBE_AUDIO_SLAVE:10241,STREAM_SET_CAPTURE_VOLUME_ARGUMENT_ERROR:10242,STREAM_TAKE_SNAPSHOT_ERROR:10247,STREAM_TAKE_SNAPSHOT_NO_CANVAS_ERROR:10248,SET_AUDIO_VOLUME_ARGUMENTS_ERROR:10250,SET_AUDIO_VOLUME_ERROR:10251,SET_CAPTURE_VOLUME_ARGUMENTS_ERROR:10252,SET_AUDIO_OUTPUT_ERROR:10253,SWITCH_DEVICE_REPEAT_ARGUMENTS_ERROR:10254,SWITCH_DEVICE_REPEAT_ERROR:10255,SWITCH_DEVICE_NO_MIC_ERROR:10256,SWITCH_DEVICE_NO_SUPPORT_AUDIO:10257,SWITCH_DEVICE_NO_CAMERA_ERROR:10258,SWITCH_DEVICE_NO_SUPPORT_VIDEO:10259,STREAM_MUTE_AUDIO_ERROR:10265,STREAM_NOT_MUTE_AUDIO_YET:10266,STREAM_UNMUTE_AUDIO_WITHOUT_STREAM:10267,STREAM_MUTE_AUDIO_SLAVE_ERROR:10270,STREAM_NOT_MUTE_AUDIO_SLAVE_YET:10271,STREAM_UNMUTE_AUDIO_SLAVE_WITHOUT_STREAM:10272,STREAM_MUTE_VIDEO_ERROR:10275,STREAM_NOT_MUTE_VIDEO_YET:10276,STREAM_UNMUTE_VIDEO_WITHOUT_STREAM:10277,STREAM_MUTE_SCREEN_ERROR:10280,STREAM_NOT_MUTE_SCREEN_YET:10281,STREAM_UNMUTE_SCREEN_WITHOUT_STREAM:10282,STREAM_MUTE_VIDEO_THIRD_ERROR:10284,STREAM_NOT_MUTE_VIDEO_THIRD_YET:10285,STREAM_UNMUTE_VIDEO_THIRD_WITHOUT_STREAM:10286,STREAM_MUTE_VIDEO_FOURTH_ERROR:10287,STREAM_NOT_MUTE_VIDEO_FOURTH_YET:10288,STREAM_UNMUTE_VIDEO_FOURTH_WITHOUT_STREAM:10289,ASR_CAPTIONS_ERROR:10283,NOT_PUBLISHED:10340,NOT_SUBSCRIBED:10341,CONSUME_START:10342,NOT_OPENED:10345,ENDED:10346,PAUSED:10347,PLAYING:10348,MUTED:10347,INVALID_STATE:10349,PUBLISH_NO_STREAM:10350,PUBLISH_ROLE_ERROR:10351,PUBLISH_SERVER_ERROR:10355,SUBSCRIBE_SERVER_ERROR:10360,WEBGL_NOT_SUPPORT_ERROR:10401,WEBGL_LOSE_CONTEXT_ERROR:10402,WEBGL_RESTORED_FAILD_ERROR:10403,BASIC_BEAUTY_RES_ERROR:10404,ADV_BEAUTY_RES_ERROR:10405,PLUGIN_LOADED_ERROR:10406,PLUGIN_ERROR:10407,PLUGIN_REGISTER_ERROR:10408,PLUGIN_NOT_REGISTER:10409,PLUGIN_NOT_SUPPORT:10410,PLUGIN_NOT_SUPPORT_BROWSER:10411,WEBGL_NOT_INIT:10412,PLUGIN_VERSION_ERROR:10413,AUDIO_MIX_NO_AUDIO:10420,AUDIO_MIX_FILE_ERROR:10421,AUDIO_MIX_NO_SUPPORT:10422,AUDIO_MIX_NOT_STATE_ERROR:10423,AUDIO_MIX_NOT_PAUSE:10424,AUDIO_MIX_VOLUME_ERROR:10425,AUDIO_MIX_PLAY_START_TIME_ERROR:10426,AUDIO_EFFECT_NO_SUPPORT:10430,AUDIO_EFFECT_FILE_ERROR:10431,AUDIO_EFFECT_NO_AUDIO:10432,AUDIO_EFFECT_NOT_STATE_ERROR:10433,AUDIO_EFFECT_FILE_LOST_ERROR:10434,AUDIO_EFFECT_NOT_PAUSE:10435,AUDIO_EFFECT_PLAY_ALREADY:10436,AUDIO_EFFECT_ERROR:10437,SET_LOCAL_MEDIA_PRIORITY_ARGUMENT_ERROR:10445,UPDATE_PERMKEY_ERROR:10446,RECORDING_NOT_SUPPORT:10450,REPEAT_RECORDING_ERROR:10451,RECORDING_CACHE_ERROR:10452,RECORDING_ERROR:10453,RECORDING_NOT_START_ERROR:10454,WATERMARKS_EXCEEDED_ERROR:10460,LBS_REQUEST_ERROR:10461,LBS_JSON_ERROR:10462,CUSTOM_TRANSFOR_NOT_SUPPORT_ERROR:10471,SET_ENCRYPTION_MODE_ERROR:10472,SET_ENCRYPTION_SECRET_INVALID_OPERATION_ERROR:10473,ROLE_TYPE_ERROR:10477,GET_SYSTEM_STATS_NOT_SUPPORT_ERROR:10480,SET_CLIENT_ROLE_ERROR:10490,CLIENT_ALREADY_IN_CHANNEL_ERROR:10500}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.ELECTRON_VERSION=e.IS_ELECTRON=e.IS_UCBROWSER=e.IS_WX=e.IS_LINUX=e.MACOS_VERSION=e.IS_MAC=e.WIN_VERSION=e.IS_WIN=e.IPADQQB_VERSION=e.IS_IPADQQB=e.MACQQB_VERSION=e.IS_MACQQB=e.WQQB_VERSION=e.IS_WQQB=e.MQQB_VERSION=e.IS_MQQB=e.IS_X5MQQB=e.WECHAT_MAJOR_VERSION=e.WECHAT_VERSION=e.IS_WECHAT=e.IE_VERSION=e.IS_IE=e.IS_IE8=e.XWEB_VERSION=e.IS_XWEB=e.TBS_VERSION=e.IS_TBS=e.SOGOU_VERSION=e.IS_SOGOU=e.SOGOUM_VERSION=e.IS_SOGOUM=e.EDG_VERSION=e.EDG_MAJOR_VERSION=e.IS_EDG=e.EDGE_VERSION=e.IS_EDGE=e.FIREFOX_MAJOR_VERSION=e.FIREFOX_VERSION=e.IS_FIREFOX=e.ANDROID_VERSION=e.IS_ANDROID=e.IOS_MAJOR_VERSION=e.IOS_VERSION=e.IS_IOS=e.IS_IPOD=e.IS_IPHONE=e.IS_IPAD=e.USER_LANGUAGE=e.USER_AGENT=void 0,e.IS_EN=e.IS_ZH=e.IS_LOCAL=e.IS_IOS_SAFARI=e.IS_MAC_SAFARI=e.SAFARI_VERSION=e.SAFARI_MAJOR_VERSION=e.IS_ANY_SAFARI=e.IS_SAFARI=e.IOS_FIREFOX_MAJOR_VERSION=e.IOS_FIREFOX_VERSION=e.IS_IOS_FIREFOX=e.IOS_EDGE_MAJOR_VERSION=e.IOS_EDGE_VERSION=e.IS_IOS_EDGE=e.IOS_CHROME_MAJOR_VERSION=e.IOS_CHROME_VERSION=e.IS_IOS_CHROME=e.ANY_CHROME_MAJOR_VERSION=e.CHROME_VERSION=e.CHROME_MAJOR_VERSION=e.IS_CHROME=e.IS_CHROME_ONLY=e.VIVO_VERSION=e.IS_VIVOBROWSER=e.OPPO_VERSION=e.IS_OPPOBROWSER=e.SAMSUNG_VERSION=e.IS_SAMSUNGBROWSER=e.HUAWEI_VERSION=e.IS_HUAWEIBROWSER=e.MI_VERSION=e.IS_MIBROWSER=void 0,e.USER_AGENT=window.navigator&&window.navigator.userAgent||"",e.USER_LANGUAGE=window.navigator&&window.navigator.language,e.IS_IPAD=/iPad/i.test(e.USER_AGENT),e.IS_IPHONE=/iPhone/i.test(e.USER_AGENT)&&!e.IS_IPAD,e.IS_IPOD=/iPod/i.test(e.USER_AGENT),e.IS_IOS=e.IS_IPHONE||e.IS_IPAD||e.IS_IPOD,e.IOS_VERSION=e.IS_IOS&&function(){const i=e.USER_AGENT.match(/\b[0-9]+_[0-9]+(?:_[0-9]+)?\b/)||[""];return i&&i[0]?i[0].replace(/_/g,"."):null}(),e.IOS_MAJOR_VERSION=e.IOS_VERSION&&function(){const i=e.IOS_VERSION.match(/\d+.?\d/);return i&&i[0]?parseFloat(i[0]):null}(),e.IS_ANDROID=/Android/i.test(e.USER_AGENT),e.ANDROID_VERSION=e.IS_ANDROID&&function(){const i=e.USER_AGENT.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(!i)return null;const a=i[1],l=i[2],n=i[3];return a&&l&&n?a+"."+l+"."+n:a&&l?a+"."+l:a||null}(),e.IS_FIREFOX=/Firefox/i.test(e.USER_AGENT),e.FIREFOX_VERSION=e.IS_FIREFOX&&function(){const i=navigator.userAgent.match(/Firefox\/([\d.]+)/);return i&&i[1]?i[1]:null}(),e.FIREFOX_MAJOR_VERSION=e.IS_FIREFOX&&function(){const i=e.USER_AGENT.match(/Firefox\/(\d+)/);return i&&i[1]?parseFloat(i[1]):null}(),e.IS_EDGE=/Edge\//i.test(e.USER_AGENT),e.EDGE_VERSION=e.IS_EDGE&&function(){var i=e.USER_AGENT.match(/Edge\/(\d+)/i);if(i&&i[1])return i[1]}(),e.IS_EDG=/Edg\//i.test(e.USER_AGENT),e.EDG_MAJOR_VERSION=e.IS_EDG&&function(){const i=e.USER_AGENT.match(/Edg\/(\d+)/);return i&&i[1]?parseFloat(i[1]):null}(),e.EDG_VERSION=e.IS_EDG&&function(){const i=e.USER_AGENT.match(/Edg\/([\d.]+)/);return i&&i[1]?i[1]:null}(),e.IS_SOGOUM=/SogouMobileBrowser\//i.test(e.USER_AGENT),e.SOGOUM_VERSION=e.IS_SOGOUM&&function(){const i=e.USER_AGENT.match(/SogouMobileBrowser\/(\d+)/);return i&&i[1]?parseFloat(i[1]):null}(),e.IS_SOGOU=/MetaSr\s/i.test(e.USER_AGENT),e.SOGOU_VERSION=e.IS_SOGOU&&function(){const i=e.USER_AGENT.match(/MetaSr(\s\d+(\.\d+)+)/);return i&&i[1]?parseFloat(i[1]):null}(),e.IS_TBS=/TBS\/\d+/i.test(e.USER_AGENT),e.TBS_VERSION=e.IS_TBS&&function(){var i=e.USER_AGENT.match(/TBS\/(\d+)/i);if(i&&i[1])return i[1]}(),e.IS_XWEB=/XWEB\/\d+/i.test(e.USER_AGENT),e.XWEB_VERSION=e.IS_XWEB&&function(){var i=e.USER_AGENT.match(/XWEB\/(\d+)/i);if(i&&i[1])return i[1]}(),e.IS_IE8=/MSIE\s8\.0/.test(e.USER_AGENT),e.IS_IE=/MSIE\/\d+/i.test(e.USER_AGENT),e.IE_VERSION=e.IS_IE&&function(){const i=/MSIE\s(\d+)\.\d/.exec(e.USER_AGENT);let a=i&&parseFloat(i[1]);return!a&&/Trident\/7.0/i.test(e.USER_AGENT)&&/rv:11.0/.test(e.USER_AGENT)&&(a=11),a}(),e.IS_WECHAT=/(micromessenger|webbrowser)/i.test(e.USER_AGENT),e.WECHAT_VERSION=e.IS_WECHAT&&function(){var i=navigator.userAgent.match(/MicroMessenger\/([\d.]+)/);if(i&&i[1])return i[1]}(),e.WECHAT_MAJOR_VERSION=e.IS_WECHAT&&function(){var i=e.USER_AGENT.match(/MicroMessenger\/(\d+)/i);if(i&&i[1])return parseFloat(i[1])}(),e.IS_X5MQQB=!e.IS_TBS&&/MQQBrowser\/\d+/i.test(e.USER_AGENT)&&/COVC\/\d+/i.test(e.USER_AGENT),e.IS_MQQB=!e.IS_TBS&&/MQQBrowser\/\d+/i.test(e.USER_AGENT)&&!/COVC\/\d+/i.test(e.USER_AGENT),e.MQQB_VERSION=(e.IS_MQQB||e.IS_X5MQQB)&&function(){const i=e.USER_AGENT.match(/ MQQBrowser\/([\d.]+)/);return i&&i[1]?i[1]:null}(),e.IS_WQQB=!e.IS_TBS&&/ QQBrowser\/\d+/i.test(e.USER_AGENT),e.WQQB_VERSION=e.IS_WQQB&&function(){const i=e.USER_AGENT.match(/ QQBrowser\/([\d.]+)/);return i&&i[1]?i[1]:null}(),e.IS_MACQQB=!e.IS_TBS&&/QQBrowserLite\/\d+/i.test(e.USER_AGENT),e.MACQQB_VERSION=e.IS_MACQQB&&function(){const i=e.USER_AGENT.match(/QQBrowserLite\/([\d.]+)/);return i&&i[1]?i[1]:null}(),e.IS_IPADQQB=!e.IS_TBS&&/MQBHD\/\d+/i.test(e.USER_AGENT),e.IPADQQB_VERSION=e.IS_IPADQQB&&function(){const i=e.USER_AGENT.match(/MQBHD\/([\d.]+)/);return i&&i[1]?i[1]:null}(),e.IS_WIN=/Windows/i.test(e.USER_AGENT),e.WIN_VERSION=e.IS_WIN&&function(){const i=e.USER_AGENT.match(/Windows NT (\d+)(?:\.(\d+))?(?:\.(\d+))*/i),a=i&&i[1],l=i&&i[2];return a&&l?a+"."+l:a||null}(),e.IS_MAC=!e.IS_IOS&&/MAC OS X/i.test(e.USER_AGENT),e.MACOS_VERSION=e.IS_MAC&&function(){const i=e.USER_AGENT.match(/\b[0-9]+_[0-9]+(?:_[0-9]+)?\b/)||[""];return i&&i[0]?i[0].replace(/_/g,"."):null}(),e.IS_LINUX=!e.IS_ANDROID&&/Linux/i.test(e.USER_AGENT),e.IS_WX=/MicroMessenger/i.test(e.USER_AGENT),e.IS_UCBROWSER=/UCBrowser/i.test(e.USER_AGENT),e.IS_ELECTRON=/Electron/i.test(e.USER_AGENT),e.ELECTRON_VERSION=e.IS_ELECTRON&&function(){const i=e.USER_AGENT.match(/Electron\/([\d.]+)/);return i&&i[1]?i[1]:null}(),e.IS_MIBROWSER=/MiuiBrowser/i.test(e.USER_AGENT),e.MI_VERSION=e.IS_MIBROWSER&&function(){const i=e.USER_AGENT.match(/MiuiBrowser\/([\d.]+)/);return i&&i[1]?i[1]:null}(),e.IS_HUAWEIBROWSER=/HuaweiBrowser/i.test(e.USER_AGENT),e.HUAWEI_VERSION=e.IS_HUAWEIBROWSER&&function(){const i=e.USER_AGENT.match(/HuaweiBrowser\/([\d.]+)/);return i&&i[1]?i[1]:null}(),e.IS_SAMSUNGBROWSER=/SamsungBrowser/i.test(e.USER_AGENT),e.SAMSUNG_VERSION=e.IS_SAMSUNGBROWSER&&function(){const i=e.USER_AGENT.match(/SamsungBrowser\/([\d.]+)/);return i&&i[1]?i[1]:null}(),e.IS_OPPOBROWSER=/HeyTapBrowser/i.test(e.USER_AGENT),e.OPPO_VERSION=e.IS_OPPOBROWSER&&function(){const i=e.USER_AGENT.match(/HeyTapBrowser\/([\d.]+)/);return i&&i[1]?i[1]:null}(),e.IS_VIVOBROWSER=/VivoBrowser/i.test(e.USER_AGENT),e.VIVO_VERSION=e.IS_VIVOBROWSER&&function(){const i=e.USER_AGENT.match(/VivoBrowser\/([\d.]+)/);return i&&i[1]?i[1]:null}(),e.IS_CHROME_ONLY=/Chrome/i.test(e.USER_AGENT),e.IS_CHROME=!e.IS_EDGE&&!e.IS_SOGOU&&!e.IS_SOGOUM&&!e.IS_TBS&&!e.IS_XWEB&&!e.IS_EDG&&!e.IS_WQQB&&!e.IS_MIBROWSER&&!e.IS_HUAWEIBROWSER&&!e.IS_SAMSUNGBROWSER&&!e.IS_OPPOBROWSER&&!e.IS_VIVOBROWSER&&/Chrome/i.test(e.USER_AGENT),e.CHROME_MAJOR_VERSION=e.IS_CHROME&&function(){const i=e.USER_AGENT.match(/Chrome\/(\d+)/);return i&&i[1]?parseFloat(i[1]):null}(),e.CHROME_VERSION=e.IS_CHROME&&function(){const i=e.USER_AGENT.match(/Chrome\/([\d.]+)/);return i&&i[1]?i[1]:null}(),e.ANY_CHROME_MAJOR_VERSION=function(){const i=e.USER_AGENT.match(/Chrome\/(\d+)/);return i&&i[1]?parseFloat(i[1]):null}(),e.IS_IOS_CHROME=/CriOS/i.test(e.USER_AGENT),e.IOS_CHROME_VERSION=e.IS_IOS_CHROME&&function(){const i=e.USER_AGENT.match(/CriOS\/([\d.]+)/);return i&&i[1]?i[1]:null}(),e.IOS_CHROME_MAJOR_VERSION=e.IS_IOS_CHROME&&function(){const i=e.USER_AGENT.match(/CriOS\/(\d+)/);return i&&i[1]?parseFloat(i[1]):null}(),e.IS_IOS_EDGE=/EdgiOS/i.test(e.USER_AGENT),e.IOS_EDGE_VERSION=e.IS_IOS_EDGE&&function(){const i=e.USER_AGENT.match(/EdgiOS\/([\d.]+)/);return i&&i[1]?i[1]:null}(),e.IOS_EDGE_MAJOR_VERSION=e.IS_IOS_EDGE&&function(){const i=e.USER_AGENT.match(/EdgiOS\/(\d+)/);return i&&i[1]?parseFloat(i[1]):null}(),e.IS_IOS_FIREFOX=/FxiOS/i.test(e.USER_AGENT),e.IOS_FIREFOX_VERSION=e.IS_IOS_FIREFOX&&function(){const i=e.USER_AGENT.match(/FxiOS\/([\d.]+)/);return i&&i[1]?i[1]:null}(),e.IOS_FIREFOX_MAJOR_VERSION=e.IS_IOS_FIREFOX&&function(){const i=e.USER_AGENT.match(/FxiOS\/(\d+)/);return i&&i[1]?parseFloat(i[1]):null}(),e.IS_SAFARI=!e.IS_CHROME_ONLY&&!e.IS_MQQB&&!e.IS_X5MQQB&&!e.IS_MACQQB&&!e.IS_IPADQQB&&/Safari/i.test(e.USER_AGENT),e.IS_ANY_SAFARI=e.IS_SAFARI||e.IS_IOS,e.SAFARI_MAJOR_VERSION=e.IS_SAFARI&&function(){const i=e.USER_AGENT.match(/Version\/(\d+)/);return i&&i[1]?parseFloat(i[1]):null}(),e.SAFARI_VERSION=e.IS_SAFARI&&function(){const i=e.USER_AGENT.match(/Version\/([\d.]+)/);return i&&i[1]?i[1]:null}(),e.IS_MAC_SAFARI=e.IS_SAFARI&&e.IS_MAC,e.IS_IOS_SAFARI=e.IS_SAFARI&&e.IS_IOS,e.IS_LOCAL=window.location.protocol==="file:"||window.location.hostname==="localhost"||/^\d+\.\d+\.\d+\.\d+$/.test(window.location.hostname),e.IS_ZH=/zh/i.test(e.USER_LANGUAGE),e.IS_EN=/en/i.test(e.USER_LANGUAGE)},function(t,e,r){var i=this&&this.__importDefault||function(n){return n&&n.__esModule?n:{default:n}};Object.defineProperty(e,"__esModule",{value:!0});const a=i(r(6));class l extends Error{constructor(c){let s=c.url?c.url:"https://doc.yunxin.163.com/jcyOTA0ODM/docs/zU2MDQ4MjU?platform=web",d=c.advice?` advice: ${c.advice} `:"";super(c.message+` <${function(u){for(let h in a.default)if(a.default[h]===u)return h;return"UNKNOWN"}(c.code)} ${c.code.toString()}> `+d+s),this.code_=c.code||0,this.message_=c.message||null,this.advice_=c.advice||null,this.extraCode_=c.extraCode||null}get code(){return this.code_}get message(){return this.message_}get extraCode(){return this.extraCode_}get advice(){return this.advice_}getCode(){return this.code_}getMessage(){return this.message_}getProposal(){return this.advice_}getExtraCode(){return this.extraCode_}}e.default=l},function(t,e,r){var i=r(10),a=r(23);t.exports=r(12)?function(l,n,c){return i.f(l,n,a(1,c))}:function(l,n,c){return l[n]=c,l}},function(t,e,r){var i=r(5),a=r(54),l=r(33),n=Object.defineProperty;e.f=r(12)?Object.defineProperty:function(c,s,d){if(i(c),s=l(s,!0),i(d),a)try{return n(c,s,d)}catch{}if("get"in d||"set"in d)throw TypeError("Accessors not supported!");return"value"in d&&(c[s]=d.value),c}},function(t,e){t.exports=function(r){return typeof r=="object"?r!==null:typeof r=="function"}},function(t,e,r){t.exports=!r(22)(function(){return Object.defineProperty({},"a",{get:function(){return 7}}).a!=7})},function(t,e){var r={}.hasOwnProperty;t.exports=function(i,a){return r.call(i,a)}},function(t,e,r){var i=r(100),a=r(31);t.exports=function(l){return i(a(l))}},function(t,e){t.exports=!0},function(t,e,r){var i=r(0),a=r(4),l=r(20),n=r(9),c=r(13),s=function(d,u,h){var o,f,m,g=d&s.F,v=d&s.G,O=d&s.S,T=d&s.P,C=d&s.B,A=d&s.W,R=v?a:a[u]||(a[u]={}),w=R.prototype,k=v?i:O?i[u]:(i[u]||{}).prototype;for(o in v&&(h=u),h)(f=!g&&k&&k[o]!==void 0)&&c(R,o)||(m=f?k[o]:h[o],R[o]=v&&typeof k[o]!="function"?h[o]:C&&f?l(m,i):A&&k[o]==m?function(I){var M=function(P,S,y){if(this instanceof I){switch(arguments.length){case 0:return new I;case 1:return new I(P);case 2:return new I(P,S)}return new I(P,S,y)}return I.apply(this,arguments)};return M.prototype=I.prototype,M}(m):T&&typeof m=="function"?l(Function.call,m):m,T&&((R.virtual||(R.virtual={}))[o]=m,d&s.R&&w&&!w[o]&&n(w,o,m)))};s.F=1,s.G=2,s.S=4,s.P=8,s.B=16,s.W=32,s.U=64,s.R=128,t.exports=s},function(t,e){t.exports={}},function(t,e){var r={}.toString;t.exports=function(i){return r.call(i).slice(8,-1)}},function(t,e,r){var i,a,l=t.exports=r(44),n=r(182);l.codegen=r(272),l.fetch=r(273),l.path=r(274),l.fs=l.inquire("fs"),l.toArray=function(h){if(h){for(var o=Object.keys(h),f=new Array(o.length),m=0;m<o.length;)f[m]=h[o[m++]];return f}return[]},l.toObject=function(h){for(var o={},f=0;f<h.length;){var m=h[f++],g=h[f++];g!==void 0&&(o[m]=g)}return o};var c=/\\/g,s=/"/g;l.isReserved=function(h){return/^(?:do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|default|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$/.test(h)},l.safeProp=function(h){return!/^[$\w_]+$/.test(h)||l.isReserved(h)?'["'+h.replace(c,"\\\\").replace(s,'\\"')+'"]':"."+h},l.ucFirst=function(h){return h.charAt(0).toUpperCase()+h.substring(1)};var d=/_([a-z])/g;l.camelCase=function(h){return h.substring(0,1)+h.substring(1).replace(d,function(o,f){return f.toUpperCase()})},l.compareFieldsById=function(h,o){return h.id-o.id},l.decorateType=function(h,o){if(h.$type)return o&&h.$type.name!==o&&(l.decorateRoot.remove(h.$type),h.$type.name=o,l.decorateRoot.add(h.$type)),h.$type;i||(i=r(184));var f=new i(o||h.name);return l.decorateRoot.add(f),f.ctor=h,Object.defineProperty(h,"$type",{value:f,enumerable:!1}),Object.defineProperty(h.prototype,"$type",{value:f,enumerable:!1}),f};var u=0;l.decorateEnum=function(h){if(h.$type)return h.$type;a||(a=r(45));var o=new a("Enum"+u++,h);return l.decorateRoot.add(o),Object.defineProperty(h,"$type",{value:o,enumerable:!1}),o},l.setProperty=function(h,o,f){if(typeof h!="object")throw TypeError("dst must be an object");if(!o)throw TypeError("path must be specified");return function m(g,v,O){var T=v.shift();if(v.length>0)g[T]=m(g[T]||{},v,O);else{var C=g[T];C&&(O=[].concat(C).concat(O)),g[T]=O}return g}(h,o=o.split("."),f)},Object.defineProperty(l,"decorateRoot",{get:function(){return n.decorated||(n.decorated=new(r(192)))}})},function(t,e,r){var i=r(21);t.exports=function(a,l,n){if(i(a),l===void 0)return a;switch(n){case 1:return function(c){return a.call(l,c)};case 2:return function(c,s){return a.call(l,c,s)};case 3:return function(c,s,d){return a.call(l,c,s,d)}}return function(){return a.apply(l,arguments)}}},function(t,e){t.exports=function(r){if(typeof r!="function")throw TypeError(r+" is not a function!");return r}},function(t,e){t.exports=function(r){try{return!!r()}catch{return!0}}},function(t,e){t.exports=function(r,i){return{enumerable:!(1&r),configurable:!(2&r),writable:!(4&r),value:i}}},function(t,e){var r=0,i=Math.random();t.exports=function(a){return"Symbol(".concat(a===void 0?"":a,")_",(++r+i).toString(36))}},function(t,e,r){var i=r(10).f,a=r(13),l=r(2)("toStringTag");t.exports=function(n,c,s){n&&!a(n=s?n:n.prototype,l)&&i(n,l,{configurable:!0,value:c})}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.SDK_VERSION=e.roomsTaskUrl=e.lbsUrl=e.TAGS_TO_MAIN_DOMAIN=e.LBS_REGION_CONFIG=e.getCloudProxyInfoUrl=e.getChannelInfoUrl=e.ENV=e.ENGINE_VERSION=e.createChannelUrl=e.checkSumUrl=e.BUILD=void 0,e.SDK_VERSION="5.6.50",e.ENGINE_VERSION="5.6.50",e.BUILD="v5.6.50-0-gaaf117b6";const i=r(211);Object.defineProperty(e,"ENV",{enumerable:!0,get:function(){return i.ENV}}),Object.defineProperty(e,"LBS_REGION_CONFIG",{enumerable:!0,get:function(){return i.LBS_REGION_CONFIG}}),Object.defineProperty(e,"TAGS_TO_MAIN_DOMAIN",{enumerable:!0,get:function(){return i.TAGS_TO_MAIN_DOMAIN}});const a=i.Config.checkSumUrl;e.checkSumUrl=a;const l=i.Config.createChannelUrl;e.createChannelUrl=l;const n=i.Config.getChannelInfoUrl;e.getChannelInfoUrl=n;const c=i.Config.roomsTaskUrl;e.roomsTaskUrl=c;const s=i.Config.getCloudProxyInfoUrl;e.getCloudProxyInfoUrl=s;const d=i.Config.lbsUrl;e.lbsUrl=d},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.generateRandomNumber=e.clone=void 0,e.clone=function(i,a={}){return i===void 0?a:JSON.parse(JSON.stringify(i))},e.generateRandomNumber=function(){return Math.round(1e7*Math.random())}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.getDefaultLogger=e.Logger=e.updateLogIndex=void 0;const i=r(1),a=r(84),l=r(77),n=r(42),c=r(26);let s=0,d=[];function u(){return s++,(""+s).padStart(4,"0")}e.updateLogIndex=u;class h{constructor(v){this.style="color:#1cb977;",this.options=v,this.tagGen=v.tagGen,this.supportedBrowsers=["Chrome","Safari","Firefox","Chrome Mobile","Electron"],this.cs=console}getChild(v){const O=Object.assign({},this.options),T=new h(O);return T.tagGen=v,T.parent=this,T}debug(){var v=this.formatArgs("DEBUG",[].slice.call(arguments,0));i.getParameters().logLevel<=a.loglevels.DEBUG&&this._log("debug",v),m(v)}log(){var v=this.formatArgs("LOG",[].slice.call(arguments,0));if(this.supportedBrowsers.indexOf(l.getBrowserInfo().browserName)!==-1&&typeof v[0]=="string"){v[0]="%c"+v[0],v.splice(1,0,this.style);for(let O=2;O<v.length&&typeof v[O]=="string";O++)v[0]+="%c"+v[O],v[O]=""}i.getParameters().logLevel<=a.loglevels.INFO&&this._log("log",v),m(v)}info(){var v=this.formatArgs("INFO",[].slice.call(arguments,0));this.supportedBrowsers.indexOf(l.getBrowserInfo().browserName)!==-1&&typeof v[0]=="string"&&(v[0]="%c"+v[0],v.splice(1,0,this.style)),i.getParameters().logLevel<=a.loglevels.INFO&&this._log("info",v),m(v)}warn(){var v=this.formatArgs("WARN",[].slice.call(arguments,0));this.supportedBrowsers.indexOf(l.getBrowserInfo().browserName)!==-1&&typeof v[0]=="string"&&(v[0]="%c"+v[0],v.splice(1,0,this.style)),i.getParameters().logLevel<=a.loglevels.WARNING&&this._log("warn",v),m(v)}error(){var v=this.formatArgs("ERROR",[].slice.call(arguments,0));this.supportedBrowsers.indexOf(l.getBrowserInfo().browserName)!==-1&&typeof v[0]=="string"&&(v[0]="%c"+v[0],v.splice(1,0,this.style)),i.getParameters().logLevel<=a.loglevels.ERROR&&this._log("error",v),m(v)}_log(v,O){let T=this.options.logFunc,C=null;if(T&&(T[v]&&(C=T[v]),typeof C=="function"))C.apply(T,O);else if(this.cs[v])try{this.cs[v].apply?this.chrome(v,O):this.ie(v,O)}catch{}}chrome(v,O){l.getBrowserInfo().browserName,this.cs[v]?this.cs[v].apply(this.cs,O):this.cs.log?this.cs.log.apply(this.cs,O):this.ie(v,O)}ie(v,O){var T=this;O.forEach(function(C){T.cs[v](JSON.stringify(C,null,4))})}formatArgs(v,O){var T=new Date,C=f(""+(T.getMonth()+1))+"-"+f(""+T.getDate())+" "+f(""+T.getHours())+":"+f(""+T.getMinutes())+":"+f(""+T.getSeconds())+":"+f(""+T.getMilliseconds(),3);let A=this,R="";for(let w=0;w<3&&(A.tagGen&&(R=`[${A.tagGen()}]`+R),A.parent);w++)A=A.parent;return R=`[NERTC:${v}:${u()} ${C}]${R}`,O.splice(0,0,R),O.forEach(function(w,k){w=n.formatSingleArg(w),O[k]=typeof w=="object"?function I(M,P=[]){if(!(M=n.formatSingleArg(M))||typeof M!="object")return M;let S={};for(let y in M)M.hasOwnProperty&&!M.hasOwnProperty(y)||(M[y]&&typeof M[y]=="object"?P.indexOf(M[y])!==-1?S[y]="[Circular obj]":(P.push(M[y]),S[y]=I(M[y],P)):S[y]=M[y]);return S}(w):w}),O}}e.Logger=h;let o=null;e.getDefaultLogger=function(){return o||(o=new h({tagGen:()=>""+c.BUILD})),o};var f=function(g,v){v=v||2;for(var O=""+g;O.length<v;)O="0"+O;return O};function m(g){if(i.getParameters().logUpload&&!i.getParameters().disableAllReports){const v=i.getParameters().reportWS;if(v)d.length&&(d.forEach(O=>{v.sendLog(O.args)}),d=[]),v.sendLog(g);else{let O=Date.now();try{d.length&&d[d.length-1].args[0].replace("[NERTC","[缓存][NERTC")}catch{}d.push({time:O,args:g})}}}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.Logger=void 0;const i=new(r(28)).Logger({tagGen:void 0});e.Logger={debug(a,...l){try{i.log(`[${a}] ${l.join(" ")}`)}catch{}},warn(a,...l){try{i.warn(`[${a}] ${l.join(" ")}`)}catch{}},error(a,...l){try{i.error(`[${a}] ${l.join(" ")}`)}catch{}}}},function(t,e){var r=Math.ceil,i=Math.floor;t.exports=function(a){return isNaN(a=+a)?0:(a>0?i:r)(a)}},function(t,e){t.exports=function(r){if(r==null)throw TypeError("Can't call method on  "+r);return r}},function(t,e,r){var i=r(11),a=r(0).document,l=i(a)&&i(a.createElement);t.exports=function(n){return l?a.createElement(n):{}}},function(t,e,r){var i=r(11);t.exports=function(a,l){if(!i(a))return a;var n,c;if(l&&typeof(n=a.toString)=="function"&&!i(c=n.call(a))||typeof(n=a.valueOf)=="function"&&!i(c=n.call(a))||!l&&typeof(n=a.toString)=="function"&&!i(c=n.call(a)))return c;throw TypeError("Can't convert object to primitive value")}},function(t,e,r){var i=r(57),a=r(37);t.exports=Object.keys||function(l){return i(l,a)}},function(t,e,r){var i=r(36)("keys"),a=r(24);t.exports=function(l){return i[l]||(i[l]=a(l))}},function(t,e,r){var i=r(4),a=r(0),l=a["__core-js_shared__"]||(a["__core-js_shared__"]={});(t.exports=function(n,c){return l[n]||(l[n]=c!==void 0?c:{})})("versions",[]).push({version:i.version,mode:r(15)?"pure":"global",copyright:"© 2020 Denis Pushkarev (zloirock.ru)"})},function(t,e){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,e,r){var i=r(21);function a(l){var n,c;this.promise=new l(function(s,d){if(n!==void 0||c!==void 0)throw TypeError("Bad Promise constructor");n=s,c=d}),this.resolve=i(n),this.reject=i(c)}t.exports.f=function(l){return new a(l)}},function(t,e,r){e.f=r(2)},function(t,e,r){var i=r(0),a=r(4),l=r(15),n=r(39),c=r(10).f;t.exports=function(s){var d=a.Symbol||(a.Symbol=l?{}:i.Symbol||{});s.charAt(0)=="_"||s in d||c(d,s,{value:n.f(s)})}},function(t,e){e.f={}.propertyIsEnumerable},function(t,e,r){function i(l,n=1,c=1){return l<=1?c:i(l-1,c,n+c)}Object.defineProperty(e,"__esModule",{value:!0}),e.getDomInfo=e.makePrintable=e.formatSingleArg=e.deepCopy=e.randomString=e.randomId=e.generateUUID=e.getReconnectionTimeout=e.fibonacci=void 0,e.fibonacci=i,e.getReconnectionTimeout=function(l){const n=Math.round(l/2)+1;return n>6?13e3:1e3*i(n)},e.generateUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(l){var n=16*Math.random()|0;return(l=="x"?n:3&n|8).toString(16)})},e.randomId=function(){return"xxxxxxxxxx".replace(/[xy]/g,function(l){var n=16*Math.random()|0;return(l=="x"?n:3&n|8).toString(16)})};function a(l){if(window.RTCRtpSender&&l instanceof RTCRtpSender)return`[RTCRtpSender track: ${a(l.track)}]`;if(l instanceof MediaStreamTrack){const n=l;return`[MediaStreamTrack kind:${n.kind} label:${n.label} readyState:${n.readyState} id: ${n.id} enabled:${n.enabled} muted: ${n.muted}]`}if(l instanceof HTMLElement){const n=l;return`[${n.tagName}.${n.className} ${n.clientWidth}x${n.clientHeight}]`}if(l instanceof MediaStream){const n=l;return`[MediaStream active:${n.active} a:${n.getAudioTracks().length} v:${n.getVideoTracks().length}]`}return window.DOMException&&l instanceof DOMException?`[Error name:${l.name} code:${l.code} message:${l.message}]`:l}e.randomString=(l,n)=>{if(!l||!n)return"";let c="";for(var s=n;s>0;--s)c+=l[Math.floor(Math.random()*l.length)];return c},e.deepCopy=function l(n){var c=Array.isArray(n)?[]:{};for(var s in n)n.hasOwnProperty(s)&&(typeof n[s]=="object"&&n[s]!==null?c[s]=l(n[s]):c[s]=n[s]);return c},e.formatSingleArg=a,e.makePrintable=function l(n,c,s=[]){if(typeof n!="object"||!(n!=null&&n.hasOwnProperty))return n;var d=Array.isArray(n)?[]:{};for(var u in n)if(n.hasOwnProperty(u)){const h=a(n[u]);h&&(u==="client"&&h.adapterRef||["adapterRef","sdkRef","logger","_events"].indexOf(u)>-1||(h&&typeof h=="object"?s.indexOf(h)>-1?d[u]="[Circular obj]":(s.push(d[u]),c>=1?d[u]=l(h,c-1,s):h!=null&&h.toString?d[u]=h.toString():d[u]=typeof h):d[u]=h))}return d},e.getDomInfo=function(l){if(!l)return""+l;let n=l.tagName;return l.id&&(n+="#"+l.id),l.className&&(n+="."+l.className),(l.offsetWidth||l.offsetHeight)&&(n+=` ${l.offsetWidth}x${l.offsetHeight}`),n}},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(m,g,v,O){O===void 0&&(O=v),Object.defineProperty(m,O,{enumerable:!0,get:function(){return g[v]}})}:function(m,g,v,O){O===void 0&&(O=v),m[O]=g[v]}),a=this&&this.__setModuleDefault||(Object.create?function(m,g){Object.defineProperty(m,"default",{enumerable:!0,value:g})}:function(m,g){m.default=g}),l=this&&this.__importStar||function(m){if(m&&m.__esModule)return m;var g={};if(m!=null)for(var v in m)v!=="default"&&Object.prototype.hasOwnProperty.call(m,v)&&i(g,m,v);return a(g,m),g};Object.defineProperty(e,"__esModule",{value:!0}),e.reduceCodecs=e.getSupportedCodecs=e.getCurrentProfileLevel=e.VideoCodecList=void 0;const n=r(1),c=r(7),s=r(28),d=l(r(7));function u(m){const g={video:[],audio:[]};return m.match(/ H264/i)&&g.video.push("H264"),m.match(/ VP8/i)&&g.video.push("VP8"),m.match(/ opus/i)&&g.audio.push("OPUS"),g}function h(m,g,v){const O={video:[],audio:[]};if(g&&g.codecs&&g.codecs.length)for(let T=0;T<g.codecs.length;T++){const C=g.codecs[T];C.mimeType=="video/H264"&&O.video.indexOf("H264")===-1&&(m==="recv"&&C.sdpFmtpLine&&C.sdpFmtpLine.indexOf("profile-level-id")>-1?n.getParameters().h264StrictHigh?C.sdpFmtpLine.indexOf("profile-level-id=64")>-1&&O.video.push("H264"):O.video.push("H264"):O.video.indexOf("H264")===-1&&O.video.push("H264")),C.mimeType=="video/VP8"&&O.video.indexOf("VP8")===-1&&O.video.push("VP8")}if(v&&v.codecs&&v.codecs.length)for(let T=0;T<v.codecs.length;T++)v.codecs[T].mimeType=="audio/opus"&&O.audio.push("OPUS");return O}function o(m){if(typeof RTCRtpSender<"u"&&typeof RTCRtpSender.getCapabilities=="function"){const g=RTCRtpSender.getCapabilities("video");if(g)for(let v in g.codecs){const O=g.codecs[v];if(O.mimeType==="video/H264"&&O.sdpFmtpLine&&O.sdpFmtpLine.indexOf(m)>-1)return!0}}return!1}e.VideoCodecList=["H264","VP8"],e.getSupportedCodecs=async function(m="recv",g=RTCPeerConnection){if(m==="recv"){if(d.ANY_CHROME_MAJOR_VERSION&&d.ANY_CHROME_MAJOR_VERSION>=58&&d.ANY_CHROME_MAJOR_VERSION<69){const v=new g({}),O=await v.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});return v.close(),O.sdp?u(O.sdp):!1}if(typeof RTCRtpReceiver<"u"&&RTCRtpReceiver.getCapabilities)return h(m,RTCRtpReceiver.getCapabilities("video"),RTCRtpReceiver.getCapabilities("audio"));{const v=new g({});v.addTransceiver("audio",{direction:"recvonly"}),v.addTransceiver("video",{direction:"recvonly"});const O=await v.createOffer({});return v.close(),O.sdp?u(O.sdp):!1}}if(typeof RTCRtpSender<"u"&&RTCRtpSender.getCapabilities)return h(m,RTCRtpSender.getCapabilities("video"),RTCRtpSender.getCapabilities("audio"));{const v=new g({}),O=await v.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});return v.close(),O.sdp?u(O.sdp):!1}};let f="";e.getCurrentProfileLevel=function(){return f},e.reduceCodecs=function(m,g){const v=[];let O="";for(let T=0;T<m.length;T++){if(m[T].mimeType&&g&&e.VideoCodecList.indexOf(m[T].mimeType.split("/")[1])>-1&&m[T].mimeType!==g.mimeType){T++;continue}const C=m[T];C.mimeType&&C.mimeType.indexOf("video")===0&&(C.mimeType==="video/H264"&&n.getParameters().h264ProfileLevel&&(c.CHROME_MAJOR_VERSION===95?s.getDefaultLogger().warn("当前浏览器版本无法修改H264 Profile Level："+n.getParameters().h264ProfileLevel):C.parameters["profile-level-id"]&&o(n.getParameters().h264ProfileLevel)&&(C.parameters["profile-level-id"]=n.getParameters().h264ProfileLevel)),O||(O=`${C.mimeType}/${C.parameters["profile-level-id"]}`)),v.push(m[T])}return O&&(f=O),v}},function(t,e,r){(function(i){var a=e;function l(c,s,d){for(var u=Object.keys(s),h=0;h<u.length;++h)c[u[h]]!==void 0&&d||(c[u[h]]=s[u[h]]);return c}function n(c){function s(d,u){if(!(this instanceof s))return new s(d,u);Object.defineProperty(this,"message",{get:function(){return d}}),Error.captureStackTrace?Error.captureStackTrace(this,s):Object.defineProperty(this,"stack",{value:new Error().stack||""}),u&&l(this,u)}return(s.prototype=Object.create(Error.prototype)).constructor=s,Object.defineProperty(s.prototype,"name",{get:function(){return c}}),s.prototype.toString=function(){return this.name+": "+this.message},s}a.asPromise=r(179),a.base64=r(263),a.EventEmitter=r(264),a.float=r(265),a.inquire=r(180),a.utf8=r(266),a.pool=r(267),a.LongBits=r(268),a.isNode=!!(i!==void 0&&i&&i.process&&i.process.versions&&i.process.versions.node),a.global=a.isNode&&i||typeof window<"u"&&window||typeof self<"u"&&self||this,a.emptyArray=Object.freeze?Object.freeze([]):[],a.emptyObject=Object.freeze?Object.freeze({}):{},a.isInteger=Number.isInteger||function(c){return typeof c=="number"&&isFinite(c)&&Math.floor(c)===c},a.isString=function(c){return typeof c=="string"||c instanceof String},a.isObject=function(c){return c&&typeof c=="object"},a.isset=a.isSet=function(c,s){var d=c[s];return!(d==null||!c.hasOwnProperty(s))&&(typeof d!="object"||(Array.isArray(d)?d.length:Object.keys(d).length)>0)},a.Buffer=function(){try{var c=a.inquire("buffer").Buffer;return c.prototype.utf8Write?c:null}catch{return null}}(),a._Buffer_from=null,a._Buffer_allocUnsafe=null,a.newBuffer=function(c){return typeof c=="number"?a.Buffer?a._Buffer_allocUnsafe(c):new a.Array(c):a.Buffer?a._Buffer_from(c):typeof Uint8Array>"u"?c:new Uint8Array(c)},a.Array=typeof Uint8Array<"u"?Uint8Array:Array,a.Long=a.global.dcodeIO&&a.global.dcodeIO.Long||a.global.Long||a.inquire("long"),a.key2Re=/^true|false|0|1$/,a.key32Re=/^-?(?:0|[1-9][0-9]*)$/,a.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,a.longToHash=function(c){return c?a.LongBits.from(c).toHash():a.LongBits.zeroHash},a.longFromHash=function(c,s){var d=a.LongBits.fromHash(c);return a.Long?a.Long.fromBits(d.lo,d.hi,s):d.toNumber(!!s)},a.merge=l,a.lcFirst=function(c){return c.charAt(0).toLowerCase()+c.substring(1)},a.newError=n,a.ProtocolError=n("ProtocolError"),a.oneOfGetter=function(c){for(var s={},d=0;d<c.length;++d)s[c[d]]=1;return function(){for(var u=Object.keys(this),h=u.length-1;h>-1;--h)if(s[u[h]]===1&&this[u[h]]!==void 0&&this[u[h]]!==null)return u[h]}},a.oneOfSetter=function(c){return function(s){for(var d=0;d<c.length;++d)c[d]!==s&&delete this[c[d]]}},a.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},a._configure=function(){var c=a.Buffer;c?(a._Buffer_from=c.from!==Uint8Array.from&&c.from||function(s,d){return new c(s,d)},a._Buffer_allocUnsafe=c.allocUnsafe||function(s){return new c(s)}):a._Buffer_from=a._Buffer_allocUnsafe=null}}).call(this,r(70))},function(t,e,r){t.exports=n;var i=r(82);((n.prototype=Object.create(i.prototype)).constructor=n).className="Enum";var a=r(91),l=r(19);function n(c,s,d,u,h){if(i.call(this,c,d),s&&typeof s!="object")throw TypeError("values must be an object");if(this.valuesById={},this.values=Object.create(this.valuesById),this.comment=u,this.comments=h||{},this.reserved=void 0,s)for(var o=Object.keys(s),f=0;f<o.length;++f)typeof s[o[f]]=="number"&&(this.valuesById[this.values[o[f]]=s[o[f]]]=o[f])}n.fromJSON=function(c,s){var d=new n(c,s.values,s.options,s.comment,s.comments);return d.reserved=s.reserved,d},n.prototype.toJSON=function(c){var s=!!c&&!!c.keepComments;return l.toObject(["options",this.options,"values",this.values,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"comment",s?this.comment:void 0,"comments",s?this.comments:void 0])},n.prototype.add=function(c,s,d){if(!l.isString(c))throw TypeError("name must be a string");if(!l.isInteger(s))throw TypeError("id must be an integer");if(this.values[c]!==void 0)throw Error("duplicate name '"+c+"' in "+this);if(this.isReservedId(s))throw Error("id "+s+" is reserved in "+this);if(this.isReservedName(c))throw Error("name '"+c+"' is reserved in "+this);if(this.valuesById[s]!==void 0){if(!this.options||!this.options.allow_alias)throw Error("duplicate id "+s+" in "+this);this.values[c]=s}else this.valuesById[this.values[c]=s]=c;return this.comments[c]=d||null,this},n.prototype.remove=function(c){if(!l.isString(c))throw TypeError("name must be a string");var s=this.values[c];if(s==null)throw Error("name '"+c+"' does not exist in "+this);return delete this.valuesById[s],delete this.values[c],delete this.comments[c],this},n.prototype.isReservedId=function(c){return a.isReservedId(this.reserved,c)},n.prototype.isReservedName=function(c){return a.isReservedName(this.reserved,c)}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.RTCEventEmitter=void 0;const i=r(3);class a extends i.EventEmitter{constructor(){super(),this._events||(this._events={})}safeEmit(n,...c){try{n.match(/^@/)||this.emit("@"+n,...c),this.emit(n,...c)}catch(s){(this.logger||console).error(`Error on event ${n}: ${s.name} ${s.message}`,s.stack)}}}e.RTCEventEmitter=a},function(t,e,r){var i=this&&this.__importDefault||function(C){return C&&C.__esModule?C:{default:C}};Object.defineProperty(e,"__esModule",{value:!0}),e.WebAudio=e.getAudioLevelDestination=e.getAudioContext=e.tryResumeAudioContext=void 0;const a=r(3),l=r(165),n=i(r(6)),c=i(r(8)),s=r(143),d=r(1),u=r(212),h=s.RtcSupport.checkWebAudio();let o;class f{constructor(A){this.id=A.id,this.label=A.label,this.audioNode=A.audioNode,this.gainNode=A.context.createGain(),this.type=A.type,this.audioNode.connect(this.gainNode)}connect(A){this.gainNode.connect(A)}disconnect(){try{this.audioNode.disconnect(this.gainNode)}catch{}this.gainNode.disconnect()}}function m(){return o?o.state==="suspended"&&(o.resume().catch(C=>{}),!0):null}function g(){return o?(m(),o):d.getParameters().disableWebAudio?null:h.WebAudio&&h.MediaStream?(o=new window.AudioContext,o):null}e.tryResumeAudioContext=m,e.getAudioContext=g;let v=null;function O(){if(!v){const C=g();C&&(v=C.createMediaStreamDestination())}return v}e.getAudioLevelDestination=O;class T extends a.EventEmitter{constructor(A){super(),this.Jungle=null,this.wetGain=null,this.dryGain=null,this.effectInput=null,this.outputMix=null;const{logger:R,isAnalyze:w=!1,isRemote:k=!1}=A;this.support=h.WebAudio&&h.MediaStream,this.gain=1,this.logger=R,this.audioInArr=[],this.isAnalyze=w,this.isRemote=k||!1,this.instant=0,this.slow=0,this.clip=0,this.mediaHelper=A.mediaHelper,this.mixAudioConf={state:l.AuidoMixingState.UNSTART,audioSource:null,gainFilter:null,replace:!1,cycle:0,pauseTime:0,startTime:0,totalTime:0,volume:1,playStartTime:0,setPlayStartTime:0,auidoMixingEnd:null},this.context=g(),this.context?(this.destination=this.createDestination(),this.musicDestination=this.createDestination(),this.analyzeDestination=this.createDestination()):(this.destination=null,this.musicDestination=null,this.analyzeDestination=null),this.support&&(this.resetMixConf(),this.init())}createDestination(){if(!this.context)throw new Error("AudioContextRequired");try{return new MediaStreamAudioDestinationNode(this.context)}catch(A){if(A.name==="TypeError")return this.context.createMediaStreamDestination();throw A}}createSource(A){if(!this.context)throw new Error("AudioContextRequired");try{return new MediaStreamAudioSourceNode(this.context,A)}catch(R){if(R.name==="TypeError")return this.context.createMediaStreamSource(A.mediaStream);throw R}}init(){this.isAnalyze&&this.initMonitor(),this.initWebAudio(),this.initAudioIn()}initMonitor(){var A=this;this.context?(this.script=this.context.createScriptProcessor(0,1,1)).onaudioprocess=function(R){var w,k=R.inputBuffer.getChannelData(0),I=0,M=0;for(w=0;w<k.length;++w)I+=Math.abs(k[w]),Math.abs(k[w])>.99&&(M+=1);A.instant=Math.sqrt(I/k.length),A.slow=.95*A.slow+.05*A.instant,A.clip=M/k.length;let P=R.inputBuffer,S=R.outputBuffer;S.copyToChannel&&S.copyToChannel(P.getChannelData(0),0,0)}:A.logger.error("initMonitor:参数不够")}initWebAudio(){this.context&&this.destination?(this.gainFilter=this.context.createGain(),this.gainFilter.gain.value=this.gain):this.logger.error("initMonitor:参数不够")}initAudioIn(){var A,R,w,k,I;const M=this;if(!M.context||!M.gainFilter||!M.destination)return this.logger.error("initAudioIn:参数不够"),null;let P=((R=(A=this.mediaHelper.audio.stageAIProcessing)===null||A===void 0?void 0:A.node)===null||R===void 0?void 0:R.audioNode)||null,S=(w=this.mediaHelper.audio.stageAIProcessing)===null||w===void 0?void 0:w.enabled;const y=this.mixAudioConf.state==="MIX_PLAYING"&&this.mixAudioConf.replace;if(P&&!y)if(S)P.connect(M.gainFilter);else try{P.disconnect(M.gainFilter)}catch{}for(var _=0;_<M.audioInArr.length;_++){const b=M.audioInArr[_];if(P&&!y)if(S){try{b.gainNode.disconnect(M.gainFilter)}catch{}b.connect(P)}else{try{b.gainNode.disconnect(P)}catch{}b.connect(M.gainFilter)}else y?this.logger.log("当前正在以Replace模式播放伴音，暂不接入"):b.connect(M.gainFilter);let E=((I=(k=this.mediaHelper.audio.stageAIProcessing)===null||k===void 0?void 0:k.howlingNode)===null||I===void 0?void 0:I.audioNode)||null;if(E)if(S){b.connect(E);const x=O();x&&E.connect(x)}else try{b.gainNode.disconnect(E)}catch{}}M.mixAudioConf.state===l.AuidoMixingState.UNSTART&&(M.script&&M.analyzeDestination&&(M.gainFilter.connect(M.script),M.script.connect(M.analyzeDestination)),M.gainFilter.connect(M.destination)),this.logger.log("WebAudio: initAudioIn: 初始化音频 state: ",M.context.state),M.context.state!=="running"&&M.context.resume().then(()=>{this.context&&this.logger.log("WebAudio: addMs: 状态变更成功 state: ",this.context.state)}).catch(b=>{this.logger.log("WebAudio: addMs: 状态变更出错: ",b.name,b.message,b),this.context&&this.context.resume()})}updateTracks(A){for(let R=this.audioInArr.length-1;R>=0;R--){const w=this.audioInArr[R];A.find(k=>k.track&&w&&k.track.id===w.id)||(this.logger.log("updateTracks，删除",w.label,w.id),this.audioInArr.splice(R,1),w.disconnect())}for(let R=A.length-1;R>=0;R--){const w=A[R];if(!this.audioInArr.find(k=>w.track&&w.track.id===k.id)&&w.track)if(this.context){const k=new MediaStream;k.addTrack(w.track);const I={context:this.context,id:w.track.id,label:w.track.label,audioNode:this.createSource({mediaStream:k}),type:w.type},M=new f(I);M.gainNode.gain.value=this.gain,this.audioInArr.push(M)}else this.logger.error("updateTracks：没有audioContext")}this.initAudioIn()}removeTrack(A){for(let R=this.audioInArr.length-1;R>=0;R--){const w=this.audioInArr[R];w.id===A.id&&(this.logger.log("removeTrack，删除track",A.id,A.label),this.audioInArr.splice(R,1),w.disconnect())}}setGain(A,R){for(let w=0;w<this.audioInArr.length;w++){const k=this.audioInArr[w];R&&R!==k.type||(this.logger.log("WebAudio.setGain",R,A,k.type,k.label,k.id),k.gainNode.gain.value=0,k.gainNode.gain.setValueAtTime(A,this.context.currentTime))}R||(this.gain=A)}getGain(){if(this.gainFilter)return this.gain}getGainMin(){let A=1;for(let R=0;R<this.audioInArr.length;R++){const w=this.audioInArr[R];w.gainNode.gain.value<A&&(A=w.gainNode.gain.value)}return A}stop(){this.gainFilter&&(this.script?this.script.disconnect(0):this.gainFilter.disconnect(0),this.instant=0)}start(){this.gainFilter&&this.destination&&(this.script&&this.analyzeDestination&&(this.gainFilter.connect(this.script),this.script.connect(this.analyzeDestination)),this.gainFilter.connect(this.destination))}setAudioEffectLite(A,R){switch(A){case"Pitch":this.setPitch(R);break;case"close":this.closeAudioEffect();break;default:this.logger.warn("暂不支持的类型：",A)}}setPitch(A){var R,w;this.context&&this.destination&&this.gainFilter&&(this.Jungle||this.initJungle(),!((R=this.Jungle)===null||R===void 0)&&R.connected||this.createPitchShifter(),this.logger.log("setPitch: ",A),(w=this.Jungle)===null||w===void 0||w.setPitchOffset(A))}initJungle(){if(this.context&&this.destination&&this.gainFilter){this.Jungle||(this.Jungle=new u.Jungle(this.context));const A=this.gainFilter;this.outputMix=this.context.createGain(),this.wetGain=this.context.createGain(),this.dryGain=this.context.createGain(),this.effectInput=this.context.createGain(),A.connect(this.dryGain),A.connect(this.effectInput),this.dryGain.connect(this.outputMix),this.wetGain.connect(this.outputMix),this.outputMix.connect(this.destination),u.crossfade(1,this.dryGain,this.wetGain),this.logger.log("initJungle: 初始化成功")}else this.logger.error("connectJungle: contxt is null")}createPitchShifter(){if(this.logger.log("createPitchShifter: 开始连接"),this.Jungle&&this.wetGain&&this.gainFilter){const A=this.gainFilter;A.disconnect(0),A.connect(this.Jungle.input),this.Jungle.output.connect(this.wetGain),this.Jungle.connected=!0,this.logger.log("createPitchShifter: 连接成功")}else this.logger.warn("createPitchShifter: Jungle is null")}disconnectJungle(){var A,R;this.logger.log("disconnectJungle: 断开连接"),this.destination?((A=this.gainFilter)===null||A===void 0||A.disconnect(0),(R=this.gainFilter)===null||R===void 0||R.connect(this.destination)):this.logger.warn("disconnectJungle: destination is null")}closeAudioEffect(){var A,R;this.destination&&((A=this.gainFilter)===null||A===void 0||A.disconnect(0),(R=this.gainFilter)===null||R===void 0||R.connect(this.destination)),this.Jungle&&(this.Jungle.connected=!1)}resetMixConf(){var A,R,w;if((A=this.mixAudioConf.audioSource)===null||A===void 0||A.disconnect(0),(R=this.mixAudioConf.gainFilter)===null||R===void 0||R.disconnect(0),this.mixAudioConf.replace){if(this.logger.log("伴音停止了，恢复mic"),!((w=this.mediaHelper.audio.stageAIProcessing)===null||w===void 0)&&w.enabled)this.connectAiNode();else if(this.gainFilter&&this.destination){for(var k=0;k<this.audioInArr.length;k++)this.audioInArr[k].gainNode.connect(this.gainFilter);this.script&&this.analyzeDestination&&(this.gainFilter.connect(this.script),this.script.connect(this.analyzeDestination)),this.gainFilter.connect(this.destination)}}this.mixAudioConf={state:l.AuidoMixingState.UNSTART,audioSource:null,gainFilter:null,replace:!1,cycle:0,pauseTime:0,startTime:0,totalTime:0,volume:1,playStartTime:0,setPlayStartTime:0,auidoMixingEnd:null},this.gainFilter&&this.gainFilter.gain.value===1&&this.emit("audioFilePlaybackCompleted")}startMix(A){var R;if(!this.context||!this.destination||!this.gainFilter)return this.logger.error("startMix: 不支持伴音"),Promise.reject(new c.default({code:n.default.AUDIO_MIX_NO_SUPPORT,message:"startMix:不支持伴音"}));if(this.logger.log("开始混音: ",JSON.stringify(A)),this.mixAudioConf.audioSource=this.context.createBufferSource(),this.mixAudioConf.gainFilter=this.context.createGain(),this.mixAudioConf.audioSource.buffer=A.buffer,this.mixAudioConf.replace=A.replace,this.mixAudioConf.cycle=A.cycle,this.mixAudioConf.playStartTime=A.playStartTime,this.mixAudioConf.volume=A.volume?A.volume/255:1,this.mixAudioConf.auidoMixingEnd=A.auidoMixingEnd,this.mixAudioConf.audioSource.connect(this.mixAudioConf.gainFilter),this.mixAudioConf.gainFilter.connect(this.gainFilter),this.musicDestination&&this.mixAudioConf.gainFilter.connect(this.musicDestination),A.replace){for(var w=0;w<this.audioInArr.length;w++){const k=this.audioInArr[w];try{k.gainNode.disconnect(this.gainFilter),this.logger.log(`已断开音频：【${k.label}】`)}catch(I){I.name==="InvalidAccessError"?this.logger.log(`音频断开前未连接：【${k.label}】`):this.logger.error(`无法断开音频:【${k.label}】${I.name}`,I.message)}}!((R=this.mediaHelper.audio.stageAIProcessing)===null||R===void 0)&&R.enabled&&this.disconnectAiNode()}if(this.mixAudioConf.audioSource.onended=k=>{this.audioEnd(k)},this.mixAudioConf.totalTime=A.buffer.duration,(this.mixAudioConf.playStartTime<0||this.mixAudioConf.playStartTime>=this.mixAudioConf.totalTime)&&(this.mixAudioConf.playStartTime=0),this.logger.log("设置音量:",this.mixAudioConf.volume),this.mixAudioConf.gainFilter.gain.value=this.mixAudioConf.volume,A.loopback&&A.cycle>1){this.mixAudioConf.audioSource.loop=A.loopback;const k=A.cycle*this.mixAudioConf.totalTime-this.mixAudioConf.playStartTime;this.logger.log("循环播放: options.playStartTime: ",this.mixAudioConf.playStartTime),this.logger.log("循环播放: totalTime: ",k),this.mixAudioConf.audioSource.start(0,this.mixAudioConf.playStartTime,k-1)}else A.loopback&&A.cycle==1?(this.mixAudioConf.audioSource.loop=!1,this.mixAudioConf.audioSource.start(0,this.mixAudioConf.playStartTime)):(this.logger.log("无限循环播放 loop: ",A.loopback),this.mixAudioConf.audioSource.loop=A.loopback,this.mixAudioConf.audioSource.start(0,this.mixAudioConf.playStartTime));return this.mixAudioConf.state=l.AuidoMixingState.PLAYED,this.mixAudioConf.startTime=Date.now(),Promise.resolve()}pauseAudioMixing(){if(!this.mixAudioConf.audioSource||!this.mixAudioConf.gainFilter)return void this.logger.error("pauseAudioMixing: 缺失audioSource/gainFilter");this.logger.log("暂停混音"),this.mixAudioConf.audioSource.onended=null,this.mixAudioConf.audioSource.disconnect(0),this.mixAudioConf.gainFilter.disconnect(0),this.mixAudioConf.audioSource.stop(),this.mixAudioConf.pauseTime=Date.now(),this.mixAudioConf.state=l.AuidoMixingState.PAUSED;let A=(this.mixAudioConf.pauseTime-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return this.logger.log("已经播放的时间: ",A),A>this.mixAudioConf.totalTime&&(A%=this.mixAudioConf.totalTime),this.logger.log("暂停位置:",A),Promise.resolve()}resumeAudioMixing(A){return this.logger.log("恢复混音"),this.mixAudioConf.pauseTime=0,A.volume=255*this.mixAudioConf.volume,this.startMix(A)}stopAudioMixing(A=!0){return this.mixAudioConf.audioSource&&this.mixAudioConf.gainFilter?(this.logger.log("开始停止混音, isFinished: ",A),this.mixAudioConf.audioSource.onended=null,this.mixAudioConf.audioSource.disconnect(0),this.mixAudioConf.gainFilter.disconnect(0),this.mixAudioConf.audioSource.stop(),this.mixAudioConf.state=l.AuidoMixingState.STOPED,A&&this.resetMixConf(),this.logger.log("混音已停止"),Promise.resolve()):Promise.reject(new c.default({code:n.default.AUDIO_MIX_NOT_STATE_ERROR,message:"stopAudioMixing() 当前没有开启伴音"}))}audioEnd(A){if(this.mixAudioConf.state===l.AuidoMixingState.PLAYED){if(!(this.mixAudioConf.audioSource&&this.mixAudioConf.audioSource.loop&&this.mixAudioConf.cycle<=0))return this.logger.log("伴音播放完成: ",this.mixAudioConf),this.mixAudioConf.audioSource&&(this.mixAudioConf.audioSource.onended=null),this.mixAudioConf.auidoMixingEnd&&(this.mixAudioConf.auidoMixingEnd(A),this.mixAudioConf.auidoMixingEnd=null),this.resetMixConf(),Promise.resolve();this.logger.log("无限循环时, 伴音播放完成event: ",A)}else this.logger.error("audioEnd:参数不够")}setAudioMixingVolume(A){if(this.mixAudioConf.gainFilter)return this.mixAudioConf.gainFilter.gain.value=A/255,this.mixAudioConf.volume=this.mixAudioConf.gainFilter.gain.value,Promise.resolve();this.logger.error("setAudioMixingVolume: 参数缺失gainFilter")}setAudioMixingPlayTime(A){return this.mixAudioConf.state===l.AuidoMixingState.PLAYED&&(this.mixAudioConf.setPlayStartTime=A.playStartTime),A.volume=255*this.mixAudioConf.volume,this.startMix(A)}getAudioMixingPlayedTime(){let A=Date.now();this.mixAudioConf.state==l.AuidoMixingState.PAUSED&&this.mixAudioConf.pauseTime&&(this.logger.log("当前是暂停状态"),A=this.mixAudioConf.pauseTime);let R=(A-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return R>this.mixAudioConf.totalTime&&(R%=this.mixAudioConf.totalTime),{playedTime:R}}getAudioMixingTotalTime(){return{totalTime:this.mixAudioConf.totalTime}}createAudioBufferSource(A){if(!this.context||!this.destination||!this.gainFilter)throw new c.default({code:n.default.AUDIO_EFFECT_NO_SUPPORT,message:"webAudio_createAudioBufferSource: 接口调用状态异常"});const R=this.context.createBufferSource();R.buffer=A;const w=this.context.createGain();return R.connect(w),{sourceNode:R,gainNode:w}}startAudioEffectMix(A){if(!this.context||!this.destination||!this.gainFilter)return Promise.reject(new c.default({code:n.default.AUDIO_EFFECT_NO_SUPPORT,message:"webAudio_startAudioEffectMix: 接口调用状态异常"}));const{sourceNode:R,gainNode:w,playOverTime:k,playStartTime:I,volume:M,cycle:P}=A;w&&R&&(this.logger.log("startAudioEffectMix: ",JSON.stringify(A)),w.connect(this.gainFilter),this.musicDestination&&w.connect(this.musicDestination),w.gain.value=M/100,P>1?(R.loop=!0,R.start(0,I,k)):(R.loop=!1,R.start(0,I)),this.mixAudioConf.state=l.AuidoMixingState.PLAYED,this.mixAudioConf.startTime=Date.now())}stopAudioEffectMix(A){const{sourceNode:R,gainNode:w,playOverTime:k,playStartTime:I,volume:M,cycle:P}=A;if(!w||!R)return Promise.reject(new c.default({code:n.default.AUDIO_EFFECT_NO_SUPPORT,message:"webAudio_startAudioEffectMix: 接口调用状态异常"}));this.logger.log("stopAudioEffectMix: ",JSON.stringify(A)),R.onended=null,R.disconnect(0),w.disconnect(0),R.stop()}connectAiNode(){var A,R;if(!this.context||!this.gainFilter)return null;let w=((R=(A=this.mediaHelper.audio.stageAIProcessing)===null||A===void 0?void 0:A.node)===null||R===void 0?void 0:R.audioNode)||null;if(w)try{w.connect(this.gainFilter)}catch{}for(var k=0;k<this.audioInArr.length;k++){const I=this.audioInArr[k];if(w)try{I.connect(w)}catch{}}}disconnectAiNode(){var A,R;if(!this.context||!this.gainFilter)return null;let w=((R=(A=this.mediaHelper.audio.stageAIProcessing)===null||A===void 0?void 0:A.node)===null||R===void 0?void 0:R.audioNode)||null;if(w)try{w.disconnect(this.gainFilter)}catch{}for(var k=0;k<this.audioInArr.length;k++){const I=this.audioInArr[k];if(w)try{I.gainNode.disconnect(w)}catch{}}}destroy(){this.logger.log("AudioContext 清除"),this.instant=0,this.slow=0,this.clip=0,this.gainFilter&&this.gainFilter.disconnect(0),this.script&&this.script.disconnect(0);for(let A=0;A<this.audioInArr.length;A++)this.audioInArr[A]&&this.audioInArr[A].disconnect();this.audioInArr=[]}getVolumeData(){return this.instant.toFixed(2)}}e.WebAudio=T},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.PlatformType=e.PlatformTypeMap=e.MediaTypeList=e.MediaTypeListVideo=e.MediaTypeListAudio=e.ReconnectReason=e.ConStateChange_reason=e.ConStateChange_state=void 0,function(i){i[i.ChannelIdle=0]="ChannelIdle",i[i.ChannelJoining=1]="ChannelJoining",i[i.ChannelJoined=2]="ChannelJoined",i[i.ChannelLeaving=3]="ChannelLeaving",i[i.ChannelLeave=4]="ChannelLeave",i[i.ChannelRejoining=5]="ChannelRejoining",i[i.ChannelJoinFailed=6]="ChannelJoinFailed"}(e.ConStateChange_state||(e.ConStateChange_state={})),function(i){i[i.Idle=0]="Idle",i[i.Leave=1]="Leave",i[i.Closed=2]="Closed",i[i.BeKicked=3]="BeKicked",i[i.TimeOut=4]="TimeOut",i[i.Join=5]="Join",i[i.JoinSucceed=6]="JoinSucceed",i[i.ReJoinSucceed=7]="ReJoinSucceed",i[i.MediaDisconnected=8]="MediaDisconnected",i[i.SignalDisconnected=9]="SignalDisconnected",i[i.RequestChannelFailed=10]="RequestChannelFailed",i[i.JoinChannelFailed=11]="JoinChannelFailed",i[i.RedispatchServer=12]="RedispatchServer",i[i.GetCloudProxyServer=13]="GetCloudProxyServer",i[i.BeKickedDueToSameUserId=14]="BeKickedDueToSameUserId"}(e.ConStateChange_reason||(e.ConStateChange_reason={})),function(i){i[i.Unknown=0]="Unknown",i[i.SendPeerIceFailed=1]="SendPeerIceFailed",i[i.RecvPeerIceFailed=2]="RecvPeerIceFailed",i[i.WebsocketDisconnect=3]="WebsocketDisconnect",i[i.ConsumeRequestTimeout=4]="ConsumeRequestTimeout",i[i.OnTransportClose=5]="OnTransportClose",i[i.OnSignalRestart=6]="OnSignalRestart",i[i.MediaCapability=7]="MediaCapability"}(e.ReconnectReason||(e.ReconnectReason={})),e.MediaTypeListAudio=["audio","audioSlave"],e.MediaTypeListVideo=["video","screen","videoThird","videoFourth"],e.MediaTypeList=["audio","video","screen","audioSlave","videoThird","videoFourth"],e.PlatformTypeMap={"-1":"unknown",1:"aos",2:"ios",4:"pc",8:"winphone",9:"mac",16:"web"},function(i){i[i.unknown=-1]="unknown",i[i.aos=1]="aos",i[i.ios=2]="ios",i[i.pc=4]="pc",i[i.winphone=8]="winphone",i[i.mac=9]="mac",i[i.web=16]="web"}(e.PlatformType||(e.PlatformType={}))},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(o,f,m,g){g===void 0&&(g=m),Object.defineProperty(o,g,{enumerable:!0,get:function(){return f[m]}})}:function(o,f,m,g){g===void 0&&(g=m),o[g]=f[m]}),a=this&&this.__setModuleDefault||(Object.create?function(o,f){Object.defineProperty(o,"default",{enumerable:!0,value:f})}:function(o,f){o.default=f}),l=this&&this.__importStar||function(o){if(o&&o.__esModule)return o;var f={};if(o!=null)for(var m in o)m!=="default"&&Object.prototype.hasOwnProperty.call(o,m)&&i(f,o,m);return a(f,o),f},n=this&&this.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(e,"__esModule",{value:!0}),e.isNumber=e.isExistOptions=e.checkValidEnum=e.checkValidObject=e.checkValidString=e.checkValidInteger=e.checkValidFloat=e.checkValidBoolean=e.checkExists=e.isValidInteger=void 0;const c=n(r(6)),s=n(r(8)),d=l(r(7)),u=o=>Number.isInteger(o.value)?typeof o.min=="number"&&o.value<o.min?{result:!1,zhMsg:"参数小于最小值 "+o.min,enMsg:"The parameter is less than the minimum value "+o.min}:typeof o.max=="number"&&o.value>o.max?{result:!1,zhMsg:"参数大于最大值 "+o.max,enMsg:"The parameter is greater than the maximum value "+o.max}:{result:!0}:{result:!1,zhMsg:"参数不是整数",enMsg:"Parameter is not Number"};e.isValidInteger=u,e.checkValidInteger=o=>{const f=u(o);if(!f.result){let m=d.IS_ZH?`checkValidInteger: 参数错误: ${o.tag}:${f.zhMsg}`:`checkValidInteger: invalid parameter: ${o.tag}:${f.enMsg}`;throw new s.default({code:c.default.INVALID_PARAMETER_ERROR,message:m})}},e.checkValidBoolean=o=>{const f=(m=>typeof m.value!="boolean"?{result:!1,enMsg:"The parameter is not Boolean",zhMsg:"参数不是布尔类型"}:{result:!0})(o);if(!f.result){let m=d.IS_ZH?`checkValidBoolean: 参数错误: ${o.tag}:${f.zhMsg}`:`checkValidBoolean: invalid parameter: ${o.tag}:${f.enMsg}`;throw new s.default({code:c.default.INVALID_PARAMETER_ERROR,message:m})}},e.checkValidString=o=>{const f=(m=>typeof m.value!="string"?{result:!1,zhMsg:"参数不是字符串",enMsg:"The parameter is not String"}:typeof m.min=="number"&&m.value.length<m.min?{result:!1,zhMsg:"参数长度最小值"+m.min,enMsg:"The parameter is less than the minimum value "+m.min}:typeof m.max=="number"&&m.value.length>m.max?{result:!1,zhMsg:"参数长度大于最大值"+m.max,enMsg:"The parameter is greater than the maximum value "+m.max}:{result:!0})(o);if(!f.result){let m=d.IS_ZH?`checkValidString: 参数错误: ${o.tag}:${f.zhMsg}`:`checkValidString: invalid parameter: ${o.tag}:${f.enMsg}`;throw new s.default({code:c.default.INVALID_PARAMETER_ERROR,message:m})}},e.checkValidEnum=o=>{const f=(m=>m.enums.indexOf(m.value)===-1?{result:!1,zhMsg:`参数不符合枚举类型：${m.value}。有效的类型包括：${m.enums.join()}`,enMsg:`The param is not enum：${m.value}。Valid enums are：${m.enums.join()}`}:{result:!0})(o);if(!f.result){let m=d.IS_ZH?`checkValidEnum: 参数错误: ${o.tag}:${f.zhMsg}`:`checkValidEnum: invalid parameter: ${o.tag}:${f.enMsg}`;throw new s.default({code:c.default.INVALID_PARAMETER_ERROR,message:m})}},e.checkValidObject=o=>{const f=(m=>typeof m.value!="object"?{result:!1,zhMsg:"参数不是对象",enMsg:"The parameter is not Object"}:{result:!0})(o);if(!f.result){let m=d.IS_ZH?`checkValidObject: 参数错误: ${o.tag}:${f.zhMsg}`:`checkValidObject: invalid parameter: ${o.tag}:${f.enMsg}`;throw new s.default({code:c.default.INVALID_PARAMETER_ERROR,message:m})}},e.checkValidFloat=o=>{const f=(m=>Number.isFinite(m.value)?typeof m.min=="number"&&m.value<m.min?{result:!1,zhMsg:"参数小于最小值"+m.min,enMsg:"The parameter is less than the minimum value "+m.min}:typeof m.max=="number"&&m.value>m.max?{result:!1,zhMsg:"参数大于最大值"+m.max,enMsg:"The parameter is greater than the maximum value "+m.max}:{result:!0}:{result:!1,zhMsg:"参数不是float类型",enMsg:"The parameter is not float"})(o);if(!f.result){let m=d.IS_ZH?`checkValidFloat: 参数错误: ${o.tag}:${f.zhMsg}`:`checkValidFloat: invalid parameter: ${o.tag}:${f.enMsg}`;throw new s.default({code:c.default.INVALID_PARAMETER_ERROR,message:m})}};const h=o=>o.value===void 0||o.value===null?{result:!1,zhMsg:"未填必选参数",enMsg:"Missing required parameters"}:{result:!0};e.isExistOptions=h,e.checkExists=o=>{const f=h(o);if(!f.result){let m=d.IS_ZH?`checkExists: 参数错误: ${o.tag}:${f.zhMsg}`:`checkExists: invalid parameter: ${o.tag}:${f.enMsg}`;throw new s.default({code:c.default.INVALID_PARAMETER_ERROR,message:m})}},e.isNumber=o=>!isNaN(parseFloat(o))&&typeof o=="number"},function(t,e,r){var i=r(223),a=r(224);e.write=a,e.parse=i.parse,e.parseParams=i.parseParams,e.parseFmtpConfig=i.parseFmtpConfig,e.parsePayloads=i.parsePayloads,e.parseRemoteCandidates=i.parseRemoteCandidates,e.parseImageAttributes=i.parseImageAttributes,e.parseSimulcastStreamList=i.parseSimulcastStreamList},function(t,e){},function(t,e,r){var i=r(97)(!0);r(53)(String,"String",function(a){this._t=String(a),this._i=0},function(){var a,l=this._t,n=this._i;return n>=l.length?{value:void 0,done:!0}:(a=i(l,n),this._i+=a.length,{value:a,done:!1})})},function(t,e,r){var i=r(15),a=r(16),l=r(55),n=r(9),c=r(17),s=r(98),d=r(25),u=r(103),h=r(2)("iterator"),o=!([].keys&&"next"in[].keys()),f=function(){return this};t.exports=function(m,g,v,O,T,C,A){s(v,g,O);var R,w,k,I=function(D){if(!o&&D in y)return y[D];switch(D){case"keys":case"values":return function(){return new v(this,D)}}return function(){return new v(this,D)}},M=g+" Iterator",P=T=="values",S=!1,y=m.prototype,_=y[h]||y["@@iterator"]||T&&y[T],b=_||I(T),E=T?P?I("entries"):b:void 0,x=g=="Array"&&y.entries||_;if(x&&(k=u(x.call(new m)))!==Object.prototype&&k.next&&(d(k,M,!0),i||typeof k[h]=="function"||n(k,h,f)),P&&_&&_.name!=="values"&&(S=!0,b=function(){return _.call(this)}),i&&!A||!o&&!S&&y[h]||n(y,h,b),c[g]=b,c[M]=f,T)if(R={values:P?b:I("values"),keys:C?b:I("keys"),entries:E},A)for(w in R)w in y||l(y,w,R[w]);else a(a.P+a.F*(o||S),g,R);return R}},function(t,e,r){t.exports=!r(12)&&!r(22)(function(){return Object.defineProperty(r(32)("div"),"a",{get:function(){return 7}}).a!=7})},function(t,e,r){t.exports=r(9)},function(t,e,r){var i=r(5),a=r(99),l=r(37),n=r(35)("IE_PROTO"),c=function(){},s=function(){var d,u=r(32)("iframe"),h=l.length;for(u.style.display="none",r(59).appendChild(u),u.src="javascript:",(d=u.contentWindow.document).open(),d.write("<script>document.F=Object<\/script>"),d.close(),s=d.F;h--;)delete s.prototype[l[h]];return s()};t.exports=Object.create||function(d,u){var h;return d!==null?(c.prototype=i(d),h=new c,c.prototype=null,h[n]=d):h=s(),u===void 0?h:a(h,u)}},function(t,e,r){var i=r(13),a=r(14),l=r(101)(!1),n=r(35)("IE_PROTO");t.exports=function(c,s){var d,u=a(c),h=0,o=[];for(d in u)d!=n&&i(u,d)&&o.push(d);for(;s.length>h;)i(u,d=s[h++])&&(~l(o,d)||o.push(d));return o}},function(t,e,r){var i=r(30),a=Math.min;t.exports=function(l){return l>0?a(i(l),9007199254740991):0}},function(t,e,r){var i=r(0).document;t.exports=i&&i.documentElement},function(t,e,r){var i=r(31);t.exports=function(a){return Object(i(a))}},function(t,e,r){r(104);for(var i=r(0),a=r(9),l=r(17),n=r(2)("toStringTag"),c="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),s=0;s<c.length;s++){var d=c[s],u=i[d],h=u&&u.prototype;h&&!h[n]&&a(h,n,d),l[d]=l.Array}},function(t,e,r){var i=r(18),a=r(2)("toStringTag"),l=i(function(){return arguments}())=="Arguments";t.exports=function(n){var c,s,d;return n===void 0?"Undefined":n===null?"Null":typeof(s=function(u,h){try{return u[h]}catch{}}(c=Object(n),a))=="string"?s:l?i(c):(d=i(c))=="Object"&&typeof c.callee=="function"?"Arguments":d}},function(t,e,r){var i=r(5),a=r(21),l=r(2)("species");t.exports=function(n,c){var s,d=i(n).constructor;return d===void 0||(s=i(d)[l])==null?c:a(s)}},function(t,e,r){var i,a,l,n=r(20),c=r(113),s=r(59),d=r(32),u=r(0),h=u.process,o=u.setImmediate,f=u.clearImmediate,m=u.MessageChannel,g=u.Dispatch,v=0,O={},T=function(){var A=+this;if(O.hasOwnProperty(A)){var R=O[A];delete O[A],R()}},C=function(A){T.call(A.data)};o&&f||(o=function(A){for(var R=[],w=1;arguments.length>w;)R.push(arguments[w++]);return O[++v]=function(){c(typeof A=="function"?A:Function(A),R)},i(v),v},f=function(A){delete O[A]},r(18)(h)=="process"?i=function(A){h.nextTick(n(T,A,1))}:g&&g.now?i=function(A){g.now(n(T,A,1))}:m?(l=(a=new m).port2,a.port1.onmessage=C,i=n(l.postMessage,l,1)):u.addEventListener&&typeof postMessage=="function"&&!u.importScripts?(i=function(A){u.postMessage(A+"","*")},u.addEventListener("message",C,!1)):i="onreadystatechange"in d("script")?function(A){s.appendChild(d("script")).onreadystatechange=function(){s.removeChild(this),T.call(A)}}:function(A){setTimeout(n(T,A,1),0)}),t.exports={set:o,clear:f}},function(t,e){t.exports=function(r){try{return{e:!1,v:r()}}catch(i){return{e:!0,v:i}}}},function(t,e,r){var i=r(5),a=r(11),l=r(38);t.exports=function(n,c){if(i(n),a(c)&&c.constructor===n)return c;var s=l.f(n);return(0,s.resolve)(c),s.promise}},function(t,e){e.f=Object.getOwnPropertySymbols},function(t,e,r){var i=r(57),a=r(37).concat("length","prototype");e.f=Object.getOwnPropertyNames||function(l){return i(l,a)}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.MEDIA_READYSTATE_REV=e.MEDIA_READYSTATE=e.STREAM_TYPE_REV=e.STREAM_TYPE=e.NERTC_VIDEO_QUALITY_REV=e.NERTC_VIDEO_QUALITY=e.NERTC_VIDEO_QUALITY_ENUM=e.NERTC_RECORD_VIDEO_FRAME_RATE=e.NERTC_RECORD_VIDEO_QUALITY=e.VIDEO_FRAME_RATE=e.VIDEO_FRAME_RATE_ENUM=void 0,function(i){i[i.CHAT_VIDEO_FRAME_RATE_NORMAL=0]="CHAT_VIDEO_FRAME_RATE_NORMAL",i[i.CHAT_VIDEO_FRAME_RATE_5=1]="CHAT_VIDEO_FRAME_RATE_5",i[i.CHAT_VIDEO_FRAME_RATE_10=2]="CHAT_VIDEO_FRAME_RATE_10",i[i.CHAT_VIDEO_FRAME_RATE_15=3]="CHAT_VIDEO_FRAME_RATE_15",i[i.CHAT_VIDEO_FRAME_RATE_20=4]="CHAT_VIDEO_FRAME_RATE_20",i[i.CHAT_VIDEO_FRAME_RATE_25=5]="CHAT_VIDEO_FRAME_RATE_25",i[i.CHAT_VIDEO_FRAME_RATE_30=6]="CHAT_VIDEO_FRAME_RATE_30"}(e.VIDEO_FRAME_RATE_ENUM||(e.VIDEO_FRAME_RATE_ENUM={})),e.VIDEO_FRAME_RATE={CHAT_VIDEO_FRAME_RATE_NORMAL:0,CHAT_VIDEO_FRAME_RATE_5:1,CHAT_VIDEO_FRAME_RATE_10:2,CHAT_VIDEO_FRAME_RATE_15:3,CHAT_VIDEO_FRAME_RATE_20:4,CHAT_VIDEO_FRAME_RATE_25:5,CHAT_VIDEO_FRAME_RATE_30:6},e.NERTC_RECORD_VIDEO_QUALITY={RECORD_VIDEO_QUALITY_360p:360,RECORD_VIDEO_QUALITY_480p:480,RECORD_VIDEO_QUALITY_720p:720},e.NERTC_RECORD_VIDEO_FRAME_RATE={RECORD_VIDEO_FRAME_RATE_15:15,RECORD_VIDEO_FRAME_RATE_30:30},function(i){i[i.VIDEO_QUALITY_180p=2]="VIDEO_QUALITY_180p",i[i.VIDEO_QUALITY_480p=4]="VIDEO_QUALITY_480p",i[i.VIDEO_QUALITY_720p=8]="VIDEO_QUALITY_720p",i[i.VIDEO_QUALITY_1080p=16]="VIDEO_QUALITY_1080p"}(e.NERTC_VIDEO_QUALITY_ENUM||(e.NERTC_VIDEO_QUALITY_ENUM={})),e.NERTC_VIDEO_QUALITY={VIDEO_QUALITY_180p:2,VIDEO_QUALITY_480p:4,VIDEO_QUALITY_720p:8,VIDEO_QUALITY_1080p:16},e.NERTC_VIDEO_QUALITY_REV={[e.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_180p]:"320x180",[e.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p]:"640x480",[e.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_720p]:"1280x720",[e.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p]:"1920x1080"},e.STREAM_TYPE={HIGH:0,LOW:1},e.STREAM_TYPE_REV={0:"HIGH",1:"LOW"},e.MEDIA_READYSTATE={HAVE_NOTHING:0,HAVE_METADATA:1,HAVE_CURRENT_DATA:2,HAVE_FUTURE_DATA:3,HAVE_ENOUGH_DATA:4},e.MEDIA_READYSTATE_REV={0:"HAVE_NOTHING",1:"HAVE_METADATA",2:"HAVE_CURRENT_DATA",3:"HAVE_FUTURE_DATA",4:"HAVE_ENOUGH_DATA"}},function(t,e){var r;r=function(){return this}();try{r=r||new Function("return this")()}catch{typeof window=="object"&&(r=window)}t.exports=r},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.getStream=e.getScreenStream=e.emptyStreamWith=e.printVideoState=e.printForLongPromise=e.watchTrack=e.checkScreenTrackSurface=void 0;const i=r(175),a=r(144),l=r(76),n=r(1),c=r(47),s=r(251),d=r(252),u=r(28),h=r(69),o=r(176),f=r(7),m=new u.Logger({tagGen:()=>"GUM"});let g=0,v="getSettings"in MediaStreamTrack.prototype;function O(k){const I=n.getParameters().forceDisplaySurface;if(I==="default")return!0;const M=function(P){return P.getSettings().displaySurface!==void 0?P.getSettings().displaySurface:f.IS_FIREFOX?P.label===""||P.label.indexOf("Primary Monitor")>-1?"monitor":(m.log("getDisplaySurfaceType: ",P.label),"unknown"):f.IS_SAFARI?"unknown":P.label.indexOf("web-contents")>-1?"browser":P.label.indexOf("window")>-1?"window":P.label.indexOf("screen")>-1?"monitor":(m.log("getDisplaySurfaceType: ",P.label),"unknown")}(k);return M=="unknown"?(m.warn("checkScreenTrackSurface: unknown ",k.label),l.Device.emit("unknown-display-surface",k.label),!0):(m.log("checkScreenTrackSurface: ",M),I===M)}e.getStream=async function(k,I){if(k.audio&&typeof k.audio=="object"){if(!k.audio.deviceId){const P=l.Device.deviceHistory.audioIn.find(S=>S.deviceId==="default");P&&(I.log("getStream：音频使用默认设备"+P.label),k.audio.deviceId={exact:P.deviceId})}a.compatAudioInputList.enabled&&(I.log("兼容模式：constraint强制将channelCount设为2，echoCancellation设为false"),k.audio.channelCount=2,k.audio.echoCancellation=!1)}const M=++g;I.log("getLocalStream constraint: #"+M,JSON.stringify(k));try{const P=navigator.mediaDevices.getUserMedia(k);w(P,"仍在等待 getUserMedia 返回 #"+M);const S=await P;I.log("获取到媒体流: #"+M,S.id);const y=S.getTracks();for(let _=0;_<y.length;_++){const b=y[_];if(R(b),b.kind==="video"){if(s.canShimCanvas()){I.warn("使用canvas track取代videoTrack",b.label);const E=s.shimCanvas(b);R(E),S.removeTrack(b),S.addTrack(E)}}else if(b.kind==="audio"&&a.compatAudioInputList.enabled){let E;E=v?b.getSettings?b.getSettings():{}:b.getConstraints?b.getConstraints():{},E.channelCount&&E.channelCount>=2?I.log("该设备支持兼容模式："+b.label,E):I.warn("该设备为单声道设备，强行开启兼容模式(右声道无声)："+b.label,E);const x=c.getAudioContext();if(x){const D=x.createChannelSplitter(2),F=x.createMediaStreamDestination(),V=new MediaStream([b]),N=x.createMediaStreamSource(V),L=new i.AudioLevel({stream:V,logger:I,sourceNode:N});let U=0;n.getParameters().audioInputcompatMode==="left"?(I.log("兼容模式：仅使用左声道"),U=0):n.getParameters().audioInputcompatMode==="right"?(I.log("兼容模式：仅使用右声道"),U=1):n.getParameters().audioInputcompatMode==="auto"&&(I.log("兼容模式：在左右声道间根据音量切换"),L.on("channel-state-change",j=>{j.state==="leftLoud"&&U===1?(I.log("兼容模式切换至左声道：",b.label),D.disconnect(F),D.connect(F,0),U=0):j.state==="rightLoud"&&U===0&&(I.log("兼容模式切换至右声道：",b.label),D.disconnect(F),D.connect(F,1),U=1)})),N.connect(D),D.connect(F,U);const H=F.stream.getTracks()[0];R(H),a.compatAudioInputList.compatTracks.push({source:b,dest:H}),d.syncTrackState(b,H,"bidirectional"),S.removeTrack(b),S.addTrack(H),I.log("getStream：启用兼容模式成功")}}}return S}catch(P){if(I.error(`getUserMedia error: ${P.name} [${P.message}] constraint: ${JSON.stringify(k)}`),k.video){l.Device.emit("device-open-fail",k),k.video=!0,I.log("使用浏览器默认参数，尝试重新获取视频流",JSON.stringify(k));try{const S=navigator.mediaDevices.getUserMedia(k);w(S,"仍在等待 getUserMedia 返回 #"+M);const y=await S;I.log("重新获取视频流成功: #"+M,y.id);const _=y.getTracks();for(let b=0;b<_.length;b++){const E=_[b];if(R(E),E.kind==="video"){if(s.canShimCanvas()){I.warn("使用canvas track取代videoTrack",E.label);const x=s.shimCanvas(E);R(x),y.removeTrack(E),y.addTrack(x)}}else E.kind}return y}catch(S){return I.error(`重新获取视频流失败, ${S.name} [${S.message}]`),Promise.reject(S)}}return Promise.reject(P)}},e.getScreenStream=async function(k,I){var M;const P=++g;let S;o.patchScreenConstraints(k,I),I.log("getScreenStream constraint: #"+P,JSON.stringify(k,null," ")),navigator.getDisplayMedia||navigator.mediaDevices.getDisplayMedia;try{const _=navigator.mediaDevices.getDisplayMedia(k);w(_,"仍在等待 getDisplayMedia 返回 #"+P),S=await _}catch(_){if(!(((M=_==null?void 0:_.message)===null||M===void 0?void 0:M.indexOf("user gesture"))>-1&&l.Device.onUserGestureNeeded))throw I.error("屏幕共享获取失败: #"+P,_.name,_.message),_;I.warn("荧幕共享获取中断，需要手势触发。",P),l.Device.onUserGestureNeeded(_);try{S=await new Promise((b,E)=>{l.Device.once("user-gesture-fired",()=>{navigator.mediaDevices.getDisplayMedia(k).then(b).catch(E)})})}catch(b){throw I.error("第二次屏幕共享获取失败: #"+P,b.name,b.message),b}}let y=S.getVideoTracks()[0];if(y&&!O(y))throw I.error("屏幕共享流和forceDisplaySurface参数设置不同"),S.getTracks().forEach(_=>{_.stop()}),{name:"DisplaySurfaceError",message:"displaySurface not match"};return(_=>{I.log("获取到屏幕共享流: #"+P,_.id),_.getTracks().forEach(b=>{R(b)}),Promise.resolve(_)})(S),S},e.checkScreenTrackSurface=O;let T=Date.now(),C=0;const A=()=>{const k=n.getParameters().tracks.video,I=n.getParameters().tracks.audio,M=Date.now();if(M-T>5e3&&C<n.getParameters().maxEventLoopLagWarning){let S=`侦测到主线程事件循环从卡死中恢复。卡顿时间：${M-T-1e3}毫秒。`;S+="这可能是由于页面切往后台、设备休眠、频繁的dom操作、阻塞性代码引起的。",S+=`当前页面页面是否隐藏：${document.hidden}，可见性：${document.visibilityState}，网络状态：${navigator.onLine}。`,C+=1,C===n.getParameters().maxEventLoopLagWarning&&(S+="今后不再提示。"),m.warn(S)}T=M;const P=(S,y)=>{if(!S)return;let _="";if(_=S.canvas?`CANVASTRACK#${y}${S.canvas.width}x${S.canvas.height}`:`${S.kind.toUpperCase()}TRACK#${y}【${S.label}】`,!S.endedAt)if(S.readyState==="ended"){m.log(_+": 已停止"),S.endedAt=M;const b=new CustomEvent("neTrackEnded");S.dispatchEvent(b)}else!S.canvas&&S.muted&&S.enabled?(S.mutedStartAt=S.mutedStartAt||M,S.mutedCnt=S.mutedCnt||0,S.mutedCnt++,S.mutedCnt!==11&&S.mutedCnt!==31||(m.warn(`${_}： 处于无数据状态，请检查设备是否正常:${M-S.mutedStartAt}ms（系统可能休眠了，或者浏览器进程被阻塞）`),function(b){const E=[...n.getParameters().tracks.video,...n.getParameters().tracks.audio];for(let x=0;x<E.length;x++){const D=E[x];if(D&&D.label===b.label&&D!==b&&D.readyState!=="ended")return!0}return!1}(S)&&m.warn(_+" ：该设备打开了多次"))):S.mutedStartAt&&(S.mutedCnt&&S.mutedCnt>11&&m.warn(`${_}：数据恢复正常 :${M-S.mutedStartAt}ms`),delete S.mutedStartAt,delete S.mutedCnt)};k.forEach(P),I.forEach(P)};function R(k){if(k)if(k.readyState==="ended"&&m.error("注意：输入的track已经停止：",k),k.kind==="audio"){const I=n.getParameters().tracks.audio;let M=v?k.getSettings():k.getConstraints();m.log("获取到的设备类型: AUDIOTRACK#"+I.length,k.kind,k.label,k.id,JSON.stringify(M));const P=I.findIndex(S=>k===S);P>-1?(m.warn(`注意：AUDIOTRACK#${I.length} 与 AUDIOTRACK#${P} 相同`),I.push(null)):(k.addEventListener("ended",A),I.push(k))}else{const I=n.getParameters().tracks.video;let M=v?k.getSettings():k.getConstraints();m.log("获取到的设备类型: VIDEOTRACK#"+I.length,k.kind,k.label,k.id,JSON.stringify(M));const P=I.findIndex(S=>k===S);P>-1?(m.warn(`注意：VIDEOTRACK#${I.length} 与 VIDEOTRACK#${P} 相同`),I.push(null)):(k.addEventListener("ended",A),I.push(k))}}async function w(k,I){let M=0;const P=Date.now();let S=setInterval(()=>{M++,u.getDefaultLogger().warn(`${I} ${Date.now()-P}ms`),S&&M>10&&(clearInterval(S),S=null)},6e3);k.then(()=>{S&&(clearInterval(S),S=null)}).catch(y=>{S&&(clearInterval(S),S=null)})}setInterval(A,1e3),e.watchTrack=R,e.printForLongPromise=w,e.printVideoState=async function(k,I,M,P){let S=0;const y=Date.now(),_=[1,5,10];let b=setInterval(()=>{if(S++,_.indexOf(S)===-1)return;let E=`播放 ${M} 的 ${P}, HTMLMediaElement ReadyState:${h.MEDIA_READYSTATE_REV[I.readyState]}(${I.readyState})Paused: ${I.paused}.Time: ${Date.now()-y}ms.`;const x=I.srcObject,D=x==null?void 0:x.getTracks()[0];D?(E+=`, 媒体Track enabled: ${D.enabled} muted:${D.muted} name:[${D.label}]`,D.enabled?D.muted?u.getDefaultLogger().warn("媒体处于mute状态，无数据或者解码失败："+E):u.getDefaultLogger().warn("媒体标签仍在启动播放中："+E):(u.getDefaultLogger().warn("媒体被disable："+E),b&&(clearInterval(b),b=null))):(u.getDefaultLogger().warn("媒体标签srcObject属性处于异常状态："+E),b&&(clearInterval(b),b=null)),b&&S>_[_.length-1]&&(clearInterval(b),b=null)},6e3);k.then(()=>{b&&(clearInterval(b),b=null)}).catch(E=>{b&&(clearInterval(b),b=null)})},e.emptyStreamWith=function(k,I){let M=!1;k.getTracks().forEach(P=>{P!==I?(k.removeTrack(P),k.onremovetrack&&k.onremovetrack({track:P})):M=!0}),!M&&I&&(k.addTrack(I),k.onaddtrack&&k.onaddtrack({track:I}))}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.NeAudioNode=e.NeAudioNodeNullable=void 0;const i=r(46);let a=0;class l extends i.RTCEventEmitter{constructor(c,s){super(),this.id=a++,this.connectedTo=[],this.connectedFrom=[],this.tag=c,this.audioNode=s}connect(c){this.audioNode&&c.audioNode&&this.audioNode.connect(c.audioNode),this.connectedTo.indexOf(c)===-1&&this.connectedTo.push(c),c.connectedFrom.indexOf(this)===-1&&c.connectedFrom.push(this)}disconnect(c){this.audioNode&&c.audioNode&&this.audioNode.disconnect(c.audioNode),this.connectedTo.indexOf(c)!==-1&&this.connectedTo.splice(this.connectedTo.indexOf(c),1),c.connectedFrom.indexOf(this)===-1&&c.connectedFrom.splice(c.connectedFrom.indexOf(this),1)}isConnectedTo(c){return this.connectedTo.indexOf(c)>-1}isConnectedFrom(c){return this.connectedFrom.indexOf(c)>-1}disconnectFromAll(){this.connectedFrom.forEach(c=>{c.audioNode&&this.audioNode&&c.audioNode.disconnect(this.audioNode);const s=c.connectedTo.indexOf(this);s>-1&&c.connectedTo.splice(s,1)}),this.connectedFrom.length=0}disconnectToAll(){this.connectedTo.forEach(c=>{c.audioNode&&this.audioNode&&this.audioNode.disconnect(c.audioNode);const s=c.connectedFrom.indexOf(this);s>-1&&c.connectedFrom.splice(s,1)}),this.connectedTo.length=0}updateNode(c){this.connectedTo.forEach(s=>{s.audioNode&&(this.audioNode&&this.audioNode.disconnect(s.audioNode),c.connect(s.audioNode))}),this.connectedFrom.forEach(s=>{s.audioNode&&(this.audioNode&&s.audioNode.disconnect(this.audioNode),s.audioNode.connect(c))}),this.audioNode=c}}e.NeAudioNodeNullable=l,e.NeAudioNode=class extends l{constructor(n,c){super(n,c),this.tag=n,this.audioNode=c}}},function(t,e,r){t.exports=r(93)},function(t,e,r){e.__esModule=!0;var i,a=r(95),l=(i=a)&&i.__esModule?i:{default:i};e.default=function(n){return function(){var c=n.apply(this,arguments);return new l.default(function(s,d){return function u(h,o){try{var f=c[h](o),m=f.value}catch(g){return void d(g)}if(!f.done)return l.default.resolve(m).then(function(g){u("next",g)},function(g){u("throw",g)});s(m)}("next")})}}},function(t,e,r){function i(c){return c>0&&(c&c-1)==0}Object.defineProperty(e,"__esModule",{value:!0}),e.loadImageBatch=e.retryLoadImage=e.loadImage=e.createTexture=e.imgDataSize=e.toNthPower=e.isNthPower=void 0,e.isNthPower=i,e.toNthPower=function(c){if(i(c))return c;const s=[4096,2048,1024,512,256,128,64,32,16,8,4,2,1];let d=1/0;for(let u=0;u<s.length;u++){const h=s[u],o=Math.abs(c-h);if(c>=h)return o>d?s[u-1]:h;d=o}return 1},e.imgDataSize=function(c,s,d){if(d=d??Math.min(s)){const u=Math.max(c,s);if(u>512){const h=u/512;return{width:c/h>>0,height:s/h>>0}}}return{width:c,height:s}},e.createTexture=function c(s,d,u){const h=s.createTexture();if(!h)return console.error(`texture:[${d}] created error.`),null;const o=Object.assign({flipY:!0,wrapS:"clamp",wrapT:"clamp",genMipMaps:!1},u),f={clamp:s.CLAMP_TO_EDGE,repeat:s.REPEAT,mirror:s.MIRRORED_REPEAT},m={glTexture:h,source:d,refresh(){const{source:g,glTexture:v,opts:O}=m,{genMipMaps:T}=O,C=s.TEXTURE_2D;s.bindTexture(C,v);const{flipY:A}=O;A?s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0):s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!1),s.texParameteri(C,s.TEXTURE_WRAP_S,f[O.wrapS]),s.texParameteri(C,s.TEXTURE_WRAP_T,f[O.wrapT]),s.texParameteri(C,s.TEXTURE_MIN_FILTER,T?s.LINEAR_MIPMAP_LINEAR:s.LINEAR),s.texParameteri(C,s.TEXTURE_MAG_FILTER,s.LINEAR),"width"in O&&"height"in O?s.texImage2D(C,0,s.RGBA,O.width,O.height,0,s.RGBA,s.UNSIGNED_BYTE,g):g!==null&&s.texImage2D(C,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,g),T&&s.generateMipmap(C)},updateMipMap(){const{glTexture:g,opts:v}=m,{genMipMaps:O}=v;if(!O)return;const T=s.TEXTURE_2D;s.bindTexture(T,g),s.generateMipmap(T)},clone:()=>c(s,m.source,m.opts),opts:o};return m.refresh(),m};const a={};function l(c,s,d){typeof c=="string"&&c&&(a[c]?s==null||s(a[c]):fetch(c+"?rdn="+Date.now()).then(u=>u.arrayBuffer()).then(u=>{let h=!1;const o=new Blob([u],{type:"image/*"}),f=new Image;new URL(c,window.location.href).origin!==window.location.origin&&(f.crossOrigin="anonymous"),f.onload=()=>{h||(h=!0,a[c]=f,s==null||s(f))},f.onerror=m=>{d==null||d(m)},f.src=URL.createObjectURL(o),setTimeout(()=>{!h&&f.complete&&f.naturalHeight>0&&(h=!0,a[c]=f,s==null||s(f))},0)}).catch(u=>{d==null||d(u)}))}function n(c,s=3,d,u){let h=null;const o=(f=0)=>{(f+=1)<=s?l(c,m=>{d==null||d(m)},m=>{h=m,o(f)}):u==null||u(h)};o()}e.loadImage=l,e.retryLoadImage=n,e.loadImageBatch=function(c,s=3,d){let u={},h=[];const o=()=>{Object.keys(u).length+h.length===c.length&&(d==null||d(u,h))};c.forEach(f=>{n(f,s,m=>{u[f]=m,o()},()=>{h.push(f),o()})})}},function(t,e,r){var i=this&&this.__importDefault||function(f){return f&&f.__esModule?f:{default:f}};Object.defineProperty(e,"__esModule",{value:!0}),e.Device=e.alerter=void 0;const a=i(r(6)),l=i(r(8)),n=r(46),c=r(28),s=r(142);Object.defineProperty(e,"alerter",{enumerable:!0,get:function(){return s.alerter}});const d=r(144),u=r(1);class h extends n.RTCEventEmitter{constructor(){super(),this.deviceChangeDetectionTimer=null,this.deviceInited=!1,this.hasPerm={audioIn:!1,video:!1,audioOut:!1},this.deviceHistory={audioIn:[],video:[],audioOut:[]},this.compatAudioInputList=d.compatAudioInputList,this.__v_skip=u.getParameters().enableVSkip,this.onUserGestureNeeded=null,this.logger=new c.Logger({tagGen:()=>`Device m${this.deviceHistory.audioIn.length}c${this.deviceHistory.video.length}s${this.deviceHistory.audioOut.length}`}),this.handleDeviceChange=this.detectDeviceChange.bind(this),this.onUserGestureNeeded=this.defaultHandleUserGestureNeeded.bind(this),s.alerter.addListener("@user-gesture-fired",()=>{this.safeEmit("user-gesture-fired")})}async getDevices(m){if(!navigator.mediaDevices)throw this.logger.error("navigator.mediaDevices is "+navigator.mediaDevices),new l.default({code:a.default.NOT_SUPPORT_ERROR,message:"getDevices: 当前浏览器不支持 mediaDevices",url:"https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/enumerateDevices"});if(!navigator.mediaDevices.enumerateDevices)throw this.logger.error("navigator.mediaDevices is "+navigator.mediaDevices.enumerateDevices),new l.default({code:a.default.NOT_SUPPORT_ERROR,message:"getDevices: 当前浏览器不支持 enumerateDevices",url:"https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/enumerateDevices"});let g={video:[],audioIn:[],audioOut:[]},v=await navigator.mediaDevices.enumerateDevices(),O=null;if(m.requestPerm){const T=v.find(A=>m.audioinput&&A.kind=="audioinput"&&!A.label),C=v.find(A=>m.videoinput&&A.kind=="videoinput"&&!A.label);if(T||C)try{O=await navigator.mediaDevices.getUserMedia({audio:T,video:C})}catch(A){this.logger.error(A.name,A.message,A.stack)}}return v=await navigator.mediaDevices.enumerateDevices(),v.forEach(function(T){if(m.videoinput&&T.kind==="videoinput"){let C={deviceId:T.deviceId,label:T.label||(m.noFillLabel?T.label:"camera "+(g.video.length+1))};m.groupId&&(C.groupId=T.groupId),g.video.push(C)}else if(m.audioinput&&T.kind==="audioinput"){let C;C={deviceId:T.deviceId,label:T.label||(m.noFillLabel?T.label:"microphone "+(g.audioIn.length+1))},m.groupId&&(C.groupId=T.groupId),g.audioIn.push(C)}else if(m.audiooutput&&T.kind==="audiooutput"){let C={deviceId:T.deviceId,label:T.label||(m.noFillLabel?T.label:"speaker "+(g.audioOut.length+1))};m.groupId&&(C.groupId=T.groupId),g.audioOut.push(C)}O&&O.getTracks().forEach(C=>{C.stop()})}),g}async getCameras(m){const g=await this.getDevices({videoinput:!0,requestPerm:m});return g?g.video:[]}async getMicrophones(m){const g=await this.getDevices({audioinput:!0,requestPerm:m});return g?g.audioIn:[]}async getSpeakers(m){const g=await this.getDevices({audioinput:!0,audiooutput:!0,requestPerm:m});return g?g.audioOut:[]}async detectDeviceChange(){let m={audioIn:{added:[],changed:[],removed:[]},video:{added:[],changed:[],removed:[]},audioOut:{added:[],changed:[],removed:[]}};const g=await this.getDevices({audioinput:!0,audiooutput:!0,videoinput:!0,requestPerm:!1,groupId:!0,noFillLabel:!0});["audioIn","video","audioOut"].forEach(v=>{if(this.deviceInited){const O=g[v].find(T=>T.deviceId&&T.label);O?this.hasPerm[v]?(g[v].forEach(T=>{const C=this.deviceHistory[v].find(A=>A.deviceId===T.deviceId||A.deviceId===""&&T.deviceId==="default");if(C){if(C.label!==T.label||C.groupId!==T.groupId){let A=`检测到设备改变：${v}: deviceId ${T.deviceId}`;C.label!==T.label?A+=`【Label ${C.label} => ${T.label}】`:A+=" Label "+T.label,C.groupId!==T.groupId&&(A+="【groupId changed】"),this.logger.log(A),m[v].changed.push(T)}}else this.logger.log(`检测到设备新增：${v}: deviceId ${T.deviceId} 【${T.label}】`),m[v].added.push(T)}),this.deviceHistory[v].forEach(T=>{g[v].find(C=>T.deviceId===C.deviceId||T.deviceId===""&&C.deviceId==="default")||(this.logger.log(`检测到设备拔出：${v}: deviceId ${T.deviceId} 【${T.label}】`),m[v].removed.push(T))}),this.deviceHistory[v]=g[v],m[v].added.forEach(T=>{v==="audioIn"?this.emit("recording-device-changed",{device:T,state:"ACTIVE"}):v==="video"?this.emit("camera-changed",{device:T,state:"ACTIVE"}):v==="audioOut"&&this.emit("playout-device-changed",{device:T,state:"ACTIVE"})}),m[v].changed.forEach(T=>{v==="audioIn"?this.emit("recording-device-changed",{device:T,state:"CHANGED"}):v==="video"?this.emit("camera-changed",{device:T,state:"CHANGED"}):v==="audioOut"&&this.emit("playout-device-changed",{device:T,state:"CHANGED"})}),m[v].removed.forEach(T=>{v==="audioIn"?this.emit("recording-device-changed",{device:T,state:"INACTIVE"}):v==="video"?this.emit("camera-changed",{device:T,state:"INACTIVE"}):v==="audioOut"&&this.emit("playout-device-changed",{device:T,state:"INACTIVE"})})):(this.hasPerm[v]=!0,this.deviceHistory[v]=g[v],v==="audioIn"?(this.logger.log(`麦克风设备：${O.deviceId}【${O.label}】`),this.emit("recording-device-init")):v==="video"?(this.logger.log(`摄像头设备：【${g[v].map(T=>T.label).join("】【")}】`),this.emit("camera-init")):v==="audioOut"&&(this.logger.log(`扬声器设备：${O.deviceId}【${O.label}】`),this.emit("playout-device-init"))):this.deviceHistory[v]=g[v]}else this.deviceHistory[v]=g[v]}),this.deviceInited||(this.deviceInited=!0,g.audioIn.length||this.logger.error("未侦测到可用麦克风"),g.video.length||this.logger.error("未侦测到可用摄像头"))}async startDeviceChangeDetection(){navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?(this.deviceChangeDetectionTimer&&clearInterval(this.deviceChangeDetectionTimer),await this.handleDeviceChange(),navigator.mediaDevices.ondevicechange?navigator.mediaDevices.ondevicechange===this.handleDeviceChange||(u.getParameters().forceListenDeviceChange?navigator.mediaDevices.ondevicechange=this.handleDeviceChange:this.logger.warn("系统设备枚举回调已被占用，设备枚举实效性将受到影响")):navigator.mediaDevices.ondevicechange=this.handleDeviceChange,u.getParameters().deviceChangeInterval&&(this.deviceChangeDetectionTimer=setInterval(this.handleDeviceChange,1e3))):this.logger.warn("当前环境不支持设备枚举")}stopDeviceChangeDetection(){this.logger.log("停止监听浏览器设备变化"),this.deviceChangeDetectionTimer&&(clearInterval(this.deviceChangeDetectionTimer),this.deviceChangeDetectionTimer=null),navigator.mediaDevices&&navigator.mediaDevices.ondevicechange&&(navigator.mediaDevices.ondevicechange=null),this.deviceInited=!1,this.deviceHistory.audioIn=[],this.deviceHistory.audioOut=[],this.deviceHistory.video=[],this.hasPerm.audioIn=!1,this.hasPerm.video=!1,this.hasPerm.audioOut=!1}enableCompatMode(){this.logger.log("开启兼容模式"),d.compatAudioInputList.enabled=!0,this.handleDeviceChange()}disableCompatMode(){this.logger.log("关闭兼容模式。"),d.compatAudioInputList.enabled=!1,this.handleDeviceChange()}defaultHandleUserGestureNeeded(m){const g=`由于浏览器限制，该操作需手势触发。<br/>${m.name}<br/>${m.message}<br/>点击此处以继续`;s.alerter.alert(g),this.logger.warn('为避免看到这个消息，您应该实现 Device.onUserGestureNeeded 方法，引导用户作出手势，并触发 Device.on("user-gesture-fired")事件。')}clean(){}}const o=new h;e.Device=o},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(d,u,h,o){o===void 0&&(o=h),Object.defineProperty(d,o,{enumerable:!0,get:function(){return u[h]}})}:function(d,u,h,o){o===void 0&&(o=h),d[o]=u[h]}),a=this&&this.__setModuleDefault||(Object.create?function(d,u){Object.defineProperty(d,"default",{enumerable:!0,value:u})}:function(d,u){d.default=u}),l=this&&this.__importStar||function(d){if(d&&d.__esModule)return d;var u={};if(d!=null)for(var h in d)h!=="default"&&Object.prototype.hasOwnProperty.call(d,h)&&i(u,d,h);return a(u,d),u};Object.defineProperty(e,"__esModule",{value:!0}),e.getBrowserInfo=e.getOSInfo=void 0;const n=l(r(7)),c=new Map([[n.IS_ANDROID,["Android",n.ANDROID_VERSION]],[n.IS_IOS,["iOS",n.IOS_VERSION]],[n.IS_WIN,["Windows",n.WIN_VERSION]],[n.IS_MAC,["MacOS",n.MACOS_VERSION]]]);e.getOSInfo=function(){let d="unknown",u="unknown";return c.get(!0)&&(d=c.get(!0)[0],u=c.get(!0)[1]),{osName:d,osVersion:u}};const s=new Map([[n.IS_FIREFOX,["Firefox",n.FIREFOX_VERSION]],[n.IS_EDG,["Edg",n.EDG_VERSION]],[n.IS_CHROME,["Chrome",n.CHROME_VERSION]],[n.IS_SAFARI,["Safari",n.SAFARI_VERSION]],[n.IS_WECHAT,["WeChat",n.WECHAT_VERSION]],[n.IS_WQQB,["QQ(Win)",n.WQQB_VERSION]],[n.IS_MQQB,["QQ(Mobile)",n.MQQB_VERSION]],[n.IS_X5MQQB,["QQ(Mobile X5)",n.MQQB_VERSION]],[n.IS_MACQQB,["QQ(Mac)",n.MACQQB_VERSION]],[n.IS_IPADQQB,["QQ(iPad)",n.IPADQQB_VERSION]],[n.IS_MIBROWSER,["MI",n.MI_VERSION]],[n.IS_HUAWEIBROWSER,["HW",n.HUAWEI_VERSION]],[n.IS_SAMSUNGBROWSER,["Samsung",n.SAMSUNG_VERSION]],[n.IS_OPPOBROWSER,["OPPO",n.OPPO_VERSION]],[n.IS_VIVOBROWSER,["VIVO",n.VIVO_VERSION]],[n.IS_EDGE,["EDGE",n.EDGE_VERSION]],[n.IS_SOGOUM,["SogouMobile",n.SOGOUM_VERSION]],[n.IS_SOGOU,["Sogou",n.SOGOU_VERSION]],[n.IS_ELECTRON,["Electron",n.ELECTRON_VERSION]]]);e.getBrowserInfo=function(){let d="unknown",u="unknown";return s.get(!0)&&(d=s.get(!0)[0],u=s.get(!0)[1]),{browserName:d,browserVersion:u}}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.InvalidStateError=e.UnsupportedError=void 0;class i extends Error{constructor(n){super(n),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,i):this.stack=new Error(n).stack}}e.UnsupportedError=i;class a extends Error{constructor(n){super(n),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,a):this.stack=new Error(n).stack}}e.InvalidStateError=a},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(R,w,k,I){I===void 0&&(I=k),Object.defineProperty(R,I,{enumerable:!0,get:function(){return w[k]}})}:function(R,w,k,I){I===void 0&&(I=k),R[I]=w[k]}),a=this&&this.__setModuleDefault||(Object.create?function(R,w){Object.defineProperty(R,"default",{enumerable:!0,value:w})}:function(R,w){R.default=w}),l=this&&this.__importStar||function(R){if(R&&R.__esModule)return R;var w={};if(R!=null)for(var k in R)k!=="default"&&Object.prototype.hasOwnProperty.call(R,k)&&i(w,R,k);return a(w,R),w};Object.defineProperty(e,"__esModule",{value:!0}),e.canReceive=e.canSend=e.generateProbatorRtpParameters=e.reduceCodecs=e.getSendingRemoteRtpParameters=e.getSendingRtpParameters=e.getRecvRtpCapabilities=e.getExtendedRtpCapabilities=e.validateSctpStreamParameters=e.validateSctpParameters=e.validateNumSctpStreams=e.validateSctpCapabilities=e.validateRtcpParameters=e.validateRtpEncodingParameters=e.validateRtpHeaderExtensionParameters=e.validateRtpCodecParameters=e.validateRtpParameters=e.validateRtpHeaderExtension=e.validateRtcpFeedback=e.validateRtpCodecCapability=e.validateRtpCapabilities=void 0;const n=l(r(225)),c=l(r(27));function s(R){const w=new RegExp("^(audio|video)/(.+)","i");if(typeof R!="object")throw new TypeError("codec is not an object");if(!R.mimeType||typeof R.mimeType!="string")throw new TypeError("missing codec.mimeType");const k=w.exec(R.mimeType);if(!k)throw new TypeError("invalid codec.mimeType");if(R.kind=k[1].toLowerCase(),R.preferredPayloadType&&typeof R.preferredPayloadType!="number")throw new TypeError("invalid codec.preferredPayloadType");if(typeof R.clockRate!="number")throw new TypeError("missing codec.clockRate");R.kind==="audio"?typeof R.channels!="number"&&(R.channels=1):delete R.channels,R.parameters&&typeof R.parameters=="object"||(R.parameters={});for(const I of Object.keys(R.parameters)){let M=R.parameters[I];if(M===void 0&&(R.parameters[I]="",M=""),typeof M!="string"&&typeof M!="number")throw new TypeError(`invalid codec parameter [key:${I}s, value:${M}]`);if(I==="apt"&&typeof M!="number")throw new TypeError("invalid codec apt parameter")}R.rtcpFeedback&&Array.isArray(R.rtcpFeedback)||(R.rtcpFeedback=[]);for(const I of R.rtcpFeedback)d(I)}function d(R){if(typeof R!="object")throw new TypeError("fb is not an object");if(!R.type||typeof R.type!="string")throw new TypeError("missing fb.type");R.parameter&&typeof R.parameter=="string"||(R.parameter="")}function u(R){if(typeof R!="object")throw new TypeError("ext is not an object");if(R.kind&&typeof R.kind=="string"||(R.kind=""),R.kind!==""&&R.kind!=="audio"&&R.kind!=="video")throw new TypeError("invalid ext.kind");if(!R.uri||typeof R.uri!="string")throw new TypeError("missing ext.uri");if(typeof R.preferredId!="number")throw new TypeError("missing ext.preferredId");if(R.preferredEncrypt&&typeof R.preferredEncrypt!="boolean")throw new TypeError("invalid ext.preferredEncrypt");if(R.preferredEncrypt||(R.preferredEncrypt=!1),R.direction&&typeof R.direction!="string")throw new TypeError("invalid ext.direction");R.direction||(R.direction="sendrecv")}function h(R){if(typeof R!="object")throw new TypeError("params is not an object");if(R.mid&&typeof R.mid!="string")throw new TypeError("params.mid is not a string");if(!Array.isArray(R.codecs))throw new TypeError("missing params.codecs");for(const w of R.codecs)o(w);if(R.headerExtensions&&!Array.isArray(R.headerExtensions))throw new TypeError("params.headerExtensions is not an array");R.headerExtensions||(R.headerExtensions=[]);for(const w of R.headerExtensions)f(w);if(R.encodings&&!Array.isArray(R.encodings))throw new TypeError("params.encodings is not an array");R.encodings||(R.encodings=[]);for(const w of R.encodings)m(w);if(R.rtcp&&typeof R.rtcp!="object")throw new TypeError("params.rtcp is not an object");R.rtcp||(R.rtcp={}),g(R.rtcp)}function o(R){const w=new RegExp("^(audio|video)/(.+)","i");if(typeof R!="object")throw new TypeError("codec is not an object");if(!R.mimeType||typeof R.mimeType!="string")throw new TypeError("missing codec.mimeType");const k=w.exec(R.mimeType);if(!k)throw new TypeError("invalid codec.mimeType");if(typeof R.payloadType!="number")throw new TypeError("missing codec.payloadType");if(typeof R.clockRate!="number")throw new TypeError("missing codec.clockRate");k[1].toLowerCase()==="audio"?typeof R.channels!="number"&&(R.channels=1):delete R.channels,R.parameters&&typeof R.parameters=="object"||(R.parameters={});for(const I of Object.keys(R.parameters)){let M=R.parameters[I];if(M===void 0&&(R.parameters[I]="",M=""),typeof M!="string"&&typeof M!="number")throw new TypeError(`invalid codec parameter [key:${I}s, value:${M}]`);if(I==="apt"&&typeof M!="number")throw new TypeError("invalid codec apt parameter")}R.rtcpFeedback&&Array.isArray(R.rtcpFeedback)||(R.rtcpFeedback=[]);for(const I of R.rtcpFeedback)d(I)}function f(R){if(typeof R!="object")throw new TypeError("ext is not an object");if(!R.uri||typeof R.uri!="string")throw new TypeError("missing ext.uri");if(typeof R.id!="number")throw new TypeError("missing ext.id");if(R.encrypt&&typeof R.encrypt!="boolean")throw new TypeError("invalid ext.encrypt");R.encrypt||(R.encrypt=!1),R.parameters&&typeof R.parameters=="object"||(R.parameters={});for(const w of Object.keys(R.parameters)){let k=R.parameters[w];if(k===void 0&&(R.parameters[w]="",k=""),typeof k!="string"&&typeof k!="number")throw new TypeError("invalid header extension parameter")}}function m(R){if(typeof R!="object")throw new TypeError("encoding is not an object");if(R.ssrc&&typeof R.ssrc!="number")throw new TypeError("invalid encoding.ssrc");if(R.rid&&typeof R.rid!="string")throw new TypeError("invalid encoding.rid");if(R.rtx&&typeof R.rtx!="object")throw new TypeError("invalid encoding.rtx");if(R.rtx&&typeof R.rtx.ssrc!="number")throw new TypeError("missing encoding.rtx.ssrc");if(R.dtx&&typeof R.dtx=="boolean"||(R.dtx=!1),R.scalabilityMode&&typeof R.scalabilityMode!="string")throw new TypeError("invalid encoding.scalabilityMode")}function g(R){if(typeof R!="object")throw new TypeError("rtcp is not an object");if(R.cname&&typeof R.cname!="string")throw new TypeError("invalid rtcp.cname");R.reducedSize&&typeof R.reducedSize=="boolean"||(R.reducedSize=!0)}function v(R){if(typeof R!="object")throw new TypeError("numStreams is not an object");if(typeof R.OS!="number")throw new TypeError("missing numStreams.OS");if(typeof R.MIS!="number")throw new TypeError("missing numStreams.MIS")}function O(R){return!!R&&/.+\/rtx$/i.test(R.mimeType)}function T(R,w,{strict:k=!1,modify:I=!1}={}){const M=R.mimeType.toLowerCase();if(M!==w.mimeType.toLowerCase()||R.clockRate!==w.clockRate||R.channels!==w.channels)return!1;switch(M){case"video/h265":case"video/vp9":case"video/av1":return!1;case"video/h264":if((R.parameters["packetization-mode"]||0)!==(w.parameters["packetization-mode"]||0))return!1;if(k){if(!n.isSameProfile(R.parameters,w.parameters))return!1;let P;try{P=n.generateProfileLevelIdForAnswer(R.parameters,w.parameters)}catch{return!1}I&&(P?R.parameters["profile-level-id"]=P:delete R.parameters["profile-level-id"])}break}return!0}function C(R,w){return(!R.kind||!w.kind||R.kind===w.kind)&&R.uri===w.uri}function A(R,w){const k=[];for(const I of R.rtcpFeedback||[]){const M=(w.rtcpFeedback||[]).find(P=>P.type===I.type&&(P.parameter===I.parameter||!P.parameter&&!I.parameter));M&&k.push(M)}return k}e.validateRtpCapabilities=function(R){if(typeof R!="object")throw new TypeError("caps is not an object");if(R.codecs&&!Array.isArray(R.codecs))throw new TypeError("caps.codecs is not an array");R.codecs||(R.codecs=[]);for(const w of R.codecs)s(w);if(R.headerExtensions&&!Array.isArray(R.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");R.headerExtensions||(R.headerExtensions=[]);for(const w of R.headerExtensions)u(w)},e.validateRtpCodecCapability=s,e.validateRtcpFeedback=d,e.validateRtpHeaderExtension=u,e.validateRtpParameters=h,e.validateRtpCodecParameters=o,e.validateRtpHeaderExtensionParameters=f,e.validateRtpEncodingParameters=m,e.validateRtcpParameters=g,e.validateSctpCapabilities=function(R){if(typeof R!="object")throw new TypeError("caps is not an object");if(!R.numStreams||typeof R.numStreams!="object")throw new TypeError("missing caps.numStreams");v(R.numStreams)},e.validateNumSctpStreams=v,e.validateSctpParameters=function(R){if(typeof R!="object")throw new TypeError("params is not an object");if(typeof R.port!="number")throw new TypeError("missing params.port");if(typeof R.OS!="number")throw new TypeError("missing params.OS");if(typeof R.MIS!="number")throw new TypeError("missing params.MIS");if(typeof R.maxMessageSize!="number")throw new TypeError("missing params.maxMessageSize")},e.validateSctpStreamParameters=function(R){if(typeof R!="object")throw new TypeError("params is not an object");if(typeof R.streamId!="number")throw new TypeError("missing params.streamId");let w=!1;if(typeof R.ordered=="boolean"?w=!0:R.ordered=!0,R.maxPacketLifeTime&&typeof R.maxPacketLifeTime!="number")throw new TypeError("invalid params.maxPacketLifeTime");if(R.maxRetransmits&&typeof R.maxRetransmits!="number")throw new TypeError("invalid params.maxRetransmits");if(R.maxPacketLifeTime&&R.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(w&&R.ordered&&(R.maxPacketLifeTime||R.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(w||!R.maxPacketLifeTime&&!R.maxRetransmits||(R.ordered=!1),R.label&&typeof R.label!="string")throw new TypeError("invalid params.label");if(R.protocol&&typeof R.protocol!="string")throw new TypeError("invalid params.protocol")},e.getExtendedRtpCapabilities=function(R,w){const k={codecs:[],headerExtensions:[]};for(const I of w.codecs||[]){if(O(I))continue;const M=(R.codecs||[]).find(S=>T(S,I,{strict:!0,modify:!0}));if(!M)continue;const P={mimeType:M.mimeType,kind:M.kind,clockRate:M.clockRate,channels:M.channels,localPayloadType:M.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:I.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:M.parameters,remoteParameters:I.parameters,rtcpFeedback:A(M,I)};k.codecs.push(P)}for(const I of k.codecs){const M=R.codecs.find(S=>O(S)&&S.parameters.apt===I.localPayloadType),P=w.codecs.find(S=>O(S)&&S.parameters.apt===I.remotePayloadType);M&&P&&(I.localRtxPayloadType=M.preferredPayloadType,I.remoteRtxPayloadType=P.preferredPayloadType)}for(const I of w.headerExtensions){const M=R.headerExtensions.find(S=>C(S,I));if(!M)continue;const P={kind:I.kind,uri:I.uri,sendId:M.preferredId,recvId:I.preferredId,encrypt:M.preferredEncrypt,direction:"sendrecv"};switch(I.direction){case"sendrecv":P.direction="sendrecv";break;case"recvonly":P.direction="sendonly";break;case"sendonly":P.direction="recvonly";break;case"inactive":P.direction="inactive"}k.headerExtensions.push(P)}return k},e.getRecvRtpCapabilities=function(R){const w={codecs:[],headerExtensions:[]};for(const k of R.codecs){const I={mimeType:k.mimeType,kind:k.kind,preferredPayloadType:k.localPayloadType,clockRate:k.clockRate,channels:k.channels,parameters:k.localParameters,rtcpFeedback:k.rtcpFeedback};if(w.codecs.push(I),!k.localRtxPayloadType)continue;const M={mimeType:k.kind+"/rtx",kind:k.kind,preferredPayloadType:k.localRtxPayloadType,clockRate:k.clockRate,parameters:{apt:k.localPayloadType},rtcpFeedback:[]};w.codecs.push(M)}for(const k of R.headerExtensions){if(k.direction!=="sendrecv"&&k.direction!=="recvonly")continue;const I={kind:k.kind,uri:k.uri,preferredId:k.sendId,preferredEncrypt:k.encrypt,direction:k.direction};w.headerExtensions.push(I)}return w},e.getSendingRtpParameters=function(R,w){const k={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const I of w.codecs){if(I.kind!==R)continue;const M={mimeType:I.mimeType,payloadType:I.localPayloadType,clockRate:I.clockRate,channels:I.channels,parameters:I.localParameters,rtcpFeedback:I.rtcpFeedback};if(k.codecs.push(M),I.localRtxPayloadType){const P={mimeType:I.kind+"/rtx",payloadType:I.localRtxPayloadType,clockRate:I.clockRate,parameters:{apt:I.localPayloadType},rtcpFeedback:[]};k.codecs.push(P)}}for(const I of w.headerExtensions){if(I.kind&&I.kind!==R||I.direction!=="sendrecv"&&I.direction!=="sendonly")continue;const M={uri:I.uri,id:I.sendId,encrypt:I.encrypt,parameters:{}};k.headerExtensions.push(M)}return k},e.getSendingRemoteRtpParameters=function(R,w){const k={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const I of w.codecs){if(I.kind!==R)continue;const M={mimeType:I.mimeType,payloadType:I.localPayloadType,clockRate:I.clockRate,channels:I.channels,parameters:I.remoteParameters,rtcpFeedback:I.rtcpFeedback};if(k.codecs.push(M),I.localRtxPayloadType){const P={mimeType:I.kind+"/rtx",payloadType:I.localRtxPayloadType,clockRate:I.clockRate,parameters:{apt:I.localPayloadType},rtcpFeedback:[]};k.codecs.push(P)}}for(const I of w.headerExtensions){if(I.kind&&I.kind!==R||I.direction!=="sendrecv"&&I.direction!=="sendonly")continue;const M={uri:I.uri,id:I.sendId,encrypt:I.encrypt,parameters:{}};k.headerExtensions.push(M)}return k},e.reduceCodecs=function(R,w){const k=[];if(w){for(let I=0;I<R.length;++I)if(T(R[I],w)){k.push(R[I]),O(R[I+1])&&k.push(R[I+1]);break}if(k.length===0)throw new TypeError("no matching codec found")}else k.push(R[0]),O(R[1])&&k.push(R[1]);return k},e.generateProbatorRtpParameters=function(R,w){h(R=c.clone(R,{}));const k={mid:"probator",codecs:[],headerExtensions:[],encodings:[{ssrc:w}],rtcp:{cname:"probator"}};return k.codecs.push(R.codecs[0]),k.codecs[0].payloadType=127,k.headerExtensions=R.headerExtensions,k},e.canSend=function(R,w){return w.codecs.some(k=>k.kind===R)},e.canReceive=function(R,w){if(h(R),R.codecs.length===0)return!1;for(let k in R.codecs)if(R.codecs[k].mimeType!=="video/rtx"){for(let I in w.codecs)if(w.codecs[I].localPayloadType===R.codecs[k].payloadType)return!0}return!1}},function(t,e){var r,i,a=t.exports={};function l(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}function c(v){if(r===setTimeout)return setTimeout(v,0);if((r===l||!r)&&setTimeout)return r=setTimeout,setTimeout(v,0);try{return r(v,0)}catch{try{return r.call(null,v,0)}catch{return r.call(this,v,0)}}}(function(){try{r=typeof setTimeout=="function"?setTimeout:l}catch{r=l}try{i=typeof clearTimeout=="function"?clearTimeout:n}catch{i=n}})();var s,d=[],u=!1,h=-1;function o(){u&&s&&(u=!1,s.length?d=s.concat(d):h=-1,d.length&&f())}function f(){if(!u){var v=c(o);u=!0;for(var O=d.length;O;){for(s=d,d=[];++h<O;)s&&s[h].run();h=-1,O=d.length}s=null,u=!1,function(T){if(i===clearTimeout)return clearTimeout(T);if((i===n||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(T);try{i(T)}catch{try{return i.call(null,T)}catch{return i.call(this,T)}}}(v)}}function m(v,O){this.fun=v,this.array=O}function g(){}a.nextTick=function(v){var O=new Array(arguments.length-1);if(arguments.length>1)for(var T=1;T<arguments.length;T++)O[T-1]=arguments[T];d.push(new m(v,O)),d.length!==1||u||c(f)},m.prototype.run=function(){this.fun.apply(null,this.array)},a.title="browser",a.browser=!0,a.env={},a.argv=[],a.version="",a.versions={},a.on=g,a.addListener=g,a.once=g,a.off=g,a.removeListener=g,a.removeAllListeners=g,a.emit=g,a.prependListener=g,a.prependOnceListener=g,a.listeners=function(v){return[]},a.binding=function(v){throw new Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function(v){throw new Error("process.chdir is not supported")},a.umask=function(){return 0}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.JSONBigStringify=e.JSONBigParse=void 0;const i=r(254),a=r(255);e.JSONBigParse=a.JSONParse(),e.JSONBigStringify=i.stringify},function(t,e,r){t.exports=l,l.className="ReflectionObject";var i,a=r(19);function l(n,c){if(!a.isString(n))throw TypeError("name must be a string");if(c&&!a.isObject(c))throw TypeError("options must be an object");this.options=c,this.parsedOptions=null,this.name=n,this.parent=null,this.resolved=!1,this.comment=null,this.filename=null}Object.defineProperties(l.prototype,{root:{get:function(){for(var n=this;n.parent!==null;)n=n.parent;return n}},fullName:{get:function(){for(var n=[this.name],c=this.parent;c;)n.unshift(c.name),c=c.parent;return n.join(".")}}}),l.prototype.toJSON=function(){throw Error()},l.prototype.onAdd=function(n){this.parent&&this.parent!==n&&this.parent.remove(this),this.parent=n,this.resolved=!1;var c=n.root;c instanceof i&&c._handleAdd(this)},l.prototype.onRemove=function(n){var c=n.root;c instanceof i&&c._handleRemove(this),this.parent=null,this.resolved=!1},l.prototype.resolve=function(){return this.resolved||this.root instanceof i&&(this.resolved=!0),this},l.prototype.getOption=function(n){if(this.options)return this.options[n]},l.prototype.setOption=function(n,c,s){return s&&this.options&&this.options[n]!==void 0||((this.options||(this.options={}))[n]=c),this},l.prototype.setParsedOption=function(n,c,s){this.parsedOptions||(this.parsedOptions=[]);var d=this.parsedOptions;if(s){var u=d.find(function(f){return Object.prototype.hasOwnProperty.call(f,n)});if(u){var h=u[n];a.setProperty(h,s,c)}else(u={})[n]=a.setProperty({},s,c),d.push(u)}else{var o={};o[n]=c,d.push(o)}return this},l.prototype.setOptions=function(n,c){if(n)for(var s=Object.keys(n),d=0;d<s.length;++d)this.setOption(s[d],n[s[d]],c);return this},l.prototype.toString=function(){var n=this.constructor.className,c=this.fullName;return c.length?n+" "+c:n},l._configure=function(n){i=n}},function(t,e,r){t.exports=d;var i=r(82);((d.prototype=Object.create(i.prototype)).constructor=d).className="Field";var a,l=r(45),n=r(92),c=r(19),s=/^required|optional|repeated$/;function d(u,h,o,f,m,g,v){if(c.isObject(f)?(v=m,g=f,f=m=void 0):c.isObject(m)&&(v=g,g=m,m=void 0),i.call(this,u,g),!c.isInteger(h)||h<0)throw TypeError("id must be a non-negative integer");if(!c.isString(o))throw TypeError("type must be a string");if(f!==void 0&&!s.test(f=f.toString().toLowerCase()))throw TypeError("rule must be a string rule");if(m!==void 0&&!c.isString(m))throw TypeError("extend must be a string");f==="proto3_optional"&&(f="optional"),this.rule=f&&f!=="optional"?f:void 0,this.type=o,this.id=h,this.extend=m||void 0,this.required=f==="required",this.optional=!this.required,this.repeated=f==="repeated",this.map=!1,this.message=null,this.partOf=null,this.typeDefault=null,this.defaultValue=null,this.long=!!c.Long&&n.long[o]!==void 0,this.bytes=o==="bytes",this.resolvedType=null,this.extensionField=null,this.declaringField=null,this._packed=null,this.comment=v}d.fromJSON=function(u,h){return new d(u,h.id,h.type,h.rule,h.extend,h.options,h.comment)},Object.defineProperty(d.prototype,"packed",{get:function(){return this._packed===null&&(this._packed=this.getOption("packed")!==!1),this._packed}}),d.prototype.setOption=function(u,h,o){return u==="packed"&&(this._packed=null),i.prototype.setOption.call(this,u,h,o)},d.prototype.toJSON=function(u){var h=!!u&&!!u.keepComments;return c.toObject(["rule",this.rule!=="optional"&&this.rule||void 0,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",h?this.comment:void 0])},d.prototype.resolve=function(){if(this.resolved)return this;if((this.typeDefault=n.defaults[this.type])===void 0&&(this.resolvedType=(this.declaringField?this.declaringField.parent:this.parent).lookupTypeOrEnum(this.type),this.resolvedType instanceof a?this.typeDefault=null:this.typeDefault=this.resolvedType.values[Object.keys(this.resolvedType.values)[0]]),this.options&&this.options.default!=null&&(this.typeDefault=this.options.default,this.resolvedType instanceof l&&typeof this.typeDefault=="string"&&(this.typeDefault=this.resolvedType.values[this.typeDefault])),this.options&&(this.options.packed!==!0&&(this.options.packed===void 0||!this.resolvedType||this.resolvedType instanceof l)||delete this.options.packed,Object.keys(this.options).length||(this.options=void 0)),this.long)this.typeDefault=c.Long.fromNumber(this.typeDefault,this.type.charAt(0)==="u"),Object.freeze&&Object.freeze(this.typeDefault);else if(this.bytes&&typeof this.typeDefault=="string"){var u;c.base64.test(this.typeDefault)?c.base64.decode(this.typeDefault,u=c.newBuffer(c.base64.length(this.typeDefault)),0):c.utf8.write(this.typeDefault,u=c.newBuffer(c.utf8.length(this.typeDefault)),0),this.typeDefault=u}return this.map?this.defaultValue=c.emptyObject:this.repeated?this.defaultValue=c.emptyArray:this.defaultValue=this.typeDefault,this.parent instanceof a&&(this.parent.ctor.prototype[this.name]=this.defaultValue),i.prototype.resolve.call(this)},d.d=function(u,h,o,f){return typeof h=="function"?h=c.decorateType(h).name:h&&typeof h=="object"&&(h=c.decorateEnum(h).name),function(m,g){c.decorateType(m.constructor).add(new d(g,u,h,o,{default:f}))}},d._configure=function(u){a=u}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.loglevelMap=e.loglevels=void 0,function(i){i[i.DEBUG=0]="DEBUG",i[i.INFO=1]="INFO",i[i.WARNING=2]="WARNING",i[i.ERROR=3]="ERROR",i[i.NONE=4]="NONE"}(e.loglevels||(e.loglevels={})),e.loglevelMap={0:"DEBUG",1:"INFO",2:"WARNING",3:"ERROR",4:"NONE"}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.getWebGLContext=e.get2DContext=void 0;const i=r(1);e.get2DContext=function(a,l){return i.getParameters().disable2dContext?null:a.getContext("2d",l)},e.getWebGLContext=function(a,l){return i.getParameters().disableWebGLContext?null:a.getContext("webgl",l)}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.EnhancedEventEmitter=void 0;const i=r(169),a=r(29),l="EnhancedEventEmitter";class n extends i.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}safeEmit(s,...d){const u=this.listenerCount(s);try{return this.emit(s,...d)}catch(h){return a.Logger.error(l,"safeEmit() | event listener threw an error [event:%s]:%o",s,h),!!u}}async safeEmitAsPromise(s,...d){return new Promise((u,h)=>{try{this.emit(s,...d,u,h)}catch(o){a.Logger.error(l,"safeEmitAsPromise() | event listener threw an error [event:%s]:%o",s,o),h(o)}})}}e.EnhancedEventEmitter=n},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.HandlerInterface=void 0;const i=r(86);class a extends i.EnhancedEventEmitter{constructor(){super()}}e.HandlerInterface=a},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(u,h,o,f){f===void 0&&(f=o),Object.defineProperty(u,f,{enumerable:!0,get:function(){return h[o]}})}:function(u,h,o,f){f===void 0&&(f=o),u[f]=h[o]}),a=this&&this.__setModuleDefault||(Object.create?function(u,h){Object.defineProperty(u,"default",{enumerable:!0,value:h})}:function(u,h){u.default=h}),l=this&&this.__importStar||function(u){if(u&&u.__esModule)return u;var h={};if(u!=null)for(var o in u)o!=="default"&&Object.prototype.hasOwnProperty.call(u,o)&&i(h,u,o);return a(h,u),h},n=this&&this.__importDefault||function(u){return u&&u.__esModule?u:{default:u}};Object.defineProperty(e,"__esModule",{value:!0}),e.applyCodecParameters=e.getCname=e.extractDtlsParameters=e.extractRtpCapabilities=void 0;const c=l(r(50)),s=n(r(6)),d=n(r(8));e.extractRtpCapabilities=function({sdpObject:u}){const h=new Map,o=[];let f=!1,m=!1;for(const g of u.media){const v=g.type;switch(v){case"audio":if(f)continue;f=!0;break;case"video":if(m)continue;m=!0;break;default:continue}for(const O of g.rtp){const T={kind:v,mimeType:`${v}/${O.codec}`,preferredPayloadType:O.payload,clockRate:O.rate,channels:O.encoding,parameters:{},rtcpFeedback:[]};h.set(T.preferredPayloadType,T)}for(const O of g.fmtp||[]){const T=c.parseParams(O.config),C=h.get(O.payload);C&&(T&&T.hasOwnProperty("profile-level-id")&&(T["profile-level-id"]=String(T["profile-level-id"])),C.parameters=T)}for(const O of g.rtcpFb||[]){const T=h.get(O.payload);if(!T)continue;const C={type:O.type,parameter:O.subtype};C.parameter||delete C.parameter,T.rtcpFeedback.push(C)}for(const O of g.ext||[]){if(O["encrypt-uri"])continue;const T={kind:v,uri:O.uri,preferredId:O.value};o.push(T)}}return{codecs:Array.from(h.values()),headerExtensions:o}},e.extractDtlsParameters=function({sdpObject:u}){const h=(u.media||[]).find(m=>m.iceUfrag&&m.port!==0);if(!h)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"extractDtlsParameters: active media 未找到"});const o=h.fingerprint||u.fingerprint;let f;switch(h.setup){case"active":f="client";break;case"passive":f="server";break;case"actpass":f="auto"}return{role:f,fingerprints:[{algorithm:o.type,value:o.hash}]}},e.getCname=function({offerMediaObject:u}){const h=(u.ssrcs||[]).find(o=>o.attribute==="cname");return h?h.value:""},e.applyCodecParameters=function({offerRtpParameters:u,answerMediaObject:h}){for(const o of u.codecs){const f=o.mimeType.toLowerCase();if(f!=="audio/opus"||!(h.rtp||[]).find(v=>v.payload===o.payloadType))continue;h.fmtp=h.fmtp||[];let m=h.fmtp.find(v=>v.payload===o.payloadType);m||(m={payload:o.payloadType,config:""},h.fmtp.push(m));const g=c.parseParams(m.config);switch(f){case"audio/opus":{const v=o.parameters["sprop-stereo"];v!==void 0&&(g.stereo=v?1:0);break}}m.config="";for(const v of Object.keys(g))m.config&&(m.config+=";"),m.config+=`${v}=${g[v]}`}}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.filterRembFromRtpParameters=e.filterTransportCCFromSdp=e.filterTransportCCFromRtpParameters=void 0,e.filterTransportCCFromRtpParameters=function(i){if(i.headerExtensions)for(let a=i.headerExtensions.length-1;a>=0;a--)i.headerExtensions[a].uri.indexOf("transport-wide-cc")>-1&&i.headerExtensions.splice(a,1);for(let a=i.codecs.length-1;a>=0;a--){const l=i.codecs[a];if(l.rtcpFeedback)for(let n=l.rtcpFeedback.length-1;n>=0;n--)l.rtcpFeedback[n].type==="transport-cc"&&l.rtcpFeedback.splice(n,1)}},e.filterTransportCCFromSdp=function(i){for(let a in i.media){const l=i.media[a];if(l.ext)for(let n=l.ext.length-1;n>=0;n--)l.ext[n].uri.indexOf("transport-wide-cc")>-1&&l.ext.splice(n,1);if(l.rtcpFb)for(let n=l.rtcpFb.length-1;n>=0;n--)l.rtcpFb[n].type==="transport-cc"&&l.rtcpFb.splice(n,1)}},e.filterRembFromRtpParameters=function(i){if(i.headerExtensions)for(let a=i.headerExtensions.length-1;a>=0;a--)i.headerExtensions[a].uri.indexOf("abs-send-time")>-1&&i.headerExtensions.splice(a,1);for(let a=i.codecs.length-1;a>=0;a--){const l=i.codecs[a];if(l.rtcpFeedback)for(let n=l.rtcpFeedback.length-1;n>=0;n--)l.rtcpFeedback[n].type==="goog-remb"&&l.rtcpFeedback.splice(n,1)}}},function(t,e,r){var i=this&&this.__importDefault||function(u){return u&&u.__esModule?u:{default:u}};Object.defineProperty(e,"__esModule",{value:!0}),e.getBlobUrl=void 0;const a=i(r(246)),l=i(r(247)),n=i(r(248)),c=i(r(249)),s=i(r(250)),d={volumeProcessor:{blobParts:[n.default],options:{type:"text/javascript; charset=utf-8"},url:""},webWorkerTimer:{blobParts:[c.default],options:{type:"text/javascript; charset=utf-8"},url:""},audioAIProcessor:{blobParts:[s.default],options:{type:"text/javascript; charset=utf-8"},url:""},signalProbeWorker:{blobParts:[l.default],options:{type:"text/js-worker"},url:""},rtcTimer:{blobParts:[a.default],options:{type:"text/js-worker"},url:""}};e.getBlobUrl=function(u){if(!d[u].url){const h=new Blob(d[u].blobParts,d[u].options);d[u].url=window.URL.createObjectURL(h)}return d[u].url}},function(t,e,r){t.exports=h;var i=r(82);((h.prototype=Object.create(i.prototype)).constructor=h).className="Namespace";var a,l,n,c=r(83),s=r(141),d=r(19);function u(f,m){if(f&&f.length){for(var g={},v=0;v<f.length;++v)g[f[v].name]=f[v].toJSON(m);return g}}function h(f,m){i.call(this,f,m),this.nested=void 0,this._nestedArray=null}function o(f){return f._nestedArray=null,f}h.fromJSON=function(f,m){return new h(f,m.options).addJSON(m.nested)},h.arrayToJSON=u,h.isReservedId=function(f,m){if(f){for(var g=0;g<f.length;++g)if(typeof f[g]!="string"&&f[g][0]<=m&&f[g][1]>m)return!0}return!1},h.isReservedName=function(f,m){if(f){for(var g=0;g<f.length;++g)if(f[g]===m)return!0}return!1},Object.defineProperty(h.prototype,"nestedArray",{get:function(){return this._nestedArray||(this._nestedArray=d.toArray(this.nested))}}),h.prototype.toJSON=function(f){return d.toObject(["options",this.options,"nested",u(this.nestedArray,f)])},h.prototype.addJSON=function(f){if(f)for(var m,g=Object.keys(f),v=0;v<g.length;++v)m=f[g[v]],this.add((m.fields!==void 0?a.fromJSON:m.values!==void 0?n.fromJSON:m.methods!==void 0?l.fromJSON:m.id!==void 0?c.fromJSON:h.fromJSON)(g[v],m));return this},h.prototype.get=function(f){return this.nested&&this.nested[f]||null},h.prototype.getEnum=function(f){if(this.nested&&this.nested[f]instanceof n)return this.nested[f].values;throw Error("no such enum: "+f)},h.prototype.add=function(f){if(!(f instanceof c&&f.extend!==void 0||f instanceof a||f instanceof n||f instanceof l||f instanceof h||f instanceof s))throw TypeError("object must be a valid nested object");if(this.nested){var m=this.get(f.name);if(m){if(!(m instanceof h&&f instanceof h)||m instanceof a||m instanceof l)throw Error("duplicate name '"+f.name+"' in "+this);for(var g=m.nestedArray,v=0;v<g.length;++v)f.add(g[v]);this.remove(m),this.nested||(this.nested={}),f.setOptions(m.options,!0)}}else this.nested={};return this.nested[f.name]=f,f.onAdd(this),o(this)},h.prototype.remove=function(f){if(!(f instanceof i))throw TypeError("object must be a ReflectionObject");if(f.parent!==this)throw Error(f+" is not a member of "+this);return delete this.nested[f.name],Object.keys(this.nested).length||(this.nested=void 0),f.onRemove(this),o(this)},h.prototype.define=function(f,m){if(d.isString(f))f=f.split(".");else if(!Array.isArray(f))throw TypeError("illegal path");if(f&&f.length&&f[0]==="")throw Error("path must be relative");for(var g=this;f.length>0;){var v=f.shift();if(g.nested&&g.nested[v]){if(!((g=g.nested[v])instanceof h))throw Error("path conflicts with non-namespace objects")}else g.add(g=new h(v))}return m&&g.addJSON(m),g},h.prototype.resolveAll=function(){for(var f=this.nestedArray,m=0;m<f.length;)f[m]instanceof h?f[m++].resolveAll():f[m++].resolve();return this.resolve()},h.prototype.lookup=function(f,m,g){if(typeof m=="boolean"?(g=m,m=void 0):m&&!Array.isArray(m)&&(m=[m]),d.isString(f)&&f.length){if(f===".")return this.root;f=f.split(".")}else if(!f.length)return this;if(f[0]==="")return this.root.lookup(f.slice(1),m);var v=this.get(f[0]);if(v){if(f.length===1){if(!m||m.indexOf(v.constructor)>-1)return v}else if(v instanceof h&&(v=v.lookup(f.slice(1),m,!0)))return v}else for(var O=0;O<this.nestedArray.length;++O)if(this._nestedArray[O]instanceof h&&(v=this._nestedArray[O].lookup(f,m,!0)))return v;return this.parent===null||g?null:this.parent.lookup(f,m)},h.prototype.lookupType=function(f){var m=this.lookup(f,[a]);if(!m)throw Error("no such type: "+f);return m},h.prototype.lookupEnum=function(f){var m=this.lookup(f,[n]);if(!m)throw Error("no such Enum '"+f+"' in "+this);return m},h.prototype.lookupTypeOrEnum=function(f){var m=this.lookup(f,[a,n]);if(!m)throw Error("no such Type or Enum '"+f+"' in "+this);return m},h.prototype.lookupService=function(f){var m=this.lookup(f,[l]);if(!m)throw Error("no such Service '"+f+"' in "+this);return m},h._configure=function(f,m,g){a=f,l=m,n=g}},function(t,e,r){var i=e,a=r(19),l=["double","float","int32","uint32","sint32","fixed32","sfixed32","int64","uint64","sint64","fixed64","sfixed64","bool","string","bytes"];function n(c,s){var d=0,u={};for(s|=0;d<c.length;)u[l[d+s]]=c[d++];return u}i.basic=n([1,5,0,0,0,5,5,0,0,0,1,1,0,2,2]),i.defaults=n([0,0,0,0,0,0,0,0,0,0,0,0,!1,"",a.emptyArray,null]),i.long=n([0,0,0,1,1],7),i.mapKey=n([0,0,0,5,5,0,0,0,1,1,0,2],2),i.packed=n([1,5,0,0,0,5,5,0,0,0,1,1,0])},function(t,e,r){var i=function(){return this}()||Function("return this")(),a=i.regeneratorRuntime&&Object.getOwnPropertyNames(i).indexOf("regeneratorRuntime")>=0,l=a&&i.regeneratorRuntime;if(i.regeneratorRuntime=void 0,t.exports=r(94),a)i.regeneratorRuntime=l;else try{delete i.regeneratorRuntime}catch{i.regeneratorRuntime=void 0}},function(t,e){(function(r){var i=Object.prototype,a=i.hasOwnProperty,l=typeof Symbol=="function"?Symbol:{},n=l.iterator||"@@iterator",c=l.asyncIterator||"@@asyncIterator",s=l.toStringTag||"@@toStringTag",d=typeof t=="object",u=r.regeneratorRuntime;if(u)d&&(t.exports=u);else{(u=r.regeneratorRuntime=d?t.exports:{}).wrap=v;var h={},o={};o[n]=function(){return this};var f=Object.getPrototypeOf,m=f&&f(f(S([])));m&&m!==i&&a.call(m,n)&&(o=m);var g=A.prototype=T.prototype=Object.create(o);C.prototype=g.constructor=A,A.constructor=C,A[s]=C.displayName="GeneratorFunction",u.isGeneratorFunction=function(_){var b=typeof _=="function"&&_.constructor;return!!b&&(b===C||(b.displayName||b.name)==="GeneratorFunction")},u.mark=function(_){return Object.setPrototypeOf?Object.setPrototypeOf(_,A):(_.__proto__=A,s in _||(_[s]="GeneratorFunction")),_.prototype=Object.create(g),_},u.awrap=function(_){return{__await:_}},R(w.prototype),w.prototype[c]=function(){return this},u.AsyncIterator=w,u.async=function(_,b,E,x){var D=new w(v(_,b,E,x));return u.isGeneratorFunction(b)?D:D.next().then(function(F){return F.done?F.value:D.next()})},R(g),g[s]="Generator",g[n]=function(){return this},g.toString=function(){return"[object Generator]"},u.keys=function(_){var b=[];for(var E in _)b.push(E);return b.reverse(),function x(){for(;b.length;){var D=b.pop();if(D in _)return x.value=D,x.done=!1,x}return x.done=!0,x}},u.values=S,P.prototype={constructor:P,reset:function(_){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(M),!_)for(var b in this)b.charAt(0)==="t"&&a.call(this,b)&&!isNaN(+b.slice(1))&&(this[b]=void 0)},stop:function(){this.done=!0;var _=this.tryEntries[0].completion;if(_.type==="throw")throw _.arg;return this.rval},dispatchException:function(_){if(this.done)throw _;var b=this;function E(L,U){return F.type="throw",F.arg=_,b.next=L,U&&(b.method="next",b.arg=void 0),!!U}for(var x=this.tryEntries.length-1;x>=0;--x){var D=this.tryEntries[x],F=D.completion;if(D.tryLoc==="root")return E("end");if(D.tryLoc<=this.prev){var V=a.call(D,"catchLoc"),N=a.call(D,"finallyLoc");if(V&&N){if(this.prev<D.catchLoc)return E(D.catchLoc,!0);if(this.prev<D.finallyLoc)return E(D.finallyLoc)}else if(V){if(this.prev<D.catchLoc)return E(D.catchLoc,!0)}else{if(!N)throw new Error("try statement without catch or finally");if(this.prev<D.finallyLoc)return E(D.finallyLoc)}}}},abrupt:function(_,b){for(var E=this.tryEntries.length-1;E>=0;--E){var x=this.tryEntries[E];if(x.tryLoc<=this.prev&&a.call(x,"finallyLoc")&&this.prev<x.finallyLoc){var D=x;break}}D&&(_==="break"||_==="continue")&&D.tryLoc<=b&&b<=D.finallyLoc&&(D=null);var F=D?D.completion:{};return F.type=_,F.arg=b,D?(this.method="next",this.next=D.finallyLoc,h):this.complete(F)},complete:function(_,b){if(_.type==="throw")throw _.arg;return _.type==="break"||_.type==="continue"?this.next=_.arg:_.type==="return"?(this.rval=this.arg=_.arg,this.method="return",this.next="end"):_.type==="normal"&&b&&(this.next=b),h},finish:function(_){for(var b=this.tryEntries.length-1;b>=0;--b){var E=this.tryEntries[b];if(E.finallyLoc===_)return this.complete(E.completion,E.afterLoc),M(E),h}},catch:function(_){for(var b=this.tryEntries.length-1;b>=0;--b){var E=this.tryEntries[b];if(E.tryLoc===_){var x=E.completion;if(x.type==="throw"){var D=x.arg;M(E)}return D}}throw new Error("illegal catch attempt")},delegateYield:function(_,b,E){return this.delegate={iterator:S(_),resultName:b,nextLoc:E},this.method==="next"&&(this.arg=void 0),h}}}function v(_,b,E,x){var D=b&&b.prototype instanceof T?b:T,F=Object.create(D.prototype),V=new P(x||[]);return F._invoke=function(N,L,U){var H="suspendedStart";return function(j,W){if(H==="executing")throw new Error("Generator is already running");if(H==="completed"){if(j==="throw")throw W;return y()}for(U.method=j,U.arg=W;;){var Y=U.delegate;if(Y){var te=k(Y,U);if(te){if(te===h)continue;return te}}if(U.method==="next")U.sent=U._sent=U.arg;else if(U.method==="throw"){if(H==="suspendedStart")throw H="completed",U.arg;U.dispatchException(U.arg)}else U.method==="return"&&U.abrupt("return",U.arg);H="executing";var re=O(N,L,U);if(re.type==="normal"){if(H=U.done?"completed":"suspendedYield",re.arg===h)continue;return{value:re.arg,done:U.done}}re.type==="throw"&&(H="completed",U.method="throw",U.arg=re.arg)}}}(_,E,V),F}function O(_,b,E){try{return{type:"normal",arg:_.call(b,E)}}catch(x){return{type:"throw",arg:x}}}function T(){}function C(){}function A(){}function R(_){["next","throw","return"].forEach(function(b){_[b]=function(E){return this._invoke(b,E)}})}function w(_){var b;this._invoke=function(E,x){function D(){return new Promise(function(F,V){(function N(L,U,H,j){var W=O(_[L],_,U);if(W.type!=="throw"){var Y=W.arg,te=Y.value;return te&&typeof te=="object"&&a.call(te,"__await")?Promise.resolve(te.__await).then(function(re){N("next",re,H,j)},function(re){N("throw",re,H,j)}):Promise.resolve(te).then(function(re){Y.value=re,H(Y)},j)}j(W.arg)})(E,x,F,V)})}return b=b?b.then(D,D):D()}}function k(_,b){var E=_.iterator[b.method];if(E===void 0){if(b.delegate=null,b.method==="throw"){if(_.iterator.return&&(b.method="return",b.arg=void 0,k(_,b),b.method==="throw"))return h;b.method="throw",b.arg=new TypeError("The iterator does not provide a 'throw' method")}return h}var x=O(E,_.iterator,b.arg);if(x.type==="throw")return b.method="throw",b.arg=x.arg,b.delegate=null,h;var D=x.arg;return D?D.done?(b[_.resultName]=D.value,b.next=_.nextLoc,b.method!=="return"&&(b.method="next",b.arg=void 0),b.delegate=null,h):D:(b.method="throw",b.arg=new TypeError("iterator result is not an object"),b.delegate=null,h)}function I(_){var b={tryLoc:_[0]};1 in _&&(b.catchLoc=_[1]),2 in _&&(b.finallyLoc=_[2],b.afterLoc=_[3]),this.tryEntries.push(b)}function M(_){var b=_.completion||{};b.type="normal",delete b.arg,_.completion=b}function P(_){this.tryEntries=[{tryLoc:"root"}],_.forEach(I,this),this.reset(!0)}function S(_){if(_){var b=_[n];if(b)return b.call(_);if(typeof _.next=="function")return _;if(!isNaN(_.length)){var E=-1,x=function D(){for(;++E<_.length;)if(a.call(_,E))return D.value=_[E],D.done=!1,D;return D.value=void 0,D.done=!0,D};return x.next=x}}return{next:y}}function y(){return{value:void 0,done:!0}}})(function(){return this}()||Function("return this")())},function(t,e,r){t.exports={default:r(96),__esModule:!0}},function(t,e,r){r(51),r(52),r(61),r(107),r(119),r(120),t.exports=r(4).Promise},function(t,e,r){var i=r(30),a=r(31);t.exports=function(l){return function(n,c){var s,d,u=String(a(n)),h=i(c),o=u.length;return h<0||h>=o?l?"":void 0:(s=u.charCodeAt(h))<55296||s>56319||h+1===o||(d=u.charCodeAt(h+1))<56320||d>57343?l?u.charAt(h):s:l?u.slice(h,h+2):d-56320+(s-55296<<10)+65536}}},function(t,e,r){var i=r(56),a=r(23),l=r(25),n={};r(9)(n,r(2)("iterator"),function(){return this}),t.exports=function(c,s,d){c.prototype=i(n,{next:a(1,d)}),l(c,s+" Iterator")}},function(t,e,r){var i=r(10),a=r(5),l=r(34);t.exports=r(12)?Object.defineProperties:function(n,c){a(n);for(var s,d=l(c),u=d.length,h=0;u>h;)i.f(n,s=d[h++],c[s]);return n}},function(t,e,r){var i=r(18);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(a){return i(a)=="String"?a.split(""):Object(a)}},function(t,e,r){var i=r(14),a=r(58),l=r(102);t.exports=function(n){return function(c,s,d){var u,h=i(c),o=a(h.length),f=l(d,o);if(n&&s!=s){for(;o>f;)if((u=h[f++])!=u)return!0}else for(;o>f;f++)if((n||f in h)&&h[f]===s)return n||f||0;return!n&&-1}}},function(t,e,r){var i=r(30),a=Math.max,l=Math.min;t.exports=function(n,c){return(n=i(n))<0?a(n+c,0):l(n,c)}},function(t,e,r){var i=r(13),a=r(60),l=r(35)("IE_PROTO"),n=Object.prototype;t.exports=Object.getPrototypeOf||function(c){return c=a(c),i(c,l)?c[l]:typeof c.constructor=="function"&&c instanceof c.constructor?c.constructor.prototype:c instanceof Object?n:null}},function(t,e,r){var i=r(105),a=r(106),l=r(17),n=r(14);t.exports=r(53)(Array,"Array",function(c,s){this._t=n(c),this._i=0,this._k=s},function(){var c=this._t,s=this._k,d=this._i++;return!c||d>=c.length?(this._t=void 0,a(1)):a(0,s=="keys"?d:s=="values"?c[d]:[d,c[d]])},"values"),l.Arguments=l.Array,i("keys"),i("values"),i("entries")},function(t,e){t.exports=function(){}},function(t,e){t.exports=function(r,i){return{value:i,done:!!r}}},function(t,e,r){var i,a,l,n,c=r(15),s=r(0),d=r(20),u=r(62),h=r(16),o=r(11),f=r(21),m=r(108),g=r(109),v=r(63),O=r(64).set,T=r(114)(),C=r(38),A=r(65),R=r(115),w=r(66),k=s.TypeError,I=s.process,M=I&&I.versions,P=M&&M.v8||"",S=s.Promise,y=u(I)=="process",_=function(){},b=a=C.f,E=!!function(){try{var H=S.resolve(1),j=(H.constructor={})[r(2)("species")]=function(W){W(_,_)};return(y||typeof PromiseRejectionEvent=="function")&&H.then(_)instanceof j&&P.indexOf("6.6")!==0&&R.indexOf("Chrome/66")===-1}catch{}}(),x=function(H){var j;return!(!o(H)||typeof(j=H.then)!="function")&&j},D=function(H,j){if(!H._n){H._n=!0;var W=H._c;T(function(){for(var Y=H._v,te=H._s==1,re=0,G=function(K){var de,B,$,z=te?K.ok:K.fail,ie=K.resolve,Z=K.reject,ee=K.domain;try{z?(te||(H._h==2&&N(H),H._h=1),z===!0?de=Y:(ee&&ee.enter(),de=z(Y),ee&&(ee.exit(),$=!0)),de===K.promise?Z(k("Promise-chain cycle")):(B=x(de))?B.call(de,ie,Z):ie(de)):Z(Y)}catch(ce){ee&&!$&&ee.exit(),Z(ce)}};W.length>re;)G(W[re++]);H._c=[],H._n=!1,j&&!H._h&&F(H)})}},F=function(H){O.call(s,function(){var j,W,Y,te=H._v,re=V(H);if(re&&(j=A(function(){y?I.emit("unhandledRejection",te,H):(W=s.onunhandledrejection)?W({promise:H,reason:te}):(Y=s.console)&&Y.error&&Y.error("Unhandled promise rejection",te)}),H._h=y||V(H)?2:1),H._a=void 0,re&&j.e)throw j.v})},V=function(H){return H._h!==1&&(H._a||H._c).length===0},N=function(H){O.call(s,function(){var j;y?I.emit("rejectionHandled",H):(j=s.onrejectionhandled)&&j({promise:H,reason:H._v})})},L=function(H){var j=this;j._d||(j._d=!0,(j=j._w||j)._v=H,j._s=2,j._a||(j._a=j._c.slice()),D(j,!0))},U=function(H){var j,W=this;if(!W._d){W._d=!0,W=W._w||W;try{if(W===H)throw k("Promise can't be resolved itself");(j=x(H))?T(function(){var Y={_w:W,_d:!1};try{j.call(H,d(U,Y,1),d(L,Y,1))}catch(te){L.call(Y,te)}}):(W._v=H,W._s=1,D(W,!1))}catch(Y){L.call({_w:W,_d:!1},Y)}}};E||(S=function(H){m(this,S,"Promise","_h"),f(H),i.call(this);try{H(d(U,this,1),d(L,this,1))}catch(j){L.call(this,j)}},(i=function(H){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1}).prototype=r(116)(S.prototype,{then:function(H,j){var W=b(v(this,S));return W.ok=typeof H!="function"||H,W.fail=typeof j=="function"&&j,W.domain=y?I.domain:void 0,this._c.push(W),this._a&&this._a.push(W),this._s&&D(this,!1),W.promise},catch:function(H){return this.then(void 0,H)}}),l=function(){var H=new i;this.promise=H,this.resolve=d(U,H,1),this.reject=d(L,H,1)},C.f=b=function(H){return H===S||H===n?new l(H):a(H)}),h(h.G+h.W+h.F*!E,{Promise:S}),r(25)(S,"Promise"),r(117)("Promise"),n=r(4).Promise,h(h.S+h.F*!E,"Promise",{reject:function(H){var j=b(this);return(0,j.reject)(H),j.promise}}),h(h.S+h.F*(c||!E),"Promise",{resolve:function(H){return w(c&&this===n?S:this,H)}}),h(h.S+h.F*!(E&&r(118)(function(H){S.all(H).catch(_)})),"Promise",{all:function(H){var j=this,W=b(j),Y=W.resolve,te=W.reject,re=A(function(){var G=[],K=0,de=1;g(H,!1,function(B){var $=K++,z=!1;G.push(void 0),de++,j.resolve(B).then(function(ie){z||(z=!0,G[$]=ie,--de||Y(G))},te)}),--de||Y(G)});return re.e&&te(re.v),W.promise},race:function(H){var j=this,W=b(j),Y=W.reject,te=A(function(){g(H,!1,function(re){j.resolve(re).then(W.resolve,Y)})});return te.e&&Y(te.v),W.promise}})},function(t,e){t.exports=function(r,i,a,l){if(!(r instanceof i)||l!==void 0&&l in r)throw TypeError(a+": incorrect invocation!");return r}},function(t,e,r){var i=r(20),a=r(110),l=r(111),n=r(5),c=r(58),s=r(112),d={},u={};(e=t.exports=function(h,o,f,m,g){var v,O,T,C,A=g?function(){return h}:s(h),R=i(f,m,o?2:1),w=0;if(typeof A!="function")throw TypeError(h+" is not iterable!");if(l(A)){for(v=c(h.length);v>w;w++)if((C=o?R(n(O=h[w])[0],O[1]):R(h[w]))===d||C===u)return C}else for(T=A.call(h);!(O=T.next()).done;)if((C=a(T,R,O.value,o))===d||C===u)return C}).BREAK=d,e.RETURN=u},function(t,e,r){var i=r(5);t.exports=function(a,l,n,c){try{return c?l(i(n)[0],n[1]):l(n)}catch(d){var s=a.return;throw s!==void 0&&i(s.call(a)),d}}},function(t,e,r){var i=r(17),a=r(2)("iterator"),l=Array.prototype;t.exports=function(n){return n!==void 0&&(i.Array===n||l[a]===n)}},function(t,e,r){var i=r(62),a=r(2)("iterator"),l=r(17);t.exports=r(4).getIteratorMethod=function(n){if(n!=null)return n[a]||n["@@iterator"]||l[i(n)]}},function(t,e){t.exports=function(r,i,a){var l=a===void 0;switch(i.length){case 0:return l?r():r.call(a);case 1:return l?r(i[0]):r.call(a,i[0]);case 2:return l?r(i[0],i[1]):r.call(a,i[0],i[1]);case 3:return l?r(i[0],i[1],i[2]):r.call(a,i[0],i[1],i[2]);case 4:return l?r(i[0],i[1],i[2],i[3]):r.call(a,i[0],i[1],i[2],i[3])}return r.apply(a,i)}},function(t,e,r){var i=r(0),a=r(64).set,l=i.MutationObserver||i.WebKitMutationObserver,n=i.process,c=i.Promise,s=r(18)(n)=="process";t.exports=function(){var d,u,h,o=function(){var v,O;for(s&&(v=n.domain)&&v.exit();d;){O=d.fn,d=d.next;try{O()}catch(T){throw d?h():u=void 0,T}}u=void 0,v&&v.enter()};if(s)h=function(){n.nextTick(o)};else if(!l||i.navigator&&i.navigator.standalone)if(c&&c.resolve){var f=c.resolve(void 0);h=function(){f.then(o)}}else h=function(){a.call(i,o)};else{var m=!0,g=document.createTextNode("");new l(o).observe(g,{characterData:!0}),h=function(){g.data=m=!m}}return function(v){var O={fn:v,next:void 0};u&&(u.next=O),d||(d=O,h()),u=O}}},function(t,e,r){var i=r(0).navigator;t.exports=i&&i.userAgent||""},function(t,e,r){var i=r(9);t.exports=function(a,l,n){for(var c in l)n&&a[c]?a[c]=l[c]:i(a,c,l[c]);return a}},function(t,e,r){var i=r(0),a=r(4),l=r(10),n=r(12),c=r(2)("species");t.exports=function(s){var d=typeof a[s]=="function"?a[s]:i[s];n&&d&&!d[c]&&l.f(d,c,{configurable:!0,get:function(){return this}})}},function(t,e,r){var i=r(2)("iterator"),a=!1;try{var l=[7][i]();l.return=function(){a=!0},Array.from(l,function(){throw 2})}catch{}t.exports=function(n,c){if(!c&&!a)return!1;var s=!1;try{var d=[7],u=d[i]();u.next=function(){return{done:s=!0}},d[i]=function(){return u},n(d)}catch{}return s}},function(t,e,r){var i=r(16),a=r(4),l=r(0),n=r(63),c=r(66);i(i.P+i.R,"Promise",{finally:function(s){var d=n(this,a.Promise||l.Promise),u=typeof s=="function";return this.then(u?function(h){return c(d,s()).then(function(){return h})}:s,u?function(h){return c(d,s()).then(function(){throw h})}:s)}})},function(t,e,r){var i=r(16),a=r(38),l=r(65);i(i.S,"Promise",{try:function(n){var c=a.f(this),s=l(n);return(s.e?c.reject:c.resolve)(s.v),c.promise}})},function(t,e,r){e.__esModule=!0;var i=n(r(122)),a=n(r(124)),l=typeof a.default=="function"&&typeof i.default=="symbol"?function(c){return typeof c}:function(c){return c&&typeof a.default=="function"&&c.constructor===a.default&&c!==a.default.prototype?"symbol":typeof c};function n(c){return c&&c.__esModule?c:{default:c}}e.default=typeof a.default=="function"&&l(i.default)==="symbol"?function(c){return c===void 0?"undefined":l(c)}:function(c){return c&&typeof a.default=="function"&&c.constructor===a.default&&c!==a.default.prototype?"symbol":c===void 0?"undefined":l(c)}},function(t,e,r){t.exports={default:r(123),__esModule:!0}},function(t,e,r){r(52),r(61),t.exports=r(39).f("iterator")},function(t,e,r){t.exports={default:r(125),__esModule:!0}},function(t,e,r){r(126),r(51),r(132),r(133),t.exports=r(4).Symbol},function(t,e,r){var i=r(0),a=r(13),l=r(12),n=r(16),c=r(55),s=r(127).KEY,d=r(22),u=r(36),h=r(25),o=r(24),f=r(2),m=r(39),g=r(40),v=r(128),O=r(129),T=r(5),C=r(11),A=r(60),R=r(14),w=r(33),k=r(23),I=r(56),M=r(130),P=r(131),S=r(67),y=r(10),_=r(34),b=P.f,E=y.f,x=M.f,D=i.Symbol,F=i.JSON,V=F&&F.stringify,N=f("_hidden"),L=f("toPrimitive"),U={}.propertyIsEnumerable,H=u("symbol-registry"),j=u("symbols"),W=u("op-symbols"),Y=Object.prototype,te=typeof D=="function"&&!!S.f,re=i.QObject,G=!re||!re.prototype||!re.prototype.findChild,K=l&&d(function(){return I(E({},"a",{get:function(){return E(this,"a",{value:7}).a}})).a!=7})?function(J,X,le){var ge=b(Y,X);ge&&delete Y[X],E(J,X,le),ge&&J!==Y&&E(Y,X,ge)}:E,de=function(J){var X=j[J]=I(D.prototype);return X._k=J,X},B=te&&typeof D.iterator=="symbol"?function(J){return typeof J=="symbol"}:function(J){return J instanceof D},$=function(J,X,le){return J===Y&&$(W,X,le),T(J),X=w(X,!0),T(le),a(j,X)?(le.enumerable?(a(J,N)&&J[N][X]&&(J[N][X]=!1),le=I(le,{enumerable:k(0,!1)})):(a(J,N)||E(J,N,k(1,{})),J[N][X]=!0),K(J,X,le)):E(J,X,le)},z=function(J,X){T(J);for(var le,ge=v(X=R(X)),fe=0,me=ge.length;me>fe;)$(J,le=ge[fe++],X[le]);return J},ie=function(J){var X=U.call(this,J=w(J,!0));return!(this===Y&&a(j,J)&&!a(W,J))&&(!(X||!a(this,J)||!a(j,J)||a(this,N)&&this[N][J])||X)},Z=function(J,X){if(J=R(J),X=w(X,!0),J!==Y||!a(j,X)||a(W,X)){var le=b(J,X);return!le||!a(j,X)||a(J,N)&&J[N][X]||(le.enumerable=!0),le}},ee=function(J){for(var X,le=x(R(J)),ge=[],fe=0;le.length>fe;)a(j,X=le[fe++])||X==N||X==s||ge.push(X);return ge},ce=function(J){for(var X,le=J===Y,ge=x(le?W:R(J)),fe=[],me=0;ge.length>me;)!a(j,X=ge[me++])||le&&!a(Y,X)||fe.push(j[X]);return fe};te||(c((D=function(){if(this instanceof D)throw TypeError("Symbol is not a constructor!");var J=o(arguments.length>0?arguments[0]:void 0),X=function(le){this===Y&&X.call(W,le),a(this,N)&&a(this[N],J)&&(this[N][J]=!1),K(this,J,k(1,le))};return l&&G&&K(Y,J,{configurable:!0,set:X}),de(J)}).prototype,"toString",function(){return this._k}),P.f=Z,y.f=$,r(68).f=M.f=ee,r(41).f=ie,S.f=ce,l&&!r(15)&&c(Y,"propertyIsEnumerable",ie,!0),m.f=function(J){return de(f(J))}),n(n.G+n.W+n.F*!te,{Symbol:D});for(var ae="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),ne=0;ae.length>ne;)f(ae[ne++]);for(var se=_(f.store),he=0;se.length>he;)g(se[he++]);n(n.S+n.F*!te,"Symbol",{for:function(J){return a(H,J+="")?H[J]:H[J]=D(J)},keyFor:function(J){if(!B(J))throw TypeError(J+" is not a symbol!");for(var X in H)if(H[X]===J)return X},useSetter:function(){G=!0},useSimple:function(){G=!1}}),n(n.S+n.F*!te,"Object",{create:function(J,X){return X===void 0?I(J):z(I(J),X)},defineProperty:$,defineProperties:z,getOwnPropertyDescriptor:Z,getOwnPropertyNames:ee,getOwnPropertySymbols:ce});var ue=d(function(){S.f(1)});n(n.S+n.F*ue,"Object",{getOwnPropertySymbols:function(J){return S.f(A(J))}}),F&&n(n.S+n.F*(!te||d(function(){var J=D();return V([J])!="[null]"||V({a:J})!="{}"||V(Object(J))!="{}"})),"JSON",{stringify:function(J){for(var X,le,ge=[J],fe=1;arguments.length>fe;)ge.push(arguments[fe++]);if(le=X=ge[1],(C(X)||J!==void 0)&&!B(J))return O(X)||(X=function(me,Q){if(typeof le=="function"&&(Q=le.call(this,me,Q)),!B(Q))return Q}),ge[1]=X,V.apply(F,ge)}}),D.prototype[L]||r(9)(D.prototype,L,D.prototype.valueOf),h(D,"Symbol"),h(Math,"Math",!0),h(i.JSON,"JSON",!0)},function(t,e,r){var i=r(24)("meta"),a=r(11),l=r(13),n=r(10).f,c=0,s=Object.isExtensible||function(){return!0},d=!r(22)(function(){return s(Object.preventExtensions({}))}),u=function(o){n(o,i,{value:{i:"O"+ ++c,w:{}}})},h=t.exports={KEY:i,NEED:!1,fastKey:function(o,f){if(!a(o))return typeof o=="symbol"?o:(typeof o=="string"?"S":"P")+o;if(!l(o,i)){if(!s(o))return"F";if(!f)return"E";u(o)}return o[i].i},getWeak:function(o,f){if(!l(o,i)){if(!s(o))return!0;if(!f)return!1;u(o)}return o[i].w},onFreeze:function(o){return d&&h.NEED&&s(o)&&!l(o,i)&&u(o),o}}},function(t,e,r){var i=r(34),a=r(67),l=r(41);t.exports=function(n){var c=i(n),s=a.f;if(s)for(var d,u=s(n),h=l.f,o=0;u.length>o;)h.call(n,d=u[o++])&&c.push(d);return c}},function(t,e,r){var i=r(18);t.exports=Array.isArray||function(a){return i(a)=="Array"}},function(t,e,r){var i=r(14),a=r(68).f,l={}.toString,n=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];t.exports.f=function(c){return n&&l.call(c)=="[object Window]"?function(s){try{return a(s)}catch{return n.slice()}}(c):a(i(c))}},function(t,e,r){var i=r(41),a=r(23),l=r(14),n=r(33),c=r(13),s=r(54),d=Object.getOwnPropertyDescriptor;e.f=r(12)?d:function(u,h){if(u=l(u),h=n(h,!0),s)try{return d(u,h)}catch{}if(c(u,h))return a(!i.f.call(u,h),u[h])}},function(t,e,r){r(40)("asyncIterator")},function(t,e,r){r(40)("observable")},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.createFrameBuffer=void 0;const i=r(75);e.createFrameBuffer=function(a,l,n,c){const s=a.createFramebuffer();if(!s)return console.error("framebuffer created error."),null;const d=i.createTexture(a,null,{width:l,height:n,genMipMaps:c!=null&&c});return d?(a.bindFramebuffer(a.FRAMEBUFFER,s),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,d.glTexture,0),a.bindFramebuffer(a.FRAMEBUFFER,null),{framebuffer:s,targetTexture:d,bind:u=>{u?a.bindFramebuffer(a.FRAMEBUFFER,null):a.bindFramebuffer(a.FRAMEBUFFER,s)}}):null}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.Program=void 0;const i=r(314),a=r(156),l=r(315),n=r(316);e.Program=class{constructor(c,s){this.shaders={},this.uniforms={},this.attributes={},this.indices=null,this.gl=c,this.draw=s,this._program=c.createProgram(),this.setShader(i.defaultShader.vShader,"VERTEX"),this.setShader(i.defaultShader.fShader,"FRAGMENT")}get program(){return this._program||console.error("program create error."),this._program}parseUniforms(){const c=n.parseUniforms(this.gl,this.program);for(const s in c)s in this.uniforms&&c[s].setter(this.uniforms[s].value);this.uniforms=c}parseAttributes(){const c=this.gl,s=a.parseAttributes(this.gl,this.program);for(const d in this.attributes){const u=this.attributes[d];if(d in s){const h=u.attributeBuffer;h&&s[d].bufferSetter(h)}else c.deleteBuffer(u.buffer)}this.attributes=s}get count(){const c=this.attributes;let s=-1;for(const d in c){const u=c[d];s!==-1&&s!==u.count&&console.warn("inconsistent attribute length."),s=Math.max(s,u.count)}return s}setShader(c,s){const d=this.gl,u=this.program,h=l.createShader(d,c,s);if(h){const o=this.shaders[s];o&&(d.detachShader(u,o),d.deleteShader(o)),d.attachShader(u,h),this.shaders[s]=h,this.shaders.VERTEX&&this.shaders.FRAGMENT&&(d.linkProgram(u),this.parseUniforms(),this.parseAttributes())}else s==="VERTEX"?this.setShader(i.defaultShader.vShader,"VERTEX"):this.setShader(i.defaultShader.fShader,"FRAGMENT")}getUniform(c){var s;const d=(s=this.uniforms[c])!==null&&s!==void 0?s:null;return d||console.warn(`uniform:[${c}] does not exist.`),d}setUniform(c,s){var d;(d=this.getUniform(c))===null||d===void 0||d.setter(s)}updateUniform(c,s){var d;const u=this.getUniform(c);u==null||u.setter((d=s(u.value))!==null&&d!==void 0?d:u.value)}setAttributeBuffer(c){var s;c&&((s=this.getAttribute(c.name))===null||s===void 0||s.bufferSetter(c))}getAttribute(c){return this.attributes[c]||console.warn(`attribute:[${c}] does not exist.`),this.attributes[c]}setAttribute(c,s){var d;(d=this.getAttribute(c))===null||d===void 0||d.setter(s)}updateAttribute(c,s){var d;const u=this.getAttribute(c);u==null||u.setter((d=s(u.typedArray))!==null&&d!==void 0?d:u.typedArray)}setIndices(c){if(c&&c.name==="indices"){const s=this.gl;s.bindBuffer(c.target,c.buffer),s.bufferData(c.target,c.typedArray,c.usage)}this.indices=c}render(){const c=this.gl,s=this.program;c.useProgram(s);const d=this.uniforms;for(const h in d)d[h].setter();const u=this.attributes;for(const h in u)u[h].setter();this.indices&&c.bindBuffer(this.indices.target,this.indices.buffer),this.draw?this.draw():c.drawArrays(c.TRIANGLE_STRIP,0,this.count)}destroy(c=!0){var s,d;const u=this.gl;if(c){for(const h in this.attributes){const o=this.attributes[h];if(o){const f=u.getAttribLocation(this.program,h);u.disableVertexAttribArray(f),u.deleteBuffer(o.buffer)}}this.indices&&u.deleteBuffer(this.indices.buffer)}u.deleteShader((s=this.shaders.VERTEX)!==null&&s!==void 0?s:null),u.deleteShader((d=this.shaders.FRAGMENT)!==null&&d!==void 0?d:null),u.deleteProgram(this.program)}}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.baseTextureShader=void 0,e.baseTextureShader={vShader:`
    attribute vec4 position;
    attribute vec2 uv;
    varying vec2 vuv;
    void main() {
        gl_Position = position;
        vuv = uv;
    }
`,fShader:`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
        precision highp float;
    #else
        precision mediump float;
    #endif

    uniform sampler2D map;
    varying vec2 vuv;
    void main() {
        gl_FragColor = texture2D(map, vuv);
    }
`,yFlipFShader:`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
        precision highp float;
    #else
        precision mediump float;
    #endif

    uniform sampler2D map;
    varying vec2 vuv;
    void main() {
        gl_FragColor = texture2D(map, vec2(vuv.x, 1.0 - vuv.y));
    }
`}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.Filter=void 0;const i=r(3);class a extends i.EventEmitter{constructor(n,c,s,d){super(),this.programs={},this.framebuffers={},this.renderer=n,this._map=c,this.posBuffer=s,this.uvBuffer=d}get map(){return this._map}set map(n){}get output(){return this._map}updateSize(){}render(){}destroy(n=!0){this.removeAllListeners();const c=this.renderer.gl,s=this.framebuffers,d=this.programs;for(const u in s){const h=s[u];h.bind(!0),c==null||c.deleteTexture(h.targetTexture.glTexture),c==null||c.deleteFramebuffer(h.framebuffer)}for(const u in d)d[u].destroy(n)}}e.Filter=a},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(h,o,f,m){m===void 0&&(m=f),Object.defineProperty(h,m,{enumerable:!0,get:function(){return o[f]}})}:function(h,o,f,m){m===void 0&&(m=f),h[m]=o[f]}),a=this&&this.__setModuleDefault||(Object.create?function(h,o){Object.defineProperty(h,"default",{enumerable:!0,value:o})}:function(h,o){h.default=o}),l=this&&this.__importStar||function(h){if(h&&h.__esModule)return h;var o={};if(h!=null)for(var f in h)f!=="default"&&Object.prototype.hasOwnProperty.call(h,f)&&i(o,h,f);return a(o,h),o};Object.defineProperty(e,"__esModule",{value:!0}),e.RemoteSdp=void 0;const n=l(r(50)),c=l(r(7)),s=r(1),d=r(29),u=r(229);e.RemoteSdp=class{constructor({iceParameters:h,iceCandidates:o,dtlsParameters:f,sctpParameters:m,plainRtpParameters:g,planB:v=!1}){if(this._mediaSections=[],this._midToIndex=new Map,this._iceParameters=h,this._iceCandidates=o,this._dtlsParameters=f,this._sctpParameters=m,this._plainRtpParameters=g,this._planB=v,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:1e4,sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},h&&h.iceLite&&(this._sdpObject.icelite="ice-lite"),f){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};const O=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:f.fingerprints[O-1].algorithm,hash:f.fingerprints[O-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}g&&(this._sdpObject.origin.address=g.ip,this._sdpObject.origin.ipVer=g.ipVersion)}updateIceParameters(h){d.Logger.debug("RemoteSdp","updateIceParameters() [iceParameters:%o]",h),this._iceParameters=h,this._sdpObject.icelite=h.iceLite?"ice-lite":void 0;for(const o of this._mediaSections)o.setIceParameters(h)}updateDtlsRole(h){d.Logger.debug("RemoteSdp",`updateDtlsRole() [role: ${h}]`),this._dtlsParameters&&(this._dtlsParameters.role=h);for(const o of this._mediaSections)o.setDtlsRole(h)}getNextMediaSectionIdx(){if(s.getParameters().reuseMid)for(let h=0;h<this._mediaSections.length;++h){const o=this._mediaSections[h];if(o.closed)return{idx:h,reuseMid:o.mid}}return{idx:this._mediaSections.length}}send({offerMediaObjectArr:h,reuseMid:o,offerRtpParameters:f,answerRtpParameters:m,codecOptions:g,extmapAllowMixed:v=!1}){h!=null&&h.length&&h.forEach((O,T)=>{if(!O)return;const C=new u.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,offerMediaObject:O,offerRtpParameters:f,answerRtpParameters:m,codecOptions:g?g[T]:void 0,extmapAllowMixed:v});o?this._replaceMediaSection(C,o):this._addMediaSection(C)})}receive({mid:h,kind:o,offerRtpParameters:f,streamId:m,trackId:g,reuseMid:v=null,reuseMediaSection:O}){const T=this._midToIndex.get(h);let C;T!==void 0&&(C=this._mediaSections[T]),C?(C=new u.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:h,kind:o,offerRtpParameters:f,streamId:m,trackId:g}),this._replaceMediaSection(C,h)):(C=new u.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:h,kind:o,offerRtpParameters:f,streamId:m,trackId:g}),v===null?this._addMediaSection(C):this._replaceMediaSection(C,v))}disableMediaSection(h){const o=this._midToIndex.get(h);o!==void 0&&this._mediaSections[o].disable()}closeMediaSection(h){const o=this._midToIndex.get(h);if(o===void 0)return;const f=this._mediaSections[o];h===this._firstMid&&d.Logger.debug("RemoteSdp","closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",h),f.close()}planBStopReceiving({mid:h,offerRtpParameters:o}){const f=this._midToIndex.get(h);if(f===void 0)return;const m=this._mediaSections[f];m.planBStopReceiving({offerRtpParameters:o}),this._replaceMediaSection(m)}sendSctpAssociation({offerMediaObject:h}){const o=new u.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:h});this._addMediaSection(o)}receiveSctpAssociation({oldDataChannelSpec:h=!1}={}){const o=new u.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application",oldDataChannelSpec:h});this._addMediaSection(o)}getSdp(){return this._sdpObject.origin.sessionVersion++,c.ANY_CHROME_MAJOR_VERSION&&c.ANY_CHROME_MAJOR_VERSION>=72&&this._sdpObject.media.sort(function(h,o){return h.mid-o.mid}),n.write(this._sdpObject)}_addMediaSection(h){this._firstMid||(this._firstMid=h.mid),this._mediaSections.push(h),this._midToIndex.set(h.mid,this._mediaSections.length-1),this._sdpObject.media.push(h.getObject()),this._regenerateBundleMids()}_replaceMediaSection(h,o){if(typeof o=="string"){const f=this._midToIndex.get(o);if(f===void 0)return;const m=this._mediaSections[f];this._mediaSections[f]=h,this._midToIndex.delete(m.mid),this._midToIndex.set(h.mid,f),this._sdpObject.media[f]=h.getObject(),this._regenerateBundleMids()}else{const f=this._midToIndex.get(h.mid);if(f===void 0)return;this._mediaSections[f]=h,this._sdpObject.media[f]=h.getObject()}}_regenerateBundleMids(){this._dtlsParameters&&(this._sdpObject.groups[0].mids=this._mediaSections.filter(h=>!h.closed).map(h=>h.mid).join(" "))}}},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(c,s,d,u){u===void 0&&(u=d),Object.defineProperty(c,u,{enumerable:!0,get:function(){return s[d]}})}:function(c,s,d,u){u===void 0&&(u=d),c[u]=s[d]}),a=this&&this.__setModuleDefault||(Object.create?function(c,s){Object.defineProperty(c,"default",{enumerable:!0,value:s})}:function(c,s){c.default=s}),l=this&&this.__importStar||function(c){if(c&&c.__esModule)return c;var s={};if(c!=null)for(var d in c)d!=="default"&&Object.prototype.hasOwnProperty.call(c,d)&&i(s,c,d);return a(s,c),s};Object.defineProperty(e,"__esModule",{value:!0}),e.addNackSuppportForOpus=e.mangleRtpParameters=e.getCapabilities=void 0;const n=l(r(27));e.getCapabilities=function(){const c=RTCRtpReceiver.getCapabilities(),s=n.clone(c,{});for(const d of s.codecs){if(d.channels=d.numChannels,delete d.numChannels,d.mimeType=d.mimeType||`${d.kind}/${d.name}`,d.parameters){const u=d.parameters;u.apt&&(u.apt=Number(u.apt)),u["packetization-mode"]&&(u["packetization-mode"]=Number(u["packetization-mode"]))}for(const u of d.rtcpFeedback||[])u.parameter||(u.parameter="")}return s},e.mangleRtpParameters=function(c){const s=n.clone(c,{});s.mid&&(s.muxId=s.mid,delete s.mid);for(const d of s.codecs)d.channels&&(d.numChannels=d.channels,delete d.channels),d.mimeType&&!d.name&&(d.name=d.mimeType.split("/")[1]),delete d.mimeType;return s},e.addNackSuppportForOpus=function(c){var s;for(const d of c.codecs||[])d.mimeType.toLowerCase()!=="audio/opus"||!((s=d.rtcpFeedback)===null||s===void 0)&&s.some(u=>u.type==="nack"&&!u.parameter)||(d.rtcpFeedback||(d.rtcpFeedback=[]),d.rtcpFeedback.push({type:"nack"}))}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.SimpleBig=void 0;class i{constructor(n){this.isSimpleBig=!0,typeof n=="string"?this.numStr=n:n>Number.MIN_SAFE_INTEGER?this.numStr=n.toString():(console.error("Invalid numStr:",n),this.numStr="-1")}toString(){return this.numStr}static fromHex(n){if(n.length<13)return parseInt(n,16);let c="0";return n.split("").forEach(s=>{var d=parseInt(s,16);for(let u=8;u;u>>=1)c=a(c,c),d&u&&(c=a(c,"1"))}),new i(c)}}function a(l,n){let c=0,s=[],d=l.split("").map(Number),u=n.split("").map(Number);for(;d.length||u.length;){const h=(d.pop()||0)+(u.pop()||0)+c;s.unshift(h<10?h:h-10),c=h<10?0:1}return c&&s.unshift(c),s.join("")}e.SimpleBig=i},function(t,e,r){t.exports=n;var i=r(82);((n.prototype=Object.create(i.prototype)).constructor=n).className="OneOf";var a=r(83),l=r(19);function n(s,d,u,h){if(Array.isArray(d)||(u=d,d=void 0),i.call(this,s,u),d!==void 0&&!Array.isArray(d))throw TypeError("fieldNames must be an Array");this.oneof=d||[],this.fieldsArray=[],this.comment=h}function c(s){if(s.parent)for(var d=0;d<s.fieldsArray.length;++d)s.fieldsArray[d].parent||s.parent.add(s.fieldsArray[d])}n.fromJSON=function(s,d){return new n(s,d.oneof,d.options,d.comment)},n.prototype.toJSON=function(s){var d=!!s&&!!s.keepComments;return l.toObject(["options",this.options,"oneof",this.oneof,"comment",d?this.comment:void 0])},n.prototype.add=function(s){if(!(s instanceof a))throw TypeError("field must be a Field");return s.parent&&s.parent!==this.parent&&s.parent.remove(s),this.oneof.push(s.name),this.fieldsArray.push(s),s.partOf=this,c(this),this},n.prototype.remove=function(s){if(!(s instanceof a))throw TypeError("field must be a Field");var d=this.fieldsArray.indexOf(s);if(d<0)throw Error(s+" is not a member of "+this);return this.fieldsArray.splice(d,1),(d=this.oneof.indexOf(s.name))>-1&&this.oneof.splice(d,1),s.partOf=null,this},n.prototype.onAdd=function(s){i.prototype.onAdd.call(this,s);for(var d=0;d<this.oneof.length;++d){var u=s.get(this.oneof[d]);u&&!u.partOf&&(u.partOf=this,this.fieldsArray.push(u))}c(this)},n.prototype.onRemove=function(s){for(var d,u=0;u<this.fieldsArray.length;++u)(d=this.fieldsArray[u]).parent&&d.parent.remove(d);i.prototype.onRemove.call(this,s)},n.d=function(){for(var s=new Array(arguments.length),d=0;d<arguments.length;)s[d]=arguments[d++];return function(u,h){l.decorateType(u.constructor).add(new n(h,s)),Object.defineProperty(u,h,{get:l.oneOfGetter(s),set:l.oneOfSetter(s)})}}},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(f,m,g,v){v===void 0&&(v=g),Object.defineProperty(f,v,{enumerable:!0,get:function(){return m[g]}})}:function(f,m,g,v){v===void 0&&(v=g),f[v]=m[g]}),a=this&&this.__setModuleDefault||(Object.create?function(f,m){Object.defineProperty(f,"default",{enumerable:!0,value:m})}:function(f,m){f.default=m}),l=this&&this.__importStar||function(f){if(f&&f.__esModule)return f;var m={};if(f!=null)for(var g in f)g!=="default"&&Object.prototype.hasOwnProperty.call(f,g)&&i(m,f,g);return a(m,f),m};Object.defineProperty(e,"__esModule",{value:!0}),e.alerter=void 0;const n=r(164),c=l(r(7)),s=r(46),d=r(1),u=r(47);class h extends s.RTCEventEmitter{constructor(){super(...arguments),this.elem=null}alert(m,g){g||(g={resume:!1}),this.elem||(this.elem=document.createElement("div"),this.elem.style.fontSize="20px",this.elem.style.position="fixed",this.elem.style.background="yellow",this.elem.style.margin="auto",this.elem.style.width="100%",this.elem.style.zIndex="9999",this.elem.style.top="0",this.elem.addEventListener("click",()=>{var v;!((v=this.elem)===null||v===void 0)&&v.parentNode&&this.elem.parentNode.removeChild(this.elem),this.safeEmit("@user-gesture-fired")})),this.elem.style.display="block",this.elem.innerHTML=m,document.body.appendChild(this.elem),g.resume&&this.elem.addEventListener("click",o,{once:!0})}watchClient(m){m.addListener("@pairing-join-start",()=>{if((n.systemChecker.checkCnt===0||d.getParameters().enableAlerter==="always")&&c.IS_CHROME&&(c.IS_MAC||c.IS_WIN)&&c.CHROME_MAJOR_VERSION&&c.CHROME_MAJOR_VERSION<72){let v=`您当前正在使用的Chrome浏览器版本为${c.CHROME_MAJOR_VERSION}, 不在NERTC的支持范围。请更新您的浏览器。<br/>您看到这条提示是因为您未调用 NERTC.checkSystemRequirements()，并且浏览器版本过低。`;this.alert(v)}}),m.addListener("@connection-state-change",g=>{g.curState==="DISCONNECTING"&&g.prevState==="CONNECTING"&&(m._events&&!m._events["connection-state-change"]&&!m._events.SOCKET_ERROR||d.getParameters().enableAlerter==="always")&&this.alert("由于网络原因，您当前已经退出房间。<br/>您看到这条提示是因为您未监听 connection-state-change 或 SOCKET_ERROR 事件，并且加入房间后意外退出了房间。")})}watchLocalStream(m){m.on("@notAllowedError",g=>{(!m._events.notAllowedError||d.getParameters().enableAlerter==="always")&&this.alert("音频播放需要手势触发。<br/>您看到这条提示是因为您未监听 notAllowedError 事件，并且遇到了浏览器自动播放策略问题。",{resume:!0})})}watchRemoteStream(m){m.on("@notAllowedError",g=>{(!m._events.notAllowedError||d.getParameters().enableAlerter==="always")&&this.alert("音频播放需要手势触发。<br/>您看到这条提示是因为您未监听 notAllowedError 事件，并且遇到了浏览器自动播放策略问题。",{resume:!0})})}}function o(){const f=d.getParameters().clients;for(let v=0;v<f.length;v++){const O=f[v];if(!O.destroyed)for(let T in O.adapterRef.remoteStreamMap)O.adapterRef.remoteStreamMap[T].resume()}const m=d.getParameters().localStreams;for(let v=0;v<m.length;v++){const O=m[v];O.destroyed||O.resume()}const g=u.getAudioContext();(g==null?void 0:g.state)==="suspended"&&(f[0]&&f[0].logger.warn("尝试恢复 AudioContext"),g.resume())}e.alerter=new h},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(P,S,y,_){_===void 0&&(_=y),Object.defineProperty(P,_,{enumerable:!0,get:function(){return S[y]}})}:function(P,S,y,_){_===void 0&&(_=y),P[_]=S[y]}),a=this&&this.__setModuleDefault||(Object.create?function(P,S){Object.defineProperty(P,"default",{enumerable:!0,value:S})}:function(P,S){P.default=S}),l=this&&this.__importStar||function(P){if(P&&P.__esModule)return P;var S={};if(P!=null)for(var y in P)y!=="default"&&Object.prototype.hasOwnProperty.call(P,y)&&i(S,P,y);return a(S,P),S};Object.defineProperty(e,"__esModule",{value:!0}),e.isHttpProtocol=e.checkBrowserCompatibility=e.isBrowserSupported=e.isPullStreamSupported=e.isPushStreamSupported=e.RtcSupport=void 0;const n=r(76),c=r(43),s=l(r(7)),d=r(77);let u={isPullStreamSupport:!1,isPushStreamSupport:!1,isScreenShareSupport:!1},h={video:[]},o={video:[]};var f=null;s.IS_IOS&&s.IS_WECHAT||(f=navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia);var m=window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext,g=window.RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,v=window.MediaStream=window.MediaStream||window.webkitMediaStream;function O(P){let S;return S||(S=document.createElement("video")),!!S.canPlayType({ogg:'video/ogg; codecs="theora"',h264:'video/mp4; codecs="avc1.42E01E"',webm:'video/webm; codecs="vp8, vorbis"',vp9:'video/webm; codecs="vp9"',hls:'application/x-mpegURL; codecs="avc1.42E01E"'}[P]||P)}const T={WebRTC:!!g&&!!v,RTCPeerConnection:!!g,Vp8:O("webm"),Vp9:O("vp9"),H264:O("h264"),GetUserMedia:!!f&&!!navigator.mediaDevices,DataChannel:!!(g&&typeof RTCDataChannel<"u"&&g.prototype&&g.prototype.createDataChannel),WebAudio:!(!m||!m.prototype.createMediaStreamSource),MediaStream:!!v};function C(){let P=d.getBrowserInfo().browserName,S=d.getBrowserInfo().browserVersion;return S=S&&S.match(/\d+/)[0],{prefix:P,version:S}}const A={checkWebRtc:()=>T,checkWebAudio:()=>({WebAudio:T.WebAudio,MediaStream:T.MediaStream}),checkCompatibility(){let P=Object.assign(C(),{system:d.getOSInfo().osName+" "+d.getOSInfo().osVersion,browser:d.getBrowserInfo().browserName,version:d.getBrowserInfo().browserVersion});return new Promise(function(S,y){(async()=>{const _=Object.assign(P,T,{ScreenSharing:!1}),b=await n.Device.getDevices({audiooutput:!0,audioinput:!0,videoinput:!0,requestPerm:!0}).catch(E=>S(_));_.MicrophoneList=b&&b.audioIn||[],_.CameraList=b&&b.video||[],_.Microphone=b&&b.audioIn&&b.audioIn.length>0||!1,_.Camera=b&&b.video&&b.video.length>0||!1,S(_)})()})},checkVersion:()=>C()};e.RtcSupport=A;const R=function(){return["RTCPeerConnection","webkitRTCPeerConnection","mozRTCPeerConnection"].filter(P=>P in window).length>0},w=function(){return!!window.WebSocket&&!!window.WebSocket.prototype.send};async function k(){return await async function(){return!!h.video.length||(h=await c.getSupportedCodecs("send"),h.video.indexOf("H264")>-1||h.video.indexOf("VP8")>-1)}()&&R()&&w()&&function(){if(!navigator.mediaDevices)return!1;const P=["getUserMedia","enumerateDevices"];return P.filter(S=>S in navigator.mediaDevices).length===P.length}()&&async function(){return!!g.prototype.getStats||!!RTCRtpSender.prototype.getStats}()}async function I(){return await async function(){return!!o.video.length||(o=await c.getSupportedCodecs("recv"),o.video.indexOf("H264")>-1||o.video.indexOf("VP8")>-1)}()&&R()&&w()&&async function(){return!!g.prototype.getStats||!!RTCRtpReceiver.prototype.getStats}()}e.isPushStreamSupported=k,e.isPullStreamSupported=I,e.isBrowserSupported=function(){return!!(s.IS_CHROME&&s.CHROME_MAJOR_VERSION>=72)||!!(s.IS_MAC_SAFARI&&s.SAFARI_MAJOR_VERSION>=12)||!(!(s.IS_IOS_SAFARI&&s.SAFARI_MAJOR_VERSION>=13)||s.IS_WECHAT)||!!(s.IS_EDG&&s.EDG_MAJOR_VERSION>=80)||!!(s.IS_FIREFOX&&s.FIREFOX_MAJOR_VERSION>=66)||!(!s.IS_IOS||!s.IS_MQQB)||!!(s.IS_IOS&&s.IOS_VERSION&&parseFloat(s.IOS_VERSION)>=14.3&&s.IS_WECHAT&&s.WECHAT_VERSION&&parseFloat(s.WECHAT_VERSION)>=6.5)||!(!s.IS_ANDROID||!s.IS_TBS&&!s.IS_XWEB)},e.checkBrowserCompatibility=async function(){const P=function(){if(s.IS_ELECTRON)return!0;{let _=navigator.mediaDevices;return!(!_||!_.getDisplayMedia)}}(),S=await k(),y=await I();return u.isScreenShareSupport=P,u.isPushStreamSupport=S,u.isPullStreamSupport=y,u};const M=location.protocol==="file:"||location.hostname==="localhost"||/^\d+\.\d+\.\d+\.\d+$/.test(location.hostname);e.isHttpProtocol=function(){return location.protocol==="http:"&&!M}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.compatAudioInputList=void 0;const i=r(1);e.compatAudioInputList=new class{constructor(){this.enabled=i.getParameters().enableCompatAudio,this.compatTracks=[]}findSource(a){const l=this.compatTracks.find(n=>n.dest.id===a);return l?l.source:null}}},function(t,e,r){var i=this&&this.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(e,"__esModule",{value:!0}),e.encryptionModeToInt=e.EncryptionModes=e.Encryption=void 0;const a=r(3),l=i(r(146)),n={none:-1,"sm4-128-ecb":0};e.EncryptionModes=n,e.encryptionModeToInt=function(s){return s==="none"||s==="sm4-128-ecb"?n[s]:void 0};class c extends a.EventEmitter{constructor(d){super(),this.encryptionMode="none",this.encryptionSecret="",this.encodedInsertableStreams=!1,this.adapterRef=d}setEncryptionMode(d){this.encryptionMode=d}setEncryptionSecret(d){this.encryptionSecret=l.default(d)}handleUpstreamTransform(d,u,h){d.index++,d.index===1&&this.adapterRef.logger.log("生成第一帧上行自定义加密（明文）。长度:",u.data.byteLength,d.mediaType,d.streamType),this.adapterRef.instance.safeEmit("sender-transform",{uid:this.adapterRef.channelInfo.uid,mediaType:d.mediaType,streamType:d.streamType,encodedFrame:u,controller:h})}handleDownstreamTransform(d,u,h){d.index++,d.index===1&&this.adapterRef.logger.log("收到第一帧下行自定义加密（密文）。长度:",u.data.byteLength,d.uid,d.mediaType),u.type==="key"&&this.adapterRef.state.videoFirstIframeTime<this.adapterRef.state.signalJoinSuccessTime&&(this.adapterRef.state.videoFirstIframeTime=Date.now()),this.adapterRef.instance.safeEmit("receiver-transform",{uid:d.uid,mediaType:d.mediaType,encodedFrame:u,controller:h})}}e.Encryption=c},function(t,e,r){var i,a,l,n,c;i=r(213),a=r(166).utf8,l=r(214),n=r(166).bin,(c=function(s,d){s.constructor==String?s=d&&d.encoding==="binary"?n.stringToBytes(s):a.stringToBytes(s):l(s)?s=Array.prototype.slice.call(s,0):Array.isArray(s)||s.constructor===Uint8Array||(s=s.toString());for(var u=i.bytesToWords(s),h=8*s.length,o=1732584193,f=-271733879,m=-1732584194,g=271733878,v=0;v<u.length;v++)u[v]=16711935&(u[v]<<8|u[v]>>>24)|4278255360&(u[v]<<24|u[v]>>>8);u[h>>>5]|=128<<h%32,u[14+(h+64>>>9<<4)]=h;var O=c._ff,T=c._gg,C=c._hh,A=c._ii;for(v=0;v<u.length;v+=16){var R=o,w=f,k=m,I=g;o=O(o,f,m,g,u[v+0],7,-680876936),g=O(g,o,f,m,u[v+1],12,-389564586),m=O(m,g,o,f,u[v+2],17,606105819),f=O(f,m,g,o,u[v+3],22,-1044525330),o=O(o,f,m,g,u[v+4],7,-176418897),g=O(g,o,f,m,u[v+5],12,1200080426),m=O(m,g,o,f,u[v+6],17,-1473231341),f=O(f,m,g,o,u[v+7],22,-45705983),o=O(o,f,m,g,u[v+8],7,1770035416),g=O(g,o,f,m,u[v+9],12,-1958414417),m=O(m,g,o,f,u[v+10],17,-42063),f=O(f,m,g,o,u[v+11],22,-1990404162),o=O(o,f,m,g,u[v+12],7,1804603682),g=O(g,o,f,m,u[v+13],12,-40341101),m=O(m,g,o,f,u[v+14],17,-1502002290),o=T(o,f=O(f,m,g,o,u[v+15],22,1236535329),m,g,u[v+1],5,-165796510),g=T(g,o,f,m,u[v+6],9,-1069501632),m=T(m,g,o,f,u[v+11],14,643717713),f=T(f,m,g,o,u[v+0],20,-373897302),o=T(o,f,m,g,u[v+5],5,-701558691),g=T(g,o,f,m,u[v+10],9,38016083),m=T(m,g,o,f,u[v+15],14,-660478335),f=T(f,m,g,o,u[v+4],20,-405537848),o=T(o,f,m,g,u[v+9],5,568446438),g=T(g,o,f,m,u[v+14],9,-1019803690),m=T(m,g,o,f,u[v+3],14,-187363961),f=T(f,m,g,o,u[v+8],20,1163531501),o=T(o,f,m,g,u[v+13],5,-1444681467),g=T(g,o,f,m,u[v+2],9,-51403784),m=T(m,g,o,f,u[v+7],14,1735328473),o=C(o,f=T(f,m,g,o,u[v+12],20,-1926607734),m,g,u[v+5],4,-378558),g=C(g,o,f,m,u[v+8],11,-2022574463),m=C(m,g,o,f,u[v+11],16,1839030562),f=C(f,m,g,o,u[v+14],23,-35309556),o=C(o,f,m,g,u[v+1],4,-1530992060),g=C(g,o,f,m,u[v+4],11,1272893353),m=C(m,g,o,f,u[v+7],16,-155497632),f=C(f,m,g,o,u[v+10],23,-1094730640),o=C(o,f,m,g,u[v+13],4,681279174),g=C(g,o,f,m,u[v+0],11,-358537222),m=C(m,g,o,f,u[v+3],16,-722521979),f=C(f,m,g,o,u[v+6],23,76029189),o=C(o,f,m,g,u[v+9],4,-640364487),g=C(g,o,f,m,u[v+12],11,-421815835),m=C(m,g,o,f,u[v+15],16,530742520),o=A(o,f=C(f,m,g,o,u[v+2],23,-995338651),m,g,u[v+0],6,-198630844),g=A(g,o,f,m,u[v+7],10,1126891415),m=A(m,g,o,f,u[v+14],15,-1416354905),f=A(f,m,g,o,u[v+5],21,-57434055),o=A(o,f,m,g,u[v+12],6,1700485571),g=A(g,o,f,m,u[v+3],10,-1894986606),m=A(m,g,o,f,u[v+10],15,-1051523),f=A(f,m,g,o,u[v+1],21,-2054922799),o=A(o,f,m,g,u[v+8],6,1873313359),g=A(g,o,f,m,u[v+15],10,-30611744),m=A(m,g,o,f,u[v+6],15,-1560198380),f=A(f,m,g,o,u[v+13],21,1309151649),o=A(o,f,m,g,u[v+4],6,-145523070),g=A(g,o,f,m,u[v+11],10,-1120210379),m=A(m,g,o,f,u[v+2],15,718787259),f=A(f,m,g,o,u[v+9],21,-343485551),o=o+R>>>0,f=f+w>>>0,m=m+k>>>0,g=g+I>>>0}return i.endian([o,f,m,g])})._ff=function(s,d,u,h,o,f,m){var g=s+(d&u|~d&h)+(o>>>0)+m;return(g<<f|g>>>32-f)+d},c._gg=function(s,d,u,h,o,f,m){var g=s+(d&h|u&~h)+(o>>>0)+m;return(g<<f|g>>>32-f)+d},c._hh=function(s,d,u,h,o,f,m){var g=s+(d^u^h)+(o>>>0)+m;return(g<<f|g>>>32-f)+d},c._ii=function(s,d,u,h,o,f,m){var g=s+(u^(d|~h))+(o>>>0)+m;return(g<<f|g>>>32-f)+d},c._blocksize=16,c._digestsize=16,t.exports=function(s,d){if(s==null)throw new Error("Illegal argument "+s);var u=i.wordsToBytes(c(s,d));return d&&d.asBytes?u:d&&d.asString?n.bytesToString(u):i.bytesToHex(u)}},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(o,f,m,g){g===void 0&&(g=m),Object.defineProperty(o,g,{enumerable:!0,get:function(){return f[m]}})}:function(o,f,m,g){g===void 0&&(g=m),o[g]=f[m]}),a=this&&this.__setModuleDefault||(Object.create?function(o,f){Object.defineProperty(o,"default",{enumerable:!0,value:f})}:function(o,f){o.default=f}),l=this&&this.__importStar||function(o){if(o&&o.__esModule)return o;var f={};if(o!=null)for(var m in o)m!=="default"&&Object.prototype.hasOwnProperty.call(o,m)&&i(f,o,m);return a(f,o),f},n=this&&this.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(e,"__esModule",{value:!0}),e.Record=void 0;const c=r(3),s=n(r(6)),d=n(r(8)),u=l(r(7));class h extends c.EventEmitter{constructor(f){super(),this._status={recordedChunks:[],isRecording:!1,stream:null,option:null,contentTypes:[],mimeType:"",audioController:null,opStream:null,state:"init",timer:null,fileName:null,recordId:0,recordStatus:"init",recordUrl:null,startTime:null,endTime:null},this._recorder=null,this.logger=f.logger.getChild(()=>"recorder "+this._status.recordStatus),this._reset(),this.client=f.client}get recoder(){return this._recorder}async start(f){const{stream:m=null,uid:g="0",type:v="video",reset:O=!1,recordName:T}=f;this.logger.log("开始本地录制: ",JSON.stringify(f,null,""));let C=null;if(!window.MediaRecorder||!MediaRecorder.isTypeSupported||!u.IS_CHROME)throw C="Record.start: 当前浏览器不支持本地录制",this.logger.warn(C),new d.default({code:s.default.RECORDING_NOT_SUPPORT,message:C});if(this._status.isRecording)throw C="Record.start: 操作异常, 当前正在录制中",this.logger.warn(C),new d.default({code:s.default.REPEAT_RECORDING_ERROR,message:C});if(this._status.recordUrl&&this._status.recordStatus!=="downloaded"){if(!f.reset)throw C="Record.start: 操作异常, 请先下载或重置上一段录制文件",this.logger.warn(C),new d.default({code:s.default.RECORDING_CACHE_ERROR,message:C});this.logger.warn("Record.start: 存在未下载视频，强制清除..."),await this.clean()}C&&this.client.apiFrequencyControl({name:"startMediaRecording",code:-1,param:JSON.stringify({reason:C,uid:g,mediaType:v,recordName:""},null," ")}),this._status.stream=m,this._status.option=f,this._status.fileName=this._getFilename(T),this._status.startTime=this._getTimeStamp();let A=["video/mp4;codecs=opus","video/webm","video/webm;codecs=h264","video/x-matroska;codecs=opus","video/invalid"];if(f.type==="audio"&&(A=["audio/wav","audio/ogg","audio/pcm","audio/webm"]),!(this._status.mimeType=this._validation(A)[0]))return"RecordBrowserNotSupport";try{await this._format(),await this._start(),this.client.apiFrequencyControl({name:"startMediaRecording",code:0,param:JSON.stringify({uid:g,mediaType:v,recordName:""},null," ")})}catch(R){return this.logger.error("Record.start 内部异常: ",R.name,R.message),this.client.apiFrequencyControl({name:"startMediaRecording",code:-1,param:JSON.stringify({reason:R.message,uid:g,mediaType:v,recordName:""},null," ")}),Promise.reject(new d.default({code:s.default.RECORDING_ERROR,message:"Record.start: 录制异常 "+R.message}))}}stop(f){let m=null;return this._status.isRecording&&this._recorder||(this.logger.log("Record.stop 当前没有进行录制"),m="RecordNotExist"),this._recorder&&this._status.state!=="started"&&(this.logger.warn("Record.stop: record stopping when "+this._recorder.state),m="RecordStateError"),m?(f&&f.isUser===!1||this.client.apiFrequencyControl({name:"stopMediaRecording",code:-1,param:""}),Promise.resolve()):(this._status.state="stopped",this._status.recordStatus="stopping",new Promise((g,v)=>{var O;this._status.fileName=this._status.fileName,this._recorder.onstop=()=>{this._onStop(g)},(O=this==null?void 0:this._recorder)===null||O===void 0||O.stop(),this.client.apiFrequencyControl({name:"stopMediaRecording",code:0,param:""}),f&&f.isUser&&this.client.apiFrequencyControl({name:"stopMediaRecording",code:-1,param:""})}))}play(f){return this._status.state!=="stopped"?(this.client.apiFrequencyControl({name:"playMediaRecording",code:-1,param:JSON.stringify({reason:"RecordStateError"},null," ")}),this.logger.warn("MediaRecordHelper: record stopping when "+(this._recorder&&this._recorder.state)),Promise.resolve()):(this.client.apiFrequencyControl({name:"playMediaRecording",code:0,param:JSON.stringify({recordId:""},null," ")}),this._play(f))}download(f=!0){return Promise.resolve().then(()=>this._status.isRecording?(this.logger.log("Record.download: 正在录制中，立即停止..."),this.stop({isUser:!1})):Promise.resolve()).then(()=>{if(this._status.recordUrl){const m=document.createElement("a");document.body.appendChild(m),m.style.display="none",m.href=this._status.recordUrl,m.download=(this._status.fileName||this._getTimeStamp())+".webm",m.click(),this._status.recordStatus="downloaded"}else this.logger.log("Record.download: cannot download media without url ...");return f&&this.client.apiFrequencyControl({name:"downloadMediaRecording",code:0,param:""}),Promise.resolve(this._status)})}async clean(){this.client.apiFrequencyControl({name:"cleanMediaRecording",code:0,param:""}),this._status.isRecording&&this._recorder&&await this.stop(),this._status.recordUrl&&(window.URL.revokeObjectURL(this._status.recordUrl),this._status.recordUrl=null),this._destroy(),this._status.recordStatus="init"}leave(f={uid:0}){if(!this._status.isRecording||!this._recorder)return Promise.resolve();const{uid:m}=f;return m&&this._status.option?m===+this._status.option.uid?this.stop():void 0:Promise.resolve()}pause(){this._recorder&&this._recorder.pause()}resume(){this._recorder&&this._recorder.resume()}_reset(){this._recorder=null,Object.assign(this._status,{recordedChunks:[],isRecording:!1,stream:null,option:null,contentTypes:[],mimeType:"",audioController:null,opStream:null,state:"init",timer:null,fileName:null,recordId:0,recordStatus:"init",recordUrl:null,startTime:null,endTime:null})}_getTimeStamp(){return Math.floor(Date.now()/1e3)}_getFilename(f){let m="";f&&(m+=f+"_");const g=new Date;return m+=`${g.getFullYear()}${(g.getMonth()+1).toString().padStart(2,"0")}${g.getDate().toString().padStart(2,"0")}`,m+=`${g.getHours().toString().padStart(2,"0")}${g.getMinutes().toString().padStart(2,"0")}${g.getSeconds().toString().padStart(2,"0")}${g.getMilliseconds().toString().padStart(3,"0")}`,m}_validation(f){return f.filter(m=>MediaRecorder.isTypeSupported(m))}_format(){let f=this._status.stream,m=this._status.option;return new Promise((g,v)=>{let O=new MediaStream;if(!f)return v(new d.default({code:s.default.RECORDING_ERROR,message:"Record._format: stream 未明确"}));if(this._matchLocalStreamConstructor(f.constructor.toString())&&(f=[f]),Array.isArray(f)){if(f.forEach(T=>{T&&this._matchLocalStreamConstructor(T.constructor.toString())&&T.getTracks().forEach(C=>{(m==null?void 0:m.type)==="audio"?C.kind==="audio"&&O.addTrack(C):O.addTrack(C)})}),O.getTracks().length===0)return this.logger.error("_format: No tracks available"),g(O);this._status.opStream=O,g(O)}})}_matchLocalStreamConstructor(f){return/(LocalMediaStream|MediaStream)/.test(f)}_start(){let f={audioBitsPerSecond:128e3,videoBitsPerSecond:25e5,mimeType:this._status.mimeType};if(!this._status.opStream)return Promise.reject(new d.default({code:s.default.RECORDING_ERROR,message:"Record._start: opStream 未明确"}));const m=this._status.opStream.getAudioTracks();let g;g=m.length>1?new MediaStream([m[0]]):this._status.opStream;let v=this._recorder=new MediaRecorder(g,f);return v.ondataavailable=this._onDataAvailable.bind(this),v.onstop=()=>{this.logger.log("MediaRecordHelper: _start: record stop automatically ..."),this._onStop()},this._status.recordUrl&&(window.URL.revokeObjectURL(this._status.recordUrl),this._status.recordUrl=null),this._status.recordedChunks=[],this._status.isRecording=!0,this._status.state="started",this._status.recordId+=1,this._status.recordStatus="starting",this._recorder.start(),this._clearTimer(),this._startTimer(),Promise.resolve(this._status.recordId)}_startTimer(){this._status.timer||(this._status.timer=setInterval(()=>{this.logger.log(`MediaRecordHelper: startTimer: ${new Date().toLocaleString()} --> MediaRecorder status: ${this._recorder&&this._recorder.state}`)},5e3))}_onStop(f){this.logger.log("MediaRecordHelper: _onStop: record stoped !!!"),this._clearTimer(),this._status.recordStatus="stopped",this._status.isRecording=!1,this._status.endTime=this._getTimeStamp();let m=new Blob(this._status.recordedChunks,{type:this._status.mimeType});this._status.recordUrl=URL.createObjectURL(m),this.emit("media-recording-stopped",this.getRecordStatus()),f&&f(this._status.fileName)}_play(f){let m=null;if(this._status.mimeType.indexOf("audio")!=-1)m=document.createElement("audio");else{if(this._status.mimeType.indexOf("video")==-1)return Promise.reject(new d.default({code:s.default.NOT_SUPPORT_ERROR,message:"_play: 当前浏览器不支持 MIME type "+this._status.mimeType}));m=document.createElement("video"),m.autoplay=!0}return this._status.recordUrl?(f.appendChild(m),m.srcObject=null,m.src=this._status.recordUrl,m.controls=!1,m.play(),Promise.resolve(this._status.option)):Promise.reject(new d.default({code:s.default.RECORDING_ERROR,message:"Record._play: 录制 url 未明确"}))}async _destroy(){this._status.audioController&&this._status.audioController.destroy(),this._status.isRecording&&await this.stop({isUser:!1}),this._clearTimer(),this._recorder=null,Object.assign(this._status,{stream:null,recordedChunks:[],isRecording:!1,audioController:null,status:"init"})}_clearTimer(){this._status.timer&&(clearInterval(this._status.timer),this._status.timer=null)}_onDataAvailable(f){if(this._status.recordStatus="recording",this.logger.log("MediaRecordHelper: ondataavailable: data received"),!(f.data.size>0))return this.logger.warn("MediaRecordHelper: ondataavailable: no data"),void this.stop();this._status.recordedChunks.push(f.data)}checkIsRecording(){return this._status.isRecording}getRecordStatus(){const f=Object.assign({id:this._status.recordId,type:this._status.mimeType,name:this._status.fileName,status:this._status.recordStatus,isRecording:this._status.isRecording,startTime:this._status.startTime,endTime:this._status.endTime},this._status.option);return this.client.apiFrequencyControl({name:"listMediaRecording",code:0,param:""}),f}destroy(){this._destroy()}}e.Record=h},function(t,e,r){var i=this&&this.__importDefault||function(n){return n&&n.__esModule?n:{default:n}};Object.defineProperty(e,"__esModule",{value:!0}),e.addLegacySimulcast=e.getRtpEncodings=void 0;const a=i(r(6)),l=i(r(8));e.getRtpEncodings=function({offerMediaObject:n}){const c=new Set;for(const u of n.ssrcs||[]){const h=u.id;c.add(h)}if(c.size===0)throw new l.default({code:a.default.UNKNOWN_TYPE_ERROR,message:"getRtpEncodings: a=ssrc 行未找到"});const s=new Map;for(const u of n.ssrcGroups||[]){if(u.semantics!=="FID")continue;let[h,o]=u.ssrcs.split(/\s+/);h=Number(h),o=Number(o),c.has(h)&&(c.delete(h),c.delete(o),s.set(h,o))}for(const u of c)s.set(u,null);const d=[];for(const[u,h]of s){const o={ssrc:u};h&&(o.rtx={ssrc:h}),d.push(o)}return d},e.addLegacySimulcast=function({offerMediaObject:n,numStreams:c}){if(c<=1)throw new TypeError("numStreams must be greater than 1");const s=(n.ssrcs||[]).find(v=>v.attribute==="msid");if(!s)throw new l.default({code:a.default.UNKNOWN_TYPE_ERROR,message:"addLegacySimulcast: a=ssrc 行的 msid 信息未找到"});const[d,u]=s.value.split(" "),h=s.id;let o;(n.ssrcGroups||[]).some(v=>{if(v.semantics!=="FID")return!1;const O=v.ssrcs.split(/\s+/);return Number(O[0])===h&&(o=Number(O[1]),!0)});const f=n.ssrcs.find(v=>v.attribute==="cname").value,m=[],g=[];for(let v=0;v<c;++v)m.push(h+v),o&&g.push(o+v);n.ssrcGroups=[],n.ssrcs=[],n.ssrcGroups.push({semantics:"SIM",ssrcs:m.join(" ")});for(let v=0;v<m.length;++v){const O=m[v];n.ssrcs.push({id:O,attribute:"cname",value:f}),n.ssrcs.push({id:O,attribute:"msid",value:`${d} ${u}`})}for(let v=0;v<g.length;++v){const O=m[v],T=g[v];n.ssrcs.push({id:T,attribute:"cname",value:f}),n.ssrcs.push({id:T,attribute:"msid",value:`${d} ${u}`}),n.ssrcGroups.push({semantics:"FID",ssrcs:`${O} ${T}`})}}},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(h,o,f,m){m===void 0&&(m=f),Object.defineProperty(h,m,{enumerable:!0,get:function(){return o[f]}})}:function(h,o,f,m){m===void 0&&(m=f),h[m]=o[f]}),a=this&&this.__setModuleDefault||(Object.create?function(h,o){Object.defineProperty(h,"default",{enumerable:!0,value:o})}:function(h,o){h.default=o}),l=this&&this.__importStar||function(h){if(h&&h.__esModule)return h;var o={};if(h!=null)for(var f in h)f!=="default"&&Object.prototype.hasOwnProperty.call(h,f)&&i(o,h,f);return a(o,h),o};Object.defineProperty(e,"__esModule",{value:!0}),e.isIosFromRtpStats=e.getNativeRtpCapabilities=e.detectRtcCapabilities=void 0;const n=l(r(50)),c=l(r(88)),s=r(139);let d=null;async function u(){const h=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{h.addTransceiver("audio"),h.addTransceiver("video");const o=await h.createOffer();o!=null&&o.sdp.indexOf("a=rtcp-fb:111")&&o.sdp.indexOf("a=rtcp-fb:111 nack")===-1&&(o.sdp=o.sdp.replace(/(a=rtcp-fb:111.*)/,`$1\r
a=rtcp-fb:111 nack`));let f=!1;try{await h.getStats(()=>{})}catch(O){O.name==="TypeError"&&(f=!0)}try{h.close()}catch{}const m=n.parse(o.sdp),g=c.extractRtpCapabilities({sdpObject:m});s.addNackSuppportForOpus(g);const v={nativeRtpCapabilities:g,isIOS:f};return d=v,v}catch(o){try{h.close()}catch{}throw o}}e.detectRtcCapabilities=u,e.getNativeRtpCapabilities=async function(){d||(d=await u());try{return JSON.parse(JSON.stringify(d.nativeRtpCapabilities))}catch{return d.nativeRtpCapabilities}},e.isIosFromRtpStats=function(){return d==null?void 0:d.isIOS}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.RTCCanvas=void 0;const i=r(85);e.RTCCanvas=class{constructor(a,l){this.isAppend=!1,this.title=a,this.isAppend=l,this.createCanvas()}get _canvas(){return this.canvas}get _ctx(){return this.ctx}createCanvas(){this.canvas=document.createElement("canvas"),this.ctx=i.get2DContext(this.canvas),this.isAppend&&document.body.appendChild(this.canvas)}setSize(a,l){this.canvas&&(this.canvas.width=a,this.canvas.height=l)}destroy(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.isAppend&&document.body.removeChild(this.canvas),this.canvas=null}}},function(t,e,r){t.exports=h;var i,a=r(44),l=a.LongBits,n=a.base64,c=a.utf8;function s(T,C,A){this.fn=T,this.len=C,this.next=void 0,this.val=A}function d(){}function u(T){this.head=T.head,this.tail=T.tail,this.len=T.len,this.next=T.states}function h(){this.len=0,this.head=new s(d,0,0),this.tail=this.head,this.states=null}var o=function(){return a.Buffer?function(){return(h.create=function(){return new i})()}:function(){return new h}};function f(T,C,A){C[A]=255&T}function m(T,C){this.len=T,this.next=void 0,this.val=C}function g(T,C,A){for(;T.hi;)C[A++]=127&T.lo|128,T.lo=(T.lo>>>7|T.hi<<25)>>>0,T.hi>>>=7;for(;T.lo>127;)C[A++]=127&T.lo|128,T.lo=T.lo>>>7;C[A++]=T.lo}function v(T,C,A){C[A]=255&T,C[A+1]=T>>>8&255,C[A+2]=T>>>16&255,C[A+3]=T>>>24}h.create=o(),h.alloc=function(T){return new a.Array(T)},a.Array!==Array&&(h.alloc=a.pool(h.alloc,a.Array.prototype.subarray)),h.prototype._push=function(T,C,A){return this.tail=this.tail.next=new s(T,C,A),this.len+=C,this},m.prototype=Object.create(s.prototype),m.prototype.fn=function(T,C,A){for(;T>127;)C[A++]=127&T|128,T>>>=7;C[A]=T},h.prototype.uint32=function(T){return this.len+=(this.tail=this.tail.next=new m((T>>>=0)<128?1:T<16384?2:T<2097152?3:T<268435456?4:5,T)).len,this},h.prototype.int32=function(T){return T<0?this._push(g,10,l.fromNumber(T)):this.uint32(T)},h.prototype.sint32=function(T){return this.uint32((T<<1^T>>31)>>>0)},h.prototype.uint64=function(T){var C=l.from(T);return this._push(g,C.length(),C)},h.prototype.int64=h.prototype.uint64,h.prototype.sint64=function(T){var C=l.from(T).zzEncode();return this._push(g,C.length(),C)},h.prototype.bool=function(T){return this._push(f,1,T?1:0)},h.prototype.fixed32=function(T){return this._push(v,4,T>>>0)},h.prototype.sfixed32=h.prototype.fixed32,h.prototype.fixed64=function(T){var C=l.from(T);return this._push(v,4,C.lo)._push(v,4,C.hi)},h.prototype.sfixed64=h.prototype.fixed64,h.prototype.float=function(T){return this._push(a.float.writeFloatLE,4,T)},h.prototype.double=function(T){return this._push(a.float.writeDoubleLE,8,T)};var O=a.Array.prototype.set?function(T,C,A){C.set(T,A)}:function(T,C,A){for(var R=0;R<T.length;++R)C[A+R]=T[R]};h.prototype.bytes=function(T){var C=T.length>>>0;if(!C)return this._push(f,1,0);if(a.isString(T)){var A=h.alloc(C=n.length(T));n.decode(T,A,0),T=A}return this.uint32(C)._push(O,C,T)},h.prototype.string=function(T){var C=c.length(T);return C?this.uint32(C)._push(c.write,C,T):this._push(f,1,0)},h.prototype.fork=function(){return this.states=new u(this),this.head=this.tail=new s(d,0,0),this.len=0,this},h.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new s(d,0,0),this.len=0),this},h.prototype.ldelim=function(){var T=this.head,C=this.tail,A=this.len;return this.reset().uint32(A),A&&(this.tail.next=T.next,this.tail=C,this.len+=A),this},h.prototype.finish=function(){for(var T=this.head.next,C=this.constructor.alloc(this.len),A=0;T;)T.fn(T.val,C,A),A+=T.len,T=T.next;return C},h._configure=function(T){i=T,h.create=o(),i._configure()}},function(t,e,r){t.exports=s;var i,a=r(44),l=a.LongBits,n=a.utf8;function c(g,v){return RangeError("index out of range: "+g.pos+" + "+(v||1)+" > "+g.len)}function s(g){this.buf=g,this.pos=0,this.len=g.length}var d,u=typeof Uint8Array<"u"?function(g){if(g instanceof Uint8Array||Array.isArray(g))return new s(g);throw Error("illegal buffer")}:function(g){if(Array.isArray(g))return new s(g);throw Error("illegal buffer")},h=function(){return a.Buffer?function(g){return(s.create=function(v){return a.Buffer.isBuffer(v)?new i(v):u(v)})(g)}:u};function o(){var g=new l(0,0),v=0;if(!(this.len-this.pos>4)){for(;v<3;++v){if(this.pos>=this.len)throw c(this);if(g.lo=(g.lo|(127&this.buf[this.pos])<<7*v)>>>0,this.buf[this.pos++]<128)return g}return g.lo=(g.lo|(127&this.buf[this.pos++])<<7*v)>>>0,g}for(;v<4;++v)if(g.lo=(g.lo|(127&this.buf[this.pos])<<7*v)>>>0,this.buf[this.pos++]<128)return g;if(g.lo=(g.lo|(127&this.buf[this.pos])<<28)>>>0,g.hi=(g.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return g;if(v=0,this.len-this.pos>4){for(;v<5;++v)if(g.hi=(g.hi|(127&this.buf[this.pos])<<7*v+3)>>>0,this.buf[this.pos++]<128)return g}else for(;v<5;++v){if(this.pos>=this.len)throw c(this);if(g.hi=(g.hi|(127&this.buf[this.pos])<<7*v+3)>>>0,this.buf[this.pos++]<128)return g}throw Error("invalid varint encoding")}function f(g,v){return(g[v-4]|g[v-3]<<8|g[v-2]<<16|g[v-1]<<24)>>>0}function m(){if(this.pos+8>this.len)throw c(this,8);return new l(f(this.buf,this.pos+=4),f(this.buf,this.pos+=4))}s.create=h(),s.prototype._slice=a.Array.prototype.subarray||a.Array.prototype.slice,s.prototype.uint32=(d=4294967295,function(){if(d=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128||(d=(d|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)||(d=(d|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)||(d=(d|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)||(d=(d|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128))return d;if((this.pos+=5)>this.len)throw this.pos=this.len,c(this,10);return d}),s.prototype.int32=function(){return 0|this.uint32()},s.prototype.sint32=function(){var g=this.uint32();return g>>>1^-(1&g)|0},s.prototype.bool=function(){return this.uint32()!==0},s.prototype.fixed32=function(){if(this.pos+4>this.len)throw c(this,4);return f(this.buf,this.pos+=4)},s.prototype.sfixed32=function(){if(this.pos+4>this.len)throw c(this,4);return 0|f(this.buf,this.pos+=4)},s.prototype.float=function(){if(this.pos+4>this.len)throw c(this,4);var g=a.float.readFloatLE(this.buf,this.pos);return this.pos+=4,g},s.prototype.double=function(){if(this.pos+8>this.len)throw c(this,4);var g=a.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,g},s.prototype.bytes=function(){var g=this.uint32(),v=this.pos,O=this.pos+g;if(O>this.len)throw c(this,g);return this.pos+=g,Array.isArray(this.buf)?this.buf.slice(v,O):v===O?new this.buf.constructor(0):this._slice.call(this.buf,v,O)},s.prototype.string=function(){var g=this.bytes();return n.read(g,0,g.length)},s.prototype.skip=function(g){if(typeof g=="number"){if(this.pos+g>this.len)throw c(this,g);this.pos+=g}else do if(this.pos>=this.len)throw c(this);while(128&this.buf[this.pos++]);return this},s.prototype.skipType=function(g){switch(g){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(g=7&this.uint32())!=4;)this.skipType(g);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+g+" at offset "+this.pos)}return this},s._configure=function(g){i=g,s.create=h(),i._configure();var v=a.Long?"toLong":"toNumber";a.merge(s.prototype,{int64:function(){return o.call(this)[v](!1)},uint64:function(){return o.call(this)[v](!0)},sint64:function(){return o.call(this).zzDecode()[v](!1)},fixed64:function(){return m.call(this)[v](!0)},sfixed64:function(){return m.call(this)[v](!1)}})}},function(t,e,r){t.exports=a;var i=r(44);function a(l){if(l)for(var n=Object.keys(l),c=0;c<n.length;++c)this[n[c]]=l[n[c]]}a.create=function(l){return this.$type.create(l)},a.encode=function(l,n){return this.$type.encode(l,n)},a.encodeDelimited=function(l,n){return this.$type.encodeDelimited(l,n)},a.decode=function(l){return this.$type.decode(l)},a.decodeDelimited=function(l){return this.$type.decodeDelimited(l)},a.verify=function(l){return this.$type.verify(l)},a.fromObject=function(l){return this.$type.fromObject(l)},a.toObject=function(l,n){return this.$type.toObject(l,n)},a.prototype.toJSON=function(){return this.$type.toObject(this,i.toJSONOptions)}},function(t,e,r){var i=this&&this.__importDefault||function(c){return c&&c.__esModule?c:{default:c}};Object.defineProperty(e,"__esModule",{value:!0}),e.ajax=e.getFormData=void 0;const a=i(r(6)),l=i(r(8)),n=r(81);e.getFormData=c=>Object.keys(c).map(s=>encodeURIComponent(s)+"="+encodeURIComponent(/Object/i.test(c[s])?n.JSONBigStringify(c[s]):c[s])).join("&"),e.ajax=function(c){if(!c||!c.url)return Promise.reject(new l.default({code:a.default.NETWORK_REQUEST_ERROR,message:"ajax: 参数异常"}));c.dataType=c.dataType||"json";var s=new XMLHttpRequest;s.open(c.type||"GET",c.url,!0),s.responseType=""+c.dataType;const d=c.contentType||"application/json;charset=UTF-8";return s.setRequestHeader("Content-type",d),c.header&&Object.keys(c.header).map(u=>{c.header&&c.header[u]&&s.setRequestHeader(u,c.header[u])}),new Promise((u,h)=>{s.onload=function(){if(s.status>400)return Promise.reject(new l.default({code:a.default.NETWORK_REQUEST_ERROR,message:"ajax: 响应异常, code: "+s.status}));var o=s.response;u(o)},s.onerror=function(o){h(o)},s.ontimeout=function(o){h({code:456,desc:"ERR_TIMED_OUT "+c.url})},d.indexOf("x-www-form-urlencoded")>=0?c.data?s.send(e.getFormData(c.data)):s.send():c.data?c.header&&c.header["Content-Encoding"]==="gzip"?s.send(c.data):s.send(n.JSONBigStringify(c.data)):s.send()})}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.audioPlugins=e.videoPlugins=void 0,e.videoPlugins=["VirtualBackground","AdvancedBeauty"],e.audioPlugins=["AIAudioEffects","AIhowling"],e.default=["VirtualBackground","AdvancedBeauty","AIAudioEffects","AIhowling"]},function(t,e,r){function i(n,c){return{ARRAY_BUFFER:n.ARRAY_BUFFER,ELEMENT_ARRAY_BUFFER:n.ELEMENT_ARRAY_BUFFER}[c??"ARRAY_BUFFER"]}function a(n,c){return{STATIC_DRAW:n.STATIC_DRAW,DYNAMIC_DRAW:n.DYNAMIC_DRAW,STREAM_DRAW:n.STREAM_DRAW}[c??"STATIC_DRAW"]}function l(n,c){const s={Int8Array:n.BYTE,Uint8Array:n.UNSIGNED_BYTE,Int16Array:n.SHORT,Uint16Array:n.UNSIGNED_SHORT,Int32Array:n.INT,Uint32Array:n.UNSIGNED_INT,Float32Array:n.FLOAT}[Object.prototype.toString.call(c).replace(/object|\[|\]|\s/g,"")];return s===void 0?(console.warn(`attribute buffer type error.
 legal type may << Int8Array、Uint8Array、Int16Array、Uint16Array、Float32Array.`),n.FLOAT):s}Object.defineProperty(e,"__esModule",{value:!0}),e.parseAttributes=e.createAttributeBuffer=void 0,e.createAttributeBuffer=function(n,c,s,d,u,h,o,f,m){const g=n.createBuffer();if(!g)return console.error("buffer created failed."),null;const v=s.length;return{type:l(n,s),buffer:g,name:c,typedArray:s,itemSize:d??1,count:v/(d??1)>>0,normalized:o!=null&&o,target:i(n,u),usage:a(n,h),stride:f??0,offset:m??0}},e.parseAttributes=function(n,c){const s=n.getProgramParameter(c,n.ACTIVE_ATTRIBUTES),d={};for(let u=0;u<s;u++){const h=n.getActiveAttrib(c,u);if(h){const{name:o}=h,f=n.getAttribLocation(c,o);if(f!==null){const m={type:n.FLOAT,buffer:null,typedArray:null,itemSize:1,count:0,normalized:!1,target:i(n),usage:a(n),stride:0,offset:0,setter:g=>{if(g){const{buffer:v}=m;if(!v)return void console.error(`buffer of attribute:[${o}] is not initialized.`);const{type:O}=m;if(l(n,g)!==O)return void console.error(`typedArray's type of attribute:[${o}] is inconsistent.`);m.typedArray=g;const{itemSize:T,normalized:C,target:A,usage:R,stride:w,offset:k}=m;n.bindBuffer(A,v),n.bufferData(A,g,R),n.enableVertexAttribArray(f),n.vertexAttribPointer(f,T,O,C,w,k)}else{const{buffer:v,type:O,itemSize:T,normalized:C,target:A,stride:R,offset:w}=m;n.bindBuffer(A,v),n.vertexAttribPointer(f,T,O,C,R,w)}},bufferSetter:g=>{if(g){const{name:v}=g;v===o&&(m.type=g.type,m.buffer=g.buffer,m.itemSize=g.itemSize,m.count=g.count,m.normalized=g.normalized,m.target=g.target,m.usage=g.usage,m.stride=g.stride,m.offset=g.offset,m.setter(g.typedArray))}},get attributeBuffer(){return m.buffer===null?null:{type:m.type,buffer:m.buffer,name:o,typedArray:m.typedArray,itemSize:m.itemSize,count:m.count,normalized:m.normalized,target:m.target,usage:m.usage,stride:m.stride,offset:m.offset}}};d[o]=m}else console.warn(`attribute:[${o}] is null.`)}}return d}},,,,,,,,function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.checkSystemRequirements=e.systemChecker=void 0,e.systemChecker=new class{constructor(){this.checkCnt=0}checkSystemRequirements(){this.checkCnt++;const i=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;return i?i.prototype.getSenders&&i.prototype.addTransceiver&&i.prototype.getTransceivers||i.prototype.addStream?!!window.WebSocket||(console.warn("checkSystemRequirements: 没有 WebSocket 对象。"),!1):(console.warn("checkSystemRequirements: RTCPeerConnection不符合sdk要求"),!1):(console.warn("checkSystemRequirements: 没有 RTCPeerConnection 对象。"),!1)}},e.checkSystemRequirements=function(){return e.systemChecker.checkSystemRequirements()}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.AuidoMixingState=void 0,e.AuidoMixingState={UNSTART:"MIX_UNSTART",STARTING:"MIX_STARTING",PLAYED:"MIX_PLAYING",PAUSED:"MIX_PAUSED",STOPED:"MIX_STOPED"}},function(t,e){var r={utf8:{stringToBytes:function(i){return r.bin.stringToBytes(unescape(encodeURIComponent(i)))},bytesToString:function(i){return decodeURIComponent(escape(r.bin.bytesToString(i)))}},bin:{stringToBytes:function(i){for(var a=[],l=0;l<i.length;l++)a.push(255&i.charCodeAt(l));return a},bytesToString:function(i){for(var a=[],l=0;l<i.length;l++)a.push(String.fromCharCode(i[l]));return a.join("")}}};t.exports=r},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(d,u,h,o){o===void 0&&(o=h),Object.defineProperty(d,o,{enumerable:!0,get:function(){return u[h]}})}:function(d,u,h,o){o===void 0&&(o=h),d[o]=u[h]}),a=this&&this.__setModuleDefault||(Object.create?function(d,u){Object.defineProperty(d,"default",{enumerable:!0,value:u})}:function(d,u){d.default=u}),l=this&&this.__importStar||function(d){if(d&&d.__esModule)return d;var u={};if(d!=null)for(var h in d)h!=="default"&&Object.prototype.hasOwnProperty.call(d,h)&&i(u,d,h);return a(u,d),u};Object.defineProperty(e,"__esModule",{value:!0}),e.parseScalabilityMode=e.Device=e.detectDevice=e.version=e.types=void 0;const n=r(168);Object.defineProperty(e,"detectDevice",{enumerable:!0,get:function(){return n.detectDevice}}),Object.defineProperty(e,"Device",{enumerable:!0,get:function(){return n.Device}});const c=l(r(240));e.types=c,e.version="__MEDIASOUP_CLIENT_VERSION__";var s=r(243);Object.defineProperty(e,"parseScalabilityMode",{enumerable:!0,get:function(){return s.parse}})},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(R,w,k,I){I===void 0&&(I=k),Object.defineProperty(R,I,{enumerable:!0,get:function(){return w[k]}})}:function(R,w,k,I){I===void 0&&(I=k),R[I]=w[k]}),a=this&&this.__setModuleDefault||(Object.create?function(R,w){Object.defineProperty(R,"default",{enumerable:!0,value:w})}:function(R,w){R.default=w}),l=this&&this.__importStar||function(R){if(R&&R.__esModule)return R;var w={};if(R!=null)for(var k in R)k!=="default"&&Object.prototype.hasOwnProperty.call(R,k)&&i(w,R,k);return a(w,R),w};Object.defineProperty(e,"__esModule",{value:!0}),e.Device=e.detectDevice=void 0;const n=r(86),c=r(78),s=r(222),d=r(230),u=r(236),h=r(237),o=r(29),f=l(r(79)),m=r(171),g=l(r(27)),v=l(r(7)),O=r(77),T=r(149),C="Device";function A(){return typeof navigator=="object"&&typeof navigator.userAgent=="string"?v.IS_CHROME_ONLY&&v.CHROME_MAJOR_VERSION&&v.CHROME_MAJOR_VERSION>=58&&v.CHROME_MAJOR_VERSION<69?"Chrome58":v.IS_CHROME_ONLY&&v.CHROME_MAJOR_VERSION&&v.CHROME_MAJOR_VERSION>=69||v.IS_EDG&&v.IS_CHROME_ONLY&&v.ANY_CHROME_MAJOR_VERSION&&v.ANY_CHROME_MAJOR_VERSION>=69?"Chrome74":v.IS_ANDROID?v.ANY_CHROME_MAJOR_VERSION&&v.ANY_CHROME_MAJOR_VERSION>=58&&v.ANY_CHROME_MAJOR_VERSION<69?"Chrome58":"Chrome74":v.IS_ELECTRON&&v.IS_CHROME_ONLY&&v.ANY_CHROME_MAJOR_VERSION&&v.ANY_CHROME_MAJOR_VERSION>=69?"Chrome74":v.IS_FIREFOX&&v.FIREFOX_MAJOR_VERSION&&v.FIREFOX_MAJOR_VERSION>=58?"Firefox60":v.IS_ANY_SAFARI&&v.SAFARI_MAJOR_VERSION&&v.SAFARI_MAJOR_VERSION>=12||v.IS_ANY_SAFARI&&v.IS_WECHAT||T.isIosFromRtpStats()?"Safari12":(o.Logger.warn(C,"this._detectDevice() | browser not supported [name:%s, version:%s], using Chrome72 as default",O.getBrowserInfo().browserName,O.getBrowserInfo().browserVersion),"Chrome74"):(o.Logger.warn(C,"this._detectDevice() | unknown device, using Chrome 72 as default"),"Chrome74")}e.detectDevice=A,e.Device=class{constructor({handlerName:R,handlerFactory:w,Handler:k}={}){if(this._loaded=!1,this._observer=new n.EnhancedEventEmitter,o.Logger.debug(C,"constructor()"),k){if(o.Logger.warn(C,"constructor() | Handler option is DEPRECATED, use handlerName or handlerFactory instead"),typeof k!="string")throw new TypeError("non string Handler option no longer supported, use handlerFactory instead");R=k}if(R&&w)throw new TypeError("just one of handlerName or handlerInterface can be given");if(w)this._handlerFactory=w;else{if(R)o.Logger.debug(C,"constructor() | handler given: %s",R);else{if(!(R=A()))throw new c.UnsupportedError("device not supported");o.Logger.debug(C,"constructor() | detected handler: %s",R)}switch(R){case"Chrome58":this._handlerFactory=d.Chrome58.createFactory();break;case"Chrome74":this._handlerFactory=s.Chrome74.createFactory();break;case"Safari12":this._handlerFactory=h.Safari12.createFactory();break;case"Firefox60":this._handlerFactory=u.Firefox60.createFactory();break;default:o.Logger.warn(`unknown browser handlerName "${R}, using Chrome 74 as default"`),this._handlerFactory=s.Chrome74.createFactory()}}const I=this._handlerFactory();this._handlerName=I.name,I.close(),this._extendedRtpCapabilities=void 0,this._recvRtpCapabilities=void 0,this._canProduceByKind={audio:!1,video:!1},this._sctpCapabilities=void 0}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new c.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new c.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}async load({routerRtpCapabilities:R}){let w;o.Logger.debug(C,"load()"),R=g.clone(R,void 0);try{if(this._loaded)throw new c.InvalidStateError("already loaded");f.validateRtpCapabilities(R),w=this._handlerFactory();const k=await w.getNativeRtpCapabilities();o.Logger.debug(C,"load() | got native RTP capabilities"),f.validateRtpCapabilities(k),this._extendedRtpCapabilities=f.getExtendedRtpCapabilities(k,R),o.Logger.debug(C,"load() | got extended RTP capabilities"),this._canProduceByKind.audio=f.canSend("audio",this._extendedRtpCapabilities),this._canProduceByKind.video=f.canSend("video",this._extendedRtpCapabilities),this._recvRtpCapabilities=f.getRecvRtpCapabilities(this._extendedRtpCapabilities),f.validateRtpCapabilities(this._recvRtpCapabilities),o.Logger.debug(C,"load() | got receiving RTP capabilities"),this._sctpCapabilities=await w.getNativeSctpCapabilities(),o.Logger.debug(C,"load() | got native SCTP capabilities"),f.validateSctpCapabilities(this._sctpCapabilities),o.Logger.debug(C,"load() succeeded"),this._loaded=!0,w.close()}catch(k){throw w&&w.close(),k}}canProduce(R){if(!this._loaded)throw new c.InvalidStateError("not loaded");if(R!=="audio"&&R!=="video")throw new TypeError(`invalid kind "${R}"`);return this._canProduceByKind[R]}createSendTransport({id:R,iceParameters:w,iceCandidates:k,dtlsParameters:I,sctpParameters:M,iceServers:P,iceTransportPolicy:S,additionalSettings:y,proprietaryConstraints:_,appData:b={}}){return o.Logger.debug(C,"createSendTransport()"),this._createTransport({direction:"send",id:R,iceParameters:w,iceCandidates:k,dtlsParameters:I,sctpParameters:M,iceServers:P,iceTransportPolicy:S,additionalSettings:y,proprietaryConstraints:_,appData:b})}createRecvTransport({id:R,iceParameters:w,iceCandidates:k,dtlsParameters:I,sctpParameters:M,iceServers:P,iceTransportPolicy:S,additionalSettings:y,proprietaryConstraints:_,appData:b={}}){return o.Logger.debug(C,"createRecvTransport()"),this._createTransport({direction:"recv",id:R,iceParameters:w,iceCandidates:k,dtlsParameters:I,sctpParameters:M,iceServers:P,iceTransportPolicy:S,additionalSettings:y,proprietaryConstraints:_,appData:b})}_createTransport({direction:R,id:w,iceParameters:k,iceCandidates:I,dtlsParameters:M,sctpParameters:P,iceServers:S,iceTransportPolicy:y,additionalSettings:_,proprietaryConstraints:b,appData:E={}}){if(!this._loaded)throw new c.InvalidStateError("not loaded");if(E&&typeof E!="object")throw new TypeError("if given, appData must be an object");const x=new m.Transport({direction:R,id:w,iceParameters:k,iceCandidates:I,dtlsParameters:M,sctpParameters:P,iceServers:S,iceTransportPolicy:y,additionalSettings:_,proprietaryConstraints:b,appData:E,handlerFactory:this._handlerFactory,extendedRtpCapabilities:this._extendedRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",x),x}}},function(t,e,r){var i,a=typeof Reflect=="object"?Reflect:null,l=a&&typeof a.apply=="function"?a.apply:function(T,C,A){return Function.prototype.apply.call(T,C,A)};i=a&&typeof a.ownKeys=="function"?a.ownKeys:Object.getOwnPropertySymbols?function(T){return Object.getOwnPropertyNames(T).concat(Object.getOwnPropertySymbols(T))}:function(T){return Object.getOwnPropertyNames(T)};var n=Number.isNaN||function(T){return T!=T};function c(){c.init.call(this)}t.exports=c,t.exports.once=function(T,C){return new Promise(function(A,R){function w(I){T.removeListener(C,k),R(I)}function k(){typeof T.removeListener=="function"&&T.removeListener("error",w),A([].slice.call(arguments))}O(T,C,k,{once:!0}),C!=="error"&&function(I,M,P){typeof I.on=="function"&&O(I,"error",M,P)}(T,w,{once:!0})})},c.EventEmitter=c,c.prototype._events=void 0,c.prototype._eventsCount=0,c.prototype._maxListeners=void 0;var s=10;function d(T){if(typeof T!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof T)}function u(T){return T._maxListeners===void 0?c.defaultMaxListeners:T._maxListeners}function h(T,C,A,R){var w,k,I,M;if(d(A),(k=T._events)===void 0?(k=T._events=Object.create(null),T._eventsCount=0):(k.newListener!==void 0&&(T.emit("newListener",C,A.listener?A.listener:A),k=T._events),I=k[C]),I===void 0)I=k[C]=A,++T._eventsCount;else if(typeof I=="function"?I=k[C]=R?[A,I]:[I,A]:R?I.unshift(A):I.push(A),(w=u(T))>0&&I.length>w&&!I.warned){I.warned=!0;var P=new Error("Possible EventEmitter memory leak detected. "+I.length+" "+String(C)+" listeners added. Use emitter.setMaxListeners() to increase limit");P.name="MaxListenersExceededWarning",P.emitter=T,P.type=C,P.count=I.length,M=P,console&&console.warn&&console.warn(M)}return T}function o(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function f(T,C,A){var R={fired:!1,wrapFn:void 0,target:T,type:C,listener:A},w=o.bind(R);return w.listener=A,R.wrapFn=w,w}function m(T,C,A){var R=T._events;if(R===void 0)return[];var w=R[C];return w===void 0?[]:typeof w=="function"?A?[w.listener||w]:[w]:A?function(k){for(var I=new Array(k.length),M=0;M<I.length;++M)I[M]=k[M].listener||k[M];return I}(w):v(w,w.length)}function g(T){var C=this._events;if(C!==void 0){var A=C[T];if(typeof A=="function")return 1;if(A!==void 0)return A.length}return 0}function v(T,C){for(var A=new Array(C),R=0;R<C;++R)A[R]=T[R];return A}function O(T,C,A,R){if(typeof T.on=="function")R.once?T.once(C,A):T.on(C,A);else{if(typeof T.addEventListener!="function")throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof T);T.addEventListener(C,function w(k){R.once&&T.removeEventListener(C,w),A(k)})}}Object.defineProperty(c,"defaultMaxListeners",{enumerable:!0,get:function(){return s},set:function(T){if(typeof T!="number"||T<0||n(T))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+T+".");s=T}}),c.init=function(){this._events!==void 0&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},c.prototype.setMaxListeners=function(T){if(typeof T!="number"||T<0||n(T))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+T+".");return this._maxListeners=T,this},c.prototype.getMaxListeners=function(){return u(this)},c.prototype.emit=function(T){for(var C=[],A=1;A<arguments.length;A++)C.push(arguments[A]);var R=T==="error",w=this._events;if(w!==void 0)R=R&&w.error===void 0;else if(!R)return!1;if(R){var k;if(C.length>0&&(k=C[0]),k instanceof Error)throw k;var I=new Error("Unhandled error."+(k?" ("+k.message+")":""));throw I.context=k,I}var M=w[T];if(M===void 0)return!1;if(typeof M=="function")l(M,this,C);else{var P=M.length,S=v(M,P);for(A=0;A<P;++A)l(S[A],this,C)}return!0},c.prototype.addListener=function(T,C){return h(this,T,C,!1)},c.prototype.on=c.prototype.addListener,c.prototype.prependListener=function(T,C){return h(this,T,C,!0)},c.prototype.once=function(T,C){return d(C),this.on(T,f(this,T,C)),this},c.prototype.prependOnceListener=function(T,C){return d(C),this.prependListener(T,f(this,T,C)),this},c.prototype.removeListener=function(T,C){var A,R,w,k,I;if(d(C),(R=this._events)===void 0)return this;if((A=R[T])===void 0)return this;if(A===C||A.listener===C)--this._eventsCount==0?this._events=Object.create(null):(delete R[T],R.removeListener&&this.emit("removeListener",T,A.listener||C));else if(typeof A!="function"){for(w=-1,k=A.length-1;k>=0;k--)if(A[k]===C||A[k].listener===C){I=A[k].listener,w=k;break}if(w<0)return this;w===0?A.shift():function(M,P){for(;P+1<M.length;P++)M[P]=M[P+1];M.pop()}(A,w),A.length===1&&(R[T]=A[0]),R.removeListener!==void 0&&this.emit("removeListener",T,I||C)}return this},c.prototype.off=c.prototype.removeListener,c.prototype.removeAllListeners=function(T){var C,A,R;if((A=this._events)===void 0)return this;if(A.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):A[T]!==void 0&&(--this._eventsCount==0?this._events=Object.create(null):delete A[T]),this;if(arguments.length===0){var w,k=Object.keys(A);for(R=0;R<k.length;++R)(w=k[R])!=="removeListener"&&this.removeAllListeners(w);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(typeof(C=A[T])=="function")this.removeListener(T,C);else if(C!==void 0)for(R=C.length-1;R>=0;R--)this.removeListener(T,C[R]);return this},c.prototype.listeners=function(T){return m(this,T,!0)},c.prototype.rawListeners=function(T){return m(this,T,!1)},c.listenerCount=function(T,C){return typeof T.listenerCount=="function"?T.listenerCount(C):g.call(T,C)},c.prototype.listenerCount=g,c.prototype.eventNames=function(){return this._eventsCount>0?i(this._events):[]}},function(t,e){var r=t.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(i){return i.encoding?"rtpmap:%d %s/%s/%s":i.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(i){return i.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(i){return i.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(i){return"extmap:%d"+(i.direction?"/%s":"%v")+(i["encrypt-uri"]?" %s":"%v")+" %s"+(i.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(i){return i.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(i){var a="candidate:%s %d %s %d %s %d typ %s";return a+=i.raddr!=null?" raddr %s rport %d":"%v%v",a+=i.tcptype!=null?" tcptype %s":"%v",i.generation!=null&&(a+=" generation %d"),a+=i["network-id"]!=null?" network-id %d":"%v",a+=i["network-cost"]!=null?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(i){var a="ssrc:%d";return i.attribute!=null&&(a+=" %s",i.value!=null&&(a+=":%s")),a}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(i){return i.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(i){return i.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(i){return"imageattr:%s %s %s"+(i.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(i){return"simulcast:%s %s"+(i.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(i){return"ts-refclk:%s"+(i.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(i){var a="mediaclk:";return a+=i.id!=null?"id=%s %s":"%v%s",a+=i.mediaClockValue!=null?"=%s":"",a+=i.rateNumerator!=null?" rate=%s":"",a+=i.rateDenominator!=null?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(r).forEach(function(i){r[i].forEach(function(a){a.reg||(a.reg=/(.*)/),a.format||(a.format="%s")})})},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(C,A,R,w){w===void 0&&(w=R),Object.defineProperty(C,w,{enumerable:!0,get:function(){return A[R]}})}:function(C,A,R,w){w===void 0&&(w=R),C[w]=A[R]}),a=this&&this.__setModuleDefault||(Object.create?function(C,A){Object.defineProperty(C,"default",{enumerable:!0,value:A})}:function(C,A){C.default=A}),l=this&&this.__importStar||function(C){if(C&&C.__esModule)return C;var A={};if(C!=null)for(var R in C)R!=="default"&&Object.prototype.hasOwnProperty.call(C,R)&&i(A,C,R);return a(A,C),A};Object.defineProperty(e,"__esModule",{value:!0}),e.Transport=void 0;const n=r(239),c=l(r(7)),s=r(1),d=r(172),u=r(86),h=r(78),o=r(29),f=l(r(79)),m=r(173),g=l(r(27)),v="Transport";let O=0;class T extends u.EnhancedEventEmitter{constructor({direction:A,id:R,iceParameters:w,iceCandidates:k,dtlsParameters:I,sctpParameters:M,iceServers:P,iceTransportPolicy:S,additionalSettings:y,proprietaryConstraints:_,appData:b,handlerFactory:E,extendedRtpCapabilities:x,canProduceByKind:D}){super(),this.idx=++O,this._closed=!1,this._iceGatheringState="new",this._connectionState="new",this._producers=new Map,this._consumers=new Map,this._probatorConsumerCreated=!1,this._awaitQueue=new n.AwaitQueue({ClosedErrorClass:h.InvalidStateError}),this._observer=new u.EnhancedEventEmitter,this.send=[],this.recv=[],o.Logger.debug(v,`constructor() [id: ${R}, direction: ${A}]`),this._id=R,this._direction=A,this._extendedRtpCapabilities=x,this._canProduceByKind=D,this._maxSctpMessageSize=M?M.maxMessageSize:null,delete(y=g.clone(y,{})).iceServers,delete y.iceTransportPolicy,delete y.bundlePolicy,delete y.rtcpMuxPolicy,delete y.sdpSemantics,this._handler=E(),this._handler.run({direction:A,iceParameters:w,iceCandidates:k,dtlsParameters:I,sctpParameters:M,iceServers:P,iceTransportPolicy:S,additionalSettings:y,proprietaryConstraints:_,extendedRtpCapabilities:x,appData:b}),this._appData=b,this._handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get iceGatheringState(){return this._iceGatheringState}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(A){}get observer(){return this._observer}close(){if(!this._closed){o.Logger.debug(v,"close()"),this._closed=!0,this._awaitQueue.close(),this._handler.close();for(const A of this._producers.values())A.transportClosed();this._producers.clear();for(const A of this._consumers.values())A.transportClosed();this._consumers.clear(),this._observer.safeEmit("close")}}async getStats(){if(this._closed)throw new h.InvalidStateError("closed");return this._handler.getTransportStats()}async restartIce({iceParameters:A}){if(o.Logger.debug(v,"restartIce()"),this._closed)throw new h.InvalidStateError("closed");if(!A)throw new TypeError("missing iceParameters");return this._awaitQueue.push(async()=>this._handler.restartIce(A),"transport.restartIce()")}async updateIceServers({iceServers:A}={}){if(o.Logger.debug(v,"updateIceServers()"),this._closed)throw new h.InvalidStateError("closed");if(!Array.isArray(A))throw new TypeError("missing iceServers");return this._handler.updateIceServers(A)}async produce({track:A,trackLow:R,encodings:w,codecOptions:k,codec:I,stopTracks:M=!1,disableTrackOnPause:P=!0,zeroRtpOnPause:S=!1,appData:y}){if(o.Logger.debug(v,"produce()"),!A)throw new TypeError("missing track");if(this._direction!=="send")throw new h.UnsupportedError("not a sending Transport");if(!this._canProduceByKind[A.kind])throw new h.UnsupportedError("cannot produce "+A.kind);if(A.readyState==="ended")throw new h.InvalidStateError("track ended");if(this.listenerCount("produce")===0)throw new TypeError('no "produce" listener set into this transport');if(y&&typeof y!="object")throw new TypeError("if given, appData must be an object");return this._awaitQueue.push(async()=>{let _;if(w&&!Array.isArray(w))throw TypeError("encodings must be an array");w&&w.length===0?_=void 0:w&&(_=w.map(L=>{const U={active:!0};return L.active===!1&&(U.active=!1),typeof L.dtx=="boolean"&&(U.dtx=L.dtx),typeof L.scalabilityMode=="string"&&(U.scalabilityMode=L.scalabilityMode),typeof L.scaleResolutionDownBy=="number"&&(U.scaleResolutionDownBy=L.scaleResolutionDownBy),typeof L.maxBitrate=="number"&&(U.maxBitrate=L.maxBitrate),typeof L.maxFramerate=="number"&&(U.maxFramerate=L.maxFramerate),typeof L.adaptivePtime=="boolean"&&(U.adaptivePtime=L.adaptivePtime),typeof L.priority=="string"&&(U.priority=L.priority),typeof L.networkPriority=="string"&&(U.networkPriority=L.networkPriority),U}));const{localId:b,localIdLow:E,rtpParameters:x,rtpSender:D,rtpSenderLow:F,dtlsParameters:V,offer:N}=await this._handler.send({track:A,trackLow:R,encodings:_,codecOptions:k,appData:y,codec:I});D&&this.updateSenderInfo(D,y.mediaType==="screenShare"?"screen":y.mediaType,"high",b),F&&E&&this.updateSenderInfo(F,y.mediaType==="screenShare"?"screen":y.mediaType,"low",E);try{f.validateRtpParameters(x);const{id:L}=await this.safeEmitAsPromise("produce",{kind:A.kind,rtpParameters:x,track:A,trackLow:R,appData:y,localDtlsParameters:V,offer:N}),U=new m.Producer({id:L,localId:b,localIdLow:E,rtpSender:D,rtpSenderLow:F,track:A,trackLow:R,rtpParameters:x,stopTracks:M,disableTrackOnPause:P,zeroRtpOnPause:S,appData:y});return this._producers.set(U.id,U),this._handleProducer(U),this._observer.safeEmit("newproducer",U),U}catch(L){throw this._handler.stopSending(b,y.mediaType).catch(()=>{}),L}},"transport.produce()").catch(_=>{throw _})}async fillRemoteRecvSdp({kind:A,appData:R,iceParameters:w,iceCandidates:k,dtlsParameters:I,sctpParameters:M,sendingRtpParameters:P,codecOptions:S,offer:y,audioProfile:_,codec:b,resetVideoSdp:E=!1}){await this._handler.fillRemoteRecvSdp({kind:A,appData:R,iceParameters:w,iceCandidates:k,dtlsParameters:I,sctpParameters:M,sendingRtpParameters:P,codecOptions:S,offer:y,codec:b,audioProfile:_,resetVideoSdp:E})}async prepareLocalSdp(A,R,w){try{const{dtlsParameters:k,rtpCapabilities:I,offer:M,mid:P,iceUfragReg:S}=await this._handler.prepareLocalSdp(A,w);if(!this._recvRtpCapabilities||!f.canSend("audio",this._recvRtpCapabilities)||!f.canSend("video",this._recvRtpCapabilities)){let y=f.getExtendedRtpCapabilities(I,R);this._recvRtpCapabilities=f.getRecvRtpCapabilities(y),f.validateRtpCapabilities(this._recvRtpCapabilities)}return{dtlsParameters:k,rtpCapabilities:this._recvRtpCapabilities,offer:M,mid:P,iceUfragReg:S}}catch(k){throw k}}async recoverLocalSdp(A,R,w){if(!(c.ANY_CHROME_MAJOR_VERSION&&c.ANY_CHROME_MAJOR_VERSION>=58&&c.ANY_CHROME_MAJOR_VERSION<69))try{return void await this._handler.recoverTransceiver(A,R,w)}catch(k){throw k}}updateSenderInfo(A,R,w,k){let I=this.send.find(M=>M.sender===A);return I?(I.mediaType!==R||I.streamType||w||I.localId!==k)&&(o.Logger.debug(v,`Sender Change. mediaType:${I.mediaType} => ${R}, StreamType: ${I.streamType} => ${w}, LocalId: ${I.localId} => ${k} index: ${I.index}`),I.mediaType=R,I.streamType=w,I.localId=k,I.index=0):(I={sender:A,mediaType:R,streamType:w,localId:k,index:0},this.send.unshift(I)),I}updateReceiverInfo(A,R,w,k){let I=this.recv.find(M=>M.receiver===A);return I?I.uid===R&&I.mediaType===w&&I.localId===k||(o.Logger.debug(v,`Receiver Change. uid:${I.uid} => ${R}, mediaType:${I.mediaType} => ${w} localId: ${I.localId} => ${k} index: ${I.index}`),I.uid=R,I.mediaType=w,I.localId=k,I.index=0):(I={receiver:A,uid:R,mediaType:w,localId:k,index:0},this.recv.unshift(I)),I}async consume({id:A,producerId:R,kind:w,uid:k,mediaType:I,rtpParameters:M,appData:P={},offer:S,iceParameters:y,iceCandidates:_,dtlsParameters:b,sctpParameters:E,probeSSrc:x}){if(o.Logger.debug(v,"consume()"),M=g.clone(M,void 0),this._closed)throw new h.InvalidStateError("closed");if(this._direction!=="recv")throw new h.UnsupportedError("not a receiving Transport");if(typeof A!="string")throw new TypeError("missing id");if(typeof R!="string")throw new TypeError("missing producerId");if(w!=="audio"&&w!=="video")throw new TypeError(`invalid kind '${w}'`);if(P&&typeof P!="object")throw new TypeError("if given, appData must be an object");return this._awaitQueue.push(async()=>{const{localId:D,rtpReceiver:F,track:V}=await this._handler.receive({iceParameters:y,iceCandidates:_,dtlsParameters:b,sctpParameters:E,trackId:A,kind:w,rtpParameters:M,offer:S,probeSSrc:x,remoteUid:P.remoteUid,extendedRtpCapabilities:this._extendedRtpCapabilities,appData:P});F&&(this.updateReceiverInfo(F,k,I,D),F.track.kind==="audio"&&s.getParameters().audioPlayoutDelayHint&&(F.playoutDelayHint=s.getParameters().audioPlayoutDelayHint,o.Logger.debug(v,"audioPlayoutDelayHint: ",s.getParameters().audioPlayoutDelayHint)),F.track.kind==="video"&&s.getParameters().videoPlayoutDelayHint&&(F.playoutDelayHint=s.getParameters().videoPlayoutDelayHint,o.Logger.debug(v,"videoPlayoutDelayHint: ",s.getParameters().videoPlayoutDelayHint)));const N=new d.Consumer({id:A,localId:D,producerId:R,rtpReceiver:F,track:V,rtpParameters:M,appData:P});return this._consumers.set(N.id,N),this._handleConsumer(N),this._observer.safeEmit("newconsumer",N),N},"transport.consume()")}_handleHandler(){const A=this._handler;A.on("@connect",({dtlsParameters:R},w,k)=>{this._closed?k(new h.InvalidStateError("closed")):this.safeEmit("connect",{dtlsParameters:R},w,k)}),A.on("@icegatheringstatechange",R=>{R!==this._iceGatheringState&&(o.Logger.debug(v,"ICE gathering state changed to %s",R),this._iceGatheringState=R,this._closed||this.safeEmit("icegatheringstatechange",R))}),A.on("@connectionstatechange",R=>{R!==this._connectionState&&(o.Logger.debug(v,"connection state changed to %s",R),this._connectionState=R,this._closed||this.safeEmit("connectionstatechange",R))})}_handleProducer(A){A.on("@close",()=>{this._closed||(o.Logger.debug(v,"producer 关闭: ",A.localId),this._awaitQueue.push(async()=>this._handler.stopSending(A.localId,A.appData.mediaType)).catch(R=>o.Logger.warn(v,"producer.close() failed:%o",R)))}),A.on("@replacetrack",(R,w,k)=>{this._awaitQueue.push(async()=>this._handler.replaceTrack(A.localId,R),"producer @replacetrack event").then(w).catch(k)}),A.on("@setmaxspatiallayer",(R,w,k)=>{this._awaitQueue.push(async()=>this._handler.setMaxSpatialLayer(A.localId,R),"producer @setmaxspatiallayer event").then(w).catch(k)}),A.on("@setrtpencodingparameters",(R,w,k)=>{this._awaitQueue.push(async()=>this._handler.setRtpEncodingParameters(A.localId,R),"producer @setrtpencodingparameters event").then(w).catch(k)}),A.on("@getstats",(R,w)=>{if(this._closed)return w(new h.InvalidStateError("closed"));this._handler.getSenderStats(A.localId).then(R).catch(w)})}_handleConsumer(A){A.on("@close",()=>{this._consumers.delete(A.id),this._closed||this._awaitQueue.push(async()=>this._handler.stopReceiving(A.localId),"consumer @close event").catch(()=>{})}),A.on("@getstats",(R,w)=>{if(this._closed)return w(new h.InvalidStateError("closed"));this._handler.getReceiverStats(A.localId).then(R).catch(w)})}}e.Transport=T},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.Consumer=void 0;const i=r(86),a=r(78),l=r(29),n="Consumer";class c extends i.EnhancedEventEmitter{constructor({id:d,localId:u,producerId:h,rtpReceiver:o,track:f,rtpParameters:m,appData:g}){super(),this._closed=!1,this._observer=new i.EnhancedEventEmitter,l.Logger.debug(n,"constructor()"),this._id=d,this._localId=u,this._producerId=h,this._rtpReceiver=o,this._track=f,this._rtpParameters=m,this._paused=!f.enabled,this._appData=g,this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(d){}get observer(){return this._observer}close(){this._closed||(l.Logger.debug(n,"close()"),this._closed=!0,this._destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(l.Logger.debug(n,"transportClosed()"),this._closed=!0,this._destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new a.InvalidStateError("closed");return this.safeEmitAsPromise("@getstats")}pause(){l.Logger.debug(n,"pause()"),this._closed?l.Logger.error(n,"pause() | Consumer closed"):this._paused?l.Logger.debug("pause() | Consumer is already paused"):(this._paused=!0,this._track.enabled=!1,this._observer.safeEmit("pause"))}resume(){l.Logger.debug(n,"resume()"),this._closed?l.Logger.error(n,"resume() | Consumer closed"):this._paused?(this._paused=!1,this._track.enabled=!0,this._observer.safeEmit("resume")):l.Logger.debug("resume() | Consumer is already resumed")}_onTrackEnded(){l.Logger.debug(n,'track "ended" event, %o, %s',this.id,this.kind),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}_handleTrack(){this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){l.Logger.debug(n,"don not stop receiver track")}}e.Consumer=c},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(f,m,g,v){v===void 0&&(v=g),Object.defineProperty(f,v,{enumerable:!0,get:function(){return m[g]}})}:function(f,m,g,v){v===void 0&&(v=g),f[v]=m[g]}),a=this&&this.__setModuleDefault||(Object.create?function(f,m){Object.defineProperty(f,"default",{enumerable:!0,value:m})}:function(f,m){f.default=m}),l=this&&this.__importStar||function(f){if(f&&f.__esModule)return f;var m={};if(f!=null)for(var g in f)g!=="default"&&Object.prototype.hasOwnProperty.call(f,g)&&i(m,f,g);return a(m,f),m};Object.defineProperty(e,"__esModule",{value:!0}),e.Producer=void 0;const n=l(r(7)),c=r(1),s=r(86),d=r(78),u=r(29),h="Producer";class o extends s.EnhancedEventEmitter{constructor({id:m,localId:g,localIdLow:v,rtpSender:O,rtpSenderLow:T,track:C,trackLow:A,rtpParameters:R,stopTracks:w,disableTrackOnPause:k,zeroRtpOnPause:I,appData:M}){super(),this._closed=!1,this._observer=new s.EnhancedEventEmitter,u.Logger.debug(h,"constructor()",g),this._id=m,this._localId=g,this._localIdLow=v,this._rtpSender=O,this._rtpSenderLow=T,this._track=C,this._trackLow=A,this._kind=C.kind,this._rtpParameters=R,this._paused=!!k&&!C.enabled,this._maxSpatialLayer=void 0,this._stopTracks=w,this._disableTrackOnPause=k,this._zeroRtpOnPause=I,this._appData=M,this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(m){}get observer(){return this._observer}close(){this._closed||(u.Logger.debug(h,"close()"),this._closed=!0,this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(u.Logger.debug(h,"transportClosed()"),this._closed=!0,this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new d.InvalidStateError("closed");return this.safeEmitAsPromise("@getstats")}pause(){u.Logger.debug(h,"pause()"),this._closed?u.Logger.error(h,"pause() | Producer closed"):(this._paused=!0,n.SAFARI_VERSION&&parseFloat(n.SAFARI_VERSION)===15.1||this._disableTrackOnPause&&(this._track&&(this._track.enabled=!1),this._trackLow&&(this._trackLow.enabled=!1)),this._zeroRtpOnPause&&this.safeEmitAsPromise("@replacetrack",null).catch(()=>{}),this._observer.safeEmit("pause"))}resume(){u.Logger.debug(h,"resume()"),this._closed?u.Logger.error(h,"resume() | Producer closed"):(this._paused=!1,this._disableTrackOnPause&&(this._track&&(this._track.enabled=!0),this._trackLow&&(this._trackLow.enabled=!0)),this._zeroRtpOnPause&&this.safeEmitAsPromise("@replacetrack",this._track).catch(()=>{}),this._observer.safeEmit("resume"))}async replaceTrack({track:m}){if(u.Logger.debug(h,"replaceTrack()"),this._closed){if(m&&this._stopTracks)try{if(m.kind==="audio"){const g=c.getParameters().tracks.audio.findIndex(v=>m===v);u.Logger.warn(`Stopping AUDIOTRACK#${g} ${m.id}, ${m.label}, ${m.readyState}`)}else{const g=c.getParameters().tracks.video.findIndex(v=>m===v);u.Logger.warn(`Stopping VIDEOTRACK#${g} ${m.id}, ${m.label}, ${m.readyState}`)}m.stop()}catch{}throw new d.InvalidStateError("closed")}if(m&&m.readyState==="ended")throw new d.InvalidStateError("track ended");m!==this._track?(this._zeroRtpOnPause&&this._paused||await this.safeEmitAsPromise("@replacetrack",m),this._destroyTrack(),this._track=m,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this._handleTrack()):u.Logger.debug(h,"replaceTrack() | same track, ignored")}async setMaxSpatialLayer(m){if(this._closed)throw new d.InvalidStateError("closed");if(this._kind!=="video")throw new d.UnsupportedError("not a video Producer");if(typeof m!="number")throw new TypeError("invalid spatialLayer");m!==this._maxSpatialLayer&&(await this.safeEmitAsPromise("@setmaxspatiallayer",m),this._maxSpatialLayer=m)}async setRtpEncodingParameters(m){if(this._closed)throw new d.InvalidStateError("closed");if(typeof m!="object")throw new TypeError("invalid params");await this.safeEmitAsPromise("@setrtpencodingparameters",m)}_onTrackEnded(){u.Logger.debug(h,'track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}_handleTrack(){this._track&&this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){this._track&&u.Logger.warn(h,"don not stop sender track")}}e.Producer=o},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.getRTCTimer=void 0;const i=r(90);class a{constructor(s={from:{native:!0,worker:!0,webAudio:!0},minInterval:8}){this.history=[],this.timers=[void 0],this.worker=null,this.options=s;const d=u=>{const h={source:u,ts:Date.now()},o=this.history[this.history.length-1];if(!(o&&h.ts-o.ts<this.options.minInterval)){this.history.push(h),this.history.length>1e3&&this.history.shift();for(let f=0;f<this.timers.length;f++){const m=this.timers[f];if(m&&!(m.cntMax<=m.cnt||h.ts-m.lastCalledAt<m.interval-1)){m.cnt++,m.lastCalledAt=h.ts;try{m.handler()}catch(g){console.error(g)}}}}};if(s.from.native&&(this.nativeTimer=setInterval(()=>{d("native")},this.options.minInterval)),s.from.worker&&typeof Worker!==void 0)try{this.worker=new Worker(i.getBlobUrl("rtcTimer")),this.worker.onmessage=()=>{d("worker")}}catch(u){console.warn("无法启动RTCTimer/Worker Timer。页面在后台运行时计时可能不准",u.name,u.message)}}setInterval(s,d){const u={handler:s,id:this.timers.length,interval:d,lastCalledAt:Date.now(),cnt:0,cntMax:Number.MAX_SAFE_INTEGER};return this.timers.push(u),u.id}clearInterval(s){if(!s)return;const d=this.timers[s];d&&(d.id===s?delete this.timers[s]:console.error("timer错位",s,d))}}let l=null;function n(){return l||(l=new a),l}e.getRTCTimer=n},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.AudioLevel=void 0;const i=r(3),a=r(90),l=r(47);let n="NOTREADY",c=null;class s extends i.EventEmitter{constructor(u){super(),this.volume=0,this.left=null,this.right=null,this.channelState="balance",this.stateChangeCnt=0,this.sampleRate=48e3,this.bufferTime=1,this.lastAudioDuration=0,this.bufferSize=this.sampleRate*this.bufferTime,this.leftData=new Float32Array(this.bufferSize),this.rightData=new Float32Array(this.bufferSize),this.dataIndex=0,this.audioData=null,this.enableData=!1,this.onAudioData=()=>{},this.support=null,this.logger=u.logger.getChild(()=>{let f="AudioLevel";return f+=n!=="READY"?" "+n:" "+this.channelState,this.stateChangeCnt&&(f+=" change"+this.stateChangeCnt),f});const h=l.getAudioContext(),o=u.stream;h&&(this.support={stream:o,context:h},this.updateStream(o,u.sourceNode))}async updateStream(u,h){var o;if(this.logger.log("AudioLevel updateStream"),this.support){if(!h&&u.getAudioTracks().length>0)try{h=this.support.context.createMediaStreamSource(u)}catch(m){if(m.name!=="TypeError")return void this.logger.error("无法创建MediaStreamAudioSourceNode",m.name,m.message);h=new MediaStreamAudioSourceNode(this.support.context,{mediaStream:u})}if(this.support.sourceNode&&this.support.sourceNode.disconnect(),this.support.sourceNode=h,!this.support.audioWorkletNode){if(!this.support.context.audioWorklet)return void this.logger.error("该环境不支持音量模块");c?n==="LOADING"&&await c:(n="LOADING",this.logger.log("正在载入音量模块"),c=this.support.context.audioWorklet.addModule(a.getBlobUrl("volumeProcessor")),await c,n="READY",this.logger.log("载入音量模块成功")),this.support.audioWorkletNode=new AudioWorkletNode(this.support.context,"vumeter"),this.support.audioWorkletNode.port.onmessage=m=>{var g,v;const O=Date.now(),T=Math.floor(O);this.volume=m.data.volume,this.sampleRate!==m.data.sampleRate&&(this.sampleRate=m.data.sampleRate,this._resetAudioDataBuffer(),this.logger.warn("采样率变更 "+m.data.sampleRate));const C=m.data.leftData,A=m.data.rightData;if(this.enableData){this.dataIndex+C.length>this.leftData.length&&(this.audioData=[this.leftData.subarray(0,this.dataIndex)],A&&this.audioData.push(this.rightData.subarray(0,this.dataIndex)),this.lastAudioDuration=Math.round(this.audioData[0].length/this.sampleRate*1e3),this.emit("audio-data",{data:this.audioData,duration:this.lastAudioDuration,sampleRate:this.sampleRate}),this._resetAudioDataBuffer());try{this.leftData.set(C,this.dataIndex),A&&this.rightData.set(A,this.dataIndex),this.dataIndex+=C.length}catch{this._resetAudioDataBuffer()}}if(m.data.left>-1)this.left||(this.left={volume:0,history:[]}),this.left.history.length&&this.left.history[0].sec===T||this.left.history.unshift({sec:T,sum:0}),this.left.volume=m.data.left,this.left.history[0].sum+=m.data.left,this.left.history.length>2&&this.left.history.pop();else{const R=this.channelState;this.channelState="mono",R!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${R} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:R}))}if(m.data.right>-1&&(this.right||(this.right={volume:0,history:[]}),this.right.history.length&&this.right.history[0].sec===T||this.right.history.unshift({sec:T,sum:0}),this.right.volume=m.data.right,this.right.history[0].sum+=m.data.right,this.right.history.length>2&&this.right.history.pop()),((g=this.left)===null||g===void 0?void 0:g.history[1])&&((v=this.right)===null||v===void 0?void 0:v.history[1]))if(this.left.history[1].sum>4*this.right.history[1].sum){const R=this.channelState;this.channelState="leftLoud",R!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${R} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:R}))}else if(this.right.history[1].sum>4*this.left.history[1].sum){const R=this.channelState;this.channelState="rightLoud",R!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${R} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:R}))}else{if(this.left.history[1].sum>this.right.history[1].sum&&this.channelState!=="leftLoud"){const R=this.channelState;this.channelState="balance",R!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${R} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:R}))}if(this.right.history[1].sum>this.left.history[1].sum&&this.channelState!=="rightLoud"){const R=this.channelState;this.channelState="balance",R!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${R} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:R}))}}}}(o=this.support.sourceNode)===null||o===void 0||o.connect(this.support.audioWorkletNode);const f=l.getAudioLevelDestination();f&&this.support.audioWorkletNode.connect(f),this.volume=0}}_resetAudioDataBuffer(){this.bufferSize=this.sampleRate*this.bufferTime,this.leftData=new Float32Array(this.bufferSize),this.rightData=new Float32Array(this.bufferSize),this.dataIndex=0}getAudioLevel(){return this.volume}set enableAudioData(u){this.enableData=u,u||this._resetAudioDataBuffer()}get enableAudioData(){return this.enableData}getAudioData(){return{data:this.audioData,duration:this.lastAudioDuration,sampleRate:this.sampleRate}}setBufferTime(u){return this.bufferTime=u/1e3,this._resetAudioDataBuffer(),!0}destroy(){var u,h;this.logger.log("destroy() AudioLevel模块"),(h=(u=this.support)===null||u===void 0?void 0:u.sourceNode)===null||h===void 0||h.disconnect(),this.support=null,this.dataIndex>0&&(this.audioData=[this.leftData.subarray(0,this.dataIndex)],this.audioData.push(this.rightData.subarray(0,this.dataIndex)),this.lastAudioDuration=Math.round(this.audioData[0].length/this.sampleRate*1e3),this.emit("audio-data",{data:this.audioData,duration:this.lastAudioDuration,sampleRate:this.sampleRate}),this.audioData=null,this.dataIndex=0,this.enableAudioData=!1)}}e.AudioLevel=s},function(t,e,r){var i=this&&this.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(e,"__esModule",{value:!0}),e.forceAudioConstraints=e.set3AConstraint=e.patchScreenConstraints=void 0;const a=r(1),l=i(r(6)),n=i(r(8));function c(s,d,u){if(s&&typeof u=="boolean")switch(d){case"AEC":s.echoCancellation=u,s.googEchoCancellation=u,s.googEchoCancellation2=u;break;case"ANS":s.noiseSuppression=u,s.googNoiseSuppression=u,s.googNoiseSuppression2=u;break;case"AGC":s.autoGainControl=u,s.googAutoGainControl=u,s.googAutoGainControl2=u}}e.patchScreenConstraints=function(s,d){if(a.getParameters().screenFocus!=="default")try{if(typeof CaptureController<"u"){const u=new CaptureController;u.setFocusBehavior(a.getParameters().screenFocus),s.controller=u,d.log("屏幕共享跳转控制："+a.getParameters().screenFocus)}else d.log("当前浏览器不支持屏幕共享跳转控制:"+a.getParameters().screenFocus)}catch{}if(a.getParameters().screenDisplaySurface!=="default"&&s.video&&(s.video.displaySurface=a.getParameters().screenDisplaySurface),a.getParameters().screenSurfaceSwitching!=="default"&&(s.surfaceSwitching=a.getParameters().screenSurfaceSwitching),a.getParameters().screenPreferCurrentTab&&(s.preferCurrentTab=a.getParameters().screenPreferCurrentTab),a.getParameters().screenSelfBrowserSurface!=="default"&&(s.selfBrowserSurface=a.getParameters().screenSelfBrowserSurface),s.preferCurrentTab&&s.selfBrowserSurface==="exclude")throw d.log("屏幕共享参数 preferCurrentTab: true 和 selfBrowserSurface: 'exclude' 互斥，不能同时存在"),new n.default({code:l.default.INVALID_PARAMETER_ERROR,message:"screenShare: preferCurrentTab: true 和 selfBrowserSurface: 'exclude' 互斥，不能同时存在"});a.getParameters().forceDisplaySurface!=="default"&&s.video&&(s.video.displaySurface=a.getParameters().forceDisplaySurface)},e.set3AConstraint=c,e.forceAudioConstraints=function(s){a.getParameters().forceAEC!=="no"&&c(s,"AEC",a.getParameters().forceAEC==="on"),a.getParameters().forceANS!=="no"&&c(s,"ANS",a.getParameters().forceANS==="on"),a.getParameters().forceAGC!=="no"&&c(s,"AGC",a.getParameters().forceAGC==="on"),a.getParameters().forceChannelCount!==-1&&(s.channelCount=a.getParameters().forceChannelCount),a.getParameters().forceSampleRate!==-1&&(s.sampleRate=a.getParameters().forceSampleRate),a.getParameters().forceLatency!==-1&&(s.latency=a.getParameters().forceLatency)}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.DataReport=void 0;const i=r(26),a=r(42),l=r(7),n=r(257);let c="https://statistic.live.126.net/statics/report/common/form";e.DataReport=class{constructor(s){this.localStorageKey="EVENT_REPORT_CATCH",this.localStorageMaxLength=1e3;const d=s.adapterRef;s.sdkRef,this.adapterRef=d;let u=d.instance,h=d.channelInfo||{};this.cid=h.cid||h.channelId||0,this.uid=h.uid||0;const o=u._params&&u._params.appkey;this.time=h.clientNtpTime-h.T4,this.common={name:"common",ver:"2.0",sdk_type:"nrtc2",session_id:this.adapterRef.deviceId,app_key:o},this.eventKeys=[],this.eventMap={},this.api=[],this.heartbeat=null}addEvent(s,d){return this.eventKeys.indexOf(s)==-1&&this.eventKeys.push(s),d.time?d.time=d.time+this.time:(this.adapterRef.logger.warn(`addEvent:事件${s}没有time属性。使用当前时间戳`),d.time=Date.now()),this.eventMap[s]=d,this}updateCommon(s){return Object.assign(this.common,s),this}setHeartbeat(s){this.heartbeat=s;const d=Object.keys(this.adapterRef.apiEvent),u=Object.keys(this.adapterRef.apiEvents),h=d.concat(u.filter(f=>!d.includes(f)));let o=[];for(let f in h){const m=h[f];this.adapterRef.apiEvents[m]&&this.adapterRef.apiEvents[m].length?(o=o.concat(this.adapterRef.apiEvents[m]),this.adapterRef.apiEvents[m]=[]):this.adapterRef.apiEvent[m]&&this.adapterRef.apiEvent[m].length&&(o=o.concat(this.adapterRef.apiEvent[m]),this.adapterRef.apiEvent[m]=[])}return this.api=this.api.concat(o),this}setNetworkChange(s){return this.addEvent("networkChange",s),this}setLogin(s){var d,u,h;s.sdk_ver=s.sdk_ver||i.SDK_VERSION,s.platform=s.platform||"Web",s.app_key=s.app_key||this.common.app_key,s.meeting_mode=s.meeting_mode||1,s.model=s.model,s.build=i.BUILD,s.supported_codec_send=(d=this.adapterRef.mediaCapability.supportedCodecSend)===null||d===void 0?void 0:d.join(","),s.supported_codec_recv=(u=this.adapterRef.mediaCapability.supportedCodecRecv)===null||u===void 0?void 0:u.join(","),s.preferred_codec_send=(h=this.adapterRef.mediaCapability.preferredCodecSend.video)===null||h===void 0?void 0:h.join(","),s.extra_info=JSON.stringify({proc:n.processManager.processId,page:n.processManager.pageId,brow:n.processManager.browserId,userAgent:l.USER_AGENT}),s.lbs_addrs=this.adapterRef.lbsManager.getReportField("nrtc"),this.addEvent("login",s)}setRelogin(s){this.addEvent("relogin",s)}setLogout(s){this.addEvent("logout",s)}deviceAbnormal(s){this.addEvent("deviceAbnormal",s)}setDisconnect(s){this.addEvent("disconnect",s)}setRecvFirstFrame(s){this.addEvent("recvFirstFrame",s)}setSendFirstPackage(s){this.addEvent("firstPacketSent",s)}setRecvFirstPackage(s){this.addEvent("recvFirstPackage",s)}setFunction(s){this.addEvent("function",s)}setRequestLbs(s){this.addEvent("requestLBS",s)}setAudioVideoBanned(s){this.addEvent("audioVideoBanned",s)}setStreamException(s){this.addEvent("streamException",s)}setUserCustomEvent(s){this.addEvent("userCustomEvent",s)}setException(s){this.addEvent("exception",s)}setAsrCaptions(s){this.addEvent("asrCaptions",s)}setConnectionStateChange(s){this.addEvent("connectionStateChange",s)}reset(){this.eventKeys=[],this.api=[],this.heartbeat=null}send(s){let d={common:this.common};if(s||(s=this.eventKeys),this.heartbeat&&(d.heartbeat=this.heartbeat,this.api.length&&(this.api.forEach(h=>{h.uid||(h.uid=this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid),h.cid||(h.cid=this.adapterRef.channelInfo&&this.adapterRef.channelInfo.cid),h.param&&typeof h.param=="object"&&h.param.clientUid!==void 0&&(h.param.clientUid=h.uid)}),d.event={apiEvent:this.api},this.api=[])),s){if(s.length){let h=0,o={};for(let f=s.length-1;f>=0;f--){const m=s[f];this.eventMap[m]&&(h++,o[m]=this.eventMap[m],delete this.eventMap[m],s.splice(f,1))}h&&(d.event=o)}}else if(!this.heartbeat)return this;this.adapterRef.instance._params.neRtcServerAddresses.statisticsServer&&(c=this.adapterRef.instance._params.neRtcServerAddresses.statisticsServer);let u=a.generateUUID();try{const h=window.localStorage.getItem(this.localStorageKey)===null?[]:JSON.parse(window.localStorage.getItem(this.localStorageKey));h.length>=this.localStorageMaxLength&&h.shift(),h.push({sdktype:this.common.sdk_type,appkey:this.common.app_key,data:d,requestid:u}),window.localStorage.setItem(this.localStorageKey,JSON.stringify(h))}catch{}return this.adapterRef.lbsManager.ajax({type:"post",url:c,data:d,header:{sdktype:this.common.sdk_type,appkey:this.common.app_key,platform:"web",sdkver:i.SDK_VERSION}}).then(()=>{s===this.eventKeys&&this.reset();try{let h=window.localStorage.getItem(this.localStorageKey)===null?[]:JSON.parse(window.localStorage.getItem(this.localStorageKey));h=h.filter((o,f,m)=>o.requestid!==u),u=null,window.localStorage.setItem(this.localStorageKey,JSON.stringify(h))}catch{}}).catch(h=>{this.adapterRef.logger.log("dataReport, send error: ",h.name,h.message,h),this.reset()}),this}async sendCacheEvent(){try{const s=window.localStorage.getItem(this.localStorageKey)===null?[]:JSON.parse(window.localStorage.getItem(this.localStorageKey));for(let d=0;d<s.length;d++)try{await this.adapterRef.lbsManager.ajax({type:"post",url:c,data:s[d].data,header:{sdktype:s[d].sdktype,appkey:s[d].appkey,platform:"web",sdkver:i.SDK_VERSION}}),s.splice(d,1),d--}catch(u){this.adapterRef.logger.log("sendCacheEvent send error: ",u.name,u.message)}window.localStorage.setItem(this.localStorageKey,JSON.stringify(s))}catch(s){this.adapterRef.logger.log("sendCacheEvent error: ",s.name,s.message)}}}},function(t,e,r){t.exports=r(261)},function(t,e,r){t.exports=function(i,a){for(var l=new Array(arguments.length-1),n=0,c=2,s=!0;c<arguments.length;)l[n++]=arguments[c++];return new Promise(function(d,u){l[n]=function(h){if(s)if(s=!1,h)u(h);else{for(var o=new Array(arguments.length-1),f=0;f<o.length;)o[f++]=arguments[f];d.apply(null,o)}};try{i.apply(a||null,l)}catch(h){s&&(s=!1,u(h))}})}},function(module,exports,__webpack_require__){function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(t){}return null}module.exports=inquire},function(t,e,r){e.Service=r(271)},function(t,e,r){t.exports={}},function(t,e,r){t.exports=function(c){for(var s,d=l.codegen(["m","w"],c.name+"$encode")("if(!w)")("w=Writer.create()"),u=c.fieldsArray.slice().sort(l.compareFieldsById),h=0;h<u.length;++h){var o=u[h].resolve(),f=c._fieldsArray.indexOf(o),m=o.resolvedType instanceof i?"int32":o.type,g=a.basic[m];s="m"+l.safeProp(o.name),o.map?(d("if(%s!=null&&Object.hasOwnProperty.call(m,%j)){",s,o.name)("for(var ks=Object.keys(%s),i=0;i<ks.length;++i){",s)("w.uint32(%i).fork().uint32(%i).%s(ks[i])",(o.id<<3|2)>>>0,8|a.mapKey[o.keyType],o.keyType),g===void 0?d("types[%i].encode(%s[ks[i]],w.uint32(18).fork()).ldelim().ldelim()",f,s):d(".uint32(%i).%s(%s[ks[i]]).ldelim()",16|g,m,s),d("}")("}")):o.repeated?(d("if(%s!=null&&%s.length){",s,s),o.packed&&a.packed[m]!==void 0?d("w.uint32(%i).fork()",(o.id<<3|2)>>>0)("for(var i=0;i<%s.length;++i)",s)("w.%s(%s[i])",m,s)("w.ldelim()"):(d("for(var i=0;i<%s.length;++i)",s),g===void 0?n(d,o,f,s+"[i]"):d("w.uint32(%i).%s(%s[i])",(o.id<<3|g)>>>0,m,s)),d("}")):(o.optional&&d("if(%s!=null&&Object.hasOwnProperty.call(m,%j))",s,o.name),g===void 0?n(d,o,f,s):d("w.uint32(%i).%s(%s)",(o.id<<3|g)>>>0,m,s))}return d("return w")};var i=r(45),a=r(92),l=r(19);function n(c,s,d,u){return s.resolvedType.group?c("types[%i].encode(%s,w.uint32(%i)).uint32(%i)",d,u,(s.id<<3|3)>>>0,(s.id<<3|4)>>>0):c("types[%i].encode(%s,w.uint32(%i).fork()).ldelim()",d,u,(s.id<<3|2)>>>0)}},function(t,e,r){t.exports=T;var i=r(91);((T.prototype=Object.create(i.prototype)).constructor=T).className="Type";var a=r(45),l=r(141),n=r(83),c=r(185),s=r(186),d=r(153),u=r(152),h=r(151),o=r(19),f=r(183),m=r(188),g=r(189),v=r(190),O=r(191);function T(A,R){i.call(this,A,R),this.fields={},this.oneofs=void 0,this.extensions=void 0,this.reserved=void 0,this.group=void 0,this._fieldsById=null,this._fieldsArray=null,this._oneofsArray=null,this._ctor=null}function C(A){return A._fieldsById=A._fieldsArray=A._oneofsArray=null,delete A.encode,delete A.decode,delete A.verify,A}Object.defineProperties(T.prototype,{fieldsById:{get:function(){if(this._fieldsById)return this._fieldsById;this._fieldsById={};for(var A=Object.keys(this.fields),R=0;R<A.length;++R){var w=this.fields[A[R]],k=w.id;if(this._fieldsById[k])throw Error("duplicate id "+k+" in "+this);this._fieldsById[k]=w}return this._fieldsById}},fieldsArray:{get:function(){return this._fieldsArray||(this._fieldsArray=o.toArray(this.fields))}},oneofsArray:{get:function(){return this._oneofsArray||(this._oneofsArray=o.toArray(this.oneofs))}},ctor:{get:function(){return this._ctor||(this.ctor=T.generateConstructor(this)())},set:function(A){var R=A.prototype;R instanceof d||((A.prototype=new d).constructor=A,o.merge(A.prototype,R)),A.$type=A.prototype.$type=this,o.merge(A,d,!0),this._ctor=A;for(var w=0;w<this.fieldsArray.length;++w)this._fieldsArray[w].resolve();var k={};for(w=0;w<this.oneofsArray.length;++w)k[this._oneofsArray[w].resolve().name]={get:o.oneOfGetter(this._oneofsArray[w].oneof),set:o.oneOfSetter(this._oneofsArray[w].oneof)};w&&Object.defineProperties(A.prototype,k)}}}),T.generateConstructor=function(A){for(var R,w=o.codegen(["p"],A.name),k=0;k<A.fieldsArray.length;++k)(R=A._fieldsArray[k]).map?w("this%s={}",o.safeProp(R.name)):R.repeated&&w("this%s=[]",o.safeProp(R.name));return w("if(p)for(var ks=Object.keys(p),i=0;i<ks.length;++i)if(p[ks[i]]!=null)")("this[ks[i]]=p[ks[i]]")},T.fromJSON=function(A,R){var w=new T(A,R.options);w.extensions=R.extensions,w.reserved=R.reserved;for(var k=Object.keys(R.fields),I=0;I<k.length;++I)w.add((R.fields[k[I]].keyType!==void 0?c.fromJSON:n.fromJSON)(k[I],R.fields[k[I]]));if(R.oneofs)for(k=Object.keys(R.oneofs),I=0;I<k.length;++I)w.add(l.fromJSON(k[I],R.oneofs[k[I]]));if(R.nested)for(k=Object.keys(R.nested),I=0;I<k.length;++I){var M=R.nested[k[I]];w.add((M.id!==void 0?n.fromJSON:M.fields!==void 0?T.fromJSON:M.values!==void 0?a.fromJSON:M.methods!==void 0?s.fromJSON:i.fromJSON)(k[I],M))}return R.extensions&&R.extensions.length&&(w.extensions=R.extensions),R.reserved&&R.reserved.length&&(w.reserved=R.reserved),R.group&&(w.group=!0),R.comment&&(w.comment=R.comment),w},T.prototype.toJSON=function(A){var R=i.prototype.toJSON.call(this,A),w=!!A&&!!A.keepComments;return o.toObject(["options",R&&R.options||void 0,"oneofs",i.arrayToJSON(this.oneofsArray,A),"fields",i.arrayToJSON(this.fieldsArray.filter(function(k){return!k.declaringField}),A)||{},"extensions",this.extensions&&this.extensions.length?this.extensions:void 0,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"group",this.group||void 0,"nested",R&&R.nested||void 0,"comment",w?this.comment:void 0])},T.prototype.resolveAll=function(){for(var A=this.fieldsArray,R=0;R<A.length;)A[R++].resolve();var w=this.oneofsArray;for(R=0;R<w.length;)w[R++].resolve();return i.prototype.resolveAll.call(this)},T.prototype.get=function(A){return this.fields[A]||this.oneofs&&this.oneofs[A]||this.nested&&this.nested[A]||null},T.prototype.add=function(A){if(this.get(A.name))throw Error("duplicate name '"+A.name+"' in "+this);if(A instanceof n&&A.extend===void 0){if(this._fieldsById?this._fieldsById[A.id]:this.fieldsById[A.id])throw Error("duplicate id "+A.id+" in "+this);if(this.isReservedId(A.id))throw Error("id "+A.id+" is reserved in "+this);if(this.isReservedName(A.name))throw Error("name '"+A.name+"' is reserved in "+this);return A.parent&&A.parent.remove(A),this.fields[A.name]=A,A.message=this,A.onAdd(this),C(this)}return A instanceof l?(this.oneofs||(this.oneofs={}),this.oneofs[A.name]=A,A.onAdd(this),C(this)):i.prototype.add.call(this,A)},T.prototype.remove=function(A){if(A instanceof n&&A.extend===void 0){if(!this.fields||this.fields[A.name]!==A)throw Error(A+" is not a member of "+this);return delete this.fields[A.name],A.parent=null,A.onRemove(this),C(this)}if(A instanceof l){if(!this.oneofs||this.oneofs[A.name]!==A)throw Error(A+" is not a member of "+this);return delete this.oneofs[A.name],A.parent=null,A.onRemove(this),C(this)}return i.prototype.remove.call(this,A)},T.prototype.isReservedId=function(A){return i.isReservedId(this.reserved,A)},T.prototype.isReservedName=function(A){return i.isReservedName(this.reserved,A)},T.prototype.create=function(A){return new this.ctor(A)},T.prototype.setup=function(){for(var A=this.fullName,R=[],w=0;w<this.fieldsArray.length;++w)R.push(this._fieldsArray[w].resolve().resolvedType);this.encode=f(this)({Writer:h,types:R,util:o}),this.decode=m(this)({Reader:u,types:R,util:o}),this.verify=g(this)({types:R,util:o}),this.fromObject=v.fromObject(this)({types:R,util:o}),this.toObject=v.toObject(this)({types:R,util:o});var k=O[A];if(k){var I=Object.create(this);I.fromObject=this.fromObject,this.fromObject=k.fromObject.bind(I),I.toObject=this.toObject,this.toObject=k.toObject.bind(I)}return this},T.prototype.encode=function(A,R){return this.setup().encode(A,R)},T.prototype.encodeDelimited=function(A,R){return this.encode(A,R&&R.len?R.fork():R).ldelim()},T.prototype.decode=function(A,R){return this.setup().decode(A,R)},T.prototype.decodeDelimited=function(A){return A instanceof u||(A=u.create(A)),this.decode(A,A.uint32())},T.prototype.verify=function(A){return this.setup().verify(A)},T.prototype.fromObject=function(A){return this.setup().fromObject(A)},T.prototype.toObject=function(A,R){return this.setup().toObject(A,R)},T.d=function(A){return function(R){o.decorateType(R,A)}}},function(t,e,r){t.exports=n;var i=r(83);((n.prototype=Object.create(i.prototype)).constructor=n).className="MapField";var a=r(92),l=r(19);function n(c,s,d,u,h,o){if(i.call(this,c,s,u,void 0,void 0,h,o),!l.isString(d))throw TypeError("keyType must be a string");this.keyType=d,this.resolvedKeyType=null,this.map=!0}n.fromJSON=function(c,s){return new n(c,s.id,s.keyType,s.type,s.options,s.comment)},n.prototype.toJSON=function(c){var s=!!c&&!!c.keepComments;return l.toObject(["keyType",this.keyType,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",s?this.comment:void 0])},n.prototype.resolve=function(){if(this.resolved)return this;if(a.mapKey[this.keyType]===void 0)throw Error("invalid key type: "+this.keyType);return i.prototype.resolve.call(this)},n.d=function(c,s,d){return typeof d=="function"?d=l.decorateType(d).name:d&&typeof d=="object"&&(d=l.decorateEnum(d).name),function(u,h){l.decorateType(u.constructor).add(new n(h,c,s,d))}}},function(t,e,r){t.exports=c;var i=r(91);((c.prototype=Object.create(i.prototype)).constructor=c).className="Service";var a=r(187),l=r(19),n=r(181);function c(d,u){i.call(this,d,u),this.methods={},this._methodsArray=null}function s(d){return d._methodsArray=null,d}c.fromJSON=function(d,u){var h=new c(d,u.options);if(u.methods)for(var o=Object.keys(u.methods),f=0;f<o.length;++f)h.add(a.fromJSON(o[f],u.methods[o[f]]));return u.nested&&h.addJSON(u.nested),h.comment=u.comment,h},c.prototype.toJSON=function(d){var u=i.prototype.toJSON.call(this,d),h=!!d&&!!d.keepComments;return l.toObject(["options",u&&u.options||void 0,"methods",i.arrayToJSON(this.methodsArray,d)||{},"nested",u&&u.nested||void 0,"comment",h?this.comment:void 0])},Object.defineProperty(c.prototype,"methodsArray",{get:function(){return this._methodsArray||(this._methodsArray=l.toArray(this.methods))}}),c.prototype.get=function(d){return this.methods[d]||i.prototype.get.call(this,d)},c.prototype.resolveAll=function(){for(var d=this.methodsArray,u=0;u<d.length;++u)d[u].resolve();return i.prototype.resolve.call(this)},c.prototype.add=function(d){if(this.get(d.name))throw Error("duplicate name '"+d.name+"' in "+this);return d instanceof a?(this.methods[d.name]=d,d.parent=this,s(this)):i.prototype.add.call(this,d)},c.prototype.remove=function(d){if(d instanceof a){if(this.methods[d.name]!==d)throw Error(d+" is not a member of "+this);return delete this.methods[d.name],d.parent=null,s(this)}return i.prototype.remove.call(this,d)},c.prototype.create=function(d,u,h){for(var o,f=new n.Service(d,u,h),m=0;m<this.methodsArray.length;++m){var g=l.lcFirst((o=this._methodsArray[m]).resolve().name).replace(/[^$\w_]/g,"");f[g]=l.codegen(["r","c"],l.isReserved(g)?g+"_":g)("return this.rpcCall(m,q,s,r,c)")({m:o,q:o.resolvedRequestType.ctor,s:o.resolvedResponseType.ctor})}return f}},function(t,e,r){t.exports=l;var i=r(82);((l.prototype=Object.create(i.prototype)).constructor=l).className="Method";var a=r(19);function l(n,c,s,d,u,h,o,f,m){if(a.isObject(u)?(o=u,u=h=void 0):a.isObject(h)&&(o=h,h=void 0),c!==void 0&&!a.isString(c))throw TypeError("type must be a string");if(!a.isString(s))throw TypeError("requestType must be a string");if(!a.isString(d))throw TypeError("responseType must be a string");i.call(this,n,o),this.type=c||"rpc",this.requestType=s,this.requestStream=!!u||void 0,this.responseType=d,this.responseStream=!!h||void 0,this.resolvedRequestType=null,this.resolvedResponseType=null,this.comment=f,this.parsedOptions=m}l.fromJSON=function(n,c){return new l(n,c.type,c.requestType,c.responseType,c.requestStream,c.responseStream,c.options,c.comment,c.parsedOptions)},l.prototype.toJSON=function(n){var c=!!n&&!!n.keepComments;return a.toObject(["type",this.type!=="rpc"&&this.type||void 0,"requestType",this.requestType,"requestStream",this.requestStream,"responseType",this.responseType,"responseStream",this.responseStream,"options",this.options,"comment",c?this.comment:void 0,"parsedOptions",this.parsedOptions])},l.prototype.resolve=function(){return this.resolved?this:(this.resolvedRequestType=this.parent.lookupType(this.requestType),this.resolvedResponseType=this.parent.lookupType(this.responseType),i.prototype.resolve.call(this))}},function(t,e,r){t.exports=function(c){var s=l.codegen(["r","l"],c.name+"$decode")("if(!(r instanceof Reader))")("r=Reader.create(r)")("var c=l===undefined?r.len:r.pos+l,m=new this.ctor"+(c.fieldsArray.filter(function(m){return m.map}).length?",k,value":""))("while(r.pos<c){")("var t=r.uint32()");c.group&&s("if((t&7)===4)")("break"),s("switch(t>>>3){");for(var d=0;d<c.fieldsArray.length;++d){var u=c._fieldsArray[d].resolve(),h=u.resolvedType instanceof i?"int32":u.type,o="m"+l.safeProp(u.name);s("case %i:",u.id),u.map?(s("if(%s===util.emptyObject)",o)("%s={}",o)("var c2 = r.uint32()+r.pos"),a.defaults[u.keyType]!==void 0?s("k=%j",a.defaults[u.keyType]):s("k=null"),a.defaults[h]!==void 0?s("value=%j",a.defaults[h]):s("value=null"),s("while(r.pos<c2){")("var tag2=r.uint32()")("switch(tag2>>>3){")("case 1: k=r.%s(); break",u.keyType)("case 2:"),a.basic[h]===void 0?s("value=types[%i].decode(r,r.uint32())",d):s("value=r.%s()",h),s("break")("default:")("r.skipType(tag2&7)")("break")("}")("}"),a.long[u.keyType]!==void 0?s('%s[typeof k==="object"?util.longToHash(k):k]=value',o):s("%s[k]=value",o)):u.repeated?(s("if(!(%s&&%s.length))",o,o)("%s=[]",o),a.packed[h]!==void 0&&s("if((t&7)===2){")("var c2=r.uint32()+r.pos")("while(r.pos<c2)")("%s.push(r.%s())",o,h)("}else"),a.basic[h]===void 0?s(u.resolvedType.group?"%s.push(types[%i].decode(r))":"%s.push(types[%i].decode(r,r.uint32()))",o,d):s("%s.push(r.%s())",o,h)):a.basic[h]===void 0?s(u.resolvedType.group?"%s=types[%i].decode(r)":"%s=types[%i].decode(r,r.uint32())",o,d):s("%s=r.%s()",o,h),s("break")}for(s("default:")("r.skipType(t&7)")("break")("}")("}"),d=0;d<c._fieldsArray.length;++d){var f=c._fieldsArray[d];f.required&&s("if(!m.hasOwnProperty(%j))",f.name)("throw util.ProtocolError(%j,{instance:m})",n(f))}return s("return m")};var i=r(45),a=r(92),l=r(19);function n(c){return"missing required '"+c.name+"'"}},function(t,e,r){t.exports=function(s){var d=a.codegen(["m"],s.name+"$verify")('if(typeof m!=="object"||m===null)')("return%j","object expected"),u=s.oneofsArray,h={};u.length&&d("var p={}");for(var o=0;o<s.fieldsArray.length;++o){var f=s._fieldsArray[o].resolve(),m="m"+a.safeProp(f.name);if(f.optional&&d("if(%s!=null&&m.hasOwnProperty(%j)){",m,f.name),f.map)d("if(!util.isObject(%s))",m)("return%j",l(f,"object"))("var k=Object.keys(%s)",m)("for(var i=0;i<k.length;++i){"),c(d,f,"k[i]"),n(d,f,o,m+"[k[i]]")("}");else if(f.repeated)d("if(!Array.isArray(%s))",m)("return%j",l(f,"array"))("for(var i=0;i<%s.length;++i){",m),n(d,f,o,m+"[i]")("}");else{if(f.partOf){var g=a.safeProp(f.partOf.name);h[f.partOf.name]===1&&d("if(p%s===1)",g)("return%j",f.partOf.name+": multiple values"),h[f.partOf.name]=1,d("p%s=1",g)}n(d,f,o,m)}f.optional&&d("}")}return d("return null")};var i=r(45),a=r(19);function l(s,d){return s.name+": "+d+(s.repeated&&d!=="array"?"[]":s.map&&d!=="object"?"{k:"+s.keyType+"}":"")+" expected"}function n(s,d,u,h){if(d.resolvedType)if(d.resolvedType instanceof i){s("switch(%s){",h)("default:")("return%j",l(d,"enum value"));for(var o=Object.keys(d.resolvedType.values),f=0;f<o.length;++f)s("case %i:",d.resolvedType.values[o[f]]);s("break")("}")}else s("{")("var e=types[%i].verify(%s);",u,h)("if(e)")("return%j+e",d.name+".")("}");else switch(d.type){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":s("if(!util.isInteger(%s))",h)("return%j",l(d,"integer"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":s("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))",h,h,h,h)("return%j",l(d,"integer|Long"));break;case"float":case"double":s('if(typeof %s!=="number")',h)("return%j",l(d,"number"));break;case"bool":s('if(typeof %s!=="boolean")',h)("return%j",l(d,"boolean"));break;case"string":s("if(!util.isString(%s))",h)("return%j",l(d,"string"));break;case"bytes":s('if(!(%s&&typeof %s.length==="number"||util.isString(%s)))',h,h,h)("return%j",l(d,"buffer"))}return s}function c(s,d,u){switch(d.keyType){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":s("if(!util.key32Re.test(%s))",u)("return%j",l(d,"integer key"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":s("if(!util.key64Re.test(%s))",u)("return%j",l(d,"integer|Long key"));break;case"bool":s("if(!util.key2Re.test(%s))",u)("return%j",l(d,"boolean key"))}return s}},function(t,e,r){var i=e,a=r(45),l=r(19);function n(s,d,u,h){if(d.resolvedType)if(d.resolvedType instanceof a){s("switch(d%s){",h);for(var o=d.resolvedType.values,f=Object.keys(o),m=0;m<f.length;++m)d.repeated&&o[f[m]]===d.typeDefault&&s("default:"),s("case%j:",f[m])("case %i:",o[f[m]])("m%s=%j",h,o[f[m]])("break");s("}")}else s('if(typeof d%s!=="object")',h)("throw TypeError(%j)",d.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",h,u,h);else{var g=!1;switch(d.type){case"double":case"float":s("m%s=Number(d%s)",h,h);break;case"uint32":case"fixed32":s("m%s=d%s>>>0",h,h);break;case"int32":case"sint32":case"sfixed32":s("m%s=d%s|0",h,h);break;case"uint64":g=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":s("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",h,h,g)('else if(typeof d%s==="string")',h)("m%s=parseInt(d%s,10)",h,h)('else if(typeof d%s==="number")',h)("m%s=d%s",h,h)('else if(typeof d%s==="object")',h)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",h,h,h,g?"true":"");break;case"bytes":s('if(typeof d%s==="string")',h)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",h,h,h)("else if(d%s.length)",h)("m%s=d%s",h,h);break;case"string":s("m%s=String(d%s)",h,h);break;case"bool":s("m%s=Boolean(d%s)",h,h)}}return s}function c(s,d,u,h){if(d.resolvedType)d.resolvedType instanceof a?s("d%s=o.enums===String?types[%i].values[m%s]:m%s",h,u,h,h):s("d%s=types[%i].toObject(m%s,o)",h,u,h);else{var o=!1;switch(d.type){case"double":case"float":s("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",h,h,h,h);break;case"uint64":o=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":s('if(typeof m%s==="number")',h)("d%s=o.longs===String?String(m%s):m%s",h,h,h)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",h,h,h,h,o?"true":"",h);break;case"bytes":s("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",h,h,h,h,h);break;default:s("d%s=m%s",h,h)}}return s}i.fromObject=function(s){var d=s.fieldsArray,u=l.codegen(["d"],s.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!d.length)return u("return new this.ctor");u("var m=new this.ctor");for(var h=0;h<d.length;++h){var o=d[h].resolve(),f=l.safeProp(o.name);o.map?(u("if(d%s){",f)('if(typeof d%s!=="object")',f)("throw TypeError(%j)",o.fullName+": object expected")("m%s={}",f)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",f),n(u,o,h,f+"[ks[i]]")("}")("}")):o.repeated?(u("if(d%s){",f)("if(!Array.isArray(d%s))",f)("throw TypeError(%j)",o.fullName+": array expected")("m%s=[]",f)("for(var i=0;i<d%s.length;++i){",f),n(u,o,h,f+"[i]")("}")("}")):(o.resolvedType instanceof a||u("if(d%s!=null){",f),n(u,o,h,f),o.resolvedType instanceof a||u("}"))}return u("return m")},i.toObject=function(s){var d=s.fieldsArray.slice().sort(l.compareFieldsById);if(!d.length)return l.codegen()("return {}");for(var u=l.codegen(["m","o"],s.name+"$toObject")("if(!o)")("o={}")("var d={}"),h=[],o=[],f=[],m=0;m<d.length;++m)d[m].partOf||(d[m].resolve().repeated?h:d[m].map?o:f).push(d[m]);if(h.length){for(u("if(o.arrays||o.defaults){"),m=0;m<h.length;++m)u("d%s=[]",l.safeProp(h[m].name));u("}")}if(o.length){for(u("if(o.objects||o.defaults){"),m=0;m<o.length;++m)u("d%s={}",l.safeProp(o[m].name));u("}")}if(f.length){for(u("if(o.defaults){"),m=0;m<f.length;++m){var g=f[m],v=l.safeProp(g.name);if(g.resolvedType instanceof a)u("d%s=o.enums===String?%j:%j",v,g.resolvedType.valuesById[g.typeDefault],g.typeDefault);else if(g.long)u("if(util.Long){")("var n=new util.Long(%i,%i,%j)",g.typeDefault.low,g.typeDefault.high,g.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",v)("}else")("d%s=o.longs===String?%j:%i",v,g.typeDefault.toString(),g.typeDefault.toNumber());else if(g.bytes){var O="["+Array.prototype.slice.call(g.typeDefault).join(",")+"]";u("if(o.bytes===String)d%s=%j",v,String.fromCharCode.apply(String,g.typeDefault))("else{")("d%s=%s",v,O)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",v,v)("}")}else u("d%s=%j",v,g.typeDefault)}u("}")}var T=!1;for(m=0;m<d.length;++m){g=d[m];var C=s._fieldsArray.indexOf(g);v=l.safeProp(g.name),g.map?(T||(T=!0,u("var ks2")),u("if(m%s&&(ks2=Object.keys(m%s)).length){",v,v)("d%s={}",v)("for(var j=0;j<ks2.length;++j){"),c(u,g,C,v+"[ks2[j]]")("}")):g.repeated?(u("if(m%s&&m%s.length){",v,v)("d%s=[]",v)("for(var j=0;j<m%s.length;++j){",v),c(u,g,C,v+"[j]")("}")):(u("if(m%s!=null&&m.hasOwnProperty(%j)){",v,g.name),c(u,g,C,v),g.partOf&&u("if(o.oneofs)")("d%s=%j",l.safeProp(g.partOf.name),g.name)),u("}")}return u("return d")}},function(t,e,r){var i=e,a=r(153);i[".google.protobuf.Any"]={fromObject:function(l){if(l&&l["@type"]){var n=l["@type"].substring(l["@type"].lastIndexOf("/")+1),c=this.lookup(n);if(c){var s=l["@type"].charAt(0)==="."?l["@type"].substr(1):l["@type"];return s.indexOf("/")===-1&&(s="/"+s),this.create({type_url:s,value:c.encode(c.fromObject(l)).finish()})}}return this.fromObject(l)},toObject:function(l,n){var c="",s="";if(n&&n.json&&l.type_url&&l.value){s=l.type_url.substring(l.type_url.lastIndexOf("/")+1),c=l.type_url.substring(0,l.type_url.lastIndexOf("/")+1);var d=this.lookup(s);d&&(l=d.decode(l.value))}if(!(l instanceof this.ctor)&&l instanceof a){var u=l.$type.toObject(l,n);return c===""&&(c="type.googleapis.com/"),s=c+(l.$type.fullName[0]==="."?l.$type.fullName.substr(1):l.$type.fullName),u["@type"]=s,u}return this.toObject(l,n)}}},function(t,e,r){t.exports=h;var i=r(91);((h.prototype=Object.create(i.prototype)).constructor=h).className="Root";var a,l,n,c=r(83),s=r(45),d=r(141),u=r(19);function h(g){i.call(this,"",g),this.deferred=[],this.files=[]}function o(){}h.fromJSON=function(g,v){return v||(v=new h),g.options&&v.setOptions(g.options),v.addJSON(g.nested)},h.prototype.resolvePath=u.path.resolve,h.prototype.fetch=u.fetch,h.prototype.load=function g(v,O,T){typeof O=="function"&&(T=O,O=void 0);var C=this;if(!T)return u.asPromise(g,C,v,O);var A=T===o;function R(y,_){if(T){var b=T;if(T=null,A)throw y;b(y,_)}}function w(y){var _=y.lastIndexOf("google/protobuf/");if(_>-1){var b=y.substring(_);if(b in n)return b}return null}function k(y,_){try{if(u.isString(_)&&_.charAt(0)==="{"&&(_=JSON.parse(_)),u.isString(_)){l.filename=y;var b,E=l(_,C,O),x=0;if(E.imports)for(;x<E.imports.length;++x)(b=w(E.imports[x])||C.resolvePath(y,E.imports[x]))&&I(b);if(E.weakImports)for(x=0;x<E.weakImports.length;++x)(b=w(E.weakImports[x])||C.resolvePath(y,E.weakImports[x]))&&I(b,!0)}else C.setOptions(_.options).addJSON(_.nested)}catch(D){R(D)}A||M||R(null,C)}function I(y,_){if(!(C.files.indexOf(y)>-1))if(C.files.push(y),y in n)A?k(y,n[y]):(++M,setTimeout(function(){--M,k(y,n[y])}));else if(A){var b;try{b=u.fs.readFileSync(y).toString("utf8")}catch(E){return void(_||R(E))}k(y,b)}else++M,C.fetch(y,function(E,x){--M,T&&(E?_?M||R(null,C):R(E):k(y,x))})}var M=0;u.isString(v)&&(v=[v]);for(var P,S=0;S<v.length;++S)(P=C.resolvePath("",v[S]))&&I(P);if(A)return C;M||R(null,C)},h.prototype.loadSync=function(g,v){if(!u.isNode)throw Error("not supported");return this.load(g,v,o)},h.prototype.resolveAll=function(){if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map(function(g){return"'extend "+g.extend+"' in "+g.parent.fullName}).join(", "));return i.prototype.resolveAll.call(this)};var f=/^[A-Z]/;function m(g,v){var O=v.parent.lookup(v.extend);if(O){var T=new c(v.fullName,v.id,v.type,v.rule,void 0,v.options);return T.declaringField=v,v.extensionField=T,O.add(T),!0}return!1}h.prototype._handleAdd=function(g){if(g instanceof c)g.extend===void 0||g.extensionField||m(0,g)||this.deferred.push(g);else if(g instanceof s)f.test(g.name)&&(g.parent[g.name]=g.values);else if(!(g instanceof d)){if(g instanceof a)for(var v=0;v<this.deferred.length;)m(0,this.deferred[v])?this.deferred.splice(v,1):++v;for(var O=0;O<g.nestedArray.length;++O)this._handleAdd(g._nestedArray[O]);f.test(g.name)&&(g.parent[g.name]=g)}},h.prototype._handleRemove=function(g){if(g instanceof c){if(g.extend!==void 0)if(g.extensionField)g.extensionField.parent.remove(g.extensionField),g.extensionField=null;else{var v=this.deferred.indexOf(g);v>-1&&this.deferred.splice(v,1)}}else if(g instanceof s)f.test(g.name)&&delete g.parent[g.name];else if(g instanceof i){for(var O=0;O<g.nestedArray.length;++O)this._handleRemove(g._nestedArray[O]);f.test(g.name)&&delete g.parent[g.name]}},h._configure=function(g,v,O){a=g,l=v,n=O}},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(S,y,_,b){b===void 0&&(b=_),Object.defineProperty(S,b,{enumerable:!0,get:function(){return y[_]}})}:function(S,y,_,b){b===void 0&&(b=_),S[b]=y[_]}),a=this&&this.__setModuleDefault||(Object.create?function(S,y){Object.defineProperty(S,"default",{enumerable:!0,value:y})}:function(S,y){S.default=y}),l=this&&this.__importStar||function(S){if(S&&S.__esModule)return S;var y={};if(S!=null)for(var _ in S)_!=="default"&&Object.prototype.hasOwnProperty.call(S,_)&&i(y,S,_);return a(y,S),y},n=this&&this.__importDefault||function(S){return S&&S.__esModule?S:{default:S}};Object.defineProperty(e,"__esModule",{value:!0}),e.MediaHelper=void 0;const c=r(3),s=r(165),d=r(69),u=r(154),h=n(r(6)),o=n(r(8)),f=l(r(71)),m=r(71),g=r(49),v=r(283),O=l(r(7)),T=r(29),C=r(144),A=r(76),R=r(1),w=r(284),k=r(47),I=r(285),M=r(176);class P extends c.EventEmitter{constructor(y){super(),this.audio={audioStream:new MediaStream,audioSourceStream:new MediaStream,musicStream:new MediaStream,micStream:new MediaStream,pipeline:null,audioSource:null,micTrack:null,deviceInfo:{mic:{compatAudio:!1,label:""}},webAudio:null,micConstraint:null,mixAudioConf:{index:0,audioBuffer:{},sounds:{}},stageAIProcessing:null,audioRoutingEnabled:!1,audioDom:null},this.video={videoStream:new MediaStream,renderStream:new MediaStream,low:null,cameraTrack:null,cameraConstraint:{video:{}},videoSource:null,preProcessingEnabled:!1,preProcessing:null,captureConfig:{high:{width:640,height:480,frameRate:15}},encoderConfig:{high:{maxBitrate:8e5,contentHint:null},low:{maxBitrate:1e5,contentHint:"motion"}}},this.screen={screenVideoStream:new MediaStream,renderStream:new MediaStream,low:null,screenVideoTrack:null,screenVideoSource:null,preProcessingEnabled:!1,preProcessing:null,captureConfig:{high:{width:1920,height:1080,frameRate:5}},encoderConfig:{high:{maxBitrate:15e5,contentHint:null},low:{maxBitrate:2e5,contentHint:"motion"}}},this.videoThird={videoThirdStream:new MediaStream,renderStream:new MediaStream,low:null,videoThirdTrack:null,videoThirdSource:null,preProcessingEnabled:!1,preProcessing:null,captureConfig:{high:{width:1920,height:1080,frameRate:5}},encoderConfig:{high:{maxBitrate:15e5,contentHint:null},low:{maxBitrate:2e5,contentHint:"motion"}}},this.videoFourth={videoFourthStream:new MediaStream,renderStream:new MediaStream,low:null,videoFourthTrack:null,videoFourthSource:null,preProcessingEnabled:!1,preProcessing:null,captureConfig:{high:{width:1920,height:1080,frameRate:5}},encoderConfig:{high:{maxBitrate:15e5,contentHint:null},low:{maxBitrate:2e5,contentHint:"motion"}}},this.screenAudio={screenAudioStream:new MediaStream,screenAudioTrack:null,screenAudioSource:null,pipeline:null},this.listenToTrackEnded=_=>{_&&(_.readyState==="ended"&&this.logger.error("注意:刚刚获取到的的track已经停止: ",_.label,_.id),_.addEventListener("ended",async()=>{var b;O.ANY_CHROME_MAJOR_VERSION&&O.ANY_CHROME_MAJOR_VERSION<62&&await this.delay(100),this.logger.log("Track ended",_.label,_.id),this.stream.isRemote||this.stream.localStreamId!==((b=this.stream.client.adapterRef.localStream)===null||b===void 0?void 0:b.localStreamId)||(_!==this.audio.micTrack&&_!==this.audio.audioSource||(this.logger.warn("音频轨道已停止"),this.stream.client.safeEmit("audioTrackEnded"),this.stream.client.safeEmit("TrackEnded","audio"),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:"audioTrackEnded",mediaType:"audio"})),_!==this.video.cameraTrack&&_!==this.video.videoSource||(this.logger.warn("视频轨道已停止"),this.stream.client.safeEmit("videoTrackEnded"),this.stream.client.safeEmit("TrackEnded","video"),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:"videoTrackEnded",mediaType:"video"})),(_===this.screen.screenVideoTrack||_===this.screen.screenVideoSource||_.label.indexOf("screen")>-1||_.label.indexOf("window")>-1||_.label.indexOf("web-")>-1)&&(this.logger.warn("屏幕共享已停止"),this.stream.client.safeEmit("stopScreenSharing"),this.stream.client.safeEmit("TrackEnded","screen"),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:"videoTrackEnded",mediaType:"screen"})),_===this.screenAudio.screenAudioTrack&&(this.logger.warn("屏幕共享音频已停止"),this.stream.client.safeEmit("stopScreenAudio"),this.stream.client.safeEmit("TrackEnded","screenAudio"),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:"stopScreenAudio",mediaType:"screenAudio"})))}),_.muted&&this._handleTrackMuted(_),_.addEventListener("mute",()=>{this.logger.warn("Track muted",_.label,_.id),this._handleTrackMuted(_)}),_.addEventListener("unmute",()=>{this.logger.log("Track unmuted",_.label,_.id)}))},this._handleTrackMuted=_=>{_!==this.audio.micTrack&&_!==this.audio.audioSource||(this.logger.warn("音频轨道已mute"),this.stream.client.safeEmit("TrackMuted","audio"),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:"audioTrackMuted",mediaType:"audio"})),_!==this.video.cameraTrack&&_!==this.video.videoSource||(this.logger.warn("视频轨道已mute"),this.stream.client.safeEmit("TrackMuted","video"),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:"videoTrackkMuted",mediaType:"video"})),(_===this.screen.screenVideoTrack||_===this.screen.screenVideoSource||_.label.indexOf("screen")>-1||_.label.indexOf("window")>-1||_.label.indexOf("web-")>-1)&&(this.logger.warn("屏幕共享已mute"),this.stream.client.safeEmit("TrackMuted","screen"),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:"screenTrackkMuted",mediaType:"screen"})),_===this.screenAudio.screenAudioTrack&&(this.logger.warn("屏幕共享音频已mute"),this.stream.client.safeEmit("TrackMuted","screenAudio"),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:"screenAudioTrackkMuted",mediaType:"screenAudio"}))},this.stream=y.stream,this.logger=y.stream.logger.getChild(()=>{var _;let b="mediaHelper";return this.audio.audioRoutingEnabled&&(b+=" WebAudio"),this.audio.webAudio&&(this.audio.webAudio.context&&this.audio.webAudio.context.state!=="running"&&(b+=" "+this.audio.webAudio.context.state),this.audio.webAudio.mixAudioConf.state!==s.AuidoMixingState.UNSTART&&(b+=" "+((_=this.audio.webAudio)===null||_===void 0?void 0:_.mixAudioConf.state))),b}),this.getSettingsEnabled="getSettings"in MediaStreamTrack.prototype,this.bindRenderStream(),A.Device.on("recording-device-changed",_=>{this.audio.micTrack&&this.audio.deviceInfo.mic.deviceId===_.device.deviceId&&(_.state==="INACTIVE"?(this.logger.error("当前使用的麦克风设备被移除，需重新启用设备",_.device),this.stream.emit("recording-device-changed",_)):A.Device.deviceHistory.audioIn.find(b=>{b.groupId,this.audio.deviceInfo.mic.groupId})||(this.logger.error(`当前麦克风已由【${this.audio.deviceInfo.mic.label}】切换至【${_.device.label}】，可能会影响通话质量`),this.audio.deviceInfo.mic.label=_.device.label,this.audio.deviceInfo.mic.groupId=_.device.groupId,this.stream.emit("recording-device-changed",_)))})}getOrCreateAudioPipeline(y="audio"){let _;const b=k.getAudioContext();if(!b)return this.logger.error("getOrCreateAudioPipeline: AudioContext is not supported"),null;if(y==="audio")if(this.audio.pipeline?_=this.audio.pipeline:(_=new I.AudioPipeline({logger:this.logger,outputStream:this.audio.audioStream,context:b}),this.audio.pipeline=_,this.logger.log("getOrCreateAudioPipeline: 初始化成功")),this.stream.isRemote)_.inputs.remote.track!==this.audio.micTrack&&(this.logger.log("getOrCreateAudioPipeline: 更新输入的Track"),_.setInput("remote",this.audio.micTrack,"remote"+this.stream.streamID));else{const E=this.audio.micTrack||this.audio.audioSource;_.inputs.local.track!==E&&(this.logger.log("getOrCreateAudioPipeline: 更新输入的Track"),_.setInput("local",E,(E==null?void 0:E.label)||"empty"))}else if(this.screenAudio.pipeline?_=this.screenAudio.pipeline:(_=new I.AudioPipeline({logger:this.logger,outputStream:this.screenAudio.screenAudioStream,context:b}),this.screenAudio.pipeline=_,this.logger.log("getOrCreateAudioPipeline/screenAudio: 初始化成功")),this.stream.isRemote)_.inputs.remote.track!==this.screenAudio.screenAudioTrack&&(this.logger.log("getOrCreateAudioPipeline/screenAudio: 更新输入的Track"),_.setInput("remote",this.screenAudio.screenAudioTrack,`remote${this.stream.streamID}/screenAudio`));else{const E=this.screenAudio.screenAudioTrack||this.screenAudio.screenAudioSource;_.inputs.local.track!==E&&(this.logger.log("getOrCreateAudioPipeline/screenAudio: 更新输入的Track"),_.setInput("local",E,(E==null?void 0:E.label)||"empty"))}return _}bindRenderStream(){O.IS_SAFARI&&R.getParameters().shimLocalCanvas==="safari"||R.getParameters().shimLocalCanvas==="all"?(this.video.videoStream.onaddtrack=async y=>{if(typeof CanvasCaptureMediaStreamTrack<"u"&&y.track instanceof CanvasCaptureMediaStreamTrack){const _=v.pcCloneTrack(y.track);m.watchTrack(_),this.logger.warn("renderStream cloned track for video:",y.track,_),m.emptyStreamWith(this.video.renderStream,_)}else m.emptyStreamWith(this.video.renderStream,y.track)},this.video.videoStream.onremovetrack=y=>{m.emptyStreamWith(this.video.renderStream,null)},this.screen.screenVideoStream.onaddtrack=async y=>{if(typeof CanvasCaptureMediaStreamTrack<"u"&&y.track instanceof CanvasCaptureMediaStreamTrack){const _=v.pcCloneTrack(y.track);m.watchTrack(_),this.logger.warn("renderStream cloned track for screen:",y.track,_),m.emptyStreamWith(this.screen.renderStream,_)}else m.emptyStreamWith(this.screen.renderStream,y.track)},this.screen.screenVideoStream.onremovetrack=y=>{m.emptyStreamWith(this.screen.renderStream,null)},this.videoThird.videoThirdStream.onaddtrack=async y=>{if(typeof CanvasCaptureMediaStreamTrack<"u"&&y.track instanceof CanvasCaptureMediaStreamTrack){const _=v.pcCloneTrack(y.track);m.watchTrack(_),this.logger.warn("renderStream cloned track for videoThird:",y.track,_),m.emptyStreamWith(this.videoThird.videoThirdStream,_)}else m.emptyStreamWith(this.videoThird.videoThirdStream,y.track)},this.videoThird.videoThirdStream.onremovetrack=y=>{m.emptyStreamWith(this.videoThird.renderStream,null)},this.videoFourth.videoFourthStream.onaddtrack=async y=>{if(typeof CanvasCaptureMediaStreamTrack<"u"&&y.track instanceof CanvasCaptureMediaStreamTrack){const _=v.pcCloneTrack(y.track);m.watchTrack(_),this.logger.warn("renderStream cloned track for videoFourth:",y.track,_),m.emptyStreamWith(this.videoFourth.renderStream,_)}else m.emptyStreamWith(this.videoFourth.renderStream,y.track)},this.videoFourth.videoFourthStream.onremovetrack=y=>{m.emptyStreamWith(this.videoFourth.renderStream,null)}):(this.video.renderStream=this.video.videoStream,this.screen.renderStream=this.screen.screenVideoStream,this.videoThird.renderStream=this.videoThird.videoThirdStream,this.videoFourth.renderStream=this.videoFourth.videoFourthStream)}assertLive(){if(!this.stream.isRemote&&!this.stream.isRemote&&this.stream.destroyed)throw this._reset(),new o.default({code:h.default.LOCALSTREAM_NOT_FOUND_ERROR,message:"assertLive: localStream 已经销毁"})}_reset(){this.stopAllEffects(),this.audio.webAudio&&(this.audio.webAudio.off("audioFilePlaybackCompleted"),this.audio.webAudio.destroy()),this.audio.webAudio=null,this.audio.micConstraint=null,this.audio.audioRoutingEnabled=!1,this.audio.micTrack&&(this.audio.micTrack.stop(),this.audio.micTrack=null),this.video.low&&(this.video.low.destroy(),this.video.low=null),this.video.videoSource=null,this.video.cameraTrack&&!this.stream.isRemote&&(this.video.cameraTrack.stop(),this.video.cameraTrack=null),this.screen.screenVideoTrack&&!this.stream.isRemote&&(this.screen.screenVideoTrack.stop(),this.screen.screenVideoTrack=null),this.videoThird.videoThirdTrack&&!this.stream.isRemote&&(this.videoThird.videoThirdTrack.stop(),this.videoThird.videoThirdTrack=null),this.videoFourth.videoFourthTrack&&!this.stream.isRemote&&(this.videoFourth.videoFourthTrack.stop(),this.videoFourth.videoFourthTrack=null),this.video.cameraConstraint={video:{}},this.screenAudio.screenAudioTrack&&(this.screenAudio.screenAudioTrack.stop(),this.screenAudio.screenAudioTrack=null),this.audio.mixAudioConf={index:0,audioBuffer:{},sounds:{}},this.audio.audioDom=null,m.emptyStreamWith(this.audio.audioStream,null),m.emptyStreamWith(this.audio.musicStream,null),m.emptyStreamWith(this.audio.micStream,null),m.emptyStreamWith(this.screenAudio.screenAudioStream,null),m.emptyStreamWith(this.video.videoStream,null),m.emptyStreamWith(this.screen.screenVideoStream,null),m.emptyStreamWith(this.screenAudio.screenAudioStream,null),m.emptyStreamWith(this.videoThird.videoThirdStream,null),m.emptyStreamWith(this.videoFourth.videoFourthStream,null)}updateWebAudio(){var y,_;if(!this.audio.webAudio){this.audio.webAudio=new k.WebAudio({mediaHelper:this,logger:this.logger}),this.audio.webAudio.on("audioFilePlaybackCompleted",this._audioFilePlaybackCompletedEvent.bind(this));const b=(_=(y=this.audio.webAudio)===null||y===void 0?void 0:y.musicDestination)===null||_===void 0?void 0:_.stream.getAudioTracks()[0];b&&m.emptyStreamWith(this.audio.musicStream,b)}this.audio.webAudio.updateTracks([{track:this.audio.micTrack||this.audio.audioSource,type:"microphone"}])}async getScreenSource(y){let _;const{width:b,height:E,frameRate:x}=this.screen.captureConfig.high;try{return _={video:{width:{ideal:b},height:{ideal:E},frameRate:{ideal:x,max:x}}},this.replaceConstraint(_,"screen"),await f.getScreenStream(_,this.logger)}catch(D){const F="screen";return D.message&&D.message.indexOf("ermission")>-1&&D.message.indexOf("denied")>-1?this.stream.client.safeEmit("accessDenied",F):D.message&&D.message.indexOf("not found")>-1?this.stream.client.safeEmit("notFound",F):D.message&&D.message.indexOf("not start video source")>-1?this.stream.client.safeEmit("beOccupied",F):D.name==="DisplaySurfaceError"?this.stream.client.safeEmit("displaySurfaceError",F):this.stream.client.safeEmit("deviceError",F),this.stream.emit("device-error",{type:F,error:D}),Promise.reject(D)}}getTrackByMediaType(y){return y==="audio"?this.audio.micTrack||this.audio.audioSource:y==="audioSlave"?this.screenAudio.screenAudioTrack||this.screenAudio.screenAudioSource:y==="video"?this.video.cameraTrack||this.video.videoSource:y==="screen"?this.screen.screenVideoTrack||this.screen.screenVideoSource:y==="videoThird"?this.videoThird.videoThirdTrack||this.videoThird.videoThirdSource:y==="videoFourth"?this.videoFourth.videoFourthTrack||this.videoFourth.videoFourthSource:null}async getStream(y){let{audio:_=!1,audioDeviceId:b="",video:E=!1,videoDeviceId:x="",screen:D=!1,sourceId:F="",screenAudio:V=!1,facingMode:N="",audioSource:L=null,videoSource:U=null,screenAudioSource:H=null,screenVideoSource:j=null,deviceId:W=""}=y;if(L&&(_=!0),U&&(E=!0),j&&(D=!0),H&&(V=!0),this.stream.isRemote)return void this.logger.error("getStream: 远端流不能够调用getStream");if(!(_||E||D||V))return void this.logger.error("getStream: 必须指定媒体类型");if(L){if(L.readyState==="ended")return void this.logger.error("不应输入已经停止的轨道:",L.kind,L.label);m.watchTrack(L),this.audio.audioSource=L,m.emptyStreamWith(this.audio.audioSourceStream,L),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(m.emptyStreamWith(this.audio.audioStream,L),this.updateAudioSender(L))),_=!1,this.stream.client.updateRecordingAudioStream()}if(U){if(U.readyState==="ended")return void this.logger.error("不应输入已经停止的轨道:",U.kind,U.label);m.watchTrack(U),this.video.videoSource=U,m.emptyStreamWith(this.video.videoStream,U),this.video.videoStream.getVideoTracks().length&&typeof this.video.encoderConfig.high.contentHint=="string"&&this.video.videoStream.getVideoTracks()[0].contentHint!==this.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.video.encoderConfig.high.contentHint),this.video.videoStream.getVideoTracks()[0].contentHint=this.video.encoderConfig.high.contentHint),E=!1}if(H){if(H.readyState==="ended")return void this.logger.error("不应输入已经停止的轨道:",H.kind,H.label);m.watchTrack(H),this.screenAudio.screenAudioSource=H,m.emptyStreamWith(this.screenAudio.screenAudioStream,H),this.listenToTrackEnded(this.screenAudio.screenAudioSource),m.emptyStreamWith(this.screenAudio.screenAudioStream,H),V=!1}if(j){if(j.readyState==="ended")return void this.logger.error("不应输入已经停止的轨道:",j.kind,j.label);m.watchTrack(j),this.screen.screenVideoSource=j,m.emptyStreamWith(this.screen.screenVideoStream,j),this.screen.screenVideoStream.getVideoTracks().length&&typeof this.screen.encoderConfig.high.contentHint=="string"&&this.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.screen.encoderConfig.high.contentHint),this.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.screen.encoderConfig.high.contentHint),D=!1}let Y=null,te=null,re=null;try{if(D){const{width:G,height:K,frameRate:de}=this.screen.captureConfig.high;if(F){re={video:{mandatory:{maxWidth:G,maxHeight:K,maxFrameRate:de,minFrameRate:5,chromeMediaSource:"desktop",chromeMediaSourceId:F}}},this.replaceConstraint(re,"screen");const B=(await f.getStream(re,this.logger)).getVideoTracks()[0];this.screen.screenVideoTrack=B,m.emptyStreamWith(this.screen.screenVideoStream,B)}else{re={video:{width:{ideal:G},height:{ideal:K},frameRate:{ideal:de,max:de}},audio:V&&this.getAudioConstraints("audioSlave")?this.getAudioConstraints("audioSlave"):V},this.replaceConstraint(re,"screen");let B=await f.getScreenStream(re,this.logger);if(this.screen.screenVideoTrack=B.getVideoTracks()[0],this.listenToTrackEnded(this.screen.screenVideoTrack),m.emptyStreamWith(this.screen.screenVideoStream,this.screen.screenVideoTrack),this.screen.screenVideoStream.getVideoTracks().length&&typeof this.screen.encoderConfig.high.contentHint=="string"&&this.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.screen.encoderConfig.high.contentHint),this.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.screen.encoderConfig.high.contentHint),V){const $=B.getAudioTracks()[0];$?(this.screenAudio.screenAudioTrack=$,m.emptyStreamWith(this.screenAudio.screenAudioStream,$),this.listenToTrackEnded($),this.stream.client.apiEventReport("setFunction",{name:"pub_second_audio",oper:"1",value:JSON.stringify({result:"success",constaints:re.audio},null," ")})):(this.logger.warn("getStream screenAudio: 未获取到屏幕共享音频"),this.stream.screenAudio=!1,this.stream.client.emit("error","screenAudioNotAllowed"))}}if(this.stream.client.apiEventReport("setFunction",{name:"set_screen",oper:"1",value:JSON.stringify({result:"success",constaints:re},null," ")}),_){Y={audio:this.getAudioConstraints("audio")},this.replaceConstraint(Y,"audio");let B=await f.getStream(Y,this.logger);this.audio.micTrack=B.getAudioTracks()[0],m.emptyStreamWith(this.audio.micStream,this.audio.micTrack),this.listenToTrackEnded(this.audio.micTrack),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(m.emptyStreamWith(this.audio.audioStream,this.audio.micTrack),this.updateAudioSender(this.audio.micTrack)));const $=C.compatAudioInputList.findSource(this.audio.micTrack.id);if($){if(this.audio.deviceInfo.mic.compatAudio=!0,this.getSettingsEnabled){const z=$.getSettings();this.audio.deviceInfo.mic.label=$.label,this.audio.deviceInfo.mic.deviceId=z.deviceId,this.audio.deviceInfo.mic.groupId=z.groupId}}else if(this.audio.deviceInfo.mic.compatAudio=!1,this.getSettingsEnabled){const z=this.audio.micTrack.getSettings();this.audio.deviceInfo.mic.label=this.audio.micTrack.label,this.audio.deviceInfo.mic.deviceId=z.deviceId,this.audio.deviceInfo.mic.groupId=z.groupId}this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:JSON.stringify({result:"success",constaints:Y.audio,track:{enabled:this.audio.micTrack.enabled,muted:this.audio.micTrack.muted,label:this.audio.micTrack.label}},null," ")})}}else if(V)this.logger.error("无法单独获取屏幕共享音频");else if(_||E){if(this.stream.isRemote)return void this.logger.error("MediaHelper.getStream:远端流不能调用getStream");const{height:G,width:K,frameRate:de}=this.video.captureConfig.high;te={audio:_&&this.getAudioConstraints("audio")?this.getAudioConstraints("audio"):void 0,video:E?{width:{ideal:K},height:{ideal:G},frameRate:{ideal:de||15}}:void 0},b&&typeof te.audio=="object"&&(te.audio.deviceId={exact:b}),te.video&&(N?te.video.facingMode={exact:N}:x&&(te.video.deviceId={exact:x})),this.replaceConstraint(te,"video");const B=await f.getStream(te,this.logger),$=B.getVideoTracks()[0],z=B.getAudioTracks()[0];if(z){this.audio.micTrack=z,this.listenToTrackEnded(this.audio.micTrack),m.emptyStreamWith(this.audio.micStream,this.audio.micTrack),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(m.emptyStreamWith(this.audio.audioStream,this.audio.micTrack),this.updateAudioSender(this.audio.micTrack)));const ie=C.compatAudioInputList.findSource(this.audio.micTrack.id);if(ie){if(this.audio.deviceInfo.mic.compatAudio=!0,this.getSettingsEnabled){const Z=ie.getSettings();this.audio.deviceInfo.mic.label=ie.label,this.audio.deviceInfo.mic.deviceId=Z.deviceId,this.audio.deviceInfo.mic.groupId=Z.groupId}}else if(this.audio.deviceInfo.mic.compatAudio=!1,this.getSettingsEnabled){const Z=this.audio.micTrack.getSettings();this.audio.deviceInfo.mic.label=this.audio.micTrack.label,this.audio.deviceInfo.mic.deviceId=Z.deviceId,this.audio.deviceInfo.mic.groupId=Z.groupId}this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:JSON.stringify({result:"success",constaints:te.audio,track:{enabled:z.enabled,muted:z.muted,label:z.label}},null," ")}),typeof te.audio=="object"&&(this.audio.micConstraint={audio:te.audio}),this.stream.client.updateRecordingAudioStream()}$&&(this.video.cameraTrack=$,m.emptyStreamWith(this.video.videoStream,$),this.video.videoStream.getVideoTracks().length&&typeof this.video.encoderConfig.high.contentHint=="string"&&this.video.videoStream.getVideoTracks()[0].contentHint!==this.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.video.encoderConfig.high.contentHint),this.video.videoStream.getVideoTracks()[0].contentHint=this.video.encoderConfig.high.contentHint),this.listenToTrackEnded(this.video.cameraTrack),this.stream.client.apiEventReport("setFunction",{name:"set_camera",oper:"1",value:JSON.stringify({result:"success",constaints:te.video,track:{enabled:$.enabled,muted:$.muted,label:$.label}})}),typeof te.video=="object"&&(this.video.cameraConstraint={video:te.video}))}this.assertLive()}catch(G){this.logger.error("getStream error:",G.name,G.message);let K="audio";return _&&this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:JSON.stringify({result:"fail",reason:""+G.message},null," ")}),E&&(K="video",this.stream.client.apiEventReport("setFunction",{name:"set_camera",oper:"1",value:JSON.stringify({result:"fail",reason:`${G.name} + ${G.message}`},null," ")})),D&&(K="screen",this.stream.client.apiEventReport("setFunction",{name:"set_screen",oper:"1",value:JSON.stringify({result:"fail",reason:`${G.name} + ${G.message}`},null," ")})),G.name==="NotAllowedError"||G.name==="PermissionDeniedError"?this.stream.client.safeEmit("accessDenied",K):G.name==="NotFoundError"?this.stream.client.safeEmit("notFound",K):G.name==="NotReadableError"?this.stream.client.safeEmit("beOccupied",K):G.name==="OverconstrainedError"?this.stream.client.safeEmit("deviceError",K):G.name==="DisplaySurfaceError"&&this.stream.client.safeEmit("displaySurfaceError",K),this.stream.emit("device-error",{type:K,error:G}),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:`getUserMediaError: ${G.name} + ${G.message}`,mediaType:K}),Promise.reject(G)}}async getSecondStream(y){let{audio:_=!1,video:b=!1}=y;if(!this.stream.isRemote)try{this.replaceConstraint(y,"video");const E=await f.getStream(y,this.logger),x=E.getAudioTracks()[0],D=E.getVideoTracks()[0];if(this.logger.log(`getSecondStream: ${x?x.label:""} ${D?D.label:""}`),x){typeof y.audio=="object"&&(this.audio.micConstraint={audio:y.audio}),this.audio.micTrack=x,this._stopTrack(this.audio.micStream),m.emptyStreamWith(this.audio.micStream,this.audio.micTrack),this.listenToTrackEnded(this.audio.micTrack),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(m.emptyStreamWith(this.audio.audioStream,this.audio.micTrack),this.updateAudioSender(this.audio.micTrack)));const F=C.compatAudioInputList.findSource(this.audio.micTrack.id);if(F){if(this.audio.deviceInfo.mic.compatAudio=!0,this.getSettingsEnabled){const V=F.getSettings();this.audio.deviceInfo.mic.label=F.label,this.audio.deviceInfo.mic.deviceId=V.deviceId,this.audio.deviceInfo.mic.groupId=V.groupId}}else if(this.audio.deviceInfo.mic.compatAudio=!1,this.getSettingsEnabled){const V=this.audio.micTrack.getSettings();this.audio.deviceInfo.mic.label=this.audio.micTrack.label,this.audio.deviceInfo.mic.deviceId=V.deviceId,this.audio.deviceInfo.mic.groupId=V.groupId}this.stream.client.updateRecordingAudioStream(),this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:JSON.stringify({result:"success",constaints:y.audio},null," ")})}if(D){typeof y.video=="object"&&(this.video.cameraConstraint={video:y.video}),this.video.cameraTrack=D,this._stopTrack(this.video.videoStream),m.emptyStreamWith(this.video.videoStream,this.video.cameraTrack),this.video.videoStream.getVideoTracks().length&&typeof this.video.encoderConfig.high.contentHint=="string"&&this.video.videoStream.getVideoTracks()[0].contentHint!==this.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.video.encoderConfig.high.contentHint),this.video.videoStream.getVideoTracks()[0].contentHint=this.video.encoderConfig.high.contentHint),this.stream.client.apiEventReport("setFunction",{name:"set_camera",oper:"1",value:JSON.stringify({result:"success",constaints:y.video,func:"switchDevices",track:{enabled:D.enabled,muted:D.muted,label:D.label}},null," ")});const F=this.stream._play.video.view;F&&(await this.stream.play(F),"width"in this.stream.renderMode.local.video&&this.stream.setLocalRenderMode(this.stream.renderMode.local.video,"video"));const V=this.stream.getSender("video","high");V!=null&&V.track?V.replaceTrack(D):this.logger.warn("getSecondStream video: 此时未发布流")}}catch(E){this.logger.error("getStream error",E.message);const x=_?"set_mic":"set_camera";return this.stream.client.apiEventReport("setFunction",{name:x,oper:"1",value:JSON.stringify({result:"fail",reason:E.message},null," ")}),Promise.reject(E)}}convert(y){const _=y.resolution,b=y.frameRate;let E={width:640,height:480,frameRate:15};return _===2?(E.width=320,E.height=180):_===4?(E.width=640,E.height=480):_===8||O.IS_IOS_SAFARI?(E.width=1280,E.height=720):_===16&&(E.width=1920,E.height=1080),b===d.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_NORMAL?E.frameRate=15:b===d.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_5?E.frameRate=5:b===d.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_10?E.frameRate=10:b===d.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_15?E.frameRate=15:b===d.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_20?E.frameRate=20:b===d.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_25?E.frameRate=25:b===d.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_30&&(E.frameRate=30),E}getAudioConstraints(y){if(this.stream.isRemote)return void this.logger.error("Remote Stream dont have audio constraints");const _=this.stream,b=_.constraintSettings[y];let E={channelCount:y==="audio"?1:2};switch(y==="audioSlave"&&(M.set3AConstraint(E,"AEC",!1),M.set3AConstraint(E,"ANS",!1),M.set3AConstraint(E,"AGC",!1)),_.audioProfile){case"standard_stereo":case"high_quality_stereo":M.set3AConstraint(E,"AGC",!1),M.set3AConstraint(E,"AEC",!1),M.set3AConstraint(E,"ANS",!1),E.channelCount=2}for(let x in b)if(["AEC","ANS","AGC"].indexOf(x)>-1){const D=x;M.set3AConstraint(E,D,b[D])}else E[x]=b[x];return M.forceAudioConstraints(E),E}getTrackSettings(){const y={};try{if(this.audio.micTrack){const _=C.compatAudioInputList.findSource(this.audio.micTrack.id);y.mic=_?{compat:!0,settings:this.getSettingsEnabled?_.getSettings():_.getConstraints(),label:_.label,readyState:_.readyState}:{settings:this.getSettingsEnabled?this.audio.micTrack.getSettings():this.audio.micTrack.getConstraints(),label:this.audio.micTrack.label,readyState:this.audio.micTrack.readyState}}this.audio.audioSource&&(y.audioSource={settings:this.getSettingsEnabled?this.audio.audioSource.getSettings():this.audio.audioSource.getConstraints(),label:this.audio.audioSource.label,readyState:this.audio.audioSource.readyState}),this.video.cameraTrack&&(y.camera={settings:this.getSettingsEnabled?this.video.cameraTrack.getSettings():this.video.cameraTrack.getConstraints(),label:this.video.cameraTrack.label,readyState:this.video.cameraTrack.readyState}),this.video.videoSource&&(y.videoSource={settings:this.getSettingsEnabled?this.video.videoSource.getSettings():this.video.videoSource.getConstraints(),label:this.video.videoSource.label,readyState:this.video.videoSource.readyState}),this.screen.screenVideoTrack&&(y.screen={settings:this.getSettingsEnabled?this.screen.screenVideoTrack.getSettings():this.screen.screenVideoTrack.getConstraints(),label:this.screen.screenVideoTrack.label,readyState:this.screen.screenVideoTrack.readyState}),this.screen.screenVideoSource&&(y.screenVideoSource={settings:this.getSettingsEnabled?this.screen.screenVideoSource.getSettings():this.screen.screenVideoSource.getConstraints(),label:this.screen.screenVideoSource.label,readyState:this.screen.screenVideoSource.readyState}),this.screenAudio.screenAudioTrack&&(y.screenAudio={settings:this.getSettingsEnabled?this.screenAudio.screenAudioTrack.getSettings():this.screenAudio.screenAudioTrack.getConstraints(),label:this.screenAudio.screenAudioTrack.label,readyState:this.screenAudio.screenAudioTrack.readyState}),this.screenAudio.screenAudioSource&&(y.screenAudioSource={settings:this.getSettingsEnabled?this.screenAudio.screenAudioSource.getSettings():this.screenAudio.screenAudioSource.getConstraints(),label:this.screenAudio.screenAudioSource.label,readyState:this.screenAudio.screenAudioSource.readyState}),A.Device.deviceHistory.audioOut[0]&&(y.audioOutDefault=A.Device.deviceHistory.audioOut[0])}catch(_){y.errName=_.name,y.errMessage=_.message}return y}updateStream(y,_){y==="audio"?(this.audio.micTrack=_,m.emptyStreamWith(this.audio.audioStream,_),this.updateWebAudio(),this.stream._play.audio.dom&&(this.stream._play.audio.dom.srcObject=this.audio.audioStream)):y==="audioSlave"?(this.screenAudio.screenAudioTrack=_,m.emptyStreamWith(this.screenAudio.screenAudioStream,_),this.stream._play.audioSlave.dom&&(this.stream._play.audioSlave.dom.srcObject=this.screenAudio.screenAudioStream)):y==="video"?(this.video.cameraTrack=_,m.emptyStreamWith(this.video.videoStream,_),this.video.videoStream.getVideoTracks().length&&typeof this.video.encoderConfig.high.contentHint=="string"&&this.video.videoStream.getVideoTracks()[0].contentHint!==this.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.video.encoderConfig.high.contentHint),this.video.videoStream.getVideoTracks()[0].contentHint=this.video.encoderConfig.high.contentHint),this.stream._play.video.dom&&(this.stream._play.video.dom.srcObject=this.video.renderStream)):y==="screen"?(this.screen.screenVideoTrack=_,m.emptyStreamWith(this.screen.screenVideoStream,_),this.screen.screenVideoStream.getVideoTracks().length&&typeof this.screen.encoderConfig.high.contentHint=="string"&&this.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.screen.encoderConfig.high.contentHint),this.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.screen.encoderConfig.high.contentHint),this.stream._play.screen.dom&&(this.stream._play.screen.dom.srcObject=this.screen.renderStream)):y==="videoThird"?(this.videoThird.videoThirdTrack=_,m.emptyStreamWith(this.videoThird.videoThirdStream,_),this.videoThird.videoThirdStream.getVideoTracks().length&&typeof this.videoThird.encoderConfig.high.contentHint=="string"&&this.videoThird.videoThirdStream.getVideoTracks()[0].contentHint!==this.videoThird.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint videoThird high",this.videoThird.encoderConfig.high.contentHint),this.videoThird.videoThirdStream.getVideoTracks()[0].contentHint=this.videoThird.encoderConfig.high.contentHint),this.stream._play.videoThird.dom&&(this.stream._play.videoThird.dom.srcObject=this.videoThird.renderStream)):y==="videoFourth"&&(this.videoFourth.videoFourthTrack=_,m.emptyStreamWith(this.videoFourth.videoFourthStream,_),this.videoFourth.videoFourthStream.getVideoTracks().length&&typeof this.videoFourth.encoderConfig.high.contentHint=="string"&&this.videoFourth.videoFourthStream.getVideoTracks()[0].contentHint!==this.videoFourth.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint videoFourth high",this.videoFourth.encoderConfig.high.contentHint),this.videoFourth.videoFourthStream.getVideoTracks()[0].contentHint=this.videoFourth.encoderConfig.high.contentHint),this.stream._play.videoFourth.dom&&(this.stream._play.videoFourth.dom.srcObject=this.videoFourth.renderStream))}stopStream(y){var _,b,E,x,D,F,V,N;let L="set_mic";y==="audio"?(R.getParameters().tracks.audio=R.getParameters().tracks.audio.filter(U=>this.audio.micTrack!==U),(_=this.audio.micTrack)===null||_===void 0||_.stop(),this.audio.micTrack=null,m.emptyStreamWith(this.audio.micStream,null),this.audio.audioSource=null,m.emptyStreamWith(this.audio.audioSourceStream,null),this.updateWebAudio(),this.canDisableAudioRouting()&&this.disableAudioRouting(),this.stream.isRemote||(b=this.stream.audioLevelHelper)===null||b===void 0||b.updateStream(this.screenAudio.screenAudioStream)):y==="screenAudio"?((E=this.screenAudio.screenAudioTrack)===null||E===void 0||E.stop(),this.screenAudio.screenAudioTrack=null,this.screenAudio.screenAudioSource=null,m.emptyStreamWith(this.screenAudio.screenAudioStream,null),this.stream.isRemote||(x=this.stream.audioLevelHelperSlave)===null||x===void 0||x.updateStream(this.screenAudio.screenAudioStream),L="pub_second_audio"):y==="video"?(L="set_camera",R.getParameters().tracks.video=R.getParameters().tracks.video.filter(U=>this.video.cameraTrack!==U),(D=this.video.cameraTrack)===null||D===void 0||D.stop(),this.video.cameraTrack=null,this.video.videoSource=null,m.emptyStreamWith(this.video.videoStream,null)):y==="screen"?(L="set_screen",(F=this.screen.screenVideoTrack)===null||F===void 0||F.stop(),this.screen.screenVideoTrack=null,this.screen.screenVideoSource=null,m.emptyStreamWith(this.screen.screenVideoStream,null)):y==="videoThird"?(L="set_video_third",(V=this.videoThird.videoThirdTrack)===null||V===void 0||V.stop(),this.videoThird.videoThirdTrack=null,m.emptyStreamWith(this.videoThird.videoThirdStream,null)):y==="videoFourth"&&(L="set_video_fourth",(N=this.videoFourth.videoFourthTrack)===null||N===void 0||N.stop(),this.videoFourth.videoFourthTrack=null,m.emptyStreamWith(this.videoFourth.videoFourthStream,null)),this.stream.client.apiEventReport("setFunction",{name:L,oper:"0",value:"success"})}_stopTrack(y){if(!y||this.stream.isRemote)return;this.logger.log("清除stream: ",y);const _=y.getTracks();this.logger.log("清除stream tracks: ",..._),_&&_.length!==0&&_.forEach(b=>{if(b.kind==="audio"){const E=R.getParameters().tracks.audio.findIndex(x=>b===x);T.Logger.warn(`Stopping AUDIOTRACK#${E} ${b.id}, ${b.label}, ${b.readyState}`),R.getParameters().tracks.audio=R.getParameters().tracks.audio.filter(x=>b!==x)}else{const E=R.getParameters().tracks.video.findIndex(x=>b===x);T.Logger.warn(`Stopping VIDEOTRACK#${E} ${b.id}, ${b.label}, ${b.readyState}`),R.getParameters().tracks.video=R.getParameters().tracks.video.filter(x=>b!==x)}b.stop(),y.removeTrack(b),this.audio.micTrack===b&&(this.audio.micTrack=null,this.audio.deviceInfo.mic={compatAudio:C.compatAudioInputList.enabled,label:""},this.updateWebAudio()),this.screenAudio.screenAudioTrack===b&&(this.screenAudio.screenAudioTrack=null,this.updateWebAudio()),this.video.cameraTrack===b&&(this.video.cameraTrack=null),this.screen.screenVideoTrack===b&&(this.screen.screenVideoTrack=null),this.videoThird.videoThirdTrack===b&&(this.videoThird.videoThirdTrack=null),this.videoFourth.videoFourthTrack===b&&(this.videoFourth.videoFourthTrack=null)})}getAudioTrack(){var y;return(y=this.audio)===null||y===void 0?void 0:y.audioStream.getAudioTracks()[0]}getVideoTrack(){var y;return(y=this.video)===null||y===void 0?void 0:y.videoStream.getVideoTracks()[0]}setGain(y,_){this.audio.webAudio?(this.logger.log("setGain",y),this.audio.webAudio.setGain(y,_),this.canDisableAudioRouting()&&this.disableAudioRouting()):this.logger.log("setGain: 缺失本地音频")}getGain(){var y;return((y=this.audio.webAudio)===null||y===void 0?void 0:y.getVolumeData())||"0.0"}canDisableAudioRouting(){var y,_;let b=!0;if(!this.audio.webAudio||!((y=this.audio.stageAIProcessing)===null||y===void 0)&&y.enabled)return!1;this.audio.webAudio.mixAudioConf.state!==s.AuidoMixingState.PLAYED&&this.audio.webAudio.mixAudioConf.state!==s.AuidoMixingState.PAUSED||(b=!1),Object.values(this.audio.mixAudioConf.sounds).forEach(x=>{x.state!=="STARTING"&&x.state!=="PLAYED"&&x.state!=="PAUSED"||(b=!1)});const E=this.audio.webAudio.getGainMin();return!(!((_=this.audio.webAudio.Jungle)===null||_===void 0)&&_.connected)&&b&&E===1&&this.audio.webAudio.audioInArr.length<=1}setAudioEffectLite(y,_){this.audio.webAudio?this.audio.webAudio.setAudioEffectLite(y,_):this.logger.warn("WebAudio is not available")}_audioFilePlaybackCompletedEvent(){this.canDisableAudioRouting()&&this.disableAudioRouting()}startAudioMixing(y){let _,b;return this.logger.log("开始伴音:",JSON.stringify(y,null," ")),Object.assign(this.audio.mixAudioConf,y),this.audio.mixAudioConf.audioFilePath?this.getAudioInputTracks().length!==0&&this.stream.pubStatus.audio.audio?this.audio.webAudio&&this.audio.webAudio.context||(b="startAudioMixing() 浏览器环境不支持伴音",_=h.default.AUDIO_MIX_NO_SUPPORT):(b="startAudioMixing() 当前没有开启过麦克风",_=h.default.AUDIO_MIX_NO_AUDIO):(b="startAudioMixing() 没有设置云端文件路径",_=h.default.AUDIO_MIX_FILE_ERROR),_?(this.logger.error(b),this.stream.client.apiFrequencyControl({name:"startAudioMixing",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:_}),null," ")}),Promise.reject(new o.default({code:_,message:b}))):(this.stream.client.apiFrequencyControl({name:"startAudioMixing",code:0,param:JSON.stringify(this.audio.mixAudioConf,null," ")}),this.audio.webAudio&&(this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource&&this.audio.webAudio.mixAudioConf.state===s.AuidoMixingState.PLAYED&&(this.logger.log("startAudioMixing() 当前已经开启伴音，先关闭之前的伴音"),this.stopAudioMixing()),this.audio.webAudio.mixAudioConf.state,s.AuidoMixingState.STARTING),this.audio.mixAudioConf.audioFilePath&&this.audio.mixAudioConf.audioBuffer[this.audio.mixAudioConf.audioFilePath]?(this.logger.log("startAudioMixing() 开始伴音, 已经加载过云端音乐"),this.startMix(this.audio.mixAudioConf.index)):(this.logger.log("startAudioMixing() 开始伴音, 先加载云端音乐"),this.loadRemoteAudioFile(this.audio.mixAudioConf.index)))}loadRemoteAudioFile(y){const _=this.audio.mixAudioConf.audioFilePath;return _?u.ajax({url:_,type:"GET",dataType:"arraybuffer"}).then(b=>(this.logger.log("loadRemoteAudioFile 加载云端音乐成功"),new Promise((E,x)=>{var D,F;(F=(D=this.audio.webAudio)===null||D===void 0?void 0:D.context)===null||F===void 0||F.decodeAudioData(b,V=>{var N;this.logger.log("loadRemoteAudioFile 云端音乐解码成功"),this.audio.mixAudioConf.audioBuffer[_]=V,(N=this.startMix(y))===null||N===void 0||N.then(L=>{E(L)})},V=>{x(new o.default({code:h.default.AUDIO_MIX_FILE_ERROR,message:"loadRemoteAudioFile: 云端音乐解码失败: "+V.message}))})}))).catch(b=>Promise.reject(new o.default({code:h.default.AUDIO_MIX_FILE_ERROR,message:`loadRemoteAudioFile: 加载云端音乐失败: ${b.name} ${b.message}`}))):(this.logger.warn("loadRemoteAudioFile() audioFilePath未设置"),Promise.resolve())}delay(y){return new Promise(_=>setTimeout(_,y))}startMix(y){var _;if(this.logger.log("startMix 开始混音:",JSON.stringify(this.audio.mixAudioConf)),y!==this.audio.mixAudioConf.index)return this.logger.log("startMix: 该次伴音已经取消"),Promise.resolve();this.audio.audioRoutingEnabled||this.enableAudioRouting();const{audioFilePath:b="",loopback:E=!1,replace:x=!1,cycle:D=0,playStartTime:F=0,volume:V=255,auidoMixingEnd:N=null}=this.audio.mixAudioConf;return(_=this.audio.webAudio)===null||_===void 0?void 0:_.startMix({buffer:this.audio.mixAudioConf.audioBuffer[b],loopback:E,replace:x,cycle:D,playStartTime:F,volume:V,auidoMixingEnd:N})}stopAudioMixing(y=!0){var _;return!((_=this.audio.webAudio)===null||_===void 0)&&_.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource?(this.stream.client.apiFrequencyControl({name:"stopAudioMixing",code:0,param:JSON.stringify(this.audio.mixAudioConf,null," ")}),this.audio.webAudio.stopAudioMixing(y)):(this.logger.error("stopAudioMixing() 当前没有开启伴音"),this.stream.client.apiFrequencyControl({name:"stopAudioMixing",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:"stopAudioMixing() 当前没有开启伴音"}),null," ")}),Promise.reject(new o.default({code:h.default.AUDIO_MIX_NOT_STATE_ERROR,message:"stopAudioMixing() 当前没有开启伴音"})))}pauseAudioMixing(){var y;return!((y=this.audio.webAudio)===null||y===void 0)&&y.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource&&this.audio.webAudio.mixAudioConf.state===s.AuidoMixingState.PLAYED?(this.stream.client.apiFrequencyControl({name:"pauseAudioMixing",code:0,param:JSON.stringify(this.audio.mixAudioConf,null," ")}),this.audio.webAudio&&this.audio.webAudio.pauseAudioMixing()):(this.logger.error("pauseAudioMixing() 当前没有开启伴音"),this.stream.client.apiFrequencyControl({name:"pauseAudioMixing",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:"pauseAudioMixing() 当前没有开启伴音"}),null," ")}),Promise.reject(new o.default({code:h.default.AUDIO_MIX_NOT_STATE_ERROR,message:"pauseAudioMixing() 当前没有开启伴音"})))}resumeAudioMixing(){var y;let _,b;if(!((y=this.audio.webAudio)===null||y===void 0)&&y.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource?this.audio.webAudio.mixAudioConf.state!==s.AuidoMixingState.PAUSED&&(b="resumeAudioMixing() 当前没有暂停伴音",_=h.default.AUDIO_MIX_NOT_PAUSE):(b="resumeAudioMixing() 当前没有开启伴音",_=h.default.AUDIO_MIX_NOT_STATE_ERROR),this.stream.client.apiFrequencyControl({name:"resumeAudioMixing",code:_?-1:0,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:b||""}),null," ")}),_)return this.logger.error(b),Promise.reject(new o.default({code:_,message:b}));if(!this.audio.webAudio)return;let{audioFilePath:E="",loopback:x=!1,replace:D=!1,cycle:F=0,playStartTime:V=0,auidoMixingEnd:N=null}=this.audio.mixAudioConf,L=(this.audio.webAudio.mixAudioConf.pauseTime-this.audio.webAudio.mixAudioConf.startTime)/1e3+this.audio.webAudio.mixAudioConf.playStartTime;return L>this.audio.webAudio.mixAudioConf.totalTime&&(this.logger.log("播放过的圈数 playedCycle: ",Math.floor(L/this.audio.webAudio.mixAudioConf.totalTime)),F-=Math.floor(L/this.audio.webAudio.mixAudioConf.totalTime),this.audio.mixAudioConf.cycle=F),this.audio.webAudio.mixAudioConf.setPlayStartTime?(this.logger.log("暂停期间，用户设置混音播放时间: ",this.audio.webAudio.mixAudioConf.setPlayStartTime),V=this.audio.webAudio.mixAudioConf.setPlayStartTime,this.audio.webAudio.mixAudioConf.setPlayStartTime=0):(this.logger.log("恢复混音:",JSON.stringify(this.audio.webAudio.mixAudioConf)),this.logger.log("已经播放的时间: ",L),L>this.audio.webAudio.mixAudioConf.totalTime&&(L%=this.audio.webAudio.mixAudioConf.totalTime),V=L),this.logger.log("回复重置的时间点：",V),this.audio.webAudio.resumeAudioMixing({buffer:this.audio.mixAudioConf.audioBuffer[E],loopback:x,replace:D,cycle:F,playStartTime:V,auidoMixingEnd:N})}setAudioMixingVolume(y){var _;let b,E;return!((_=this.audio.webAudio)===null||_===void 0)&&_.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource?(!Number.isInteger(y)||y<0||y>255)&&(E="adjustAudioMixingVolume() volume应该是1-255的number类型",b=h.default.AUDIO_MIX_VOLUME_ERROR):(E="adjustAudioMixingVolume() 当前没有开启伴音",b=h.default.AUDIO_MIX_NOT_STATE_ERROR),this.stream.client.apiFrequencyControl({name:"adjustAudioMixingVolume",code:b?-1:0,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:E||"",volume:y}),null," ")}),b?(this.logger.error(E),Promise.reject(new o.default({code:b,message:E}))):this.audio.webAudio&&this.audio.webAudio.setAudioMixingVolume(y)}setAudioMixingPlayTime(y){var _;let b,E;if(!((_=this.audio.webAudio)===null||_===void 0)&&_.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource){if(y<0)E="setAudioMixingPosition(): 设置的playStartTime 小于 0 了",b=h.default.AUDIO_MIX_PLAY_START_TIME_ERROR;else if(y>=this.audio.webAudio.mixAudioConf.totalTime)E="setAudioMixingPosition(): 设置的playStartTime大于音频文件总时长了",b=h.default.AUDIO_MIX_PLAY_START_TIME_ERROR;else if(this.audio.webAudio.mixAudioConf.state===s.AuidoMixingState.PAUSED)return this.audio.webAudio.mixAudioConf.setPlayStartTime=y,this.logger.log("setAudioMixingPosition() 当前正在暂停，记录设置的播放位置，在恢复伴音时，跳转到此次设置的播放位置: ",y),Promise.resolve()}else E="setAudioMixingPosition(): 当前没有开启伴音",b=h.default.AUDIO_MIX_NOT_STATE_ERROR;return this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:b?-1:0,param:JSON.stringify({playTime:y,reason:E||""},null," ")}),b?(this.logger.error(E),Promise.reject(new o.default({code:b,message:E}))):new Promise((x,D)=>{this.stopAudioMixing(!1).then(F=>{if(!this.audio.webAudio)return;this.audio.mixAudioConf.playStartTime=y;let{audioFilePath:V="",loopback:N=!1,replace:L=!1,cycle:U=0,playStartTime:H=0,auidoMixingEnd:j=null}=this.audio.mixAudioConf;this.logger.log("设置混音的播放位置:",this.audio.webAudio.mixAudioConf);let W=(Date.now()-this.audio.webAudio.mixAudioConf.startTime)/1e3+this.audio.webAudio.mixAudioConf.playStartTime;this.logger.log("已经播放的时间: ",W),W>this.audio.webAudio.mixAudioConf.totalTime&&(this.logger.log("播放过的圈数 playedCycle: ",Math.floor(W/this.audio.webAudio.mixAudioConf.totalTime)),U-=Math.floor(W/this.audio.webAudio.mixAudioConf.totalTime),this.audio.mixAudioConf.cycle=U),this.logger.log(`setAudioMixingPlayTime, playTime: ${y}, cycle: ${U}`),this.audio.webAudio.setAudioMixingPlayTime({buffer:this.audio.mixAudioConf.audioBuffer[V],loopback:N,replace:L,cycle:U,playStartTime:H,auidoMixingEnd:j}).then(Y=>{this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:0,param:JSON.stringify({playTime:y},null," ")}),x(Y)}).catch(Y=>{this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:-1,param:JSON.stringify({playTime:y,reason:"重新播放伴音失败"+Y.message},null," ")}),D(Y)})}).catch(F=>(this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:-1,param:JSON.stringify({playTime:y,reason:"暂停当前播放失败"+F.message},null," ")}),Promise.reject(F)))})}getAudioMixingPlayedTime(){var y,_;return!((y=this.audio.webAudio)===null||y===void 0)&&y.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource?(this.stream.client.apiFrequencyControl({name:"getAudioMixingCurrentPosition",code:0,param:JSON.stringify({playTime:(_=this.audio.webAudio.getAudioMixingPlayedTime())===null||_===void 0?void 0:_.playedTime},null," ")}),this.audio.webAudio.getAudioMixingPlayedTime()):(this.logger.log("getAudioMixingCurrentPosition() 当前没有开启伴音"),Promise.reject(new o.default({code:h.default.AUDIO_MIX_NOT_STATE_ERROR,message:"getAudioMixingCurrentPosition() 当前没有开启伴音"})))}getAudioMixingTotalTime(){var y,_;return!((y=this.audio.webAudio)===null||y===void 0)&&y.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource?(this.stream.client.apiFrequencyControl({name:"getAudioMixingDuration",code:0,param:JSON.stringify({totalTime:(_=this.audio.webAudio.getAudioMixingTotalTime())===null||_===void 0?void 0:_.totalTime},null," ")}),this.audio.webAudio.getAudioMixingTotalTime()):(this.logger.log("getAudioMixingDuration() 当前没有开启伴音"),Promise.reject(new o.default({code:h.default.AUDIO_MIX_NOT_STATE_ERROR,message:"getAudioMixingDuration() 当前没有开启伴音"})))}isMixAuido(){return!!(this.audio.webAudio&&this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource)}_initSoundIfNotExists(y,_){this.audio.mixAudioConf.sounds[y]||(this.audio.mixAudioConf.sounds[y]={soundId:y,state:"UNSTART",filePath:_||"",volume:100,sourceNode:null,gainNode:null,cycle:1,playStartTime:0,playOverTime:0,pauseTime:0,startTime:0,totalTime:0,options:{}}),_&&(this.audio.mixAudioConf.sounds[y].filePath=_)}async playEffect(y,_){const{soundId:b,filePath:E,cycle:x=1}=y,D={tag:"Stream.playEffect:filePath",value:E};g.checkExists(D);const F={tag:"Stream.playEffect:soundId",value:b,min:1,max:1e4};g.isExistOptions(F).result&&g.checkValidInteger(F);const V={tag:"Stream.playEffect:cycle",value:x,min:1,max:1e4};if(g.isExistOptions(V).result&&g.checkValidInteger(V),this._initSoundIfNotExists(b,E),this.audio.audioRoutingEnabled||this.enableAudioRouting(),this.getAudioInputTracks().length===0||!this.stream.pubStatus.audio.audio)return Promise.reject(new o.default({code:h.default.AUDIO_EFFECT_NO_AUDIO,message:"playEffect() 当前没有开启麦克风，无法使用音效功能"}));if(!this.audio.webAudio||!this.audio.webAudio.context)return this.logger.log("playEffect() 浏览器不支持"),Promise.reject(new o.default({code:h.default.AUDIO_EFFECT_NO_SUPPORT,message:"playEffect() 当前浏览器不支持音效功能"}));if(this.audio.mixAudioConf.sounds[b]&&(this.audio.mixAudioConf.sounds[b].state==="STARTING"||this.audio.mixAudioConf.sounds[b].state==="PLAYED"||this.audio.mixAudioConf.sounds[b].state==="PAUSED")&&(this.logger.log(`pauseEffect: 该音效文件正处于: ${this.audio.mixAudioConf.sounds[b].state} 状态`),_===void 0))return Promise.reject(new o.default({code:h.default.AUDIO_EFFECT_ERROR,message:"playEffect() playStartTime 异常"}));this.audio.mixAudioConf.sounds[b].state="STARTING",this.audio.mixAudioConf.audioBuffer[E]?this.logger.log("playEffect: 已经 load 音效文件"):(this.logger.log("playEffect, 先 load 音效文件"),await this.preloadEffect(b,E));try{const N=this.audio.webAudio.createAudioBufferSource(this.audio.mixAudioConf.audioBuffer[E]);this.audio.mixAudioConf.sounds[b].sourceNode=N.sourceNode,N&&N.sourceNode&&(N.sourceNode.onended=U=>{this.stopEffect(b)}),this.audio.mixAudioConf.sounds[b].gainNode=N.gainNode,this.audio.mixAudioConf.sounds[b].totalTime=this.audio.mixAudioConf.audioBuffer[E]&&this.audio.mixAudioConf.audioBuffer[E].duration,this.audio.mixAudioConf.sounds[b].cycle=x;const L=this.audio.mixAudioConf.audioBuffer[E]&&this.audio.mixAudioConf.audioBuffer[E].duration;this.audio.mixAudioConf.sounds[b].playOverTime=L,x>1&&(this.audio.mixAudioConf.sounds[b].playOverTime=x*L-this.audio.mixAudioConf.sounds[b].playStartTime),this.audio.mixAudioConf.sounds[b].playStartTime=_||0,this.audio.webAudio.startAudioEffectMix(this.audio.mixAudioConf.sounds[b]),this.audio.mixAudioConf.sounds[b].state="PLAYED",this.audio.mixAudioConf.sounds[b].startTime=Date.now(),this.stream.client.apiFrequencyControl({name:"playEffect",code:0,param:JSON.stringify(y,null," ")})}catch{}}async stopEffect(y){var _;const b={tag:"Stream.stopEffect:soundId",value:y};let E,x;if(g.isExistOptions(b).result&&g.checkValidInteger(b),this.audio.mixAudioConf.sounds[y]||(x="stopEffect() soundId找不到对应的音效文件",E=h.default.AUDIO_EFFECT_FILE_LOST_ERROR),E)throw new o.default({code:E,message:x});(_=this.audio.webAudio)===null||_===void 0||_.stopAudioEffectMix(this.audio.mixAudioConf.sounds[y]),this.audio.mixAudioConf.sounds[y].state="STOPED",this._audioFilePlaybackCompletedEvent(),this.stream.client.apiFrequencyControl({name:"stopEffect",code:0,param:JSON.stringify(y,null," ")})}async pauseEffect(y){const _={tag:"Stream.pauseEffect:soundId",value:y};let b,E;if(g.isExistOptions(_).result&&g.checkValidInteger(_),this.audio.mixAudioConf.sounds[y]){if(this.audio.mixAudioConf.sounds[y].state==="PAUSED")return void this.logger.log("pauseEffect: 已经暂停");this.audio.mixAudioConf.sounds[y].state!=="PLAYED"&&(this.logger.log("pauseEffect: 当前没有开启该音效"),E="pauseEffect() 当前没有开启该音效",b=h.default.AUDIO_EFFECT_NOT_STATE_ERROR)}else E="pauseEffect() soundId找不到对应的音效文件",b=h.default.AUDIO_EFFECT_FILE_LOST_ERROR;if(b)throw new o.default({code:b,message:E});if(!this.audio.webAudio)return;this.audio.webAudio.stopAudioEffectMix(this.audio.mixAudioConf.sounds[y]),this.audio.mixAudioConf.sounds[y].pauseTime=Date.now(),this.audio.mixAudioConf.sounds[y].state="PAUSED";let x=(this.audio.mixAudioConf.sounds[y].pauseTime-this.audio.mixAudioConf.sounds[y].startTime)/1e3+this.audio.mixAudioConf.sounds[y].playStartTime;this.logger.log("pauseEffect 已经播放的时间: ",x),x>this.audio.mixAudioConf.sounds[y].totalTime&&(x%=this.audio.mixAudioConf.sounds[y].totalTime),this.logger.log("pauseEffect 暂停位置: ",x),this.stream.client.apiFrequencyControl({name:"pauseEffect",code:0,param:JSON.stringify(y,null," ")})}async resumeEffect(y){const _={tag:"Stream.resumeEffect:soundId",value:y};let b,E;if(g.isExistOptions(_).result&&g.checkValidInteger(_),this.audio.mixAudioConf.sounds[y]?this.audio.mixAudioConf.sounds[y].state!=="PAUSED"&&(E="resumeEffect() 当前没有暂停该音效文件",b=h.default.AUDIO_EFFECT_NOT_PAUSE):(E="resumeEffect() soundId找不到对应的音效文件",b=h.default.AUDIO_EFFECT_FILE_LOST_ERROR),b)throw new o.default({code:b,message:E});if(!this.audio.webAudio)return;let x=(this.audio.mixAudioConf.sounds[y].pauseTime-this.audio.mixAudioConf.sounds[y].startTime)/1e3+this.audio.mixAudioConf.sounds[y].playStartTime;if(this.logger.log("resumeEffect 已经播放的时间: ",x),x>this.audio.mixAudioConf.sounds[y].totalTime){const D=Math.floor(x/this.audio.mixAudioConf.sounds[y].totalTime);this.logger.log("播放过的圈数 playedCycle: ",D),x%=this.audio.mixAudioConf.sounds[y].totalTime,this.audio.mixAudioConf.sounds[y].cycle=this.audio.mixAudioConf.sounds[y].cycle-D}this.audio.mixAudioConf.sounds[y].playOverTime=this.audio.mixAudioConf.sounds[y].totalTime,this.audio.mixAudioConf.sounds[y].cycle>1&&(this.audio.mixAudioConf.sounds[y].playOverTime=this.audio.mixAudioConf.sounds[y].cycle*this.audio.mixAudioConf.sounds[y].totalTime-this.audio.mixAudioConf.sounds[y].playStartTime),x>this.audio.mixAudioConf.sounds[y].totalTime&&(x%=this.audio.mixAudioConf.sounds[y].totalTime),this.audio.mixAudioConf.sounds[y].playStartTime=x,this.logger.log("resumeEffect 回复重置的时间点：",x),this.playEffect({soundId:y,filePath:this.audio.mixAudioConf.sounds[y].filePath,cycle:this.audio.mixAudioConf.sounds[y].cycle},x),this.audio.mixAudioConf.sounds[y].state="PLAYED",this.audio.mixAudioConf.sounds[y].startTime=Date.now(),this.stream.client.apiFrequencyControl({name:"resumeEffect",code:0,param:JSON.stringify(y,null," ")})}async setVolumeOfEffect(y,_){var b;const E={tag:"Stream.setVolumeOfEffect:soundId",value:y,min:1};if(g.isExistOptions(E).result&&g.checkValidInteger(E),!this.audio.mixAudioConf.sounds[y])throw new o.default({code:h.default.AUDIO_EFFECT_FILE_LOST_ERROR,message:"resumeEffect() soundId找不到对应的音效文件"});const x={tag:"Stream.setVolumeOfEffect:volume",value:_,min:0,max:100};g.isExistOptions(x).result&&g.checkValidInteger(x),this.logger.log(`setVolumeOfEffect 设置 ${y} 音效文件的音量: ${_}`),this._initSoundIfNotExists(y);const D=(b=this.audio.mixAudioConf.sounds[y])===null||b===void 0?void 0:b.gainNode;D?D.gain.value=_/100:this.logger.log("setVolumeOfEffect: no gainNode"),this.audio.mixAudioConf.sounds[y].volume=_,this.stream.client.apiFrequencyControl({name:"setVolumeOfEffect",code:0,param:JSON.stringify({soundId:y,volume:_},null," ")})}async preloadEffect(y,_){const b={tag:"Stream.preloadEffect:filePath",value:_};g.checkExists(b);const E={tag:"Stream.preloadEffect:soundId",value:y};if(g.isExistOptions(E).result&&g.checkValidInteger(E),this.logger.log(`preloadEffect 设置soundId: ${y}, 音效文件的filePath: ${_}`),this._initSoundIfNotExists(y,_),this.audio.audioRoutingEnabled||this.enableAudioRouting(),this.audio.mixAudioConf.audioBuffer[_])this.logger.log("preloadEffect: 已经 load 音效文件");else try{await this.loadAudioBuffer(_),this.stream.client.apiFrequencyControl({name:"preloadEffect",code:0,param:JSON.stringify({soundId:y,filePath:_},null," ")})}catch(x){throw this.logger.error("preloadEffect 错误: ",x.name,x.message),this.stream.client.apiFrequencyControl({name:"preloadEffect",code:-1,param:JSON.stringify({reason:x.message},null," ")}),x}}async unloadEffect(y){const _={tag:"Stream.unloadEffect:soundId",value:y,min:1};return g.isExistOptions(_).result&&g.checkValidInteger(_),this.logger.log(`unloadEffect() ${y} 音效文件`),this.audio.mixAudioConf.sounds[y]?this.audio.mixAudioConf.sounds[y].state!=="UNSTART"&&this.audio.mixAudioConf.sounds[y].state!=="STOPED"?(this.logger.log("unloadEffect() 该音效文件正在播放"),Promise.reject(new o.default({code:h.default.AUDIO_EFFECT_PLAY_ALREADY,message:"unloadEffect() 该音效文件正在播放"}))):(delete this.audio.mixAudioConf.audioBuffer[this.audio.mixAudioConf.sounds[y].filePath],delete this.audio.mixAudioConf.sounds[y],void this.stream.client.apiFrequencyControl({name:"unloadEffect",code:0,param:JSON.stringify({soundId:y},null," ")})):(this.logger.log("unloadEffect() 没有该音效文件"),Promise.reject(new o.default({code:h.default.AUDIO_EFFECT_FILE_LOST_ERROR,message:"unloadEffect() soundId找不到对应的音效文件"})))}getEffectsVolume(){this.logger.log("getEffectsVolume()");const y=[];return Object.values(this.audio.mixAudioConf.sounds).forEach(_=>{y.push({soundId:_.soundId,volume:_.volume})}),this.stream.client.apiFrequencyControl({name:"getEffectsVolume",code:0,param:JSON.stringify(y,null,2)}),y}setEffectsVolume(y){const _={tag:"Stream.setEffectsVolume:volume",value:y,min:0,max:100};g.isExistOptions(_).result&&g.checkValidInteger(_),this.logger.log("setEffectsVolume(), 设置音量: "+y),Object.values(this.audio.mixAudioConf.sounds).forEach(b=>{this.setVolumeOfEffect(b.soundId,y)}),this.stream.client.apiFrequencyControl({name:"setEffectsVolume",code:0,param:JSON.stringify({volume:y},null,2)})}async stopAllEffects(){this.logger.log("stopAllEffects()"),Object.values(this.audio.mixAudioConf.sounds).forEach(y=>{y.state!=="PLAYED"&&y.state!=="PAUSED"||this.stopEffect(y.soundId)}),this.stream.client.apiFrequencyControl({name:"stopAllEffects",code:0,param:JSON.stringify("stopAllEffects",null,2)})}async pauseAllEffects(){this.logger.log("pauseAllEffects()"),Object.values(this.audio.mixAudioConf.sounds).forEach(y=>{y.state==="PLAYED"&&this.pauseEffect(y.soundId)}),this.stream.client.apiFrequencyControl({name:"pauseAllEffects",code:0,param:JSON.stringify("pauseAllEffects",null,2)})}async resumeAllEffects(){this.logger.log("resumeAllEffects()"),Object.values(this.audio.mixAudioConf.sounds).forEach(y=>{y.state==="PAUSED"&&this.resumeEffect(y.soundId)}),this.stream.client.apiFrequencyControl({name:"resumeAllEffects",code:0,param:JSON.stringify("resumeAllEffects",null,2)})}getAudioEffectsTotalTime(y){const{soundId:_,filePath:b,cycle:E=1}=y;if(!this.audio.mixAudioConf||JSON.stringify(this.audio.mixAudioConf.sounds)==="{}")return this.logger.log("getAudioEffectsDuration: 当前没有音效文件"),Promise.resolve();let x;return this._initSoundIfNotExists(_,b),this.audio.mixAudioConf.sounds[_].state==="PLAYED"&&(x=this.audio.mixAudioConf.sounds[_].totalTime),this.stream.client.apiFrequencyControl({name:"getAudioEffectsDuration",code:0,param:JSON.stringify({totalTime:x},null," ")}),x}getAudioEffectsPlayedTime(y){const{soundId:_,filePath:b,cycle:E=1}=y;if(!this.audio.mixAudioConf||JSON.stringify(this.audio.mixAudioConf.sounds)==="{}")return this.logger.log("getAudioEffectsCurrentPosition() 当前没有音效文件"),Promise.resolve();this._initSoundIfNotExists(_,b);let x=Date.now();this.audio.mixAudioConf.sounds[_].state=="PAUSED"&&(this.logger.log("getAudioEffectsCurrentPosition() 当前是暂停状态"),x=this.audio.mixAudioConf.sounds[_].pauseTime);let D=(x-this.audio.mixAudioConf.sounds[_].startTime)/1e3+this.audio.mixAudioConf.sounds[_].playStartTime;return D>this.audio.mixAudioConf.sounds[_].totalTime&&(D%=this.audio.mixAudioConf.sounds[_].totalTime),this.stream.client.apiFrequencyControl({name:"getAudioEffectsCurrentPosition",code:0,param:JSON.stringify({playTime:D},null," ")}),{playedTime:D}}loadAudioBuffer(y){return u.ajax({url:y,type:"GET",dataType:"arraybuffer"}).then(_=>(this.logger.log("loadAudioBuffer 加载 audio file 成功"),new Promise((b,E)=>{var x,D;(D=(x=this.audio.webAudio)===null||x===void 0?void 0:x.context)===null||D===void 0||D.decodeAudioData(_,F=>{this.logger.log("loadAudioBuffer audio file 解码成功"),this.audio.mixAudioConf.audioBuffer[y]=F,b(F)},F=>{this.logger.log("loadAudioBuffer 云端音乐解码失败：",F.message),E(new o.default({code:h.default.AUDIO_EFFECT_FILE_ERROR,message:`loadAudioBuffer: 云端音乐解码失败: ${F.name} ${F.message}`}))})}))).catch(_=>(this.logger.log("loadAudioBuffer 加载云端音乐失败: ",_),Promise.reject(new o.default({code:h.default.AUDIO_EFFECT_FILE_ERROR,message:`loadAudioBuffer: 加载云端音乐失败: ${_.name} ${_.message}`}))))}getAudioInputTracks(){var y,_;let b=[];return((y=this.audio.audioSource)===null||y===void 0?void 0:y.readyState)==="live"&&b.push(this.audio.audioSource),((_=this.audio.micTrack)===null||_===void 0?void 0:_.readyState)==="live"&&b.push(this.audio.micTrack),b}getAudioSlaveInputTracks(){var y,_;let b=[];return((y=this.screenAudio.screenAudioTrack)===null||y===void 0?void 0:y.readyState)==="live"&&b.push(this.screenAudio.screenAudioTrack),((_=this.screenAudio.screenAudioSource)===null||_===void 0?void 0:_.readyState)==="live"&&b.push(this.screenAudio.screenAudioSource),b}enableAudioRouting(){if(this.audio.webAudio&&this.audio.webAudio.destination){this.audio.audioRoutingEnabled=!0;const y=this.audio.webAudio.destination.stream.getAudioTracks()[0];this.logger.log("enableAudioRouting: ",y.label);const _=this.audio.audioStream.getAudioTracks()[0];if(_&&(y.enabled=_.enabled,_.enabled=!0),m.emptyStreamWith(this.audio.audioStream,y),this.stream.isRemote&&this.audio.micTrack){if(!this.audio.audioDom){const b=new MediaStream,E=document.createElement("audio");b.addTrack(this.audio.micTrack),E.srcObject=b,this.audio.audioDom=E}this.audio.audioDom.volume=1e-4,this.audio.audioDom.volume=0,this.audio.audioDom.muted=!0}this.stream.audioLevelHelper&&this.stream.audioLevelHelper.updateStream(this.audio.audioStream),this.updateAudioSender(y)}else this.logger.log("enableAudioRouting: 已替换为Destination")}disableAudioRouting(){const y=this.getAudioInputTracks();if(y.length){y.length===1?this.logger.log("disableAudioRouting: ",y[0].label):this.logger.warn("disableAudioRouting: 仍然有多于一个输入",...y);const _=this.audio.audioStream.getAudioTracks()[0];m.emptyStreamWith(this.audio.audioStream,y[0]),y[0].enabled=_.enabled,_.enabled=!0,this.updateAudioSender(y[0])}else this.logger.log("disableAudioRouting quiet."),m.emptyStreamWith(this.audio.audioStream,null);this.audio.audioRoutingEnabled=!1}updateAudioSender(y){var _,b,E,x,D,F,V,N,L,U,H,j,W,Y,te,re,G;if(this.stream.isRemote)this.logger.warn("updateAudioSender only for localStream");else if(!((b=(_=this.stream.getAdapterRef())===null||_===void 0?void 0:_._mediasoup)===null||b===void 0)&&b._micProducer){if(!((D=(x=(E=this.stream.getAdapterRef())===null||E===void 0?void 0:E._mediasoup)===null||x===void 0?void 0:x._micProducer)===null||D===void 0)&&D._rtpSender)this.logger.info("updateAudioSender: 替换当前_micProducer的track",y.label),(L=(N=(V=(F=this.stream.getAdapterRef())===null||F===void 0?void 0:F._mediasoup)===null||V===void 0?void 0:V._micProducer)===null||N===void 0?void 0:N._rtpSender)===null||L===void 0||L.replaceTrack(y);else if(!((W=(j=(H=(U=this.stream.getAdapterRef())===null||U===void 0?void 0:U._mediasoup)===null||H===void 0?void 0:H._sendTransport)===null||j===void 0?void 0:j.handler)===null||W===void 0)&&W._pc){const K=(re=(te=(Y=this.stream.getAdapterRef())===null||Y===void 0?void 0:Y._mediasoup)===null||te===void 0?void 0:te._sendTransport)===null||re===void 0?void 0:re.handler._pc.audioSender;K&&(this.logger.info("updateAudioSender: 替换audioSender",(G=K==null?void 0:K.track)===null||G===void 0?void 0:G.label),K.replaceTrack(y))}}}enablePreProcessing(y,_){w.enablePreProcessing(this,y,_)}disablePreProcessing(y,_=!1){w.disablePreProcessing(this,y,_)}canDisablePreProcessing(y){return w.canDisablePreProcessing(this,y)}getPreprocessingStats(y="video"){var _;const b=(_=this[y].preProcessing)===null||_===void 0?void 0:_.history;if(!(b!=null&&b.length))return null;const E=b[b.length-1].endTs-b[0].startTs,x={total:0};for(let D=0;D<b.length;D++){x.total+=b[D].endTs-b[D].startTs;for(let F of b[D].handlerTs)F.spent>0&&(x[F.name]||(x[F.name]=0),x[F.name]+=F.spent)}return{fps:1e3*b.length/E,load:x.total/E,delay:x.total/b.length,spent:x}}replaceConstraint(y,_){var b,E,x,D,F,V;y!=null&&y.video&&(R.getParameters().replaceIdealConstraint==="safari16_screen"&&O.IS_SAFARI&&O.SAFARI_MAJOR_VERSION&&O.SAFARI_MAJOR_VERSION>=16&&_==="screen"||R.getParameters().replaceIdealConstraint==="all")&&(!((E=(b=y==null?void 0:y.video)===null||b===void 0?void 0:b.width)===null||E===void 0)&&E.ideal&&(y.video.width.max=y.video.width.ideal,delete y.video.width.ideal),!((D=(x=y==null?void 0:y.video)===null||x===void 0?void 0:x.height)===null||D===void 0)&&D.ideal&&(y.video.height.max=y.video.height.ideal,delete y.video.height.ideal),!((V=(F=y==null?void 0:y.video)===null||F===void 0?void 0:F.frameRate)===null||V===void 0)&&V.ideal&&(y.video.frameRate.max=y.video.frameRate.ideal,delete y.video.frameRate.ideal))}destroy(){this.logger.log("清除 meida"),this._reset()}}e.MediaHelper=P},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.StageBase=void 0,e.StageBase=class{constructor(i){this.enabled=!1,this.node=null,this.state="UNINIT",this.context=i}isTransparent(){return!1}}},function(t,e,r){var i=this&&this.__importDefault||function(O){return O&&O.__esModule?O:{default:O}};Object.defineProperty(e,"__esModule",{value:!0}),e.Play=void 0;const a=r(3),l=r(48),n=i(r(6)),c=i(r(8)),s=r(150),d=r(42),u=r(1),h=r(291),o=r(292),f=r(85),m=r(71),g=r(69);class v extends a.EventEmitter{constructor(T){super(),this.snapshotIndex=0,this.sinkId=null,this.audio={normalizedVolume:1,dom:null},this.audioSlave={normalizedVolume:1,dom:null},this.mask={enabled:!1},this.stream=T.stream,this.logger=T.stream.logger.getChild(()=>{var C,A;let R="player";return!((C=this.audio.dom)===null||C===void 0)&&C.paused&&(R+=" audio_paused"),!((A=this.audioSlave.dom)===null||A===void 0)&&A.paused&&(R+=" audioSlave_paused"),R}),this.video={dom:null,containerDom:null,view:null,size:{width:0,height:0},canvasWatermark:h.createCanvasWatermarkControl(this.logger),encoderWatermark:o.createEncoderWatermarkControl(this.logger),frameData:{canvas:null,context:null},renderMode:{width:0,height:0,cut:!1}},this.screen={dom:null,containerDom:null,view:null,size:{width:0,height:0},canvasWatermark:h.createCanvasWatermarkControl(this.logger),encoderWatermark:o.createEncoderWatermarkControl(this.logger),frameData:{canvas:null,context:null},renderMode:{width:0,height:0,cut:!1}},this.videoThird={dom:null,containerDom:null,view:null,size:{width:0,height:0},canvasWatermark:h.createCanvasWatermarkControl(this.logger),encoderWatermark:o.createEncoderWatermarkControl(this.logger),frameData:{canvas:null,context:null},renderMode:{width:0,height:0,cut:!1}},this.videoFourth={dom:null,containerDom:null,view:null,size:{width:0,height:0},canvasWatermark:h.createCanvasWatermarkControl(this.logger),encoderWatermark:o.createEncoderWatermarkControl(this.logger),frameData:{canvas:null,context:null},renderMode:{width:0,height:0,cut:!1}}}_initDomAndView(T){const C=this[T];if(C.view){if(!C.containerDom){const A=document.createElement("div");C.containerDom=A,C.containerDom.className=`nertc-${T}-container nertc-${T}-container-${this.stream.isRemote?"remote":"local"}`,A.style.overflow="hidden",A.style.position="relative",A.style.width=C.view.clientWidth+"px",A.style.height=C.view.clientHeight+"px",A.style.display="inline-block"}if(!C.dom){const A=document.createElement("video");C.dom=A,A.style.position="absolute",A.style.left="50%",A.style.top="50%",A.style.transform="translate(-50%,-50%)",A.setAttribute("x-webkit-airplay","x-webkit-airplay"),A.setAttribute("playsinline","playsinline"),A.setAttribute("webkit-playsinline","webkit-playsinline"),A.preload="auto",A.dataset.uid=""+this.stream.getId(),A.autoplay=!0,A.muted=!0,C.size.width=0,C.size.height=0,u.getParameters().controlOnPaused&&(A.addEventListener("pause",this.showControlIfVideoPause.bind(this)),A.addEventListener("canplay",this.handleVideoScreenPlay.bind(this)),A.addEventListener("click",this.handleVideoScreenClick.bind(this))),A.addEventListener("resize",R=>{if(!this[T].dom||this[T].dom!==A||this[T].dom!==R.target)return;const w=A.videoWidth,k=A.videoHeight;w>2&&k>2&&this.stream.isRemote&&this.stream.client.adapterRef.state.videoResizeTime<this.stream.client.adapterRef.state.signalJoinSuccessTime&&(this.stream.client.adapterRef.state.videoResizeTime=Date.now()),w===C.size.width&&k===C.size.height||(this.logger.log(`[Play] 视频分辨率发生变化：${T} ${C.size.width}x${C.size.height} => ${w}x${k}。当前父节点：${d.getDomInfo(C.view)}${C.size.width<4?" 首帧渲染":""}`),this.stream.safeEmit("video-resize",{uid:this.stream.getId(),mediaType:T,width:w,height:k}),w>k&&C.size.width>C.size.height||w<k&&C.size.width<C.size.height||this.setRender(T),C.size.width=w,C.size.height=k)})}C.containerDom==C.dom.parentNode?this.logger.log("[Play] initVideoNode: 节点已挂载，请勿重复挂载"):(C.containerDom.appendChild(C.dom),this.logger.log("[Play] initVideoNode "+T)),C.view==C.containerDom.parentNode?this.logger.log("[Play] mountVideoToDom: 节点已挂载，请勿重复挂载"):(this.logger.log("[Play] mountVideoToDom"),C.view.appendChild(C.containerDom),this.logger.log("[Play] 视频主流dom节点挂载成功。父节点："+d.getDomInfo(C.view)),C.canvasWatermark.watermarks.length?C.canvasWatermark.start(C.containerDom):C.canvasWatermark.div=C.containerDom)}}showControlIfVideoPause(){l.MediaTypeList.forEach(T=>{const C=this[T].dom;C!=null&&C.paused&&(this.logger.log("[Play] 可能遇到了播放问题, 尝试主动恢复播放 "+T),C.play().then(()=>{this.logger.log(`[Play] 主动恢复播放: ${T} 成功`)}).catch(A=>{this.logger.error(`[Play] 主动恢复播放 ${T} 出现问题:`,A.name,A.message)}))})}handleVideoScreenClick(){l.MediaTypeList.forEach(T=>{const C=this[T].dom;C!=null&&C.paused&&(this.logger.log("[Play] 视频侦测到点击动作，尝试恢复播放:"+T),C.play())})}handleVideoScreenPlay(){l.MediaTypeList.forEach(T=>{const C=this[T].dom;C&&(C==null?void 0:C.paused)===!1&&this.logger.log(`[Play] 视频侦测到可以播放，当前 mediaType： ${T}，当前播放状态 played: ${C.played.length}, readyState: ${C.readyState}, currentTime: ${C.currentTime}`)})}isPlaying(T){let C=this[T].dom;if(!C||!C.srcObject||C.paused||C.readyState!==4)return!1;{let A=C.srcObject.getTracks()[0];if(!A||!A.enabled||A.muted||(T==="audio"||T==="audioSlave")&&(C.muted||C.volume===0))return!1}return!0}canPlay(T){const C={result:!1,reason:""},A=this.stream.mediaHelper.getTrackByMediaType(T),R=this[T].dom;return A?A.readyState==="ended"?C.reason="ENDED":A.muted||!A.enabled?C.reason="MUTED":R&&R.srcObject?R.paused?A.kind==="audio"?C.result=!0:C.reason="PAUSED":C.reason="PLAYING":C.result=!0:this.stream.isRemote?this.stream.pubStatus[T].producerId?this.stream.pubStatus[T].consumerId?this.stream.pubStatus[T].consumerStatus!=="end"?C.reason="CONSUME_START":C.reason="INVALID_STATE":C.reason="NOT_SUBSCRIBED":C.reason="NOT_PUBLISHED":C.reason="NOT_OPENED",C}async resume(){const T=[];l.MediaTypeList.forEach(C=>{const A=this[C].dom;if(A!=null&&A.paused){const R=A.play();T.push(R),R.then(()=>{var w;this.logger.log(`[Resume] 恢复播放: ${C} 成功`),this.stream.client.apiFrequencyControl({name:"resume",code:0,param:JSON.stringify({streamID:this.stream.stringStreamID,isRemote:!0,mediaType:C,muted:A.muted,active:(w=A.srcObject)===null||w===void 0?void 0:w.active})})}),R.catch(w=>{if(this.logger.error(`[Resume] 恢复播放 ${C} 出现问题:`,w.name,w.message),w.name==="notAllowedError"||w.name==="NotAllowedError")throw new c.default({code:n.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:"resume: 浏览器自动播放受限: "+w.name})})}});try{await Promise.all(T)}catch{}}updatePlaybackVolume(){l.MediaTypeListAudio.forEach(T=>{const C=this[T].dom;if(C){let A;A=this.stream.isRemote?this.stream.client.adapterRef.nomalizedPlaybackVolume*this[T].normalizedVolume:this[T].normalizedVolume,Math.abs(C.volume-A)>.01&&(this.logger.log(`updatePlaybackVolume ${T} ${C.volume} => ${A} ( ${this.stream.client.adapterRef.nomalizedPlaybackVolume} * ${this[T].normalizedVolume})`),C.volume=A)}})}async playAudioStream(T,C,A){var R;const w=this[T];w.dom||(w.dom=document.createElement("audio"),w.dom.addEventListener("pause",I=>{this.logger.log(`[Play] 音频侦测到pause，当前播放状态 played: ${k.played.length}, readyState: ${k.readyState}, currentTime: ${k.currentTime}`)}),w.dom.addEventListener("canplay",I=>{this.logger.log(`[Play] 音频侦测到canplay，当前播放状态 played: ${k.played.length}, readyState: ${k.readyState}, currentTime: ${k.currentTime}`)}));const k=w.dom;if(k.muted=typeof A=="boolean"&&A,k.srcObject=C,k.autoplay=!0,this.updatePlaybackVolume(),this.sinkId&&k.sinkId!==void 0){this.logger.log(`[Play ${T}] 音频尝试使用输出设备`,this.sinkId);try{await k.setSinkId(this.sinkId),this.logger.log(`[Play] ${T} 音频使用输出设备成功`,this.sinkId)}catch(I){this.logger.error("[Play] 音频输出设备切换失败",I.name,I.message,I)}}try{const I=C.getTracks()[0];this.logger.log(`[Play] 音频播放开始, 当前音频track状态 enabled: ${I.enabled}, muted: ${I.muted}, name: ${I.label}`),await this.playDomElement(k,u.getParameters().playMediaTimeout,T),this.logger.log(`[Play] 音频播放完成, 当前播放状态 played: ${k.played.length}, readyState: ${k.readyState}, currentTime: ${k.currentTime}`),this.stream.client.updateRecordingAudioStream(),this.stream.client.apiEventReport("setFunction",{name:`set_${T}_play`,oper:"1",value:JSON.stringify({code:0,reason:"",streamUid:this.stream.stringStreamID,isRemote:this.stream.isRemote,muted:k.muted,active:(R=k.srcObject)===null||R===void 0?void 0:R.active,played:k.played.length,readyState:k.readyState,currentTime:k.currentTime,track:{enabled:I.enabled,muted:I.muted,label:I.label}},null," ")})}catch(I){this.logger.warn(`[Play] 音频 ${T} 播放出现问题: `,I.name,I.message);const M=this.canPlay(T),P=I.name==="notAllowedError"||I.name==="NotAllowedError"?10347:n.default[M.reason];if(this.stream.client.apiEventReport("setFunction",{name:`set_${T}_play`,oper:"1",value:JSON.stringify({code:P,reason:`${I.name} + ${I.message}`,streamUid:this.stream.stringStreamID,isRemote:this.stream.isRemote,muted:k==null?void 0:k.muted,active:C==null?void 0:C.active,readyState:k==null?void 0:k.readyState},null," ")}),I.name==="notAllowedError"||I.name==="NotAllowedError")throw new c.default({code:n.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:`playStream ${T}: 浏览器自动播放受限: ${I.name}`})}}setPlayVolume(T,C){this[T].normalizedVolume=C,this.updatePlaybackVolume()}async playVideoStream(T,C,A){var R,w,k,I;this.logger.log(`[Play ${T}] playVideoStream`);const M=this[T];if(M.view&&M.containerDom&&M.view!==A&&(this.logger.log(`[Play ${T}] playVideoStream: 更换播放容器: ${M.view.getAttribute("id")} -> ${A.getAttribute("id")}`),M.view=A,M.view.appendChild(M.containerDom)),((R=M.dom)===null||R===void 0?void 0:R.srcObject)!==C){M.view=A,this._initDomAndView(T),this.mask.enabled&&this.enableMask();try{const P=C.getVideoTracks()[0];if(!P)return void this.logger.error(`[Play ${T}] 加载播放视频源失败：没有视频源`);{let y="getSettings"in MediaStreamTrack.prototype?P.getSettings():P.getConstraints();this.logger.log(`[Play] 视频播放${T}开始, 当前视频track状态 enabled: ${P.enabled}, muted: ${P.muted}, name: ${P.label}, videoSettings: ${JSON.stringify(y,null," ")}`)}const S=M.dom;if(!S)return;S.srcObject=C,this.stream.isRemote&&this.stream.client.adapterRef.state.domVideoAppendTime<this.stream.client.adapterRef.state.signalJoinSuccessTime&&(this.stream.client.adapterRef.state.domVideoAppendTime=Date.now()),await this.playDomElement(S,u.getParameters().playMediaTimeout,T),this.logger.log(`[Play] 视频播放${T}完成, 当前播放状态 played: ${S.played.length}, readyState: ${S.readyState}, currentTime: ${S.currentTime}, 分辨率: ${S.videoWidth}x${S.videoHeight}，显示宽高: ${S.offsetWidth}x${S.offsetHeight}`),this.stream.client.apiEventReport("setFunction",{name:`set_${T}_play`,oper:"1",value:JSON.stringify({code:0,reason:"",streamUid:this.stream.stringStreamID,isRemote:this.stream.isRemote,muted:S.muted,active:(w=S.srcObject)===null||w===void 0?void 0:w.active,played:S.played.length,readyState:S.readyState,currentTime:S.currentTime,videoWidth:S.videoWidth,videoHeight:S.videoHeight,track:{enabled:P.enabled,muted:P.muted,label:P.label}},null," ")}),S.paused&&u.getParameters().controlOnPaused&&this.showControlIfVideoPause()}catch(P){this.logger.warn(`[Play] 视频播放 ${T} 出现问题: `,P.name,P.message);const S=this.canPlay(T),y=P.name==="notAllowedError"||P.name==="NotAllowedError"?10347:n.default[S.reason];if(this.stream.client.apiEventReport("setFunction",{name:`set_${T}_play`,oper:"1",value:JSON.stringify({code:y,reason:`${P.name} + ${P.message}`,streamUid:this.stream.stringStreamID,isRemote:this.stream.isRemote,muted:(k=M==null?void 0:M.dom)===null||k===void 0?void 0:k.muted,active:C==null?void 0:C.active,readyState:(I=M==null?void 0:M.dom)===null||I===void 0?void 0:I.readyState},null," ")}),P.name==="notAllowedError"||P.name==="NotAllowedError")throw new c.default({code:n.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:"playVideoStream: 浏览器自动播放受限: "+P.name})}}else this.logger.log(`[Play ${T}] playVideoStream: 跳过重复的播放请求`)}async stopPlayStream(T){T==="audio"||T==="audioSlave"?this._stopPlayAudioStream(T):T!=="video"&&T!=="screen"&&T!=="videoThird"&&T!=="videoFourth"||this._stopPlayVideoStream(T)}async _stopPlayAudioStream(T){const C=this[T].dom;C&&(C.muted=!0,C.srcObject=null,this.stream.client.apiEventReport("setFunction",{name:`set_${T}_play`,oper:"0",value:JSON.stringify({code:0,reason:"",streamUid:this.stream.stringStreamID,isRemote:this.stream.isRemote,muted:C.muted},null," ")}))}async _stopPlayVideoStream(T){this.logger.log("stopPlayVideoStream 停止播放 "+T);const C=this[T].view,A=this[T].containerDom,R=this[T].dom;if(A&&R){A===R.parentNode?(this.logger.log(`清除 ${T} dom`),A.removeChild(R)):A.lastChild&&(this.logger.log("videoContainerDom 删除子节点"),A.removeChild(A.lastChild));try{R.remove(),R.srcObject=null,this[T].dom=null,this.stream.client.apiEventReport("setFunction",{name:`set_${T}_play`,oper:"0",value:JSON.stringify({code:0,reason:"",streamUid:this.stream.stringStreamID,isRemote:this.stream.isRemote},null," ")})}catch(w){this.logger.log("stopPlayVideoStream e: ",w),this.stream.client.apiEventReport("setFunction",{name:`set_${T}_play`,oper:"0",value:JSON.stringify({code:-1,uid:this.stream.stringStreamID,reason:`${w.name} + ${w.message}`,isRemote:this.stream.isRemote,streamUid:this.stream.stringStreamID},null," ")})}}C&&A&&(C==A.parentNode?(this.logger.log(`清除 ${T} containerDom`),C.removeChild(A)):C.lastChild&&(this.logger.log(T+" View 删除子节点"),C.removeChild(C.lastChild),C.innerHTML=""),this[T].containerDom=null,this[T].view=null)}setRender(T,C){var A,R,w,k;const I=this[T],M=I.containerDom,P=I.dom;if(C?(this.logger.log(`[Play ${T}] setRender() options: ${JSON.stringify(C)}`),I.renderMode=Object.assign({},C)):(C=I.renderMode,this.logger.log("[Play] setVideoRender() existing videoRenderMode: "+JSON.stringify(C))),!(!M||!P)){if(M.style.width=C.width+"px",M.style.height=C.height+"px",!C.cut)return P.style.height="100%",void(P.style.width="100%");P.videoWidth/P.videoHeight>C.width/C.height?(P.style.width="auto",P.style.height="100%"):(P.style.width="100%",P.style.height="auto"),this.stream.client.apiEventReport("setFunction",{name:"set_render_"+T,oper:"1",value:JSON.stringify({result:"success",streamUid:this.stream.stringStreamID,played:P.played.length,domStyleWidth:P.style.width,domStyleHeight:P.style.height,containerDomWidth:(R=(A=I.containerDom)===null||A===void 0?void 0:A.style)===null||R===void 0?void 0:R.width,containerDomHeight:(k=(w=I.containerDom)===null||w===void 0?void 0:w.style)===null||k===void 0?void 0:k.height},null," ")})}}async setAudioOutput(T){this.logger.log("[Play] setAudioOutput() audioSinkId: ",T),this.sinkId=T,this.stream.client.outputDeviceId=T;for(let C of l.MediaTypeListAudio){const A=this[C].dom;A&&A.srcObject&&A.sinkId!==void 0?A.srcObject.getAudioTracks().length&&(await A.setSinkId(T),this.logger.log("[Play] setAudioOutput() 设置通话音频输出设备成功")):this.logger.warn("[Play] setAudioOutput() Browser does not support output device selection.")}}async takeSnapshot(T,C,A){if(this.mask.enabled)return this.logger.warn("takeSnapshot: 目前在打码状态"),null;let R=new s.RTCCanvas("canvas"),w=R._canvas,k=R._ctx;if(!k||!w)throw this.logger.error("takeSnapshot() 浏览器环境不支持"),new c.default({code:n.default.STREAM_TAKE_SNAPSHOT_NO_CANVAS_ERROR,message:"takeSnapshot() 浏览器环境不支持"});const I=["video","screen","videoThird","videoFourth"];let M="";for(let P of I)if(!T.mediaType&&this[P].dom||T.mediaType===P){const S=T.name||(A||this.stream.getId())+"-"+this.snapshotIndex++;k.fillStyle="#ffffff";const y=this[P].dom;if(!y)return;k.fillRect(0,0,y.videoWidth,y.videoHeight),R.setSize(y.videoWidth,y.videoHeight),k.drawImage(y,0,0,y.videoWidth,y.videoHeight,0,0,y.videoWidth,y.videoHeight),C==="download"?M=await new Promise((_,b)=>{w.toBlob(E=>{this.logger.log("takeSnapshot() 获取到截图的blob: ",E);let x=URL.createObjectURL(E),D=document.createElement("a");document.body.appendChild(D),D.style.display="none",D.href=x,D.download=S+".png",D.click(),window.URL.revokeObjectURL(x),_(S+".png")})}):C==="base64"&&(M=this.getBase64Image(w))}return R.destroy(),M}_initFrameDataCanvas(T){const C=this[T].frameData;return C.canvas||(this.logger.log("正在初始化 frameData.canvas "+T),C.canvas=document.createElement("canvas"),C.context=f.get2DContext(C.canvas,{willReadFrequently:!0})),C.context}getCurrentFrameData(T){if(T.mediaType==="audio"||T.mediaType==="audioSlave")return void this.logger.error("getCurrentFrameData: mediaType参数错误");if(this.mask.enabled)return this.logger.error("getCurrentFrameData: 当前在打码状态"),null;let C,A,R;if(R=T.mediaType&&T.mediaType!=="video"?T.mediaType:"video",A=this[R].dom,C=this[R].frameData,!A)return this.logger.error("getCurrentFrameData: Playing Video is not found"),null;A.paused&&this.logger.warn("getCurrentFrameData: 目前数据源不在播放状态，截图结果可能不是最新。"),C.canvas||this._initFrameDataCanvas(R);const w=C.canvas,k=C.context;if(!k||!w)throw new c.default({code:n.default.STREAM_TAKE_SNAPSHOT_NO_CANVAS_ERROR,message:"getCurrentFrameData() 浏览器环境不支持"});const I=A.videoWidth,M=A.videoHeight;if(!I||!M)return null;let P,S;return T.width&&T.width>0?T.height&&T.height>0?(P=T.width,S=T.height):(P=T.width,S=Math.floor(T.width/I*M)):T.height&&T.height>0?(S=T.height,P=Math.floor(T.height/M*I)):(P=I,S=M),w.width!==P&&(w.width=P),w.height!==S&&(w.height=S),k.drawImage(A,0,0,P,S),k.getImageData(0,0,P,S)}getBase64Image(T){return T.toDataURL("image/",1)}async playDomElement(T,C,A){return new Promise((R,w)=>{let k=setTimeout(()=>{k&&(k=null,R())},C),I=setTimeout(()=>{var P,S;if(I&&(I=null,T.readyState===g.MEDIA_READYSTATE.HAVE_ENOUGH_DATA||u.getParameters().moreNotAllowedError)){const y=new c.default({code:n.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:"playDomElement: 浏览器自动播放受限，表现为Play既不成功也不失败。可尝试通过resume()恢复。"});this.stream.safeEmit("notAllowedError",y),(P=this.stream.getAdapterRef())===null||P===void 0||P.instance.safeEmit("NotAllowedError",y),(S=this.stream.getAdapterRef())===null||S===void 0||S.instance.safeEmit("notAllowedError",y)}},u.getParameters().playMediaTimeoutForAutoplay);const M=T.play();m.printVideoState(M,T,this.stream.stringStreamID,A),M.then(()=>{k&&(clearTimeout(k),k=null,R()),I&&(clearTimeout(I),I=null)}).catch(P=>{k&&(clearTimeout(k),k=null,(P==null?void 0:P.name)==="AbortError"?R():w(P)),I&&(clearTimeout(I),I=null)})})}enableMask(){this.mask.enabled=!0,this.video.dom&&(this.video.dom.style.filter="blur(20px)")}disableMask(){this.mask.enabled=!1,this.video.dom&&(this.video.dom.style.filter=""),this.screen.dom&&(this.screen.dom.style.filter=""),this.videoThird.dom&&(this.videoThird.dom.style.filter=""),this.videoFourth.dom&&(this.videoFourth.dom.style.filter="")}destroy(){l.MediaTypeList.forEach(T=>{this.stopPlayStream(T)})}}e.Play=v},function(t,e,r){var i;(function(a){var l,n,c,s=(l=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZWN]|'[^']*'|'[^']*'/g,n=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,c=/[^-+\dA-Z]/g,function(f,m,g,v){if(arguments.length!==1||o(f)!=="string"||/\d/.test(f)||(m=f,f=void 0),(f=f||new Date)instanceof Date||(f=new Date(f)),isNaN(f))throw TypeError("Invalid date");var O=(m=String(s.masks[m]||m||s.masks.default)).slice(0,4);O!=="UTC:"&&O!=="GMT:"||(m=m.slice(4),g=!0,O==="GMT:"&&(v=!0));var T=g?"getUTC":"get",C=f[T+"Date"](),A=f[T+"Day"](),R=f[T+"Month"](),w=f[T+"FullYear"](),k=f[T+"Hours"](),I=f[T+"Minutes"](),M=f[T+"Seconds"](),P=f[T+"Milliseconds"](),S=g?0:f.getTimezoneOffset(),y=u(f),_=h(f),b={d:C,dd:d(C),ddd:s.i18n.dayNames[A],dddd:s.i18n.dayNames[A+7],m:R+1,mm:d(R+1),mmm:s.i18n.monthNames[R],mmmm:s.i18n.monthNames[R+12],yy:String(w).slice(2),yyyy:w,h:k%12||12,hh:d(k%12||12),H:k,HH:d(k),M:I,MM:d(I),s:M,ss:d(M),l:d(P,3),L:d(Math.round(P/10)),t:k<12?"a":"p",tt:k<12?"am":"pm",T:k<12?"A":"P",TT:k<12?"AM":"PM",Z:v?"GMT":g?"UTC":(String(f).match(n)||[""]).pop().replace(c,""),o:(S>0?"-":"+")+d(100*Math.floor(Math.abs(S)/60)+Math.abs(S)%60,4),S:["th","st","nd","rd"][C%10>3?0:(C%100-C%10!=10)*C%10],W:y,N:_};return m.replace(l,function(E){return E in b?b[E]:E.slice(1,E.length-1)})});function d(f,m){for(f=String(f),m=m||2;f.length<m;)f="0"+f;return f}function u(f){var m=new Date(f.getFullYear(),f.getMonth(),f.getDate());m.setDate(m.getDate()-(m.getDay()+6)%7+3);var g=new Date(m.getFullYear(),0,4);g.setDate(g.getDate()-(g.getDay()+6)%7+3);var v=m.getTimezoneOffset()-g.getTimezoneOffset();m.setHours(m.getHours()-v);var O=(m-g)/6048e5;return 1+Math.floor(O)}function h(f){var m=f.getDay();return m===0&&(m=7),m}function o(f){return f===null?"null":f===void 0?"undefined":typeof f!="object"?typeof f:Array.isArray(f)?"array":{}.toString.call(f).slice(8,-1).toLowerCase()}s.masks={default:"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:sso",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'",expiresHeaderFormat:"ddd, dd mmm yyyy HH:MM:ss Z"},s.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]},(i=(function(){return s}).call(e,r,e,t))===void 0||(t.exports=i)})()},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.measureText=e.numberToRGBA=void 0,e.numberToRGBA=function(i){if(i===0)return"rgba(0,0,0,0)";let a,l,n,c;return n=i%256,l=(i=Math.floor(i/256))%256,a=(i=Math.floor(i/256))%256,c=(i=Math.floor(i/256))>0?(i%256/256).toFixed(2):1,`rgba(${a}, ${l}, ${n}, ${c})`},e.measureText=function(i,a,l){if(!i)return{width:0,height:0};let n=document.createElement("div"),c=document.createElement("span");c.innerText=i,c.style.fontSize=a,c.style.fontFamily=l,n.style.opacity="0",n.style.position="absolute",n.style.height=a,document.body.appendChild(n),n.appendChild(c);const s=n.clientHeight,d=c.offsetWidth;return n.remove(),{width:d,height:s}}},function(t,e,r){var i=this&&this.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(e,"__esModule",{value:!0}),e.StageAIProcessing=void 0;const a=i(r(293)),l=i(r(294)),n=r(3);class c extends n.EventEmitter{constructor(d,u){super(),this.node=null,this.howlingNode=null,this.enabled=!1,this._audioAffectsProcessor=null,this._howlingProcessor=null,this.pluginModules={AIAudioEffects:null,AIhowling:null},this.pluginConfig={AIAudioEffects:null,AIhowling:null},this.context=d,this.logger=u.getChild(()=>"StageAIProcessing"),this.enabled=!1}registerPlugin(d){this.logger.log("registerPlugin ",d.key),this.pluginConfig[d.key]=d}getPlugin(d){return this.pluginModules[d]}getPluginConfig(d){return this.pluginConfig[d]?this.pluginConfig[d]:(this.logger.warn("pluginConfig is not found",d),null)}hasWorkingPlugin(){const d=this._audioAffectsProcessor!==null||this._howlingProcessor!==null;return this.logger.log("hasWorkingPlugin",d),d}async initProcessor(d){d==="AIAudioEffects"?await this.initAudioEffects():d==="AIhowling"?await this.initHowling():this.logger.warn("initProcessor ",d,"not found")}getProcessor(d){return this.pluginModules[d]}destroyProcessor(d){var u,h;this.logger.log("destroyProcessor ",d),d==="AIAudioEffects"?((u=this.pluginModules[d])===null||u===void 0||u.destroy(),this.pluginModules[d]=null,this._audioAffectsProcessor=null):d==="AIhowling"?((h=this.pluginModules[d])===null||h===void 0||h.destroy(),this.pluginModules[d]=null,this._howlingProcessor=null):this.logger.warn("destroyProcessor ",d,"not found")}async initAudioEffects(){this.logger.log("initAudioEffectsProcessor"),this._audioAffectsProcessor=new a.default(this,this.context),await this._audioAffectsProcessor.init(),this.pluginModules.AIAudioEffects=this._audioAffectsProcessor,this._audioAffectsProcessor.on("effects-load",()=>{this.emit("effects-load")}),this._audioAffectsProcessor.on("error",d=>{this.emit("error",{key:"AIAudioEffects",msg:d})}),this._audioAffectsProcessor.on("plugin-process-unstable",d=>{this.emit("plugin-process-unstable",{key:"AIAudioEffects",msg:d})}),this.node=this._audioAffectsProcessor.getAudioNode()}async initHowling(){this.logger.log("initHowlingProcessor"),this._howlingProcessor=new l.default(this,this.context),await this._howlingProcessor.init(),this.pluginModules.AIhowling=this._howlingProcessor,this._howlingProcessor.on("aihowling-load",()=>{this.emit("aihowling-load")}),this._howlingProcessor.on("error",d=>{this.emit("error",{key:"AIhowling",msg:d})}),this.howlingNode=this._howlingProcessor.getAudioNode()}unregisterPlugin(d){var u,h,o,f;this.logger.log("unregisterPlugin ",d),d==="AIAudioEffects"?((u=this._audioAffectsProcessor)===null||u===void 0||u.removeAllListeners(),(h=this._audioAffectsProcessor)===null||h===void 0||h.destroy(),this._audioAffectsProcessor=null,this.removeListener("plugin-process-unstable")):d==="AIhowling"&&((o=this._howlingProcessor)===null||o===void 0||o.removeAllListeners(),(f=this._howlingProcessor)===null||f===void 0||f.destroy(),this._howlingProcessor=null),this.pluginConfig[d]=null,this.pluginModules[d]=null}destroy(){this.logger.log("destroy StageAIProcessing");for(const d in this.pluginModules)this.pluginModules[d]&&this.unregisterPlugin(d);this.node=null,this.howlingNode=null,this.enabled=!1}}e.StageAIProcessing=c},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.AudioWorkletAgent=void 0;const i=r(3),a=r(72);let l={AIAudioEffects:"NOTREADY",AIhowling:"NOTREADY"},n={AIAudioEffects:null,AIhowling:null};class c extends i.EventEmitter{constructor(d){super(),this.outputCnt=0,this.inputCnt=0,this.node=new a.NeAudioNodeNullable("AudioWorkletAgent",null),this.processCallback=null,this.pluginType=d.pluginType,this.logger=d.logger.getChild(()=>{let h="AudioWorkletAgent";return l[d.pluginType]!=="READY"&&(h+=" "+l[d.pluginType]),h});const u=d.context;this.support={context:u,audioWorkletNode:null}}async init(d){var u;if(this.logger.log("AudioWorkletAgent init ",d.key),this.support.audioWorkletNode)return void this.logger.error("Already Inited");if(!this.support.context.audioWorklet)return void this.logger.error("该环境不支持音频处理");const h=d.key==="AIAudioEffects"?"audioEffectsWorkletAgentProcessor":"aiHowlingWorkletAgentProcessor";n[this.pluginType]?l[this.pluginType]==="LOADING"&&await n[this.pluginType]:(l[this.pluginType]="LOADING",this.logger.log(`正在载入 ${h} 模块`),n[this.pluginType]=this.support.context.audioWorklet.addModule(d.blobUrl),await n[this.pluginType],l[this.pluginType]="READY",this.logger.log(`载入 ${h} 模块成功`)),this.support.audioWorkletNode=new AudioWorkletNode(this.support.context,h),this.node.updateNode(this.support.audioWorkletNode),this.bindProcessorEvents(),d.wasmBinary?(u=this.support.audioWorkletNode)===null||u===void 0||u.port.postMessage({type:"init",wasmBinary:d.wasmBinary}):(this.logger.log("wasmBinary 为空，正在加载 "+d.wasmUrl),fetch(d.wasmUrl).then(o=>{if(o.status==200)return o.arrayBuffer();this.logger.error(`加载 ${d.wasmUrl} 失败, 无法初始化音频处理程序`)}).then(o=>{var f;if(o){const m=new Uint8Array(o);(f=this.support.audioWorkletNode)===null||f===void 0||f.port.postMessage({type:"init",wasmBinary:m})}}))}bindProcessorEvents(){this.removeAllListeners("rawinputs"),this.support.audioWorkletNode.port.onmessage=d=>{this.emit("processor-message",d);const{type:u}=d.data;switch(u){case"rawinputs":this.handleTypeRawInputs(d);break;case"bufferDrop":this.logger.warn(`音频处理程序刚刚丢弃了${d.data.cnt}个包的数据`);break;case"created":const{value:h}=d.data;this.logger.log("音频处理程序已创建 "+h),h==="AIAudioEffects"?this.emit("effects-load"):h==="AIhowling"&&this.emit("aihowling-load");break;case"howlingState":typeof this.processCallback=="function"&&this.processCallback(!!d.data.result);break;case"error":const o=d.data.message;this.logger.error("音频处理程序错误 "+o),this.emit("error",o);break;case"plugin-process-unstable":const{startTime:f,duration:m}=d.data;this.logger.log(`音频处理程序处理时长不稳定, start: ${f}, duration: ${m}`),this.emit("plugin-process-unstable","音频处理程序处理时长不稳定, 可能发生卡顿问题, start: "+f);break;default:this.logger.error("Unknown message",d)}}}handleTypeRawInputs(d){this.outputCnt++,this.emit("rawinputs",d.data)}outputData(d){if(!this.support.audioWorkletNode)throw new Error("Destroyed");this.inputCnt++,this.support.audioWorkletNode.port.postMessage({type:"outputData",data:d})}postMessage(d){if(!this.support.audioWorkletNode)throw new Error("Destroyed");this.support.audioWorkletNode.port.postMessage(d)}setHowlingCallback(d){this.logger.log("setHowlingCallback"),this.processCallback=d}destroy(){this.logger.log("destroy AudioWorkletAgent"),this.support.audioWorkletNode&&(this.support.audioWorkletNode.disconnect(),this.support.audioWorkletNode=null)}}e.AudioWorkletAgent=c},function(t,e,r){var i=this&&this.__importDefault||function(l){return l&&l.__esModule?l:{default:l}};Object.defineProperty(e,"__esModule",{value:!0}),e.loadPlugin=void 0;const a=i(r(155));e.loadPlugin=function(l,n){return new Promise((c,s)=>{a.default.indexOf(l)==-1&&s("unsupport plugin "+l);const d=document.createElement("script");d.defer=!0,d.src=n,document.body.appendChild(d),d.onload=function(){c()},d.onerror=function(u){s(`Load plugin ${n} error`)}})}},function(t,e,r){var i=l(r(73)),a=l(r(74));function l(c){return c&&c.__esModule?c:{default:c}}var n=r(169).EventEmitter;t.exports=class extends n{constructor(c){super(),this.setMaxListeners(1/0),this._logger=c||console}safeEmit(c){try{for(var s=arguments.length,d=Array(s>1?s-1:0),u=1;u<s;u++)d[u-1]=arguments[u];this.emit.apply(this,[c].concat(d))}catch(h){this._logger.error("safeEmit() | event listener threw an error [event:%s]:%o",c,h)}}safeEmitAsPromise(c){for(var s=this,d=arguments.length,u=Array(d>1?d-1:0),h=1;h<d;h++)u[h-1]=arguments[h];return(0,a.default)(i.default.mark(function o(){return i.default.wrap(function(f){for(;;)switch(f.prev=f.next){case 0:return f.abrupt("return",new Promise(function(m,g){s.safeEmit.apply(s,[c].concat(u,[m,g]))}));case 1:case"end":return f.stop()}},o,s)}))()}}},function(t,e,r){var i,a=r(121),l=(i=a)&&i.__esModule?i:{default:i},n=r(28),c=r(299).generateRandomNumber,s=r(81).JSONBigParse,d=new n.Logger({tagGen:function(){return"Message"}});t.exports=class{static parse(u){var h=void 0,o={};try{h=s(u)}catch(f){return void d.error("parse() | invalid JSONbig: %s",f)}if((h===void 0?"undefined":(0,l.default)(h))==="object"&&!Array.isArray(h)){if(h.request){if(o.request=!0,typeof h.method!="string")return void d.error("parse() | missing/invalid method field");if(typeof h.id!="number")return void d.error("parse() | missing/invalid id field");o.id=h.id,o.method=h.method,o.data=h.data||{}}else if(h.response){if(o.response=!0,typeof h.id!="number")return void d.error("parse() | missing/invalid id field");o.id=h.id,h.ok?(o.ok=!0,o.data=h.data||{}):(o.ok=!1,o.errorCode=h.errorCode,o.errorReason=h.errorReason)}else{if(!h.notification)return void d.error("parse() | missing request/response field");if(o.notification=!0,typeof h.method!="string")return void d.error("parse() | missing/invalid method field");o.id=h.id,o.method=h.method,o.data=h.data||{}}return o}d.error("parse() | not an object")}static createRequest(u,h){return{request:!0,id:c(),method:u,data:h||{}}}static createSuccessResponse(u,h){return{response:!0,id:u.id,ok:!0,data:h||{}}}static createErrorResponse(u,h,o){return{response:!0,id:u.id,ok:!1,errorCode:h,errorReason:o}}static createNotification(u,h){return{notification:!0,method:u,data:h||{}}}}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0});const i=r(1),a=r(84),l=r(28),n={setLogLevel(c){i.getParameters().logLevel!==c&&(l.getDefaultLogger().info(`NERTC LogLevel was changed: ${a.loglevelMap[i.getParameters().logLevel]} => ${a.loglevelMap[c]}`),i.getParameters().logLevel=c)},enableLogUpload(){i.getParameters().logUpload=!0},disableLogUpload(){i.getParameters().logUpload=!1}};i.getParameters().forceLogUpload==="on"?n.enableLogUpload():n.disableLogUpload(),e.default=n},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.geofenceArea=void 0;const i=r(26),a=r(28),l=r(1);e.geofenceArea=new class{constructor(){this.areaCode="GLOBAL",this.regions=i.LBS_REGION_CONFIG,this.logger=a.getDefaultLogger().getChild(()=>"GeofenceArea "+this.areaCode)}setAreaById(n){if(this.regions[n]){const c=this.areaCode;this.areaCode=n,this.logger.log(`setArea: ${c} -> ${n}`)}else this.logger.error(`setAreaById: 不存在该区域：${n}。可用区域：${this.getAvailableAreas().join(",")}`);for(let c in l.getParameters().clients){const s=l.getParameters().clients[c];s.destroyed||s.adapterRef.connectState.curState!=="DISCONNECTED"||s.adapterRef.lbsManager.loadBuiltinConfig("setArea")}}getAvailableAreas(){const n=[];for(let c in this.regions)this.regions[c]&&this.regions[c].nrtc&&n.push(c);return n}getBuiltinConfig(){return l.getParameters().forceGeofenceArea!=="NONE"?this.regions[l.getParameters().forceGeofenceArea]:this.regions[this.areaCode]}}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.AdvBeautyFilter=e.resSet=void 0;const i=r(156),a=r(134),l=r(135),n=r(75),c=r(317),s=r(318),d=r(319),u=r(320),h=r(136),o=r(321),f=r(137);e.resSet={faceMask:"https://yx-web-nosdn.netease.im/common/6947be5d3e5604368401950ca0cf094d/facemask-01.png",eyeTeethMask:"https://yx-web-nosdn.netease.im/common/655421269305cac5c1e48d62f0fac8de/eye-teeth-mask-02.png",teethWhiten:"https://yx-web-nosdn.netease.im/common/ca8a6b0be3427ead9b19bcf9ae1245a8/teath.png"};const m={genTopFace(A){const R=o.Vector2.getVec(A,49),w=o.Vector2.getVec(A,43);let k=o.Vector2.sub(w,R),I=1.5*k.length;k=o.Vector2.normalize(k);const M=o.Vector2.sub(o.Vector2.getVec(A,0),w);let P=M.length;const S=o.Vector2.sub(o.Vector2.getVec(A,32),w);let y=S.length;const _=Math.max(P,y);let b=P/_,E=y/_;o.Vector2.setPoint(A,116,o.Vector2.add(w,o.Vector2.scale(k,I)));let x=o.Vector2.angle(M,k),D=o.Matrix3x3.rotate(x/-6,0,0),F=k;[110,109,108,107,106].forEach((V,N)=>{F=D.multiplyVector(F);const L=(N+1)/7,U=1*(1-L)+b*L;o.Vector2.setPoint(A,V,o.Vector2.add(w,o.Vector2.scale(F,I*U*(1-L)+P*L)))}),x=o.Vector2.angle(S,k),D=o.Matrix3x3.rotate(x/6,0,0),F=k,[115,114,113,112,111].forEach((V,N)=>{F=D.multiplyVector(F);const L=(N+1)/7,U=1*(1-L)+E*L;o.Vector2.setPoint(A,V,o.Vector2.add(w,o.Vector2.scale(F,I*U*(1-L)+y*L)))})},genFaceOutline(A){const R=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,106,107,108,109,110,111,112,113,114,115,116],w=o.Vector2.getVec(A,43);for(let k=0;k<R.length;k++){const I=R[k],M=o.Vector2.getVec(A,I),P=o.Vector2.add(w,o.Vector2.scale(o.Vector2.sub(M,w),1.3)),S=2*(117+k);A[S]=P.value[0]>>0,A[S+1]=P.value[1]>>0}}},g=new Set;let v=null,O=null,T=null;class C extends f.Filter{constructor(R,w,k,I,M,P,S,y,_,b,E,x){super(R,w,k,null),this.isShowWire=!1,this.advData=null,this.wirePosBuffer=null,this.targetPosBuffer=null,this.zIndexBuffer=null,this.indicesBuffer=null,this.faceMaskUVBuffer=null,this.planePosBuffer=null,this.planeUVBuffer=null,this.advEyeTeethPosBuffer=null,this.advEyeTeethIndicesBuffer=null,this.advEyeTeethZindexBuffer=null,this.advEyeTeethUVBuffer=null,this.defParams={enlargeEye:0,roundedEye:0,openCanthus:0,eyeDistance:.5,eyeAngle:.5,shrinkNose:0,lengthenNose:.5,shrinkMouth:.5,widenMouth:.5,mouthCorners:.5,adjustPhiltrum:.5,shrinkUnderjaw:0,shrinkCheekbone:0,lengthenJaw:.5,narrowedFace:0,shrinkFace:0,vShapedFace:0,minifyFace:0,shortenFace:0,whitenTeeth:0,brightenEye:0,fadeHeadWrinkle:0,fadeEyeRim:0,fadeNoseLine:0},g.add(this),this.faceMaskMap=n.createTexture(this.renderer.gl,v),this.eyeTeethMaskMap=n.createTexture(this.renderer.gl,O),this.whiteTeethLutMap=n.createTexture(this.renderer.gl,T,{flipY:!1}),this.params=Object.assign({},this.defParams),m.genTopFace(this.posBuffer.typedArray),m.genFaceOutline(this.posBuffer.typedArray),this.targetPosBuffer=i.createAttributeBuffer(this.renderer.gl,"tPosition",this.posBuffer.typedArray.slice(0),2),this.zIndexBuffer=I,this.indicesBuffer=M,this.faceMaskUVBuffer=P,this.planePosBuffer=S,this.planeUVBuffer=y,this.advEyeTeethPosBuffer=_,this.advEyeTeethIndicesBuffer=b,this.advEyeTeethZindexBuffer=E,this.advEyeTeethUVBuffer=x,this.setWirePosBuffer(),this.initProgramBuffer()}setWirePosBuffer(){if(!this.isShowWire)return;const R=new Set,w=[],k=this.indicesBuffer.typedArray,I=this.posBuffer.typedArray,M=(P,S)=>{if(!R.has(P+"-"+S)&&!R.has(S+"-"+P)){R.add(P+"-"+S);const y=2*P,_=2*S;w.push(I[y],I[y+1],I[_],I[_+1])}};for(let P=0;P<(k.length-2)/3;P++){const S=3*P,y=k[S],_=k[S+1],b=k[S+2];M(y,_),M(_,b),M(b,y)}this.wirePosBuffer?this.programs.wire.updateAttribute("position",P=>{P.set(w,0)}):this.wirePosBuffer=i.createAttributeBuffer(this.renderer.gl,"position",new Int16Array(w),2)}initProgramBuffer(){const R=this.renderer.gl,w=this.renderer.getSize(),k={width:w.width>>2,height:w.height>>2};let I=null;if(this.isShowWire){const E=new l.Program(R,()=>{var x;R.drawArrays(R.LINES,0,((x=this.wirePosBuffer)===null||x===void 0?void 0:x.count)||0)});E.setShader(d.advBeautyWireShader.vShader,"VERTEX"),E.setShader(d.advBeautyWireShader.fShader,"FRAGMENT"),E.setAttributeBuffer(this.wirePosBuffer),I=a.createFrameBuffer(R,w.width,w.height),E.setUniform("size",[w.width,w.height]),this.programs.wire=E,this.framebuffers.wire=I}const M=new l.Program(R,()=>{R.drawElements(R.TRIANGLES,this.indicesBuffer.count,R.UNSIGNED_SHORT,0)});M.setShader(s.advBeautyShader.vShader,"VERTEX"),M.setShader(s.advBeautyShader.fShader,"FRAGMENT"),M.setAttributeBuffer(this.posBuffer),M.setAttributeBuffer(this.targetPosBuffer),M.setAttributeBuffer(this.zIndexBuffer);const P=a.createFrameBuffer(R,w.width,w.height);M.setUniform("size",[w.width,w.height]),this.isShowWire&&M.setUniform("wireMap",I.targetTexture),M.setUniform("showWire",this.isShowWire?1:0),M.setUniform("map",this.map),M.setUniform("teethLut",this.whiteTeethLutMap),M.setUniform("teethIntensity",0),M.setUniform("eyeIntensity",0),M.setIndices(this.indicesBuffer),this.programs.morph=M,this.framebuffers.morph=P;const S=new l.Program(R,()=>{R.drawElements(R.TRIANGLES,this.indicesBuffer.count,R.UNSIGNED_SHORT,0)});S.setShader(u.advFaceMaskShader.vShader,"VERTEX"),S.setShader(h.baseTextureShader.fShader,"FRAGMENT"),S.setAttributeBuffer(this.targetPosBuffer),S.setAttributeBuffer(this.zIndexBuffer),S.setAttributeBuffer(this.faceMaskUVBuffer);const y=a.createFrameBuffer(R,k.width,k.height);S.setUniform("size",[w.width,w.height]),S.setUniform("map",this.faceMaskMap),S.setIndices(this.indicesBuffer),this.programs.faceMask=S,this.framebuffers.faceMask=y;const _=new l.Program(R,()=>{R.drawElements(R.TRIANGLES,this.advEyeTeethIndicesBuffer.count,R.UNSIGNED_SHORT,0)});_.setShader(u.advFaceMaskShader.vShader,"VERTEX"),_.setShader(h.baseTextureShader.fShader,"FRAGMENT"),_.setAttributeBuffer(this.advEyeTeethPosBuffer),_.setAttributeBuffer(this.advEyeTeethZindexBuffer),_.setAttributeBuffer(this.advEyeTeethUVBuffer);const b=a.createFrameBuffer(R,k.width,k.height);_.setUniform("size",[w.width,w.height]),_.setUniform("map",this.eyeTeethMaskMap),_.setIndices(this.advEyeTeethIndicesBuffer),this.programs.eyeTeeth=_,this.framebuffers.eyeTeeth=b,M.setUniform("eyeTeethMaskMap",b.targetTexture);for(let E=0;E<2;E++){const x=new l.Program(R);x.setShader(h.baseTextureShader.vShader,"VERTEX"),x.setShader(c.advBeautyEyeShader.fShader,"FRAGMENT"),x.setAttributeBuffer(this.planePosBuffer),x.setAttributeBuffer(this.planeUVBuffer);const D=a.createFrameBuffer(R,w.width,w.height);x.setUniform("map",E===0?P.targetTexture:this.framebuffers.lEye.targetTexture),x.setUniform("eyeCenter",[0,0]),x.setUniform("rdIntensity",0),x.setUniform("lgIntensity",0),x.setUniform("intensRatio",0),x.setUniform("range",0),x.setUniform("rdDir",[0,0]);const F=["lEye","rEye"][E];this.programs[F]=x,this.framebuffers[F]=D;const V=new l.Program(R);V.setShader(h.baseTextureShader.vShader,"VERTEX"),V.setShader(u.advFaceMaskShader.fShader,"FRAGMENT"),V.setAttributeBuffer(this.planePosBuffer),V.setAttributeBuffer(this.planeUVBuffer);const N=a.createFrameBuffer(R,k.width,k.height);V.setUniform("map",null),V.setUniform("maskMap",y.targetTexture),V.setUniform("index",E),this.programs["faceMaskMerge"+E]=V,this.framebuffers["faceMaskMerge"+E]=N}}get output(){return this.advData?this.framebuffers.rEye.targetTexture:super.output}get faceMask(){if(this.advData){const R=this.advData.length/212>>0;return this.framebuffers["faceMaskMerge"+(R-1)%2].targetTexture}return null}updateSize(){const R=this.renderer.getSize(),w={width:R.width>>2,height:R.height>>2};["wire","morph","lEye","rEye","faceMask","faceMaskMerge0","faceMaskMerge1","eyeTeeth"].forEach(k=>{var I;["faceMaskMerge0","faceMaskMerge1","lEye","rEye"].indexOf(k)===-1&&((I=this.programs[k])===null||I===void 0||I.setUniform("size",[R.width,R.height]));const M=this.framebuffers[k];if(M){const P=["faceMask","faceMaskMerge0","faceMaskMerge1","eyeTeeth"].indexOf(k)===-1?R:w;M.targetTexture.opts.width=P.width,M.targetTexture.opts.height=P.height,M.targetTexture.refresh()}})}setAdvData(R){this.advData=R.length?R:null}setAdvEffect(R,w){if(R in this.params&&typeof w=="number")this.params[R]=Math.min(1,Math.max(0,w)),R==="whitenTeeth"&&this.params[R]===0?this.programs.morph.setUniform("teethIntensity",0):R==="brightenEye"?this.programs.morph.setUniform("eyeIntensity",w):R==="roundedEye"?(this.programs.lEye.setUniform("rdIntensity",w),this.programs.rEye.setUniform("rdIntensity",w)):R==="enlargeEye"&&(this.programs.lEye.setUniform("lgIntensity",w),this.programs.rEye.setUniform("lgIntensity",w));else for(const k in this.defParams)this.setAdvEffect(k,this.defParams[k])}presetAdvEffect(R){for(const w in this.defParams)w in R?this.setAdvEffect(w,R[w]):this.setAdvEffect(w,this.defParams[w])}get featureParas(){return this.advData?{forehead:this.params.fadeHeadWrinkle,eyeRim:this.params.fadeEyeRim,noseLine:this.params.fadeNoseLine}:{forehead:0,eyeRim:0,noseLine:0}}posToUV(R,w,k){return new o.Vector2(R.x/w,1-R.y/k)}render(){const R=this.advData;if(R){const w=this.renderer,k=w.gl,I=w.getSize(),M={width:I.width>>2,height:I.height>>2},P=R.length/212>>0;for(let S=0;S<P;S++){const y=R.slice(212*S,212*(S+1)),_=S%2,b=this.programs.morph,E=this.programs["faceMaskMerge"+_];b.setUniform("map",S===0?this.map:this.framebuffers.rEye.targetTexture),b.updateAttribute("position",D=>{D.set(y,0),m.genTopFace(D),m.genFaceOutline(D)});let x=null;if(b.updateAttribute("tPosition",D=>{var F;const V=D;V.set(this.posBuffer.typedArray,0),o.preHandle(V);for(const N in o.handlers){const L=this.params[N];if(L!==this.defParams[N]){const U=(F=o.handlers[N])===null||F===void 0?void 0:F.call(o.handlers,V,L);N==="whitenTeeth"?b.setUniform("teethIntensity",U):N!=="roundedEye"&&N!=="enlargeEye"||(x=Object.assign(Object.assign({},U),{posData:V}))}}}),this.setWirePosBuffer(),this.isShowWire&&(this.framebuffers.wire.bind(),k.clear(k.COLOR_BUFFER_BIT|k.DEPTH_BUFFER_BIT),this.renderer.render(this.programs.wire)),w.setViewport(0,0,M.width,M.height),this.framebuffers.faceMask.bind(),this.renderer.render(this.programs.faceMask),E.setUniform("index",S),E.setUniform("map",this.framebuffers["faceMaskMerge"+(_===0?1:0)].targetTexture),this.framebuffers["faceMaskMerge"+_].bind(),this.renderer.render(E),this.programs.eyeTeeth.updateAttribute("tPosition",D=>{const F=D,V=this.targetPosBuffer.typedArray;[52,53,72,54,55,56,73,57,61,60,75,59,58,63,76,62,96,97,98,99,100,101,102,103].forEach((N,L)=>{let U=2*L,H=2*N;F[U]=V[H],F[U+1]=V[H+1]})}),this.framebuffers.eyeTeeth.bind(),k.clear(k.COLOR_BUFFER_BIT|k.DEPTH_BUFFER_BIT),this.renderer.render(this.programs.eyeTeeth),w.setViewport(0,0,I.width,I.height),this.framebuffers.morph.bind(),this.renderer.render(b),x){const D=this.posToUV(x.lEyeCenter,I.width,I.height),F=this.posToUV(x.rEyeCenter,I.width,I.height),V=this.posToUV(o.Vector2.getVec(x.posData,52),I.width,I.height),N=this.posToUV(o.Vector2.getVec(x.posData,55),I.width,I.height);let L=o.Vector2.getVec(x.posData,72),U=o.Vector2.getVec(x.posData,73);const H=this.posToUV(o.Vector2.getVec(x.posData,58),I.width,I.height),j=this.posToUV(o.Vector2.getVec(x.posData,61),I.width,I.height);let W=o.Vector2.getVec(x.posData,75),Y=o.Vector2.getVec(x.posData,76);const te=Math.min(1,Math.max(0,(o.Vector2.disPow2(L,U)-4)/4)),re=Math.min(1,Math.max(0,(o.Vector2.disPow2(W,Y)-4)/4));L=this.posToUV(L,I.width,I.height),U=this.posToUV(U,I.width,I.height),W=this.posToUV(W,I.width,I.height),Y=this.posToUV(Y,I.width,I.height),this.programs.lEye.setUniform("eyeCenter",D.value),this.programs.lEye.setUniform("range",Math.max(o.Vector2.dis(D,V),o.Vector2.dis(D,N))),this.programs.lEye.setUniform("rdDir",o.Vector2.normalize(o.Vector2.sub(L,U)).value),this.programs.lEye.setUniform("intensRatio",te),this.programs.rEye.setUniform("eyeCenter",F.value),this.programs.rEye.setUniform("range",Math.max(o.Vector2.dis(F,H),o.Vector2.dis(F,j))),this.programs.rEye.setUniform("rdDir",o.Vector2.normalize(o.Vector2.sub(W,Y)).value),this.programs.rEye.setUniform("intensRatio",re)}this.framebuffers.lEye.bind(),this.renderer.render(this.programs.lEye),this.framebuffers.rEye.bind(),this.renderer.render(this.programs.rEye)}}}static configStaticRes(R,w){const k=[];let I=1;const M=()=>{I-=1,I<=0&&(w?w.emit("advBeautyResComplete",k):g.forEach(P=>{try{P.emit("advBeautyResComplete",k)}catch{}}))};R.faceMask&&!v&&(I+=1,e.resSet.faceMask=R.faceMask,n.retryLoadImage(R.faceMask,3,P=>{v=P,g.forEach(S=>{try{S.faceMaskMap.source=P,S.faceMaskMap.refresh()}catch{}}),M()},()=>{k.push(R.faceMask),M()})),R.eyeTeethMask&&!O&&(I+=1,e.resSet.eyeTeethMask=R.eyeTeethMask,n.retryLoadImage(e.resSet.eyeTeethMask,3,P=>{O=P,g.forEach(S=>{try{S.eyeTeethMaskMap.source=P,S.eyeTeethMaskMap.refresh()}catch{}}),M()},()=>{k.push(R.eyeTeethMask),M()})),R.teethWhiten&&!T&&(I+=1,e.resSet.teethWhiten=R.teethWhiten,n.retryLoadImage(e.resSet.teethWhiten,3,P=>{T=P,g.forEach(S=>{try{S.whiteTeethLutMap.source=P,S.whiteTeethLutMap.refresh()}catch{}}),M()},()=>{k.push(R.teethWhiten),M()})),M()}destroy(){var R,w,k;super.destroy(),(R=this.renderer.gl)===null||R===void 0||R.deleteTexture(this.faceMaskMap.glTexture),(w=this.renderer.gl)===null||w===void 0||w.deleteTexture(this.eyeTeethMaskMap.glTexture),(k=this.renderer.gl)===null||k===void 0||k.deleteTexture(this.whiteTeethLutMap.glTexture),g.delete(this)}remove(){g.delete(this)}}e.AdvBeautyFilter=C},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.lutShader=void 0,e.lutShader={fShader:`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
        precision highp float;
    #else
        precision mediump float;
    #endif

    uniform sampler2D map;
    uniform sampler2D lut;

    // lut强度
    uniform float intensity;

    varying vec2 vuv;

    void main() {
        vec3 color = texture2D(map, vuv).rgb;

        if(intensity > 0.0){
            float blue = color.b * 63.0;

            vec2 q1;
            float fb = floor(blue);
            q1.y = floor(fb * 0.125);
            q1.x = fb - (q1.y * 8.0);

            vec2 q2;
            float cb = ceil(blue);
            q2.y = floor(cb * 0.125);
            q2.x = cb - (q2.y * 8.0);

            vec2 t = 0.123 * color.rg + vec2(0.000976563);
            vec2 t1 = q1 * 0.125 + t;
            vec3 p1 = texture2D(lut, t1).rgb;

            vec2 t2 = q2 * 0.125 + t;
            vec3 p2 = texture2D(lut, t2).rgb;

            vec3 filter = mix(p1, p2, fract(blue));
            color = mix(color, filter, intensity);
        }
        gl_FragColor = vec4(color, 1.0);
    }`}},,,function(t,e,r){var i=this&&this.__importDefault||function(P){return P&&P.__esModule?P:{default:P}};Object.defineProperty(e,"__esModule",{value:!0}),e.NERTC=void 0;const a=r(210),l=r(309),n=r(26),c=r(339),s=r(340),d=r(341),u=r(69),h=r(167),o=r(76),f=r(1),m=r(48),g=r(164),v=i(r(6)),O=i(r(8)),T=i(r(203)),C=r(84),A=r(49),R=r(43),w=r(143),k=r(204);let I,M=window;e.NERTC={Logger:{DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4,setLogLevel(P){const S=f.getParameters().forceLogLevel;S!==-1?I==null||I.logger.error("setLogLevel: 本页面的日志级别固定为 "+C.loglevelMap[S]):(I&&I.apiFrequencyControl({name:"setLogLevel",code:0,param:{clientUid:I.adapterRef.channelInfo.uid||"",level:P}}),T.default.setLogLevel(P))},enableLogUpload(){f.getParameters().forceLogUpload==="off"?I==null||I.logger.error("enableLogUpload: 禁止开启日志上传"):(I&&I.apiFrequencyControl({name:"enableLogUpload",code:0,param:{clientUid:I.adapterRef.channelInfo.uid||""}}),T.default.enableLogUpload())},disableLogUpload(){f.getParameters().forceLogUpload==="on"?I==null||I.logger.error("disableLogUpload: 禁止关闭日志上传"):(I&&I.apiFrequencyControl({name:"disableLogUpload",code:0,param:{clientUid:I.adapterRef.channelInfo.uid||""}}),T.default.disableLogUpload())}},setArea(P){const S=f.getParameters().forceGeofenceArea;if(S!=="NONE")I==null||I.logger.error("setArea: 本页面的日志级别固定为 "+S);else{A.checkValidObject({tag:"NERTC.setArea:area",value:P}),A.checkValidEnum({tag:"NERTC.setArea:area.areaCode",value:P.areaCode,enums:k.geofenceArea.getAvailableAreas()});let y=null;for(let _ in f.getParameters().clients)if(y=f.getParameters().clients[_],!y.destroyed&&y.adapterRef.connectState.curState!=="DISCONNECTED")throw new O.default({code:v.default.CLIENT_ALREADY_IN_CHANNEL_ERROR,message:"用户已在频道中，不支持调用setArea"});k.geofenceArea.setAreaById(P.areaCode),y&&y.apiFrequencyControl({name:"setArea",code:0,param:{clientUid:y.adapterRef.channelInfo.uid||"",area:P,config:k.geofenceArea.getBuiltinConfig()}})}},createClient(P){if(!g.checkSystemRequirements())throw console.error("浏览器环境不支持"),new O.default({code:v.default.NOT_SUPPORT_ERROR,message:"云信sdk不支持，请使用最新版本的chrome浏览器"});A.checkExists({tag:"createClient:ClientOptions",value:P}),A.checkExists({tag:"createClient:ClientOptions.appkey",value:P.appkey});const S=new a.Client(Object.assign(P,{apiList:[],ref:e.NERTC}));return f.getParameters().clients.push(S),I||(I=S),S},createStream(P){if(A.checkExists({tag:"createStream:options",value:P}),w.isHttpProtocol()&&!f.getParameters().passEnvCheck)throw I==null||I.adapterRef.logger.warn("The current protocol is HTTP"),new O.default({code:v.default.NOT_SUPPORT_ERROR,message:"请使用https环境或者localhost环境"});if(!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)&&!f.getParameters().passEnvCheck)throw I==null||I.adapterRef.logger.warn("没有 getUserMedia 方法。请使用最新版本的chrome浏览器"),new O.default({code:v.default.NOT_SUPPORT_ERROR,message:"浏览器不支持开启媒体设备，请使用最新版本的chrome浏览器"});if(P.screenAudio&&!P.screen&&!P.screenAudioSource)throw new O.default({code:v.default.INVALID_OPERATION_ERROR,message:"createStream: screenAudio 要与 screen 一起开启"});if(!P.client&&I&&I.adapterRef.logger.warn("createStream: 未传入client参数。使用默认client。"),I||P.client){const S=new l.LocalStream(Object.assign(P,{isRemote:!1,client:P.client||I}));return f.getParameters().localStreams.push(S),S}return c.clientNotYetUninitialized},Device:o.Device,getDevices:(P=!1)=>o.Device.getDevices({audioinput:!0,audiooutput:!0,videoinput:!0,requestPerm:P}),getCameras:(P=!1)=>o.Device.getCameras(P),getMicrophones:(P=!1)=>o.Device.getMicrophones(P),getSpeakers:(P=!1)=>o.Device.getSpeakers(P),checkSystemRequirements:g.checkSystemRequirements,getSupportedCodec:async()=>await R.getSupportedCodecs(),checkBrowserCompatibility:async()=>await w.checkBrowserCompatibility(),getHandler:()=>h.detectDevice(),_geofenceArea:k.geofenceArea,getParameters:f.getParameters,destroy(P){let S=P||I;S&&S.destroy(),P||(I=null)},PlatformTypeMap:m.PlatformTypeMap,CHAT_VIDEO_FRAME_RATE_NORMAL:u.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL,CHAT_VIDEO_FRAME_RATE_5:u.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_5,CHAT_VIDEO_FRAME_RATE_10:u.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_10,CHAT_VIDEO_FRAME_RATE_15:u.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15,CHAT_VIDEO_FRAME_RATE_20:u.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_20,CHAT_VIDEO_FRAME_RATE_25:u.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_25,CHAT_VIDEO_FRAME_RATE_30:u.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_30,VIDEO_QUALITY_180p:u.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_180p,VIDEO_QUALITY_480p:u.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p,VIDEO_QUALITY_720p:u.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_720p,VIDEO_QUALITY_1080p:u.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p,RECORD_VIDEO_QUALITY_360p:u.NERTC_RECORD_VIDEO_QUALITY.RECORD_VIDEO_QUALITY_360p,RECORD_VIDEO_QUALITY_480p:u.NERTC_RECORD_VIDEO_QUALITY.RECORD_VIDEO_QUALITY_480p,RECORD_VIDEO_QUALITY_720p:u.NERTC_RECORD_VIDEO_QUALITY.RECORD_VIDEO_QUALITY_720p,RECORD_VIDEO_FRAME_RATE_15:u.NERTC_RECORD_VIDEO_FRAME_RATE.RECORD_VIDEO_FRAME_RATE_15,RECORD_VIDEO_FRAME_RATE_30:u.NERTC_RECORD_VIDEO_FRAME_RATE.RECORD_VIDEO_FRAME_RATE_30,LIVE_STREAM_AUDIO_CODEC_PROFILE:s.LIVE_STREAM_AUDIO_CODEC_PROFILE,LIVE_STREAM_AUDIO_SAMPLE_RATE:s.LIVE_STREAM_AUDIO_SAMPLE_RATE,VIDEO_FRAME_RATE:u.VIDEO_FRAME_RATE,VIDEO_QUALITY:u.NERTC_VIDEO_QUALITY,NETWORK_STATUS:d.NETWORK_STATUS,STREAM_TYPE:u.STREAM_TYPE,VERSION:n.SDK_VERSION,BUILD:n.BUILD,ENV:n.ENV},e.default=e.NERTC,t.exports=M.WebRTC2=e.NERTC},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(P,S,y,_){_===void 0&&(_=y),Object.defineProperty(P,_,{enumerable:!0,get:function(){return S[y]}})}:function(P,S,y,_){_===void 0&&(_=y),P[_]=S[y]}),a=this&&this.__setModuleDefault||(Object.create?function(P,S){Object.defineProperty(P,"default",{enumerable:!0,value:S})}:function(P,S){P.default=S}),l=this&&this.__importStar||function(P){if(P&&P.__esModule)return P;var S={};if(P!=null)for(var y in P)y!=="default"&&Object.prototype.hasOwnProperty.call(P,y)&&i(S,P,y);return a(S,P),S},n=this&&this.__importDefault||function(P){return P&&P.__esModule?P:{default:P}};Object.defineProperty(e,"__esModule",{value:!0}),e.Client=void 0;const c=r(26),s=r(69),d=r(76),u=r(145),h=r(215),o=r(1),f=r(147),m=r(47),g=r(48),v=n(r(6)),O=n(r(8)),T=r(216),C=r(49),A=r(217),R=r(308),w=r(43),k=r(149),I=l(r(7));class M extends A.Base{constructor(S){super(S),this.destroyed=!1,this.outOfConnect=!1,this.onJoinFinish=null,this.spatialManager=null,this.outputDeviceId="default",this.__v_skip=o.getParameters().enableVSkip,this.apiFrequencyControl({name:"createClient",code:0,param:{clientUid:"",debug:S.debug}}),this.operationQueue=new T.OperationQueue(this.logger),this.handlePageUnload=y=>{this.adapterRef.channelStatus!=="join"&&this.adapterRef.channelStatus!=="connectioning"||(this.logger.warn(`收到 ${y==null?void 0:y.type} 事件，当前状态：${this.adapterRef.channelStatus}，即将离开房间`),this.leave(v.default.PAGE_UNLOAD))},this.handleOnOnline=y=>{var _;const b={cmd:"onOnline",data:{type:y.type}};(_=this.adapterRef.signalProbeManager.worker)===null||_===void 0||_.postMessage(b)},this.handleOnOffline=y=>{},this.handleUnhandledRejection=y=>{this.logger.warn(`Exception caught => type: ${y.type}, reason: ${y.reason}`),this.apiFrequencyControl({name:"exception",code:0,param:{clientUid:"",type:y.type,reason:y.reason}})},o.getParameters().leaveOnUnload&&(window.addEventListener("pagehide",this.handlePageUnload),window.addEventListener("beforeunload",this.handlePageUnload)),o.getParameters().trustOnOnline&&window.addEventListener("online",this.handleOnOnline),o.getParameters().trustOnOffline&&window.addEventListener("offline",this.handleOnOffline),o.getParameters().trustUnhandledrejection&&window.addEventListener("unhandledrejection",this.handleUnhandledRejection),this._roleInfo={userRole:0,audienceList:{}},this._init(S),this.logger.info(`NERTC ${c.SDK_VERSION} ${c.BUILD}: 客户端创建成功。`),this.on("@connection-state-change",y=>{var _,b,E;y.prevState==="CONNECTED"&&(!((_=this.recordManager.record)===null||_===void 0)&&_._status.isRecording)&&((b=this.recordManager.record)===null||b===void 0?void 0:b._status.state)==="started"&&(this.logger.log("自动停止客户端录制功能"),this.recordManager.record.download()),y.curState==="CONNECTED"&&y.prevState==="CONNECTING"&&(y.reconnect&&this.adapterRef.lbsManager.startUpdate("reconnect"),!((E=this.adapterRef.datareportCache)===null||E===void 0)&&E.length&&(this.logger.log(`上报进频道前事件：${this.adapterRef.datareportCache.length}条: ${this.adapterRef.datareportCache.map(x=>x.func).join()}`),this.adapterRef.datareportCache.forEach(x=>{const D=x.datareport[x.func];D&&(D.cid=D.cid||this.adapterRef.channelInfo.cid,D.uid=D.uid||this.adapterRef.channelInfo.uid),x.datareport.send()}),this.adapterRef.datareportCache=[]))}),this.on("@media-stats-change",y=>{let _=!1,b={profile:w.getCurrentProfileLevel()};y.data.forEach(E=>{var x;E.mediaType!=="video"&&E.mediaType!=="screen"||!((x=E.new)===null||x===void 0)&&x.CodecImplementationName&&(b[`${E.mediaType}_${E.streamType}`]=E.new.CodecImplementationName,E.new.CodecImplementationName!=="unknown"&&(E.old&&E.old.CodecImplementationName===E.new.CodecImplementationName||(this.logger.log(`CodecImplementationName ${E.streamType} ${E.mediaType} ${E.new.CodecImplementationName}`),_=!0)))}),_&&this.apiFrequencyControl({name:"CodecImplementationName",code:0,param:b})})}_init(S){const{appkey:y="",token:_}=S;this._params.appkey=y,this.adapterRef.lbsManager.loadBuiltinConfig("oninit"),this._params.token=_,this._roleInfo={userRole:0,audienceList:{}},d.Device.deviceInited||d.Device.startDeviceChangeDetection(),d.Device.on("recording-device-changed",E=>{this.destroyed||(this.safeEmit("recording-device-changed",E),this.adapterRef.instance.apiEventReport("setUserCustomEvent",{name:"recording-device-changed",customIdentify:"client",param:JSON.stringify(E,null," ")}))}),d.Device.on("camera-changed",E=>{this.destroyed||(this.safeEmit("camera-changed",E),this.adapterRef.instance.apiEventReport("setUserCustomEvent",{name:"camera-changed",customIdentify:"client",param:JSON.stringify(E,null," ")}))}),d.Device.on("playout-device-changed",E=>{this.destroyed||(this.safeEmit("playout-device-changed",E),this.adapterRef.instance.apiEventReport("setUserCustomEvent",{name:"playout-device-changed",customIdentify:"client",param:JSON.stringify(E,null," ")}))}),d.Device.on("device-open-fail",E=>{this.destroyed||this.safeEmit("device-open-fail",E)}),d.Device.on("unknown-display-surface",E=>{this.destroyed||this.safeEmit("displaySurfaceUnknown",E)});const b=()=>{this.onJoinFinish?(this.onJoinFinish(),this.onJoinFinish=null):this.logger.debug("孤立的join完成回调")};this.addListener("@pairing-join-success",b),this.addListener("@pairing-join-error",b),o.getParameters().enableAlerter!=="never"&&d.alerter.watchClient(this.adapterRef.instance),document.addEventListener("visibilitychange",this._onVisibilityChange.bind(this)),this.eventCacheReport()}getUid(){return this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid}getParameter(S="getChannelInfo"){if(this.apiFrequencyControl({name:"getParameter",code:0,param:{type:S}}),S==="getChannelInfo"){const y=`appkey=${this._params.appkey}&osType=4&mode=2&netType=0&version=${c.SDK_VERSION+".0"}&webrtc=1&nrtcg2=1&t1=${Date.now()}`;return JSON.stringify({postData:y,header:{"Content-Type":"application/x-www-form-urlencoded"}})}}getChannelInfo(){return this.apiFrequencyControl({name:"getChannelInfo",code:0,param:{clientUid:this.adapterRef.channelInfo.uid||""}}),this.adapterRef.channelInfo||{}}startProxyServer(S){let y=null;if(this.adapterRef.logger.log("startProxyServer()"),this.adapterRef.channelStatus!=="join"&&this.adapterRef.channelStatus!=="connectioning"||(this.adapterRef.logger.warn("startProxyServer() 请在加入房间前调用"),y="startProxyServer() 请在加入房间前调用"),this.apiFrequencyControl({name:"startProxyServer",code:y?-1:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",reason:y}}),y)throw new O.default({code:v.default.API_CALL_SEQUENCE_BEFORE_ERROR,message:"startProxyServer() 请在加入房间前调用"});this.adapterRef.proxyServer.enable=!0,S&&(this.adapterRef.proxyServer.type=S)}stopProxyServer(){this.adapterRef.logger.log("stopProxyServer()"),this.adapterRef.proxyServer&&(this.adapterRef.proxyServer.enable=!1,this.adapterRef.proxyServer.wsProxyArray=null),this.apiFrequencyControl({name:"stopProxyServer",code:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",reason:""}})}setLocalMediaPriority(S){this.logger.log("setLocalMediaPriority() options: ",JSON.stringify(S));let y=0,_="";this.adapterRef.channelStatus!=="join"&&this.adapterRef.channelStatus!=="connectioning"||(_="setLocalMediaPriority() 请在加入房间前调用",y=v.default.API_CALL_SEQUENCE_BEFORE_ERROR),S.priority!==100&&S.priority!==50&&(_="setLocalMediaPriority: options.priority应该是100或者50",y=v.default.SET_LOCAL_MEDIA_PRIORITY_ARGUMENT_ERROR);const{priority:b=100,preemtiveMode:E=!1}=S;if(this.apiFrequencyControl({name:"setLocalMediaPriority",code:y?-1:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",priority:b,preemtiveMode:E,reason:y,message:_}}),y)throw this.logger.error(_),new O.default({code:y,message:_});this.adapterRef.userPriority=S}async join(S){this.logger.log("join() 加入频道, options: ",JSON.stringify(S,null," ")),this.adapterRef.instance.outOfConnect=!1;let y=null;try{if(!S.channelName||S.channelName==="")throw this.logger.log("join() 请填写房间名称"),new O.default({code:v.default.JOIN_WITHOUT_CHANNEL_NAME,message:"join() 请填写房间名称"});if(S.joinChannelRecordConfig&&(C.checkValidBoolean({tag:"joinOptions.joinChannelRecordConfig.recordAudio should be boolean",value:S.joinChannelRecordConfig.recordAudio}),C.checkValidBoolean({tag:"joinOptions.joinChannelRecordConfig.recordVideo should be boolean",value:S.joinChannelRecordConfig.recordVideo})),typeof S.uid=="string"){if(this.logger.log("join() uid 是 string 类型"),!/^[1-9]\d*$/.test(S.uid))throw this.logger.log("join() uid 不是数字字符串格式"),new O.default({code:v.default.JOIN_UID_TYPE_ERROR,message:"join() uid 不是数字字符串格式"});this.adapterRef.channelInfo.uidType="string"}else{if(typeof S.uid!="number")return this.logger.error("join() uid 参数格式非法"),Promise.reject(new O.default({code:v.default.JOIN_UID_TYPE_ERROR,message:"join() uid 参数格式非法"}));if(this.logger.log("join() uid 是 number类型"),this.adapterRef.channelInfo.uidType="number",S.uid>Number.MAX_SAFE_INTEGER)throw this.logger.error("join() uid 参数越界, 会导致精度缺失"),new O.default({code:v.default.JOIN_UID_TYPE_ERROR,message:"join() Number 类型的 uid 最大值是 2^53 - 1, 请输入正确的参数"})}if(S.mixRemoteAudioStream&&(this.logger.log("join() 开启远端音频流混流"),this.adapterRef.enableMixAudio=!0),this.onJoinFinish=await this.operationQueue.enqueue({caller:this,method:"join",options:S}),this.safeEmit("@pairing-join-start"),this.adapterRef.channelStatus==="join"||this.adapterRef.channelStatus==="connectioning")return this.safeEmit("@pairing-join-error"),Promise.reject(new O.default({code:v.default.REPEAT_JOIN_ERROR,message:"join() 重复加入房间"}));if(this.adapterRef.connectState.curState="CONNECTING",this.adapterRef.connectState.prevState="DISCONNECTED",this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),S.spatial&&this.initSpatialManager(S.spatial),S.token&&(this._params.token=S.token),S.customData&&(this.adapterRef.channelInfo.customData=S.customData),I.ANY_CHROME_MAJOR_VERSION&&I.ANY_CHROME_MAJOR_VERSION>=58&&I.ANY_CHROME_MAJOR_VERSION<69||k.detectRtcCapabilities().catch(b=>{this.logger.warn("join() detectRtcCapabilities",b.name,b.message)}),this._params.JoinChannelRequestParam4WebRTC2={startJoinTime:Date.now(),appkey:this._params.appkey,userRole:this._roleInfo.userRole,channelName:S.channelName,wssArr:S.wssArr,uid:S.uid,permKey:S.permKey||"",token:this._params.token,joinChannelLiveConfig:S.joinChannelLiveConfig||{liveEnable:!1},joinChannelRecordConfig:S.joinChannelRecordConfig||{recordAudio:!1,recordVideo:!1,recordType:0,isHostSpeaker:!1},getChanneInfoResponse:S.getChanneInfoResponse},S.neRtcServerAddresses&&(o.getParameters().signalProbeEnabled=!1,this._params.neRtcServerAddresses={channelServer:S.neRtcServerAddresses.channelServer||"",statisticsServer:S.neRtcServerAddresses.statisticsServer||"",statisticsWebSocketServer:S.neRtcServerAddresses.statisticsWebSocketServer||"",roomServer:S.neRtcServerAddresses.roomServer||"",webSocketProxyServer:S.neRtcServerAddresses.webSocketProxyServer||"",mediaProxyServer:S.neRtcServerAddresses.mediaProxyServer||"",lbsServer:S.neRtcServerAddresses.lbsServer||""}),!o.getParameters().disableLBSService&&!o.getParameters().lbsUseBuiltinOnly&&(y=this.adapterRef.lbsManager.loadLocalConfig("onjoin"),y.config)){const b=y.config.ts+1e3*y.config.config.ttl-Date.now();b<1e3*y.config.config.preloadTimeSec&&(this.logger.log(`join() LBS在 ${Math.floor(b/1e3)} 秒后过期。preloadTimeSec: ${y.config.config.preloadTimeSec}。发起异步刷新请求`),this.adapterRef.lbsManager.startUpdate("renew"))}if(this.setStartSessionTime(),this.initMode(),!this.adapterRef.mediaCapability.supportedCodecRecv||!this.adapterRef.mediaCapability.supportedCodecSend)try{await this.adapterRef.mediaCapability.detect()}catch(b){this.logger.warn("join() Failed to detect mediaCapability: ",b.name,b.message)}if(!this.adapterRef._meetings)throw this.logger.error("join() meeting 模块缺失"),this.safeEmit("@pairing-join-error"),new O.default({code:v.default.UNKNOWN_TYPE_ERROR,message:"join() meeting 模块缺失"});const _=await this.adapterRef._meetings.joinChannel(this._params.JoinChannelRequestParam4WebRTC2);return this.safeEmit("@pairing-join-success"),y&&!y.config&&this.adapterRef.lbsManager.startUpdate(y.reason),this.apiFrequencyControl({name:"join",code:0,param:Object.assign({},S)}),_}catch(_){throw this.logger.error("join() 加入房间失败: ",_.message),this.safeEmit("@pairing-join-error"),y&&!y.config&&this.adapterRef.lbsManager.startUpdate(y.reason),this.apiFrequencyControl({name:"join",code:-1,param:Object.assign(Object.assign({},S),{reason:_&&_.message})}),this.stopSession(),_.getCode?_:new O.default({code:v.default.JOIN_FAILED,message:`join() 内部错误: ${_.name}, ${_.message}`})}}async leave(S=0){const y=await this.operationQueue.enqueue({caller:this,method:"leave",options:null});this.logger.log("leave() 离开频道: ",S),this.adapterRef.instance.apiEventReport("setLogout",{reason:S}),this.apiFrequencyControl({name:"leave",code:0,param:{clientUid:this.getUid()}}),this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTING",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.apiEventReport("setConnectionStateChange",{state:g.ConStateChange_state.ChannelLeave,reason:g.ConStateChange_reason.Leave}),this.setEndSessionTime(),this.adapterRef.asrCaptionConfig.enable&&(await this.stopAsrCaptions(),this.adapterRef.asrCaptionConfig={enable:!1,source:"CH",target:"CH"}),this.adapterRef._meetings?await this.adapterRef._meetings.leaveChannel():this.adapterRef.connectState={prevState:"DISCONNECTED",curState:"DISCONNECTED",reconnect:!1},this.adapterRef.audioMixer&&this.adapterRef.audioMixer.destroy(),document.removeEventListener("visibilitychange",this._onVisibilityChange.bind(this)),setTimeout(()=>{this.eventCacheReport()},500),y()}setEncryptionMode(S){if(C.checkValidInteger({tag:"Valid encryptionModes are: "+Object.keys(u.EncryptionModes).join(","),value:u.encryptionModeToInt(S)}),this.adapterRef.encryption.encodedInsertableStreams){const _="setEncryptionMode() 自定义加密功能与国密加密功能不兼容";throw this.logger.error(_),new O.default({code:v.default.SET_ENCRYPTION_MODE_ERROR,message:_})}this.logger.log("setEncryptionMode() 设置加密模式：",S),this.adapterRef.encryption.setEncryptionMode(S);const y={enable:S!=="none",mode:u.encryptionModeToInt(S)};this.apiFrequencyControl({name:"setEncryptionMode",code:0,param:JSON.stringify(y,null," ")})}setEncryptionSecret(S){switch(this.adapterRef.encryption.encryptionMode){case"none":throw new O.default({code:v.default.SET_ENCRYPTION_SECRET_INVALID_OPERATION_ERROR,message:"setEncryptionSecret() 请先设置加密模式"});case"sm4-128-ecb":C.checkValidString({tag:"client.setEncryptionSecret:encryptionSecret",value:S,min:1,max:128})}this.logger.log("设置加密密钥"),this.adapterRef.encryption.setEncryptionSecret(S),this.apiFrequencyControl({name:"setEncryptionSecret",code:0,param:JSON.stringify({encryptionSecret:S},null," ")})}enableCustomTransform(S){var y;let _,b;if(this.adapterRef.connectState.curState!=="DISCONNECTED"?(_="enableCustomTransform() 必须在加入频道前调用",b=v.default.API_CALL_SEQUENCE_BEFORE_ERROR):typeof window.TransformStream!="function"?(_="enableCustomTransform() 浏览器不支持自定义加密, TransformStream 未找到",b=v.default.CUSTOM_TRANSFOR_NOT_SUPPORT_ERROR):typeof((y=window.RTCRtpReceiver)===null||y===void 0?void 0:y.prototype.createEncodedStreams)!="function"?(_="enableCustomTransform() 浏览器不支持自定义加解密，未找到createEncodedStreams",b=v.default.CUSTOM_TRANSFOR_NOT_SUPPORT_ERROR):this.adapterRef.encryption.encryptionMode!=="none"&&(_="enableCustomTransform() 自定义加密功能与国密加密功能不兼容",b=v.default.SET_ENCRYPTION_MODE_ERROR),this.apiFrequencyControl({name:"enableCustomTransform",code:_?-1:0,param:JSON.stringify({enable:S,message:_})}),_)throw this.logger.error(_),new O.default({code:b,message:_});S===!1?(this.adapterRef.encryption.encodedInsertableStreams=!1,this.logger.log("enableCustomTransform() 已关闭自定义加解密")):(this.adapterRef.encryption.encodedInsertableStreams=!0,this.logger.log("enableCustomTransform() 已开启自定义加解密"))}async publish(S,y="all"){C.checkExists({tag:"client.publish:stream",value:S}),await this.doPublish(S,y)}async doPublish(S,y){const _=await this.operationQueue.enqueue({caller:this,method:"publish",options:S});let b=0,E="";const x=()=>{var D,F;_();const V={reason:b,message:E,profileLevel:w.getCurrentProfileLevel(),pubStatus:S.pubStatus};(S.mediaHelper.video.cameraTrack||S.mediaHelper.video.videoSource)&&(V.webcamProducerCodec=(D=this.adapterRef._mediasoup)===null||D===void 0?void 0:D._webcamProducerCodec),(S.mediaHelper.screen.screenVideoTrack||S.mediaHelper.screen.screenVideoSource)&&(V.screenProducerCodec=(F=this.adapterRef._mediasoup)===null||F===void 0?void 0:F._screenProducerCodec),this.apiFrequencyControl({name:"publish",code:b?-1:0,param:JSON.stringify(V)});const N=JSON.stringify(S.mediaHelper.getTrackSettings());this.apiFrequencyControl({name:"_trackSettings",code:0,param:N}),this.adapterRef.instance.apiEventReport("setUserCustomEvent",{name:"media_track_Settings",customIdentify:"publish",param:N})};if(S&&(S.audio||S.video||S.screen||S.screenAudio)?this._roleInfo.userRole===1?(E="publish() 观众禁止Publish, 请先使用setClientRole设为主播",this.logger.error(E),b=v.default.PUBLISH_ROLE_ERROR):this.adapterRef.connectState.curState==="CONNECTING"?(E="publish() 当前正在连接, 将在连接成功后发布媒体流",this.bindLocalStream(S),b=v.default.RECONNECTING):this.adapterRef.connectState.curState!=="CONNECTED"&&(E="publish() 当前不在频道中, 可能是没有加入频道或者是网络波动导致暂时断开连接",this.logger.error(E),b=v.default.API_CALL_SEQUENCE_BEFORE_ERROR):S&&o.getParameters().allowEmptyMedia?this.logger.log("publish() 当前模式允许发布没有媒体流的localStream"):(E="publish() 传入的 stream 格式非法，没有媒体数据",this.logger.error(E),b=v.default.PUBLISH_NO_STREAM),b)return E?(x(),Promise.reject(new O.default({code:b,message:E}))):void x();try{if(!this.adapterRef._mediasoup)throw E="publish() 媒体mediasoup模块缺失",b=v.default.UNKNOWN_TYPE_ERROR,this.logger.error(E),x(),new O.default({code:b,message:E});this.bindLocalStream(S);try{S.logger.log("publish() 发布音视频: ",S.getId(),y),await this.adapterRef._mediasoup.createProduce(S,y)}catch(D){this.logger.error("publish() createProduce error: ",D)}x()}catch(D){throw this.logger.error("publish() 内部错误: ",D.name,D.message),b=v.default.UNKNOWN_TYPE_ERROR,E=D.message,x(),D.getCode?D:new O.default({code:b,message:`publish() 内部错误: ${D.name}, ${D.message}`})}}async unpublish(S,y){C.checkExists({tag:"client.unpublish:stream",value:S});const _=await this.operationQueue.enqueue({caller:this,method:"unpublish",options:null}),b=()=>{_(),JSON.stringify({pubStatus:S&&S.pubStatus,reason:E,message:x},null," "),this.apiFrequencyControl({name:"unpublish",code:E?-1:0,param:{clientUid:this.getUid(),pubStatus:S&&S.pubStatus,reason:E,mediaType:y}})};let E=0,x="";if(this.adapterRef.connectState.curState==="CONNECTING"?(this.adapterRef.localStream=null,x="unpublish() 当前正在连接, 连接成功后将不再发送媒体流",E=v.default.RECONNECTING):this.adapterRef.connectState.curState!=="CONNECTED"&&(x="unpublish() 当前不在频道中, 可能是没有加入频道或者是网络波动导致暂时断开连接",this.logger.error(x),E=v.default.API_CALL_SEQUENCE_BEFORE_ERROR),E)return b(),x?(this.logger.error(x),Promise.reject(new O.default({code:E,message:x}))):void 0;this.logger.log("unpublish(): 开始取消发布本地流",y);try{if(!this.adapterRef._mediasoup)throw x="unpublish() 媒体mediasoup模块缺失",E=v.default.UNKNOWN_TYPE_ERROR,this.logger.error(x),b(),new O.default({code:E,message:x});y&&y!=="all"?await this.adapterRef._mediasoup.destroyProduce(y):(await this.adapterRef._mediasoup.destroyProduce("audio"),await this.adapterRef._mediasoup.destroyProduce("audioSlave"),await this.adapterRef._mediasoup.destroyProduce("video"),await this.adapterRef._mediasoup.destroyProduce("screen"),this.adapterRef.localStream=null),b()}catch(D){throw this.logger.error("unpublish() 内部错误: ",D.name,D.message),E=v.default.UNKNOWN_TYPE_ERROR,x=D.message,b(),D.getCode?D:new O.default({code:E,message:`unpublish() 内部错误: ${D.name}, ${D.message}`})}}getSubStatus(S,y){let _={status:"unsubscribed",subscribable:!1};if(y==="all"){const b=[this.getSubStatus(S,"audio"),this.getSubStatus(S,"audioSlave"),this.getSubStatus(S,"video"),this.getSubStatus(S,"screen")];b.find(E=>E.status==="unsubscribing")?_.status="unsubscribing":b.find(E=>E.status==="subscribing")&&(_.status="subscribing"),b.find(E=>E.status==="subscribed")&&(_.status="subscribed"),_.status!=="subscribed"&&_.status!=="unsubscribed"||b.find(E=>E.subscribable)&&(_.subscribable=!0)}else S.pubStatus[y].stopconsumerStatus==="start"?_.status="unsubscribing":S.pubStatus[y].consumerStatus==="start"?_.status="subscribing":S.pubStatus[y].consumerId?_.status="subscribed":_.status==="unsubscribed"&&S.pubStatus[y].producerId&&S.subConf[y]&&(_.subscribable=!0);return _}async subscribe(S,y){if(!this.spatialManager)return C.checkExists({tag:"client.subscribe:stream",value:S}),y?(this.logger.log(`subscribe [订阅远端: ${S.stringStreamID}] ${JSON.stringify(y)}`),S.doSetSubscribeConfig(y),this.doSubscribe(S)):(this.logger.log(`subscribe() [订阅远端: ${S.stringStreamID}]`),this.doSubscribe(S));this.logger.warn("subscribe() 已开启空间音频，跳过用户订阅步骤")}async doSubscribe(S){var y,_,b,E,x,D,F,V,N,L;const U=S.getId();if(!this.adapterRef._mediasoup){const j="subscribe() 媒体mediasoup模块缺失";throw this.logger.error(j),new O.default({code:v.default.UNKNOWN_TYPE_ERROR,message:j})}let H={audio:S.subConf.audio,audioSlave:S.subConf.audioSlave,video:S.subConf.video,screen:S.subConf.screen};try{if(S.subConf.audio)((y=this.adapterRef.permKeyInfo)===null||y===void 0?void 0:y.subAudioRight)===!1?(this.logger.error("subscribe() permKey权限控制，没有权限订阅audio"),this.adapterRef.instance.emit("error","no-subscribe-audio-permission")):S.pubStatus.audio.audio&&!S.pubStatus.audio.consumerId&&(I.ANY_CHROME_MAJOR_VERSION&&I.ANY_CHROME_MAJOR_VERSION<69?this.logger.log(`subscribe() 开始订阅 ${S.getId()} 音频流`):(this.logger.log(`subscribe() 开始订阅 ${S.getId()} 音频流`),S.pubStatus.audio.consumerStatus="start",await this.adapterRef._mediasoup.createConsumer(U,"audio","audio",S.pubStatus.audio.producerId),S.pubStatus.audio.consumerStatus="end",this.logger.log(`subscribe() 订阅 ${S.getId()} 音频流完成`)));else if(S.pubStatus.audio.consumerId&&S.pubStatus.audio.stopconsumerStatus!=="start")if(I.ANY_CHROME_MAJOR_VERSION&&I.ANY_CHROME_MAJOR_VERSION<69)this.logger.log(`subscribe() 开始取消订阅 ${S.getId()} 音频流`);else{this.logger.log(`subscribe() 开始取消订阅 ${S.getId()} 音频流`),S.pubStatus.audio.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(S.pubStatus.audio.consumerId,S,"audio"),this.adapterRef.instance.removeSsrc(S.getId(),"audio"),S.mediaHelper.updateStream("audio",null),S.pubStatus.audio.consumerId="",S.stop("audio"),S.pubStatus.audio.stopconsumerStatus="end",S.subStatus.audio=!1;const j=S.getId();j&&delete this.adapterRef.remoteAudioStats[j],this.logger.log(`subscribe() 取消订阅 ${S.getId()} 音频流完成`)}else this.logger.log(`subscribe() 开始取消订阅 ${S.getId()} audio流, consumerId: ${S.pubStatus.audio.consumerId}, stopconsumerStatus: {stream.pubStatus.audio.stopconsumerStatus}`);if(S.subConf.audioSlave)((_=this.adapterRef.permKeyInfo)===null||_===void 0?void 0:_.subAudioRight)===!1?(this.logger.error("subscribe() permKey权限控制，没有权限订阅audio slave"),this.adapterRef.instance.emit("error","no-subscribe-audio-slave-permission")):S.pubStatus.audioSlave.audioSlave&&!S.pubStatus.audioSlave.consumerId&&(I.ANY_CHROME_MAJOR_VERSION&&I.ANY_CHROME_MAJOR_VERSION<69?this.logger.log(`subscribe() 开始订阅 ${S.getId()} 音频辅流`):(this.logger.log(`subscribe() 开始订阅 ${S.getId()} 音频辅流`),S.pubStatus.audioSlave.consumerStatus="start",await this.adapterRef._mediasoup.createConsumer(U,"audio","audioSlave",S.pubStatus.audioSlave.producerId),S.pubStatus.audioSlave.consumerStatus="end",this.logger.log(`subscribe() 订阅 ${S.getId()} 音频辅流完成`)));else if(S.pubStatus.audioSlave.consumerId&&S.pubStatus.audioSlave.stopconsumerStatus!=="start")if(I.ANY_CHROME_MAJOR_VERSION&&I.ANY_CHROME_MAJOR_VERSION<69)this.logger.log(`subscribe() 开始取消订阅 ${S.getId()} 音频辅流`);else{this.logger.log(`subscribe() 开始取消订阅 ${S.getId()} 音频辅流`),S.pubStatus.audioSlave.stopconsumerStatus="start",await((b=this.adapterRef._mediasoup)===null||b===void 0?void 0:b.destroyConsumer(S.pubStatus.audioSlave.consumerId,S,"audioSlave")),this.adapterRef.instance.removeSsrc(S.getId(),"audioSlave"),S.mediaHelper.updateStream("audioSlave",null),S.pubStatus.audioSlave.consumerId="",S.stop("audioSlave"),S.pubStatus.audioSlave.stopconsumerStatus="end",S.subStatus.audioSlave=!1;const j=S.getId();j&&delete this.adapterRef.remoteAudioSlaveStats[j],this.logger.log("subscribe() 取消订阅 ${stream.getId()} 音频辅流完成")}else this.logger.log(`subscribe() 开始取消订阅 ${S.getId()} audioSlave流, consumerId: ${S.pubStatus.audioSlave.consumerId}, stopconsumerStatus: {stream.pubStatus.audioSlave.stopconsumerStatus}`);if(S.subConf.video)if(((E=this.adapterRef.permKeyInfo)===null||E===void 0?void 0:E.subVideoRight)===!1)this.logger.error("subscribe() permKey权限控制，没有权限订阅video"),this.adapterRef.instance.emit("error","no-subscribe-video-permission");else if(S.pubStatus.video.video&&!S.pubStatus.video.consumerId)if(I.ANY_CHROME_MAJOR_VERSION&&I.ANY_CHROME_MAJOR_VERSION<69)this.logger.log(`subscribe() 开始订阅 ${S.getId()} 视频流`);else{let j;this.logger.log(`subscribe() 开始订阅 ${S.getId()} 视频流`),j=S.subConf.highOrLow.video===s.STREAM_TYPE.LOW?0:1,await this.adapterRef._mediasoup.createConsumer(U,"video","video",S.pubStatus.video.producerId,j),this.logger.log(`subscribe() 订阅 ${S.getId()} 视频流完成`)}else this.logger.log("subscribe() stream.pubStatus.video: ",JSON.stringify(S.pubStatus.video));else S.pubStatus.video.consumerId&&S.pubStatus.video.stopconsumerStatus!=="start"?I.ANY_CHROME_MAJOR_VERSION&&I.ANY_CHROME_MAJOR_VERSION<69?this.logger.log(`subscribe() 开始取消订阅 ${S.getId()} 视频流`):(this.logger.log(`subscribe() 开始取消订阅 ${S.getId()} 视频流`),S.pubStatus.video.stopconsumerStatus="start",await((x=this.adapterRef._mediasoup)===null||x===void 0?void 0:x.destroyConsumer(S.pubStatus.video.consumerId,S,"video")),this.adapterRef.instance.removeSsrc(S.getId(),"video"),S.mediaHelper.updateStream("video",null),S.pubStatus.video.consumerId="",S.stop("video"),S.pubStatus.video.stopconsumerStatus="end",S.subStatus.video=!1,this.logger.log(`subscribe() 取消订阅 ${S.getId()} 视频流完成`)):this.logger.log(`subscribe() 开始取消订阅 ${S.getId()} video流, consumerId: ${S.pubStatus.video.consumerId}, stopconsumerStatus: {stream.pubStatus.video.stopconsumerStatus}`);if(S.subConf.screen){if(((D=this.adapterRef.permKeyInfo)===null||D===void 0?void 0:D.subVideoRight)===!1)this.logger.error("subscribe() permKey权限控制，没有权利订阅screen"),this.adapterRef.instance.emit("error","no-subscribe-screen-permission");else if(S.pubStatus.screen.screen&&!S.pubStatus.screen.consumerId)if(I.ANY_CHROME_MAJOR_VERSION&&I.ANY_CHROME_MAJOR_VERSION<69)this.logger.log(`subscribe() 开始订阅 ${S.getId()} 辅流`);else{let j;this.logger.log(`subscribe() 开始订阅 ${S.getId()} 辅流`),j=S.subConf.highOrLow.screen===s.STREAM_TYPE.LOW?0:1,await this.adapterRef._mediasoup.createConsumer(U,"video","screenShare",S.pubStatus.screen.producerId,j),this.logger.log(`subscribe() 订阅 ${S.getId()} 辅流完成`)}}else if(S.pubStatus.screen.consumerId&&S.pubStatus.screen.stopconsumerStatus!=="start")if(I.ANY_CHROME_MAJOR_VERSION&&I.ANY_CHROME_MAJOR_VERSION<69)this.logger.log(`subscribe() 开始取消订阅 ${S.getId()} 辅流`);else{this.logger.log(`subscribe() 开始取消订阅 ${S.getId()} 辅流`),S.pubStatus.screen.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(S.pubStatus.screen.consumerId,S,"screen"),this.adapterRef.instance.removeSsrc(S.getId(),"screen"),S.mediaHelper.updateStream("screen",null),S.pubStatus.screen.consumerId="",S.stop("screen"),S.pubStatus.screen.stopconsumerStatus="end",S.subStatus.screen=!1;const j=S.getId();j&&delete this.adapterRef.remoteScreenStats[j],this.logger.log(`subscribe() 取消订阅 ${S.getId()} 辅流完成`)}else this.logger.log(`subscribe() 开始取消订阅 ${S.getId()} screen流, consumerId: ${S.pubStatus.screen.consumerId}, stopconsumerStatus: {stream.pubStatus.screen.stopconsumerStatus}`);if(S.subConf.videoThird)if(((F=this.adapterRef.permKeyInfo)===null||F===void 0?void 0:F.subVideoRight)===!1)this.logger.error("subscribe() permKey权限控制，没有权限订阅videoThird"),this.adapterRef.instance.emit("error","no-subscribe-video-permission");else if(S.pubStatus.videoThird.videoThird&&!S.pubStatus.videoThird.consumerId)if(I.ANY_CHROME_MAJOR_VERSION&&I.ANY_CHROME_MAJOR_VERSION<69)this.logger.log(`subscribe() 开始订阅 ${S.getId()} 第三路视频流`);else{let j;this.logger.log(`subscribe() 开始订阅 ${S.getId()} 第三路视频流`),j=S.subConf.highOrLow.videoThird===s.STREAM_TYPE.LOW?0:1,await this.adapterRef._mediasoup.createConsumer(U,"video","videoThird",S.pubStatus.videoThird.producerId,j),this.logger.log(`subscribe() 订阅 ${S.getId()} 第三路视频流完成`)}else this.logger.log("subscribe() stream.pubStatus.videoThird: ",JSON.stringify(S.pubStatus.video));else S.pubStatus.videoThird.consumerId&&S.pubStatus.videoThird.stopconsumerStatus!=="start"?I.ANY_CHROME_MAJOR_VERSION&&I.ANY_CHROME_MAJOR_VERSION<69?this.logger.log(`subscribe() 开始取消订阅 ${S.getId()} 第三路视频流`):(this.logger.log(`subscribe() 开始取消订阅 ${S.getId()} 第三路视频流`),S.pubStatus.videoThird.stopconsumerStatus="start",await((V=this.adapterRef._mediasoup)===null||V===void 0?void 0:V.destroyConsumer(S.pubStatus.videoThird.consumerId,S,"videoThird")),this.adapterRef.instance.removeSsrc(S.getId(),"videoThird"),S.mediaHelper.updateStream("videoThird",null),S.pubStatus.videoThird.consumerId="",S.stop("videoThird"),S.pubStatus.videoThird.stopconsumerStatus="end",S.subStatus.videoThird=!1,this.logger.log(`subscribe() 取消订阅 ${S.getId()} 第三路视频流完成`)):this.logger.log(`subscribe() 开始取消第三路订阅 ${S.getId()} 视频流, consumerId: ${S.pubStatus.videoThird.consumerId}, stopconsumerStatus: {stream.pubStatus.videoThird.stopconsumerStatus}`);if(S.subConf.videoFourth)if(((N=this.adapterRef.permKeyInfo)===null||N===void 0?void 0:N.subVideoRight)===!1)this.logger.error("subscribe() permKey权限控制，没有权限订阅videoFourth"),this.adapterRef.instance.emit("error","no-subscribe-video-permission");else if(S.pubStatus.videoFourth.videoFourth&&!S.pubStatus.videoFourth.consumerId)if(I.ANY_CHROME_MAJOR_VERSION&&I.ANY_CHROME_MAJOR_VERSION<69)this.logger.log(`subscribe() 开始订阅 ${S.getId()} 第四路视频流`);else{let j;this.logger.log(`subscribe() 开始订阅 ${S.getId()} 第四路视频流`),j=S.subConf.highOrLow.videoFourth===s.STREAM_TYPE.LOW?0:1,await this.adapterRef._mediasoup.createConsumer(U,"video","videoFourth",S.pubStatus.videoFourth.producerId,j),this.logger.log(`subscribe() 订阅 ${S.getId()} 第四路视频流完成`)}else this.logger.log("subscribe() stream.pubStatus.videoFourth: ",JSON.stringify(S.pubStatus.video));else S.pubStatus.videoFourth.consumerId&&S.pubStatus.videoFourth.stopconsumerStatus!=="start"?I.ANY_CHROME_MAJOR_VERSION&&I.ANY_CHROME_MAJOR_VERSION<69?this.logger.log(`subscribe() 开始取消订阅 ${S.getId()} 第四路视频流`):(this.logger.log(`subscribe() 开始取消订阅 ${S.getId()} 第四路视频流`),S.pubStatus.videoFourth.stopconsumerStatus="start",await((L=this.adapterRef._mediasoup)===null||L===void 0?void 0:L.destroyConsumer(S.pubStatus.videoFourth.consumerId,S,"videoFourth")),this.adapterRef.instance.removeSsrc(S.getId(),"videoFourth"),S.mediaHelper.updateStream("videoFourth",null),S.pubStatus.videoFourth.consumerId="",S.stop("videoFourth"),S.pubStatus.videoFourth.stopconsumerStatus="end",S.subStatus.videoFourth=!1,this.logger.log(`subscribe() 取消订阅 ${S.getId()} 第四路视频流完成`)):this.logger.log(`subscribe() 开始取消订阅 ${S.getId()} 第四路视频流, consumerId: ${S.pubStatus.videoFourth.consumerId}, stopconsumerStatus: {stream.pubStatus.videoFourth.stopconsumerStatus}`);I.ANY_CHROME_MAJOR_VERSION&&I.ANY_CHROME_MAJOR_VERSION<69&&await this.adapterRef._mediasoup.createConsumer69(U,S,H,S.pubStatus),this.apiFrequencyControl({name:"subscribe",code:0,param:JSON.stringify({reason:"",subStatus:S.subStatus,subConf:S.subConf,pubStatus:S.pubStatus},null," ")})}catch(j){if(j==="resetConsumeRequestStatus")return void this.logger.warn("subscribe() API调用被打断");throw this.logger.error("subscribe() 内部错误: ",j.message),this.apiFrequencyControl({name:"subscribe",code:-1,param:JSON.stringify({reason:j.message,subStatus:S.subStatus,subConf:S.subConf,pubStatus:S.pubStatus},null," ")}),j.getCode?j:new O.default({code:v.default.UNKNOWN_TYPE_ERROR,message:`subscribe() 内部错误: ${j.name}, ${j.message}`})}}async unsubscribe(S,y){if(C.checkExists({tag:"client.unsubscribe:stream",value:S}),!y)return this.logger.log(`unsubscribe() [取消订阅远端: ${S.getId()}]`),this.doUnsubscribe(S);{C.checkValidObject({tag:"client.unsubscribe:unsubscribeOptions",value:y}),this.logger.log(`unsubscribe ${S.getId()} ${JSON.stringify(y)}`);const _={audio:S.subConf.audio,audioSlave:S.subConf.audioSlave,video:S.subConf.video,screen:S.subConf.screen,videoThird:S.subConf.videoThird,videoFourth:S.subConf.videoFourth};g.MediaTypeList.forEach(b=>{y[b]===!0&&(_[b]=!1)}),S.doSetSubscribeConfig(_),this.doSubscribe(S)}}async doUnsubscribe(S,y){if(!this.adapterRef._mediasoup){const _="unsubscribe() 媒体mediasoup模块缺失";throw this.logger.error(_),new O.default({code:v.default.UNKNOWN_TYPE_ERROR,message:_})}try{if((y===void 0||y==="audio")&&S.pubStatus.audio.consumerId&&S.pubStatus.audio.stopconsumerStatus!=="start"){this.logger.log(`unsubscribe() [开始取消订阅 ${S.getId()}] 的音频流`),S.pubStatus.audio.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(S.pubStatus.audio.consumerId,S,"audio"),this.adapterRef.instance.removeSsrc(S.getId(),"audio"),S.mediaHelper.updateStream("audio",null),S.pubStatus.audio.consumerId="",S.stop("audio"),S.pubStatus.audio.stopconsumerStatus="end",S.subStatus.audio=!1;const _=S.getId();_&&delete this.adapterRef.remoteAudioStats[_],this.logger.log(`unsubscribe() [取消订阅 ${S.getId()}] 的音频流完成`)}if((y===void 0||y==="audioSlave")&&S.pubStatus.audioSlave.consumerId&&S.pubStatus.audioSlave.stopconsumerStatus!=="start"){this.logger.log(`unsubscribe() [开始取消订阅 ${S.getId()}] 的音频辅流`),S.pubStatus.audioSlave.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(S.pubStatus.audioSlave.consumerId,S,"audioSlave"),this.adapterRef.instance.removeSsrc(S.getId(),"audioSlave"),S.mediaHelper.updateStream("audioSlave",null),S.pubStatus.audioSlave.consumerId="",S.stop("audioSlave"),S.pubStatus.audioSlave.stopconsumerStatus="end",S.subStatus.audioSlave=!1;const _=S.getId();_&&delete this.adapterRef.remoteAudioSlaveStats[_],this.logger.log(`unsubscribe() [取消订阅 ${S.getId()}] 的音频辅流完成`)}if((y===void 0||y==="video")&&S.pubStatus.video.consumerId&&S.pubStatus.video.stopconsumerStatus!=="start"&&(this.logger.log(`unsubscribe() [开始取消订阅 ${S.getId()}] 的视频流`),S.pubStatus.video.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(S.pubStatus.video.consumerId,S,"video"),this.adapterRef.instance.removeSsrc(S.getId(),"video"),S.mediaHelper.updateStream("video",null),S.pubStatus.video.consumerId="",S.stop("video"),S.pubStatus.video.stopconsumerStatus="end",S.subStatus.video=!1,S.getId(),this.logger.log(`unsubscribe() [取消订阅 ${S.getId()}] 的视频流完成`)),(y===void 0||y==="screen")&&S.pubStatus.screen.consumerId&&S.pubStatus.screen.stopconsumerStatus!=="start"){this.logger.log(`unsubscribe() [开始取消订阅 ${S.getId()}] 的视频辅流`),S.pubStatus.screen.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(S.pubStatus.screen.consumerId,S,"screen"),this.adapterRef.instance.removeSsrc(S.getId(),"screen"),S.mediaHelper.updateStream("screen",null),S.pubStatus.screen.consumerId="",S.stop("screen"),S.pubStatus.screen.stopconsumerStatus="end",S.subStatus.screen=!1;const _=S.getId();_&&delete this.adapterRef.remoteScreenStats[_],this.logger.log(`unsubscribe() [取消订阅 ${S.getId()}] 的视频辅流完成`)}(y===void 0||y==="videoThird")&&S.pubStatus.videoThird.consumerId&&S.pubStatus.videoThird.stopconsumerStatus!=="start"&&(this.logger.log(`unsubscribe() [开始取消订阅 ${S.getId()}] 的第三路视频流`),S.pubStatus.videoThird.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(S.pubStatus.videoThird.consumerId,S,"videoThird"),this.adapterRef.instance.removeSsrc(S.getId(),"videoThird"),S.mediaHelper.updateStream("videoThird",null),S.pubStatus.videoThird.consumerId="",S.stop("videoThird"),S.pubStatus.videoThird.stopconsumerStatus="end",S.subStatus.videoThird=!1,S.getId(),this.logger.log(`unsubscribe() [取消订阅 ${S.getId()}] 的第三路视频流完成`)),(y===void 0||y==="videoFourth")&&S.pubStatus.videoFourth.consumerId&&S.pubStatus.videoFourth.stopconsumerStatus!=="start"&&(this.logger.log(`unsubscribe() [开始取消订阅 ${S.getId()}] 的第四路视频流`),S.pubStatus.videoFourth.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(S.pubStatus.videoFourth.consumerId,S,"videoFourth"),this.adapterRef.instance.removeSsrc(S.getId(),"videoFourth"),S.mediaHelper.updateStream("videoFourth",null),S.pubStatus.videoFourth.consumerId="",S.stop("videoFourth"),S.pubStatus.videoFourth.stopconsumerStatus="end",S.subStatus.videoFourth=!1,S.getId(),this.logger.log(`unsubscribe() [取消订阅 ${S.getId()}] 的第四路视频流完成`)),this.apiFrequencyControl({name:"unsubscribe",code:0,param:JSON.stringify({clientUid:this.getUid(),streamId:S.stringStreamID,reason:"",subStatus:S.subStatus,subConf:S.subConf},null," ")})}catch(_){throw this.logger.error("unsubscribe() 内部错误:",_,_.name,_.message),this.apiFrequencyControl({name:"unsubscribe",code:-1,param:JSON.stringify({clientUid:this.getUid(),streamId:S.stringStreamID,reason:_.message,subStatus:S.subStatus,subConf:S.subConf},null," ")}),_.getCode?_:new O.default({code:v.default.UNKNOWN_TYPE_ERROR,message:`unsubscribe() 内部错误: ${_.name}, ${_.message}`})}}async setRemoteVideoStreamType(S,y){var _;this.logger.log(`setRemoteVideoStreamType() uid ${S.getId()} 订阅成员的${y?"小":"大"}流`,y);try{await((_=this.adapterRef._mediasoup)===null||_===void 0?void 0:_.setConsumerPreferredLayer(S,y?0:1,"video")),S.subConf.highOrLow.video=y,this.apiFrequencyControl({name:"setRemoteVideoStreamType",code:0,param:JSON.stringify({clientUid:this.getUid(),streamId:S.stringStreamID,highOrLow:y},null," ")})}catch(b){throw this.logger.error("setRemoteVideoStreamType() 内部错误: ",b.message),this.apiFrequencyControl({name:"setRemoteVideoStreamType",code:-1,param:JSON.stringify({clientUid:this.getUid(),streamId:S.stringStreamID,reason:b.message,highOrLow:y},null," ")}),b.getCode?b:new O.default({code:v.default.UNKNOWN_TYPE_ERROR,message:`setRemoteVideoStreamType() 内部错误: ${b.name}, ${b.message}`})}}async setRemoteStreamType(S,y,_){var b;this.logger.log(`setRemoteStreamType() 订阅${S.getId()}成员${y}媒体的${y?"小":"大"}流`);try{await((b=this.adapterRef._mediasoup)===null||b===void 0?void 0:b.setConsumerPreferredLayer(S,y?0:1,_)),S.subConf.highOrLow[_]=y,this.apiFrequencyControl({name:"setRemoteStreamType",code:0,param:{highOrLow:y,mediaType:_,clientUid:this.getUid(),streamID:S.stringStreamID}})}catch(E){throw this.logger.error("setRemoteStreamType() 内部错误: ",E.message),this.apiFrequencyControl({name:"setRemoteVideoStreamType",code:-1,param:JSON.stringify({reason:E.message,highOrLow:y,mediaType:_,streamID:S.stringStreamID},null," ")}),E.getCode?E:new O.default({code:v.default.UNKNOWN_TYPE_ERROR,message:"setRemoteStreamType() 内部错误: "+E.message})}}enableAudioVolumeIndicator(){this.logger.log("开启音量提醒")}enableDualStream(S={video:!0,screen:!1}){this.adapterRef.channelInfo.videoLow=S.video,this.adapterRef.channelInfo.screenLow=S.screen,this.logger.log("enableDualStream() 开启双流模式"),this.apiFrequencyControl({name:"enableDualStream",code:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",video:S.video,screen:S.screen,reason:""}})}disableDualStream(S={video:!1,screen:!1}){this.logger.log("disableDualStream() 关闭双流模式"),this.adapterRef.channelInfo.videoLow=!1,this.adapterRef.channelInfo.screenLow=!1,this.apiFrequencyControl({name:"disableDualStream",code:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",video:S.video,screen:S.screen,reason:""}})}setPlaybackVolume(S){let y,_;if(!Number.isInteger(S)||S<0||S>100)y=v.default.SET_AUDIO_VOLUME_ARGUMENTS_ERROR,_="setPlaybackVolume() volume 应该为 0 - 100 的整数";else{const b=S/100;this.logger.log(`setPlaybackVolume: ${this.adapterRef.nomalizedPlaybackVolume} => ${b} normalized`),this.adapterRef.nomalizedPlaybackVolume=b}if(this.apiFrequencyControl({name:"setPlaybackVolume",code:y?-1:0,param:{volume:S}}),y)throw this.logger.error(_),new O.default({code:y,message:_});for(let b in this.adapterRef.remoteStreamMap){const E=this.adapterRef.remoteStreamMap[b];E.active&&E._play.updatePlaybackVolume()}}async setClientRole(S){var y;let _,b=0,E="";if(S==="host"||S==="broadcaster"?_=0:S==="audience"?_=1:(E="setClientRole() 无法识别的角色："+S,this.logger.error(E),b=v.default.ROLE_TYPE_ERROR,_=-1),!b){const D=this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid||"";if(_===this._roleInfo.userRole)this.logger.warn(`setClientRole() 用户${D}的角色已经是${S}了`);else switch(this.adapterRef.connectState.curState){case"CONNECTED":_===1&&this.adapterRef.localStream&&this.isPublished(this.adapterRef.localStream)&&(this.logger.info(`setClientRole() 主播 ${D}将设为观众，自动unPublish中`),await this.unpublish(this.adapterRef.localStream));const F=await((y=this.adapterRef._mediasoup)===null||y===void 0?void 0:y.updateUserRole(_));F.code!==200?(b=F.code,E=F.errMsg):this._roleInfo.userRole!==_&&(this._roleInfo.userRole=_,this.logger.info(`setClientRole() 本地用户${D} 设置角色为 ${S}`),this.safeEmit("client-role-changed",{role:S}));break;case"DISCONNECTED":this._roleInfo.userRole!==_&&(this._roleInfo.userRole=_,this.logger.info(`setClientRole() 本地用户${D}设置角色为 ${S}`),this.safeEmit("client-role-changed",{role:S}));break;default:E=`setClientRole() 本地用户${D}当前不在频道中，可能是网络波动导致暂时断开连接`,this.logger.error(E),b=v.default.USER_NOT_IN_CHANNEL_ERROR}}const x={code:b,message:E,role:_};if(this.apiFrequencyControl({name:"setClientRole",code:b?-1:0,param:x}),b)throw new O.default({code:b,message:E})}bindLocalStream(S){this.adapterRef.localStream=S,S.client=this,S.logger.parent=this.logger;const y=this.getUid();y&&S.streamID!==y&&(this.logger.warn("localStream更换streamID",S.streamID,"=>",y),S.streamID=y,S.stringStreamID=y.toString())}getConnectionState(){return this.apiFrequencyControl({name:"getConnectionState",code:0,param:JSON.stringify({},null," ")}),this.adapterRef.connectState.curState}getSystemStats(){return navigator.getBattery?new Promise((S,y)=>{navigator.getBattery().then(function(_){S(100*_.level)})}):Promise.reject(new O.default({code:v.default.GET_SYSTEM_STATS_NOT_SUPPORT_ERROR,message:"getSystemStats() 浏览器不支持, 建议使用最新版的 Chrome 浏览器"}))}getSessionStats(){return new Promise((S,y)=>{this.adapterRef.sessionStats.Duration=(Date.now()-this.adapterRef.state.startSessionTime)/1e3,this.adapterRef.sessionStats.UserCount=Object.keys(this.adapterRef.memberMap).length+1,S(this.adapterRef.sessionStats)})}getTransportStats(){return new Promise((S,y)=>{S(this.adapterRef.transportStats)})}getLocalAudioStats(){var S,y;let _=[];return!((y=(S=this.adapterRef.localStream)===null||S===void 0?void 0:S.getSender("audio","high"))===null||y===void 0)&&y.track&&(_=_.concat(this.adapterRef.localAudioStats)),Promise.resolve(_)}getLocalAudioSlaveStats(){var S,y;let _=[];return!((y=(S=this.adapterRef.localStream)===null||S===void 0?void 0:S.getSender("audioSlave","high"))===null||y===void 0)&&y.track&&(_=_.concat(this.adapterRef.localAudioSlaveStats)),Promise.resolve(_)}getLocalVideoStats(S){var y,_,b,E;let x=[];return S&&S!=="video"||!((_=(y=this.adapterRef.localStream)===null||y===void 0?void 0:y.getSender("video","high"))===null||_===void 0)&&_.track&&(x=x.concat(this.adapterRef.localVideoStats)),S&&S!=="screen"||!((E=(b=this.adapterRef.localStream)===null||b===void 0?void 0:b.getSender("screen","high"))===null||E===void 0)&&E.track&&(x=x.concat(this.adapterRef.localScreenStats)),Promise.resolve(x)}getRemoteAudioStats(){return new Promise((S,y)=>{S(this.adapterRef.remoteAudioStats)})}getRemoteAudioSlaveStats(){return new Promise((S,y)=>{S(this.adapterRef.remoteAudioSlaveStats)})}getRemoteVideoStats(S){let y={};return S&&S!=="screen"||(y=Object.assign(y,this.adapterRef.remoteScreenStats)),S&&S!=="video"||(y=Object.assign(y,this.adapterRef.remoteVideoStats)),Promise.resolve(y)}setChannelProfile(S){const y=(S==null?void 0:S.mode)||null;let _,b;if(this.logger.log("setChannelProfile, options: ",JSON.stringify(S,null," ")),y!=="rtc"&&y!=="live"&&(b="setChannelProfile: 参数格式错误",_=v.default.SET_CHANNEL_PROFILE_INVALID_PARAMETER_ERROR,this.logger.warn(b)),this.adapterRef.connectState.curState!=="DISCONNECTED"?(b="setChannelProfile() 请在加入房间之前调用",_=v.default.API_CALL_SEQUENCE_BEFORE_ERROR,this.logger.warn(b)):(this.adapterRef.localStream&&(y==="live"?this.adapterRef.localStream.audioProfile="music_standard":y==="rtc"&&(this.adapterRef.localStream.audioProfile="speech_low_quality")),this._params.mode=y),this.apiFrequencyControl({name:"setChannelProfile",code:_?-1:0,param:{mode:JSON.stringify(S,null," "),reason:_,message:b}}),_)throw new O.default({code:_,message:b})}async updatePermKey(S){var y;try{this.logger.log("updatePermKey() permKey: "+S),this.adapterRef.channelInfo.permKey=S,await((y=this.adapterRef._signalling)===null||y===void 0?void 0:y.updatePermKey(S)),this.adapterRef.instance.apiFrequencyControl({name:"updatePermKey",code:0,param:{permKey:S}})}catch(_){throw this.adapterRef.instance.apiFrequencyControl({name:"updatePermKey",code:_.code,param:{permKey:S,reason:_.message}}),_}}async addTasks(S){var y;const{rtmpTasks:_=[]}=S;let b,E;if(this.logger.log("addTasks() 增加互动直播推流任务, options: ",JSON.stringify(S)),_&&Array.isArray(_)&&_.length?this._roleInfo.userRole===1?(E="addTasks() 观众角色不允许进行添加推流任务",b=v.default.TASKS_ROLE_ERROR):this.adapterRef._meetings||(E="addTasks() 加入房间后进行添加推流任务",b=v.default.API_CALL_SEQUENCE_AFTER_ERROR):(E="addTasks() 参数格式错误, rtmpTasks为空, 或者该数组长度为空",b=v.default.ADD_TASK_PARAMETER_ERROR),b)throw this.logger.error(E),this.adapterRef.instance.apiFrequencyControl({name:"addTasks",code:-1,param:{clientUid:this.getUid(),reason:b,message:E}}),new O.default({code:b,message:E});try{await((y=this.adapterRef._meetings)===null||y===void 0?void 0:y.addTasks(S)),this.adapterRef.instance.apiFrequencyControl({name:"addTasks",code:0,param:{lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),clientUid:this.getUid()}})}catch(x){throw this.adapterRef.instance.apiFrequencyControl({name:"addTasks",code:-1,param:{clientUid:this.getUid(),lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),message:x.message}}),x}}async deleteTasks(S){var y;const{taskIds:_=[]}=S;let b,E;if(this.logger.log("deleteTasks() 删除互动直播推流任务, options: ",S),_&&Array.isArray(_)&&_.length?this._roleInfo.userRole===1?(E="deleteTasks() 观众角色不允许删除推流任务",b=v.default.TASKS_ROLE_ERROR):this.adapterRef._meetings||(E="deleteTasks() 加入房间后才能删除推流任务",b=v.default.API_CALL_SEQUENCE_AFTER_ERROR):(E="deleteTasks() 参数格式错误, taskIds为空, 或者该数组长度为空",b=v.default.DELETE_TASK_PARAMETER_ERROR),b)throw this.logger.error(E),this.adapterRef.instance.apiFrequencyControl({name:"deleteTasks",code:-1,param:{clientUid:this.getUid(),reason:b,message:E}}),new O.default({code:b,message:E});try{await((y=this.adapterRef._meetings)===null||y===void 0?void 0:y.deleteTasks(S)),this.adapterRef.instance.apiFrequencyControl({name:"deleteTasks",code:0,param:{lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),clientUid:this.getUid()}})}catch(x){throw this.adapterRef.instance.apiFrequencyControl({name:"deleteTasks",code:-1,param:{clientUid:this.getUid(),lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),reason:x.message}}),x}}async updateTasks(S){var y;const{rtmpTasks:_=[]}=S;let b,E;if(this.logger.log("updateTasks() 更新互动直播推流任务, options: ",S),_&&Array.isArray(_)&&_.length?this._roleInfo.userRole===1?(E="updateTasks() 观众角色不允许进行添加推流任务",b=v.default.TASKS_ROLE_ERROR):this.adapterRef._meetings||(E="updateTasks() 加入房间后进行添加推流任务",b=v.default.API_CALL_SEQUENCE_AFTER_ERROR):(E="updateTasks() 参数格式错误, rtmpTasks为空, 或者该数组长度为空",b=v.default.UPDATE_TASK_PARAMETER_ERROR),b)throw this.logger.error(E),this.adapterRef.instance.apiFrequencyControl({name:"updateTasks",code:-1,param:{clientUid:this.getUid(),reason:b,message:E}}),new O.default({code:b,message:E});try{await((y=this.adapterRef._meetings)===null||y===void 0?void 0:y.updateTasks(S)),this.adapterRef.instance.apiFrequencyControl({name:"onUpdateTasks",code:0,param:{clientUid:this.getUid(),lbsAddrs:this.adapterRef.lbsManager.getReportField("call")}})}catch(x){throw this.adapterRef.instance.apiFrequencyControl({name:"onUpdateTasks",code:-1,param:{clientUid:this.getUid(),lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),reason:x.message}}),x}}refreshRemoteEvents(){for(let S in this.adapterRef.remoteStreamMap){const y=this.adapterRef.remoteStreamMap[S];this.logger.warn("refreshRemoteEvents peer-online",S),this.safeEmit("peer-online",{uid:S}),g.MediaTypeList.forEach(_=>{y.pubStatus[_].producerId&&(this.logger.warn("refreshRemoteEvents stream-added",S,_),this.safeEmit("stream-added",{stream:y,mediaType:_}),y.muteStatus[_].send&&(this.logger.warn("refreshRemoteEvents mute-"+_,S,_),this.safeEmit("mute-"+_,{uid:y.getId()})))})}}initSpatialManager(S){if(!this.spatialManager){const y=m.getAudioContext();if(!y)return void this.logger.error("当前环境不支持WebAudio");this.spatialManager=new R.SpatialManager({client:this,options:S,context:y})}this.spatialManager.init(),this.spatialManager.play()}syncUserList(){return this.adapterRef.memberMap}updateRecordingAudioStream(){if(!this.recordManager||!this.recordManager.formatMedia||!this.recordManager.formatMedia.destination)return;this.logger.log("updateRecordingAudioStream() [更新录制的音频]");const S=[];if(this.adapterRef.remoteStreamMap)for(var y in this.adapterRef.remoteStreamMap){const _=this.adapterRef.remoteStreamMap[y];S.push(_.mediaHelper.audio.audioStream)}this.adapterRef.localStream&&S.push(this.adapterRef.localStream.mediaHelper.audio.audioStream),this.recordManager.formatMedia.updateStream(S)}async startMediaRecording(S){var y;const{recorder:_,recordConfig:b}=S;this.recordManager.record||(this.recordManager.record=new f.Record({logger:this.logger,client:this.adapterRef.instance}),this.recordManager.record.on("media-recording-stopped",N=>{this.safeEmit("@media-recording-stopped")})),this.recordManager.formatMedia||(this.recordManager.formatMedia=new h.FormatMedia({adapterRef:this.adapterRef}));const E=[];if(!((y=this.adapterRef.localStream)===null||y===void 0)&&y.mediaHelper.audio.audioStream.active&&E.push(this.adapterRef.localStream.mediaHelper.audio.audioStream),_==="all"&&this.adapterRef.remoteStreamMap)for(var x in this.adapterRef.remoteStreamMap){const N=this.adapterRef.remoteStreamMap[x];N.mediaHelper.audio.audioStream.active&&E.push(N.mediaHelper.audio.audioStream)}const D=await this.recordManager.formatMedia.formatAudio(E),F=await this.recordManager.formatMedia.formatVideo(_,b),V=[];if(V.push(F),E.length>0&&V.push(D),V.length!==0)return this.recordManager.record.start({uid:"",type:(b==null?void 0:b.recordType)||"video",recordName:b==null?void 0:b.recordName,reset:!0,stream:V});this.logger.log("没有没发现要录制的媒体流")}stopMediaRecording(S){if(!this.recordManager.record)throw new O.default({code:v.default.RECORDING_NOT_START_ERROR,message:"stopMediaRecording() 录制未开始"});return this.recordManager.record.stop({})}cleanMediaRecording(){if(!this.recordManager.record)throw new O.default({code:v.default.RECORDING_NOT_START_ERROR,message:"stopMediaRecording() 录制未开始"});return this.recordManager.record.clean()}downloadMediaRecording(){if(!this.recordManager.record)throw new O.default({code:v.default.RECORDING_NOT_START_ERROR,message:"stopMediaRecording() 录制未开始"});return this.recordManager.record.download()}async startAsrCaptions(S="AUTO",y=""){var _;const b=this.getUid();if(!b)return this.logger.error("startAsrCaptions() 开启实时字幕失败: uid为空"),!1;this.logger.log("startAsrCaptions() 开启实时字幕: ",b,y);try{const E=await((_=this.adapterRef._mediasoup)===null||_===void 0?void 0:_.startAsrCaptions(S,y));return E&&(this.logger.log("startAsrCaptions() 开启字幕成功: ",b,y),this.adapterRef.asrCaptionConfig={enable:!0,source:"AUTO",target:y}),this.apiFrequencyControl({name:"startAsrCaptions",code:0,param:{uid:b,result:E,sourceLang:"AUTO",targetLang:y}}),E}catch(E){return this.logger.error("startAsrCaptions() 异常: ",E.name,E.message),this.apiFrequencyControl({name:"startAsrCaptions",code:-1,param:{uid:b,reason:E.message}}),!1}}async stopAsrCaptions(){var S;const y=this.getUid();if(!y)return this.logger.warn("stopAsrCaptions() 关闭实时字幕失败: uid为空"),!1;this.logger.log("stopAsrCaptions() 关闭实时字幕: ",y);try{const _=await((S=this.adapterRef._mediasoup)===null||S===void 0?void 0:S.stopAsrCaptions());return _&&(this.logger.log("stopAsrCaptions() 关闭实时字幕: ",y),this.adapterRef.asrCaptionConfig.enable=!1),this.apiFrequencyControl({name:"stopAsrCaptions",code:0,param:{uid:y}}),_}catch(_){return this.logger.error("stopAsrCaptions() 异常: ",_.name,_.message),this.apiFrequencyControl({name:"stopAsrCaptions",code:-1,param:{uid:y,reason:_.message}}),!1}}getAudioOutputDevice(){return this.outputDeviceId}setCodecType(S){if(this.logger.log("setCodecType() 设置编解码格式: ",S),!S)return this.logger.log("setCodecType() codecType为空，自动选择编解码格式"),void(this.adapterRef.mediaCapability.forceCodec=!1);S==="VP8"||S==="H264"?this.adapterRef.mediaCapability.forceCodec=S:this.logger.error("setCodecType() 参数错误: ",S)}async aiManualInterrupt(S){var y;if(this.logger.log("aiManualInterrupt() 开始  dstUid: ",S),S&&S!==0&&S!=="0"){if(!this.adapterRef.remoteStreamMap[S])return this.logger.warn("aiManualInterrupt() 无法获取到远端流: ",S),!1}else{const _=this.adapterRef.remoteStreamMap[Object.keys(this.adapterRef.remoteStreamMap)[0]];if(!_)return this.logger.warn("aiManualInterrupt() 无法获取到远端流"),!1;S=_.getId()}this.logger.log("aiManualInterrupt() dstUid: ",S);try{const _=await((y=this.adapterRef._mediasoup)===null||y===void 0?void 0:y.setMpsNotify(1,{dstUid:S}));_&&this.logger.log("aiManualInterrupt() 成功: ",S),this.apiFrequencyControl({name:"aiManualInterrupt",code:0,param:{dstUid:S,result:_}})}catch(_){this.logger.error("aiManualInterrupt() 异常: ",_.name,_.message),this.apiFrequencyControl({name:"aiManualInterrupt",code:-1,param:{dstUid:S,reason:_.message}})}}_onVisibilityChange(){var S,y,_,b,E,x,D,F;if(document.visibilityState==="hidden")this.logger.warn("document.visibilityState: hidden");else{this.logger.log("document.visibilityState: visible");const V={video:{muted:(y=(S=this.adapterRef.localStream)===null||S===void 0?void 0:S.getVideoTrack())===null||y===void 0?void 0:y.muted},audio:{muted:(b=(_=this.adapterRef.localStream)===null||_===void 0?void 0:_.getAudioTrack())===null||b===void 0?void 0:b.muted},screen:{muted:(x=(E=this.adapterRef.localStream)===null||E===void 0?void 0:E.getScreenTrack())===null||x===void 0?void 0:x.muted},screenAudio:{muted:(F=(D=this.adapterRef.localStream)===null||D===void 0?void 0:D.getAudioSlaveTrack())===null||F===void 0?void 0:F.muted}};this.safeEmit("local-track-state",V)}this.apiEventReport("setFunction",{name:"visibilitychange",oper:"1",value:document.visibilityState})}async destroy(){this.logger&&this.logger.warn("清除 Client 实例中"),this.leave(0);const S=await this.operationQueue.enqueue({caller:this,method:"destroy",options:null});this.operationQueue.destroy(),this._reset(),this.destroyed=!0,S()}}e.Client=M},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.ENV=e.TAGS_TO_MAIN_DOMAIN=e.LBS_REGION_CONFIG=e.Config=void 0,e.Config={lbsUrl:"https://wecan-lbs.netease.im/api/v1/web_domains",checkSumUrl:"https://nrtc.netease.im/demo/getChecksum.action",createChannelUrl:"https://nrtc.netease.im/nrtc/createChannel.action",getChannelInfoUrl:"https://nrtc.netease.im/nrtc/getChannelInfos.action",roomsTaskUrl:"https://roomserver.netease.im/v2/sdk/rooms/",getCloudProxyInfoUrl:"https://ap-prd-jd.netease.im/v1/g2/getCloudProxyInfo"},e.LBS_REGION_CONFIG={GLOBAL:{cloudProxy:["ap-prd-jd.netease.im"],lbs:["wecan-lbs.netease.im","wecan-lbs.yunxinvcloud.com"],nrtc:["nrtc.netease.im","wecan-gw.yunxinvcloud.com"],call:["roomserver.netease.im","wecan-sdk.yunxinvcloud.com"],tracking:["statistic.live.126.net","apm.yunxinhi.com"]},OVERSEAS:{cloudProxy:["supervisor-overseas.yunxinvcloud.com"],lbs:["lbs-overseas.yunxinvcloud.com"],nrtc:["nrtc-overseas.yunxinvcloud.com"],call:["call-overseas.yunxinvcloud.com"],tracking:["statistic-overseas.yunxinfw.com"]}},e.TAGS_TO_MAIN_DOMAIN={cloudProxy:"ap-prd-jd.netease.im",lbs:"wecan-lbs.netease.im",nrtc:"nrtc.netease.im",call:"roomserver.netease.im",tracking:"statistic.live.126.net"},e.ENV="production"},function(t,e,r){function i(a,l,n,c){for(var s=l*a.sampleRate,d=s+(l-2*n)*a.sampleRate,u=a.createBuffer(1,d,a.sampleRate),h=u.getChannelData(0),o=0;o<s;++o)h[o]=c?(s-o)/d:o/s;for(o=s;o<d;++o)h[o]=0;return u}Object.defineProperty(e,"__esModule",{value:!0}),e.crossfade=e.Jungle=void 0,e.Jungle=class{constructor(a){this.connected=!1,this.context=a;var l=a.createGain(),n=a.createGain();this.input=l,this.output=n;var c=a.createBufferSource(),s=a.createBufferSource(),d=a.createBufferSource(),u=a.createBufferSource();this.shiftDownBuffer=i(a,.1,.05,!1),this.shiftUpBuffer=i(a,.1,.05,!0),c.buffer=this.shiftDownBuffer,s.buffer=this.shiftDownBuffer,d.buffer=this.shiftUpBuffer,u.buffer=this.shiftUpBuffer,c.loop=!0,s.loop=!0,d.loop=!0,u.loop=!0;var h=a.createGain(),o=a.createGain(),f=a.createGain();f.gain.value=0;var m=a.createGain();m.gain.value=0,c.connect(h),s.connect(o),d.connect(f),u.connect(m);var g=a.createGain(),v=a.createGain(),O=a.createDelay(),T=a.createDelay();h.connect(g),o.connect(v),f.connect(g),m.connect(v),g.connect(O.delayTime),v.connect(T.delayTime);var C=a.createBufferSource(),A=a.createBufferSource(),R=function(P,S,y){for(var _=S*P.sampleRate,b=_+(S-2*y)*P.sampleRate,E=P.createBuffer(1,b,P.sampleRate),x=E.getChannelData(0),D=y*P.sampleRate,F=D,V=_-D,N=0;N<_;++N){var L;L=N<F?Math.sqrt(N/D):N>=V?Math.sqrt(1-(N-V)/D):1,x[N]=L}for(N=_;N<b;++N)x[N]=0;return E}(a,.1,.05);C.buffer=R,A.buffer=R,C.loop=!0,A.loop=!0;var w=a.createGain(),k=a.createGain();w.gain.value=0,k.gain.value=0,C.connect(w.gain),A.connect(k.gain),l.connect(O),l.connect(T),O.connect(w),T.connect(k),w.connect(n),k.connect(n);var I=a.currentTime+.05,M=I+.1-.05;c.start(I),s.start(M),d.start(I),u.start(M),C.start(I),A.start(M),this.mod1=c,this.mod2=s,this.mod1Gain=h,this.mod2Gain=o,this.mod3Gain=f,this.mod4Gain=m,this.modGain1=g,this.modGain2=v,this.fade1=C,this.fade2=A,this.mix1=w,this.mix2=k,this.delay1=O,this.delay2=T,this.setDelay(.1)}setDelay(a){this.modGain1.gain.setTargetAtTime(.5*a,0,.01),this.modGain2.gain.setTargetAtTime(.5*a,0,.01)}setPitchOffset(a){a>0?(this.mod1Gain.gain.value=0,this.mod2Gain.gain.value=0,this.mod3Gain.gain.value=1,this.mod4Gain.gain.value=1):(this.mod1Gain.gain.value=1,this.mod2Gain.gain.value=1,this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0),this.setDelay(.1*Math.abs(a))}},e.crossfade=function(a,l,n){var c=Math.cos(.5*a*Math.PI),s=Math.cos(.5*(1-a)*Math.PI);l&&(l.gain.value=c),n&&(n.gain.value=s)}},function(t,e){var r,i;r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i={rotl:function(a,l){return a<<l|a>>>32-l},rotr:function(a,l){return a<<32-l|a>>>l},endian:function(a){if(a.constructor==Number)return 16711935&i.rotl(a,8)|4278255360&i.rotl(a,24);for(var l=0;l<a.length;l++)a[l]=i.endian(a[l]);return a},randomBytes:function(a){for(var l=[];a>0;a--)l.push(Math.floor(256*Math.random()));return l},bytesToWords:function(a){for(var l=[],n=0,c=0;n<a.length;n++,c+=8)l[c>>>5]|=a[n]<<24-c%32;return l},wordsToBytes:function(a){for(var l=[],n=0;n<32*a.length;n+=8)l.push(a[n>>>5]>>>24-n%32&255);return l},bytesToHex:function(a){for(var l=[],n=0;n<a.length;n++)l.push((a[n]>>>4).toString(16)),l.push((15&a[n]).toString(16));return l.join("")},hexToBytes:function(a){for(var l=[],n=0;n<a.length;n+=2)l.push(parseInt(a.substr(n,2),16));return l},bytesToBase64:function(a){for(var l=[],n=0;n<a.length;n+=3)for(var c=a[n]<<16|a[n+1]<<8|a[n+2],s=0;s<4;s++)8*n+6*s<=8*a.length?l.push(r.charAt(c>>>6*(3-s)&63)):l.push("=");return l.join("")},base64ToBytes:function(a){a=a.replace(/[^A-Z0-9+\/]/gi,"");for(var l=[],n=0,c=0;n<a.length;c=++n%4)c!=0&&l.push((r.indexOf(a.charAt(n-1))&Math.pow(2,-2*c+8)-1)<<2*c|r.indexOf(a.charAt(n))>>>6-2*c);return l}},t.exports=i},function(t,e){function r(i){return!!i.constructor&&typeof i.constructor.isBuffer=="function"&&i.constructor.isBuffer(i)}/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */t.exports=function(i){return i!=null&&(r(i)||function(a){return typeof a.readFloatLE=="function"&&typeof a.slice=="function"&&r(a.slice(0,0))}(i)||!!i._isBuffer)}},function(t,e,r){var i=this&&this.__importDefault||function(d){return d&&d.__esModule?d:{default:d}};Object.defineProperty(e,"__esModule",{value:!0}),e.FormatMedia=void 0;const a=r(3),l=i(r(6)),n=i(r(8)),c=r(85);class s extends a.EventEmitter{constructor(u){super(),this.adapterRef=u.adapterRef,this.logger=u.adapterRef.logger,this.audioContext=null,this.destination=null,this.audioStreams=[],this.canvas=null,this.canvasContext=null,this.canvasTimer=null}async formatAudio(u){this.logger.log("formatAudio() [混音: ]",u);try{return this.audioContext||(this.audioContext=new window.AudioContext),this.destination=this.audioContext.createMediaStreamDestination(),await this.initAudioIn(u),this.destination.stream}catch(h){return this.logger.error("formatAudio() 异常: ",h.name,h.message),Promise.reject(new n.default({code:l.default.RECORDING_NOT_SUPPORT,message:h.message||"formatAudio() 浏览器不支持"}))}}initAudioIn(u){if(this.audioContext&&this.destination){for(var h=0;h<u.length;h++){const o=u[h].getAudioTracks()[0];if((o==null?void 0:o.readyState)!=="live")continue;const f=this.audioContext.createMediaStreamSource(u[h]);f.connect(this.destination),this.audioStreams.push(f)}this.logger.log(`initAudioIn() [初始化音频 state: ${this.audioContext.state}]`),this.audioContext.state!=="running"&&this.audioContext.resume().then(()=>{this.audioContext&&this.logger.log(`initAudioIn(): [audioContext 状态变更成功 state: ${this.audioContext.state}]`)}).catch(o=>{this.logger.warn(`initAudioIn(): [audioContext 状态变更发生错误, errorName: ${o.name}, erroMessage: ${o.message}]`),this.audioContext&&this.audioContext.resume()})}else this.logger.error("initAudioIn:参数不够")}async updateStream(u){this.logger.log("updateStream() [更新混频的音频数据: ]",u),this.audioStreams.forEach(h=>{h.disconnect(0)}),this.audioStreams.length=0,this.initAudioIn(u)}stopFormatAudio(){this.logger.log("stopFormatAudio() [结束混音]"),this.audioStreams.forEach(u=>{u.disconnect(0)}),this.audioContext&&this.audioContext.close(),this.audioContext=null,this.destination=null}async formatVideo(u,h){this.logger.log("formatVideo() 混频 recorder: ",u,"recordConfig: ",h);let o=640,f=360;const m=(h==null?void 0:h.recordVideoFrame)||15;switch(h==null?void 0:h.recordVideoQuality){case 360:o=640,f=360;break;case 480:o=640,f=480;break;case 720:o=1280,f=720}this.canvas||(this.canvas=document.createElement("canvas"),this.canvasContext=c.get2DContext(this.canvas)),this.canvas.width=o,this.canvas.height=f,this.canvasTimer&&(clearInterval(this.canvasTimer),this.canvasTimer=null);const g=Math.floor(o/2),v=Math.floor(f/2),O=Math.floor(o/3),T=Math.floor(f/3);return this.canvasContext&&(this.canvasContext.fillStyle="black",this.canvasContext.fillRect(0,0,o,f)),this.canvasTimer&&clearInterval(this.canvasTimer),this.canvasTimer=setInterval(()=>{var C,A,R;this.canvasContext&&(this.canvasContext.fillStyle="black",this.canvasContext.fillRect(0,0,o,f));let w=[];if((h==null?void 0:h.recordType)==="video"&&(!((C=this.adapterRef.localStream)===null||C===void 0)&&C._play.video.dom&&w.push(this.adapterRef.localStream._play.video.dom),!((A=this.adapterRef.localStream)===null||A===void 0)&&A._play.screen.dom&&w.push((R=this.adapterRef.localStream)===null||R===void 0?void 0:R._play.screen.dom),u==="all"&&this.adapterRef.remoteStreamMap))for(var k in this.adapterRef.remoteStreamMap){const I=this.adapterRef.remoteStreamMap[k];I._play.video.dom&&w.push(I._play.video.dom),I._play.screen.dom&&w.push(I._play.screen.dom)}switch(w.length>9&&(w=w.filter(I=>I.readyState===4)),w.length){case 0:break;case 1:this.drawSingleVideo(w[0],0,0,o,f);break;case 2:this.drawSingleVideo(w[0],0,0,g,f),this.drawSingleVideo(w[1],g,0,g,f);break;case 3:case 4:this.drawSingleVideo(w[0],0,0,g,v),this.drawSingleVideo(w[1],g,0,g,v),this.drawSingleVideo(w[2],0,v,g,v),this.drawSingleVideo(w[3],g,v,g,v);break;default:this.drawSingleVideo(w[0],0,0,O,T),this.drawSingleVideo(w[1],O,0,O,T),this.drawSingleVideo(w[2],2*O,0,O,T),this.drawSingleVideo(w[3],0,T,O,T),this.drawSingleVideo(w[4],O,T,O,T),this.drawSingleVideo(w[5],2*O,T,O,T),this.drawSingleVideo(w[6],0,2*T,O,T),this.drawSingleVideo(w[7],O,2*T,O,T),this.drawSingleVideo(w[8],2*O,2*T,O,T)}},Math.floor(1e3/m)),this.canvas.captureStream()}drawSingleVideo(u,h,o,f,m){var g;if(!u)return;const v=Math.min(f/u.videoWidth,m/u.videoHeight);let O=u.videoWidth*v,T=u.videoHeight*v,C=h+(f-O)/2,A=o+(m-T)/2;(g=this.canvasContext)===null||g===void 0||g.drawImage(u,C,A,O,T)}async stopFormatVideo(){this.logger.log("stopFormatAudio() [结束混频]"),this.canvasTimer&&(clearInterval(this.canvasTimer),this.canvasTimer=null),this.canvasContext=this.canvas=null}destroy(){this.logger.log("destroy()"),this.stopFormatAudio(),this.stopFormatVideo()}}e.FormatMedia=s},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.OperationQueue=void 0;let i=!1;e.OperationQueue=class{constructor(a){this.cnt=0,this.current=null,this.history=null,this.queue=[],this.logger=a.getChild(()=>{let l="oper";return this.current?l+=` ${this.current.args.method}#${this.current.id}`:this.history&&(l+=` ${this.history.args.method}#${this.history.id} FINISHED`),this.queue.forEach(n=>{l+=`|${n.args.method}#${n.id}`}),l}),this.operationQueueTimer=setInterval(()=>{if(this.current&&Date.now()-this.current.enqueueTs>5e3){if(this.queue.length){const l=this.queue[0];this.logger.error(`当前操作已执行了${Date.now()-this.current.enqueueTs}ms，放开锁限制：${this.current.args.method}#${this.current.id}。即将进行下一个操作：${l.args.method}#${l.id}`)}else this.logger.log(`当前操作已执行了${Date.now()-this.current.enqueueTs}ms，放开锁限制：${this.current.args.method}#${this.current.id}`);this.current.status="timeout",this.history=this.current,this.current=null,this.fire("timer")}},5e3)}enqueue(a){var l,n;if(!i){const c=a.caller;c.clientId>-1&&c.clientId==((n=(l=c.adapterRef)===null||l===void 0?void 0:l.instance)===null||n===void 0?void 0:n.clientId)&&c!==c.adapterRef.instance&&(c.logger.warn("侦测到该次调用的this不指向原生Client对象。请避免使用Proxy或bind等方式篡改SDK调用主体 Client:"+a.method),i=!0)}return new Promise((c,s)=>{this.queue.push({id:++this.cnt,enqueueTs:Date.now(),args:a,resolve:c,reject:s,status:"pending"}),this.current?this.logger.log(`操作等位中，目前有其他操作。前面还有${this.queue.length}位：${a.method}#${this.cnt}。`):this.fire("instant")})}fire(a){var l;if(!this.current){const n=this.queue.shift();if(n){if(!((l=n.args.caller)===null||l===void 0)&&l.destroyed)return this.logger.error(`无法执行操作：${n.args.method}: 对象已被销毁，请重新创建对象`),void this.fire("functionEnd");this.history=this.current,this.current=n,this.current.status="live",a==="instant"?this.logger.log("开始执行操作："+n.args.method):this.logger.log(`开始执行队列中的操作：${n.args.method}#${n.id}，等待时间：${Date.now()-n.enqueueTs}ms。`),n.startTs=Date.now(),n.resolve(()=>{this.current===n?(this.current.status="finished",this.history=this.current,this.current=null,this.logger.log(`执行操作结束：${n.args.method}。花费 ${n.startTs?Date.now()-n.startTs:null}ms`),this.fire("functionEnd")):n.status==="timeout"?this.logger.log(`执行操作结束：${n.args.method}。花费 ${n.startTs?Date.now()-n.startTs:null}ms。该操作超时，但未阻塞执行队列。`):this.logger.error(`操作收到多次返回：${n.args.method}#${n.id}。花费 ${n.startTs?Date.now()-n.startTs:null}ms`)})}}}destroy(){clearInterval(this.operationQueueTimer),this.queue=[],this.current=null,this.history=null}}},function(t,e,r){var i=this&&this.__importDefault||function(y){return y&&y.__esModule?y:{default:y}};Object.defineProperty(e,"__esModule",{value:!0}),e.Base=void 0;const a=r(145),l=r(218),n=r(220),c=r(256),s=r(1),d=r(177),u=r(258),h=r(281),o=r(48),f=i(r(6)),m=i(r(8)),g=r(304),v=i(r(203)),O=r(43),T=r(28),C=r(146),A=r(305),R=r(46),w=r(84),k=r(42),I=r(306),M=r(307);let P=0;class S extends R.RTCEventEmitter{constructor(_){super(),this.transportRebuildCnt=0,this.timeLast=Date.now(),this._params={appkey:"",mode:"rtc"},this.isReport=typeof _.report!="boolean"||_.report,this.clientId=P++,this.adapterRef={datareportCache:[],channelInfo:{customData:"",sessionConfig:{}},apiEvent:{},apiEvents:{},requestId:{},instance:this,preferRemb:!1,deviceId:"",asrCaptionConfig:{enable:!1,source:"CH",target:"CH"}};const b=s.getParameters().forceLogLevel;b!==-1?v.default.setLogLevel(b):_.debug===!0?v.default.setLogLevel(w.loglevels.DEBUG):_.debug===!1&&s.getParameters().logLevel<=w.loglevels.WARNING&&v.default.setLogLevel(w.loglevels.WARNING),this.logger=new T.Logger({tagGen:()=>{let E="client"+(this.clientId||"");const x=this.getUid();return x&&(E+="#"+x),this.adapterRef.connectState.curState!=="CONNECTED"&&(E+=" "+this.adapterRef.connectState.curState),this.destroyed&&(E+=" DESTROYED"),E}}),this.adapterRef.logger=this.logger,this.recordManager={record:null,formatMedia:null},this._reset(),this.adapterRef.encryption=new a.Encryption(this.adapterRef),this.adapterRef.audioMixer=new M.AudioMixer(this.adapterRef),_.debug&&(s.getParameters().debugG2=!0),this.sdkRef=_.ref}_reset(){this.sdkRef=null,this.adapterRef={datareportCache:[],audioAsl:{enabled:"unknown",aslActiveNum:-1},uid2SscrList:{},netStatusTimer:null,networkQuality:{},_statsReport:null,_meetings:null,state:void 0,mediaCapability:void 0,instance:this,lbsManager:void 0,channelInfo:{customData:"",sessionConfig:{}},apiEvent:{},memberMap:{},apiEvents:{},transportStats:{txRtt:-1,rxRtt:-1,NetworkType:"unknown",OutgoingAvailableBandwidth:-1},sessionStats:void 0,remoteAudioStats:{},remoteAudioSlaveStats:{},remoteVideoStats:{},remoteScreenStats:{},remoteStreamMap:{},localStream:null,localAudioStats:{},localAudioSlaveStats:{},localVideoStats:[],localScreenStats:[],logger:this.logger,logStorage:void 0,channelStatus:"init",_signalling:null,connectState:{prevState:"DISCONNECTED",curState:"DISCONNECTED",reconnect:!1},_mediasoup:null,mediaHelpers:{},netStatusList:[],requestId:{},deviceId:"",preferRemb:!1,nomalizedPlaybackVolume:1,userPriority:{priority:100,preemtiveMode:!1},proxyServer:{enable:!1,type:3},encryption:void 0,signalProbeManager:void 0,isAudioBanned:!1,isVideoBanned:!1,permKeyInfo:void 0,asrCaptionConfig:{enable:!1,source:"CH",target:"CH"},audioMixer:null,enableMixAudio:!1},this.adapterRef.mediaCapability=new l.MediaCapability(this.adapterRef),this.adapterRef.encryption=new a.Encryption(this.adapterRef),this.adapterRef.signalProbeManager=new I.SignalProbeManager(this.adapterRef),this._resetState(),this.adapterRef.lbsManager=new A.LBSManager(this),this._destroyModule()}_getSupportedCodecs(){return O.getSupportedCodecs(...arguments)}initMode(){this.adapterRef._meetings||(this.adapterRef._meetings=new c.Meeting({sdkRef:this.sdkRef,adapterRef:this.adapterRef})),this.adapterRef._signalling||(this.adapterRef._signalling=new h.Signalling({adapterRef:this.adapterRef,logger:this.logger})),this.adapterRef._mediasoup||(this.adapterRef._mediasoup=new n.Mediasoup({adapterRef:this.adapterRef,logger:this.logger})),this.adapterRef._statsReport||(this.adapterRef._statsReport=new u.StatsReport({sdkRef:this.sdkRef,adapterRef:this.adapterRef,isReport:this.isReport}))}_destroyModule(){this.adapterRef._meetings&&(this.adapterRef._meetings.destroy(),this.adapterRef._meetings=null),this.adapterRef._signalling&&(this.adapterRef._signalling.destroy(),this.adapterRef._signalling=null),this.adapterRef._mediasoup&&(this.adapterRef._mediasoup.destroy(),this.adapterRef._mediasoup=null),this.recordManager.formatMedia&&(this.recordManager.formatMedia.destroy(),this.recordManager.formatMedia=null),this.recordManager.record&&(this.recordManager.record.destroy(),this.recordManager.record=null),this.adapterRef.signalProbeManager.stop()}_resetState(){this._params.neRtcServerAddresses={},this.adapterRef.channelStatus="init",this.adapterRef.connectState={prevState:"DISCONNECTED",curState:"DISCONNECTED",reconnect:!1},this.adapterRef.networkQuality={},this.adapterRef.localStream=null,this.adapterRef.memberMap={},this.adapterRef.remoteStreamMap={},this.adapterRef.netStatusList=[],this.adapterRef.netStatusTimer&&(clearInterval(this.adapterRef.netStatusTimer),this.adapterRef.netStatusTimer=null),this.adapterRef.uid2SscrList={},this.adapterRef.proxyServer={enable:!1,type:3},this.adapterRef.state={lastDeviceStatus:{audio:{type:null,device:null},video:{type:null,device:null}},audioDeviceHasOpened:!1,videoDeviceHasOpened:!1,chromeScreenShareOpened:!1,startSessionTime:0,endSessionTime:0,startPubVideoTime:0,startPubScreenTime:0,getChannelInfoTime:0,signalEstablishTime:0,signalOpenTime:0,signalJoinResTime:0,signalJoinSuccessTime:0,getChannelInfoRtt:0,signalWebsocketOpenRtt:0,signalJoinMsgRtt:0,signalAudioAddedTime:0,signalAudioSubscribedTime:0,signalVideoAddedTime:0,signalVideoSubscribedTime:0,iceRecvConnectedTime:0,domVideoAppendTime:0,videoFirstIframeTime:0,videoResizeTime:0},Object.assign(this.adapterRef,{transportStats:{NetworkType:"unknown",OutgoingAvailableBandwidth:0,txRtt:0,rxRtt:0},sessionStats:{Duration:0,RecvBitrate:0,RecvBytes:0,SendBitrate:0,SendBytes:0,UserCount:0},localAudioStats:[],localAudioSlaveStats:[],localVideoStats:[],localScreenStats:[],remoteAudioStats:{},remoteAudioSlaveStats:{},remoteVideoStats:{},remoteScreenStats:{}})}setSessionConfig(_={}){this.adapterRef.channelInfo||(this.adapterRef.channelInfo={}),this.adapterRef.channelInfo.sessionConfig||(this.adapterRef.channelInfo.sessionConfig={}),this.adapterRef.channelInfo.sessionConfig=Object.assign(this.adapterRef.channelInfo.sessionConfig,_)}resetChannel(){this.adapterRef.networkQuality={},this.adapterRef.netStatusList=[];for(let _ in this.adapterRef.remoteStreamMap){const b=this.adapterRef.remoteStreamMap[_];b.active&&(b.active=!1,b.stop(),b.clearRemotePubStatus(),s.getParameters().peerLeaveEventOnReconnect&&this.adapterRef.instance.safeEmit("peer-leave",{uid:_,reason:g.peerLeaveReasonCode.LEAVE_FOR_RECONNECT}))}this.adapterRef.memberMap={},this.adapterRef.uid2SscrList={},this.adapterRef._mediasoup&&this.adapterRef._mediasoup.destroy()}async startSession(_=0){_===0?this.logger.log("join() 开始音视频会话"):this.logger.log(`join() 开始音视频会话：第${_}次`);let{wssArr:b,cid:E}=this.adapterRef.channelInfo;if(!b||b.length===0)throw this.logger.error("join() 没有找到服务器地址 : "+JSON.stringify(this.adapterRef.channelInfo)),this.adapterRef.channelStatus="leave",new m.default({code:f.default.JOIN_FAILED,message:"join() 没有找到媒体服务器地址"});if(!E)throw this.logger.error("join() 服务器没有分配cid"),new m.default({code:f.default.JOIN_FAILED,message:"join() 服务器没有分配cid"});if(this.logger.log(`join() 开始连接服务器: ${this.adapterRef.channelInfo.wssArrIndex}, url: ${b[this.adapterRef.channelInfo.wssArrIndex]}`),this.adapterRef.channelInfo.wssArrIndex>=b.length)throw this.logger.error("join() 所有的服务器地址都连接失败"),new m.default({code:f.default.NETWORK_ERROR,message:"所有的服务器地址都连接失败"});if(!this.adapterRef._signalling)throw new m.default({code:f.default.UNKNOWN_TYPE_ERROR,message:"startSession: 信令模块缺失"});try{await this.adapterRef._signalling.init(!1,!1)}catch(D){throw this.adapterRef.channelStatus="leave",D}const x=b[this.adapterRef.channelInfo.wssArrIndex];b.splice(this.adapterRef.channelInfo.wssArrIndex,1),b.unshift(x),this.adapterRef.channelInfo.wssArrIndex=0,this.adapterRef._statsReport&&this.adapterRef._statsReport.start()}stopSession(){this.logger.log("开始清除音视频会话"),this._destroyModule();const _=s.getParameters().localStreams.filter(b=>b.client.clientId===this.clientId&&!b.destroyed);_.length&&(s.getParameters().keepLocalstreamOnLeave?this.logger.log("当前模式下离开频道不会销毁localStream"):(this.logger.log(`即将销毁${_.length}个localStream`),_.forEach(b=>{b.destroy()}))),Object.values(this.adapterRef.remoteStreamMap).forEach(b=>{b.destroy()}),this.adapterRef.remoteStreamMap={},this.adapterRef.memberMap={},this.adapterRef.uid2SscrList={},this._resetState(),this.adapterRef._statsReport&&(this.adapterRef._statsReport.destroy(),this.adapterRef._statsReport=null)}async clearMember(_,b){var E;this.logger.log(`${_}离开房间, reason: ${b}`);const x=this.adapterRef.remoteStreamMap[_];if(x!=null&&x.active){for(let D of o.MediaTypeList)x.pubStatus[D].producerId&&this.adapterRef.instance.safeEmit("stream-removed",{stream:x,mediaType:D,reason:"onPeerLeave"});delete this.adapterRef.remoteStreamMap[_],delete this.adapterRef.memberMap[_],delete this.adapterRef.remoteAudioStats[_],delete this.adapterRef.remoteAudioSlaveStats[_],delete this.adapterRef.remoteVideoStats[_],delete this.adapterRef.remoteScreenStats[_];for(let D of o.MediaTypeList)x.pubStatus[D].consumerId&&await((E=this.adapterRef._mediasoup)===null||E===void 0?void 0:E.destroyConsumer(x.pubStatus[D].consumerId,x,D));x.active=!1,x.destroy()}this.adapterRef.netStatusList=this.adapterRef.netStatusList.filter((D,F,V)=>D.uid!==_),this.logger.log(_+" 离开房间 通知用户"),this.adapterRef.instance.safeEmit("peer-leave",{uid:_,reason:b})}setStartSessionTime(){this.adapterRef.state.startSessionTime=Date.now();const _=k.generateUUID(),b=this.adapterRef.channelInfo.channelName||"",E=this.adapterRef.channelInfo.uid||0,x=Date.now(),D=C(_+b+E+x+"");this.adapterRef.deviceId=k.randomString(D,16)}setEndSessionTime(){if(!this.adapterRef.state.startSessionTime)return void this.logger.log("AbstractAdapter: setEndSessionTime: startSessionTime为空");this.adapterRef.state.endSessionTime=Date.now();const _=this.adapterRef.state.endSessionTime-this.adapterRef.state.startSessionTime;this.adapterRef.instance.safeEmit("@sessionDuration",_),this.adapterRef.state.startSessionTime=0,this.adapterRef.state.endSessionTime=0}async reBuildRecvTransport(){if(this.transportRebuildCnt++,this.transportRebuildCnt>=s.getParameters().maxTransportRebuildCnt)return void this.logger.error("reBuildRecvTransport 达到最大重连次数："+this.transportRebuildCnt);if(this.logger.warn("下行通道异常，重新建立 #"+this.transportRebuildCnt),!this.adapterRef._mediasoup)return;this.adapterRef.instance.safeEmit("@pairing-reBuildRecvTransport-start"),this.adapterRef._mediasoup._recvTransport&&(this.adapterRef._mediasoup._recvTransport.close(),this.adapterRef._mediasoup._recvTransport=null),this.adapterRef._mediasoup.init(),this.logger.log("下行通道异常, remoteStreamMap",Object.keys(this.adapterRef.remoteStreamMap)),this.logger.log("this._eventQueue: ",this.adapterRef._mediasoup._eventQueue);let _=!1;for(const b in this.adapterRef.remoteStreamMap){const E=this.adapterRef.remoteStreamMap[b];if(E){E.pubStatus.audio.consumerStatus="init",E.pubStatus.video.consumerStatus="init",E.pubStatus.screen.consumerStatus="init",E.pubStatus.audio.consumerId="",E.pubStatus.video.consumerId="",E.pubStatus.screen.consumerId="",this.logger.log("重连逻辑订阅 start：",E.stringStreamID);try{await this.doSubscribe(E)}catch(x){this.logger.error("重连逻辑订阅 error: ",x,x.name,x.message),_=!0,this.adapterRef.instance.safeEmit("@pairing-reBuildRecvTransport-error");break}this.logger.log("重连逻辑订阅 over: ",E.stringStreamID)}}_||this.adapterRef.instance.safeEmit("@pairing-reBuildRecvTransport-success")}apiFrequencyControl(_){if(s.getParameters().disableAllReports)return;const{name:b,code:E,param:x}=_;if(!b)return;this.adapterRef.apiEvent[b]||(this.adapterRef.apiEvent[b]=[],this.adapterRef.apiEvents[b]=[],this.adapterRef.requestId[b]=0);let D=this.adapterRef.channelInfo.clientNtpTime-this.adapterRef.channelInfo.T4;D>0||(D=0);let F=Date.now()+D;if(F<=this.timeLast&&(F=this.timeLast+1),this.timeLast=F,this.adapterRef.apiEvent[b].length<10)this.adapterRef.apiEvent[b].push({cid:this.adapterRef.channelInfo&&this.adapterRef.channelInfo.cid,uid:this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid,code:E,name:b,time:F,param:x,request_id:this.adapterRef.requestId[b]++});else{if(!this.adapterRef.apiEvent||!this.adapterRef.apiEvent[b]||!this.adapterRef.apiEvent[b].length)return;this.adapterRef.apiEvent[b][0].time,Date.now()-this.adapterRef.apiEvent[b][0].time<1e4?this.adapterRef.requestId[b]++:(this.adapterRef.apiEvents[b]=this.adapterRef.apiEvents[b].concat(this.adapterRef.apiEvent[b]),this.adapterRef.apiEvent[b]=[])}}apiEventReport(_,b){if(!_||s.getParameters().disableAllReports)return;let E=new d.DataReport({adapterRef:this.adapterRef,sdkRef:this.sdkRef});E[_](Object.assign({uid:""+this.adapterRef.channelInfo.uid,cid:""+this.adapterRef.channelInfo.cid,time:Date.now()},b)),this.adapterRef.channelInfo.cid&&this.adapterRef.channelInfo.uid?E.send():(this.adapterRef.datareportCache.push({func:_,datareport:E}),this.adapterRef.datareportCache.length>20&&this.adapterRef.datareportCache.shift())}eventCacheReport(){new d.DataReport({adapterRef:this.adapterRef,sdkRef:this.sdkRef}).sendCacheEvent()}getUidAndKindBySsrc(_){var b,E;const x=["high","low"];for(let D of o.MediaTypeList)for(let F of x)if(((E=(b=this.adapterRef._mediasoup)===null||b===void 0?void 0:b.senderEncodingParameter[D][F])===null||E===void 0?void 0:E.ssrc)===_)return{uid:0,kind:D,streamType:F};for(let D in this.adapterRef.uid2SscrList){if(this.adapterRef.uid2SscrList[D].audio.ssrc==_)return{uid:D,kind:"audio",streamType:"high"};if(this.adapterRef.uid2SscrList[D].audioSlave.ssrc==_)return{uid:D,kind:"audioSlave",streamType:"high"};if(this.adapterRef.uid2SscrList[D].video&&this.adapterRef.uid2SscrList[D].video.ssrc==_)return{uid:D,kind:"video",streamType:"high"};if(this.adapterRef.uid2SscrList[D].screen&&this.adapterRef.uid2SscrList[D].screen.ssrc==_)return{uid:D,kind:"screen",streamType:"high"};if(this.adapterRef.uid2SscrList[D].videoThird&&this.adapterRef.uid2SscrList[D].videoThird.ssrc==_)return{uid:D,kind:"videoThird",streamType:"high"};if(this.adapterRef.uid2SscrList[D].videoFourth&&this.adapterRef.uid2SscrList[D].videoFourth.ssrc==_)return{uid:D,kind:"videoFourth",streamType:"high"}}return{uid:0,kind:"",streamType:"high"}}getSsrcByUidAndKind(_,b){return this.adapterRef.uid2SscrList[_]&&this.adapterRef.uid2SscrList[_][b]}addSsrc(_,b,E){this.adapterRef.uid2SscrList[_]||(this.adapterRef.uid2SscrList[_]={audio:{ssrc:0},audioSlave:{ssrc:0},video:{ssrc:0},screen:{ssrc:0},videoThird:{ssrc:0},videoFourth:{ssrc:0}}),this.adapterRef.uid2SscrList[_][b]?this.adapterRef.uid2SscrList[_][b].ssrc=E:this.adapterRef.uid2SscrList[_][b]={ssrc:E}}removeSsrc(_,b){this.adapterRef.uid2SscrList[_]&&(b?this.adapterRef.uid2SscrList[_][b]&&(this.adapterRef.uid2SscrList[_][b].ssrc=0):delete this.adapterRef.uid2SscrList[_])}isPublished(_){var b;return _&&((b=this.adapterRef.localStream)===null||b===void 0?void 0:b.localStreamId)===_.localStreamId&&(_.audio&&_.pubStatus.audio.audio||_.video&&_.pubStatus.video.video||_.screen&&_.pubStatus.screen.screen)}getPeer(_){return this.adapterRef._mediasoup?_=="send"?this.adapterRef._mediasoup._sendTransport&&this.adapterRef._mediasoup._sendTransport.handler._pc:_=="recv"?this.adapterRef._mediasoup._recvTransport&&this.adapterRef._mediasoup._recvTransport.handler._pc:null:null}destroy(){this.logger.log("base: destroy!"),this._reset()}}e.Base=S},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.MediaCapability=void 0;const i=r(219),a=r(43),l=r(1);e.MediaCapability=class{constructor(n){this.logger=n.logger.getChild(()=>{let c="codec"+this.room.videoCodecType.join(",");return this.supportedCodecSend&&this.supportedCodecSend.length===2&&this.supportedCodecRecv&&this.supportedCodecRecv.length===2||(c+=`/${this.supportedCodecSend}/${this.supportedCodecRecv}`),c}),this.supportedCodecRecv=null,this.supportedCodecSend=null,this.preferredCodecSend={video:["H264","VP8"],screen:["H264","VP8"]},this.forceCodec=!1,this.room={videoCodecType:[]}}async detect(){const n=Date.now();let c=await a.getSupportedCodecs("recv")||{video:[]},s=await a.getSupportedCodecs("send")||{video:[]};if(l.getParameters().h264Wait){if(c.video.indexOf("H264")===-1)for(this.logger.warn(`当前浏览器不支持H264解码。这可能会触发频道内编码协商。最多等待 ${l.getParameters().h264Wait} 毫秒以避免编码器尚未加载。`);Date.now()-n<l.getParameters().h264Wait;){if(c=await a.getSupportedCodecs("recv")||{video:[],audio:["OPUS"]},c.video.indexOf("H264")!==-1){this.logger.log(`H264解码器加载完成！用时 ${Date.now()-n} 毫秒`);break}await new Promise(d=>{setTimeout(d,100)})}c.video.indexOf("H264")===-1&&this.logger.warn("H264解码器加载失败！")}if(this.supportedCodecRecv=c.video,this.supportedCodecSend=s.video,l.getParameters().disableH264Send){let d=this.supportedCodecSend.indexOf("H264");d!==-1&&(this.logger.log("根据私有化参数设置，忽略H264发送支持"),this.supportedCodecSend.splice(d,1))}if(l.getParameters().disableVP8Send){let d=this.supportedCodecSend.indexOf("VP8");d!==-1&&(this.logger.log("根据私有化参数设置，忽略VP8发送支持"),this.supportedCodecSend.splice(d,1))}this.logger.log("detect supportedCodecRecv",JSON.stringify(this.supportedCodecRecv),"supportedCodecSend",JSON.stringify(this.supportedCodecSend),"Preferred codec:",JSON.stringify(this.preferredCodecSend))}getCodecCapability(){if(this.forceCodec==="H264"||this.forceCodec==="VP8")return this.logger.log("getCodecCapability: forceCodec ",this.forceCodec),[this.forceCodec];if(this.supportedCodecRecv&&this.supportedCodecSend){const n=[];for(let c of a.VideoCodecList)this.supportedCodecRecv.indexOf(c)>-1&&this.supportedCodecSend.indexOf(c)>-1&&n.push(c);return n}return this.logger.error("getCodecCapability: call detect first"),[]}stringify(){let n={256:[]};for(let c of this.getCodecCapability())i.VideoCodecStr2Int[c]>-1?n[256].push(i.VideoCodecStr2Int[c]):this.logger.error("MediaCapability:Unknown VideoCodecStr2Int",c);return n[256].length===0&&this.logger.warn("MediaCapability:No Local Suitable codec available"),JSON.stringify(n)}getCodecSend(n,c){var s,d;let u={codecName:null},h={codecName:null};for(let o=0;o<this.preferredCodecSend[n].length;o++){const f=this.preferredCodecSend[n][o];if(c.codecs||!c.codecs.length)for(let m=0;m<c.codecs.length;m++){const g=c.codecs[m];l.getParameters().disableH264Send&&((s=g.mimeType)===null||s===void 0?void 0:s.toLowerCase().indexOf("h264"))>-1||l.getParameters().disableVP8Send&&((d=g.mimeType)===null||d===void 0?void 0:d.toLowerCase().indexOf("vp8"))>-1||g.mimeType&&g.mimeType.toLowerCase().indexOf(f.toLowerCase())>-1&&(this.room.videoCodecType.indexOf(f)>-1?u.codecName||(u={codecParam:g,codecName:f}):h.codecName||(h={codecParam:g,codecName:f}))}}return u.codecName?(this.logger.log("MediaCapability：发送的Codec为:",u.codecName,JSON.stringify(u.codecParam)),u):(this.logger.warn("MediaCapability：未找到合适的发送Codec。发送的Codec使用:",h.codecName,h.codecParam),h)}parseRoom(n){if(!n.mediaCapabilitySet)return;const c=JSON.parse(n.mediaCapabilitySet);if(c[256]){const s=this.room.videoCodecType;this.room.videoCodecType=[];for(const d of c[256]){let u=i.VideoCodecInt2Str[d];u?this.room.videoCodecType.push(u):this.logger.error("Unknown Video Codec Type",d,n)}s.length?this.logger.log("Room videoCodecType发生变更。new:",this.room.videoCodecType,"old:",s):this.logger.log("Room videoCodecType:",JSON.stringify(this.room.videoCodecType))}}}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.VideoCodecStr2Int=e.VideoCodecInt2Str=e.SignalChannelMode=void 0,function(i){i[i.CHANNEL_MODE_P2P=1]="CHANNEL_MODE_P2P",i[i.CHANNEL_MODE_MEETING=2]="CHANNEL_MODE_MEETING",i[i.CHANNEL_MODE_1V1=3]="CHANNEL_MODE_1V1"}(e.SignalChannelMode||(e.SignalChannelMode={})),e.VideoCodecStr2Int={H264:0,H265:1,VP8:2,NEVC:3},e.VideoCodecInt2Str={0:"H264",1:"H265",2:"VP8",3:"NEVC"}},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(k,I,M,P){P===void 0&&(P=M),Object.defineProperty(k,P,{enumerable:!0,get:function(){return I[M]}})}:function(k,I,M,P){P===void 0&&(P=M),k[P]=I[M]}),a=this&&this.__setModuleDefault||(Object.create?function(k,I){Object.defineProperty(k,"default",{enumerable:!0,value:I})}:function(k,I){k.default=I}),l=this&&this.__importStar||function(k){if(k&&k.__esModule)return k;var I={};if(k!=null)for(var M in k)M!=="default"&&Object.prototype.hasOwnProperty.call(k,M)&&i(I,k,M);return a(I,k),I},n=this&&this.__importDefault||function(k){return k&&k.__esModule?k:{default:k}};Object.defineProperty(e,"__esModule",{value:!0}),e.Mediasoup=void 0;const c=r(3),s=r(48),d=n(r(6)),u=n(r(8)),h=l(r(7)),o=r(221),f=l(r(167)),m=r(1),g=r(244),v=r(7),O=r(81),T=r(140),C=r(89);let A=0;const R=new Map([["audio",["_recvTransportMainAudio","_recvTransportMainAudioTimeoutTimer"]],["video",["_recvTransportMainVideo","_recvTransportMainVideoTimeoutTimer"]],["audioSlave",["_recvTransportSubAudioSlave","_recvTransportSubAudioSlaveTimeoutTimer"]],["screen",["_recvTransportSubScreen","_recvTransportSubScreenTimeoutTimer"]]]);class w extends c.EventEmitter{constructor(I){super(),this._consumers={},this._timeout=6e4,this._edgeRtpCapabilities=null,this._mediasoupDevice=null,this._audioSlaveProducer=null,this._audioSlaveProducerId=null,this._micProducer=null,this._micProducerId=null,this._webcamProducer=null,this._webcamProducerId=null,this._screenProducer=null,this._screenProducerId=null,this._webcamProducerCodec=null,this._screenProducerCodec=null,this._sendTransport=null,this._recvTransport=null,this._sendTransportTimeoutTimer=null,this._recvTransportTimeoutTimer=null,this._eventQueue=[],this._eventQueueData=[],this._protoo=null,this.mediasoupId=A++,this._usedUidMediaTypes={},this.consumerMap=new Map,this.remoteRecvParams={},this.senderEncodingParameter={ssrcList:[],audio:{high:null,low:null},audioSlave:{high:null,low:null},video:{high:null,low:null},screen:{high:null,low:null},videoThird:{high:null,low:null},videoFourth:{high:null,low:null}},this.unsupportedProducers={},this.iceStatusHistory={send:{promises:[],status:{ts:0,info:""}},recv:{promises:[],status:{ts:0,info:""}}},this.adapterRef=I.adapterRef,this.logger=I.logger,this.loggerSend=I.logger.getChild(()=>{var M,P;let S="MediaSend";if(this._sendTransport)if(!((M=this._sendTransport._handler)===null||M===void 0)&&M._pc){const y=this._sendTransport._handler._pc;y.connectionState&&y.connectionState!=="connected"&&(S+=" "+y.connectionState),y.signalingState!=="stable"&&(S+=" "+y.signalingState)}else S+=" NOTRANSPORT";else S+=" UNINIT";return((P=this.adapterRef._mediasoup)===null||P===void 0?void 0:P.mediasoupId)!==this.mediasoupId&&(S+=" DETACHED"),S}),this.loggerRecv=I.logger.getChild(()=>{var M,P;let S="MediaRecv";if(this._recvTransport)if(!((M=this._recvTransport._handler)===null||M===void 0)&&M._pc){const y=this._recvTransport._handler._pc;y.connectionState&&y.connectionState!=="connected"&&(S+=" "+y.connectionState),y.signalingState!=="stable"&&(S+=" "+y.signalingState)}else S+=" NOTRANSPORT";else S+=" UNINIT";return((P=this.adapterRef._mediasoup)===null||P===void 0?void 0:P.mediasoupId)!==this.mediasoupId&&(S+=" DETACHED"),S}),this._reset()}get consumers(){return this._consumers}_reset(){this._edgeRtpCapabilities=null,this._mediasoupDevice=null,this._micProducer=null,this._audioSlaveProducer=null,this._micProducerId=null,this._webcamProducer=null,this._webcamProducerId=null,this._screenProducer=null,this._screenProducerId=null,this._consumers={},this._sendTransportTimeoutTimer&&clearTimeout(this._sendTransportTimeoutTimer),this._sendTransportTimeoutTimer=null,this._recvTransportTimeoutTimer&&clearTimeout(this._recvTransportTimeoutTimer),this._recvTransportTimeoutTimer=null,this._sendTransport&&this._sendTransport.close(),this._sendTransport=null,this._recvTransport&&this._recvTransport.close(),this._recvTransport=null,this.resetConsumeRequestStatus()}async resetRecvTransport(){this.logger.log("[Subscribe] resetRecvTransport() 重新创建下行传输通道"),this._consumers={},this._recvTransportTimeoutTimer&&clearTimeout(this._recvTransportTimeoutTimer),this._recvTransportTimeoutTimer=null,this._recvTransport&&this._recvTransport.close(),this._recvTransport=null;let I=[],M="all";if(this.adapterRef.channelInfo.relaytoken&&this.adapterRef.channelInfo.relayaddrs&&(this.adapterRef.channelInfo.relayaddrs.forEach(P=>{I.push({urls:"turn:"+P+"?transport=udp",credential:this.adapterRef.proxyServer.credential||this.adapterRef.channelInfo.uid+"/"+this.adapterRef.channelInfo.cid,username:this.adapterRef.channelInfo.relaytoken},{urls:"turn:"+P+"?transport=tcp",credential:this.adapterRef.proxyServer.credential||this.adapterRef.channelInfo.uid+"/"+this.adapterRef.channelInfo.cid,username:this.adapterRef.channelInfo.relaytoken})}),h.IS_FIREFOX||(M="relay")),!this._recvTransport&&this._mediasoupDevice){const P=this._mediasoupDevice.createRecvTransport({id:this.adapterRef.channelInfo.uid,iceParameters:void 0,iceCandidates:void 0,dtlsParameters:void 0,sctpParameters:void 0,iceServers:I,iceTransportPolicy:M,appData:{cid:this.adapterRef.channelInfo.cid,uid:this.adapterRef.channelInfo.uid,encodedInsertableStreams:this.adapterRef.encryption.encodedInsertableStreams}});this._recvTransport=P,P.on("connectionstatechange",this._recvTransportConnectionstatechange.bind(this,P)),P.handler._pc.addEventListener("iceconnectionstatechange",()=>{this.getIceStatus("recv")})}}async init(I=[]){this.logger.log("init() 初始化 devices、transport"),this._mediasoupDevice||(this._mediasoupDevice=new f.Device,this._mediasoupDevice&&await this._mediasoupDevice.load({routerRtpCapabilities:this._edgeRtpCapabilities}));let M=[],P="all";if(this.adapterRef.channelInfo.relaytoken&&this.adapterRef.channelInfo.relayaddrs?(this.adapterRef.channelInfo.relayaddrs.forEach(S=>{M.push({urls:"turn:"+S+"?transport=udp",credential:this.adapterRef.proxyServer.credential||this.adapterRef.channelInfo.uid+"/"+this.adapterRef.channelInfo.cid,username:this.adapterRef.channelInfo.relaytoken},{urls:"turn:"+S+"?transport=tcp",credential:this.adapterRef.proxyServer.credential||this.adapterRef.channelInfo.uid+"/"+this.adapterRef.channelInfo.cid,username:this.adapterRef.channelInfo.relaytoken})}),h.IS_FIREFOX||(P="relay")):I.length&&(this.logger.log("init() 初始化 stunServers: ",I),M=I),M.length&&this.logger.log("iceTransportPolicy ",P," iceServers ",O.JSONBigStringify(M)),!this._sendTransport&&this._mediasoupDevice&&(this._sendTransport=this._mediasoupDevice.createSendTransport({id:this.adapterRef.channelInfo.uid,iceParameters:void 0,iceCandidates:void 0,dtlsParameters:void 0,sctpParameters:void 0,iceServers:M,iceTransportPolicy:P,appData:{cid:this.adapterRef.channelInfo.cid,uid:this.adapterRef.channelInfo.uid,encodedInsertableStreams:this.adapterRef.encryption.encodedInsertableStreams}}),this.senderEncodingParameter={ssrcList:[],audioSlave:{high:null,low:null},audio:{high:null,low:null},video:{high:null,low:null},screen:{high:null,low:null},videoThird:{high:null,low:null},videoFourth:{high:null,low:null}},this._sendTransport.on("connectionstatechange",this._sendTransportConnectionstatechange.bind(this,this._sendTransport)),this._sendTransport.handler._pc.addEventListener("iceconnectionstatechange",()=>{this.getIceStatus("send")})),!(h.ANY_CHROME_MAJOR_VERSION&&h.ANY_CHROME_MAJOR_VERSION<69)&&!this._recvTransport&&this._mediasoupDevice){const S=this._mediasoupDevice.createRecvTransport({id:this.adapterRef.channelInfo.uid,iceParameters:void 0,iceCandidates:void 0,dtlsParameters:void 0,sctpParameters:void 0,iceServers:M,iceTransportPolicy:P,appData:{cid:this.adapterRef.channelInfo.cid,uid:this.adapterRef.channelInfo.uid,encodedInsertableStreams:this.adapterRef.encryption.encodedInsertableStreams}});this._recvTransport=S,S.on("connectionstatechange",this._recvTransportConnectionstatechange.bind(this,S)),S.handler._pc.addEventListener("iceconnectionstatechange",()=>{this.getIceStatus("recv")})}this.emit("transportReady")}async _sendTransportConnectionstatechange(I,M){if(this._sendTransport&&!this._sendTransport.closed)if(this._sendTransport.idx===I.idx)if(this.loggerSend.log(`send connection #${I._handler._pc.pcid} state  changed to ${M}`),this.emit("upstream-state-change",{connectionState:M}),M==="failed")try{this._sendTransport&&(this._sendTransportTimeoutTimer||(this._sendTransportTimeoutTimer=setTimeout(()=>{this._reconnectTransportConnectTimeout()},this._timeout))),this._sendTransportConnectTimeout()}catch(P){this.loggerSend.error("reconnectSendTransportConnect() | failed:",P.name,P.message)}else M==="connected"&&this._sendTransportTimeoutTimer&&(clearTimeout(this._sendTransportTimeoutTimer),this._sendTransportTimeoutTimer=null);else this.loggerSend.warn(`_sendTransportConnectionstatechange：出现了_sendTransport绑定不一致的状况:${I.id}/${I.idx}=>${this._sendTransport.id}/${this._sendTransport.idx}`)}async _recvTransportConnectionstatechange(I,M){if(this._recvTransport&&!this._recvTransport.closed)if(this._recvTransport.idx===I.idx)if(this.loggerRecv.log(`recv connection ${I._handler._pc.pcid} state changed to ${M}`),this.emit("downstream-state-change",{connectionState:M}),M==="failed"){try{this._recvTransport&&(this._recvTransportTimeoutTimer||(this._recvTransportTimeoutTimer=setTimeout(()=>{this._reconnectTransportConnectTimeout()},this._timeout)))}catch(P){this.loggerRecv.error("reconnectRecvTransportConnect() | failed:",P.name,P.message)}this._recvTransportConnectTimeout()}else M==="connected"&&this._recvTransportTimeoutTimer&&(clearTimeout(this._recvTransportTimeoutTimer),this._recvTransportTimeoutTimer=null);else this.loggerRecv.warn(`_recvTransportConnectionstatechange：出现了_recvTransport绑定不一致的状况:${I.id}/${I.idx}=>${this._recvTransport.id}/${this._recvTransport.idx}`)}async _recvTransportConnectionstatechange69(I,M,P){let S=P.target.iceConnectionState;if(this.loggerRecv.log(`recv69 connection ${I._handler._pc.pcid} state changed to ${S}`),this.emit("downstream-state-change",{connectionState:S}),S==="failed"){try{I&&(M||(M=setTimeout(()=>{this._reconnectTransportConnectTimeout()},this._timeout)))}catch(y){this.loggerRecv.error("reconnectRecvTransportConnect() | failed:",y.name,y.message)}this._recvTransportConnectTimeout()}else S==="connected"&&M&&(clearTimeout(M),M=null)}async _sendTransportConnectTimeout(){this.loggerSend.warn("媒体上行传输通道连接失败"),this.adapterRef._signalling&&(this.adapterRef.connectState.curState==="CONNECTED"?(this.loggerSend.log("媒体上行传输通道连接失败，尝试整体重连"),this.adapterRef.channelStatus="connectioning",this.adapterRef._signalling.reconnectionControl.next=this.adapterRef._signalling.reconnectionControl.copynext,this.adapterRef._signalling.reconnectionReason=s.ReconnectReason.SendPeerIceFailed,this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"sendPeerIceFailed",ext:""}),this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startWssTime=Date.now(),this.adapterRef._signalling._reconnection()):(this.loggerRecv.warn("媒体上行传输通道建立失败, 此时sdk正在重连, 不用特殊处理"),this.adapterRef.instance.apiEventReport("setStreamException",{name:"pushStreamException",value:"send transport connection failed"})))}async _recvTransportConnectTimeout(){this.loggerRecv.warn("媒体下行传输通道建立失败"),this.adapterRef._signalling&&(this.adapterRef.connectState.curState==="CONNECTED"?(this.loggerRecv.error("媒体下行传输通道连接失败，尝试整体重连"),this.adapterRef.channelStatus="connectioning",this.adapterRef._signalling.reconnectionControl.next=this.adapterRef._signalling.reconnectionControl.copynext,this.adapterRef._signalling.reconnectionReason=s.ReconnectReason.RecvPeerIceFailed,this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"recvPeerIceFailed",ext:""}),this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startWssTime=Date.now(),this.adapterRef._signalling._reconnection()):(this.loggerRecv.warn("媒体下行传输通道建立失败，此时sdk正在重连，不用特殊处理"),this.adapterRef.instance.apiEventReport("setStreamException",{name:"pullStreamException",value:"receive transport connection failed"})))}async _reconnectTransportConnectTimeout(){this.loggerRecv.error("媒体传输通道一直重连失败，主动退出房间"),this.adapterRef.instance.safeEmit("error","MEDIA_TRANSPORT_DISCONNECT"),this.adapterRef.instance.apiEventReport("setConnectionStateChange",{state:s.ConStateChange_state.ChannelLeave,reason:s.ConStateChange_reason.MediaDisconnected}),this.adapterRef.instance.leave(d.default.MEDIA_CONNECTION_DISCONNECTED)}async createProduce(I,M){var P,S,y,_,b;if(I.logger.log("publish() 发布音视频, mediaType: ",M),!this._sendTransport)throw new u.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"createProduce: 发送端 transport 未找到 1"});if(this._sendTransport.listenerCount("produce")===0&&this._sendTransport.on("produce",async({kind:E,rtpParameters:x,appData:D,localDtlsParameters:F,offer:V},N,L)=>{if(this.loggerSend.log(`publish() produce 反馈 [kind= ${E}, appData= ${O.JSONBigStringify(D)}]`),!this._sendTransport)return;const U=D.mediaType=="screenShare"?"screen":D.mediaType;let H=!1;(U==="video"&&this.adapterRef.channelInfo.videoLow||U==="screen"&&this.adapterRef.channelInfo.screenLow)&&(H=!0);const j=V.sdp.match(/a=ice-ufrag:([0-9a-zA-Z#=+-_\/\\\\]+)/);j||this.adapterRef.logger.error("publish() 找不到 iceUfragRegLocal: ",V.sdp);try{this.adapterRef.preferRemb&&(this.logger.log("publish() 使用REMB作为带宽估计方式"),C.filterTransportCCFromRtpParameters(x));let W,Y,te,re,G=Object.assign({requestId:""+Math.ceil(1e9*Math.random()),kind:E,rtpParameters:x,iceUfrag:j[1],externData:{producerInfo:{mediaType:D.mediaType==="audioSlave"?"subAudio":D.mediaType,subStream:D.mediaType==="screenShare"||D.mediaType==="audioSlave",simulcastEnable:H,spatialLayerCount:H?2:1,mute:I.muteStatus[U].send||!1}},appData:{enableTcpCandidate:!0}},D);if(U==="screen"?G.deviceId="screen-share-default":U==="video"&&(I.mediaHelper.video.videoSource?G.deviceId="video-external-default":G.deviceId="video-default"),m.getParameters().revertSubstreamProduceType)switch(G.externData.producerInfo.mediaType){case"screenShare":G.externData.producerInfo.mediaType="video",G.externData.producerInfo.subStream=!1;break;case"video":G.externData.producerInfo.mediaType="screenShare",G.externData.producerInfo.subStream=!0;break;case"audio":G.externData.producerInfo.mediaType="subAudio",G.externData.producerInfo.subStream=!0;break;case"subAudio":G.externData.producerInfo.mediaType="audio",G.externData.producerInfo.subStream=!1}if(h.ANY_CHROME_MAJOR_VERSION&&h.ANY_CHROME_MAJOR_VERSION>=58&&h.ANY_CHROME_MAJOR_VERSION<69)W=x.encodings[0];else{if(W=this.senderEncodingParameter[U].high,Y=this.senderEncodingParameter[U].low,te=V.sdp.indexOf(D.deviceId),re=V.sdp.indexOf(D.deviceIdLow),!W){if(x.encodings&&(W=x.encodings[0],W&&this.senderEncodingParameter.ssrcList.indexOf(W.ssrc)>-1&&(W=null),x.encodings[1]&&(Y=x.encodings[1],Y&&this.senderEncodingParameter.ssrcList.indexOf(Y.ssrc)>-1&&(W=null))),!W&&D.deviceId&&te>-1){const J=V.sdp.substring(te).match(/a=ssrc-group:FID (\d+) (\d+)/);if(J&&(W={ssrc:parseInt(J[1]),rtx:{ssrc:parseInt(J[2])}}),W&&this.senderEncodingParameter.ssrcList.indexOf(W.ssrc)>-1&&(W=null),!Y&&D.deviceIdLow&&re>-1){const X=V.sdp.substring(re).match(/a=ssrc-group:FID (\d+) (\d+)/);X&&(Y={ssrc:parseInt(X[1]),rtx:{ssrc:parseInt(X[2])}}),Y&&this.senderEncodingParameter.ssrcList.indexOf(Y.ssrc)>-1&&(Y=null)}}W||(this.loggerSend.log("publish() 使用sdp中第一个ssrc"),W={ssrc:parseInt(V.sdp.match(/a=ssrc:(\d+)/)[1]),dtx:!1}),this.senderEncodingParameter[U].high=W,this.senderEncodingParameter.ssrcList.push(W.ssrc),Y?(this.senderEncodingParameter[U].low=Y,this.senderEncodingParameter.ssrcList.push(Y.ssrc)):this.senderEncodingParameter[U].low=null}x.encodings=[this.senderEncodingParameter[U].high],this.senderEncodingParameter[U].low&&x.encodings.unshift(this.senderEncodingParameter[U].low)}if(D.mediaType==="video"||D.mediaType==="screenShare"){const J=D.mediaType==="video"?"video":"screen",X=I.mediaHelper[J];console.log("mediaConfig: ",X),G.mediaProfile=[],Y&&G.mediaProfile.push({ssrc:Y.ssrc,res:"240*180",fps:"1",spatialLayer:0,maxBitrate:X.encoderConfig.low.maxBitrate/1e3||800}),console.log("captureConfig: ",X.captureConfig),G.mediaProfile.push({ssrc:W.ssrc,res:`${X.captureConfig.high.width||640}*${X.captureConfig.high.height||480}`,fps:""+(X.captureConfig.high.frameRate||15),spatialLayer:G.mediaProfile.length,maxBitrate:X.encoderConfig.high.maxBitrate/1e3||800})}else if(D.mediaType==="audio"){G.mediaProfile=[];let J=32;switch(I.audioProfile){case"speech_standard":J=36;break;case"music_standard":J=40;break;case"standard_stereo":J=64;break;case"high_quality":J=128;break;case"high_quality_stereo":J=192}G.mediaProfile.push({ssrc:W.ssrc,maxBitrate:J})}for(let J=G.rtpParameters.codecs.length-1;J>=0;J--)G.rtpParameters.codecs[J].mimeType==="audio/red"&&G.rtpParameters.codecs.splice(J,1);if(F===void 0?G.transportId=this._sendTransport.id:G.dtlsParameters=F,!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw new u.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"createProduce: _protoo 未找到"});let K=G.rtpParameters;const de=K.codecs[0];m.getParameters().h264ProfileLevel&&m.getParameters().h264ProfileLevelSignal&&de.mimeType==="video/H264"&&de.parameters&&de.parameters["profile-level-id"]!==m.getParameters().h264ProfileLevelSignal&&(K=JSON.parse(JSON.stringify(K)),this.logger.log(`信令消息修改profile-level-id, ${K.codecs[0].parameters["profile-level-id"]} => ${m.getParameters().h264ProfileLevelSignal}`),K.codecs[0].parameters["profile-level-id"]=m.getParameters().h264ProfileLevelSignal,G.rtpParameters=K);let B=await this.adapterRef._signalling._protoo.request("Produce",G);const{code:$,transportId:z,iceParameters:ie,iceCandidates:Z,turnParameters:ee,dtlsParameters:ce,producerId:ae,errMsg:ne}=B;if(z!==void 0&&(this._sendTransport._id=z),$===200?this.loggerSend.log(`publish() produce请求反馈结果, code: ${$}, kind: ${E}, producerId: ${ae}`):this.loggerSend.error(`publish() produce请求反馈错误, code: ${$}, kind: ${E}, producerId: ${ae},  errMsg: ${ne}, 请求：${O.JSONBigStringify(G)}, 返回：${O.JSONBigStringify(G)}`),ee){let J=[];J.push({urls:"turn:"+ee.ip+":"+ee.port+"?transport=udp",credential:ee.password,username:ee.username},{urls:"turn:"+ee.ip+":"+ee.port+"?transport=tcp",credential:ee.password,username:ee.username}),await this._sendTransport.updateIceServers({iceServers:J})}let se={codecParam:null,codecName:null};if(D.mediaType==="audio"?this._micProducerId=ae:D.mediaType==="audioSlave"?this._audioSlaveProducerId=ae:D.mediaType==="video"?(this._webcamProducerId=ae,se=this.adapterRef.mediaCapability.getCodecSend("video",this._sendTransport.handler._sendingRtpParametersByKind.video),this._webcamProducerCodec=se.codecName):D.mediaType==="screenShare"&&(this._screenProducerId=ae,se=this.adapterRef.mediaCapability.getCodecSend("screen",this._sendTransport.handler._sendingRtpParametersByKind.video),this._screenProducerCodec=se.codecName),!this.adapterRef.localStream)throw new u.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"createProduce: 未找到 localStream"});let he=[];if(D.mediaType==="audio"||D.mediaType==="audioSlave")he.push(Object.assign({},m.getParameters().codecOptions.audio));else if(D.mediaType==="video"){if(x.encodings.length>=2){const X={};m.getParameters().videoLowStartBitrate&&(X.videoGoogleStartBitrate=m.getParameters().videoLowStartBitrate),m.getParameters().videoLowMinBitrate&&(X.videoGoogleMinBitrate=m.getParameters().videoLowMinBitrate),he.push(X)}const J={};m.getParameters().videoHighStartBitrate&&(J.videoGoogleStartBitrate=m.getParameters().videoHighStartBitrate),m.getParameters().videoHighMinBitrate&&(J.videoGoogleMinBitrate=m.getParameters().videoHighMinBitrate),he.push(J)}else if(D.mediaType==="screenShare"){if(x.encodings.length>=2){const X={};m.getParameters().screenLowStartBitrate&&(X.videoGoogleStartBitrate=m.getParameters().screenLowStartBitrate),m.getParameters().screenLowMinBitrate&&(X.videoGoogleMinBitrate=m.getParameters().screenLowMinBitrate),he.push(X)}const J={};m.getParameters().screenHighStartBitrate&&(J.videoGoogleStartBitrate=m.getParameters().screenHighStartBitrate),m.getParameters().screenHighMinBitrate&&(J.videoGoogleMinBitrate=m.getParameters().screenHighMinBitrate),he.push(J)}this.logger.log(`codecOptions for producer ${D.mediaType}: ${O.JSONBigStringify(he)}`);let ue=Z;this.adapterRef.channelInfo.iceProtocol&&Z&&(this.logger.warn("Produce iceProtocol: ",this.adapterRef.channelInfo.iceProtocol),ue=Z.filter(J=>J.protocol==this.adapterRef.channelInfo.iceProtocol)),D.mediaType&&(this.remoteRecvParams[D.mediaType]={kind:E,appData:D,iceParameters:ie,iceCandidates:ue,dtlsParameters:ce,sctpParameters:void 0,sendingRtpParameters:x,codecOptions:he,offer:V,codec:se.codecParam,audioProfile:this.adapterRef.localStream.audioProfile}),await this._sendTransport.fillRemoteRecvSdp({kind:E,appData:D,iceParameters:ie,iceCandidates:ue,dtlsParameters:ce,sctpParameters:void 0,sendingRtpParameters:x,codecOptions:he,offer:V,codec:se.codecParam,audioProfile:this.adapterRef.localStream.audioProfile}),h.ANY_CHROME_MAJOR_VERSION&&h.ANY_CHROME_MAJOR_VERSION>=58&&h.ANY_CHROME_MAJOR_VERSION<69||U!=="video"&&U!=="screen"||(this.adapterRef.localStream.applyEncoderConfig(U,"high"),x.encodings.length>=2&&this.adapterRef.localStream.applyEncoderConfig(U,"low")),N({id:ae})}catch(W){L(W)}}),M==="audio"||M==="all")if(this._micProducer)this.loggerSend.log("publish() 音频已经发布, 忽略");else{const E=I.mediaHelper.audio.audioStream.getAudioTracks()[0];if(E)if(((P=this.adapterRef.permKeyInfo)===null||P===void 0?void 0:P.pubAudioRight)===!1)this.loggerSend.error("publish() permKey权限控制, 不能发布音频"),this.adapterRef.instance.safeEmit("error","no-publish-audio-permission");else if(E.readyState==="ended")this.loggerSend.error("publish() 音频轨道已关闭，请检查输入设备:audio",E);else{this.loggerSend.log("publish() 发布音频 audioTrack: ",E.id,E.label),I.pubStatus.audio.audio=!0;try{this._micProducer=await this._sendTransport.produce({track:E,trackLow:null,codecOptions:{opusStereo:!0,opusDtx:!0},appData:{preferRemb:this.adapterRef.preferRemb,deviceId:E.id,deviceIdLow:null,mediaType:"audio"}})}catch(x){this.loggerSend.error("produce audio error: ",x)}this.watchProducerState(this._micProducer,"_micProducer"),this.adapterRef.encryption.encodedInsertableStreams&&this._micProducer._rtpSender&&this.enableSendTransform(this._micProducer._rtpSender,"audio","high")}}if(M==="audioSlave"||M==="all")if(this._audioSlaveProducer)this.loggerSend.log("publish() 音频辅流已经发布, 忽略");else{const E=I.mediaHelper.screenAudio.screenAudioStream.getAudioTracks()[0];E&&(((S=this.adapterRef.permKeyInfo)===null||S===void 0?void 0:S.pubAudioRight)===!1?(this.loggerSend.error("publish() permKey权限控制, 不能发布音频辅流"),this.adapterRef.instance.safeEmit("error","no-publish-audio-slave-permission")):E.readyState==="ended"?this.loggerSend.error("publish() 音频辅流轨道已关闭，请检查输入设备:audioSlave",E):(this.loggerSend.log("publish() 发布音频辅流 audioSlaveTrack: ",E.id,E.label),I.pubStatus.audioSlave.audio=!0,this._audioSlaveProducer=await this._sendTransport.produce({track:E,trackLow:null,codecOptions:{opusStereo:!0,opusDtx:!0},appData:{preferRemb:this.adapterRef.preferRemb,deviceId:E.id,deviceIdLow:null,mediaType:"audioSlave"}}),this.watchProducerState(this._audioSlaveProducer,"_audioSlaveProducer")))}if(M==="video"||M==="all"){if(this._webcamProducer)this.loggerSend.log("publish() 视频已经发布，忽略");else if(I.mediaHelper.video.videoStream.getVideoTracks().length){const E=I.mediaHelper.video.videoStream.getVideoTracks()[0];if(((y=this.adapterRef.permKeyInfo)===null||y===void 0?void 0:y.pubVideoRight)===!1)this.loggerSend.error("publish() permKey权限控制, 不能发布视频"),this.adapterRef.instance.safeEmit("error","no-publish-video-permission");else if(E.readyState==="ended")this.loggerSend.error("publish() 视频轨道已关闭, 请检查输入设备: video",E);else{let x=null;this.adapterRef.channelInfo.videoLow?(I.mediaHelper.video.low||(I.mediaHelper.video.low=new g.VideoTrackLow({logger:this.logger,mediaType:"video"})),I.mediaHelper.video.low.track?(x=I.mediaHelper.video.low.track,this.adapterRef.instance.safeEmit("track-low-init-success",{mediaType:"video"})):this.adapterRef.instance.safeEmit("track-low-init-fail",{mediaType:"video"})):(I.mediaHelper.video.low&&I.mediaHelper.video.low.bindSender(null,null),this.senderEncodingParameter.video.low=null),this.loggerSend.log("publish() 发布视频 videoTrack: ",E.id,E.label),I.pubStatus.video.video=!0;const D=this.adapterRef.mediaCapability.getCodecSend("video",this._sendTransport.handler._sendingRtpParametersByKind.video);this._webcamProducer=await this._sendTransport.produce({track:E,trackLow:x,codec:D.codecParam,codecOptions:{videoGoogleStartBitrate:1e3},appData:{preferRemb:this.adapterRef.preferRemb,deviceId:E.id,deviceIdLow:(x==null?void 0:x.id)||null,mediaType:"video"}}),this._webcamProducer._rtpSender&&I.mediaHelper.video.low&&(I.mediaHelper.video.low.bindSender(this._webcamProducer._rtpSender,this._webcamProducer._rtpSenderLow||null),v.IS_SAFARI&&v.SAFARI_MAJOR_VERSION&&v.SAFARI_MAJOR_VERSION<14&&(!((_=I._play.video.dom)===null||_===void 0)&&_.srcObject)&&(this.logger.log("publish() 尝试重置本地视图的SrcObject"),I._play.video.dom.srcObject=I._play.video.dom.srcObject)),this.watchProducerState(this._webcamProducer,"_webcamProducer"),this.adapterRef.encryption.encodedInsertableStreams&&(this._webcamProducer._rtpSender&&this.enableSendTransform(this._webcamProducer._rtpSender,"video","high"),this._webcamProducer._rtpSenderLow&&this.enableSendTransform(this._webcamProducer._rtpSenderLow,"video","low")),this.adapterRef.state.startPubVideoTime||(this.adapterRef.state.startPubVideoTime=Date.now())}}}if(M==="screen"||M==="all"){if(this._screenProducer)this.loggerSend.log("publish() 屏幕共享已经发布, 忽略");else if(I.mediaHelper.screen.screenVideoStream.getVideoTracks().length){const E=I.mediaHelper.screen.screenVideoStream.getVideoTracks()[0];if(((b=this.adapterRef.permKeyInfo)===null||b===void 0?void 0:b.pubVideoRight)===!1)this.loggerSend.error("publish() permKey权限控制, 不能发布屏幕共享"),this.adapterRef.instance.safeEmit("error","no-publish-screen-permission");else if(E.readyState==="ended")this.loggerSend.error("publish()，屏幕共享轨道已关闭，请检查输入设备:screen",E);else{let x=null;this.adapterRef.channelInfo.screenLow?(I.mediaHelper.screen.low||(I.mediaHelper.screen.low=new g.VideoTrackLow({logger:I.logger,mediaType:"screen"})),I.mediaHelper.screen.low.track?(x=I.mediaHelper.screen.low.track,this.adapterRef.instance.safeEmit("track-low-init-success",{mediaType:"screen"})):this.adapterRef.instance.safeEmit("track-low-init-fail",{mediaType:"screen"})):(I.mediaHelper.screen.low&&I.mediaHelper.screen.low.bindSender(null,null),this.senderEncodingParameter.screen.low=null),this.loggerSend.log("publish() 发布屏幕共享 screenTrack: ",E.id,E.label),I.pubStatus.screen.screen=!0;const D=this.adapterRef.mediaCapability.getCodecSend("screen",this._sendTransport.handler._sendingRtpParametersByKind.video);this._screenProducer=await this._sendTransport.produce({track:E,trackLow:x,codec:D.codecParam,codecOptions:{videoGoogleStartBitrate:1e3},appData:{preferRemb:this.adapterRef.preferRemb,deviceId:E.id,deviceIdLow:(x==null?void 0:x.id)||null,mediaType:"screenShare"}}),this._screenProducer._rtpSender&&I.mediaHelper.screen.low&&I.mediaHelper.screen.low.bindSender(this._screenProducer._rtpSender,this._screenProducer._rtpSenderLow||null),this.watchProducerState(this._screenProducer,"_screenProducer"),this.adapterRef.encryption.encodedInsertableStreams&&(this._screenProducer._rtpSender&&this.enableSendTransform(this._screenProducer._rtpSender,"screen","high"),this._screenProducer._rtpSenderLow&&this.enableSendTransform(this._screenProducer._rtpSenderLow,"screen","low")),this.adapterRef.state.startPubScreenTime||(this.adapterRef.state.startPubScreenTime=Date.now())}}}}async setRemoteRecvSdp(I,M){var P,S,y;if(!this._sendTransport)return void this.logger.warn("setRemoteRecvSdp _sendTransport 不存在");if(!this.remoteRecvParams[M])return void this.logger.warn("setRemoteRecvSdp remoteRecvParams 不存在, mediaType: "+M);if(!this.adapterRef.localStream)throw new u.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"未找到 localStream"});const{kind:_,appData:b,iceParameters:E,iceCandidates:x,dtlsParameters:D,codecOptions:F,sendingRtpParameters:V}=this.remoteRecvParams[M],N=await this._sendTransport._handler._pc.createOffer();let L=null,U=((S=(P=this._sendTransport)===null||P===void 0?void 0:P.handler._sendingRtpParametersByKind.video)===null||S===void 0?void 0:S.codecs)||[];for(let H in U)if(U[H].mimeType.indexOf(I)>-1){L={codecParam:U[H],codecName:I};break}L?await((y=this._sendTransport)===null||y===void 0?void 0:y.fillRemoteRecvSdp({kind:_,appData:b,iceParameters:E,iceCandidates:x,dtlsParameters:D,sctpParameters:void 0,sendingRtpParameters:V,codecOptions:F,offer:N,codec:L.codecParam,audioProfile:this.adapterRef.localStream.audioProfile,resetVideoSdp:M==="video"||M==="screenShare"})):this.logger.error("setRemoteRecvSdp codecInfo 不存在",I)}enableSendTransform(I,M,P){var S;const y=(S=this._sendTransport)===null||S===void 0?void 0:S.send.find(_=>_.sender===I);if(y)if(y.encodedStreams)this.loggerRecv.log(`发送端自定义加密，复用之前的通道。 ${y.mediaType} ${y.streamType}`);else{const _=I.createEncodedStreams(),b=new TransformStream({transform:this.adapterRef.encryption.handleUpstreamTransform.bind(this.adapterRef.encryption,y)});_.readable.pipeThrough(b).pipeTo(_.writable),y.encodedStreams=_,y.transformStream=b,this.loggerRecv.log(`发送端自定义加密，成功启动。 ${y.mediaType} ${y.streamType}`)}else this.loggerRecv.error("enableSendTransform() 未找到匹配的Sender",M,P)}enableRecvTransform(I,M,P){var S;const y=(S=this._recvTransport)===null||S===void 0?void 0:S.recv.find(_=>_.receiver===I);if(y)if(y.encodedStreams)this.loggerRecv.log(`接收端自定义解密，复用之前的通道。uid:${y.uid}, mediaType: ${y.mediaType}`);else{const _=I.createEncodedStreams(),b=new TransformStream({transform:this.adapterRef.encryption.handleDownstreamTransform.bind(this.adapterRef.encryption,y)});_.readable.pipeThrough(b).pipeTo(_.writable),y.encodedStreams=_,y.transformStream=b,this.loggerRecv.log(`接收端自定义解密，成功启动。uid:${y.uid}, mediaType: ${y.mediaType}`)}else this.loggerRecv.error("enableRecvTransform() 未找到匹配的Receiver",M,P)}watchProducerState(I,M){var P;if(!((P=I.rtpSender)===null||P===void 0)&&P.transport){const S=I.rtpSender.transport;switch(S.state){case"failed":this.logger.error(`publish() Producer state ${M} ${S.state}`);break;case"connected":case"new":case"connecting":default:this.logger.log(`publish() Producer state ${M} ${S.state}`),I.rtpSender.transport.addEventListener("statechange",()=>{switch(S.state){case"failed":this.logger.error(`publish() Producer state changed: ${M} ${S.state}`);break;case"connected":case"new":case"connecting":this.logger.log(`publish() Producer state changed: ${M} ${S.state}`)}})}}else this.logger.log("publish() Producer state: transport is null")}async destroyProduce(I){var M;let P=null,S=null;if(!this.adapterRef.localStream)throw new u.default({code:d.default.LOCALSTREAM_NOT_FOUND_ERROR,message:`destroyProduce.${I}: 未找到 localStream`});I==="audio"?(P=this._micProducer,S=this._micProducerId,this._micProducer=this._micProducerId=null,this.adapterRef.localStream.pubStatus.audio.audio=!1):I==="audioSlave"?(P=this._audioSlaveProducer,S=this._audioSlaveProducerId,this._audioSlaveProducer=this._audioSlaveProducerId=null,this.adapterRef.localStream.pubStatus.audioSlave.audio=!1):I==="video"?(P=this._webcamProducer,S=this._webcamProducerId,this._webcamProducer=this._webcamProducerId=null,this.adapterRef.localStream.pubStatus.video.video=!1):I==="screen"&&(P=this._screenProducer,S=this._screenProducerId,this._screenProducer=this._screenProducerId=null,this.adapterRef.localStream.pubStatus.screen.screen=!1);try{if(this.loggerSend.log(`停止发布 destroyProduce ${I} producerId=`,S),!P)return;P.close(),!((M=this.adapterRef._signalling)===null||M===void 0)&&M._protoo?this.adapterRef._signalling._protoo.request("CloseProducer",{requestId:""+Math.ceil(1e9*Math.random()),producerId:S}).catch(y=>{this.logger.error("CloseProducer Failed: ",y.name,y.message)}):this.logger.warn("destroyProduce: 当前信令中断, 不发信令包",I,S)}catch(y){this.loggerSend.error("destroyProduce failed: ",y.name,y.message)}}async createConsumer(I,M,P,S,y=0){this.adapterRef.instance.safeEmit("@pairing-createConsumer-start");let _=!1;if(this._eventQueue.forEach(b=>{if(b.id===S)return this.loggerRecv.log(`[subscribe] 已经在订阅任务队列中，忽略该次请求, uid: ${I}, mediaType: ${P}, producerId: ${S}`),void(_=!0)}),!_)return new Promise((b,E)=>{if(this._eventQueue.push({uid:I,kind:M,id:S,mediaType:P,preferredSpatialLayer:y,resolve:b,reject:E}),this._eventQueue.length>1)return this._eventQueueData=Object.assign([],this._eventQueue),void this.loggerRecv.log(`[subscribe] 订阅任务队列中有多个任务，当前任务队列长度: ${this._eventQueue.length},第一个任务: ${JSON.stringify(this._eventQueue[0])}`);this._createConsumer(this._eventQueue[0])})}async createConsumer69(I,M,P,S){if(this.consumerMap.has(I)){if(P.audio==this.consumerMap.get(I).subStatus.audio&&P.video==this.consumerMap.get(I).subStatus.video&&P.audioSlave==this.consumerMap.get(I).subStatus.audioSlave&&P.screen==this.consumerMap.get(I).subStatus.screen)return void this.logger.info("createConsumer69() uid 已经存在");this.logger.info("createConsumer69() 只需替换pubStatus: ",S),this.logger.info("createConsumer69() 只需替换stream.pubStatus: ",M.pubStatus),this.consumerMap.get(I).subStatus=P,this.consumerMap.get(I).pubStatus=M.pubStatus}else this.logger.info("createConsumer69() 设置consumerMap: ",S),this.consumerMap.set(I,{stream:M,subStatus:P,pubStatus:S});let y=[],_="all";this.adapterRef.channelInfo.relaytoken&&this.adapterRef.channelInfo.relayaddrs&&(this.adapterRef.channelInfo.relayaddrs.forEach(b=>{y.push({urls:"turn:"+b+"?transport=udp",credential:this.adapterRef.proxyServer.credential||this.adapterRef.channelInfo.uid+"/"+this.adapterRef.channelInfo.cid,username:this.adapterRef.channelInfo.relaytoken},{urls:"turn:"+b+"?transport=tcp",credential:this.adapterRef.proxyServer.credential||this.adapterRef.channelInfo.uid+"/"+this.adapterRef.channelInfo.cid,username:this.adapterRef.channelInfo.relaytoken})}),h.IS_FIREFOX||(_="relay")),y.length&&this.logger.log("iceTransportPolicy ",_," iceServers ",O.JSONBigStringify(y)),this.consumerMap.size&&this.consumerMap.forEach((b,E)=>{this._mediasoupDevice&&(b.subStatus.audio&&!b._recvTransportMainAudio&&(b._recvTransportMainAudio=this._mediasoupDevice.createRecvTransport({id:E+"_main_audio",iceParameters:void 0,iceCandidates:void 0,dtlsParameters:void 0,sctpParameters:void 0,iceServers:y,iceTransportPolicy:_,appData:{cid:this.adapterRef.channelInfo.cid,uid:E.toString(),encodedInsertableStreams:this.adapterRef.encryption.encodedInsertableStreams}}),b._recvTransportMainAudioTimeoutTimer=null,b._recvTransportMainAudio._handler._pc.addEventListener("iceconnectionstatechange",this._recvTransportConnectionstatechange69.bind(this,b._recvTransportMainAudio,b._recvTransportMainAudioTimeoutTimer)),this._createConsumer69(E,"audio","audio",b.pubStatus.audio.producerId,b._recvTransportMainAudio)),b.subStatus.video&&!b._recvTransportMainVideo&&(b._recvTransportMainVideo=this._mediasoupDevice.createRecvTransport({id:E+"_main_video",iceParameters:void 0,iceCandidates:void 0,dtlsParameters:void 0,sctpParameters:void 0,iceServers:y,iceTransportPolicy:_,appData:{cid:this.adapterRef.channelInfo.cid,uid:E.toString(),encodedInsertableStreams:this.adapterRef.encryption.encodedInsertableStreams}}),b._recvTransportMainVideoTimeoutTimer=null,b._recvTransportMainVideo._handler._pc.addEventListener("iceconnectionstatechange",this._recvTransportConnectionstatechange69.bind(this,b._recvTransportMainVideo,b._recvTransportMainVideoTimeoutTimer)),this._createConsumer69(E,"video","video",b.pubStatus.video.producerId,b._recvTransportMainVideo)),b.subStatus.audioSlave&&!b._recvTransportSubAudioSlave&&(b._recvTransportSubAudioSlave=this._mediasoupDevice.createRecvTransport({id:E+"_sub_audioSlave",iceParameters:void 0,iceCandidates:void 0,dtlsParameters:void 0,sctpParameters:void 0,iceServers:y,iceTransportPolicy:_,appData:{cid:this.adapterRef.channelInfo.cid,uid:E.toString(),encodedInsertableStreams:this.adapterRef.encryption.encodedInsertableStreams}}),b._recvTransportSubAudioSlaveTimeoutTimer=null,b._recvTransportSubAudioSlave._handler._pc.addEventListener("iceconnectionstatechange",this._recvTransportConnectionstatechange69.bind(this,b._recvTransportSubAudioSlave,b._recvTransportSubAudioSlaveTimeoutTimer)),this._createConsumer69(E,"audio","audioSlave",b.pubStatus.audioSlave.producerId,b._recvTransportSubAudioSlave)),b.subStatus.screen&&!b._recvTransportSubScreen&&(b._recvTransportSubScreen=this._mediasoupDevice.createRecvTransport({id:E+"_sub_screen",iceParameters:void 0,iceCandidates:void 0,dtlsParameters:void 0,sctpParameters:void 0,iceServers:y,iceTransportPolicy:_,appData:{cid:this.adapterRef.channelInfo.cid,uid:E.toString(),encodedInsertableStreams:this.adapterRef.encryption.encodedInsertableStreams}}),b._recvTransportSubScreenTimeoutTimer=null,b._recvTransportSubScreen._handler._pc.addEventListener("iceconnectionstatechange",this._recvTransportConnectionstatechange69.bind(this,b._recvTransportSubScreen,b._recvTransportSubScreenTimeoutTimer)),this._createConsumer69(E,"video","screen",b.pubStatus.screen.producerId,b._recvTransportSubScreen)))})}async setConsumerPreferredLayer(I,M,P){if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw new u.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"setConsumerPreferredLayer: _protoo 未找到"});return this.loggerSend.log("setConsumerPreferredLayer() [切换大小流]layer: ",M,M===1?"大流":"小流",P),await this.adapterRef._signalling._protoo.request("SetConsumerPreferredLayer",{requestId:""+Math.ceil(1e9*Math.random()),uid:new T.SimpleBig(I.streamID),producerId:I.pubStatus[P].producerId,consumerId:I.pubStatus[P].consumerId,spatialLayer:M})}async resetConsumeRequestStatus(){const I=this._eventQueue;this._eventQueue=[];for(let M=0;M<I.length;M++){const P=I[M];this.loggerRecv.log(`resetConsumeRequestStatus：uid ${P.uid}, uid ${P.uid}, kind ${P.kind}, id ${P.id}`),P.reject("resetConsumeRequestStatus")}}removeUselessConsumeRequest(I,M){if(I)for(let P=this._eventQueue.length-1;P>=1;P--){const S=this._eventQueue[P];S.uid.toString()!==I.toString()||S.mediaType!==M&&M!=="all"||(this.loggerRecv.warn(`removeUselessConsumeRequest：uid ${S.uid}, mediaType ${S.mediaType}, id ${S.id}, i ${P}`),S.resolve(null),this._eventQueue.splice(P,1))}}checkConsumerList(I){return this._eventQueue.shift(),I.resolve(null),this.loggerRecv.log("查看事件队列, _eventQueue: ",this._eventQueue.length),this._eventQueue.forEach(M=>{this.loggerRecv.log(`consumerList, uid: ${M.uid}, kind: ${M.kind}, mediaType: ${M.mediaType}, id: ${M.id}`)}),this._eventQueue.length>0&&this._createConsumer(this._eventQueue[0]),"checkConsumerList"}async _createConsumer(I){var M,P,S,y,_,b,E,x;const D=((S=(P=(M=this.adapterRef)===null||M===void 0?void 0:M._mediasoup)===null||P===void 0?void 0:P._recvTransport)===null||S===void 0?void 0:S._handler._pc.getTransceivers())||[];if(D.length){const me=[...D].reverse().find(Q=>Q.remoteUid===I.uid&&Q.receiver.track.kind===I.kind);(me==null?void 0:me.receiver.track.readyState)==="ended"&&(this.loggerRecv.log("[Subscribe] Track readyState ended. RemoteUid: "+I.uid),me.isUseless=!1)}const{uid:F,kind:V,mediaType:N,id:L,preferredSpatialLayer:U=0}=I,H=N==="screenShare"?"screen":N;if(H==="audio"?this.loggerRecv.log(`[Subscribe] 开始订阅 ${F} 的 ${H} 媒体: ${L}`):this.loggerRecv.log(`[Subscribe] 开始订阅 ${F} 的 ${H} 媒体: ${L} preferredSpatialLayer: ${U} 大小流: `,U===1?"大流":"小流"),!L)return this.adapterRef.instance.safeEmit("@pairing-createConsumer-error"),this.checkConsumerList(I);if(this.unsupportedProducers[L])return this.loggerRecv.warn("[Subscribe] createConsumer: 跳过不支持的Producer",L,O.JSONBigStringify(this.unsupportedProducers[L])),this.checkConsumerList(I);const j=this.adapterRef.remoteStreamMap[F];if(!j||!j.pubStatus[H][H]||!j.pubStatus[H].producerId)return this.adapterRef.instance.safeEmit("@pairing-createConsumer-skip"),this.checkConsumerList(I);if(j.pubStatus[H].consumerId){this.loggerRecv.log("[Subscribe] 已经订阅过: ",H);let me=!0;if(j.Play&&(me=j._play.isPlaying(H)),me)return this.loggerRecv.log(`[Subscribe] 当前 ${H} 播放正常，直接返回`),this.adapterRef.instance.safeEmit("@pairing-createConsumer-skip"),this.checkConsumerList(I);if(j.pubStatus[H].stopconsumerStatus!=="start"){this.loggerRecv.log("[Subscribe] 先停止之前的订阅: ",H);try{if(j.pubStatus[H].stopconsumerStatus="start",!this.adapterRef._mediasoup)return this.checkConsumerList(I);await this.destroyConsumer(j.pubStatus.audio.consumerId,null,null),this.adapterRef.instance.removeSsrc(j.getId(),H),j.pubStatus[H].consumerId="",j.stop(H),j.pubStatus[H].stopconsumerStatus="end"}catch(Q){this.loggerRecv.error("[Subscribe] 停止之前的订阅出现错误: ",Q.name,Q.message)}}}let W=null;if(H!=="audio"&&H!=="audioSlave"||(W={opusStereo:1}),this._mediasoupDevice&&this._mediasoupDevice.loaded||(this.loggerRecv.warn(`[Subscribe] ${H} createConsumer: Waiting for Transport Ready`),await o.waitForEvent(this,"transportReady",3e3)),!this._recvTransport)throw this.adapterRef.instance.safeEmit("@pairing-createConsumer-error"),I.resolve(null),new u.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"createConsumer: 接收端 transport 未找到"});this.loggerRecv.log(`[Subscribe] prepareLocalSdp [kind: ${V}, mediaTypeShort: ${H}, uid: ${F}]`),this._recvTransport.id===this.adapterRef.channelInfo.uid&&(this.loggerRecv.log("[Subscribe] transporth还没有协商, 需要dtls消息"),this._recvTransport._handler._transportReady=!1);const Y=await this._recvTransport.prepareLocalSdp(V,this._edgeRtpCapabilities,F);this.adapterRef&&this.adapterRef.connectState.curState!="DISCONNECTING"&&this.adapterRef.connectState.curState!="DISCONNECTED"||this.checkConsumerList(I),this.loggerRecv.log("[Subscribe] 获取本地sdp, mid =",Y.mid);let{rtpCapabilities:te,offer:re}=Y,G=Y.mid;const K=Y.dtlsParameters;G=typeof G=="number"&&G<0?void 0:""+G;const de=re.sdp.match(/a=ice-ufrag:([0-9a-zA-Z=#+-_\/\\\\]+)/);if(!de)throw new u.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"_createConsumer: iceUfragRegRemote 为空"});let B={requestId:""+Math.ceil(1e9*Math.random()),kind:V,rtpCapabilities:te,uid:new T.SimpleBig(F),producerId:L,preferredSpatialLayer:U,mid:G,pause:!1,iceUfrag:de[1],audioAslFlag:this.adapterRef.audioAsl.enabled==="yes"&&m.getParameters().audioAslFlag,appData:{enableTcpCandidate:!0}};if(K===void 0?B.transportId=this._recvTransport.id:B.dtlsParameters=K,this.loggerRecv.log(`[Subscribe] 发送consume请求, uid: ${F}, kind: ${V}, mediaTypeShort: ${H}, producerId: ${B.producerId}, transportId: ${B.transportId}, requestId: ${B.requestId}`),!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw I.resolve(null),new u.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"_createConsumer: _protoo 未找到"});const $=this.adapterRef._signalling._protoo;let z=null;try{z=await this.adapterRef._signalling._protoo.request("Consume",B)}catch(me){throw me.message==="request timeout"&&this.adapterRef._signalling._protoo.id===$.id?(this.logger.error(`[Subscribe] Consume消息Timeout, 尝试信令重连: ${me.name}/${me.message}, 当前的连接状态: ${this.adapterRef.connectState.curState}, 原始请求: `,O.JSONBigStringify(B)),this.adapterRef.channelStatus="connectioning",this.adapterRef._signalling.reconnectionReason=s.ReconnectReason.ConsumeRequestTimeout,this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"consumeRequestTimeout",ext:""}),this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startWssTime=Date.now(),this.adapterRef._signalling._reconnection()):this.logger.error(`[Subscribe] Consume消息错误: ${me.name}/${me.message}, 当前的连接状态：${this.adapterRef.connectState.curState}, 原始请求：`,O.JSONBigStringify(B)),new u.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"_createConsumer: Consume 消息错误:"+me.message})}let{transportId:ie,iceParameters:Z,iceCandidates:ee,dtlsParameters:ce,probeSSrc:ae,rtpParameters:ne,turnParameters:se,producerId:he,consumerId:ue,code:J,errMsg:X}=z;if(this.loggerRecv.log(`[Subscribe] consume反馈结果 code: ${J} uid: ${F},  kind: ${V}, mediaTypeShort: ${H}, mid: ${ne&&ne.mid}, kind: ${V}, producerId: ${he}, consumerId: ${ue}, transportId: ${ie}, requestId: ${z.requestId}, errMsg: ${X}`),!this._recvTransport)return this.loggerRecv.error("[Subscribe] transport undefined, 直接返回"),this.checkConsumerList(I);if(J!==200&&!(!((_=(y=this._recvTransport)===null||y===void 0?void 0:y._handler)===null||_===void 0)&&_.remoteSdp))return this._recvTransport.recoverLocalSdp(F,"0",V),this.loggerRecv.log("[Subscribe] consume, 此外没有remoteSdp, 忽略改次失败的consume"),!((E=(b=this._recvTransport)===null||b===void 0?void 0:b._handler)===null||E===void 0)&&E._pc.localDescription||((x=this._recvTransport._handler)===null||x===void 0?void 0:x._pc.getTransceivers().length)!==1||this.resetRecvTransport(),this.checkConsumerList(I);if(se){let me=[];me.push({urls:"turn:"+se.ip+":"+se.port+"?transport=udp",credential:se.password,username:se.username},{urls:"turn:"+se.ip+":"+se.port+"?transport=tcp",credential:se.password,username:se.username}),await this._recvTransport.updateIceServers({iceServers:me})}const le=z.uid;ne&&ne.encodings&&ne.encodings.length&&ne.encodings[0].ssrc&&this.adapterRef.instance.addSsrc(F,H,ne.encodings[0].ssrc),ie!==void 0&&(this._recvTransport._id=ie),ae!==void 0&&(this._probeSSrc=ae),ne&&ne.mid!=null&&(ne.mid=ne.mid+"");let ge=ee;this.adapterRef.channelInfo.iceProtocol&&ee&&(this.logger.warn("Consume iceProtocol: ",this.adapterRef.channelInfo.iceProtocol),ge=ee.filter(me=>me.protocol==this.adapterRef.channelInfo.iceProtocol));const fe=await this._recvTransport.consume({id:ue||he||L,producerId:he||L,kind:V,mediaType:H,uid:F||le,rtpParameters:ne,codecOptions:W,appData:{peerId:le,remoteUid:F,mid:G},offer:re,iceParameters:Z,iceCandidates:ge,dtlsParameters:ce,sctpParameters:void 0,probeSSrc:this._probeSSrc});if(this.adapterRef.encryption.encodedInsertableStreams&&fe.rtpReceiver&&this.enableRecvTransform(fe.rtpReceiver,F,H),this._consumers[fe.id]=fe,fe.on("transportclose",()=>{this._consumers&&delete this._consumers[fe.id]}),this.loggerRecv.log(`[Subscribe] 订阅consume完成  uid: ${F},  kind: ${V}, mediaTypeShort: ${H}, peerId: ${le}`),this.adapterRef.instance.apiEventReport("setFunction",{name:`set_${H}_sub`,oper:"1",value:O.JSONBigStringify({remoteUid:F,code:J,reason:X||"",preferredSpatialLayer:U,consumerId:ue||"",producerId:he||L},null," ")}),j&&j.pubStatus[H].producerId){if(j.subStatus[H]=!0,j.pubStatus[H][H]=!0,j.pubStatus[H].consumerId=ue,j.pubStatus[H].producerId=he,j.getMuteStatus(H).muted){this.loggerRecv.log(`[Subscribe] 远端流处于mute状态 uid: ${j.getId()}, mediaTypeShort: ${H}, muteStatus: ${O.JSONBigStringify(j.getMuteStatus(H))}`);const me=j.getMuteStatus(H);me.send&&this.loggerRecv.log(`[Subscribe] 远端流把自己mute了：uid ${j.getId()}, ${H}, ${O.JSONBigStringify(me)}`),me.recv&&(this.loggerRecv.log(`[Subscribe] 本端把远端流mute了：uid ${j.getId()}, ${H}, ${O.JSONBigStringify(me)}`),fe.track.enabled=!1)}else fe.track.enabled=!0;this.loggerRecv.log(`[Subscribe] updateStream uid: ${j.getId()}, mediaTypeShort: ${H}, track状态 enabled: ${fe.track.enabled}, muted: ${fe.track.muted}, name: ${fe.track.label}}`),j.mediaHelper.updateStream(H,fe.track),this.adapterRef.instance.safeEmit("@pairing-createConsumer-success"),H==="audio"?this.adapterRef.state.signalAudioSubscribedTime<this.adapterRef.state.signalOpenTime&&(this.adapterRef.state.signalAudioSubscribedTime=Date.now()):H==="video"&&this.adapterRef.state.signalVideoSubscribedTime<this.adapterRef.state.signalOpenTime&&(this.adapterRef.state.signalVideoSubscribedTime=Date.now()),this.adapterRef.instance.safeEmit("stream-subscribed",{stream:j,mediaType:H})}else this.adapterRef.instance.safeEmit("@pairing-createConsumer-error"),this.loggerRecv.log("[Subscribe] 该次consume状态错误: ",O.JSONBigStringify(j.pubStatus,null,""));return this.checkConsumerList(I)}async _createConsumer69(I,M,P,S,y){let _=`${I}_${P}`;if(this._usedUidMediaTypes[_])return void this.logger.info("_createConsumer69 去重: ",_);this._usedUidMediaTypes[_]=!0;const b=this.adapterRef.remoteStreamMap[I];let E=await y.prepareLocalSdp(M,this._edgeRtpCapabilities,I);this.loggerRecv.warn("[Subscribe] 获取本地sdp, mid =",E.mid,"id = ",S);let{rtpCapabilities:x,offer:D}=E,F=E.mid;const V=E.dtlsParameters;F=typeof F=="number"&&F<0?void 0:""+F;const N=D.sdp.match(/a=ice-ufrag:([0-9a-zA-Z=#+-_\/\\\\]+)/);if(!N)throw new u.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"_createConsumer: iceUfragRegRemote 为空"});let L={requestId:""+Math.ceil(1e9*Math.random()),kind:M,rtpCapabilities:x,uid:new T.SimpleBig(I),producerId:S,preferredSpatialLayer:0,mid:F,pause:!1,iceUfrag:N[1],audioAslFlag:this.adapterRef.audioAsl.enabled==="yes"&&m.getParameters().audioAslFlag,appData:{enableTcpCandidate:!0}};if(V===void 0?L.transportId=y.id:L.dtlsParameters=V,this.loggerRecv.log(`[Subscribe] 发送consume请求, uid: ${I}, kind: ${M}, mediaTypeShort: ${P}, producerId: ${L.producerId}, transportId: ${L.transportId}, requestId: ${L.requestId}`),!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw new u.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"[Subscribe] createConsumer: _protoo 未找到"});const U=this.adapterRef._signalling._protoo;let H=null;try{H=await this.adapterRef._signalling._protoo.request("Consume",L)}catch(ae){throw ae.message==="request timeout"&&this.adapterRef._signalling._protoo.id===U.id?(this.logger.error(`[Subscribe] Consume消息Timeout, 尝试信令重连: ${ae.name}/${ae.message}, 当前的连接状态: ${this.adapterRef.connectState.curState}, 原始请求: `,O.JSONBigStringify(L)),this.adapterRef.channelStatus="connectioning",this.adapterRef._signalling.reconnectionReason=s.ReconnectReason.ConsumeRequestTimeout,this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"consumeRequestTimeout",ext:""}),this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startWssTime=Date.now(),this.adapterRef._signalling._reconnection()):this.logger.error(`[Subscribe] Consume消息错误: ${ae.name}/${ae.message}, 当前的连接状态：${this.adapterRef.connectState.curState}, 原始请求：`,O.JSONBigStringify(L)),new u.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"[Subscribe] createConsumer: Consume 消息错误:"+ae.message})}let{transportId:j,iceParameters:W,iceCandidates:Y,dtlsParameters:te,probeSSrc:re,rtpParameters:G,turnParameters:K,producerId:de,consumerId:B,code:$,errMsg:z}=H;if(this.loggerRecv.log(`[Subscribe] consume反馈结果 code: ${$} uid: ${I}, mid: ${G&&G.mid}, kind: ${M}, producerId: ${de}, consumerId: ${B}, transportId: ${j}, requestId: ${H.requestId}, errMsg: ${z}`),K){let ae=[];ae.push({urls:"turn:"+K.ip+":"+K.port+"?transport=udp",credential:K.password,username:K.username},{urls:"turn:"+K.ip+":"+K.port+"?transport=tcp",credential:K.password,username:K.username}),await y.updateIceServers({iceServers:ae})}const ie=H.uid;G&&G.encodings&&G.encodings.length&&G.encodings[0].ssrc&&this.adapterRef.instance.addSsrc(I,P,G.encodings[0].ssrc),j!==void 0&&(y._id=j),re!==void 0&&(this._probeSSrc=re),G&&G.mid!=null&&(G.mid=G.mid+"");let Z=Y;this.adapterRef.channelInfo.iceProtocol&&Y&&(this.logger.warn("[Subscribe] Consume iceProtocol: ",this.adapterRef.channelInfo.iceProtocol),Z=Y.filter(ae=>ae.protocol==this.adapterRef.channelInfo.iceProtocol));let ee=null;P!=="audio"&&P!=="audioSlave"||(ee={opusStereo:1});const ce=await y.consume({id:B||de||S,producerId:de||S,kind:M,mediaType:P,uid:I||ie,rtpParameters:G,codecOptions:ee,appData:{peerId:ie,remoteUid:I,mid:F},offer:D,iceParameters:W,iceCandidates:Z,dtlsParameters:te,sctpParameters:void 0,probeSSrc:this._probeSSrc});if(this._consumers[ce.id]=ce,ce.on("transportclose",()=>{this._consumers&&delete this._consumers[ce.id]}),this.loggerRecv.log("[Subscribe] 订阅consume完成 peerId =",ie),this.adapterRef.instance.apiEventReport("setFunction",{name:`set_${P}_sub`,oper:"1",value:O.JSONBigStringify({remoteUid:I,code:$,reason:z||"",preferredSpatialLayer:0,consumerId:B||"",producerId:de||S},null," ")}),b&&b.pubStatus[P].producerId){if(b.subStatus[P]=!0,b.pubStatus[P][P]=!0,b.pubStatus[P].consumerId=B,b.pubStatus[P].producerId=de,b.getMuteStatus(P).muted){this.loggerRecv.log(`[Subscribe] 远端流处于mute状态：uid ${b.getId()}, ${P}, ${O.JSONBigStringify(b.getMuteStatus(P))}`);const ae=b.getMuteStatus(P);ae.send&&this.loggerRecv.log(`[Subscribe] 远端流把自己mute了：uid ${b.getId()}, ${P}, ${O.JSONBigStringify(ae)}`),ae.recv&&(this.loggerRecv.log(`[Subscribe] 本端把远端流mute了：uid ${b.getId()}, ${P}, ${O.JSONBigStringify(ae)}`),ce.track.enabled=!1)}else ce.track.enabled=!0;b.mediaHelper.updateStream(P,ce.track),this.adapterRef.instance.safeEmit("@pairing-createConsumer-success"),P==="audio"?this.adapterRef.state.signalAudioSubscribedTime<this.adapterRef.state.signalOpenTime&&(this.adapterRef.state.signalAudioSubscribedTime=Date.now()):P==="video"&&this.adapterRef.state.signalVideoSubscribedTime<this.adapterRef.state.signalOpenTime&&(this.adapterRef.state.signalVideoSubscribedTime=Date.now()),this.adapterRef.instance.safeEmit("stream-subscribed",{stream:b,mediaType:P})}else this.adapterRef.instance.safeEmit("@pairing-createConsumer-error"),this.loggerRecv.log("[Subscribe] 该次consume状态错误: ",O.JSONBigStringify(b.pubStatus,null,""))}async destroyConsumer(I,M,P){var S,y;if(I)try{const _=this._consumers[I];if(!_)return void this.loggerRecv.log("跳过停止订阅 destroyConsumer consumerId=",I,M==null?void 0:M.streamID);if(this.loggerRecv.log("停止订阅 destroyConsumer consumerId=",I,M==null?void 0:M.streamID),delete this._consumers[I],h.ANY_CHROME_MAJOR_VERSION&&h.ANY_CHROME_MAJOR_VERSION<69){let b=M.streamID.toString();this.consumerMap.get(b).subStatus[P]=!1,this.consumerMap.get(b)[R.get(P)[0]].close(),this.consumerMap.get(b)[R.get(P)[0]]=null;let E=this.consumerMap.get(b)[R.get(P)[1]];E&&clearTimeout(E),E=null;let x=`${b}_${P}`;this._usedUidMediaTypes[x]=!1}try{await((y=(S=this.adapterRef._signalling)===null||S===void 0?void 0:S._protoo)===null||y===void 0?void 0:y.request("CloseConsumer",{requestId:""+Math.ceil(1e9*Math.random()),consumerId:I,producerId:_.producerId})),await _.close(),M&&P&&this.adapterRef.instance.safeEmit("@stream-unsubscribed",{stream:M,mediaType:P}),this.adapterRef.instance.apiEventReport("setFunction",{name:`set_${P}_sub`,oper:"0",value:O.JSONBigStringify({code:200,remoteUid:M==null?void 0:M.stringStreamID,consumerId:I||""},null," ")})}catch(b){this.logger.error("CloseConsumer失败",b.name,b.message,b)}}catch(_){this.loggerRecv.error("destroyConsumer() | failed:",_.name,_.message,_.stack)}}async closeTransport(I){var M,P;if(I&&I.id)try{this.logger.log(`closeTransport() [停止通道 transportId= ${I.id}]`);const S=await((P=(M=this.adapterRef._signalling)===null||M===void 0?void 0:M._protoo)===null||P===void 0?void 0:P.request("CloseTransport",{requestId:""+Math.ceil(1e9*Math.random()),transportId:I.id}));this.logger.log(`closeTransport() [停止通道反馈结果 result=${O.JSONBigStringify(S,null," ")}]`),I.close()}catch(S){this.logger.error("closeTransport() | failed:",S.name,S.message)}}async muteAudio(){var I,M,P,S;this.loggerSend.log("mute音频"),(I=this._micProducer)===null||I===void 0||I.pause();try{await((P=(M=this.adapterRef._signalling)===null||M===void 0?void 0:M._protoo)===null||P===void 0?void 0:P.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new T.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:(S=this._micProducer)===null||S===void 0?void 0:S.id,mute:!0}}}))}catch(y){this.loggerSend.error("muteAudio() | failed:",y.name,y.message,y)}}async unmuteAudio(){var I,M,P,S;this.loggerSend.log("unmute音频"),(I=this._micProducer)===null||I===void 0||I.resume();try{await((P=(M=this.adapterRef._signalling)===null||M===void 0?void 0:M._protoo)===null||P===void 0?void 0:P.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new T.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:(S=this._micProducer)===null||S===void 0?void 0:S.id,mute:!1}}}))}catch(y){return this.loggerSend.error("unmuteAudio() | failed: ",y.name,y.message),Promise.reject(y)}}async muteAudioSlave(){var I,M,P,S;this.loggerSend.log("mute音频辅流"),(I=this._audioSlaveProducer)===null||I===void 0||I.pause();try{await((P=(M=this.adapterRef._signalling)===null||M===void 0?void 0:M._protoo)===null||P===void 0?void 0:P.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new T.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:(S=this._audioSlaveProducer)===null||S===void 0?void 0:S.id,mute:!0}}}))}catch(y){this.loggerSend.error("muteAudioSlave() | failed:",y.name,y.message)}}async unmuteAudioSlave(){var I,M,P,S;this.loggerSend.log("unmute音频辅流"),(I=this._audioSlaveProducer)===null||I===void 0||I.resume();try{await((P=(M=this.adapterRef._signalling)===null||M===void 0?void 0:M._protoo)===null||P===void 0?void 0:P.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new T.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:(S=this._audioSlaveProducer)===null||S===void 0?void 0:S.id,mute:!1}}}))}catch(y){return this.loggerSend.error("unmuteAudioSlave() | failed: ",y.name,y.message),Promise.reject(y)}}async muteVideo(){var I,M,P,S;this.loggerSend.log("mute视频"),(I=this._webcamProducer)===null||I===void 0||I.pause();try{await((P=(M=this.adapterRef._signalling)===null||M===void 0?void 0:M._protoo)===null||P===void 0?void 0:P.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new T.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:(S=this._webcamProducer)===null||S===void 0?void 0:S.id,mute:!0}}}))}catch(y){this.loggerSend.error("muteVideo() | failed:",y.name,y.message)}}async unmuteVideo(){var I,M,P,S;this.loggerSend.log("unmute视频"),(I=this._webcamProducer)===null||I===void 0||I.resume();try{await((P=(M=this.adapterRef._signalling)===null||M===void 0?void 0:M._protoo)===null||P===void 0?void 0:P.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new T.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:(S=this._webcamProducer)===null||S===void 0?void 0:S.id,mute:!1}}}))}catch(y){this.loggerSend.error("unmuteVideo() | failed:",y.name,y.message)}}async muteScreen(){var I,M,P,S;this.loggerSend.log("mute屏幕共享"),(I=this._screenProducer)===null||I===void 0||I.pause();try{await((P=(M=this.adapterRef._signalling)===null||M===void 0?void 0:M._protoo)===null||P===void 0?void 0:P.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new T.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:(S=this._screenProducer)===null||S===void 0?void 0:S.id,mute:!0}}}))}catch(y){this.loggerSend.error("muteScreen() | failed: ",y.name,y.message)}}async unmuteScreen(){var I,M,P,S;this.loggerSend.log("unmute屏幕共享"),(I=this._screenProducer)===null||I===void 0||I.resume();try{await((P=(M=this.adapterRef._signalling)===null||M===void 0?void 0:M._protoo)===null||P===void 0?void 0:P.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new T.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:(S=this._screenProducer)===null||S===void 0?void 0:S.id,mute:!1}}}))}catch(y){this.loggerSend.error("unmuteScreen() | failed:",y.name,y.message)}}async startAsrCaptions(I,M){var P,S;this.loggerSend.log("startAsrCaptions() 开启实时字幕信令");try{const y=await((S=(P=this.adapterRef._signalling)===null||P===void 0?void 0:P._protoo)===null||S===void 0?void 0:S.request("StartAsrCaptions",{uid:new T.SimpleBig(this.adapterRef.channelInfo.uid),requestId:""+Math.ceil(1e9*Math.random()),externData:{asrInfo:{srcLan:I,dstLan:M}}}));if((y==null?void 0:y.code)!==200)throw y;return this.adapterRef.instance.apiEventReport("setAsrCaptions",{oper:"start",value:JSON.stringify({code:0,uid:this.adapterRef.channelInfo.uid,externData:{asrInfo:{srcLan:I,dstLan:M}}})}),!!y}catch(y){throw this.loggerSend.error("startAsrCaptions() | failed:",y.code,y.errMsg),new u.default({code:d.default.ASR_CAPTIONS_ERROR,message:"实时字幕开启失败, code: "+y.code+", errMsg: "+y.errMsg})}}async stopAsrCaptions(){var I,M,P;this.loggerSend.log("stopAsrCaptions() 关闭实时字幕信令");try{const S=await((M=(I=this.adapterRef._signalling)===null||I===void 0?void 0:I._protoo)===null||M===void 0?void 0:M.request("StopAsrCaptions",{uid:new T.SimpleBig(this.adapterRef.channelInfo.uid),requestId:""+Math.ceil(1e9*Math.random())}));if((S==null?void 0:S.code)!==200)throw S;return this.adapterRef.instance.apiEventReport("setAsrCaptions",{oper:"stop",value:JSON.stringify({code:0,uid:(P=this.adapterRef.localStream)===null||P===void 0?void 0:P.stringStreamID})}),!!S}catch(S){throw this.loggerSend.error("stopAsrCaptions() | failed:",S.code,S.errMsg),new u.default({code:d.default.ASR_CAPTIONS_ERROR,message:"关闭实时字幕失败, code: "+S.code+", errMsg: "+S.errMsg})}}async setMpsNotify(I,M){var P,S;this.loggerSend.log("setMpsNotify",I,JSON.stringify(M));try{const y=await((S=(P=this.adapterRef._signalling)===null||P===void 0?void 0:P._protoo)===null||S===void 0?void 0:S.request("SendUserData",{externData:{type:"MpsNotify",cid:this.adapterRef.channelInfo.cid,uid:new T.SimpleBig(this.adapterRef.channelInfo.uid),dstUid:new T.SimpleBig(M.dstUid),data:{action:I,dstUid:new T.SimpleBig(M.dstUid)}}}));if(y.code!==200)throw this.logger.error(`setMpsNotify: ${y.errMsg}. Code: ${y.code}`),y;return!0}catch(y){throw this.loggerSend.error("setMpsNotify() | failed:",y.name,y.message),y}}async updateUserRole(I){var M,P;this.loggerSend.log("updateUserRole() 更新用户角色为"+I);try{const S=await((P=(M=this.adapterRef._signalling)===null||M===void 0?void 0:M._protoo)===null||P===void 0?void 0:P.request("SendUserData",{externData:{type:"UserRole",cid:this.adapterRef.channelInfo.cid,uid:new T.SimpleBig(this.adapterRef.channelInfo.uid),data:{userRole:I}}}));return S!==200&&this.logger.error(`UpdateUserRole:${S.errMsg}. Code: ${S.code}`),S}catch(S){throw this.loggerSend.error("updateUserRole() failed:",S.name,S.message),S}}async getIceStatus(I="send"){var M,P,S,y;const _=Date.now(),b={ts:Date.now(),direction:I,iceConnectionState:"uninit",info:"",stuckTime:-1,elapse:-1};let E;if(E=I==="send"?(P=(M=this._sendTransport)===null||M===void 0?void 0:M._handler)===null||P===void 0?void 0:P._pc:(y=(S=this._recvTransport)===null||S===void 0?void 0:S._handler)===null||y===void 0?void 0:y._pc,E){if(b.info+="#"+E.pcid,b.iceConnectionState=E.iceConnectionState,b.info+="|iceConnectoinState "+E.iceConnectionState,E.iceStartedAt&&(b.elapse=_-E.iceStartedAt),this.iceStatusHistory[I].promises[0]&&(this.iceStatusHistory[I].promises[0](null),this.iceStatusHistory[I].promises=[]),E.iceConnectionState==="checking"){if(E.iceStartedAt||(E.iceStartedAt=_),await new Promise(N=>{this.iceStatusHistory[I].promises=[N],setTimeout(N,3e3)}),E.iceConnectionState!=="checking")return b;b.elapse=Date.now()-E.iceStartedAt}E.iceConnectionState!=="connected"&&E.iceConnectionState!=="completed"||(E.iceConnectedAt||(E.iceConnectedAt=_),await new Promise(N=>{this.iceStatusHistory[I].promises=[N],setTimeout(N,100)}));let x=null;try{let N=Date.now(),L=null;if(I==="send"){let H=E.getSenders()[0];H!=null&&H.track&&(L=H.track)}else{let H=E.getReceivers()[0];H!=null&&H.track&&(L=H.track)}let U=E.getStats(L);b.stuckTime=Date.now()-N,x=await U}catch{}const D=[],F=[];let V=Date.now();x&&x.forEach((N,L)=>{D.push(N),N.type==="transport"&&F.push(N)}),F.length||(b.info+="|no transport stats"),F.forEach(N=>{var L,U;const H=D.find(j=>j.id===N.selectedCandidatePairId);if(H){const j=D.find(Y=>Y.id===H.localCandidateId);j?(b.info+=`|local:${j.protocol} `,b.info+=`${j.address||"NOADDRESS"}:${j.port||"NOPORT"} ${j.candidateType} ${j.networkType||""}`,b.networkType=j.networkType,b.protocol=j.protocol,b.relayProtocol=j.relayProtocol,b.ip=j.ip,b.address=j.address,((U=(L=this.adapterRef._statsReport)===null||L===void 0?void 0:L.stats)===null||U===void 0?void 0:U.chromeLegecy)==="unsupported"&&(this.adapterRef.transportStats.NetworkType=j.networkType)):b.info+="|无法找到localCandidate "+H.localCandidateId;const W=D.find(Y=>Y.id===H.remoteCandidateId);W?(b.info+=`|remote:${W.protocol} `,b.info+=`${W.address||"NOADDRESS"}:${W.port||"NOPORT"} ${W.candidateType}`):b.info+="|无法找到remoteCandidate "+H.remoteCandidateId}else b.info+="无法找到candidatePair "+N.selectedCandidatePairId}),b.stuckTime+=Date.now()-V}else b.info="no_pc_"+I;if(this.iceStatusHistory[I].status.info!==b.info&&b.iceConnectionState!=="new"&&this._mediasoupDevice){const x={new:1,checking:2,connected:3,completed:4,failed:-1,disconnected:-2,closed:-3},D=x[b.iceConnectionState||0]||0;D>0?(this.adapterRef.logger.log("iceConnectionStateChanged",I,b.info),D===x.connected&&I==="recv"&&this.adapterRef.state.iceRecvConnectedTime<this.adapterRef.state.signalJoinResTime&&(this.adapterRef.state.iceRecvConnectedTime=Date.now())):this.adapterRef.logger.warn("iceConnectionStateChanged",I,b.info),this.adapterRef.instance.apiFrequencyControl({name:"_iceStateChange_"+I,code:D,param:O.JSONBigStringify(b)}),this.adapterRef.instance.safeEmit("@ice-change",b)}return this.iceStatusHistory[I].status=b,b}getReceivers(I={}){const M=[];for(let P in this.adapterRef.remoteStreamMap){const S=this.adapterRef.remoteStreamMap[P];I.uid&&I.uid.toString()!==P||s.MediaTypeList.forEach(y=>{if(I.mediaType&&I.mediaType!==y||!S.active||!S.pubStatus[y].consumerId)return;const _=this._consumers[S.pubStatus[y].consumerId];_&&M.push({uid:P,mediaType:y,remoteStream:S,consumer:_})})}return M}clearConsumerMap(){this.consumerMap.forEach((I,M)=>{I._recvTransportMainAudio&&I._recvTransportMainAudio.close(),I._recvTransportMainVideo&&I._recvTransportMainVideo.close(),I._recvTransportSubAudioSlave&&I._recvTransportSubAudioSlave.close(),I._recvTransportSubScreen&&I._recvTransportSubScreen.close(),I._recvTransportMainAudioTimeoutTimer&&(clearTimeout(I._recvTransportMainAudioTimeoutTimer),I._recvTransportMainAudioTimeoutTimer=null),I._recvTransportMainVideoTimeoutTimer&&clearTimeout(I._recvTransportMainVideoTimeoutTimer),I._recvTransportMainVideoTimeoutTimer=null,I._recvTransportSubAudioSlaveTimeoutTimer&&clearTimeout(I._recvTransportSubAudioSlaveTimeoutTimer),I._recvTransportSubAudioSlaveTimeoutTimer=null,I._recvTransportSubScreenTimeoutTimer&&clearTimeout(I._recvTransportSubScreenTimeoutTimer),I._recvTransportSubScreenTimeoutTimer=null}),this.consumerMap.clear()}destroy(){this.logger.log("清除 meidasoup"),this._reset(),h.ANY_CHROME_MAJOR_VERSION&&h.ANY_CHROME_MAJOR_VERSION<69&&this.clearConsumerMap()}}e.Mediasoup=w},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.waitForEvent=void 0,e.waitForEvent=async function(i,a,l){return new Promise((n,c)=>{let s;const d=u=>{s&&clearTimeout(s),n(u)};l&&(s=setTimeout(()=>{i.removeListener(a,d),c(`timed out after ${l}ms:${a}`)},l)),i.once(a,d)})}},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(S,y,_,b){b===void 0&&(b=_),Object.defineProperty(S,b,{enumerable:!0,get:function(){return y[_]}})}:function(S,y,_,b){b===void 0&&(b=_),S[b]=y[_]}),a=this&&this.__setModuleDefault||(Object.create?function(S,y){Object.defineProperty(S,"default",{enumerable:!0,value:y})}:function(S,y){S.default=y}),l=this&&this.__importStar||function(S){if(S&&S.__esModule)return S;var y={};if(S!=null)for(var _ in S)_!=="default"&&Object.prototype.hasOwnProperty.call(S,_)&&i(y,S,_);return a(y,S),y},n=this&&this.__importDefault||function(S){return S&&S.__esModule?S:{default:S}};Object.defineProperty(e,"__esModule",{value:!0}),e.Chrome74=void 0;const c=l(r(50)),s=n(r(6)),d=n(r(8)),u=r(43),h=r(1),o=r(29),f=l(r(79)),m=l(r(27)),g=r(87),v=l(r(88)),O=r(138),T=l(r(148)),C=r(89),A=r(139),R=r(149),{generateRandomNumber:w}=r(27),k="Chrome_",I={OS:1024,MIS:1024};let M=0;class P extends g.HandlerInterface{constructor(){super(),this._sendingRemoteRtpParametersByKind={},this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._transportReady=!1,this._appData={},this.senderStream={main:new MediaStream,slave:new MediaStream}}static createFactory(){return()=>new P}get name(){return"Chrome74"}get remoteSdp(){return this._remoteSdp}close(){if(o.Logger.debug(k,"close()"),this._pc)try{this._pc.onconnectionstatechange=null,this._pc.close()}catch{}}async getNativeRtpCapabilities(){return R.getNativeRtpCapabilities()}async getNativeSctpCapabilities(){return o.Logger.debug(k,"getNativeSctpCapabilities()"),{numStreams:I}}run({direction:y,iceParameters:_,iceCandidates:b,dtlsParameters:E,sctpParameters:x,iceServers:D,iceTransportPolicy:F,additionalSettings:V,proprietaryConstraints:N,extendedRtpCapabilities:L,appData:U}){o.Logger.debug(k,"run()"),this._appData=U,this._direction=y,this._sendingRtpParametersByKind={audio:f.getSendingRtpParameters("audio",L),video:f.getSendingRtpParameters("video",L)},this._sendingRemoteRtpParametersByKind={audio:f.getSendingRemoteRtpParameters("audio",L),video:f.getSendingRemoteRtpParameters("video",L)},o.Logger.debug(k,"iceServers: ",D==null?void 0:D.length);const H={iceServers:D||[],iceTransportPolicy:F||"all",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",iceCandidatePoolSize:10};U.encodedInsertableStreams&&(H.encodedInsertableStreams=!0),this._pc=new RTCPeerConnection(H,N),this._pc.pcid=M++,this._pc.onconnectionstatechange=j=>{switch(o.Logger.debug(k,"onconnectionstatechange connectionState: ",this._pc.connectionState),this._pc.connectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}},this._pc.onicegatheringstatechange=j=>{o.Logger.debug(k,"icegatheringstatechange iceGatheringState: ",this._pc.iceGatheringState),this.emit("@icegatheringstatechange",this._pc.iceGatheringState)},this._pc.onicecandidate=j=>{j.candidate&&o.Logger.debug(k,"onicecandidate: ",JSON.stringify(j.candidate,null," "))},this._pc.onicecandidateerror=j=>{o.Logger.warn(k,"onicecandidateerror: ",j)}}async updateIceServers(y){o.Logger.debug(k,"updateIceServers(): ");const _=this._pc.getConfiguration();_.iceServers=y,this._pc.setConfiguration(_)}async restartIce(y){if(o.Logger.debug(k,"restartIce()"),this._remoteSdp.updateIceParameters(y),this._transportReady)if(this._direction){const _=await this._pc.createOffer({iceRestart:!0});let b=c.parse(_.sdp);b.media.forEach(x=>{x.type==="audio"&&this._direction==="send"&&x.ext&&x.rtcpFb&&(x.ext=x.ext.filter(D=>D.uri.indexOf("transport-wide-cc")==-1&&D.uri.indexOf("abs-send-time")==-1),x.rtcpFb.push({payload:111,type:"nack"}))}),_.sdp=c.write(b),o.Logger.debug(k,"restartIce() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(_);const E={type:"answer",sdp:this._remoteSdp.getSdp()};o.Logger.debug(k,"restartIce() | calling pc.setRemoteDescription() [answer]"),await this._pc.setRemoteDescription(E)}else{const _={type:"offer",sdp:this._remoteSdp.getSdp()};o.Logger.debug(k,"restartIce() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(_);const b=await this._pc.createAnswer();o.Logger.debug(k,"restartIce() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(b)}}async getTransportStats(){return this._pc.getStats()}async send({track:y,trackLow:_,encodings:b,codecOptions:E,codec:x,appData:D}){this._assertSendDirection(),o.Logger.debug(k,`publish() send() [kind: ${y.kind}, track.id: ${y.id}, appData: ${JSON.stringify(D)}]`),b&&b.length>1&&b.forEach((K,de)=>{K.rid="r"+de});const F=m.clone(this._sendingRtpParametersByKind[y.kind],{});let V,N={},L={};V=D.mediaType==="audio"||D.mediaType==="video"?this.senderStream.main:this.senderStream.slave,D.mediaType==="audio"&&this._pc.audioSender?(o.Logger.debug(k,"publish() audioSender 更新 track: ",this._pc.audioSender.track,"=>",y),this._pc.audioSender.replaceTrack(y)):D.mediaType==="audioSlave"&&this._pc.audioSlaveSender?(o.Logger.debug(k,"publish() audioSlaveSender 更新 track: ",this._pc.audioSlaveSender.track,"=>",y),this._pc.audioSlaveSender.replaceTrack(y)):D.mediaType==="video"&&this._pc.videoSender?(o.Logger.debug(k,"publish() videoSender 更新 track: ",this._pc.videoSender.track,"=>",y),this._pc.videoSender.replaceTrack(y),this._pc.videoSenderLow&&this._pc.videoSenderLow.track!==_&&(o.Logger.debug(k,"publish() videoSenderLow 更新 track: ",this._pc.videoSenderLow),this._pc.videoSenderLow.replaceTrack(_))):D.mediaType==="screenShare"&&this._pc.screenSender?(o.Logger.debug(k,"publish() screenSender 更新 track: ",this._pc.screenSender.track,"=>",y),this._pc.screenSender.replaceTrack(y),this._pc.screenSenderLow&&this._pc.screenSenderLow.track!==_&&(o.Logger.debug(k,"publish() screenSenderLow 更新 track: ",this._pc.screenSenderLow),this._pc.screenSenderLow.replaceTrack(_))):(V.addTrack(y),N=this._pc.addTransceiver(y,{direction:"sendonly",streams:[V]}),_&&(L=this._pc.addTransceiver(_,{direction:"sendonly",streams:[this._sendStream]})),D.mediaType!=="audio"||this._pc.audioSender?D.mediaType!=="audioSlave"||this._pc.audioSlaveSender?D.mediaType!=="video"||this._pc.videoSender?D.mediaType!=="screenShare"||this._pc.screenSender||(this._pc.screenSender=N.sender,this._pc.screenSenderLow=L.sender):(this._pc.videoSender=N.sender,this._pc.videoSenderLow=L.sender):this._pc.audioSlaveSender=N.sender:this._pc.audioSender=N.sender),o.Logger.debug(k,`publish() [transceivers: ${this._pc.getTransceivers().length}]`);let U=await this._pc.createOffer(),H=c.parse(U.sdp);D.preferRemb&&C.filterTransportCCFromSdp(H);let j,W,Y;const te=H.media.filter(K=>{const de=this._mapMidTransceiver.get(""+K.mid);return K.type===y.kind&&(!(de&&de.sender&&de.sender.track)||(de.sender.track.id===y.id?(j=K,!1):!_||de.sender.track.id!==_.id||(W=K,!1)))});j||(j=te.pop()),_&&!W&&(W=te.pop()),this._transportReady||(Y=await this._setupTransport({localDtlsRole:"server",localSdpObject:H}));let re=j==null?void 0:j.mid;if(typeof re=="number"&&(re=""+re),!re)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"publish() Chrome.send: localId 未找到"});let G=null;if(W&&(G=""+W.mid),F.mid=re,F.rtcp.cname=v.getCname({offerMediaObject:j}),b)if(b.length===1){let K=T.getRtpEncodings({offerMediaObject:j});Object.assign(K[0],b[0]),F.encodings=K}else F.encodings=b;else F.encodings=[],W&&(F.encodings=F.encodings.concat(T.getRtpEncodings({offerMediaObject:W}))),F.encodings=F.encodings.concat(T.getRtpEncodings({offerMediaObject:j}));return F.encodings.length>1&&(F.codecs[0].mimeType.toLowerCase()==="video/vp8"||F.codecs[0].mimeType.toLowerCase()==="video/h264")&&H.media.forEach(K=>{K.type==="audio"&&K.ext&&K.rtcpFb&&(K.ext=K.ext.filter(de=>de.uri.indexOf("transport-wide-cc")==-1&&de.uri.indexOf("abs-send-time")==-1),K.rtcpFb.push({payload:111,type:"nack"}))}),U.sdp=c.write(H),this._mapMidTransceiver.set(re,N),G&&this._mapMidTransceiver.set(G,L),{localId:re,localIdLow:G,rtpParameters:F,rtpSender:N.sender,rtpSenderLow:L.sender||null,dtlsParameters:Y,offer:U}}async fillRemoteRecvSdp({kind:y,iceParameters:_,iceCandidates:b,dtlsParameters:E,sctpParameters:x,sendingRtpParameters:D,codecOptions:F,offer:V,audioProfile:N,codec:L,resetVideoSdp:U,appData:H}){o.Logger.debug(k,"publish() fillRemoteRecvSdp() | calling pc.setLocalDescription(), appData: ",JSON.stringify(H)),await this._pc.setLocalDescription(V),this._remoteSdp||(this._remoteSdp=new O.RemoteSdp({iceParameters:_,iceCandidates:b,dtlsParameters:E,sctpParameters:x}),this._remoteSdp.updateDtlsRole("client"));const j=m.clone(this._sendingRemoteRtpParametersByKind[y]);H.preferRemb?(o.Logger.debug(k,"publish() fillRemoteRecvSdp() |  使用REMB作为带宽估计方式"),C.filterTransportCCFromRtpParameters(j)):(o.Logger.debug(k,"publish() fillRemoteRecvSdp() |  使用transport-cc作为带宽估计方式"),C.filterRembFromRtpParameters(j)),j.codecs=u.reduceCodecs(j.codecs,L);let W=c.parse(this._pc.localDescription.sdp),Y=this._remoteSdp.getNextMediaSectionIdx();U&&(D.mid?D.encodings&&D.encodings.length>1?Y.idx=Number(D.mid)-(D.encodings.length-1):Y.idx=Number(D.mid):o.Logger.warn(k,"publish() fillRemoteRecvSdp() | mid 未找到"),Y.reuseMid=!0);let te=W.media[Y.idx],re=null;D.encodings&&D.encodings.length>1&&(re=W.media[Y.idx+1]),this._remoteSdp.send({offerMediaObjectArr:[te,re],reuseMid:Y.reuseMid,offerRtpParameters:D,answerRtpParameters:j,codecOptions:F,extmapAllowMixed:!0});const G={type:"answer",sdp:this._remoteSdp.getSdp()};if(o.Logger.debug(k,"publish() audioProfile设置为: ",N),N){let K=null;switch(N){case"speech_low_quality":K="maxplaybackrate=16000;sprop-maxcapturerate=16000;maxaveragebitrate=32000";break;case"speech_standard":K="maxplaybackrate=32000;sprop-maxcapturerate=32000;maxaveragebitrate=36000";break;case"music_standard":K="maxplaybackrate=48000;sprop-maxcapturerate=48000;";break;case"standard_stereo":K="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=56000";break;case"high_quality":K="maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=128000";break;case"high_quality_stereo":K="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=192000"}G.sdp.indexOf("a=fmtp:111")&&(G.sdp=G.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;useinbandfec=1;"+K)),G.sdp=G.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=maxptime:60")}o.Logger.debug(k,"publish() fillRemoteRecvSdp() | calling pc.setRemoteDescription()"),h.getParameters().enableUdpCandidate||(G.sdp=G.sdp.replace(/\r\na=candidate:udpcandidate[^\r]+/g,"")),h.getParameters().enableTcpCandidate||(G.sdp=G.sdp.replace(/\r\na=candidate:tcpcandidate[^\r]+/g,"")),await this._pc.setRemoteDescription(G)}async stopSending(y,_){this._assertSendDirection(),o.Logger.debug(k,`[unpublish] stopSending() [kind: ${_}, localId: ${y}]`);const b=this._mapMidTransceiver.get(y);_==="audio"?this._pc.audioSender.replaceTrack(null):_==="audioSlave"?this._pc.audioSlaveSender.replaceTrack(null):_==="video"?(this._pc.videoSender.replaceTrack(null),this._pc.videoSenderLow&&this._pc.videoSenderLow.replaceTrack(null)):_==="screenShare"?(this._pc.screenSender.replaceTrack(null),this._pc.screenSenderLow&&this._pc.screenSenderLow.replaceTrack(null)):b==null||b.sender.replaceTrack(null);const E=await this._pc.createOffer();let x=c.parse(E.sdp);x.media.forEach(F=>{F.type==="audio"&&F.ext&&F.rtcpFb&&(F.ext=F.ext.filter(V=>V.uri.indexOf("transport-wide-cc")==-1&&V.uri.indexOf("abs-send-time")==-1),F.rtcpFb.push({payload:111,type:"nack"}))}),E.sdp=c.write(x),o.Logger.debug(k,"[unpublish]stopSending() | calling pc.setLocalDescription()");try{await this._pc.setLocalDescription(E)}catch(F){o.Logger.debug(k,"setLocalDescription error: ",F.message)}const D={type:"answer",sdp:this._remoteSdp.getSdp()};o.Logger.debug(k,"[unpublish]stopSending() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(D)}async replaceTrack(y,_){this._assertSendDirection(),_?o.Logger.debug(k,"replaceTrack() [localId:%s, track.id:%s]",y,_.id):o.Logger.debug(k,"replaceTrack() [localId:%s, no track]",y);const b=this._mapMidTransceiver.get(y);await(b==null?void 0:b.sender.replaceTrack(_))}async setMaxSpatialLayer(y,_){this._assertSendDirection(),o.Logger.debug(k,"setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",y,_);const b=this._mapMidTransceiver.get(y),E=b==null?void 0:b.sender.getParameters();E.encodings.forEach((x,D)=>{x.active=D<=_}),await(b==null?void 0:b.sender.setParameters(E))}async setRtpEncodingParameters(y,_){this._assertSendDirection(),o.Logger.debug(k,"setRtpEncodingParameters() [localId:%s, params:%o]",y,_);const b=this._mapMidTransceiver.get(y);if(!b)return;const E=b.sender.getParameters();E.encodings.forEach((x,D)=>{E.encodings[D]=Object.assign(Object.assign({},x),_)}),await b.sender.setParameters(E)}async getSenderStats(y){this._assertSendDirection();const _=this._mapMidTransceiver.get(y);if(!_)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"Chrome.getSenderStats: RTCRtpTransceiver 未找到"});return _.sender.getStats()}async recoverTransceiver(y,_,b){o.Logger.debug(k,"recoverTransceiver() [kind:%s, remoteUid:%s, mid: %s]",b,y,_);const E=this._mapMidTransceiver.get(_);E?E.isUseless=!0:o.Logger.debug(k,"recoverTransceiver() transceiver undefined")}async prepareLocalSdp(y,_){o.Logger.debug(k,`[Subscribe] prepareLocalSdp() [kind: ${y}, remoteUid: ${_}]`);let b,E=-1;if(h.getParameters().reuseMid)for(const N of this._mapMidTransceiver.keys()){const L=this._mapMidTransceiver.get(N);if(!L)continue;const U=L.receiver&&L.receiver.track&&L.receiver.track.kind||y;if(L.isUseless&&U===y){E=N-0,L.isUseless=!1;break}}let x=null;if(E===-1){if(o.Logger.debug(k,"[Subscribe] prepareLocalSdp() 添加一个M行"),x=this._pc.addTransceiver(y,{direction:"recvonly"}),x.remoteUid=_,b=await this._pc.createOffer(),!b.sdp)throw o.Logger.error(k,"[Subscribe] prepareLocalSdp() offer没有sdp"),new Error("INVALID_OFFER");b.sdp.indexOf("a=rtcp-fb:111")&&b.sdp.indexOf("a=rtcp-fb:111 nack")===-1&&(b.sdp=b.sdp.replace(/(a=rtcp-fb:111.*)/,`$1\r
a=rtcp-fb:111 nack`)),b.sdp.indexOf("a=fmtp:111")&&(b.sdp=b.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z-]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1"))}else if(this._pc.localDescription)b={type:"offer",sdp:this._pc.localDescription.sdp};else{if(b=await this._pc.createOffer(),!b.sdp)throw o.Logger.error(k,"[Subscribe] prepareLocalSdp() offer没有sdp"),new Error("INVALID_OFFER");b.sdp.indexOf("a=rtcp-fb:111")&&b.sdp.indexOf("a=rtcp-fb:111 nack")===-1&&(b.sdp=b.sdp.replace(/(a=rtcp-fb:111.*)/,`$1\r
a=rtcp-fb:111 nack`)),b.sdp.indexOf("a=fmtp:111")&&(b.sdp=b.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z-]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1"));const N=c.parse(b.sdp);E=N.media[N.media.length-1].mid}if(!b.sdp)throw o.Logger.error(k,"[Subscribe] prepareLocalSdp() offer没有sdp"),new Error("INVALID_OFFER");const D=c.parse(b.sdp);let F;this._transportReady||(F=await this._setupTransport({localDtlsRole:"server",localSdpObject:D}));const V=v.extractRtpCapabilities({sdpObject:D});return A.addNackSuppportForOpus(V),E===-1&&(E=D.media[D.media.length-1].mid,this._mapMidTransceiver.set(""+E,x)),{dtlsParameters:F,rtpCapabilities:V,offer:b,mid:E,iceUfragReg:""}}async receive({iceParameters:y,iceCandidates:_,dtlsParameters:b,sctpParameters:E,trackId:x,kind:D,rtpParameters:F,offer:V,probeSSrc:N=-1,remoteUid:L,extendedRtpCapabilities:U,appData:H}){this._assertRecvDirection(),o.Logger.debug(k,`[Subscribe] receive() [trackId: ${x}, kind: ${D}, remoteUid: ${L}]`),this._remoteSdp||(this._remoteSdp=new O.RemoteSdp({iceParameters:y,iceCandidates:_,dtlsParameters:b,sctpParameters:E}),this._remoteSdp.updateDtlsRole("client"));let j=F&&F.mid||H.mid;if(o.Logger.debug(k,"[Subscribe] receive() mid: "+j),F==null?void 0:F.mid)this._remoteSdp.receive({mid:j,kind:D,offerRtpParameters:F,streamId:F.rtcp.cname,trackId:x});else{const te=x+"_"+w();o.Logger.debug(k,"[Subscribe] receive() 容错流程 trackId: ",te);const re=[];U.codecs.forEach(K=>{if(K.kind===D){const de=Object.assign({},K);de.parameters=de.parameters||de.localParameters,de.payloadType=de.payloadType||de.localPayloadType,re.push(de)}});const G={mid:j,kind:D,offerRtpParameters:{codecs:re,encodings:[{ssrc:0}],headerExtensions:[],rtcp:{},mid:j},streamId:D,trackId:te,reuseMediaSection:void 0};this._remoteSdp.receive(G),this._remoteSdp.disableMediaSection(""+j)}if(!V.sdp)throw o.Logger.error(k,"[Subscribe] prepareLocalSdp() offer没有sdp"),new Error("INVALID_OFFER");V.sdp.indexOf("a=fmtp:111")&&(V.sdp=V.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1"));const W={type:"answer",sdp:this._remoteSdp.getSdp()};W.sdp.indexOf("a=fmtp:111")&&(W.sdp=W.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1")),h.getParameters().enableSdpRrtr!=="chrome"&&h.getParameters().enableSdpRrtr!=="all"||(V.sdp=V.sdp.replace(/a=rtcp-fb:(\d+) rrtr ?\r\n/g,""),V.sdp=V.sdp.replace(/a=rtcp-fb:(\d+) nack ?\r\n/g,`a=rtcp-fb:$1 rrtr\r
a=rtcp-fb:$1 nack\r
`),W.sdp=W.sdp.replace(/a=rtcp-fb:(\d+) rrtr ?\r\n/g,""),W.sdp=W.sdp.replace(/a=rtcp-fb:(\d+) nack ?\r\n/g,`a=rtcp-fb:$1 rrtr\r
a=rtcp-fb:$1 nack\r
`)),h.getParameters().enableUdpCandidate||(W.sdp=W.sdp.replace(/\r\na=candidate:udpcandidate[^\r]+/g,"")),h.getParameters().enableTcpCandidate||(W.sdp=W.sdp.replace(/\r\na=candidate:tcpcandidate[^\r]+/g,"")),o.Logger.debug(k,"[Subscribe] receive() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(V),o.Logger.debug(k,"[Subscribe] receive() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(W);const Y=this._pc.getTransceivers().find(te=>te.mid===j);return this._mapMidTransceiver.set(j,Y),{localId:j,track:Y.receiver.track,rtpReceiver:Y.receiver}}async stopReceiving(y){this._assertRecvDirection(),o.Logger.debug(k,"[unsubscribe] stopReceiving() [localId:%s]",y);const _=this._mapMidTransceiver.get(y);if(!_||!_.mid)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"Chrome.stopReceiving: RTCRtpTransceiver 未找到"});_.receiver&&_.receiver.track&&_.receiver.track&&_.receiver.track.kind==="audio"||(_.isUseless=!0),this._remoteSdp.disableMediaSection(_.mid);const b=this._pc.localDescription;o.Logger.debug(k,"[unsubscribe] stopReceiving() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(b);const E={type:"answer",sdp:this._remoteSdp.getSdp()};o.Logger.debug(k,"[unsubscribe] stopReceiving() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(E)}async getReceiverStats(y){this._assertRecvDirection();const _=this._mapMidTransceiver.get(y);if(!_)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"Chrome.getReceiverStats: RTCRtpTransceiver 未找到"});return _.receiver.getStats()}async _setupTransport({localDtlsRole:y,localSdpObject:_}){_||(_=c.parse(this._pc.localDescription.sdp));const b=v.extractDtlsParameters({sdpObject:_});return b.role=y,this._transportReady=!0,b}_assertSendDirection(){if(this._direction!=="send")throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"_assertSendDirection: 操作异常"})}_assertRecvDirection(){if(this._direction!=="recv")throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"_assertRecvDirection: 操作异常"})}}e.Chrome74=P},function(t,e,r){var i=function(s){return String(Number(s))===s?Number(s):s},a=function(s,d,u){var h=s.name&&s.names;s.push&&!d[s.push]?d[s.push]=[]:h&&!d[s.name]&&(d[s.name]={});var o=s.push?{}:h?d[s.name]:d;(function(f,m,g,v){if(v&&!g)m[v]=i(f[1]);else for(var O=0;O<g.length;O+=1)f[O+1]!=null&&(m[g[O]]=i(f[O+1]))})(u.match(s.reg),o,s.names,s.name),s.push&&d[s.push].push(o)},l=r(170),n=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(s){var d={},u=[],h=d;return s.split(/(\r\n|\r|\n)/).filter(n).forEach(function(o){var f=o[0],m=o.slice(2);f==="m"&&(u.push({rtp:[],fmtp:[]}),h=u[u.length-1]);for(var g=0;g<(l[f]||[]).length;g+=1){var v=l[f][g];if(v.reg.test(m))return a(v,h,m)}}),d.media=u,d};var c=function(s,d){var u=d.split(/=(.+)/,2);return u.length===2?s[u[0]]=i(u[1]):u.length===1&&d.length>1&&(s[u[0]]=void 0),s};e.parseParams=function(s){return s.split(/;\s?/).reduce(c,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(s){return s.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(s){for(var d=[],u=s.split(" ").map(i),h=0;h<u.length;h+=3)d.push({component:u[h],ip:u[h+1],port:u[h+2]});return d},e.parseImageAttributes=function(s){return s.split(" ").map(function(d){return d.substring(1,d.length-1).split(",").reduce(c,{})})},e.parseSimulcastStreamList=function(s){return s.split(";").map(function(d){return d.split(",").map(function(u){var h,o=!1;return u[0]!=="~"?h=i(u):(h=i(u.substring(1,u.length)),o=!0),{scid:h,paused:o}})})}},function(t,e,r){var i=r(170),a=/%[sdv%]/g,l=function(d){var u=1,h=arguments,o=h.length;return d.replace(a,function(f){if(u>=o)return f;var m=h[u];switch(u+=1,f){case"%%":return"%";case"%s":return String(m);case"%d":return Number(m);case"%v":return""}})},n=function(d,u,h){var o=[d+"="+(u.format instanceof Function?u.format(u.push?h:h[u.name]):u.format)];if(u.names)for(var f=0;f<u.names.length;f+=1){var m=u.names[f];u.name?o.push(h[u.name][m]):o.push(h[u.names[f]])}else o.push(h[u.name]);return l.apply(null,o)},c=["v","o","s","i","u","e","p","c","b","t","r","z","a"],s=["i","c","b","a"];t.exports=function(d,u){u=u||{},d.version==null&&(d.version=0),d.name==null&&(d.name=" "),d.media.forEach(function(m){m.payloads==null&&(m.payloads="")});var h=u.outerOrder||c,o=u.innerOrder||s,f=[];return h.forEach(function(m){i[m].forEach(function(g){g.name in d&&d[g.name]!=null?f.push(n(m,g,d)):g.push in d&&d[g.push]!=null&&d[g.push].forEach(function(v){f.push(n(m,g,v))})})}),d.media.forEach(function(m){f.push(n("m",i.m[0],m)),o.forEach(function(g){i[g].forEach(function(v){v.name in m&&m[v.name]!=null?f.push(n(g,v,m)):v.push in m&&m[v.push]!=null&&m[v.push].forEach(function(O){f.push(n(g,v,O))})})})}),f.join(`\r
`)+`\r
`}},function(t,e,r){const i=r(226)("h264-profile-level-id");i.log=console.info.bind(console),e.ProfileConstrainedBaseline=1,e.ProfileBaseline=2,e.ProfileMain=3,e.ProfileConstrainedHigh=4,e.ProfileHigh=5,e.Level1_b=0,e.Level1=10,e.Level1_1=11,e.Level1_2=12,e.Level1_3=13,e.Level2=20,e.Level2_1=21,e.Level2_2=22,e.Level3=30,e.Level3_1=31,e.Level3_2=32,e.Level4=40,e.Level4_1=41,e.Level4_2=42,e.Level5=50,e.Level5_1=51,e.Level5_2=52;class a{constructor(o,f){this.profile=o,this.level=f}}e.ProfileLevelId=a;const l=new a(1,31);class n{constructor(o){this._mask=~d("x",o),this._maskedValue=d("1",o)}isMatch(o){return this._maskedValue===(o&this._mask)}}class c{constructor(o,f,m){this.profile_idc=o,this.profile_iop=f,this.profile=m}}const s=[new c(66,new n("x1xx0000"),1),new c(77,new n("1xxx0000"),1),new c(88,new n("11xx0000"),1),new c(66,new n("x0xx0000"),2),new c(88,new n("10xx0000"),2),new c(77,new n("0x0x0000"),3),new c(100,new n("00000000"),5),new c(100,new n("00001100"),4)];function d(h,o){return(o[0]===h)<<7|(o[1]===h)<<6|(o[2]===h)<<5|(o[3]===h)<<4|(o[4]===h)<<3|(o[5]===h)<<2|(o[6]===h)<<1|(o[7]===h)<<0}function u(h={}){const o=h["level-asymmetry-allowed"];return o===1||o==="1"}e.parseProfileLevelId=function(h){if(typeof h!="string"||h.length!==6)return null;const o=parseInt(h,16);if(o===0)return null;const f=255&o,m=o>>8&255,g=o>>16&255;let v;switch(f){case 11:v=16&m?0:11;break;case 10:case 12:case 13:case 20:case 21:case 22:case 30:case 31:case 32:case 40:case 41:case 42:case 50:case 51:case 52:v=f;break;default:return i("parseProfileLevelId() | unrecognized level_idc:%s",f),null}for(const O of s)if(g===O.profile_idc&&O.profile_iop.isMatch(m))return new a(O.profile,v);return i("parseProfileLevelId() | unrecognized profile_idc/profile_iop combination"),null},e.profileLevelIdToString=function(h){if(h.level==0)switch(h.profile){case 1:return"42f00b";case 2:return"42100b";case 3:return"4d100b";default:return i("profileLevelIdToString() | Level 1_b not is allowed for profile:%s",h.profile),null}let o;switch(h.profile){case 1:o="42e0";break;case 2:o="4200";break;case 3:o="4d00";break;case 4:o="640c";break;case 5:o="6400";break;default:return i("profileLevelIdToString() | unrecognized profile:%s",h.profile),null}let f=h.level.toString(16);return f.length===1&&(f="0"+f),`${o}${f}`},e.parseSdpProfileLevelId=function(h={}){const o=h["profile-level-id"];return o?e.parseProfileLevelId(o):l},e.isSameProfile=function(h={},o={}){const f=e.parseSdpProfileLevelId(h),m=e.parseSdpProfileLevelId(o);return!!(f&&m&&f.profile===m.profile)},e.generateProfileLevelIdForAnswer=function(h={},o={}){if(!h["profile-level-id"]&&!o["profile-level-id"])return i("generateProfileLevelIdForAnswer() | no profile-level-id in local and remote params"),null;const f=e.parseSdpProfileLevelId(h),m=e.parseSdpProfileLevelId(o);if(!f)throw new TypeError("invalid local_profile_level_id");if(!m)throw new TypeError("invalid remote_profile_level_id");if(f.profile!==m.profile)throw new TypeError("H264 Profile mismatch");const g=u(h)&&u(o),v=f.level,O=m.level,T=function(w,k){return w===0?k!==10&&k!==0:k===0?w!==10:w<k}(C=v,A=O)?C:A;var C,A;const R=g?v:T;return i("generateProfileLevelIdForAnswer() | result: [profile:%s, level:%s]",f.profile,R),e.profileLevelIdToString(new a(f.profile,R))}},function(t,e,r){(function(i){e.formatArgs=function(l){if(l[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+l[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const n="color: "+this.color;l.splice(1,0,n,"color: inherit");let c=0,s=0;l[0].replace(/%[a-zA-Z%]/g,d=>{d!=="%%"&&(c++,d==="%c"&&(s=c))}),l.splice(s,0,n)},e.save=function(l){try{l?e.storage.setItem("debug",l):e.storage.removeItem("debug")}catch{}},e.load=function(){let l;try{l=e.storage.getItem("debug")}catch{}return!l&&i!==void 0&&"env"in i&&(l=i.env.DEBUG),l},e.useColors=function(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},e.storage=function(){try{return localStorage}catch{}}(),e.destroy=(()=>{let l=!1;return()=>{l||(l=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],e.log=console.debug||console.log||(()=>{}),t.exports=r(227)(e);const{formatters:a}=t.exports;a.j=function(l){try{return JSON.stringify(l)}catch(n){return"[UnexpectedJSONParseError]: "+n.message}}}).call(this,r(80))},function(t,e,r){t.exports=function(i){function a(c){let s,d,u,h=null;function o(...f){if(!o.enabled)return;const m=o,g=Number(new Date),v=g-(s||g);m.diff=v,m.prev=s,m.curr=g,s=g,f[0]=a.coerce(f[0]),typeof f[0]!="string"&&f.unshift("%O");let O=0;f[0]=f[0].replace(/%([a-zA-Z%])/g,(T,C)=>{if(T==="%%")return"%";O++;const A=a.formatters[C];if(typeof A=="function"){const R=f[O];T=A.call(m,R),f.splice(O,1),O--}return T}),a.formatArgs.call(m,f),(m.log||a.log).apply(m,f)}return o.namespace=c,o.useColors=a.useColors(),o.color=a.selectColor(c),o.extend=l,o.destroy=a.destroy,Object.defineProperty(o,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(d!==a.namespaces&&(d=a.namespaces,u=a.enabled(c)),u),set:f=>{h=f}}),typeof a.init=="function"&&a.init(o),o}function l(c,s){const d=a(this.namespace+(s===void 0?":":s)+c);return d.log=this.log,d}function n(c){return c.toString().substring(2,c.toString().length-2).replace(/\.\*\?$/,"*")}return a.debug=a,a.default=a,a.coerce=function(c){return c instanceof Error?c.stack||c.message:c},a.disable=function(){const c=[...a.names.map(n),...a.skips.map(n).map(s=>"-"+s)].join(",");return a.enable(""),c},a.enable=function(c){let s;a.save(c),a.namespaces=c,a.names=[],a.skips=[];const d=(typeof c=="string"?c:"").split(/[\s,]+/),u=d.length;for(s=0;s<u;s++)d[s]&&((c=d[s].replace(/\*/g,".*?"))[0]==="-"?a.skips.push(new RegExp("^"+c.slice(1)+"$")):a.names.push(new RegExp("^"+c+"$")))},a.enabled=function(c){if(c[c.length-1]==="*")return!0;let s,d;for(s=0,d=a.skips.length;s<d;s++)if(a.skips[s].test(c))return!1;for(s=0,d=a.names.length;s<d;s++)if(a.names[s].test(c))return!0;return!1},a.humanize=r(228),a.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(i).forEach(c=>{a[c]=i[c]}),a.names=[],a.skips=[],a.formatters={},a.selectColor=function(c){let s=0;for(let d=0;d<c.length;d++)s=(s<<5)-s+c.charCodeAt(d),s|=0;return a.colors[Math.abs(s)%a.colors.length]},a.enable(a.load()),a}},function(t,e){var r=1e3,i=6e4,a=60*i,l=24*a;function n(c,s,d,u){var h=s>=1.5*d;return Math.round(c/d)+" "+u+(h?"s":"")}t.exports=function(c,s){s=s||{};var d=typeof c;if(d==="string"&&c.length>0)return function(u){if(!((u=String(u)).length>100)){var h=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(u);if(h){var o=parseFloat(h[1]);switch((h[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*o;case"weeks":case"week":case"w":return 6048e5*o;case"days":case"day":case"d":return o*l;case"hours":case"hour":case"hrs":case"hr":case"h":return o*a;case"minutes":case"minute":case"mins":case"min":case"m":return o*i;case"seconds":case"second":case"secs":case"sec":case"s":return o*r;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return o;default:return}}}}(c);if(d==="number"&&isFinite(c))return s.long?function(u){var h=Math.abs(u);return h>=l?n(u,h,l,"day"):h>=a?n(u,h,a,"hour"):h>=i?n(u,h,i,"minute"):h>=r?n(u,h,r,"second"):u+" ms"}(c):function(u){var h=Math.abs(u);return h>=l?Math.round(u/l)+"d":h>=a?Math.round(u/a)+"h":h>=i?Math.round(u/i)+"m":h>=r?Math.round(u/r)+"s":u+"ms"}(c);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(c))}},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(d,u,h,o){o===void 0&&(o=h),Object.defineProperty(d,o,{enumerable:!0,get:function(){return u[h]}})}:function(d,u,h,o){o===void 0&&(o=h),d[o]=u[h]}),a=this&&this.__setModuleDefault||(Object.create?function(d,u){Object.defineProperty(d,"default",{enumerable:!0,value:u})}:function(d,u){d.default=u}),l=this&&this.__importStar||function(d){if(d&&d.__esModule)return d;var u={};if(d!=null)for(var h in d)h!=="default"&&Object.prototype.hasOwnProperty.call(d,h)&&i(u,d,h);return a(u,d),u};Object.defineProperty(e,"__esModule",{value:!0}),e.OfferMediaSection=e.AnswerMediaSection=e.MediaSection=void 0;const n=l(r(27));class c{constructor({iceParameters:u,iceCandidates:h,dtlsParameters:o,planB:f=!1}){if(this._mediaObject={},this._planB=f,u&&this.setIceParameters(u),h){this._mediaObject.candidates=[];for(const m of h){const g={component:1};g.foundation=m.foundation,g.ip=m.ip,g.port=m.port,g.priority=m.priority,g.transport=m.protocol,g.type=m.type,m.tcpType&&(g.tcptype=m.tcpType),this._mediaObject.candidates.push(g)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}o&&this.setDtlsRole(o.role)}get mid(){return String(this._mediaObject.mid)}get type(){return String(this._mediaObject.type)}get closed(){return this._mediaObject.port===0}set mid(u){this._mediaObject.mid=u}getObject(){return this._mediaObject}setIceParameters(u){this._mediaObject.iceUfrag=u.usernameFragment,this._mediaObject.icePwd=u.password}disable(){delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids}close(){this._mediaObject.direction="inactive",this._mediaObject.port=0,delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}}e.MediaSection=c,e.AnswerMediaSection=class extends c{constructor({iceParameters:d,iceCandidates:u,dtlsParameters:h,sctpParameters:o,plainRtpParameters:f,planB:m=!1,offerMediaObject:g,offerRtpParameters:v,answerRtpParameters:O,codecOptions:T,extmapAllowMixed:C=!1}){switch(super({iceParameters:d,iceCandidates:u,dtlsParameters:h,planB:m}),this._mediaObject.mid=String(g.mid),this._mediaObject.type=g.type,this._mediaObject.protocol=g.protocol,f?(this._mediaObject.connection={ip:f.ip,version:f.ipVersion},this._mediaObject.port=f.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),g.type){case"audio":case"video":this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(const A of O.codecs){const R={payload:A.payloadType,codec:s(A),rate:A.clockRate};A.channels>1&&(R.encoding=A.channels),this._mediaObject.rtp.push(R);const w=n.clone(A.parameters,{});if(T){const{opusStereo:I,opusFec:M,opusDtx:P,opusMaxPlaybackRate:S,opusPtime:y,videoGoogleStartBitrate:_,videoGoogleMaxBitrate:b,videoGoogleMinBitrate:E}=T,x=v.codecs.find(D=>D.payloadType===A.payloadType);switch(A.mimeType.toLowerCase()){case"audio/opus":I!==void 0&&(x.parameters["sprop-stereo"]=I?1:0,w.stereo=I?1:0),M!==void 0&&(x.parameters.useinbandfec=M?1:0,w.useinbandfec=M?1:0),P!==void 0&&(x.parameters.usedtx=P?1:0,w.usedtx=P?1:0),S!==void 0&&(w.maxplaybackrate=S),y!==void 0&&(x.parameters.ptime=y,w.ptime=y);break;case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":_!==void 0&&(w["x-google-start-bitrate"]=_),b!==void 0&&(w["x-google-max-bitrate"]=b),E!==void 0&&(w["x-google-min-bitrate"]=E)}}const k={payload:A.payloadType,config:""};for(const I of Object.keys(w))k.config&&(k.config+=";"),k.config+=`${I}=${w[I]}`;k.config&&this._mediaObject.fmtp.push(k);for(const I of A.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:A.payloadType,type:I.type,subtype:I.parameter})}this._mediaObject.payloads=O.codecs.map(A=>A.payloadType).join(" "),this._mediaObject.ext=[];for(const A of O.headerExtensions)(g.ext||[]).some(R=>R.uri===A.uri)&&this._mediaObject.ext.push({uri:A.uri,value:A.id});if(C&&g.extmapAllowMixed==="extmap-allow-mixed"&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),g.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:g.simulcast.list1},this._mediaObject.rids=[];for(const A of g.rids||[])A.direction==="send"&&this._mediaObject.rids.push({id:A.id,direction:"recv"})}else if(g.simulcast_03){this._mediaObject.simulcast_03={value:g.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(const A of g.rids||[])A.direction==="send"&&this._mediaObject.rids.push({id:A.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize",this._planB&&this._mediaObject.type==="video"&&(this._mediaObject.xGoogleFlag="conference");break;case"application":typeof g.sctpPort=="number"?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=o.port,this._mediaObject.maxMessageSize=o.maxMessageSize):g.sctpmap&&(this._mediaObject.payloads=o.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:o.port,maxMessageSize:o.maxMessageSize})}}setDtlsRole(d){switch(d){case"client":this._mediaObject.setup="active";break;case"server":this._mediaObject.setup="passive";break;case"auto":this._mediaObject.setup="actpass"}}};function s(d){const u=new RegExp("^(audio|video)/(.+)","i").exec(d.mimeType);if(!u)throw new TypeError("invalid codec.mimeType");return u[2]}e.OfferMediaSection=class extends c{constructor({iceParameters:d,iceCandidates:u,dtlsParameters:h,sctpParameters:o,plainRtpParameters:f,planB:m=!1,mid:g,kind:v,offerRtpParameters:O,streamId:T,trackId:C,oldDataChannelSpec:A=!1}){switch(super({iceParameters:d,iceCandidates:u,dtlsParameters:h,planB:m}),this._mediaObject.mid=String(g),this._mediaObject.type=v,f?(this._mediaObject.connection={ip:f.ip,version:f.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=f.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.protocol=o?"UDP/DTLS/SCTP":"UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),v){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._planB||(this._mediaObject.msid=`${T||"-"} ${C}`);for(const I of O.codecs){const M={payload:I.payloadType||I.localPayloadType||125,codec:s(I),rate:I.clockRate};I.channels>1&&(M.encoding=I.channels),this._mediaObject.rtp.push(M);const P={payload:I.payloadType||I.localPayloadType||125,config:""},S=I.parameters||I.localParameters||{};for(const y of Object.keys(S))P.config&&(P.config+=";"),P.config+=`${y}=${S[y]}`;P.config&&this._mediaObject.fmtp.push(P);for(const y of I.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:I.payloadType,type:y.type,subtype:y.parameter})}this._mediaObject.payloads=O.codecs.map(I=>I.payloadType||I.localPayloadType||125).join(" "),this._mediaObject.ext=[];for(const I of O.headerExtensions)this._mediaObject.ext.push({uri:I.uri,value:I.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";const R=O.encodings[0],w=R.ssrc,k=R.rtx&&R.rtx.ssrc?R.rtx.ssrc:void 0;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],O.rtcp.cname&&this._mediaObject.ssrcs.push({id:w,attribute:"cname",value:O.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:w,attribute:"msid",value:`${T||"-"} ${C}`}),k&&(O.rtcp.cname&&this._mediaObject.ssrcs.push({id:k,attribute:"cname",value:O.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:k,attribute:"msid",value:`${T||"-"} ${C}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${w} ${k}`}));break}case"application":A?(this._mediaObject.payloads=o.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:o.port,maxMessageSize:o.maxMessageSize}):(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=o.port,this._mediaObject.maxMessageSize=o.maxMessageSize)}}setDtlsRole(d){switch(d){case"client":this._mediaObject.setup="active";break;case"server":this._mediaObject.setup="passive";break;case"auto":this._mediaObject.setup="actpass"}}planBReceive({offerRtpParameters:d,streamId:u,trackId:h}){const o=d.encodings[0],f=o.ssrc,m=o.rtx&&o.rtx.ssrc?o.rtx.ssrc:void 0;d.rtcp.cname&&this._mediaObject.ssrcs.push({id:f,attribute:"cname",value:d.rtcp.cname}),this._mediaObject.ssrcs.push({id:f,attribute:"msid",value:`${u||"-"} ${h}`}),m&&(d.rtcp.cname&&this._mediaObject.ssrcs.push({id:m,attribute:"cname",value:d.rtcp.cname}),this._mediaObject.ssrcs.push({id:m,attribute:"msid",value:`${u||"-"} ${h}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${f} ${m}`}))}planBStopReceiving({offerRtpParameters:d}){const u=d.encodings[0],h=u.ssrc,o=u.rtx&&u.rtx.ssrc?u.rtx.ssrc:void 0;this._mediaObject.ssrcs=this._mediaObject.ssrcs.filter(f=>f.id!==h&&f.id!==o),o&&(this._mediaObject.ssrcGroups=this._mediaObject.ssrcGroups.filter(f=>f.ssrcs!==`${h} ${o}`))}}},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(k,I,M,P){P===void 0&&(P=M),Object.defineProperty(k,P,{enumerable:!0,get:function(){return I[M]}})}:function(k,I,M,P){P===void 0&&(P=M),k[P]=I[M]}),a=this&&this.__setModuleDefault||(Object.create?function(k,I){Object.defineProperty(k,"default",{enumerable:!0,value:I})}:function(k,I){k.default=I}),l=this&&this.__importStar||function(k){if(k&&k.__esModule)return k;var I={};if(k!=null)for(var M in k)M!=="default"&&Object.prototype.hasOwnProperty.call(k,M)&&i(I,k,M);return a(I,k),I};Object.defineProperty(e,"__esModule",{value:!0}),e.Chrome58=void 0;const n=l(r(50)),c=r(29),s=r(78),d=l(r(27)),u=l(r(79)),h=l(r(88)),o=l(r(231)),f=r(43),m=r(1),g=r(87),v=r(138),O=r(89),T=r(232),C=l(r(7)),A="Chrome_",R={OS:1024,MIS:1024};class w extends g.HandlerInterface{constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new w}get name(){return"Chrome58"}close(){if(c.Logger.debug(A,"close()"),this._pc)try{this._pc.onconnectionstatechange=null,this._pc.close()}catch{}}async getNativeRtpCapabilities(){c.Logger.debug("getNativeRtpCapabilities()");const I=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const M=await I.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{I.close()}catch{}const P=n.parse(M.sdp);return h.extractRtpCapabilities({sdpObject:P})}catch(M){try{I.close()}catch{}throw M}}async getNativeSctpCapabilities(){return c.Logger.debug("getNativeSctpCapabilities()"),{numStreams:R}}run({direction:I,iceParameters:M,iceCandidates:P,dtlsParameters:S,sctpParameters:y,iceServers:_,iceTransportPolicy:b,additionalSettings:E,proprietaryConstraints:x,extendedRtpCapabilities:D}){c.Logger.debug("run()"),this._direction=I,this._sendingRtpParametersByKind={audio:u.getSendingRtpParameters("audio",D),video:u.getSendingRtpParameters("video",D)},this._sendingRemoteRtpParametersByKind={audio:u.getSendingRemoteRtpParameters("audio",D),video:u.getSendingRemoteRtpParameters("video",D)},S!=null&&S.role&&S.role!=="auto"&&(this._forcedLocalDtlsRole=S.role==="server"?"client":"server"),this._pc=new RTCPeerConnection(Object.assign({iceServers:_||[],iceTransportPolicy:b||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"},E),x),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(c.Logger.debug("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}}),this._pc.onicecandidate=F=>{},this._pc.onicecandidateerror=F=>{c.Logger.warn("onicecandidateerror: ",F)}}async updateIceServers(I){c.Logger.debug("updateIceServers()");const M=this._pc.getConfiguration();M.iceServers=I,this._pc.setConfiguration(M)}async restartIce(I){if(c.Logger.debug("restartIce()"),this._remoteSdp.updateIceParameters(I),this._transportReady)if(this._direction==="send"){const M=await this._pc.createOffer({iceRestart:!0});c.Logger.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",M),await this._pc.setLocalDescription(M);const P={type:"answer",sdp:this._remoteSdp.getSdp()};c.Logger.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",P),await this._pc.setRemoteDescription(P)}else{const M={type:"offer",sdp:this._remoteSdp.getSdp()};c.Logger.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",M),await this._pc.setRemoteDescription(M);const P=await this._pc.createAnswer();c.Logger.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",P),await this._pc.setLocalDescription(P)}}async getTransportStats(){return this._pc.getStats()}async send({track:I,encodings:M,codecOptions:P,codec:S,appData:y}){this.assertSendDirection(),c.Logger.debug("send() [kind:%s, track.id:%s]",I.kind,I.id),this._sendStream.addTrack(I),this._pc.addStream(this._sendStream);let _,b=await this._pc.createOffer(),E=n.parse(b.sdp);y.preferRemb&&O.filterTransportCCFromSdp(E);let x;const D=d.clone(this._sendingRtpParametersByKind[I.kind]),F=d.clone(this._sendingRemoteRtpParametersByKind[I.kind]);if(F.codecs=u.reduceCodecs(F.codecs),this._transportReady||(x=await this._setupTransport({localDtlsRole:"server",localSdpObject:E})),I.kind==="video"&&M&&M.length>1&&(c.Logger.debug("send() | enabling simulcast"),E=n.parse(b.sdp),_=E.media.find(N=>N.type==="video"),o.addLegacySimulcast({offerMediaObject:_,track:I,numStreams:M.length}),b={type:"offer",sdp:n.write(E)}),c.Logger.debug("send() | calling pc.setLocalDescription() [offer:%o]",b),_=E.media.find(N=>N.type===I.kind),D.rtcp.cname=h.getCname({offerMediaObject:_}),D.encodings=o.getRtpEncodings({offerMediaObject:_,track:I}),M)for(let N=0;N<D.encodings.length;++N)M[N]&&Object.assign(D.encodings[N],M[N]);if(D.encodings.length>1&&D.codecs[0].mimeType.toLowerCase()==="video/vp8")for(const N of D.encodings)N.scalabilityMode="S1T3";const V=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(V,I),{localId:V,rtpParameters:D,dtlsParameters:x,offer:b}}async fillRemoteRecvSdp({kind:I,iceParameters:M,iceCandidates:P,dtlsParameters:S,sctpParameters:y,sendingRtpParameters:_,codecOptions:b,offer:E,audioProfile:x,codec:D,resetVideoSdp:F,appData:V}){c.Logger.debug(A,"fillRemoteRecvSdp() | calling pc.setLocalDescription()"),E=new T.Interop().toUnifiedPlan(E),await this._pc.setLocalDescription(E),this._remoteSdp||(this._remoteSdp=new v.RemoteSdp({iceParameters:M,iceCandidates:P,dtlsParameters:S,sctpParameters:y}),this._remoteSdp.updateDtlsRole("client"));const N=d.clone(this._sendingRemoteRtpParametersByKind[I]);V.preferRemb?(c.Logger.debug(A,"publish() fillRemoteRecvSdp() |  使用REMB作为带宽估计方式"),O.filterTransportCCFromRtpParameters(N)):(c.Logger.debug(A,"publish() fillRemoteRecvSdp() |  使用transport-cc作为带宽估计方式"),O.filterRembFromRtpParameters(N)),N.codecs=f.reduceCodecs(N.codecs,D);let L=n.parse(this._pc.localDescription.sdp),U=this._remoteSdp.getNextMediaSectionIdx();F&&(_.mid?_.encodings&&_.encodings.length>1?U.idx=Number(_.mid)-(_.encodings.length-1):U.idx=Number(_.mid):c.Logger.warn(A,"fillRemoteRecvSdp() | mid 未找到"),U.reuseMid=!0);let H=L.media[U.idx];_.encodings&&_.encodings.length>1&&L.media[U.idx+1],this._remoteSdp.send({offerMediaObjectArr:[H],reuseMid:U.reuseMid,offerRtpParameters:_,answerRtpParameters:N,codecOptions:b,extmapAllowMixed:!0});let j={type:"answer",sdp:this._remoteSdp.getSdp()};if(c.Logger.debug(A,"audioProfile设置为: ",x),x){let W=null;switch(x){case"speech_low_quality":W="maxplaybackrate=16000;sprop-maxcapturerate=16000;maxaveragebitrate=32000";break;case"speech_standard":W="maxplaybackrate=32000;sprop-maxcapturerate=32000;maxaveragebitrate=36000";break;case"music_standard":W="maxplaybackrate=48000;sprop-maxcapturerate=48000;";break;case"standard_stereo":W="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=56000";break;case"high_quality":W="maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=128000";break;case"high_quality_stereo":W="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=192000"}j.sdp.indexOf("a=fmtp:111")&&(j.sdp=j.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;useinbandfec=1;"+W)),j.sdp=j.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=maxptime:60")}c.Logger.debug(A,"fillRemoteRecvSdp() | calling pc.setRemoteDescription()"),m.getParameters().enableUdpCandidate||(j.sdp=j.sdp.replace(/\r\na=candidate:udpcandidate[^\r]+/g,"")),m.getParameters().enableTcpCandidate||(j.sdp=j.sdp.replace(/\r\na=candidate:tcpcandidate[^\r]+/g,"")),await this._pc.setRemoteDescription(j)}async stopSending(I){this.assertSendDirection(),c.Logger.debug("stopSending() [localId:%s]",I);const M=this._mapSendLocalIdTrack.get(I);if(!M)throw new Error("track not found");this._mapSendLocalIdTrack.delete(I),this._sendStream.removeTrack(M),this._pc.addStream(this._sendStream);const P=await this._pc.createOffer();c.Logger.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",P);try{await this._pc.setLocalDescription(P)}catch(y){if(this._sendStream.getTracks().length===0)return void c.Logger.warn("stopSending() | ignoring expected error due no sending tracks: %s",y.toString());throw y}if(this._pc.signalingState==="stable")return;const S={type:"answer",sdp:this._remoteSdp.getSdp()};c.Logger.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",S),await this._pc.setRemoteDescription(S)}async pauseSending(I){}async resumeSending(I){}async replaceTrack(I,M){throw new s.UnsupportedError("not implemented")}async setMaxSpatialLayer(I,M){throw new s.UnsupportedError(" not implemented")}async setRtpEncodingParameters(I,M){throw new s.UnsupportedError("not supported")}async getSenderStats(I){throw new s.UnsupportedError("not implemented")}async prepareLocalSdp(I,M){c.Logger.debug("prepareLocalSdp() [kind:%s, remoteUid:%s]",I,M);let P,S,y,_=-1;if(S=I==="audio"||this._pc.localDescription.sdp.indexOf("m=audio")>-1,y=I==="video"||this._pc.localDescription.sdp.indexOf("m=video")>-1,P=await this._pc.createOffer({offerToReceiveAudio:S,offerToReceiveVideo:y}),!P.sdp)throw c.Logger.error(A,"[Subscribe] prepareLocalSdp() offer没有sdp"),new Error("INVALID_OFFER");if(P.sdp.indexOf("a=rtcp-fb:111")&&P.sdp.indexOf("a=rtcp-fb:111 nack")===-1&&(P.sdp=P.sdp.replace(/(a=rtcp-fb:111.*)/,`$1\r
a=rtcp-fb:111 nack`)),P.sdp.indexOf("a=fmtp:111")&&(P.sdp=P.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z-]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1")),!P.sdp)throw c.Logger.error(A,"[Subscribe] prepareLocalSdp() offer没有sdp"),new Error("INVALID_OFFER");P.sdp.includes("a=inactive")&&(P.sdp=P.sdp.replace(/a=inactive/g,"a=recvonly"));const b=n.parse(P.sdp);_=b.media[b.media.length-1].mid;let E;E=await this._setupTransport({localDtlsRole:"server",localSdpObject:b});let x=await this._pc.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}),D=n.parse(x.sdp),F=h.extractRtpCapabilities({sdpObject:D});return _===-1&&(_=b.media[b.media.length-1].mid),{dtlsParameters:E,rtpCapabilities:F,offer:P,mid:_,iceUfragReg:""}}async receive({trackId:I,kind:M,rtpParameters:P,iceParameters:S,iceCandidates:y,dtlsParameters:_,sctpParameters:b,offer:E,remoteUid:x,extendedRtpCapabilities:D,appData:F}){this.assertRecvDirection(),c.Logger.debug("receive() [trackId:%s, kind:%s]",I,M);const V=M,N=P.rtcp.cname;this._remoteSdp||(this._remoteSdp=new v.RemoteSdp({iceParameters:S,iceCandidates:y,dtlsParameters:_,sctpParameters:b,planB:!0}),this._remoteSdp.updateDtlsRole("client"));let L=P&&P.mid||F.mid;c.Logger.debug(A,"[Subscribe] receive() mid: "+L),this._remoteSdp.receive({mid:V,kind:M,offerRtpParameters:P,streamId:N,trackId:I}),C.ANY_CHROME_MAJOR_VERSION&&C.ANY_CHROME_MAJOR_VERSION<59&&this._remoteSdp.getSdp().indexOf("a=setup:actpass")>-1&&this._remoteSdp.updateDtlsRole("client");let U={type:"answer",sdp:this._remoteSdp.getSdp()};return c.Logger.debug(A,"[Subscribe] receive() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(E),c.Logger.debug(A,"[Subscribe] receive() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(U),{localId:L,track:this._pc.getRemoteStreams().find(H=>H.id===N).getTrackById(I),rtpReceiver:void 0}}async stopReceiving(I){this.assertRecvDirection();for(const S of I){c.Logger.debug("stopReceiving() [localId:%s]",S);const{mid:y,rtpParameters:_}=this._mapRecvLocalIdInfo.get(S)||{};this._mapRecvLocalIdInfo.delete(S),C.ANY_CHROME_MAJOR_VERSION&&C.ANY_CHROME_MAJOR_VERSION<59&&this._remoteSdp.updateDtlsRole("auto"),this._remoteSdp.planBStopReceiving({mid:y,offerRtpParameters:_})}const M={type:"offer",sdp:this._remoteSdp.getSdp()};c.Logger.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",M),await this._pc.setRemoteDescription(M);const P=await this._pc.createAnswer();c.Logger.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",P),await this._pc.setLocalDescription(P)}async pauseReceiving(I){}async resumeReceiving(I){}async getReceiverStats(I){throw new s.UnsupportedError("not implemented")}async _setupTransport({localDtlsRole:I,localSdpObject:M}){M||(M=n.parse(this._pc.localDescription.sdp));const P=h.extractDtlsParameters({sdpObject:M});return P.role=I,this._transportReady=!0,P}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}e.Chrome58=w},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.addLegacySimulcast=e.getRtpEncodings=void 0,e.getRtpEncodings=function({offerMediaObject:i,track:a}){const l=new Set;for(const s of i.ssrcs||[])if(s.attribute==="msid"&&s.value.split(" ")[1]===a.id){const d=s.id;l.add(d)}if(l.size===0)throw new Error(`a=ssrc line with msid information not found [track.id:${a.id}]`);const n=new Map;for(const s of i.ssrcGroups||[]){if(s.semantics!=="FID")continue;let[d,u]=s.ssrcs.split(/\s+/);d=Number(d),u=Number(u),l.has(d)&&(l.delete(d),l.delete(u),n.set(d,u))}for(const s of l)n.set(s,null);const c=[];for(const[s,d]of n){const u={ssrc:s};d&&(u.rtx={ssrc:d}),c.push(u)}return c},e.addLegacySimulcast=function({offerMediaObject:i,track:a,numStreams:l}){if(l<=1)throw new TypeError("numStreams must be greater than 1");let n,c,s;if(!(i.ssrcs||[]).find(f=>f.attribute!=="msid"?!1:f.value.split(" ")[1]===a.id&&(n=f.id,s=f.value.split(" ")[0],!0)))throw new Error(`a=ssrc line with msid information not found [track.id:${a.id}]`);(i.ssrcGroups||[]).some(f=>{if(f.semantics!=="FID")return!1;const m=f.ssrcs.split(/\s+/);return Number(m[0])===n&&(c=Number(m[1]),!0)});const d=i.ssrcs.find(f=>f.attribute==="cname"&&f.id===n);if(!d)throw new Error(`a=ssrc line with cname information not found [track.id:${a.id}]`);const u=d.value,h=[],o=[];for(let f=0;f<l;++f)h.push(n+f),c&&o.push(c+f);i.ssrcGroups=i.ssrcGroups||[],i.ssrcs=i.ssrcs||[],i.ssrcGroups.push({semantics:"SIM",ssrcs:h.join(" ")});for(let f=0;f<h.length;++f){const m=h[f];i.ssrcs.push({id:m,attribute:"cname",value:u}),i.ssrcs.push({id:m,attribute:"msid",value:`${s} ${a.id}`})}for(let f=0;f<o.length;++f){const m=h[f],g=o[f];i.ssrcs.push({id:g,attribute:"cname",value:u}),i.ssrcs.push({id:g,attribute:"msid",value:`${s} ${a.id}`}),i.ssrcGroups.push({semantics:"FID",ssrcs:`${m} ${g}`})}}},function(t,e,r){var i=this&&this.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(e,"__esModule",{value:!0}),e.Interop=void 0;const a=i(r(233)),l=i(r(234)),n=["audio","video","data"],c=o=>o.find(f=>f.semantics==="SIM"),s=o=>o.find(f=>f.semantics==="FID");function d(o,f,m,g){if(!o||!f)return;const v=O=>g.find(T=>T.id.toString()===O);f.ssrcs.forEach(O=>{o.sources.push(v(O));const T=m[parseInt(O,10)].find(C=>C.semantics==="FID");if(T){const C=T.ssrcs.find(A=>A!==O);o.sources.push(v(C)),o.ssrcGroups.push(T)}}),o.ssrcGroups.push(f)}function u(o,f,m,g){if(!o||!f)return;if(o.sources=[],o.ssrcGroups=[],!m[f.id])return o.sources.push(f),void(o.msid=f.msid);const v=c(m[f.id]),O=s(m[f.id]);if(v)d(o,v,m,g);else if(O){const T=O.ssrcs.find(A=>A!==f),C=c(m[T]);C?d(o,C,m,g):(O.ssrcs.forEach(A=>{o.sources.push((R=>g.find(w=>w.id.toString()===R))(A))}),o.ssrcGroups.push(O))}o.msid=o.sources[0].msid}function h(o,f,m){if(!m.find(g=>!!g.sources&&g.sources.some(v=>v.id===o.id))){if(!f[o.id])return!1;const g=c(f[o.id]),v=s(f[o.id]);return g?m.some(O=>O.sources&&O.sources.some(T=>T.id.toString()===g.ssrcs[0])):v&&o.id.toString()!==v.ssrcs[0]?h({id:v.ssrcs[0]},f,m):!1}return!0}e.Interop=class{toPlanB(o){if(!o||typeof o.sdp!="string")return console.warn("An empty description was passed as an argument."),o;const f=a.default.parse(o.sdp);if(!f.media||!f.media.length)return console.warn("The description has no media."),o;if(f.media.every(T=>n.indexOf(T.mid)!==-1))return console.warn("The description does not look like unified plan sdp"),o;const m={},g=f.media;f.media=[],g.forEach(T=>{const C=T.type;if(C==="application")return T.mid="data",void(m[T.mid]=T);if(m[C]===void 0){const A=l.default(T);A.sources&&Array.isArray(A.sources)&&A.sources.forEach(R=>{T.msid?R.msid=T.msid:delete R.msid}),A.ssrcGroups&&T.msid||(A.ssrcGroups=[]),delete A.msid,A.mid=C,m[C]=A}else if(T.msid){const A=l.default(T);A.sources&&Array.isArray(A.sources)&&(A.sources.forEach(R=>{R.msid=T.msid}),m[C].sources=(m[C].sources||[]).concat(A.sources)),A.ssrcGroups!==void 0&&Array.isArray(A.ssrcGroups)&&(m[C].ssrcGroups=(m[C].ssrcGroups||[]).concat(A.ssrcGroups))}}),f.media=Object.values(m);const v=[];Object.values(m).forEach(T=>{T.direction!=="inactive"&&v.push(T.mid)}),f.groups.forEach(T=>{T.type==="BUNDLE"&&(T.mids=v.join(" "))}),f.msidSemantic={semantic:"WMS",token:"*"};const O=a.default.write(f);return new RTCSessionDescription({type:o.type,sdp:O})}toUnifiedPlan(o,f=null){if(!o||typeof o.sdp!="string")return console.warn("An empty description was passed as an argument."),o;const m=a.default.parse(o.sdp);if(!m.media||!m.media.length)return console.warn("The description has no media."),o;if(m.media.length>3||m.media.every(k=>n.indexOf(k.mid)===-1))return console.warn("The description does not look like plan-b"),o;const g=f?a.default.parse(f.sdp):null,v=function(k,I){if(!k||!I||k.media.length===0||I.media.length===0)return!1;const M=k.media[0],P=I.media[0];return M.iceUfrag!==P.iceUfrag||M.icePwd!==P.icePwd}(m,g),O=m.media[0].iceUfrag,T=m.media[0].icePwd,C=m.media[0].fingerprint,A={};m.media.forEach(k=>{const I=k.type;if(I==="application"){if(!g||!g.media){const S=l.default(k);return S.mid=Object.keys(A).length.toString(),void(A[k.mid]=S)}const P=g.media.findIndex(S=>S.type===I);return void(P&&(g.media[P]=k,g.media[P].mid=P))}const M=function(P){const S={};return P&&Array.isArray(P)&&P.forEach(y=>{y.ssrcs&&Array.isArray(y.ssrcs)&&y.ssrcs.forEach(_=>{S[_]===void 0&&(S[_]=[]),S[_].push(y)})}),S}(k.ssrcGroups);if(k.sources)k.sources.forEach((P,S)=>{if(!P.msid)return;if(!g||!g.media){if(h(P,M,Object.values(A)))return;const _=l.default(k);return _.mid=Object.keys(A).length.toString(),_.direction=S||k.direction==="sendonly"?"sendonly":"sendrecv",_.bundleOnly=void 0,u(_,P,M,k.sources),void(A[_.mid]=_)}if(h(P,M,g.media))return;const y=l.default(k);y.mid=g.media.length.toString(),y.direction="sendonly",u(y,P,M,k.sources),g.media.push(y)});else if(!g){const P=l.default(k);P.mid=Object.keys(A).length.toString(),A[k.mid]=P}}),m.media=g?g.media:Object.values(A);const R=[];m.media.forEach(k=>{R.push(k.mid),v&&(k.iceUfrag=O,k.icePwd=T),k.fingerprint=C}),m.groups.forEach(k=>{k.type==="BUNDLE"&&(k.mids=R.join(" "))}),m.msidSemantic={semantic:"WMS",token:"*"},m.origin.sessionVersion++;const w=a.default.write(m);return new RTCSessionDescription({type:o.type,sdp:w})}}},function(t,e,r){var i=this&&this.__importDefault||function(l){return l&&l.__esModule?l:{default:l}};Object.defineProperty(e,"__esModule",{value:!0});const a=i(r(50));e.default={write:function(l,n){return l!==void 0&&l.media!==void 0&&Array.isArray(l.media)&&l.media.forEach(c=>{c.sources&&c.sources.length&&(c.ssrcs=[],c.sources.forEach(s=>{Object.keys(s).forEach(d=>{d!=="id"&&c.ssrcs.push({id:s.id,attribute:d,value:s[d]})})}),delete c.sources),c.ssrcGroups&&c.ssrcGroups.length&&c.ssrcGroups.forEach(s=>{s.ssrcs!==void 0&&Array.isArray(s.ssrcs)&&(s.ssrcs=s.ssrcs.join(" "))})}),a.default.write(l,n)},parse:function(l){const n=a.default.parse(l);return n!==void 0&&n.media!==void 0&&Array.isArray(n.media)&&n.media.forEach(c=>{c.ssrcs!==void 0&&Array.isArray(c.ssrcs)&&(c.sources=[],c.ssrcs.forEach(s=>{const d=c.sources.findIndex(u=>u.id===s.id);if(d>-1)c.sources[d][s.attribute]=s.value;else{const u={id:s.id};u[s.attribute]=s.value,c.sources.push(u)}}),delete c.ssrcs),c.ssrcGroups!==void 0&&Array.isArray(c.ssrcGroups)&&c.ssrcGroups.forEach(s=>{typeof s.ssrcs=="string"&&(s.ssrcs=s.ssrcs.split(" "))})}),n}}},function(t,e,r){(function(i,a){var l="[object Arguments]",n="[object Function]",c="[object GeneratorFunction]",s="[object Map]",d="[object Set]",u=/\w*$/,h=/^\[object .+?Constructor\]$/,o=/^(?:0|[1-9]\d*)$/,f={};f[l]=f["[object Array]"]=f["[object ArrayBuffer]"]=f["[object DataView]"]=f["[object Boolean]"]=f["[object Date]"]=f["[object Float32Array]"]=f["[object Float64Array]"]=f["[object Int8Array]"]=f["[object Int16Array]"]=f["[object Int32Array]"]=f[s]=f["[object Number]"]=f["[object Object]"]=f["[object RegExp]"]=f[d]=f["[object String]"]=f["[object Symbol]"]=f["[object Uint8Array]"]=f["[object Uint8ClampedArray]"]=f["[object Uint16Array]"]=f["[object Uint32Array]"]=!0,f["[object Error]"]=f[n]=f["[object WeakMap]"]=!1;var m=typeof i=="object"&&i&&i.Object===Object&&i,g=typeof self=="object"&&self&&self.Object===Object&&self,v=m||g||Function("return this")(),O=e&&!e.nodeType&&e,T=O&&typeof a=="object"&&a&&!a.nodeType&&a,C=T&&T.exports===O;function A(q,oe){return q.set(oe[0],oe[1]),q}function R(q,oe){return q.add(oe),q}function w(q,oe,pe,ve){var we=-1,ke=q?q.length:0;for(ve;++we<ke;)pe=oe(pe,q[we],we,q);return pe}function k(q){var oe=!1;if(q!=null&&typeof q.toString!="function")try{oe=!!(q+"")}catch{}return oe}function I(q){var oe=-1,pe=Array(q.size);return q.forEach(function(ve,we){pe[++oe]=[we,ve]}),pe}function M(q,oe){return function(pe){return q(oe(pe))}}function P(q){var oe=-1,pe=Array(q.size);return q.forEach(function(ve){pe[++oe]=ve}),pe}var S,y=Array.prototype,_=Function.prototype,b=Object.prototype,E=v["__core-js_shared__"],x=(S=/[^.]+$/.exec(E&&E.keys&&E.keys.IE_PROTO||""))?"Symbol(src)_1."+S:"",D=_.toString,F=b.hasOwnProperty,V=b.toString,N=RegExp("^"+D.call(F).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),L=C?v.Buffer:void 0,U=v.Symbol,H=v.Uint8Array,j=M(Object.getPrototypeOf,Object),W=Object.create,Y=b.propertyIsEnumerable,te=y.splice,re=Object.getOwnPropertySymbols,G=L?L.isBuffer:void 0,K=M(Object.keys,Object),de=be(v,"DataView"),B=be(v,"Map"),$=be(v,"Promise"),z=be(v,"Set"),ie=be(v,"WeakMap"),Z=be(Object,"create"),ee=He(de),ce=He(B),ae=He($),ne=He(z),se=He(ie),he=U?U.prototype:void 0,ue=he?he.valueOf:void 0;function J(q){var oe=-1,pe=q?q.length:0;for(this.clear();++oe<pe;){var ve=q[oe];this.set(ve[0],ve[1])}}function X(q){var oe=-1,pe=q?q.length:0;for(this.clear();++oe<pe;){var ve=q[oe];this.set(ve[0],ve[1])}}function le(q){var oe=-1,pe=q?q.length:0;for(this.clear();++oe<pe;){var ve=q[oe];this.set(ve[0],ve[1])}}function ge(q){this.__data__=new X(q)}function fe(q,oe){var pe=$e(q)||function(Ce){return function(Ae){return function(Ne){return!!Ne&&typeof Ne=="object"}(Ae)&&qe(Ae)}(Ce)&&F.call(Ce,"callee")&&(!Y.call(Ce,"callee")||V.call(Ce)==l)}(q)?function(Ce,Ae){for(var Ne=-1,Le=Array(Ce);++Ne<Ce;)Le[Ne]=Ae(Ne);return Le}(q.length,String):[],ve=pe.length,we=!!ve;for(var ke in q)!F.call(q,ke)||we&&(ke=="length"||Xe(ke,ve))||pe.push(ke);return pe}function me(q,oe,pe){var ve=q[oe];F.call(q,oe)&&Je(ve,pe)&&(pe!==void 0||oe in q)||(q[oe]=pe)}function Q(q,oe){for(var pe=q.length;pe--;)if(Je(q[pe][0],oe))return pe;return-1}function ye(q,oe,pe,ve,we,ke,Ce){var Ae;if(ve&&(Ae=ke?ve(q,we,ke,Ce):ve(q)),Ae!==void 0)return Ae;if(!Ue(q))return q;var Ne=$e(q);if(Ne){if(Ae=function(Se){var Re=Se.length,Ie=Se.constructor(Re);return Re&&typeof Se[0]=="string"&&F.call(Se,"index")&&(Ie.index=Se.index,Ie.input=Se.input),Ie}(q),!oe)return function(Se,Re){var Ie=-1,De=Se.length;for(Re||(Re=Array(De));++Ie<De;)Re[Ie]=Se[Ie];return Re}(q,Ae)}else{var Le=Ve(q),Ye=Le==n||Le==c;if(Ze(q))return function(Se,Re){if(Re)return Se.slice();var Ie=new Se.constructor(Se.length);return Se.copy(Ie),Ie}(q,oe);if(Le=="[object Object]"||Le==l||Ye&&!ke){if(k(q))return ke?q:{};if(Ae=function(Se){return typeof Se.constructor!="function"||Ge(Se)?{}:(Re=j(Se),Ue(Re)?W(Re):{});var Re}(Ye?{}:q),!oe)return function(Se,Re){return Me(Se,xe(Se),Re)}(q,function(Se,Re){return Se&&Me(Re,We(Re),Se)}(Ae,q))}else{if(!f[Le])return ke?q:{};Ae=function(Se,Re,Ie,De){var Be=Se.constructor;switch(Re){case"[object ArrayBuffer]":return Oe(Se);case"[object Boolean]":case"[object Date]":return new Be(+Se);case"[object DataView]":return function(Te,Pe){var Fe=Pe?Oe(Te.buffer):Te.buffer;return new Te.constructor(Fe,Te.byteOffset,Te.byteLength)}(Se,De);case"[object Float32Array]":case"[object Float64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":return function(Te,Pe){var Fe=Pe?Oe(Te.buffer):Te.buffer;return new Te.constructor(Fe,Te.byteOffset,Te.length)}(Se,De);case s:return function(Te,Pe,Fe){return w(Pe?Fe(I(Te),!0):I(Te),A,new Te.constructor)}(Se,De,Ie);case"[object Number]":case"[object String]":return new Be(Se);case"[object RegExp]":return function(Te){var Pe=new Te.constructor(Te.source,u.exec(Te));return Pe.lastIndex=Te.lastIndex,Pe}(Se);case d:return function(Te,Pe,Fe){return w(Pe?Fe(P(Te),!0):P(Te),R,new Te.constructor)}(Se,De,Ie);case"[object Symbol]":return je=Se,ue?Object(ue.call(je)):{}}var je}(q,Le,ye,oe)}}Ce||(Ce=new ge);var Ke=Ce.get(q);if(Ke)return Ke;if(Ce.set(q,Ae),!Ne)var Qe=pe?function(Se){return function(Re,Ie,De){var Be=Ie(Re);return $e(Re)?Be:function(je,Te){for(var Pe=-1,Fe=Te.length,et=je.length;++Pe<Fe;)je[et+Pe]=Te[Pe];return je}(Be,De(Re))}(Se,We,xe)}(q):We(q);return function(Se,Re){for(var Ie=-1,De=Se?Se.length:0;++Ie<De&&Re(Se[Ie],Ie,Se)!==!1;);}(Qe||q,function(Se,Re){Qe&&(Se=q[Re=Se]),me(Ae,Re,ye(Se,oe,pe,ve,Re,q,Ce))}),Ae}function _e(q){return!(!Ue(q)||(oe=q,x&&x in oe))&&(ze(q)||k(q)?N:h).test(He(q));var oe}function Oe(q){var oe=new q.constructor(q.byteLength);return new H(oe).set(new H(q)),oe}function Me(q,oe,pe,ve){pe||(pe={});for(var we=-1,ke=oe.length;++we<ke;){var Ce=oe[we],Ae=void 0;me(pe,Ce,Ae===void 0?q[Ce]:Ae)}return pe}function Ee(q,oe){var pe,ve,we=q.__data__;return((ve=typeof(pe=oe))=="string"||ve=="number"||ve=="symbol"||ve=="boolean"?pe!=="__proto__":pe===null)?we[typeof oe=="string"?"string":"hash"]:we.map}function be(q,oe){var pe=function(ve,we){return ve==null?void 0:ve[we]}(q,oe);return _e(pe)?pe:void 0}J.prototype.clear=function(){this.__data__=Z?Z(null):{}},J.prototype.delete=function(q){return this.has(q)&&delete this.__data__[q]},J.prototype.get=function(q){var oe=this.__data__;if(Z){var pe=oe[q];return pe==="__lodash_hash_undefined__"?void 0:pe}return F.call(oe,q)?oe[q]:void 0},J.prototype.has=function(q){var oe=this.__data__;return Z?oe[q]!==void 0:F.call(oe,q)},J.prototype.set=function(q,oe){return this.__data__[q]=Z&&oe===void 0?"__lodash_hash_undefined__":oe,this},X.prototype.clear=function(){this.__data__=[]},X.prototype.delete=function(q){var oe=this.__data__,pe=Q(oe,q);return!(pe<0)&&(pe==oe.length-1?oe.pop():te.call(oe,pe,1),!0)},X.prototype.get=function(q){var oe=this.__data__,pe=Q(oe,q);return pe<0?void 0:oe[pe][1]},X.prototype.has=function(q){return Q(this.__data__,q)>-1},X.prototype.set=function(q,oe){var pe=this.__data__,ve=Q(pe,q);return ve<0?pe.push([q,oe]):pe[ve][1]=oe,this},le.prototype.clear=function(){this.__data__={hash:new J,map:new(B||X),string:new J}},le.prototype.delete=function(q){return Ee(this,q).delete(q)},le.prototype.get=function(q){return Ee(this,q).get(q)},le.prototype.has=function(q){return Ee(this,q).has(q)},le.prototype.set=function(q,oe){return Ee(this,q).set(q,oe),this},ge.prototype.clear=function(){this.__data__=new X},ge.prototype.delete=function(q){return this.__data__.delete(q)},ge.prototype.get=function(q){return this.__data__.get(q)},ge.prototype.has=function(q){return this.__data__.has(q)},ge.prototype.set=function(q,oe){var pe=this.__data__;if(pe instanceof X){var ve=pe.__data__;if(!B||ve.length<199)return ve.push([q,oe]),this;pe=this.__data__=new le(ve)}return pe.set(q,oe),this};var xe=re?M(re,Object):function(){return[]},Ve=function(q){return V.call(q)};function Xe(q,oe){return!!(oe=oe??9007199254740991)&&(typeof q=="number"||o.test(q))&&q>-1&&q%1==0&&q<oe}function Ge(q){var oe=q&&q.constructor;return q===(typeof oe=="function"&&oe.prototype||b)}function He(q){if(q!=null){try{return D.call(q)}catch{}try{return q+""}catch{}}return""}function Je(q,oe){return q===oe||q!=q&&oe!=oe}(de&&Ve(new de(new ArrayBuffer(1)))!="[object DataView]"||B&&Ve(new B)!=s||$&&Ve($.resolve())!="[object Promise]"||z&&Ve(new z)!=d||ie&&Ve(new ie)!="[object WeakMap]")&&(Ve=function(q){var oe=V.call(q),pe=oe=="[object Object]"?q.constructor:void 0,ve=pe?He(pe):void 0;if(ve)switch(ve){case ee:return"[object DataView]";case ce:return s;case ae:return"[object Promise]";case ne:return d;case se:return"[object WeakMap]"}return oe});var $e=Array.isArray;function qe(q){return q!=null&&function(oe){return typeof oe=="number"&&oe>-1&&oe%1==0&&oe<=9007199254740991}(q.length)&&!ze(q)}var Ze=G||function(){return!1};function ze(q){var oe=Ue(q)?V.call(q):"";return oe==n||oe==c}function Ue(q){var oe=typeof q;return!!q&&(oe=="object"||oe=="function")}function We(q){return qe(q)?fe(q):function(oe){if(!Ge(oe))return K(oe);var pe=[];for(var ve in Object(oe))F.call(oe,ve)&&ve!="constructor"&&pe.push(ve);return pe}(q)}a.exports=function(q){return ye(q,!0,!0)}}).call(this,r(70),r(235)(t))},function(t,e){t.exports=function(r){return r.webpackPolyfill||(r.deprecate=function(){},r.paths=[],r.children||(r.children=[]),Object.defineProperty(r,"loaded",{enumerable:!0,get:function(){return r.l}}),Object.defineProperty(r,"id",{enumerable:!0,get:function(){return r.i}}),r.webpackPolyfill=1),r}},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(P,S,y,_){_===void 0&&(_=y),Object.defineProperty(P,_,{enumerable:!0,get:function(){return S[y]}})}:function(P,S,y,_){_===void 0&&(_=y),P[_]=S[y]}),a=this&&this.__setModuleDefault||(Object.create?function(P,S){Object.defineProperty(P,"default",{enumerable:!0,value:S})}:function(P,S){P.default=S}),l=this&&this.__importStar||function(P){if(P&&P.__esModule)return P;var S={};if(P!=null)for(var y in P)y!=="default"&&Object.prototype.hasOwnProperty.call(P,y)&&i(S,P,y);return a(S,P),S},n=this&&this.__importDefault||function(P){return P&&P.__esModule?P:{default:P}};Object.defineProperty(e,"__esModule",{value:!0}),e.Firefox60=void 0;const c=l(r(50)),s=n(r(6)),d=n(r(8)),u=r(43),h=r(1),o=r(29),f=l(r(79)),m=l(r(27)),g=r(87),v=l(r(88)),O=r(138),T=l(r(148)),C=r(89),A=r(139),{generateRandomNumber:R}=r(27),w="Firefox_",k={OS:1024,MIS:1024};let I=0;class M extends g.HandlerInterface{constructor(){super(),this._sendingRemoteRtpParametersByKind={},this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._transportReady=!1,this._appData={},this.signalingState="stable"}static createFactory(){return()=>new M}get name(){return"Firefox60"}get remoteSdp(){return this._remoteSdp}close(){if(o.Logger.debug(w,"close()"),this._pc)try{this._pc.oniceconnectionstatechange=null,this._pc.close()}catch{}}async getNativeRtpCapabilities(){o.Logger.debug(w,"getNativeRtpCapabilities()");const S=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{S.addTransceiver("audio"),S.addTransceiver("video");const y=await S.createOffer();y.sdp.indexOf("a=rtcp-fb:111")&&y.sdp.indexOf("a=rtcp-fb:111 nack")===-1&&(y.sdp=y.sdp.replace(/(a=rtcp-fb:111.*)/,`$1\r
a=rtcp-fb:111 nack`));try{S.close()}catch{}const _=c.parse(y.sdp),b=v.extractRtpCapabilities({sdpObject:_});return A.addNackSuppportForOpus(b),b}catch(y){try{S.close()}catch{}throw y}}async getNativeSctpCapabilities(){return o.Logger.debug(w,"getNativeSctpCapabilities()"),{numStreams:k}}run({direction:S,iceParameters:y,iceCandidates:_,dtlsParameters:b,sctpParameters:E,iceServers:x,iceTransportPolicy:D,additionalSettings:F,proprietaryConstraints:V,extendedRtpCapabilities:N,appData:L}){o.Logger.debug(w,"run()",L),this._appData=L,this._direction=S,this._sendingRtpParametersByKind={audio:f.getSendingRtpParameters("audio",N),video:f.getSendingRtpParameters("video",N)},this._sendingRemoteRtpParametersByKind={audio:f.getSendingRemoteRtpParameters("audio",N),video:f.getSendingRemoteRtpParameters("video",N)},o.Logger.debug(w,"iceServers: %o",x);const U={iceServers:x||[],iceTransportPolicy:D||"all",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"};L.encodedInsertableStreams&&(U.encodedInsertableStreams=!0),this._pc=new RTCPeerConnection(U,V),this._pc.pcid=I++,this._pc.oniceconnectionstatechange=()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}},this._pc.onicecandidate=H=>{},this._pc.onicecandidateerror=H=>{o.Logger.debug("onicecandidateerror: ",H)}}async updateIceServers(S){o.Logger.debug(w,"updateIceServers()");const y=this._pc.getConfiguration();y.iceServers=S,this._pc.setConfiguration(y)}async restartIce(S){if(o.Logger.debug(w,"restartIce()"),this._remoteSdp.updateIceParameters(S),this._transportReady)if(this._direction){const y=await this._pc.createOffer({iceRestart:!0});y.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(y.sdp=y.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#${this._direction}`));let _=c.parse(y.sdp);_.media.forEach(E=>{E.type==="audio"&&this._direction==="send"&&E.ext&&E.rtcpFb&&(E.ext=E.ext.filter(x=>x.uri.indexOf("transport-wide-cc")==-1&&x.uri.indexOf("abs-send-time")==-1),E.rtcpFb.push({payload:111,type:"nack"}))}),y.sdp=c.write(_),o.Logger.debug(w,"restartIce() | calling pc.setLocalDescription()"),this.signalingState="have-local-offer",await this._pc.setLocalDescription(y);const b={type:"answer",sdp:this._remoteSdp.getSdp()};o.Logger.debug(w,"restartIce() | calling pc.setRemoteDescription()"),this.signalingState="stable",await this._pc.setRemoteDescription(b)}else{const y={type:"offer",sdp:this._remoteSdp.getSdp()};o.Logger.debug(w,"restartIce() | calling pc.setRemoteDescription()"),this.signalingState="stable",await this._pc.setRemoteDescription(y);const _=await this._pc.createAnswer();o.Logger.debug(w,"restartIce() | calling pc.setLocalDescription() [answer:%o]",_),this.signalingState="have-local-offer",await this._pc.setLocalDescription(_)}}async getTransportStats(){return this._pc.getStats()}async send({track:S,trackLow:y,encodings:_,codecOptions:b,codec:E,appData:x}){this._assertSendDirection(),o.Logger.debug(w,`[Produce] send() [kind: ${S.kind}, track.id: ${S.id}, appData: ${JSON.stringify(x)}]`),_&&_.length>1&&(_.forEach((G,K)=>{G.rid="r"+K}),_.reverse());const D=m.clone(this._sendingRtpParametersByKind[S.kind],{});let F={},V={};const N=new MediaStream;x.mediaType==="audio"&&this._pc.audioSender?(o.Logger.debug(w,"[Produce] audioSender更新track: ",this._pc.audioSender),this._pc.audioSender.replaceTrack(S)):x.mediaType==="video"&&this._pc.videoSender?(o.Logger.debug(w,"[Produce] videoSender更新track: ",this._pc.videoSender),this._pc.videoSender.replaceTrack(S),this._pc.videoSenderLow&&this._pc.videoSenderLow.track!==y&&(o.Logger.debug(w,"[Produce] videoSenderLow更新track: ",this._pc.videoSenderLow),this._pc.videoSenderLow.replaceTrack(y))):x.mediaType==="screenShare"&&this._pc.screenSender?(o.Logger.debug(w,"[Produce] screenSender更新track: ",this._pc.screenSender),this._pc.screenSender.replaceTrack(S),this._pc.screenSenderLow&&this._pc.screenSenderLow.track!==y&&(o.Logger.debug(w,"[Produce] screenSenderLow更新track: ",this._pc.screenSenderLow),this._pc.screenSenderLow.replaceTrack(y))):(N.addTrack(S),F=this._pc.addTransceiver(S,{direction:"sendonly",streams:[N]}),y&&(V=this._pc.addTransceiver(y,{direction:"sendonly",streams:[this._sendStream]})),x.mediaType!=="audio"||this._pc.audioSender?x.mediaType!=="video"||this._pc.videoSender?x.mediaType!=="screenShare"||this._pc.screenSender||(this._pc.screenSender=F.sender,this._pc.screenSenderLow=V.sender):(this._pc.videoSender=F.sender,this._pc.videoSenderLow=V.sender):this._pc.audioSender=F.sender),o.Logger.debug(w,"[Produce] send() | [transceivers:%d]",this._pc.getTransceivers().length);let L=await this._pc.createOffer();L.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(L.sdp=L.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#send`));let U=c.parse(L.sdp);x.preferRemb&&C.filterTransportCCFromSdp(U);let H,j,W;const Y=U.media.filter(G=>{const K=this._mapMidTransceiver.get(""+G.mid);return G.type===S.kind&&(!(K&&K.sender&&K.sender.track)||(K.sender.track.id===S.id?(H=G,!1):!y||K.sender.track.id!==y.id||(j=G,!1)))});H||(H=Y.pop()),y&&!j&&(j=Y.pop()),this._transportReady||(W=await this._setupTransport({localDtlsRole:"server",localSdpObject:U}));let te=H==null?void 0:H.mid;if(typeof te=="number"&&(te=""+te),!te)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"Firefox.send: localId 未找到"});let re=null;if(j&&(re=""+j.mid),D.mid=te,D.rtcp.cname=v.getCname({offerMediaObject:H}),_)if(_.length===1){let G=T.getRtpEncodings({offerMediaObject:H});Object.assign(G[0],_[0]),D.encodings=G}else D.encodings=_.reverse();else D.encodings=[],j&&(D.encodings=D.encodings.concat(T.getRtpEncodings({offerMediaObject:j}))),D.encodings=D.encodings.concat(T.getRtpEncodings({offerMediaObject:H}));return D.encodings.length>1&&(D.codecs[0].mimeType.toLowerCase()==="video/vp8"||D.codecs[0].mimeType.toLowerCase()),U.media.forEach(G=>{G.type==="audio"&&G.ext&&G.rtcpFb&&(G.ext=G.ext.filter(K=>K.uri.indexOf("transport-wide-cc")==-1&&K.uri.indexOf("abs-send-time")==-1),G.rtcpFb.push({payload:111,type:"nack"}))}),L.sdp=c.write(U),this._mapMidTransceiver.set(te,F),re&&this._mapMidTransceiver.set(re,V),{localId:te,localIdLow:re,rtpParameters:D,rtpSender:F.sender,rtpSenderLow:V.sender||null,dtlsParameters:W,offer:L}}async fillRemoteRecvSdp({kind:S,iceParameters:y,iceCandidates:_,dtlsParameters:b,sctpParameters:E,sendingRtpParameters:x,codecOptions:D,offer:F,audioProfile:V,codec:N,resetVideoSdp:L,appData:U}){o.Logger.debug(w,"fillRemoteRecvSdp() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(F),this._remoteSdp||(this._remoteSdp=new O.RemoteSdp({iceParameters:y,iceCandidates:_,dtlsParameters:b,sctpParameters:E}),this._remoteSdp.updateDtlsRole("client"));const H=m.clone(this._sendingRemoteRtpParametersByKind[S]);U.preferRemb?(o.Logger.debug(w,"publish() fillRemoteRecvSdp() |  使用REMB作为带宽估计方式"),C.filterTransportCCFromRtpParameters(H)):(o.Logger.debug(w,"publish() fillRemoteRecvSdp() |  使用transport-cc作为带宽估计方式"),C.filterRembFromRtpParameters(H)),H.codecs=u.reduceCodecs(H.codecs,N);let j=c.parse(this._pc.localDescription.sdp),W=this._remoteSdp.getNextMediaSectionIdx();L&&(x.mid?x.encodings&&x.encodings.length>1?W.idx=Number(x.mid)-(x.encodings.length-1):W.idx=Number(x.mid):o.Logger.warn(w,"fillRemoteRecvSdp() | mid 未找到"),W.reuseMid=!0);let Y=j.media[W.idx],te=null;x.encodings&&x.encodings.length>1&&(te=j.media[W.idx+1]),this._remoteSdp.send({offerMediaObjectArr:[Y,te],reuseMid:W.reuseMid,offerRtpParameters:x,answerRtpParameters:H,codecOptions:D,extmapAllowMixed:!0});const re={type:"answer",sdp:this._remoteSdp.getSdp()};if(o.Logger.debug(w,"audioProfile设置为: ",V),V){let G=null;switch(V){case"speech_low_quality":G="maxplaybackrate=16000;sprop-maxcapturerate=16000;maxaveragebitrate=32000";break;case"speech_standard":G="maxplaybackrate=32000;sprop-maxcapturerate=32000;maxaveragebitrate=36000";break;case"music_standard":G="maxplaybackrate=48000;sprop-maxcapturerate=48000;";break;case"standard_stereo":G="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=56000";break;case"high_quality":G="maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=128000";break;case"high_quality_stereo":G="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=192000"}re.sdp.indexOf("a=fmtp:111")&&(re.sdp=re.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;useinbandfec=1;"+G)),re.sdp=re.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=maxptime:60")}o.Logger.debug(w,"fillRemoteRecvSdp() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(re)}async stopSending(S,y){this._assertSendDirection(),o.Logger.debug(w,"stopSending() [localId:%s]",S);const _=this._mapMidTransceiver.get(S);if(!_)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"Firefox.stopSending: RTCRtpTransceiver 未找到"});y==="audio"?this._pc.audioSender.replaceTrack(null):y==="video"?(this._pc.videoSender.replaceTrack(null),this._pc.videoSenderLow&&this._pc.videoSenderLow.replaceTrack(null)):y==="screenShare"?(this._pc.screenSender.replaceTrack(null),this._pc.screenSenderLow&&this._pc.screenSenderLow.replaceTrack(null)):(_.sender.replaceTrack(null),this._pc.removeTrack(_.sender),this._remoteSdp.disableMediaSection(_.mid));const b=await this._pc.createOffer();b.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(b.sdp=b.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#send`));let E=c.parse(b.sdp);E.media.forEach(D=>{D.type==="audio"&&D.ext&&D.rtcpFb&&(D.ext=D.ext.filter(F=>F.uri.indexOf("transport-wide-cc")==-1&&F.uri.indexOf("abs-send-time")==-1),D.rtcpFb.push({payload:111,type:"nack"}))}),b.sdp=c.write(E),o.Logger.debug(w,"stopSending() | calling pc.setLocalDescription()");try{await this._pc.setLocalDescription(b)}catch(D){o.Logger.debug(w,"setLocalDescription error = %o",D)}const x={type:"answer",sdp:this._remoteSdp.getSdp()};o.Logger.debug(w,"stopSending() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(x),this._mapMidTransceiver.delete(S)}async replaceTrack(S,y){this._assertSendDirection(),y?o.Logger.debug(w,"replaceTrack() [localId:%s, track.id:%s]",S,y.id):o.Logger.debug(w,"replaceTrack() [localId:%s, no track]",S);const _=this._mapMidTransceiver.get(S);await(_==null?void 0:_.sender.replaceTrack(y))}async setMaxSpatialLayer(S,y){this._assertSendDirection(),o.Logger.debug(w,"setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",S,y);const _=this._mapMidTransceiver.get(S),b=_==null?void 0:_.sender.getParameters();y=b.encodings.length-1-y,b.encodings.forEach((E,x)=>{E.active=x>=y}),await(_==null?void 0:_.sender.setParameters(b))}async setRtpEncodingParameters(S,y){this._assertSendDirection(),o.Logger.debug(w,"setRtpEncodingParameters() [localId:%s, params:%o]",S,y);const _=this._mapMidTransceiver.get(S);if(!_)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"Firefox.setRtpEncodingParameters: RTCRtpTransceiver 未找到"});const b=_.sender.getParameters();b.encodings.forEach((E,x)=>{b.encodings[x]=Object.assign(Object.assign({},E),y)}),await _.sender.setParameters(b)}async getSenderStats(S){this._assertSendDirection();const y=this._mapMidTransceiver.get(S);if(!y)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"Firefox.getSenderStats: RTCRtpTransceiver 未找到"});return y.sender.getStats()}async recoverTransceiver(S,y,_){o.Logger.debug(w,"recoverTransceiver() [kind:%s, remoteUid:%s, mid: %s]",_,S,y);const b=this._mapMidTransceiver.get(y);b?b.isUseless=!0:o.Logger.debug(w,"recoverTransceiver() transceiver undefined")}async prepareLocalSdp(S,y){o.Logger.debug(w,`[Subscribe] prepareLocalSdp() [kind: ${S}, remoteUid: ${y}]`);let _,b=-1;if(h.getParameters().reuseMid)for(const V of this._mapMidTransceiver.keys()){const N=this._mapMidTransceiver.get(V);if(!N)continue;const L=N.receiver&&N.receiver.track&&N.receiver.track.kind||S;if(N.isUseless&&L===S){b=V-0,N.isUseless=!1;break}}let E=null;if(b===-1){if(o.Logger.debug(w,"[Subscribe] prepareLocalSdp() 添加一个M行"),E=this._pc.addTransceiver(S,{direction:"recvonly"}),E.remoteUid=y,_=await this._pc.createOffer(),!_.sdp)throw o.Logger.error(w,"[Subscribe] prepareLocalSdp() offer没有sdp"),new Error("INVALID_OFFER");_.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(_.sdp=_.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#recv`),_.sdp.indexOf("a=rtcp-fb:111")&&_.sdp.indexOf("a=rtcp-fb:111 nack")===-1&&(_.sdp=_.sdp.replace(/(a=rtcp-fb:111.*)/,`$1\r
a=rtcp-fb:111 nack`)))}else if(this._pc.localDescription)_={type:"offer",sdp:this._pc.localDescription.sdp};else{if(_=await this._pc.createOffer(),!_.sdp)throw o.Logger.error(w,"[Subscribe] prepareLocalSdp() offer没有sdp"),new Error("INVALID_OFFER");_.sdp.indexOf("a=rtcp-fb:111")&&_.sdp.indexOf("a=rtcp-fb:111 nack")===-1&&(_.sdp=_.sdp.replace(/(a=rtcp-fb:111.*)/,`$1\r
a=rtcp-fb:111 nack`)),_.sdp.indexOf("a=fmtp:111")&&(_.sdp=_.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z-]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1"));const V=c.parse(_.sdp);b=V.media[V.media.length-1].mid}if(!_.sdp)throw o.Logger.error(w,"[Subscribe] prepareLocalSdp() offer没有sdp"),new Error("INVALID_OFFER");const x=c.parse(_.sdp);let D;this._transportReady||(D=await this._setupTransport({localDtlsRole:"server",localSdpObject:x}));const F=v.extractRtpCapabilities({sdpObject:x});return A.addNackSuppportForOpus(F),b===-1&&(b=x.media[x.media.length-1].mid,this._mapMidTransceiver.set(""+b,E)),{dtlsParameters:D,rtpCapabilities:F,offer:_,mid:b,iceUfragReg:""}}async receive({iceParameters:S,iceCandidates:y,dtlsParameters:_,sctpParameters:b,trackId:E,kind:x,rtpParameters:D,offer:F,probeSSrc:V=-1,remoteUid:N,extendedRtpCapabilities:L,appData:U}){this._assertRecvDirection(),o.Logger.debug(w,`[Subscribe] receive() [trackId: ${E}, kind: ${x}, remoteUid: ${N}]`),this._remoteSdp||(this._remoteSdp=new O.RemoteSdp({iceParameters:S,iceCandidates:y,dtlsParameters:_,sctpParameters:b}),this._remoteSdp.updateDtlsRole("client"));let H=D&&D.mid||U.mid;if(o.Logger.debug(w,"[Subscribe] receive() mid: "+H),D.mid)this._remoteSdp.receive({mid:H,kind:x,offerRtpParameters:D,streamId:D.rtcp.cname,trackId:E});else{const Y=E+"_"+R();o.Logger.debug(w,"[Subscribe] receive() 容错流程 trackId: ",Y);const te=[];L.codecs.forEach(G=>{if(G.kind===x){const K=Object.assign({},G);K.parameters=K.parameters||K.localParameters,K.payloadType=K.payloadType||K.localPayloadType,te.push(K)}});const re={mid:H,kind:x,offerRtpParameters:{codecs:te,encodings:[{ssrc:0}],headerExtensions:[],rtcp:{},mid:H},streamId:x,trackId:Y,reuseMediaSection:void 0};this._remoteSdp.receive(re),this._remoteSdp.disableMediaSection(""+H)}const j={type:"answer",sdp:this._remoteSdp.getSdp()};j.sdp.indexOf("a=fmtp:111")&&(j.sdp=j.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1")),h.getParameters().enableSdpRrtr==="all"&&(F.sdp=F.sdp.replace(/a=rtcp-fb:(\d+) rrtr ?\r\n/g,""),F.sdp=F.sdp.replace(/a=rtcp-fb:(\d+) nack ?\r\n/g,`a=rtcp-fb:$1 rrtr\r
a=rtcp-fb:$1 nack\r
`),j.sdp=j.sdp.replace(/a=rtcp-fb:(\d+) rrtr ?\r\n/g,""),j.sdp=j.sdp.replace(/a=rtcp-fb:(\d+) nack ?\r\n/g,`a=rtcp-fb:$1 rrtr\r
a=rtcp-fb:$1 nack\r
`)),h.getParameters().enableUdpCandidate||(j.sdp=j.sdp.replace(/\r\na=candidate:udpcandidate[^\r]+/g,"")),h.getParameters().enableTcpCandidate||(j.sdp=j.sdp.replace(/\r\na=candidate:tcpcandidate[^\r]+/g,"")),o.Logger.debug(w,"[Subscribe] receive() | calling pc.setLocalDescription()");try{await this._pc.setLocalDescription(F)}catch(Y){if(Y.name!=="InvalidModificationError")throw Y;await this._pc.createOffer(),await this._pc.setLocalDescription(F)}o.Logger.debug(w,"[Subscribe] receive() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(j);const W=this._pc.getTransceivers().find(Y=>Y.mid===H);return W.isUseless=!D.mid,this._mapMidTransceiver.set(H,W),{localId:H,track:W.receiver.track,rtpReceiver:W.receiver}}async stopReceiving(S){this._assertRecvDirection(),o.Logger.debug(w,"stopReceiving() [localId:%s]",S);const y=this._mapMidTransceiver.get(S);if(!y||!y.mid)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"Firefox.stopReceiving: RTCRtpTransceiver 未找到"});y.receiver&&y.receiver.track&&y.receiver.track&&y.receiver.track.kind==="audio"||(y.isUseless=!0),this._remoteSdp.disableMediaSection(y.mid)}async getReceiverStats(S){this._assertRecvDirection();const y=this._mapMidTransceiver.get(S);if(!y)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"Firefox.getReceiverStats: RTCRtpTransceiver 未找到"});return y.receiver.getStats()}async _setupTransport({localDtlsRole:S,localSdpObject:y}){y||(y=c.parse(this._pc.localDescription.sdp));const _=v.extractDtlsParameters({sdpObject:y});return _.role=S,this._transportReady=!0,_}_assertSendDirection(){if(this._direction!=="send")throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"_assertSendDirection: 操作异常"})}_assertRecvDirection(){if(this._direction!=="recv")throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"_assertRecvDirection: 操作异常"})}}e.Firefox60=M},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(S,y,_,b){b===void 0&&(b=_),Object.defineProperty(S,b,{enumerable:!0,get:function(){return y[_]}})}:function(S,y,_,b){b===void 0&&(b=_),S[b]=y[_]}),a=this&&this.__setModuleDefault||(Object.create?function(S,y){Object.defineProperty(S,"default",{enumerable:!0,value:y})}:function(S,y){S.default=y}),l=this&&this.__importStar||function(S){if(S&&S.__esModule)return S;var y={};if(S!=null)for(var _ in S)_!=="default"&&Object.prototype.hasOwnProperty.call(S,_)&&i(y,S,_);return a(y,S),y},n=this&&this.__importDefault||function(S){return S&&S.__esModule?S:{default:S}};Object.defineProperty(e,"__esModule",{value:!0}),e.Safari12=void 0;const c=l(r(50)),s=n(r(6)),d=n(r(8)),u=r(43),h=r(238),o=r(1),f=r(29),m=l(r(79)),g=l(r(27)),v=r(87),O=l(r(88)),T=r(138),C=l(r(148)),A=r(89),R=r(139),{generateRandomNumber:w}=r(27),k="Safari_",I={OS:1024,MIS:1024};let M=0;class P extends v.HandlerInterface{constructor(){super(),this._sendingRemoteRtpParametersByKind={},this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._transportReady=!1,this._appData={}}static createFactory(){return()=>new P}get name(){return"Safari12"}get remoteSdp(){return this._remoteSdp}close(){if(f.Logger.debug(k,"close()"),this._pc)try{this._pc.close()}catch{}}async getNativeRtpCapabilities(){f.Logger.debug(k,"getNativeRtpCapabilities()");const y=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{y.addTransceiver("audio"),y.addTransceiver("video");const _=await y.createOffer();_.sdp.indexOf("a=rtcp-fb:111")&&_.sdp.indexOf("a=rtcp-fb:111 nack")===-1&&(_.sdp=_.sdp.replace(/(a=rtcp-fb:111.*)/,`$1\r
a=rtcp-fb:111 nack`));try{y.close()}catch{}const b=c.parse(_.sdp),E=O.extractRtpCapabilities({sdpObject:b});return R.addNackSuppportForOpus(E),E}catch(_){try{y.close()}catch{}throw _}}async getNativeSctpCapabilities(){return f.Logger.debug(k,"getNativeSctpCapabilities()"),{numStreams:I}}run({direction:y,iceParameters:_,iceCandidates:b,dtlsParameters:E,sctpParameters:x,iceServers:D,iceTransportPolicy:F,additionalSettings:V,proprietaryConstraints:N,extendedRtpCapabilities:L,appData:U}){f.Logger.debug(k,"run()"),this._direction=y,this._appData=U,this._sendingRtpParametersByKind={audio:m.getSendingRtpParameters("audio",L),video:m.getSendingRtpParameters("video",L)},this._sendingRemoteRtpParametersByKind={audio:m.getSendingRemoteRtpParameters("audio",L),video:m.getSendingRemoteRtpParameters("video",L)},this._pc=new RTCPeerConnection(Object.assign({iceServers:D||[],iceTransportPolicy:F||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},V),N),this._pc.pcid=M++,this._pc.onconnectionstatechange=()=>{switch(this._pc.connectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}}}async updateIceServers(y){f.Logger.debug(k,"updateIceServers()");const _=this._pc.getConfiguration();_.iceServers=y,this._pc.setConfiguration(_)}async restartIce(y){if(f.Logger.debug(k,"restartIce()"),this._remoteSdp.updateIceParameters(y),this._transportReady)if(this._direction){const _=await this._pc.createOffer({iceRestart:!0});let b=c.parse(_.sdp);b.media.forEach(x=>{x.type==="audio"&&this._direction==="send"&&x.ext&&x.rtcpFb&&(x.ext=x.ext.filter(D=>D.uri.indexOf("transport-wide-cc")==-1&&D.uri.indexOf("abs-send-time")==-1),x.rtcpFb.push({payload:111,type:"nack"}))}),_.sdp=c.write(b),f.Logger.debug(k,"restartIce() | calling pc.setLocalDescription() [offer:%o]",_),await this._pc.setLocalDescription(_);const E={type:"answer",sdp:this._remoteSdp.getSdp()};f.Logger.debug(k,"restartIce() | calling pc.setRemoteDescription() [answer:%o]",E),await this._pc.setRemoteDescription(E)}else{const _={type:"offer",sdp:this._remoteSdp.getSdp()};f.Logger.debug(k,"restartIce() | calling pc.setRemoteDescription() [offer:%o]",_),await this._pc.setRemoteDescription(_);const b=await this._pc.createAnswer();f.Logger.debug(k,"restartIce() | calling pc.setLocalDescription() [answer:%o]",b),await this._pc.setLocalDescription(b)}}async getTransportStats(){return this._pc.getStats()}async send({track:y,trackLow:_,encodings:b,codecOptions:E,codec:x,appData:D}){this._assertSendDirection(),f.Logger.debug(k,`send() [kind: ${y.kind}, track.id: ${y.id}, appData: ${JSON.stringify(D)}]`);const F=g.clone(this._sendingRtpParametersByKind[y.kind],{});let V={},N={};const L=new MediaStream;D.mediaType==="audio"&&this._pc.audioSender?(f.Logger.warn(k,"audioSender更新track: ",this._pc.audioSender.track,"=>",y),this._pc.audioSender.replaceTrack(y)):D.mediaType==="video"&&this._pc.videoSender?(f.Logger.warn(k,"videoSender更新track: ",this._pc.videoSender.track,"=>",y),this._pc.videoSender.replaceTrack(y),this._pc.videoSenderLow&&this._pc.videoSenderLow.track!==_&&(f.Logger.debug(k,"videoSenderLow更新track: ",this._pc.videoSenderLow),this._pc.videoSenderLow.replaceTrack(_))):D.mediaType==="screenShare"&&this._pc.screenSender?(f.Logger.warn(k,"screenSender更新track: ",this._pc.screenSender.track,"=>",y),this._pc.screenSender.replaceTrack(y),this._pc.screenSenderLow&&this._pc.screenSenderLow.track!==_&&(f.Logger.debug(k,"screenSenderLow更新track: ",this._pc.screenSenderLow),this._pc.screenSenderLow.replaceTrack(_))):(L.addTrack(y),V=this._pc.addTransceiver(y,{direction:"sendonly",streams:[L]}),_&&(N=this._pc.addTransceiver(_,{direction:"sendonly",streams:[this._sendStream]})),D.mediaType!=="audio"||this._pc.audioSender?D.mediaType!=="video"||this._pc.videoSender?D.mediaType!=="screenShare"||this._pc.screenSender||(this._pc.screenSender=V.sender,this._pc.screenSenderLow=N.sender):(this._pc.videoSender=V.sender,this._pc.videoSenderLow=N.sender):this._pc.audioSender=V.sender),D.mediaType!=="audio"||this._pc.audioSender?D.mediaType!=="video"||this._pc.videoSender?D.mediaType!=="screenShare"||this._pc.screenSender||(this._pc.screenSender=V.sender):this._pc.videoSender=V.sender:this._pc.audioSender=V.sender,f.Logger.debug(k,"send() | [transceivers:%d]",this._pc.getTransceivers().length);let U=await this._pc.createOffer(),H=c.parse(U.sdp);D.preferRemb&&A.filterTransportCCFromSdp(H);let j,W,Y;const te=H.media.filter(K=>{const de=this._mapMidTransceiver.get(""+K.mid);return K.type===y.kind&&(!(de&&de.sender&&de.sender.track)||(de.sender.track.id===y.id?(j=K,!1):!_||de.sender.track.id!==_.id||(W=K,!1)))});j||(j=te.pop()),_&&!W&&(W=te.pop()),this._transportReady||(Y=await this._setupTransport({localDtlsRole:"server",localSdpObject:H}));let re=j==null?void 0:j.mid;if(typeof re=="number"&&(re=""+re),!re)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"Safari.send: localId 未找到"});let G=null;if(W&&(G=""+W.mid),F.mid=re,f.Logger.debug(k,"要检查M行: ",j),F.rtcp.cname=O.getCname({offerMediaObject:j}),b)if(b.length===1){let K=C.getRtpEncodings({offerMediaObject:j});Object.assign(K[0],b[0]),F.encodings=K}else F.encodings=b;else F.encodings=[],W&&(F.encodings=F.encodings.concat(C.getRtpEncodings({offerMediaObject:W}))),F.encodings=F.encodings.concat(C.getRtpEncodings({offerMediaObject:j}));return F.encodings.length>1&&(F.codecs[0].mimeType.toLowerCase()==="video/vp8"||F.codecs[0].mimeType.toLowerCase()==="video/h264")&&H.media.forEach(K=>{K.type==="audio"&&K.ext&&K.rtcpFb&&(K.ext=K.ext.filter(de=>de.uri.indexOf("transport-wide-cc")==-1&&de.uri.indexOf("abs-send-time")==-1),K.rtcpFb.push({payload:111,type:"nack"}))}),U.sdp=c.write(H),this._mapMidTransceiver.set(re,V),G&&this._mapMidTransceiver.set(G,N),{localId:re,localIdLow:G,rtpParameters:F,rtpSender:V.sender,rtpSenderLow:N.sender||null,dtlsParameters:Y,offer:U}}async fillRemoteRecvSdp({kind:y,iceParameters:_,iceCandidates:b,dtlsParameters:E,sctpParameters:x,sendingRtpParameters:D,codecOptions:F,offer:V,audioProfile:N,codec:L,resetVideoSdp:U,appData:H}){let j=c.parse(V.sdp);j.media.forEach(de=>{de.type==="audio"&&de.ext&&de.rtcpFb&&(de.ext=de.ext.filter(B=>B.uri.indexOf("transport-wide-cc")==-1&&B.uri.indexOf("abs-send-time")==-1),de.rtcpFb.push({payload:111,type:"nack"}))}),V.sdp=c.write(j),f.Logger.debug(k,"fillRemoteRecvSdp() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(V),this._remoteSdp||(this._remoteSdp=new T.RemoteSdp({iceParameters:_,iceCandidates:b,dtlsParameters:E,sctpParameters:x}),this._remoteSdp.updateDtlsRole("client"));const W=g.clone(this._sendingRemoteRtpParametersByKind[y]);H.preferRemb?(f.Logger.debug(k,"publish() fillRemoteRecvSdp() |  使用REMB作为带宽估计方式"),A.filterTransportCCFromRtpParameters(W)):(f.Logger.debug(k,"publish() fillRemoteRecvSdp() |  使用transport-cc作为带宽估计方式"),A.filterRembFromRtpParameters(W)),W.codecs=u.reduceCodecs(W.codecs,L);let Y=c.parse(this._pc.localDescription.sdp),te=this._remoteSdp.getNextMediaSectionIdx();U&&(D.mid?D.encodings&&D.encodings.length>1?te.idx=Number(D.mid)-(D.encodings.length-1):te.idx=Number(D.mid):f.Logger.warn(k,"fillRemoteRecvSdp() | mid 未找到"),te.reuseMid=!0);let re=Y.media[te.idx],G=null;D.encodings&&D.encodings.length>1&&(G=Y.media[te.idx+1]),this._remoteSdp.send({offerMediaObjectArr:[re,G],reuseMid:te.reuseMid,offerRtpParameters:D,answerRtpParameters:W,codecOptions:F,extmapAllowMixed:!0});const K={type:"answer",sdp:this._remoteSdp.getSdp()};if(f.Logger.debug(k,"audioProfile设置为: ",N),N){let de=null;switch(N){case"speech_low_quality":de="maxplaybackrate=16000;sprop-maxcapturerate=16000;maxaveragebitrate=32000";break;case"speech_standard":de="maxplaybackrate=32000;sprop-maxcapturerate=32000;maxaveragebitrate=36000";break;case"music_standard":de="maxplaybackrate=48000;sprop-maxcapturerate=48000;";break;case"standard_stereo":de="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=56000";break;case"high_quality":de="maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=128000";break;case"high_quality_stereo":de="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=192000"}K.sdp.indexOf("a=fmtp:111")&&(K.sdp=K.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;useinbandfec=1;"+de)),K.sdp=K.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=maxptime:60")}h.canShimVideoOrientation(V,K)&&h.shimVideoOrientation(V,K),f.Logger.debug(k,"fillRemoteRecvSdp() | calling pc.setRemoteDescription() [answer:%o]",K.sdp),await this._pc.setRemoteDescription(K)}async stopSending(y,_){this._assertSendDirection(),f.Logger.debug(k,"stopSending() [localId:%s]",y);const b=this._mapMidTransceiver.get(y);_==="audio"?(this._pc.audioSender.replaceTrack(null),f.Logger.debug(k,"删除发送的audio track: ",this._pc.audioSender)):_==="video"?(this._pc.videoSenderLow&&this._pc.videoSenderLow.replaceTrack(null),this._pc.videoSender.replaceTrack(null),f.Logger.debug(k,"删除发送的video track: ",this._pc.videoSender)):_==="screenShare"?(this._pc.screenSender.replaceTrack(null),this._pc.screenSenderLow&&this._pc.screenSenderLow.replaceTrack(null),f.Logger.debug(k,"删除发送的screen track: ",this._pc.screenSender)):b==null||b.sender.replaceTrack(null);const E=await this._pc.createOffer();let x=c.parse(E.sdp);x.media.forEach(F=>{F.type==="audio"&&F.ext&&F.rtcpFb&&(F.ext=F.ext.filter(V=>V.uri.indexOf("transport-wide-cc")==-1&&V.uri.indexOf("abs-send-time")==-1),F.rtcpFb.push({payload:111,type:"nack"}))}),E.sdp=c.write(x),f.Logger.debug(k,"stopSending() | calling pc.setLocalDescription() [offer:%o]",E.sdp),await this._pc.setLocalDescription(E);const D={type:"answer",sdp:this._remoteSdp.getSdp()};f.Logger.debug(k,"stopSending() | calling pc.setRemoteDescription() [answer:%o]",D),await this._pc.setRemoteDescription(D)}async replaceTrack(y,_){this._assertSendDirection(),_?f.Logger.debug(k,"replaceTrack() [localId:%s, track.id:%s]",y,_.id):f.Logger.debug(k,"replaceTrack() [localId:%s, no track]",y);const b=this._mapMidTransceiver.get(y);await(b==null?void 0:b.sender.replaceTrack(_))}async setMaxSpatialLayer(y,_){this._assertSendDirection(),f.Logger.debug(k,"setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",y,_);const b=this._mapMidTransceiver.get(y);if(!b)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"Safari.setMaxSpatialLayer: RTCRtpTransceiver 未找到"});const E=b.sender.getParameters();E.encodings.forEach((x,D)=>{x.active=D<=_}),await b.sender.setParameters(E)}async setRtpEncodingParameters(y,_){this._assertSendDirection(),f.Logger.debug(k,"setRtpEncodingParameters() [localId:%s, params:%o]",y,_);const b=this._mapMidTransceiver.get(y);if(!b)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"Safari.setRtpEncodingParameters: RTCRtpTransceiver 未找到"});const E=b.sender.getParameters();E.encodings.forEach((x,D)=>{E.encodings[D]=Object.assign(Object.assign({},x),_)}),await b.sender.setParameters(E)}async getSenderStats(y){this._assertSendDirection();const _=this._mapMidTransceiver.get(y);if(!_)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"Safari.getSenderStats: RTCRtpTransceiver 未找到"});return _.sender.getStats()}async recoverTransceiver(y,_,b){f.Logger.debug(k,"recoverTransceiver() [kind:%s, remoteUid:%s, mid: %s]",b,y,_);const E=this._mapMidTransceiver.get(_);E?E.isUseless=!0:f.Logger.debug(k,"recoverTransceiver() transceiver undefined")}async prepareLocalSdp(y,_){f.Logger.debug(k,`[Subscribe] prepareLocalSdp() [kind: ${y}, remoteUid: ${_}]`);let b=-1;if(o.getParameters().reuseMid)for(const N of this._mapMidTransceiver.keys()){const L=this._mapMidTransceiver.get(N);if(!L)continue;const U=L.receiver&&L.receiver.track&&L.receiver.track.kind||y;if(L.isUseless&&U===y){b=N-0,L.isUseless=!1;break}}let E=null,x=null;if(b===-1)f.Logger.debug(k,"[Subscribe] prepareLocalSdp() 添加一个M行"),x=this._pc.addTransceiver(y,{direction:"recvonly"}),x.remoteUid=_,E=await this._pc.createOffer(),E.sdp.indexOf("a=rtcp-fb:111")&&E.sdp.indexOf("a=rtcp-fb:111 nack")===-1&&(E.sdp=E.sdp.replace(/(a=rtcp-fb:111.*)/,`$1\r
a=rtcp-fb:111 nack`));else if(this._pc.localDescription)E={type:this._pc.localDescription.type,sdp:this._pc.localDescription.sdp};else if(!this._pc.localDescription){E=await this._pc.createOffer(),E.sdp.indexOf("a=rtcp-fb:111")&&E.sdp.indexOf("a=rtcp-fb:111 nack")===-1&&(E.sdp=E.sdp.replace(/(a=rtcp-fb:111.*)/,`$1\r
a=rtcp-fb:111 nack`)),E.sdp.indexOf("a=fmtp:111")&&(E.sdp=E.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z-]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1"));const N=c.parse(E.sdp);b=N.media[N.media.length-1].mid}const D=c.parse(E.sdp);let F;this._transportReady||(F=await this._setupTransport({localDtlsRole:"server",localSdpObject:D}));const V=O.extractRtpCapabilities({sdpObject:D});return R.addNackSuppportForOpus(V),b===-1&&(b=D.media[D.media.length-1].mid,this._mapMidTransceiver.set(""+b,x)),{dtlsParameters:F,rtpCapabilities:V,offer:E,mid:b,iceUfragReg:""}}async receive({iceParameters:y,iceCandidates:_,dtlsParameters:b,sctpParameters:E,trackId:x,kind:D,rtpParameters:F,offer:V,probeSSrc:N=-1,remoteUid:L,extendedRtpCapabilities:U,appData:H}){this._assertRecvDirection(),f.Logger.debug(k,`[Subscribe] receive() [trackId: ${x}, kind: ${D}, remoteUid: ${L}]`),this._remoteSdp||(this._remoteSdp=new T.RemoteSdp({iceParameters:y,iceCandidates:_,dtlsParameters:b,sctpParameters:E}),this._remoteSdp.updateDtlsRole("client"));let j=F&&F.mid||H.mid;if(f.Logger.debug(k,"receive() mid: "+j),F.mid)this._remoteSdp.receive({mid:j,kind:D,offerRtpParameters:F,streamId:F.rtcp.cname,trackId:x});else{const te=x+"_"+w();f.Logger.debug(k,"[Subscribe] receive() 容错流程 trackId: ",te);const re=[];U.codecs.forEach(K=>{if(K.kind===D){const de=Object.assign({},K);de.parameters=de.parameters||de.localParameters,de.payloadType=de.payloadType||de.localPayloadType,re.push(de)}});const G={mid:j,kind:D,offerRtpParameters:{codecs:re,encodings:[{ssrc:0}],headerExtensions:[],rtcp:{},mid:j},streamId:D,trackId:te,reuseMediaSection:void 0};this._remoteSdp.receive(G),this._remoteSdp.disableMediaSection(""+j)}let W={type:"answer",sdp:this._remoteSdp.getSdp()};W.sdp.indexOf("a=fmtp:111")&&(W.sdp=W.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1")),o.getParameters().enableSdpRrtr==="all"&&(V.sdp=V.sdp.replace(/a=rtcp-fb:(\d+) rrtr ?\r\n/g,""),V.sdp=V.sdp.replace(/a=rtcp-fb:(\d+) nack ?\r\n/g,`a=rtcp-fb:$1 rrtr\r
a=rtcp-fb:$1 nack\r
`),W.sdp=W.sdp.replace(/a=rtcp-fb:(\d+) rrtr ?\r\n/g,""),W.sdp=W.sdp.replace(/a=rtcp-fb:(\d+) nack ?\r\n/g,`a=rtcp-fb:$1 rrtr\r
a=rtcp-fb:$1 nack\r
`)),o.getParameters().enableUdpCandidate||(W.sdp=W.sdp.replace(/\r\na=candidate:udpcandidate[^\r]+/g,"")),o.getParameters().enableTcpCandidate||(W.sdp=W.sdp.replace(/\r\na=candidate:tcpcandidate[^\r]+/g,"")),f.Logger.debug(k,"[Subscribe] receive() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(V),f.Logger.debug(k,"[Subscribe] receive() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(W);const Y=this._pc.getTransceivers().find(te=>te.mid===j);if(!Y)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"Safari.receive: RTCRtpTransceiver 未找到"});return this._mapMidTransceiver.set(j,Y),{localId:j,track:Y.receiver.track,rtpReceiver:Y.receiver}}async stopReceiving(y){this._assertRecvDirection(),f.Logger.debug(k,"stopReceiving() [localId:%s]",y);const _=this._mapMidTransceiver.get(y);if(!_||!_.mid)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"Safari.stopReceiving: RTCRtpTransceiver 未找到"});f.Logger.debug(k,"transceiver: ",_),_.receiver&&_.receiver.track&&_.receiver.track&&_.receiver.track.kind==="audio"||(_.isUseless=!0),this._remoteSdp.disableMediaSection(_.mid);const b=this._pc.localDescription;f.Logger.debug(k,"stopReceiving() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(b);const E={type:"answer",sdp:this._remoteSdp.getSdp()};f.Logger.debug(k,"stopReceiving() | calling pc.setRemoteDescription() [answer:%o]",E.sdp),await this._pc.setRemoteDescription(E)}async getReceiverStats(y){this._assertRecvDirection();const _=this._mapMidTransceiver.get(y);if(!_)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"Safari.getReceiverStats: RTCRtpTransceiver 未找到"});return _.receiver.getStats()}async _setupTransport({localDtlsRole:y,localSdpObject:_}){_||(_=c.parse(this._pc.localDescription.sdp));const b=O.extractDtlsParameters({sdpObject:_});return b.role=y,this._transportReady=!0,b}_assertSendDirection(){if(this._direction!=="send")throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"_assertSendDirection: 操作异常"})}_assertRecvDirection(){if(this._direction!=="recv")throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"_assertRecvDirection: 操作异常"})}}e.Safari12=P},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(u,h,o,f){f===void 0&&(f=o),Object.defineProperty(u,f,{enumerable:!0,get:function(){return h[o]}})}:function(u,h,o,f){f===void 0&&(f=o),u[f]=h[o]}),a=this&&this.__setModuleDefault||(Object.create?function(u,h){Object.defineProperty(u,"default",{enumerable:!0,value:h})}:function(u,h){u.default=h}),l=this&&this.__importStar||function(u){if(u&&u.__esModule)return u;var h={};if(u!=null)for(var o in u)o!=="default"&&Object.prototype.hasOwnProperty.call(u,o)&&i(h,u,o);return a(h,u),h};Object.defineProperty(e,"__esModule",{value:!0}),e.shimVideoOrientation=e.canShimVideoOrientation=void 0;const n=r(1),c=l(r(7)),s=r(77),d="a=extmap:4 ";e.canShimVideoOrientation=function(u,h){if(n.getParameters().shimVideoOrientation==="never")return!1;if(n.getParameters().shimVideoOrientation==="ios151"){if(!c.IS_IOS)return!1;if(c.IS_SAFARI){if(parseFloat(s.getBrowserInfo().browserVersion)<15.1)return!1}else if(!c.IS_WECHAT||!navigator.userAgent.match(/OS 15_[1-9]/))return!1}if(h.sdp.indexOf("H264")===-1||h.sdp.indexOf("m=video")===-1)return!1;const o=u.sdp.match(/\r\n(.*3gpp\:video-orientation.*)\r\n/);return!!(o&&u.sdp.indexOf(d)>-1&&h.sdp.indexOf(o[1])===-1)},e.shimVideoOrientation=function(u,h){if(h.sdp.indexOf("H264")===-1||h.sdp.indexOf("m=video")===-1)return;const o=u.sdp.match(/\r\n(.*3gpp\:video-orientation.*)\r\n/);if(o&&u.sdp.indexOf(d)>-1&&h.sdp.indexOf(o[1])===-1){const f=o[1];console.log(`shimVideoOrientation for ${s.getBrowserInfo().browserName} ${s.getBrowserInfo().browserVersion} ${f}`),h.sdp=h.sdp.split(d).join(f+`\r
`+d)}else console.error("Failed to shimVideoOrientation",o,u.sdp.indexOf(d),o&&h.sdp.indexOf(o[1]))}},function(t,e,r){var i=this&&this.__awaiter||function(a,l,n,c){return new(n||(n=Promise))(function(s,d){function u(f){try{o(c.next(f))}catch(m){d(m)}}function h(f){try{o(c.throw(f))}catch(m){d(m)}}function o(f){var m;f.done?s(f.value):(m=f.value,m instanceof n?m:new n(function(g){g(m)})).then(u,h)}o((c=c.apply(a,l||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.AwaitQueue=class{constructor({ClosedErrorClass:a=Error,StoppedErrorClass:l=Error}={ClosedErrorClass:Error,StoppedErrorClass:Error}){this.closed=!1,this.pendingTasks=[],this.ClosedErrorClass=Error,this.StoppedErrorClass=Error,this.ClosedErrorClass=a,this.StoppedErrorClass=l}get size(){return this.pendingTasks.length}close(){if(!this.closed){this.closed=!0;for(const a of this.pendingTasks)a.stopped=!0,a.reject(new this.ClosedErrorClass("AwaitQueue closed"));this.pendingTasks.length=0}}push(a,l){return i(this,void 0,void 0,function*(){if(this.closed)throw new this.ClosedErrorClass("AwaitQueue closed");if(typeof a!="function")throw new TypeError("given task is not a function");if(!a.name&&l)try{Object.defineProperty(a,"name",{value:l})}catch{}return new Promise((n,c)=>{const s={task:a,name:l,resolve:n,reject:c,stopped:!1,enqueuedAt:new Date,executedAt:void 0};this.pendingTasks.push(s),this.pendingTasks.length===1&&this.next()})})}stop(){if(!this.closed){for(const a of this.pendingTasks)a.stopped=!0,a.reject(new this.StoppedErrorClass("AwaitQueue stopped"));this.pendingTasks.length=0}}dump(){const a=new Date;return this.pendingTasks.map(l=>({task:l.task,name:l.name,enqueuedTime:l.executedAt?l.executedAt.getTime()-l.enqueuedAt.getTime():a.getTime()-l.enqueuedAt.getTime(),executingTime:l.executedAt?a.getTime()-l.executedAt.getTime():0}))}next(){return i(this,void 0,void 0,function*(){const a=this.pendingTasks[0];a&&(yield this.executeTask(a),this.pendingTasks.shift(),this.next())})}executeTask(a){return i(this,void 0,void 0,function*(){if(!a.stopped){a.executedAt=new Date;try{const l=yield a.task();if(a.stopped)return;a.resolve(l)}catch(l){if(a.stopped)return;a.reject(l)}}})}}},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(l,n,c,s){s===void 0&&(s=c),Object.defineProperty(l,s,{enumerable:!0,get:function(){return n[c]}})}:function(l,n,c,s){s===void 0&&(s=c),l[s]=n[c]}),a=this&&this.__exportStar||function(l,n){for(var c in l)c==="default"||Object.prototype.hasOwnProperty.call(n,c)||i(n,l,c)};Object.defineProperty(e,"__esModule",{value:!0}),a(r(172),e),a(r(168),e),a(r(78),e),a(r(87),e),a(r(173),e),a(r(241),e),a(r(242),e),a(r(171),e)},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.parse=void 0;const i=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");e.parse=function(a){const l=i.exec(a||"");return l?{spatialLayers:Number(l[1]),temporalLayers:Number(l[2])}:{spatialLayers:1,temporalLayers:1}}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.VideoTrackLow=void 0;const i=r(245),a=r(174),l=r(71),n=r(1),c=r(85),s=r(253),d=r(7);e.VideoTrackLow=class{constructor(u){var h;this.width=0,this.height=0,this.canvas=document.createElement("canvas"),this.context=c.get2DContext(this.canvas),this.timer=null,this.lastDrawAt=0,this.lastState="clear",this.high={sender:null,track:null,stream:new MediaStream,videoDom:i.getAutoplayVideo(),width:0,height:0},this.sender=null,this.emptyTrackInfo={track:null,count:0,visible:"unknown"},this.mediaType=u.mediaType,this.mediaType==="video"?(this.WIDTH_MAX=n.getParameters().videoLowMaxWidth,this.HEIGHT_MAX=n.getParameters().videoLowMaxHeight,this.FRAME_RATE=n.getParameters().videoLowFramerate):(this.WIDTH_MAX=n.getParameters().screenLowMaxWidth,this.HEIGHT_MAX=n.getParameters().screenLowMaxHeight,this.FRAME_RATE=n.getParameters().screenLowFramerate),this.stream=this.canvas.captureStream?this.canvas.captureStream(this.FRAME_RATE):null,this.track=((h=this.stream)===null||h===void 0?void 0:h.getTracks()[0])||null,l.watchTrack(this.track),this.logger=u.logger.getChild(()=>{let o=`low_${this.mediaType} ${this.width}x${this.height}`;return this.high.sender?this.high.sender.track?this.high.sender.track.readyState!=="live"?o+=" HIGH_STATE_"+this.high.sender.track.readyState:(this.high.sender&&this.high.sender.track!==this.high.track&&(o+=" MISMATCH"),this.high.sender.track.enabled||(o+=" muted"),o+=` 【${this.high.sender.track.label}】`):o+=" NO_HIGH_TRACK":o+=" NO_HIGH_SENDER",this.track?this.track.readyState!=="live"&&(o+=" LOW_STATE_"+this.track.readyState):o+=" NO_LOW_TRACK",o}),this.track?this.context?this.timer=a.getRTCTimer().setInterval(()=>{this.drawOneFrame()},1e3/this.FRAME_RATE):(this.logger.error("CanvasContext无法顺利启动"),this.stream=null,this.track=null):this.logger.error("当前浏览器不支持CanvasTrack")}_correctSize(){if(this.high.sender&&this._bindTrack(this.high.sender.track),this.high.width!==this.high.videoDom.videoWidth||this.high.height!==this.high.videoDom.videoHeight){const u=this.high.videoDom.videoWidth/this.high.videoDom.videoHeight;let h=this.width,o=this.height;const f=u>1?this.WIDTH_MAX:this.HEIGHT_MAX,m=u>1?this.HEIGHT_MAX:this.WIDTH_MAX;u>f/m?(o=Math.floor(this.high.videoDom.videoHeight/this.high.videoDom.videoWidth*f),o>0?h=f:(h=0,o=0)):(o=m,h=Math.floor(this.high.videoDom.videoWidth/this.high.videoDom.videoHeight*m),h>0?o=m:(h=0,o=0)),this.logger.log(`High resize ${this.high.width}x${this.high.height}=>${this.high.videoDom.videoWidth}x${this.high.videoDom.videoHeight}, low: ${this.width}x${this.height}=>${h}x${o}`),this.high.width=this.high.videoDom.videoWidth,this.high.height=this.high.videoDom.videoHeight,this.width=h,this.height=o,this.canvas.width=this.width,this.canvas.height=this.height}}destroy(){var u;this.timer&&(a.getRTCTimer().clearInterval(this.timer),this.timer=null),(u=this.track)===null||u===void 0||u.stop(),this.stream=null}drawOneFrame(){var u,h,o,f;if(this.context)if(this._correctSize(),((u=this.high.track)===null||u===void 0?void 0:u.enabled)===!0&&((h=this.track)===null||h===void 0?void 0:h.enabled)===!1&&(this.logger.log("恢复小流mute状态"),this.track.enabled=!0),this.track){if(this.track.readyState!=="live")this.logger.error("小流 Track 已停止");else if(((o=this.high.track)===null||o===void 0?void 0:o.enabled)===!1){if(this.lastState==="frame"||this.lastState==="clear"){this.logger.log("track处在mute状态");let m="black";this.logger.log(`小流状态变更 ${this.lastState} => ${m}`),this.lastState=m,this.context.fillRect(0,0,this.width,this.height)}}else if(this.high.videoDom.paused){if(this.lastState==="frame"||this.lastState==="clear"){let m="paused";this.logger.log(`小流状态变更 ${this.lastState} => ${m}`),this.lastState=m,this.high.videoDom.play().catch(g=>{})}(n.getParameters().videoLowCheckCanvasBlank==="all"||d.IS_IOS&&n.getParameters().videoLowCheckCanvasBlank==="ios")&&this._checkCanvasBlank()}else if(((f=this.high.track)===null||f===void 0?void 0:f.readyState)==="live"){if(this.lastState!=="frame"){let g="frame";this.logger.log(`小流状态变更 ${this.lastState} => ${g}`),this.lastState=g}const m=this.high.track.canvas;m?this.context.drawImage(m,0,0,this.width,this.height):this.context.drawImage(this.high.videoDom,0,0,this.width,this.height),this.lastDrawAt=Date.now(),(n.getParameters().videoLowCheckCanvasBlank==="all"||d.IS_IOS&&n.getParameters().videoLowCheckCanvasBlank==="ios")&&this._checkCanvasBlank()}else if(this.lastState==="frame"){let m="clear";this.logger.log(`小流状态变更 ${this.lastState} => ${m}`),this.lastState=m,this.context.clearRect(0,0,this.width,this.height)}}else this.logger.error("无法获取小流 Track")}_checkCanvasBlank(){var u,h;!((u=this.high.sender)===null||u===void 0)&&u.track&&(!((h=this.sender)===null||h===void 0)&&h.track)&&(this.high.sender.track!==this.emptyTrackInfo.track&&(this.emptyTrackInfo={track:this.high.sender.track,count:0,visible:"unknown"}),this.emptyTrackInfo.visible==="unknown")&&(this.high.videoDom.paused||this.high.videoDom.readyState!==4?this.emptyTrackInfo.count++:s.isCanvasBlank(this.canvas)?this.emptyTrackInfo.count++:(this.emptyTrackInfo.visible="yes",this.logger.log("_checkCanvasBlank: 小流画面可见",this.emptyTrackInfo.count),this.sender.track!==this.track&&(this.logger.warn("小流切换至低分辨率模式"),this.sender.replaceTrack(this.track))),this.emptyTrackInfo.count>30&&(this.emptyTrackInfo.visible="no",this.sender.track!==this.high.sender.track?(this.logger.warn("_checkCanvasBlank: 小流两秒内无画面，小流切换至相同分辨率模式"),this.sender.replaceTrack(this.high.sender.track)):this.logger.warn("_checkCanvasBlank: 小流两秒内无画面，继续使用相同分辨率模式")))}_bindTrack(u){var h;this.high.track!==u&&(this.high.track&&this.high.stream.removeTrack(this.high.track),u&&this.high.stream.addTrack(u),this.high.track=u,this.high.videoDom.srcObject=this.high.stream,this.high.videoDom.play().catch(o=>{}),!((h=this.sender)===null||h===void 0)&&h.track&&(this.emptyTrackInfo.visible==="no"?(this.logger.warn("小流正在使用相同分辨率模式"),this.sender.replaceTrack(u)):this.sender.track!==this.track&&(this.logger.warn("小流正在使用低分辨率模式"),this.sender.replaceTrack(this.track))))}bindSender(u,h){this.high.sender=u,this.sender=h,u?this._bindTrack(u.track):this._bindTrack(null)}}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.getAutoplayVideo=void 0;let i=0;e.getAutoplayVideo=function(){const a=document.createElement("video");return a.style.position="absolute",a.setAttribute("x-webkit-airplay","x-webkit-airplay"),a.setAttribute("playsinline","playsinline"),a.setAttribute("webkit-playsinline","webkit-playsinline"),a.preload="auto",a.className="nertc-video-id-"+i++,a.autoplay=!0,a.muted=!0,a}},function(t,e,r){t.exports=`setInterval(() => {
  self.postMessage('RTCTimer')
}, 8)
`},function(t,e,r){t.exports='!function(t){var e={};function s(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,s),i.l=!0,i.exports}s.m=t,s.c=e,s.d=function(t,e,n){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)s.d(n,i,function(e){return t[e]}.bind(null,i));return n},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=self;class i{constructor(t){this.signalProbers={},this.pingInterval=t.pingInterval,this.maxRtt=t.maxRtt,this.wsTimeout=t.wsTimeout,this.reconnectionInterval=t.reconnectionInterval;for(let e in t.signalStates)t.signalStates[e]?this.signalProbers[e]=new r(this,t.signalStates[e]):this.error(`Unrecognized ${e} ${t.signalStates}`);this.timer=setInterval(()=>{this.sync()},1e3)}sync(){const t=Date.now(),e={};for(let s in this.signalProbers){const n=this.signalProbers[s].signalState;-1===n.ping.rtt?n.active=!1:n.ping.recvIndex<n.ping.sendIndex&&(n.ping.rtt=Math.max(n.ping.rtt,t-n.ping.lastSentAt)),e[s]=n}n.postMessage({cmd:"sync",data:e})}log(t){n.postMessage({cmd:"log",data:t})}error(t){n.postMessage({cmd:"error",data:t})}handleDebugMessage(t){var e;if("closeWs"===t.data.type)for(let s in this.signalProbers){const n=this.signalProbers[s];n.signalState.index===t.data.index&&(this.error(`Closing #${t.data.index} ${n.wsUrl}`),null===(e=n.ws)||void 0===e||e.close())}if("doNotSendPing"===t.data.type)for(let e in this.signalProbers){const s=this.signalProbers[e];s.signalState.index===t.data.index&&(s.debug.doNotSendPing=!!t.data.value,s.log("doNotSendPing: "+JSON.stringify(t.data)))}}handleOnlineMessage(t){this.log("收到在线事件，探测服务发起重连");for(let t in this.signalProbers){this.signalProbers[t].init()}}}let a=null;n.postMessage({cmd:"ohayo"}),n.onmessage=t=>{const e=t.data;if("init"===e.cmd){if(a)return void a.error("Already Inited");const t=e.data;a=new i(t)}else if("debug"===e.cmd)null==a||a.handleDebugMessage(e);else{if("onOnline"!==e.cmd)return void(null==a||a.log("Invalid message "+JSON.stringify(e)));null==a||a.handleOnlineMessage(e)}};class r{constructor(t,e){this.debug={doNotSendPing:!1},this.signalProbeWorker=t,this.signalState=e;const s=e.wsUrl.split(/\\/\\?|\\?/);this.wsUrl=`wss://${s[0]}/nertc/private/ping${s[1]?"?"+s[1]:""}`,this.pingTimer=setInterval(this.checkState.bind(this),100),this.ws=null,this.init()}init(){this.ws&&this.ws.close(),this.ws=new WebSocket(this.wsUrl),this.ws.onmessage=this.handleWsMessage.bind(this,this.ws),this.ws.onopen=this.handleWsOpen.bind(this,this.ws),this.ws.onclose=this.checkState.bind(this),this.ws.onerror=this.checkState.bind(this),this.signalState.connect.startCnt++,this.signalState.connect.initAt=Date.now(),this.signalState.connect.connectAt=-1,this.signalState.ping.sendIndex=0,this.signalState.ping.recvIndex=0}getTag(){return`[signalProber #${this.signalState.index} rtt${this.signalState.ping.rtt}ms ${this.signalState.connect.successCnt}_${this.signalState.connect.failCnt}]`}log(t){this.signalProbeWorker.log(`${this.getTag()}${t}`)}error(t){this.signalProbeWorker.error(`${this.getTag()}${t}`)}checkState(){const t=Date.now();if(this.ws)if(this.ws.readyState===WebSocket.OPEN)if(this.signalState.ping.sendIndex===this.signalState.ping.recvIndex){if(t-this.signalState.ping.lastSentAt>this.signalProbeWorker.pingInterval){const e=""+t;this.debug.doNotSendPing||this.ws.send(e),this.signalState.ping.lastSentAt=t,this.signalState.ping.lastSentMsg=e,this.signalState.ping.sendIndex++}}else t-this.signalState.ping.lastSentAt>this.signalProbeWorker.maxRtt&&(this.signalState.active=!1,this.signalState.ping.rtt=-1),t-this.signalState.ping.lastSentAt>this.signalProbeWorker.wsTimeout&&(this.log(`timeout: ${t-this.signalState.ping.lastSentAt}ms. Connect cnt:${this.signalState.connect.startCnt} ${this.wsUrl}`),this.ws.close(),this.ws=null,this.init());else this.ws.readyState===WebSocket.CONNECTING||this.ws.readyState!==WebSocket.CLOSED&&this.ws.readyState!==WebSocket.CLOSING||(-1===this.signalState.connect.connectAt||0===this.signalState.ping.recvIndex?(this.ws=null,this.signalState.connect.failCnt++,this.signalState.connect.failCntFromLastSuccess++,this.signalState.connect.failCnt<=3&&this.log(`[checkState]WebSocket Failed count:${this.signalState.connect.failCntFromLastSuccess}. Next try: ${this.getBackoffTime()}ms`)):this.signalState.active&&(this.log(`[checkState]WebSocket CLOSED. Next try: ${this.getBackoffTime()}ms`),this.signalState.active=!1,this.signalState.ping.rtt=-1,this.ws=null,this.signalProbeWorker.sync()));else t-this.signalState.connect.initAt>this.getBackoffTime()&&this.init()}getBackoffTime(){return this.signalProbeWorker.reconnectionInterval*this.signalState.connect.failCntFromLastSuccess}handleWsOpen(t,e){const s=e.data;if(this.ws===t){const t=Date.now();this.signalState.connect.connectAt=t,this.signalState.connect.failCnt<=3&&this.log(`open ${this.signalState.connect.connectAt-this.signalState.connect.initAt}ms ${this.signalState.wsUrl} => ${this.wsUrl}`),this.checkState()}else this.error("Detached ws open "+JSON.stringify(s))}handleWsMessage(t,e){const s=e.data;if(this.ws!==t)return void this.error("Detached ws message "+JSON.stringify(s));if(this.signalState.ping.lastSentMsg!==s)return void(this.signalState.connect.failCnt<=3&&this.error("Unrecognized message "+JSON.stringify(s)));const n=Date.now();this.signalState.ping.recvIndex++,this.signalState.ping.rtt=n-this.signalState.ping.lastSentAt,1===this.signalState.ping.recvIndex&&(this.signalState.connect.successCnt++,this.signalState.connect.failCntFromLastSuccess=0),this.signalState.ping.rtt>this.signalProbeWorker.maxRtt?(this.signalState.ping.rtt=-1,this.signalState.active=!1):this.signalState.ping.rtt>0&&(this.signalState.active=!0)}}}]);'},function(t,e,r){t.exports=`const SMOOTHING_FACTOR = 0.8
const MINIMUM_VALUE = 0.00001
registerProcessor(
  'vumeter',
  class extends AudioWorkletProcessor {
    constructor() {
      super()
      this._leftVolume = 0
      this._rightVolume = 0
      this._updateIntervalInMS = 25
      this._nextUpdateFrame = this.intervalInFrames
      this.port.onmessage = (event) => {
        if (event.data.updateIntervalInMS) this._updateIntervalInMS = event.data.updateIntervalInMS
      }
      //缓存intervalInFrames数量的音频数据
      this.leftChannelData = new Float32Array(sampleRate)
      this.rightChannelData = new Float32Array(sampleRate)
      this.dataIndex = 0
    }

    get intervalInFrames() {
      return (this._updateIntervalInMS / 1000) * sampleRate
    }

    process(inputs, outputs, parameters) {
      const input = inputs[0]

      // Note that the input will be down-mixed to mono; however, if no inputs are
      // connected then zero channels will be passed in.
      if (input.length > 0) {
        const samplesLeft = input[0]
        const samplesRight = input[1]

        let sum = 0
        let rms = 0
        // Calculated the squared-sum.
        if (samplesLeft && samplesLeft.length) {
          for (let i = 0; i < samplesLeft.length; ++i) {
            sum += samplesLeft[i] * samplesLeft[i]
          }
          // Calculate the RMS level and update the volume.
          rms = Math.sqrt(sum / samplesLeft.length)
          this._leftVolume = Math.max(rms, this._leftVolume * SMOOTHING_FACTOR)
          if (this._leftVolume < 1e-10) {
            this._leftVolume = 0
          }
        }
        if (samplesRight) {
          sum = 0
          rms = 0
          // Calculated the squared-sum.
          for (let j = 0; j < samplesRight.length; ++j) sum += samplesRight[j] * samplesRight[j]

          // Calculate the RMS level and update the volume.
          rms = Math.sqrt(sum / samplesRight.length)
          this._rightVolume = Math.max(rms, this._rightVolume * SMOOTHING_FACTOR)
          if (this._rightVolume < 1e-10) {
            this._rightVolume = 0
          }
        }

        //拷贝数据
        try {
          this.leftChannelData.set(samplesLeft, this.dataIndex)
          if (samplesRight) {
            this.rightChannelData.set(samplesRight, this.dataIndex)
          }
          this.dataIndex += samplesLeft.length
        } catch (e) {
          //正常情况下不会出现这种情况，这里用try catch是为了防止出现异常导致getAudioLevel不准确
          this.leftChannelData = new Float32Array(sampleRate)
          this.rightChannelData = new Float32Array(sampleRate)
          this.dataIndex = 0
        }

        // Update and sync the volume property with the main thread.
        this._nextUpdateFrame -= samplesLeft.length

        if (this._nextUpdateFrame <= 0) {
          this._nextUpdateFrame += this.intervalInFrames
          let volume = Math.max(this._leftVolume, this._rightVolume)
          if (!(volume > -1)) {
            if (this._leftVolume > -1) {
              volume = this._leftVolume
            } else if (this._rightVolume > -1) {
              volume = this._rightVolume
            }
          }
          if (samplesRight) {
            this.port.postMessage({
              left: this._leftVolume,
              right: this._rightVolume,
              volume: volume,
              leftData: this.leftChannelData.subarray(0, this.dataIndex),
              rightData: this.rightChannelData.subarray(0, this.dataIndex),
              sampleRate: sampleRate
            })
          } else {
            this.port.postMessage({
              volume: volume,
              leftData: this.leftChannelData.subarray(0, this.dataIndex),
              sampleRate: sampleRate
            })
          }
          this.leftChannelData = new Float32Array(sampleRate)
          this.rightChannelData = new Float32Array(sampleRate)
          this.dataIndex = 0
        }
      }

      return true
    }
  }
)
`},function(t,e,r){t.exports=`;(function () {
  const intervalIds = {}
  const timeoutIds = {}

  // 监听message 开始执行定时器或者销毁
  self.onmessage = function onMsgFunc(e) {
    switch (e.data.command) {
      case 'interval:start': // 开启定时器
        const intervalId = setInterval(function () {
          postMessage({
            message: 'interval:tick',
            id: e.data.id
          })
        }, e.data.interval)

        postMessage({
          message: 'interval:started',
          id: e.data.id
        })

        intervalIds[e.data.id] = intervalId
        break
      case 'interval:clear': // 销毁
        clearInterval(intervalIds[e.data.id])

        postMessage({
          message: 'interval:cleared',
          id: e.data.id
        })

        delete intervalIds[e.data.id]
        break

      case 'timeout:start': // 开启定时器
        const timeoutId = this.setTimeout(function () {
          postMessage({
            message: 'timeout:tick',
            id: e.data.id
          })
        }, e.data.timeout)

        postMessage({
          message: 'timeout:started',
          id: e.data.id
        })

        timeoutIds[e.data.id] = timeoutId
        break
      case 'timeout:clear': // 销毁
        clearTimeout(timeoutIds[e.data.id])

        postMessage({
          message: 'timeout:cleared',
          id: e.data.id
        })

        delete timeoutIds[e.data.id]
        break
    }
  }
})()
`},function(t,e,r){t.exports=`/**
 * 模拟一个AI Worklet
 * 其实是个Delay
 */
registerProcessor(
  'audioAIProcessor',
  class extends AudioWorkletProcessor {
    constructor() {
      super()
      // 尚未接入AI，以延迟1秒为例
      this.inputSamplesHistory = []
      this.delayMs = 3000
    }

    process(inputs, outputs, parameters) {
      const now = Date.now()
      const input = inputs[0].map((channel) => {
        return channel.slice(0)
      })
      const output = outputs[0]
      this.inputSamplesHistory.push({
        input,
        ms: now
      })
      const firstItem = this.inputSamplesHistory[0]
      if (firstItem) {
        if (now - firstItem.ms > this.delayMs) {
          this.inputSamplesHistory.shift()
          output.forEach((channel, index) => {
            for (let i = 0; i < channel.length; i++) {
              if (firstItem.input[index] && firstItem.input[index][i]) {
                channel[i] = firstItem.input[index][i]
              }
            }
          })
        }
      }
      return true
    }
  }
)
`},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(d,u,h,o){o===void 0&&(o=h),Object.defineProperty(d,o,{enumerable:!0,get:function(){return u[h]}})}:function(d,u,h,o){o===void 0&&(o=h),d[o]=u[h]}),a=this&&this.__setModuleDefault||(Object.create?function(d,u){Object.defineProperty(d,"default",{enumerable:!0,value:u})}:function(d,u){d.default=u}),l=this&&this.__importStar||function(d){if(d&&d.__esModule)return d;var u={};if(d!=null)for(var h in d)h!=="default"&&Object.prototype.hasOwnProperty.call(d,h)&&i(u,d,h);return a(u,d),u};Object.defineProperty(e,"__esModule",{value:!0}),e.shimCanvas=e.canShimCanvas=void 0;const n=r(1),c=r(150),s=l(r(7));e.canShimCanvas=function(){let d=!1;if(n.getParameters().shimCanvas==="never")d=!1;else if(n.getParameters().shimCanvas==="always")d=!0;else if(n.getParameters().shimCanvas==="ios151")return!!(s.IS_IOS&&navigator.userAgent.indexOf(" OS 15_1")>-1);return d},e.shimCanvas=function(d){let u=new c.RTCCanvas("canvas");const h=document.createElement("video");let o,f=u._canvas;o="getSettings"in MediaStreamTrack.prototype?d.getSettings():d.getConstraints();let m=o.frameRate||15,g=u._ctx;const v=new MediaStream([d]);if(h.srcObject=v,h.setAttribute("playsinline","playsinline"),h.setAttribute("muted","muted"),h.setAttribute("autoplay","autoplay"),h.className="nertc-ios-shim",h.style.display="none",h.onresize=()=>{h.videoWidth&&h.videoHeight&&u.setSize(h.videoWidth,h.videoHeight)},g){const O=f.captureStream(m).getVideoTracks()[0];Object.defineProperty(O,"enabled",{get:()=>d.enabled,set(C){console.warn("Delegate cameraTrack enabled",C),d.enabled=C}});const T=setInterval(()=>{h.paused?h.play():O.readyState==="ended"?(d.readyState==="live"&&(console.warn("canvasTrack已停止，回收videoTrack中"),d.stop()),clearInterval(T),document.body.removeChild(h)):g.drawImage(h,0,0)},1e3/m);return document.body.appendChild(h),O}throw new Error("Ctx not supported")}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.syncTrackState=void 0;const i=new(r(28)).Logger({tagGen:()=>"syncTrackState"}),a=[];setInterval(()=>{for(let l=a.length-1;l>=0;l--){const n=a[l];if(n.srcTrack.readyState==="ended")return n.destTrack.readyState==="live"&&(i.log(`同步MediaStreamTrack关闭状态。【${n.srcTrack.label}】=>【${n.destTrack.label}】`),n.destTrack.stop()),void a.splice(l,1);if(n.direction==="bidirectional"&&n.destTrack.readyState==="ended")return n.srcTrack.readyState==="live"&&(i.warn(`同步MediaStreamTrack关闭状态。【${n.destTrack.label}】=>【${n.srcTrack.label}】`),n.srcTrack.stop()),void a.splice(l,1);n.srcTrack.enabled!==n.enabled&&(n.enabled=n.srcTrack.enabled,n.srcTrack.enabled!==n.destTrack.enabled&&(i.warn(`同步MediaStreamTrack enabled:【${n.srcTrack.label}】`,n.enabled),n.destTrack.enabled=n.srcTrack.enabled)),n.direction==="bidirectional"&&n.destTrack.enabled!==n.enabled&&(n.enabled=n.destTrack.enabled,n.destTrack.enabled!==n.srcTrack.enabled&&(i.warn(`同步MediaStreamTrack enabled:【${n.srcTrack.label}】`,n.enabled),n.srcTrack.enabled=n.destTrack.enabled))}},1e3),e.syncTrackState=function(l,n,c){a.push({srcTrack:l,destTrack:n,direction:c,enabled:l.enabled})}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.isCanvasBlank=void 0;let i=null;e.isCanvasBlank=function(a){i||(i=document.createElement("canvas")),i.width=a.width,i.height=a.height;let l=a.toDataURL()===i.toDataURL();return l&&console.error("result",l,a),l}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.stringify=void 0;const i=r(140),a=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;let l,n;const c={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};let s;function d(u){return a.lastIndex=0,a.test(u)?`"${u.replace(a,h=>{const o=c[h];return typeof o=="string"?o:"\\u"+("0000"+h.charCodeAt(0).toString(16)).slice(-4)})}"`:`"${u}"`}e.stringify=function(u,h,o){let f;if(l="",n="",typeof o=="number")for(f=0;f<o;f+=1)n+=" ";else typeof o=="string"&&(n=o);if(s=h,h&&typeof h!="function"&&!Array.isArray(h))throw new Error("JSON.stringify");return function m(g,v){let O,T,C,A;const R=l;let w,k=v[g];const I=k!=null&&k instanceof i.SimpleBig;switch(k&&typeof k=="object"&&typeof k.toJSON=="function"&&(k=k.toJSON(g)),typeof s=="function"&&(k=s.call(v,g,k)),typeof k){case"string":return d(k);case"number":return isFinite(k)?String(k):"null";case"boolean":case"bigint":return String(k);case"object":if(I)return k.toString();if(!k)return"null";if(l+=n,w=[],Object.prototype.toString.apply(k)==="[object Array]"){for(A=k.length,O=0;O<A;O+=1)w[O]=m(O,k)||"null";return C=w.length===0?"[]":l?`[
${l}${w.join(`,
`+l)}
${R}]`:`[${w.join(",")}]`,l=R,C}if(Array.isArray(s))for(A=s.length,O=0;O<A;O+=1)typeof s[O]=="string"&&(T=s[O],C=m(T,k),C&&w.push(d(T)+(l?": ":":")+C));else Object.keys(k).forEach(M=>{const P=m(M,k);P&&w.push(d(M)+(l?": ":":")+P)});return C=w.length===0?"{}":l?`{
${l}${w.join(`,
`+l)}
${R}}`:`{${w.join(",")}}`,l=R,C;default:return""}}("",{"":u})}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.JSONParse=void 0;const i=/(?:_|\\u005[Ff])(?:_|\\u005[Ff])(?:p|\\u0070)(?:r|\\u0072)(?:o|\\u006[Ff])(?:t|\\u0074)(?:o|\\u006[Ff])(?:_|\\u005[Ff])(?:_|\\u005[Ff])/,a=/(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)/;e.JSONParse=function(l){const n={strict:!1,storeAsString:!0,alwaysParseAsBig:!1,useNativeBigInt:!0,protoAction:"error",constructorAction:"error"};if(l!=null){if(l.strict===!0&&(n.strict=!0),l.storeAsString===!0&&(n.storeAsString=!0),n.alwaysParseAsBig=l.alwaysParseAsBig===!0&&l.alwaysParseAsBig,n.useNativeBigInt=l.useNativeBigInt===!0&&l.useNativeBigInt,l.constructorAction!==void 0){if(l.constructorAction!=="error"&&l.constructorAction!=="ignore"&&l.constructorAction!=="preserve")throw new Error('Incorrect value for constructorAction option, must be "error", "ignore" or undefined but passed '+l.constructorAction);n.constructorAction=l.constructorAction}if(l.protoAction!==void 0){if(l.protoAction!=="error"&&l.protoAction!=="ignore"&&l.protoAction!=="preserve")throw new Error('Incorrect value for protoAction option, must be "error", "ignore" or undefined but passed '+l.protoAction);n.protoAction=l.protoAction}}let c,s;const d={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:`
`,r:"\r",t:"	"};let u;const h=function(T){throw{name:"SyntaxError",message:T,at:c,text:u}},o=function(T){return T&&T!==s&&h(`Expected '${T}' instead of '${s}'`),s=u.charAt(c),c+=1,s},f=function(){let T,C="";for(s==="-"&&(C="-",o("-"));s>="0"&&s<="9";)C+=s,o();if(s===".")for(C+=".";o()&&s>="0"&&s<="9";)C+=s;if(s==="e"||s==="E")for(C+=s,o(),s!=="-"&&s!=="+"||(C+=s,o());s>="0"&&s<="9";)C+=s,o();if(T=+C,isFinite(T))return C.length>15?n.storeAsString?C:n.useNativeBigInt?BigInt(C):null:n.alwaysParseAsBig?n.useNativeBigInt?BigInt(T):null:T;h("Bad number")};function m(){let T,C,A,R="";if(s==='"'){let w=c;for(;o();){if(s==='"')return c-1>w&&(R+=u.substring(w,c-1)),o(),R;if(s==="\\"){if(c-1>w&&(R+=u.substring(w,c-1)),o(),s==="u"){for(A=0,C=0;C<4&&(T=parseInt(o(),16),isFinite(T));C+=1)A=16*A+T;R+=String.fromCharCode(A)}else{if(typeof d[s]!="string")break;R+=d[s]}w=c}}}h("Bad string")}const g=function(){for(;s&&s<=" ";)o()};function v(){switch(g(),s){case"{":return O();case"[":return function(){const T=[];if(s==="["){if(o("["),g(),s==="]")return o("]"),T;for(;s;){if(T.push(v()),g(),s==="]")return o("]"),T;o(","),g()}}h("Bad array")}();case'"':return m();case"-":return f();default:return s>="0"&&s<="9"?f():function(){switch(s){case"t":return o("t"),o("r"),o("u"),o("e"),!0;case"f":return o("f"),o("a"),o("l"),o("s"),o("e"),!1;case"n":return o("n"),o("u"),o("l"),o("l"),null}h(`Unexpected '${s}'`)}()}}const O=function(){let T;const C=Object.create(null);if(s==="{"){if(o("{"),g(),s==="}")return o("}"),C;for(;s;){if(T=m(),g(),o(":"),n.strict===!0&&Object.hasOwnProperty.call(C,T)&&h(`Duplicate key "${T}"`),i.test(T)===!0?n.protoAction==="error"?h("Object contains forbidden prototype property"):n.protoAction==="ignore"?v():C[T]=v():a.test(T)===!0?n.constructorAction==="error"?h("Object contains forbidden constructor property"):n.constructorAction==="ignore"?v():C[T]=v():C[T]=v(),g(),s==="}")return o("}"),C;o(","),g()}}h("Bad object")};return function(T,C){let A;return u=""+T,c=0,s=" ",A=v(),g(),s&&h("Syntax error"),typeof C=="function"?function R(w,k){let I;const M=w[k];return M&&typeof M=="object"&&Object.keys(M).forEach(P=>{I=R(M,P),I!==void 0?M[P]=I:delete M[P]}),C.call(w,k,M)}({"":A},""):A}}},function(t,e,r){var i=this&&this.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(e,"__esModule",{value:!0}),e.Meeting=void 0;const a=r(3),l=r(26),n=r(146),c=i(r(6)),s=i(r(8)),d=r(81),u=r(140);class h extends a.EventEmitter{constructor(f){super(),this.info={turn:!0,relay:!1,forward:!1,secure:!0},this._reset(),this.adapterRef=f.adapterRef,this.sdkRef=f.sdkRef,this.logger=f.adapterRef.logger.getChild(()=>{var m,g,v;let O="meeting";return this.info.secure||(O+=" INSECURE"),this.info.forward&&(O+=" FORWARD"),this.info.turn||(O+=" NOTURN"),!((v=(g=(m=f.adapterRef.instance)===null||m===void 0?void 0:m._params)===null||g===void 0?void 0:g.neRtcServerAddresses)===null||v===void 0)&&v.channelServer&&(O+=" PRIVATE"),O})}_reset(){}async getCloudProxyInfo(f){const{appkey:m,channelName:g,uid:v,token:O=""}=f;this.adapterRef.logger.log("getCloudProxyInfo() url: ",l.getCloudProxyInfoUrl);let T=l.getCloudProxyInfoUrl;this.adapterRef.instance._params.neRtcServerAddresses.cloudProxyServer&&(T=this.adapterRef.instance._params.neRtcServerAddresses.cloudProxyServer,this.adapterRef.logger.log("getCloudProxyInfo() 私有化配置cloudProxyServer: ",T));let C=Date.parse(new Date)/1e3;try{const A=await this.adapterRef.lbsManager.ajax({url:T,type:"POST",header:{"Session-Id":this.adapterRef.deviceId||""},data:{uid:new u.SimpleBig(v),appkey:m,channelName:g,secureType:O?"1":"2",osType:"4",version:l.SDK_VERSION+".0"||!1,curtime:""+C,checksum:n(m+"."+v+"."+C),proxy:"1",needIPV6:"0"}});if(this.adapterRef.logger.log("getCloudProxyInfo() 获取到云代理服务相关信息: ",d.JSONBigStringify(A,null," ")),this.adapterRef.instance.apiFrequencyControl({name:"setCloudProxyInfo",code:A.code===200?0:-1,param:{channelName:g,uid:v,appkey:m,token:O,reason:A.code}}),A.code===200){this.adapterRef.channelStatus="join";const{wsProxyArray:R,mediaProxyArray:w,mediaProxyToken:k,cname:I,curTime:M}=A;this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer?(this.adapterRef.logger.warn("getCloudProxyInfo() webSocketProxyServer: ",this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer),this.adapterRef.proxyServer.wsProxyArray=[this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer]):this.adapterRef.proxyServer.wsProxyArray=R,this.adapterRef.instance._params.neRtcServerAddresses.mediaProxyServer?(this.adapterRef.logger.warn("getCloudProxyInfo() mediaProxyServer:",this.adapterRef.instance._params.neRtcServerAddresses.mediaProxyServer),this.adapterRef.proxyServer.mediaProxyArray=[this.adapterRef.instance._params.neRtcServerAddresses.mediaProxyServer],this.adapterRef.proxyServer.mediaProxyToken="netease",this.adapterRef.proxyServer.credential="netease"):(this.adapterRef.proxyServer.mediaProxyArray=w,this.adapterRef.proxyServer.mediaProxyToken=k,this.adapterRef.proxyServer.credential=v+"/"+M)}else this.adapterRef.logger.log("getCloudProxyInfo() 云代理服务相关信息获取失败, 回滚")}catch(A){throw this.adapterRef.logger.log("getCloudProxyInfo() 网络请求异常:",A.name,A.message,A),this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.apiFrequencyControl({name:"startProxyServer",code:-1,param:Object.assign(Object.assign({},f),{reason:A.message})}),new s.default({code:c.default.NETWORK_REQUEST_ERROR,message:A.message})}}async joinChannel(f){try{this.adapterRef.proxyServer.enable&&await this.getCloudProxyInfo(f)}catch(S){throw S}const{appkey:m,channelName:g,uid:v,wssArr:O=null,sessionMode:T="meeting",joinChannelRecordConfig:C,joinChannelLiveConfig:A,token:R="",permKey:w="",getChanneInfoResponse:k}=f;let I=Date.now(),M=+new Date,P=l.getChannelInfoUrl;this.adapterRef.instance._params.neRtcServerAddresses.channelServer&&(P=this.adapterRef.instance._params.neRtcServerAddresses.channelServer,this.logger.log("join() 私有化配置的 getChannelInfoUrl: ",P)),Object.assign(this.adapterRef.channelInfo,{uid:v,sessionMode:T,appkey:m});try{let S=k;S||(this.adapterRef.state.getChannelInfoRtt=0,S=await this.adapterRef.lbsManager.ajax({url:P,type:"POST",contentType:"application/x-www-form-urlencoded",header:{"Session-Id":this.adapterRef.deviceId||""},data:{uid:new u.SimpleBig(v),appkey:m,platformType:16,permKeySecret:w,channelName:g,secureType:R?"1":"2",osType:"4",mode:2,netType:"0",version:l.SDK_VERSION+".0"||!1,curtime:M,checksum:R||n(m+"."+v+"."+M),webrtc:1,nrtcg2:1,t1:I}}),this.adapterRef.state.getChannelInfoTime=Date.now(),this.adapterRef.state.getChannelInfoRtt||(this.adapterRef.state.getChannelInfoRtt=this.adapterRef.state.getChannelInfoTime-M));let y=!(v=="0"||v!="0"&&!v);if(this.info.secure=!!R,typeof S=="string"?(this.logger.warn("join() 返回值类型为string, 强制类型转换: ",S),S=d.JSONBigParse(S)):this.logger.log("join() 获取到房间信息: ",d.JSONBigStringify(S,null," ")),S.code===200){this.adapterRef.channelStatus="join";const{ips:_,time:b}=S;_&&_.uid||this.logger.warn("join() 加入频道时服务端未返回 uid");const E=S.config&&S.config.quality_level_limit||16;this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startWssTime=Date.now();let x=_.webrtcarray&&_.webrtcarray.length&&_.webrtcarray[0];if(x&&this.adapterRef.proxyServer.wsProxyArray){const F=_.turnaddrs&&_.turnaddrs.length&&_.turnaddrs[0][0];let V=F.split(":").length>1?F.split(":")[1]:"",N=x.split("/").length>1?x.split("/")[1]:"";this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer&&(V=N.split(":")[1]),N&&V?this.adapterRef.proxyServer.wsProxyArray=this.adapterRef.proxyServer.wsProxyArray.map(L=>L+"/"+N.split(":")[0]+":"+V):this.adapterRef.logger.log(`join() 云代理无法获取到代理信息, serverurl: ${N}, port: ${V}`)}Object.assign(this.adapterRef.channelInfo,{cid:+S.cid,permKey:w,token:S.token,turnToken:_.token,channelName:g,wssArr:O||this.adapterRef.proxyServer.enable&&this.adapterRef.proxyServer.wsProxyArray||_.webrtcarray||[],relayaddrs:this.adapterRef.proxyServer.mediaProxyArray||_.relayaddrs||null,relaytoken:this.adapterRef.proxyServer.mediaProxyToken||_.relaytoken||null,wssArrIndex:0,maxVideoQuality:E,netDetect:!1},{uid:y?v:_.uid,sessionMode:T,appkey:m}),f.uid=f.uid?f.uid:this.adapterRef.channelInfo.uid,this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.token=S.token,this.adapterRef.channelInfo.T4=Date.now();let D=this.adapterRef.channelInfo.T4-b.t1-(b.t3-b.t2);return this.adapterRef.channelInfo.clientNtpTime=b.t3+Math.round(D/2),this.adapterRef.instance.setSessionConfig(Object.assign({maxVideoQuality:E},A,C)),this.info.relay=_.relayaddrs&&_.relayaddrs.length>0,this.info.turn=_.turnaddrs&&_.turnaddrs.length>0,this.adapterRef.instance.startSession()}{let _="join() 服务器不允许加入房间, code: "+S.code;return S.desc?_=S.desc:S.code===4003&&(_="房间人数超过最大值。"),this.logger.error(_),this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.apiEventReport("setLogin",{a_record:C.recordAudio,v_record:C.recordVideo,record_type:C.recordType,host_speaker:C.isHostSpeaker,result:S.code,permKey:this.adapterRef.channelInfo.permKey,serverIp:P,desc:_}),Promise.reject(new s.default({code:c.default.SERVER_AUTH_ERROR,extraCode:S.code,message:_}))}}catch(S){throw this.logger.log("joing() 获取到房间信息错误:",S.name,S.message),this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.apiEventReport("setLogin",{a_record:C.recordAudio,v_record:C.recordVideo,record_type:C.recordType,host_speaker:C.isHostSpeaker,result:-1,desc:`join() 内部错误: ${S.name}, ${S.message}`,serverIp:P}),new s.default({code:S.getCode&&S.getCode()||c.default.JOIN_FAILED,message:S.getCode&&S.getMessage()||`join() 内部错误: ${S.name}, ${S.message}`})}}leaveChannel(){return this.adapterRef._signalling?this.adapterRef._signalling.doSendLogout().then(()=>(this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.stopSession())):Promise.resolve()}async addTasks(f){const{rtmpTasks:m=[]}=f;let g=l.roomsTaskUrl;this.adapterRef.instance._params.neRtcServerAddresses.roomServer&&(g=this.adapterRef.instance._params.neRtcServerAddresses.roomServer,g.substr(-1)!=="/"&&(g+="/"),this.logger.log("addTasks() 私有化配置的 roomsTaskUrl: ",g)),g=`${g}${this.adapterRef.channelInfo.cid}/tasks`;for(let v=0;v<m.length;v++){m[v].hostUid=new u.SimpleBig(this.adapterRef.channelInfo.uid),m[v].version=1,this.logger.log("addTasks() rtmpTask: ",d.JSONBigStringify(m[v]));const O=m[v].layout;O.users.forEach(T=>{typeof T.uid=="string"&&(T.uid=new u.SimpleBig(T.uid))});try{const T=await this.adapterRef.lbsManager.ajax({url:g,type:"POST",contentType:"application/json;charset=utf-8",header:{Token:this.adapterRef.channelInfo.turnToken,"Session-Id":this.adapterRef.deviceId||""},data:{version:1,taskId:m[v].taskId,streamUrl:m[v].streamUrl,record:m[v].record,hostUid:m[v].hostUid,layout:O,config:m[v].config,extraInfo:m[v].extraInfo||""}});if(T.code!==200)return this.logger.error(`addTasks() 添加第 ${v} 个推流任务失败: `,T),Promise.reject(new s.default({code:c.default.ADD_TASK_FAILED_ERROR,extraCode:T.code,message:"addTasks() 添加推流任务失败: "+T.code}));this.logger.log(`addTasks() 添加第 ${v} 个推流任务完成`)}catch(T){return this.logger.error("addTasks: ",T.name,T.message),Promise.reject(new s.default({code:c.default.ADD_TASK_FAILED_ERROR,message:"addTasks() 内部错误: $e.message}"}))}}}async deleteTasks(f){const{taskIds:m=[]}=f;let g=l.roomsTaskUrl;this.adapterRef.instance._params.neRtcServerAddresses.roomServer&&(g=this.adapterRef.instance._params.neRtcServerAddresses.roomServer,g.substr(-1)!=="/"&&(g+="/"),this.logger.log("deleteTasks() 私有化配置的 roomsTaskUrl: ",g)),g=`${g}${this.adapterRef.channelInfo.cid}/tasks/delete`;for(let v=0;v<m.length;v++){this.logger.log("deleteTasks() taskId: ",m[v]);try{const O=await this.adapterRef.lbsManager.ajax({url:g,type:"POST",contentType:"application/json;charset=utf-8",header:{Token:this.adapterRef.channelInfo.turnToken,"Session-Id":this.adapterRef.deviceId||""},data:{taskId:m[v]}});return O.code===200?(this.logger.log("删除推流任务完成"),Promise.resolve()):(this.logger.log("删除推流任务请求失败:",d.JSONBigStringify(O)),Promise.reject(new s.default({code:c.default.DELETE_TASK_FAILED_ERROR,extraCode:O.code,message:"deleteTasks() 删除推流任务失败: "+O.code})))}catch(O){return this.logger.error("deleteTasks发生错误: ",O.name,O.message),Promise.reject(new s.default({code:c.default.DELETE_TASK_FAILED_ERROR,message:"deleteTasks() 内部错误: $e.message}"}))}}}async updateTasks(f){const{rtmpTasks:m=[]}=f;let g=l.roomsTaskUrl;this.adapterRef.instance._params.neRtcServerAddresses.roomServer&&(g=this.adapterRef.instance._params.neRtcServerAddresses.roomServer,g.substr(-1)!=="/"&&(g+="/"),this.logger.log("updateTasks() 私有化配置的 roomsTaskUrl: ",g)),g=`${g}${this.adapterRef.channelInfo.cid}/task/update`;for(let v=0;v<m.length;v++){const O=m[v].layout;O.users.forEach(T=>{typeof T.uid=="string"&&(T.uid=new u.SimpleBig(T.uid))});try{const T=await this.adapterRef.lbsManager.ajax({url:g,type:"POST",contentType:"application/json;charset=utf-8",header:{Token:this.adapterRef.channelInfo.turnToken,"Session-Id":this.adapterRef.deviceId||""},data:{version:1,taskId:m[v].taskId,streamUrl:m[v].streamUrl,record:m[v].record,hostUid:new u.SimpleBig(this.adapterRef.channelInfo.uid),layout:O,config:m[v].config}});return T.code===200?(this.logger.log("updateTasks() 更新推流任务完成"),Promise.resolve()):(this.logger.log("() 更新推流任务失败：",d.JSONBigStringify(T)),Promise.reject(new s.default({code:c.default.UPDATE_TASKS_FAILED_ERROR,extraCode:T.code,message:"updateTasks() 更新推流任务失败: "+T.code})))}catch(T){return this.logger.error("updateTasks 发生错误: ",T.name,T.message),Promise.reject(new s.default({code:c.default.UPDATE_TASKS_FAILED_ERROR,message:"updateTasks() 内部错误: $e.message}"}))}}}destroy(){this.logger.log("清除 meeting"),this._reset()}}e.Meeting=h},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.processManager=void 0;const i=r(42),a=r(1);e.processManager=new class{constructor(){this.id=new Date;const l=`${i.generateUUID().substr(0,4)}-${new Date().toISOString().replace(/[^\d]/g,"")}`;if(this.processId="proc-"+l,!a.getParameters().reportPageBrowserId)return this.pageId="",void(this.browserId="");try{let n=sessionStorage.getItem("NERTC_PAGEID");n||(n="page-"+l,sessionStorage.setItem("NERTC_PAGEID",n)),this.pageId=n}catch{this.pageId=""}try{let n=sessionStorage.getItem("NERTC_BROWSERID");n||(n="brow-"+l,localStorage.setItem("NERTC_BROWSERID",n)),this.browserId=n}catch{this.browserId=""}}}},function(t,e,r){var i=this&&this.__importDefault||function(g){return g&&g.__esModule?g:{default:g}};Object.defineProperty(e,"__esModule",{value:!0}),e.StatsReport=void 0;const a=r(3),l=r(26),n=i(r(259)),c=i(r(260)),s=r(276),d=r(1),u=r(77),h=r(279),o=r(177),f=Date.now();class m extends a.EventEmitter{constructor(v){var O,T;super(),this._reset(),this.heartbeat_=-1,this.wsTransport_=null,this.sdkRef=v.sdkRef,this.adapterRef=v.adapterRef,this.isReport=v.isReport,this.appKey=this.adapterRef.instance._params.appkey||this.adapterRef.channelInfo&&this.adapterRef.channelInfo.appKey||"",this.reportData={appkey:this.appKey,cid:((O=this.adapterRef)===null||O===void 0?void 0:O.channelInfo.cid)||0,uid:""+((T=this.adapterRef)===null||T===void 0?void 0:T.channelInfo.uid)||"0",browser:u.getBrowserInfo().browserName,platform:u.getOSInfo().osName,timestamp:0,local:{},remote:{}},this.stats=new s.GetStats({adapterRef:this.adapterRef})}_reset(){this.stats&&this.stats.destroy(),this.stats=null,this.stopHeartbeat()}stop(){this.stats&&this.stats.stop()}start(){var v,O,T;this.reportData.uid=""+((v=this.adapterRef)===null||v===void 0?void 0:v.channelInfo.uid)||"0",this.reportData.cid=(O=this.adapterRef)===null||O===void 0?void 0:O.channelInfo.cid;let C=(T=this.adapterRef)===null||T===void 0?void 0:T.deviceId,A=h(`0${f}${l.SDK_VERSION}webwebrtc${C}40f5a1a1871e46089e1e5139a779dd77`),R=`${this.adapterRef.instance._params.neRtcServerAddresses.statisticsWebSocketServer||"wss://statistic.live.126.net/lps-websocket/websocket/collect"}?deviceId=${C}&isTest=0&sdkVer=${l.SDK_VERSION}&sdktype=webrtc&timestamp=${f}&platform=web&checkSum=${A}`;d.getParameters().disableAllReports||(this.wsTransport_=new c.default({url:R,adapterRef:this.adapterRef}),d.getParameters().reportWS=this.wsTransport_,this.wsTransport_.init(),this.startHeartbeat())}startHeartbeat(){this.heartbeat_===-1&&(this.adapterRef.logger.log("startHeartbeat..."),this.heartbeat_=n.default.setInterval(this.doHeartbeat.bind(this),d.getParameters().doHeartbeatInterval))}stopHeartbeat(){this.heartbeat_!==-1&&(n.default.clearInterval(this.heartbeat_),this.heartbeat_=-1)}async doHeartbeat(){var v;try{let O=await((v=this.stats)===null||v===void 0?void 0:v.getAllStats());this.isReport&&(O==null?void 0:O.times)%2==0&&(this.reportData.local=O==null?void 0:O.local,this.reportData.remote=O==null?void 0:O.remote,this.reportData.timestamp=new Date().getTime(),this.wsTransport_.sendPB(this.reportData)),(O==null?void 0:O.times)%60==0&&this.sendDataReportHeartbeat()}catch(O){this.adapterRef.logger.warn("数据上报出现异常: ",O.message)}}sendDataReportHeartbeat(){var v;let O=new o.DataReport({adapterRef:this.adapterRef});O.setHeartbeat({name:"setHeartbeat",uid:""+((v=this.adapterRef)===null||v===void 0?void 0:v.channelInfo.uid)||"0",cid:""+this.adapterRef.channelInfo.cid}),O.send()}destroy(){this.adapterRef.logger.log("[statsReport] destroy()"),this.sendDataReportHeartbeat(),this.stop(),this._reset(),this.isReport&&this.wsTransport_&&this.wsTransport_.close()}}e.StatsReport=m},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0});const i=r(42),a=new class{constructor(){this.intervalMap_=new Map}setInterval(l,n,c=!0){const s=i.generateUUID();let d=Date.now(),u=d;this.intervalMap_.set(s,{rafId:null,timeoutId:null,onVisibilityChange:null});const h=()=>{if(c&&document.hidden){l();const f=setTimeout(h,n);this.setTimeoutId(s,f),d=Date.now(),u=d}else{u=Date.now(),u-d>=n&&(d=u,l());const f=requestAnimationFrame(h);this.setRafId(s,f)}},o=requestAnimationFrame(h);if(this.setRafId(s,o),c){const f=()=>{if(document.hidden){const m=Date.now()-d;if(m>=n)h();else{const g=setTimeout(h,n-m);this.setTimeoutId(s,g)}}};document.addEventListener("visibilitychange",f),this.setOnVisibilityChange(s,f)}return s}clearInterval(l){if(this.intervalMap_.has(l)){const{rafId:n,timeoutId:c,onVisibilityChange:s}=this.intervalMap_.get(l);cancelAnimationFrame(n),clearTimeout(c),document.removeEventListener("visibilitychange",s),this.intervalMap_.delete(l)}}setTimeoutId(l,n){if(this.intervalMap_.has(l)){const c=this.intervalMap_.get(l);c.timeoutId&&clearTimeout(c.timeoutId),c.timeoutId=n}}setRafId(l,n){if(this.intervalMap_.has(l)){const c=this.intervalMap_.get(l);c.rafId&&cancelAnimationFrame(c.rafId),c.rafId=n}}setOnVisibilityChange(l,n){this.intervalMap_.has(l)&&(this.intervalMap_.get(l).onVisibilityChange=n)}};e.default=a},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(f,m,g,v){v===void 0&&(v=g),Object.defineProperty(f,v,{enumerable:!0,get:function(){return m[g]}})}:function(f,m,g,v){v===void 0&&(v=g),f[v]=m[g]}),a=this&&this.__setModuleDefault||(Object.create?function(f,m){Object.defineProperty(f,"default",{enumerable:!0,value:m})}:function(f,m){f.default=m}),l=this&&this.__importStar||function(f){if(f&&f.__esModule)return f;var m={};if(f!=null)for(var g in f)g!=="default"&&Object.prototype.hasOwnProperty.call(f,g)&&i(m,f,g);return a(m,f),m};Object.defineProperty(e,"__esModule",{value:!0});const n=r(3),c=l(r(178)),s=r(42),d=r(275),u=r(1);let h=new Uint8Array(1);h[0]=10;const o=h;e.default=class{constructor(f){this.lastLogTime=0,this.cachedLogs=[],this.textEncoder=new TextEncoder,this.url_=f.url,this.socket_=null,this.isConnected_=!1,this.isConnecting_=!1,this.pingPongTimeoutId_=-1,this.pingTimeoutId_=-1,this.reconnectionTimer_=-1,this.reconnectionCount_=0,this.emitter_=new n.EventEmitter,this.adapterRef=f.adapterRef,this.logger=this.adapterRef.logger.getChild(()=>"wsTransport")}init(){if(u.getParameters().disableLBSService)this.logger.log("connect to url: "+this.url_);else{const f=this.adapterRef.lbsManager.getURLSettings(this.url_)[0];f&&f.url!==this.url_?(this.logger.log(`使用线路变更：From【${this.url_} 】to【${f.url} 】`),this.url_=f.url):this.logger.log(`使用线路： 【${this.url_}】`)}this.socket_=new WebSocket(this.url_),this.bindSocket(this.socket_)}bindSocket(f){f.onopen=this.onopen.bind(this),f.onclose=this.onclose.bind(this),f.onerror=this.onerror.bind(this),f.onmessage=this.onmessage.bind(this)}unbindSocket(f){f.onopen=()=>{},f.onclose=()=>{},f.onerror=()=>{},f.onmessage=()=>{}}onopen(f){if(this.isConnected_)return;this.isConnected_=!0,this.isConnecting_=!1;const m=f.target.url;this.logger.log(`websocket[${m}] is connected`),this.urlSetting&&(this.logger.debug(`markFinish success seqId:${this.urlSetting.seqId} source:${this.urlSetting.item.source}  url:${m}`),delete this.urlSetting),this.startPingPong()}onclose(f){const m=f.target.url,g=f.target===this.socket_;this.logger.log(`websocket[${m} InUse: ${g}] is closed with code: ${f.code}`),this.socket_&&f.target===this.socket_&&(this.isConnected_=!1,f.wasClean&&f.code===1e3?this.close():(this.logger.warn(`onclose code:${f.code} reason:${f.reason}`),this.socket_.onclose=()=>{},this.socket_.close(4001),this.socket_=null,this.reconnect()))}onerror(f){const m=f.target.url;this.logger.warn(`websocket[${m}] error observed`),this.urlSetting&&(this.logger.debug(`markFinish fail seqId:${this.urlSetting.seqId} source:${this.urlSetting.item.source}  url:${m}`),delete this.urlSetting),this.isConnected_?f.target===this.socket_&&(this.isConnected_=!1,this.socket_=null,this.reconnect()):this.reconnect(),this.isConnecting_=!1,this.isConnected_=!1}onmessage(f){this.isConnected_&&f&&f.data&&(JSON.parse(f.data).action===11&&this.emit(11,f),this.clearReconnectionTimer())}isConnected(){return this.isConnected_}sendPB(f){var m;if(this.isConnected_){const g=this.createPBMessage(f);((m=this.socket_)===null||m===void 0?void 0:m.readyState)===1&&this.socket_.send(g)}}sendPing(f){var m;this.isConnected_&&((m=this.socket_)===null||m===void 0?void 0:m.readyState)===1&&this.socket_.send(f)}async sendLog(f){var m,g;const v=Math.max(this.lastLogTime+1,Date.now());this.lastLogTime=v;try{this.cachedLogs.length&&this.cachedLogs[this.cachedLogs.length-1].data[0].replace("[NERTC","[缓存][NERTC")}catch{}if(this.cachedLogs.push({time:v,data:f}),this.cachedLogs.length>500&&this.cachedLogs.shift(),this.isConnected_&&((m=this.socket_)===null||m===void 0?void 0:m.readyState)===1&&((g=this.adapterRef.channelInfo)===null||g===void 0?void 0:g.cid)){const O=this.cachedLogs;this.cachedLogs=[];const T=50,C=Math.ceil(O.length/T);for(let A=0;A<C;A++){const R=A*T,w=R+T,k=O.slice(R,w);await this.delay(100),this.sendBatch(k)}}}delay(f){return new Promise(m=>setTimeout(m,f))}sendBatch(f){for(let m of f){const g=Object.assign({uid:this.adapterRef.channelInfo.uid,cid:this.adapterRef.channelInfo.cid},m);try{const v=this.textEncoder.encode(JSON.stringify(g));let O=[5,1,1,1,2,0,0,0],T=Uint8Array.from(O.concat(Array.from(v)));this.socket_.send(T)}catch{}}}createPBMessage(f){let m=c.Root.fromJSON(d).lookupType("WebrtcStats"),g=m.create(f),v=m.encode(g).finish();return Uint8Array.from([4,1,1,1,3,0,0,0].concat(Array.from(v)))}async startPingPong(){try{if(this.pingPongTimeoutId_!==-1)return;await this.ping(),this.pingPongTimeoutId_=setTimeout(()=>{this.pingPongTimeoutId_=-1,this.startPingPong()},1e4)}catch{this.logger.warn("ping-pong failed, start reconnection"),this.clearSocket(),this.reconnect()}}stopPingPong(){this.logger.log("stop ping pong"),clearTimeout(this.pingTimeoutId_),clearTimeout(this.pingPongTimeoutId_),this.pingTimeoutId_=-1,this.pingPongTimeoutId_=-1}ping(){return new Promise((f,m)=>{if(this.pingTimeoutId_!==-1)return f();this.sendPing(o),this.once(11,()=>{clearTimeout(this.pingTimeoutId_),this.pingTimeoutId_=-1,f()}),this.pingTimeoutId_=setTimeout(()=>{this.pingTimeoutId_=-1,m()},1e4)})}reconnect(){var f,m,g;if(this.isConnecting_||this.reconnectionTimer_!==-1)return void this.logger.log("websocket is reconnecting");if(this.isConnecting_=!0,this.reconnectionCount_++,(g=(m=(f=this.adapterRef.instance)===null||f===void 0?void 0:f._params)===null||m===void 0?void 0:m.neRtcServerAddresses)===null||g===void 0?void 0:g.channelServer)return void this.logger.log("WebSocket不启用备用线路：当前为私有化配置");{const O=this.adapterRef.lbsManager.getURLSettings(this.url_),T=O[this.reconnectionCount_%O.length];T.url!==this.url_&&(this.logger.warn(`${T.seqId} WebSocket切换备用线路 ${this.url_} => ${T.url}`),this.url_=T.url,this.urlSetting=T)}this.socket_=new WebSocket(this.url_),this.bindSocket(this.socket_);const v=s.getReconnectionTimeout(this.reconnectionCount_);this.reconnectionTimer_=setTimeout(()=>{this.isConnecting_=!1,this.clearReconnectionTimer(),this.socket_&&this.unbindSocket(this.socket_),this.socket_=null,this.reconnect()},v)}clearReconnectionTimer(){this.reconnectionTimer_!==-1&&(clearTimeout(this.reconnectionTimer_),this.reconnectionTimer_=-1)}once(f,m,g){this.emitter_.once(f,m,g)}emit(f,m,g){this.emitter_.emit(f,m,g)}clearSocket(){this.socket_&&this.unbindSocket(this.socket_),this.isConnected_=!1,this.isConnecting_=!1,this.socket_=null}async close(){var f;await this.delay(1e3),this.logger.log("close websocket"),this.clearReconnectionTimer(),this.stopPingPong(),(f=this.socket_)===null||f===void 0||f.close(),this.clearSocket()}}},function(t,e,r){var i=t.exports=r(262);i.build="light",i.load=function(a,l,n){return typeof l=="function"?(n=l,l=new i.Root):l||(l=new i.Root),l.load(a,n)},i.loadSync=function(a,l){return l||(l=new i.Root),l.loadSync(a)},i.encoder=r(183),i.decoder=r(188),i.verifier=r(189),i.converter=r(190),i.ReflectionObject=r(82),i.Namespace=r(91),i.Root=r(192),i.Enum=r(45),i.Type=r(184),i.Field=r(83),i.OneOf=r(141),i.MapField=r(185),i.Service=r(186),i.Method=r(187),i.Message=r(153),i.wrappers=r(191),i.types=r(92),i.util=r(19),i.ReflectionObject._configure(i.Root),i.Namespace._configure(i.Type,i.Service,i.Enum),i.Root._configure(i.Type),i.Field._configure(i.Type)},function(t,e,r){var i=e;function a(){i.util._configure(),i.Writer._configure(i.BufferWriter),i.Reader._configure(i.BufferReader)}i.build="minimal",i.Writer=r(151),i.BufferWriter=r(269),i.Reader=r(152),i.BufferReader=r(270),i.util=r(44),i.rpc=r(181),i.roots=r(182),i.configure=a,a()},function(t,e,r){var i=e;i.length=function(c){var s=c.length;if(!s)return 0;for(var d=0;--s%4>1&&c.charAt(s)==="=";)++d;return Math.ceil(3*c.length)/4-d};for(var a=new Array(64),l=new Array(123),n=0;n<64;)l[a[n]=n<26?n+65:n<52?n+71:n<62?n-4:n-59|43]=n++;i.encode=function(c,s,d){for(var u,h=null,o=[],f=0,m=0;s<d;){var g=c[s++];switch(m){case 0:o[f++]=a[g>>2],u=(3&g)<<4,m=1;break;case 1:o[f++]=a[u|g>>4],u=(15&g)<<2,m=2;break;case 2:o[f++]=a[u|g>>6],o[f++]=a[63&g],m=0}f>8191&&((h||(h=[])).push(String.fromCharCode.apply(String,o)),f=0)}return m&&(o[f++]=a[u],o[f++]=61,m===1&&(o[f++]=61)),h?(f&&h.push(String.fromCharCode.apply(String,o.slice(0,f))),h.join("")):String.fromCharCode.apply(String,o.slice(0,f))},i.decode=function(c,s,d){for(var u,h=d,o=0,f=0;f<c.length;){var m=c.charCodeAt(f++);if(m===61&&o>1)break;if((m=l[m])===void 0)throw Error("invalid encoding");switch(o){case 0:u=m,o=1;break;case 1:s[d++]=u<<2|(48&m)>>4,u=m,o=2;break;case 2:s[d++]=(15&u)<<4|(60&m)>>2,u=m,o=3;break;case 3:s[d++]=(3&u)<<6|m,o=0}}if(o===1)throw Error("invalid encoding");return d-h},i.test=function(c){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(c)}},function(t,e,r){function i(){this._listeners={}}t.exports=i,i.prototype.on=function(a,l,n){return(this._listeners[a]||(this._listeners[a]=[])).push({fn:l,ctx:n||this}),this},i.prototype.off=function(a,l){if(a===void 0)this._listeners={};else if(l===void 0)this._listeners[a]=[];else for(var n=this._listeners[a],c=0;c<n.length;)n[c].fn===l?n.splice(c,1):++c;return this},i.prototype.emit=function(a){var l=this._listeners[a];if(l){for(var n=[],c=1;c<arguments.length;)n.push(arguments[c++]);for(c=0;c<l.length;)l[c].fn.apply(l[c++].ctx,n)}return this}},function(t,e,r){function i(s){return typeof Float32Array<"u"?function(){var d=new Float32Array([-0]),u=new Uint8Array(d.buffer),h=u[3]===128;function o(v,O,T){d[0]=v,O[T]=u[0],O[T+1]=u[1],O[T+2]=u[2],O[T+3]=u[3]}function f(v,O,T){d[0]=v,O[T]=u[3],O[T+1]=u[2],O[T+2]=u[1],O[T+3]=u[0]}function m(v,O){return u[0]=v[O],u[1]=v[O+1],u[2]=v[O+2],u[3]=v[O+3],d[0]}function g(v,O){return u[3]=v[O],u[2]=v[O+1],u[1]=v[O+2],u[0]=v[O+3],d[0]}s.writeFloatLE=h?o:f,s.writeFloatBE=h?f:o,s.readFloatLE=h?m:g,s.readFloatBE=h?g:m}():function(){function d(h,o,f,m){var g=o<0?1:0;if(g&&(o=-o),o===0)h(1/o>0?0:2147483648,f,m);else if(isNaN(o))h(2143289344,f,m);else if(o>34028234663852886e22)h((g<<31|2139095040)>>>0,f,m);else if(o<11754943508222875e-54)h((g<<31|Math.round(o/1401298464324817e-60))>>>0,f,m);else{var v=Math.floor(Math.log(o)/Math.LN2);h((g<<31|v+127<<23|8388607&Math.round(o*Math.pow(2,-v)*8388608))>>>0,f,m)}}function u(h,o,f){var m=h(o,f),g=2*(m>>31)+1,v=m>>>23&255,O=8388607&m;return v===255?O?NaN:g*(1/0):v===0?1401298464324817e-60*g*O:g*Math.pow(2,v-150)*(O+8388608)}s.writeFloatLE=d.bind(null,a),s.writeFloatBE=d.bind(null,l),s.readFloatLE=u.bind(null,n),s.readFloatBE=u.bind(null,c)}(),typeof Float64Array<"u"?function(){var d=new Float64Array([-0]),u=new Uint8Array(d.buffer),h=u[7]===128;function o(v,O,T){d[0]=v,O[T]=u[0],O[T+1]=u[1],O[T+2]=u[2],O[T+3]=u[3],O[T+4]=u[4],O[T+5]=u[5],O[T+6]=u[6],O[T+7]=u[7]}function f(v,O,T){d[0]=v,O[T]=u[7],O[T+1]=u[6],O[T+2]=u[5],O[T+3]=u[4],O[T+4]=u[3],O[T+5]=u[2],O[T+6]=u[1],O[T+7]=u[0]}function m(v,O){return u[0]=v[O],u[1]=v[O+1],u[2]=v[O+2],u[3]=v[O+3],u[4]=v[O+4],u[5]=v[O+5],u[6]=v[O+6],u[7]=v[O+7],d[0]}function g(v,O){return u[7]=v[O],u[6]=v[O+1],u[5]=v[O+2],u[4]=v[O+3],u[3]=v[O+4],u[2]=v[O+5],u[1]=v[O+6],u[0]=v[O+7],d[0]}s.writeDoubleLE=h?o:f,s.writeDoubleBE=h?f:o,s.readDoubleLE=h?m:g,s.readDoubleBE=h?g:m}():function(){function d(h,o,f,m,g,v){var O=m<0?1:0;if(O&&(m=-m),m===0)h(0,g,v+o),h(1/m>0?0:2147483648,g,v+f);else if(isNaN(m))h(0,g,v+o),h(2146959360,g,v+f);else if(m>17976931348623157e292)h(0,g,v+o),h((O<<31|2146435072)>>>0,g,v+f);else{var T;if(m<22250738585072014e-324)h((T=m/5e-324)>>>0,g,v+o),h((O<<31|T/4294967296)>>>0,g,v+f);else{var C=Math.floor(Math.log(m)/Math.LN2);C===1024&&(C=1023),h(4503599627370496*(T=m*Math.pow(2,-C))>>>0,g,v+o),h((O<<31|C+1023<<20|1048576*T&1048575)>>>0,g,v+f)}}}function u(h,o,f,m,g){var v=h(m,g+o),O=h(m,g+f),T=2*(O>>31)+1,C=O>>>20&2047,A=4294967296*(1048575&O)+v;return C===2047?A?NaN:T*(1/0):C===0?5e-324*T*A:T*Math.pow(2,C-1075)*(A+4503599627370496)}s.writeDoubleLE=d.bind(null,a,0,4),s.writeDoubleBE=d.bind(null,l,4,0),s.readDoubleLE=u.bind(null,n,0,4),s.readDoubleBE=u.bind(null,c,4,0)}(),s}function a(s,d,u){d[u]=255&s,d[u+1]=s>>>8&255,d[u+2]=s>>>16&255,d[u+3]=s>>>24}function l(s,d,u){d[u]=s>>>24,d[u+1]=s>>>16&255,d[u+2]=s>>>8&255,d[u+3]=255&s}function n(s,d){return(s[d]|s[d+1]<<8|s[d+2]<<16|s[d+3]<<24)>>>0}function c(s,d){return(s[d]<<24|s[d+1]<<16|s[d+2]<<8|s[d+3])>>>0}t.exports=i(i)},function(t,e,r){var i=e;i.length=function(a){for(var l=0,n=0,c=0;c<a.length;++c)(n=a.charCodeAt(c))<128?l+=1:n<2048?l+=2:(64512&n)==55296&&(64512&a.charCodeAt(c+1))==56320?(++c,l+=4):l+=3;return l},i.read=function(a,l,n){if(n-l<1)return"";for(var c,s=null,d=[],u=0;l<n;)(c=a[l++])<128?d[u++]=c:c>191&&c<224?d[u++]=(31&c)<<6|63&a[l++]:c>239&&c<365?(c=((7&c)<<18|(63&a[l++])<<12|(63&a[l++])<<6|63&a[l++])-65536,d[u++]=55296+(c>>10),d[u++]=56320+(1023&c)):d[u++]=(15&c)<<12|(63&a[l++])<<6|63&a[l++],u>8191&&((s||(s=[])).push(String.fromCharCode.apply(String,d)),u=0);return s?(u&&s.push(String.fromCharCode.apply(String,d.slice(0,u))),s.join("")):String.fromCharCode.apply(String,d.slice(0,u))},i.write=function(a,l,n){for(var c,s,d=n,u=0;u<a.length;++u)(c=a.charCodeAt(u))<128?l[n++]=c:c<2048?(l[n++]=c>>6|192,l[n++]=63&c|128):(64512&c)==55296&&(64512&(s=a.charCodeAt(u+1)))==56320?(c=65536+((1023&c)<<10)+(1023&s),++u,l[n++]=c>>18|240,l[n++]=c>>12&63|128,l[n++]=c>>6&63|128,l[n++]=63&c|128):(l[n++]=c>>12|224,l[n++]=c>>6&63|128,l[n++]=63&c|128);return n-d}},function(t,e,r){t.exports=function(i,a,l){var n=l||8192,c=n>>>1,s=null,d=n;return function(u){if(u<1||u>c)return i(u);d+u>n&&(s=i(n),d=0);var h=a.call(s,d,d+=u);return 7&d&&(d=1+(7|d)),h}}},function(t,e,r){t.exports=a;var i=r(44);function a(s,d){this.lo=s>>>0,this.hi=d>>>0}var l=a.zero=new a(0,0);l.toNumber=function(){return 0},l.zzEncode=l.zzDecode=function(){return this},l.length=function(){return 1};var n=a.zeroHash="\0\0\0\0\0\0\0\0";a.fromNumber=function(s){if(s===0)return l;var d=s<0;d&&(s=-s);var u=s>>>0,h=(s-u)/4294967296>>>0;return d&&(h=~h>>>0,u=~u>>>0,++u>4294967295&&(u=0,++h>4294967295&&(h=0))),new a(u,h)},a.from=function(s){if(typeof s=="number")return a.fromNumber(s);if(i.isString(s)){if(!i.Long)return a.fromNumber(parseInt(s,10));s=i.Long.fromString(s)}return s.low||s.high?new a(s.low>>>0,s.high>>>0):l},a.prototype.toNumber=function(s){if(!s&&this.hi>>>31){var d=1+~this.lo>>>0,u=~this.hi>>>0;return d||(u=u+1>>>0),-(d+4294967296*u)}return this.lo+4294967296*this.hi},a.prototype.toLong=function(s){return i.Long?new i.Long(0|this.lo,0|this.hi,!!s):{low:0|this.lo,high:0|this.hi,unsigned:!!s}};var c=String.prototype.charCodeAt;a.fromHash=function(s){return s===n?l:new a((c.call(s,0)|c.call(s,1)<<8|c.call(s,2)<<16|c.call(s,3)<<24)>>>0,(c.call(s,4)|c.call(s,5)<<8|c.call(s,6)<<16|c.call(s,7)<<24)>>>0)},a.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},a.prototype.zzEncode=function(){var s=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^s)>>>0,this.lo=(this.lo<<1^s)>>>0,this},a.prototype.zzDecode=function(){var s=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^s)>>>0,this.hi=(this.hi>>>1^s)>>>0,this},a.prototype.length=function(){var s=this.lo,d=(this.lo>>>28|this.hi<<4)>>>0,u=this.hi>>>24;return u===0?d===0?s<16384?s<128?1:2:s<2097152?3:4:d<16384?d<128?5:6:d<2097152?7:8:u<128?9:10}},function(t,e,r){t.exports=l;var i=r(151);(l.prototype=Object.create(i.prototype)).constructor=l;var a=r(44);function l(){i.call(this)}function n(c,s,d){c.length<40?a.utf8.write(c,s,d):s.utf8Write?s.utf8Write(c,d):s.write(c,d)}l._configure=function(){l.alloc=a._Buffer_allocUnsafe,l.writeBytesBuffer=a.Buffer&&a.Buffer.prototype instanceof Uint8Array&&a.Buffer.prototype.set.name==="set"?function(c,s,d){s.set(c,d)}:function(c,s,d){if(c.copy)c.copy(s,d,0,c.length);else for(var u=0;u<c.length;)s[d++]=c[u++]}},l.prototype.bytes=function(c){a.isString(c)&&(c=a._Buffer_from(c,"base64"));var s=c.length>>>0;return this.uint32(s),s&&this._push(l.writeBytesBuffer,s,c),this},l.prototype.string=function(c){var s=a.Buffer.byteLength(c);return this.uint32(s),s&&this._push(n,s,c),this},l._configure()},function(t,e,r){t.exports=l;var i=r(152);(l.prototype=Object.create(i.prototype)).constructor=l;var a=r(44);function l(n){i.call(this,n)}l._configure=function(){a.Buffer&&(l.prototype._slice=a.Buffer.prototype.slice)},l.prototype.string=function(){var n=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+n,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+n,this.len))},l._configure()},function(t,e,r){t.exports=a;var i=r(44);function a(l,n,c){if(typeof l!="function")throw TypeError("rpcImpl must be a function");i.EventEmitter.call(this),this.rpcImpl=l,this.requestDelimited=!!n,this.responseDelimited=!!c}(a.prototype=Object.create(i.EventEmitter.prototype)).constructor=a,a.prototype.rpcCall=function l(n,c,s,d,u){if(!d)throw TypeError("request must be specified");var h=this;if(!u)return i.asPromise(l,h,n,c,s,d);if(h.rpcImpl)try{return h.rpcImpl(n,c[h.requestDelimited?"encodeDelimited":"encode"](d).finish(),function(o,f){if(o)return h.emit("error",o,n),u(o);if(f!==null){if(!(f instanceof s))try{f=s[h.responseDelimited?"decodeDelimited":"decode"](f)}catch(m){return h.emit("error",m,n),u(m)}return h.emit("data",f,n),u(null,f)}h.end(!0)})}catch(o){return h.emit("error",o,n),void setTimeout(function(){u(o)},0)}else setTimeout(function(){u(Error("already ended"))},0)},a.prototype.end=function(l){return this.rpcImpl&&(l||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},function(t,e,r){function i(a,l){typeof a=="string"&&(l=a,a=void 0);var n=[];function c(d){if(typeof d!="string"){var u=s();if(i.verbose&&console.log("codegen: "+u),u="return "+u,d){for(var h=Object.keys(d),o=new Array(h.length+1),f=new Array(h.length),m=0;m<h.length;)o[m]=h[m],f[m]=d[h[m++]];return o[m]=u,Function.apply(null,o).apply(null,f)}return Function(u)()}for(var g=new Array(arguments.length-1),v=0;v<g.length;)g[v]=arguments[++v];if(v=0,d=d.replace(/%([%dfijs])/g,function(O,T){var C=g[v++];switch(T){case"d":case"f":return String(Number(C));case"i":return String(Math.floor(C));case"j":return JSON.stringify(C);case"s":return String(C)}return"%"}),v!==g.length)throw Error("parameter count mismatch");return n.push(d),c}function s(d){return"function "+(d||l||"")+"("+(a&&a.join(",")||"")+`){
  `+n.join(`
  `)+`
}`}return c.toString=s,c}t.exports=i,i.verbose=!1},function(t,e,r){t.exports=l;var i=r(179),a=r(180)("fs");function l(n,c,s){return typeof c=="function"?(s=c,c={}):c||(c={}),s?!c.xhr&&a&&a.readFile?a.readFile(n,function(d,u){return d&&typeof XMLHttpRequest<"u"?l.xhr(n,c,s):d?s(d):s(null,c.binary?u:u.toString("utf8"))}):l.xhr(n,c,s):i(l,this,n,c)}l.xhr=function(n,c,s){var d=new XMLHttpRequest;d.onreadystatechange=function(){if(d.readyState===4){if(d.status!==0&&d.status!==200)return s(Error("status "+d.status));if(c.binary){var u=d.response;if(!u){u=[];for(var h=0;h<d.responseText.length;++h)u.push(255&d.responseText.charCodeAt(h))}return s(null,typeof Uint8Array<"u"?new Uint8Array(u):u)}return s(null,d.responseText)}},c.binary&&("overrideMimeType"in d&&d.overrideMimeType("text/plain; charset=x-user-defined"),d.responseType="arraybuffer"),d.open("GET",n),d.send()}},function(t,e,r){var i=e,a=i.isAbsolute=function(n){return/^(?:\/|\w+:)/.test(n)},l=i.normalize=function(n){var c=(n=n.replace(/\\/g,"/").replace(/\/{2,}/g,"/")).split("/"),s=a(n),d="";s&&(d=c.shift()+"/");for(var u=0;u<c.length;)c[u]===".."?u>0&&c[u-1]!==".."?c.splice(--u,2):s?c.splice(u,1):++u:c[u]==="."?c.splice(u,1):++u;return d+c.join("/")};i.resolve=function(n,c,s){return s||(c=l(c)),a(c)?c:(s||(n=l(n)),(n=n.replace(/(?:\/|^)[^/]+$/,"")).length?l(n+"/"+c):c)}},function(t,e,r){var i=r(178),a=(i.roots.default||(i.roots.default=new i.Root)).addJSON({WebrtcStats:{fields:{local:{type:"local_obj",id:1},remote:{type:"remote_obj",id:2},timestamp:{type:"int64",id:3},appkey:{type:"string",id:4},cid:{type:"int64",id:5},uid:{type:"string",id:6},browser:{type:"string",id:7},platform:{type:"string",id:8},sdkVersion:{type:"string",id:9}},nested:{local_obj:{fields:{audio_ssrc:{rule:"repeated",type:"audio_ssrc_obj",id:1},audioSlave_ssrc:{rule:"repeated",type:"audioSlave_ssrc_obj",id:2},video_ssrc:{rule:"repeated",type:"video_ssrc_obj",id:3},screen_ssrc:{rule:"repeated",type:"screen_ssrc_obj",id:4},bwe:{rule:"repeated",type:"bwe_obj",id:5}},nested:{audio_ssrc_obj:{fields:{audioInputLevel:{type:"int64",id:1},totalAudioEnergy:{type:"int64",id:2},totalSamplesDuration:{type:"int64",id:3},bytesSent:{type:"int64",id:4},bitsSentPerSecond:{type:"int64",id:5},targetBitrate:{type:"int64",id:6},packetsSent:{type:"int64",id:7},packetsSentPerSecond:{type:"int64",id:8},packetsLost:{type:"int64",id:9},fractionLost:{type:"int64",id:10},packetsLostRate:{type:"int64",id:11},nackCount:{type:"int64",id:12},rtt:{type:"int64",id:13},jitterReceived:{type:"int64",id:14},echoReturnLoss:{type:"string",id:15},echoReturnLossEnhancement:{type:"string",id:16},active:{type:"int64",id:17}}},audioSlave_ssrc_obj:{fields:{audioInputLevel:{type:"int64",id:1},totalAudioEnergy:{type:"int64",id:2},totalSamplesDuration:{type:"int64",id:3},bytesSent:{type:"int64",id:4},bitsSentPerSecond:{type:"int64",id:5},targetBitrate:{type:"int64",id:6},packetsSent:{type:"int64",id:7},packetsSentPerSecond:{type:"int64",id:8},packetsLost:{type:"int64",id:9},fractionLost:{type:"int64",id:10},packetsLostRate:{type:"int64",id:11},nackCount:{type:"int64",id:12},rtt:{type:"int64",id:13},jitterReceived:{type:"int64",id:14},echoReturnLoss:{type:"string",id:15},echoReturnLossEnhancement:{type:"string",id:16},active:{type:"int64",id:17}}},video_ssrc_obj:{fields:{bytesSent:{type:"int64",id:1},bitsSentPerSecond:{type:"int64",id:2},targetBitrate:{type:"int64",id:3},packetsSent:{type:"int64",id:4},packetsSentPerSecond:{type:"int64",id:5},packetsLost:{type:"int64",id:6},fractionLost:{type:"int64",id:7},packetsLostRate:{type:"int64",id:8},firCount:{type:"int64",id:9},pliCount:{type:"int64",id:10},nackCount:{type:"int64",id:11},framesEncoded:{type:"int64",id:12},framesEncodedPerSecond:{type:"int64",id:13},avgEncodeMs:{type:"int64",id:14},encodeUsagePercent:{type:"int64",id:15},framesSent:{type:"int64",id:16},frameRateInput:{type:"int64",id:17},frameRateSent:{type:"int64",id:18},frameWidthInput:{type:"int64",id:19},frameWidthSent:{type:"int64",id:20},frameHeightInput:{type:"int64",id:21},frameHeightSent:{type:"int64",id:22},hugeFramesSent:{type:"int64",id:23},qpSum:{type:"int64",id:24},qpPercentage:{type:"int64",id:25},freezeTime:{type:"int64",id:26},totalFreezeTime:{type:"int64",id:27},qualityLimitationReason:{type:"string",id:28},qualityLimitationResolutionChanges:{type:"int64",id:29},jitter:{type:"int64",id:30},rtt:{type:"int64",id:31},active:{type:"int64",id:32},streamType:{type:"string",id:33}}},screen_ssrc_obj:{fields:{bytesSent:{type:"int64",id:1},bitsSentPerSecond:{type:"int64",id:2},targetBitrate:{type:"int64",id:3},packetsSent:{type:"int64",id:4},packetsSentPerSecond:{type:"int64",id:5},packetsLost:{type:"int64",id:6},fractionLost:{type:"int64",id:7},packetsLostRate:{type:"int64",id:8},firCount:{type:"int64",id:9},pliCount:{type:"int64",id:10},nackCount:{type:"int64",id:11},framesEncoded:{type:"int64",id:12},framesEncodedPerSecond:{type:"int64",id:13},avgEncodeMs:{type:"int64",id:14},encodeUsagePercent:{type:"int64",id:15},framesSent:{type:"int64",id:16},frameRateInput:{type:"int64",id:17},frameRateSent:{type:"int64",id:18},frameWidthInput:{type:"int64",id:19},frameWidthSent:{type:"int64",id:20},frameHeightInput:{type:"int64",id:21},frameHeightSent:{type:"int64",id:22},hugeFramesSent:{type:"int64",id:23},qpSum:{type:"int64",id:24},qpPercentage:{type:"int64",id:25},freezeTime:{type:"int64",id:26},totalFreezeTime:{type:"int64",id:27},qualityLimitationReason:{type:"string",id:28},qualityLimitationResolutionChanges:{type:"int64",id:29},jitter:{type:"int64",id:30},rtt:{type:"int64",id:31},active:{type:"int64",id:32},streamType:{type:"string",id:33}}},bwe_obj:{fields:{googActualEncBitrate:{type:"int64",id:1},googAvailableSendBandwidth:{type:"int64",id:2},googRetransmitBitrate:{type:"int64",id:3},googAvailableReceiveBandwidth:{type:"int64",id:4},googTargetEncBitrate:{type:"int64",id:5},googBucketDelay:{type:"int64",id:6},googTransmitBitrate:{type:"int64",id:7}}}}},remote_obj:{fields:{audio_ssrc:{rule:"repeated",type:"audio_ssrc_obj",id:1},audioSlave_ssrc:{rule:"repeated",type:"audioSlave_ssrc_obj",id:2},video_ssrc:{rule:"repeated",type:"video_ssrc_obj",id:3},screen_ssrc:{rule:"repeated",type:"screen_ssrc_obj",id:4}},nested:{audio_ssrc_obj:{fields:{audioOutputLevel:{type:"int64",id:1},totalAudioEnergy:{type:"int64",id:2},totalSamplesDuration:{type:"int64",id:3},bytesReceived:{type:"int64",id:4},bitsReceivedPerSecond:{type:"int64",id:5},packetsReceived:{type:"int64",id:6},packetsReceivedPerSecond:{type:"int64",id:7},packetsLost:{type:"int64",id:8},packetsLostRate:{type:"int64",id:9},nackCount:{type:"int64",id:10},lastPacketReceivedTimestamp:{type:"int64",id:11},estimatedPlayoutTimestamp:{type:"int64",id:12},freezeTime:{type:"int64",id:13},totalFreezeTime:{type:"int64",id:14},decodingPLC:{type:"int64",id:15},decodingPLCCNG:{type:"int64",id:16},decodingNormal:{type:"int64",id:17},decodingMuted:{type:"int64",id:18},decodingCNG:{type:"int64",id:19},decodingCTN:{type:"int64",id:20},currentDelayMs:{type:"int64",id:21},preferredJitterBufferMs:{type:"int64",id:22},jitterBufferMs:{type:"int64",id:23},jitterBufferDelay:{type:"int64",id:24},jitter:{type:"int64",id:25},rtt:{type:"int64",id:26},preemptiveExpandRate:{type:"int64",id:27},speechExpandRate:{type:"int64",id:28},concealedSamples:{type:"int64",id:29},silentConcealedSamples:{type:"int64",id:30},secondaryDecodedRate:{type:"int64",id:31},secondaryDiscardedRate:{type:"int64",id:32},remoteuid:{type:"string",id:33}}},audioSlave_ssrc_obj:{fields:{audioOutputLevel:{type:"int64",id:1},totalAudioEnergy:{type:"int64",id:2},totalSamplesDuration:{type:"int64",id:3},bytesReceived:{type:"int64",id:4},bitsReceivedPerSecond:{type:"int64",id:5},packetsReceived:{type:"int64",id:6},packetsReceivedPerSecond:{type:"int64",id:7},packetsLost:{type:"int64",id:8},packetsLostRate:{type:"int64",id:9},nackCount:{type:"int64",id:10},lastPacketReceivedTimestamp:{type:"int64",id:11},estimatedPlayoutTimestamp:{type:"int64",id:12},freezeTime:{type:"int64",id:13},totalFreezeTime:{type:"int64",id:14},decodingPLC:{type:"int64",id:15},decodingPLCCNG:{type:"int64",id:16},decodingNormal:{type:"int64",id:17},decodingMuted:{type:"int64",id:18},decodingCNG:{type:"int64",id:19},decodingCTN:{type:"int64",id:20},currentDelayMs:{type:"int64",id:21},preferredJitterBufferMs:{type:"int64",id:22},jitterBufferMs:{type:"int64",id:23},jitterBufferDelay:{type:"int64",id:24},jitter:{type:"int64",id:25},rtt:{type:"int64",id:26},preemptiveExpandRate:{type:"int64",id:27},speechExpandRate:{type:"int64",id:28},concealedSamples:{type:"int64",id:29},silentConcealedSamples:{type:"int64",id:30},secondaryDecodedRate:{type:"int64",id:31},secondaryDiscardedRate:{type:"int64",id:32},remoteuid:{type:"string",id:33}}},video_ssrc_obj:{fields:{bytesReceived:{type:"int64",id:1},bitsReceivedPerSecond:{type:"int64",id:2},packetsReceived:{type:"int64",id:3},packetsReceivedPerSecond:{type:"int64",id:4},packetsLost:{type:"int64",id:5},packetsLostRate:{type:"int64",id:6},firCount:{type:"int64",id:7},pliCount:{type:"int64",id:8},nackCount:{type:"int64",id:9},lastPacketReceivedTimestamp:{type:"int64",id:10},estimatedPlayoutTimestamp:{type:"int64",id:11},pauseCount:{type:"int64",id:12},totalPausesDuration:{type:"int64",id:13},freezeCount:{type:"int64",id:14},totalFreezesDuration:{type:"int64",id:15},totalFreezeTime:{type:"int64",id:16},freezeTime:{type:"int64",id:17},framesDecoded:{type:"int64",id:18},framesDropped:{type:"int64",id:19},framesReceived:{type:"int64",id:20},decodeMs:{type:"int64",id:21},frameRateDecoded:{type:"int64",id:22},frameRateOutput:{type:"int64",id:23},frameRateReceived:{type:"int64",id:24},frameWidthReceived:{type:"int64",id:25},frameHeightReceived:{type:"int64",id:26},powerEfficientDecoder:{type:"int64",id:27},currentDelayMs:{type:"int64",id:28},jitterBufferDelay:{type:"int64",id:29},remoteuid:{type:"string",id:30}}},screen_ssrc_obj:{fields:{bytesReceived:{type:"int64",id:1},bitsReceivedPerSecond:{type:"int64",id:2},packetsReceived:{type:"int64",id:3},packetsReceivedPerSecond:{type:"int64",id:4},packetsLost:{type:"int64",id:5},packetsLostRate:{type:"int64",id:6},firCount:{type:"int64",id:7},pliCount:{type:"int64",id:8},nackCount:{type:"int64",id:9},lastPacketReceivedTimestamp:{type:"int64",id:10},estimatedPlayoutTimestamp:{type:"int64",id:11},pauseCount:{type:"int64",id:12},totalPausesDuration:{type:"int64",id:13},freezeCount:{type:"int64",id:14},totalFreezesDuration:{type:"int64",id:15},totalFreezeTime:{type:"int64",id:16},freezeTime:{type:"int64",id:17},framesDecoded:{type:"int64",id:18},framesDropped:{type:"int64",id:19},framesReceived:{type:"int64",id:20},decodeMs:{type:"int64",id:21},frameRateDecoded:{type:"int64",id:22},frameRateOutput:{type:"int64",id:23},frameRateReceived:{type:"int64",id:24},frameWidthReceived:{type:"int64",id:25},frameHeightReceived:{type:"int64",id:26},powerEfficientDecoder:{type:"int64",id:27},currentDelayMs:{type:"int64",id:28},jitterBufferDelay:{type:"int64",id:29},remoteuid:{type:"string",id:30}}}}}}}});t.exports=a},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(R,w,k,I){I===void 0&&(I=k),Object.defineProperty(R,I,{enumerable:!0,get:function(){return w[k]}})}:function(R,w,k,I){I===void 0&&(I=k),R[I]=w[k]}),a=this&&this.__setModuleDefault||(Object.create?function(R,w){Object.defineProperty(R,"default",{enumerable:!0,value:w})}:function(R,w){R.default=w}),l=this&&this.__importStar||function(R){if(R&&R.__esModule)return R;var w={};if(R!=null)for(var k in R)k!=="default"&&Object.prototype.hasOwnProperty.call(R,k)&&i(w,R,k);return a(w,R),w};Object.defineProperty(e,"__esModule",{value:!0}),e.GetStats=void 0;const n=r(277),c=l(r(7)),s=r(1),d=r(278);let u=[],h=[],o=[],f=[],m={},g={},v={},O={};function T(R){if(!R)return 16;let w;return w=new Map([["speech_low_quality",16],["speech_standard",32],["music_standard",48],["standard_stereo",48],["high_quality",48],["high_quality_stereo",48]]).get(R),w}function C(R,w,k){R&&k>=Number.MIN_SAFE_INTEGER&&(R[w]=Math.round(k))}function A(R,w,k){if(R&&w&&R[k]>Number.MIN_SAFE_INTEGER&&w[k]>Number.MIN_SAFE_INTEGER&&R.timestamp&&w.timestamp){const I=(R[k]-w[k])/(R.timestamp-w.timestamp)*1e3;return Math.max(I,-1)}return NaN}e.GetStats=class{constructor(R){this.times=0,this.tmp={bytesSent:0,bytesReceived:0},this.chromeLegecy=s.getParameters().chromeLegacyDefault,this.resultMap=new Map,this.adapterRef=R.adapterRef,this.browser="chrome",this.audioLevel=[],this._reset(),this.formativeStatsReport=new n.FormativeStatsReport({adapterRef:this.adapterRef}),this.statsInfo={send:{firstStartAt:0,lastStartAt:0,totalCnt:0,frequency:0,errCnt:0,cpStats:null,statsMapHistory:{},logger:this.adapterRef.logger.getChild(()=>`getStats ${this.browser} send ${this.statsInfo.send.errCnt}/${this.statsInfo.send.totalCnt}`)},recv:{firstStartAt:0,lastStartAt:0,totalCnt:0,frequency:0,errCnt:0,cpStats:null,statsMapHistory:{},logger:this.adapterRef.logger.getChild(()=>`getStats ${this.browser} recv ${this.statsInfo.recv.errCnt}/${this.statsInfo.recv.totalCnt} `)}}}_reset(){this.times=0,this.browser="chrome",c.IS_CHROME_ONLY&&c.CHROME_MAJOR_VERSION&&c.CHROME_MAJOR_VERSION>=72||c.IS_ANDROID?this.browser="chrome":c.IS_ANY_SAFARI&&c.SAFARI_MAJOR_VERSION&&c.SAFARI_MAJOR_VERSION>=12||c.IS_ANY_SAFARI&&c.IS_WECHAT?this.browser="safari":c.IS_FIREFOX&&c.FIREFOX_MAJOR_VERSION&&c.FIREFOX_MAJOR_VERSION>=60&&(this.browser="firefox"),this.audioLevel=[],this.formativeStatsReport&&this.formativeStatsReport.destroy(),this.formativeStatsReport=null}markStatsStart(R){const w=this.statsInfo[R];w&&(w.lastStartAt=Date.now(),w.firstStartAt||(w.firstStartAt=w.lastStartAt),w.totalCnt+=1,w.frequency=Math.floor(w.totalCnt/(w.lastStartAt-w.firstStartAt)*6e4))}async getAllStats(){var R,w,k,I,M,P,S,y,_,b,E;this.tmp={bytesSent:0,bytesReceived:0},this.times=(this.times||0)+1;let x=null,D=null;try{let V=(I=(k=(w=(R=this==null?void 0:this.adapterRef)===null||R===void 0?void 0:R._mediasoup)===null||w===void 0?void 0:w._sendTransport)===null||k===void 0?void 0:k._handler)===null||I===void 0?void 0:I._pc;if(!V)return;x=await this.getLocalStats(V)}catch(V){this.statsInfo.send.errCnt++,this.statsInfo.send.errCnt<=s.getParameters().statsLogMaxCnt&&this.statsInfo.send.logger.warn("数据汇集出现异常: ",V.name,V.message,V.stack)}try{if(this.audioLevel.length=0,this.adapterRef.remoteAudioStats={},this.adapterRef.remoteAudioSlaveStats={},this.adapterRef.remoteVideoStats={},this.adapterRef.remoteScreenStats={},c.ANY_CHROME_MAJOR_VERSION&&c.ANY_CHROME_MAJOR_VERSION<69)(M=this.adapterRef._mediasoup)===null||M===void 0||M.consumerMap.forEach(async(V,N)=>{var L,U,H,j,W,Y,te,re;let G,K,de,B,$=(U=(L=V._recvTransportMainAudio)===null||L===void 0?void 0:L._handler)===null||U===void 0?void 0:U._pc;$&&(G=await this.getRemoteStatsPlanB($,"audio"));let z=(j=(H=V._recvTransportMainVideo)===null||H===void 0?void 0:H._handler)===null||j===void 0?void 0:j._pc;z&&(K=await this.getRemoteStatsPlanB(z,"video"));let ie=(Y=(W=V._recvTransportSubScreen)===null||W===void 0?void 0:W._handler)===null||Y===void 0?void 0:Y._pc;ie&&(de=await this.getRemoteStatsPlanB(ie,"screen"));let Z=(re=(te=V._recvTransportSubAudioSlave)===null||te===void 0?void 0:te._handler)===null||re===void 0?void 0:re._pc;Z&&(B=await this.getRemoteStatsPlanB(Z,"audioSlave")),m=G,g=K,O=B,v=de}),D={audio_ssrc:m?m.audio_ssrc:null,video_ssrc:g?g.video_ssrc:null,screen_ssrc:v?v.screen_ssrc:null,audioSlave_ssrc:O?O.audioSlave_ssrc:null};else{let V=(_=(y=(S=(P=this==null?void 0:this.adapterRef)===null||P===void 0?void 0:P._mediasoup)===null||S===void 0?void 0:S._recvTransport)===null||y===void 0?void 0:y._handler)===null||_===void 0?void 0:_._pc;if(!V)return;D=await this.getRemoteStats(V)}this.audioLevel.sort((F="level",function(V,N){var L=V[F],U=N[F];return U===0||U?L===0||L?U-L:1:-1})),this.audioLevel.length>0&&this.audioLevel[0].level>s.getParameters().activeSpeakerMin&&((b=this==null?void 0:this.adapterRef)===null||b===void 0||b.instance.safeEmit("active-speaker",this.audioLevel[0]),(E=this==null?void 0:this.adapterRef)===null||E===void 0||E.instance.safeEmit("volume-indicator",this.audioLevel))}catch(V){this.statsInfo.recv.errCnt++,this.statsInfo.recv.errCnt<=s.getParameters().statsLogMaxCnt&&this.statsInfo.recv.logger.warn("数据汇集出现异常: ",V.name,V.message,V.stack)}var F;return{local:x,remote:D,times:this.times}}async getLocalStats(R){return!R||/(failed|closed|new)/gi.test(R.iceConnectionState)?{}:await this[this.browser](R,"send")}async getRemoteStats(R){return!R||/(failed|closed|new)/gi.test(R.iceConnectionState)?{}:await this[this.browser](R,"recv")}async getRemoteStatsPlanB(R,w){return!R||/(failed|closed|new)/gi.test(R.iceConnectionState)?{}:await this.chrome69(R,"recv",w)}async chrome69(R,w,k){return await new Promise(I=>{R.getStats(M=>{this.markStatsStart(w),this.chromeLegecy="supported";let P={};M.result().forEach(function(S){const y={};S.names().forEach(function(_){y[_]=S.stat(_)}),y.id=S.id,y.type=S.type,y.timestamp=S.timestamp,P[y.id]=y}),R.lastStats=R.lastStats||{},P=this.formatChromeNonStandardStats(R,P,w,k),I(P)})})}async chrome(R,w){const k=this.chromeLegecy==="unsupported"?null:await new Promise(async P=>{try{this.markStatsStart(w),await R.getStats(S=>{this.chromeLegecy="supported";let y={};S.result().forEach(function(_){const b={};_.names().forEach(function(E){b[E]=_.stat(E)}),b.id=_.id,b.type=_.type,b.timestamp=_.timestamp,y[b.id]=b}),R.lastStats=R.lastStats||{},y=this.formatChromeNonStandardStats(R,y,w),P(y)})}catch(S){if(this.statsInfo[w].errCnt++,S.name==="TypeError"){if(this.chromeLegecy==="unknown"&&c.ANY_CHROME_MAJOR_VERSION&&c.ANY_CHROME_MAJOR_VERSION>=122)return this.statsInfo[w].logger.log(`getStats：当前浏览器不再支持非标准getStats ${S.name} ${S.message}`),this.chromeLegecy="unsupported",P(null);this.statsInfo[w].logger.warn(`getStats出现异常：${S.name}。fallback: 切换getStats方式 ${this.browser} => safari`,S.name,S.message),this.browser="safari"}else S.name==="NotSupportedError"?(this.statsInfo[w].logger.log(`getStats：当前浏览器不再支持非标准getStats ${S.name} ${S.message}`),this.chromeLegecy==="unknown"&&(this.chromeLegecy="unsupported"),P(null)):(this.statsInfo[w].errCnt<=s.getParameters().statsLogMaxCnt&&this.statsInfo[w].logger.warn(`getStats出现异常: ${S.name} ${S.message}`),P(null))}}),I=await(async()=>{if(!R.getTransceivers)return{};let P={audio_ssrc:[],audioSlave_ssrc:[],video_ssrc:[],screen_ssrc:[],bwe:[]};const S=R.getTransceivers();for(let y=0;y<S.length;y++){let _=null;const b=S[y];b.direction==="sendonly"?(b.sender&&b.sender.track&&b.sender.getStats&&(this.markStatsStart(w),_=await b.sender.getStats(),_=this.formatChromeStandardizedStats(_,w),_.video_ssrc&&P.video_ssrc?(P.video_ssrc.push(_.video_ssrc[0]),P.video_ssrc.length>1&&(P.video_ssrc[0]||{}).streamType==="low"&&([P.video_ssrc[0],P.video_ssrc[1]]=[P.video_ssrc[1],P.video_ssrc[0]])):_.screen_ssrc&&P.screen_ssrc?(P.screen_ssrc.push(_.screen_ssrc[0]),P.screen_ssrc.length>1&&(P.screen_ssrc[0]||{}).streamType==="low"&&([P.screen_ssrc[0],P.screen_ssrc[1]]=[P.screen_ssrc[1],P.screen_ssrc[0]])):Object.assign(P,_)),P.bwe.length===0&&this.statsInfo.send.cpStats&&P.bwe.push({googAvailableSendBandwidth:this.statsInfo.send.cpStats.availableOutgoingBitrate/1e3})):b.direction==="recvonly"&&b.receiver&&b.receiver.track&&b.receiver.getStats&&(this.markStatsStart(w),_=await b.receiver.getStats(),_=this.formatChromeStandardizedStats(_,w),_.audio_ssrc&&P.audio_ssrc?P.audio_ssrc.push(_.audio_ssrc[0]):_.audioSlave_ssrc&&P.audioSlave_ssrc?P.audioSlave_ssrc.push(_.audioSlave_ssrc[0]):_.video_ssrc&&P.video_ssrc?P.video_ssrc.push(_.video_ssrc[0]):_.screen_ssrc&&P.screen_ssrc?P.screen_ssrc.push(_.screen_ssrc[0]):Object.assign(P,_))}return P})(),M={};return k&&I?Object.keys(k).forEach(P=>{const S=k[P],y=I[P];if(M[P]=[],y)for(let _=0;_<S.length;_++)y[_]&&M[P].push(Object.assign(S[_],y[_]));else M[P]=S}):k?Object.assign(M,k):I&&Object.assign(M,I),s.getParameters().showStatsLog&&(w==="send"?this.statsInfo.send.logger.warn("getStats send",M):this.statsInfo.recv.logger.warn("getStats recv",M)),M}formatChromeNonStandardStats(R,w,k,I){const M=[],P=[],S=[],y=[],_=[],b={data:[]};Object.values(w).forEach(x=>{var D,F,V,N,L,U,H,j,W,Y,te,re,G,K,de,B,$,z,ie,Z,ee,ce,ae,ne,se,he,ue,J,X;if(x.id.includes("Conn-")&&x.googActiveConnection==="true"&&((D=this.formativeStatsReport)===null||D===void 0||D.formatTransportData(x,k)),x.id.includes("Cand-")&&x.networkType)this.adapterRef.transportStats.NetworkType=x.networkType||"";else if(x.id==="bweforvideo"&&k==="send")x=function(le){const ge={googAvailableSendBandwidth:1,googTargetEncBitrate:1,googActualEncBitrate:1,googRetransmitBitrate:1,googTransmitBitrate:1};return Object.keys(le).map(fe=>{ge[fe]&&(le[fe]=parseInt(le[fe])/1024)}),le}(x),this.adapterRef.transportStats.OutgoingAvailableBandwidth=x.googAvailableSendBandwidth,_.push({googActualEncBitrate:parseInt(x.googActualEncBitrate)||0,googAvailableSendBandwidth:parseInt(x.googAvailableSendBandwidth)||0,googRetransmitBitrate:parseInt(x.googRetransmitBitrate)||0,googAvailableReceiveBandwidth:parseInt(x.googAvailableReceiveBandwidth)||0,googTargetEncBitrate:parseInt(x.googTargetEncBitrate)||0,googTransmitBitrate:parseInt(x.googTransmitBitrate)||0,googBucketDelay:parseInt(x.googBucketDelay)||0});else if(/^ssrc_/i.test(x.id)){const le=(F=this==null?void 0:this.adapterRef)===null||F===void 0?void 0:F.instance.getUidAndKindBySsrc(parseInt(x.ssrc)),ge=le==null?void 0:le.uid,fe=le==null?void 0:le.streamType;let me="";me=le!=null&&le.kind?le.kind:x.googContentType==="screen"?"screen":x.mediaType;let Q={};if(k==="send"){if(x.mediaType==="audio"){x.audioInputLevel!==void 0&&(Q.audioInputLevel=parseInt(x.audioInputLevel)),Q.totalAudioEnergy=parseInt(x.totalAudioEnergy),Q.totalSamplesDuration=parseInt(x.totalSamplesDuration),Q.bytesSent=parseInt(x.bytesSent),Q.packetsSent=parseInt(x.packetsSent),Q.packetsLost=parseInt(x.packetsLost),Q.rtt=parseInt(x.googRtt),Q.jitterReceived=parseInt(x.googJitterReceived),x.googEchoCancellationReturnLoss!==void 0&&(Q.echoReturnLoss=""+x.googEchoCancellationReturnLoss),x.googEchoCancellationReturnLossEnhancement!==void 0&&(Q.echoReturnLossEnhancement=x.googEchoCancellationReturnLossEnhancement),(V=this.formativeStatsReport)===null||V===void 0||V.formatSendData(Q,me);const ye={CodecType:"Opus",rtt:Q.rtt||0,MuteState:((H=(U=(L=(N=this==null?void 0:this.adapterRef)===null||N===void 0?void 0:N.localStream)===null||L===void 0?void 0:L.muteStatus)===null||U===void 0?void 0:U.audio)===null||H===void 0?void 0:H.send)||!1,RecordingLevel:Q.audioInputLevel||0,SamplingRate:T((W=(j=this==null?void 0:this.adapterRef)===null||j===void 0?void 0:j.localStream)===null||W===void 0?void 0:W.audioProfile),SendBitrate:Q.bitsSentPerSecond||0,SendLevel:Q.audioInputLevel||0};me==="audio"?(M.push(Q),!((Y=R.audioSender)===null||Y===void 0)&&Y.track?this.adapterRef.localAudioStats[0]=ye:this.adapterRef.localAudioStats=[]):me==="audioSlave"&&(P.push(Q),!((te=R.audioSlaveSender)===null||te===void 0)&&te.track?this.adapterRef.localAudioSlaveStats[0]=ye:this.adapterRef.localAudioSlaveStats=[])}else if(x.mediaType==="video"){Q.bytesSent=parseInt(x.bytesSent),Q.packetsSent=parseInt(x.packetsSent),Q.packetsLost=parseInt(x.packetsLost),Q.firCount=parseInt(x.googFirsReceived),Q.pliCount=parseInt(x.googPlisReceived),Q.nackCount=parseInt(x.googNacksReceived),x.framesEncoded!==void 0&&(Q.framesEncoded=parseInt(x.framesEncoded)),Q.avgEncodeMs=parseInt(x.googAvgEncodeMs),Q.encodeUsagePercent=parseInt(x.googEncodeUsagePercent),Q.frameRateInput=parseInt(x.googFrameRateInput),Q.frameRateSent=parseInt(x.googFrameRateSent),Q.frameWidthInput=parseInt(x.googFrameWidthInput),Q.frameWidthSent=parseInt(x.googFrameWidthSent),Q.frameHeightInput=parseInt(x.googFrameHeightInput),Q.frameHeightSent=parseInt(x.googFrameHeightSent),x.hugeFramesSent!==void 0&&(Q.hugeFramesSent=parseInt(x.hugeFramesSent)),"qpSum"in x&&(Q.qpSum=parseInt(x.qpSum)),Q.qualityLimitationReason=function(_e){return _e.googBandwidthLimitedResolution?1:_e.googCpuLimitedResolution?2:_e.googHasEnteredLowResolution?3:0}(x),Q.qualityLimitationResolutionChanges=parseInt(x.googAdaptationChanges),Q.rtt=parseInt(x.googRtt),Q.streamType=fe,fe==="high"&&((re=this.formativeStatsReport)===null||re===void 0||re.formatSendData(Q,me));const ye={LayerType:1,CodecName:x.googCodecName||"h264",CodecImplementationName:x.codecImplementationName||"",CaptureFrameRate:Q.frameRateInput||0,CaptureResolutionHeight:Q.frameHeightInput||0,CaptureResolutionWidth:Q.frameWidthInput||0,EncodeDelay:Q.avgEncodeMs||0,MuteState:((de=(K=(G=this.adapterRef.localStream)===null||G===void 0?void 0:G.muteStatus)===null||K===void 0?void 0:K.video)===null||de===void 0?void 0:de.send)||!1,SendBitrate:Q.bitsSentPerSecond||0,SendFrameRate:Q.frameRateSent||0,SendResolutionHeight:Q.frameHeightSent||0,SendResolutionWidth:Q.frameWidthSent||0,TargetSendBitrate:Q.bitsSentPerSecond||0,TotalDuration:((B=this==null?void 0:this.adapterRef)===null||B===void 0?void 0:B.state.startPubVideoTime)!==void 0?(Date.now()-this.adapterRef.state.startPubVideoTime)/1e3:0,TotalFreezeTime:Q.totalFreezeTime||0};if(me==="video")if(S.push(Q),($=R.videoSender)===null||$===void 0?void 0:$.track){if(fe==="high"){const _e=this.adapterRef.localVideoStats[0];this.adapterRef.localVideoStats[0]=ye,b.data.push({mediaType:"video",streamType:"high",old:_e,new:ye})}}else b.data.push({mediaType:"video",streamType:"high",old:this.adapterRef.localVideoStats[0]||null,new:null}),this.adapterRef.localVideoStats=[];else if(me==="screen"){if(!((z=R.screenSender)===null||z===void 0)&&z.track){if(fe==="high"){ye.MuteState=((ee=(Z=(ie=this.adapterRef.localStream)===null||ie===void 0?void 0:ie.muteStatus)===null||Z===void 0?void 0:Z.screen)===null||ee===void 0?void 0:ee.send)||!1,ye.TotalDuration=((ce=this==null?void 0:this.adapterRef)===null||ce===void 0?void 0:ce.state.startPubScreenTime)!==void 0?(Date.now()-this.adapterRef.state.startPubScreenTime)/1e3:0,ye.LayerType=2;const _e=this.adapterRef.localScreenStats[0];this.adapterRef.localScreenStats[0]=ye,b.data.push({mediaType:"screen",streamType:"high",old:_e,new:ye})}}else b.data.push({mediaType:"screen",streamType:"high",old:this.adapterRef.localScreenStats[0]||null,new:null}),this.adapterRef.localScreenStats=[];y.push(Q)}}}else if(k==="recv"){if(!ge)return{};if((ae=this.formativeStatsReport)===null||ae===void 0||ae.clearFirstRecvData(ge),Q.remoteuid=ge,x.mediaType==="audio"){Q.audioOutputLevel=parseInt(x.audioOutputLevel),Q.totalAudioEnergy=parseInt(x.totalAudioEnergy),Q.totalSamplesDuration=parseInt(x.totalSamplesDuration),Q.bytesReceived=parseInt(x.bytesReceived),Q.packetsReceived=parseInt(x.packetsReceived),Q.packetsLost=parseInt(x.packetsLost),Q.decodingPLC=parseInt(x.googDecodingPLC),Q.decodingPLCCNG=parseInt(x.googDecodingPLCCNG),Q.decodingNormal=parseInt(x.googDecodingNormal),Q.decodingMuted=parseInt(x.googDecodingMuted),Q.decodingCNG=parseInt(x.googDecodingCNG),Q.decodingCTN=parseInt(x.googDecodingCTN),Q.currentDelayMs=parseInt(x.googCurrentDelayMs),Q.preferredJitterBufferMs=parseInt(x.googPreferredJitterBufferMs),Q.jitterBufferMs=parseInt(x.googJitterBufferMs),Q.jitter=parseInt(x.googJitterReceived),Q.preemptiveExpandRate=parseInt(x.googPreemptiveExpandRate),Q.speechExpandRate=parseInt(x.googAccelerateRate),Q.secondaryDecodedRate=parseInt(x.googSecondaryDecodedRate),Q.secondaryDiscardedRate=parseInt(x.googSecondaryDiscardedRate),(ne=this.formativeStatsReport)===null||ne===void 0||ne.formatRecvData(Q,me);const ye=(se=this==null?void 0:this.adapterRef)===null||se===void 0?void 0:se.remoteStreamMap[Q.remoteuid],_e=ye==null?void 0:ye.muteStatus[me],Oe=!!_e&&(_e.send||_e.recv),Me={CodecType:"Opus",End2EndDelay:(parseInt(x.googCurrentDelayMs)||0)+(parseInt(x.googJitterBufferMs)||0),MuteState:Oe,PacketLossRate:Q.packetsLostRate||0,RecvBitrate:Q.bitsReceivedPerSecond||0,RecvLevel:Q.audioOutputLevel||0,TotalFreezeTime:Q.totalFreezeTime||0,TotalPlayDuration:parseInt(x.totalSamplesDuration)||0,TransportDelay:parseInt(x.googCurrentDelayMs)||0};if(me==="audio"){if(Q.remoteuid&&(this.adapterRef.remoteAudioStats[Q.remoteuid]=Me),M.push(Q),c.ANY_CHROME_MAJOR_VERSION&&c.ANY_CHROME_MAJOR_VERSION<69&&I==="audio"){let Ee=M[0]&&M[0].remoteuid,be=u.findIndex(xe=>xe.remoteuid===Ee);be===-1?u.push(M[0]):u[be]=M[0]}}else if(me==="audioSlave"&&(Q.remoteuid&&(this.adapterRef.remoteAudioSlaveStats[Q.remoteuid]=Me),P.push(Q),c.ANY_CHROME_MAJOR_VERSION&&c.ANY_CHROME_MAJOR_VERSION<69&&I==="audioSlave")){let Ee=P[0]&&P[0].remoteuid,be=o.findIndex(xe=>xe.remoteuid===Ee);be===-1?o.push(P[0]):o[be]=P[0]}}else if(x.mediaType==="video"){Q.bytesReceived=parseInt(x.bytesReceived),Q.bitsReceivedPerSecond=0,Q.packetsReceived=parseInt(x.packetsReceived),Q.packetsLost=parseInt(x.packetsLost),Q.firCount=parseInt(x.googFirsSent),Q.pliCount=parseInt(x.googPlisSent),Q.nackCount=parseInt(x.googNacksSent),Q.framesDecoded=parseInt(x.framesDecoded),Q.decodeMs=parseInt(x.googDecodeMs),Q.frameRateDecoded=parseInt(x.googFrameRateDecoded),Q.frameRateOutput=parseInt(x.googFrameRateOutput),Q.frameRateReceived=parseInt(x.googFrameRateReceived),Q.frameWidthReceived=parseInt(x.googFrameWidthReceived),Q.frameHeightReceived=parseInt(x.googFrameHeightReceived),Q.currentDelayMs=parseInt(x.googCurrentDelayMs),x.googJitterBufferMs!==void 0&&(Q.jitterBufferDelay=parseInt(x.googJitterBufferMs)),(he=this.formativeStatsReport)===null||he===void 0||he.formatRecvData(Q,me);const ye=(ue=this==null?void 0:this.adapterRef)===null||ue===void 0?void 0:ue.remoteStreamMap[Q.remoteuid];let _e=ye&&ye.Play&&((J=ye==null?void 0:ye.Play)===null||J===void 0?void 0:J.video.dom),Oe=ye&&(ye.muteStatus.video.send||ye.muteStatus.video.recv)||!1;me==="screen"&&(_e=ye&&ye.Play&&((X=ye==null?void 0:ye.Play)===null||X===void 0?void 0:X.screen.dom),Oe=ye&&(ye.muteStatus.screen.send||ye.muteStatus.screen.recv)||!1);const Me={LayerType:1,CodecName:x.googCodecName,End2EndDelay:(parseInt(x.googCurrentDelayMs)||0)+(parseInt(x.googJitterBufferMs)||0)+(parseInt(x.googRenderDelayMs)||0),MuteState:Oe,PacketLossRate:Q.packetsLostRate||0,RecvBitrate:Q.bitsReceivedPerSecond||0,RecvResolutionHeight:Q.frameHeightReceived||0,RecvResolutionWidth:Q.frameWidthReceived||0,RenderFrameRate:Q.frameRateOutput||0,RenderResolutionHeight:_e?_e.videoHeight:0,RenderResolutionWidth:_e?_e.videoWidth:0,TotalFreezeTime:x.totalFreezeTime||0,TotalPlayDuration:_e&&_e.played&&_e.played.length?_e.played.end(0):0,TransportDelay:parseInt(x.googCurrentDelayMs)||0};if(me==="video"){if(this.adapterRef.remoteVideoStats[Q.remoteuid]=Me,S.push(Q),c.ANY_CHROME_MAJOR_VERSION&&c.ANY_CHROME_MAJOR_VERSION<69&&I==="video"){let Ee=S[0]&&S[0].remoteuid,be=h.findIndex(xe=>xe.remoteuid===Ee);be===-1?h.push(S[0]):h[be]=S[0]}}else if(me==="screen"&&(Me.LayerType=2,this.adapterRef.remoteScreenStats[Q.remoteuid]=Me,y.push(Q),c.ANY_CHROME_MAJOR_VERSION&&c.ANY_CHROME_MAJOR_VERSION<69&&I==="screen")){let Ee=y[0]&&y[0].remoteuid,be=f.findIndex(xe=>xe.remoteuid===Ee);be===-1?f.push(y[0]):f[be]=y[0]}}}}}),this.adapterRef.instance.safeEmit("@media-stats-change",b);const E={};return c.ANY_CHROME_MAJOR_VERSION&&c.ANY_CHROME_MAJOR_VERSION<69&&k==="recv"?I==="audio"?E.audio_ssrc=u:I==="video"?E.video_ssrc=h:I==="audioSlave"?E.audioSlave_ssrc=o:I==="screen"&&(E.screen_ssrc=f):(M.length&&(E.audio_ssrc=M),P.length&&(E.audioSlave_ssrc=P),S.length&&(S.length>1&&(S[0]||{}).streamType==="low"&&([S[0],S[1]]=[S[1],S[0]]),E.video_ssrc=S),y.length&&(y.length>1&&(y[0]||{}).streamType==="low"&&([y[0],y[1]]=[y[1],y[0]]),E.screen_ssrc=y),_.length&&(E.bwe=_)),E}formatChromeStandardizedStats(R,w){var k,I,M,P,S,y,_;const b=new d.FormativeStatsAudio,E=new d.FormativeStatsVideo;let x=0;R.forEach(N=>{var L;const U=this.statsInfo[w].statsMapHistory[N.id];let H=null;if(U){for(let W=U.length-1;W>=0;W--)H?U.splice(W,1):N.timestamp-U[W].timestamp>=s.getParameters().statsHistoryInterval&&(H=U[W]);U.length<10&&N.timestamp&&U.push(N)}else this.statsInfo[w].statsMapHistory[N.id]=[N];if(N.type=="media-source")N.kind==="audio"?(b.audioInputLevel=Math.round(32768*N.audioLevel),b.totalAudioEnergy=Math.round(32768*N.totalAudioEnergy),b.totalSamplesDuration=Math.round(N.totalSamplesDuration),N.echoReturnLoss&&(b.echoReturnLoss=""+N.echoReturnLoss),N.echoReturnLossEnhancement&&(b.echoReturnLossEnhancement=""+100*N.echoReturnLossEnhancement)):N.kind==="video"&&(E.frameRateInput=N.framesPerSecond,E.frameWidthInput=N.width,E.frameHeightInput=N.height);else if(N.type==="media-playout"){if(N.kind==="audio"&&H){const W=1e3*A(N,H,"totalPlayoutDelay")/A(N,H,"totalSamplesCount");b.playoutDelayMs=W}}else if(N.type=="outbound-rtp"){if(x=N.ssrc,N.kind==="audio"){if(C(b,"targetBitrate",N.targetBitrate/1e3),b.bytesSent=N.headerBytesSent+N.bytesSent,b.packetsSent=N.packetsSent,H&&w==="send"){const W=A(N,H,"bytesSent"),Y=A(N,H,"headerBytesSent");C(b,"bitsSentPerSecond",.008*(W+Y));const te=A(N,H,"packetsSent");C(b,"packetsSentPerSecond",te)}C(b,"nackCount",N.nackCount),"active"in N&&(b.active=N.active?1:0)}else if(N.kind==="video"){if("active"in N&&(E.active=N.active?1:0),E.bytesSent=N.headerBytesSent+N.bytesSent,E.firCount=N.firCount,E.nackCount=N.nackCount,E.pliCount=N.pliCount,C(E,"framesEncoded",N.framesEncoded),C(E,"framesSent",N.framesSent),C(E,"hugeFramesSent",N.hugeFramesSent),E.packetsSent=N.packetsSent,"qpSum"in N&&(E.qpSum=N.qpSum),H&&w==="send"){const W=A(N,H,"bytesSent"),Y=A(N,H,"headerBytesSent");C(E,"bitsSentPerSecond",.008*(W+Y));const te=A(N,H,"packetsSent");C(E,"packetsSentPerSecond",te);const re=A(N,H,"framesEncoded");C(E,"framesEncodedPerSecond",re);const G=A(N,H,"qpSum");C(E,"qpPercentage",G/re);const K=100*A(N,H,"totalEncodeTime");C(E,"encodeUsagePercent",K)}if(E.qualityLimitationReason=""+((j=N.qualityLimitationReason)==="bandwidth"?1:j==="cpu"?2:j==="other"?3:0),E.qualityLimitationResolutionChanges=N.qualityLimitationResolutionChanges,E.CodecImplementationName=N.encoderImplementation,C(E,"targetBitrate",N.targetBitrate/1e3),C(E,"frameRateSent",N.framesPerSecond),"frameWidth"in N&&(E.frameWidthSent=N.frameWidth),"frameHeight"in N&&(E.frameHeightSent=N.frameHeight),N.framesEncoded&&N.totalEncodeTime&&H){const W=1e3*(N.totalEncodeTime-H.totalEncodeTime)/(N.framesEncoded-H.framesEncoded);C(E,"avgEncodeMs",W)}}}else if(N.type=="remote-inbound-rtp"){if(N.kind==="audio"){if(C(b,"fractionLost",100*N.fractionLost),b.jitterReceived=Math.round(1e3*N.jitter),b.packetsLost=N.packetsLost,H&&w==="send"){const W=A(N,H,"packetsLost")/(b.packetsSentPerSecond||50)*100;C(b,"packetsLostRate",W)}C(b,"rtt",1e3*N.roundTripTime)}else if(N.kind==="video"){if(C(E,"fractionLost",100*N.fractionLost),E.jitter=Math.round(1e3*N.jitter),E.packetsLost=N.packetsLost,H&&w==="send"){const W=A(N,H,"packetsLost")/(E.packetsSentPerSecond||0)*100;C(E,"packetsLostRate",W)}C(E,"rtt",1e3*N.roundTripTime)}}else if(N.type=="inbound-rtp"){if(x=N.ssrc,N.kind==="audio"){if(C(b,"audioOutputLevel",32768*N.audioLevel),C(b,"totalAudioEnergy",32768*N.totalAudioEnergy),C(b,"totalSamplesDuration",N.totalSamplesReceived/48e3),b.bytesReceived=N.headerBytesReceived+N.bytesReceived,C(b,"concealedSamples",N.concealedSamples),C(b,"estimatedPlayoutTimestamp",N.estimatedPlayoutTimestamp-N.timestamp),C(b,"jitter",1e3*N.jitter),C(b,"jitterBufferDelay",1e3*N.jitterBufferDelay),H){const W=1e3*A(N,H,"removedSamplesForAcceleration")/A(N,H,"totalSamplesCount");C(b,"speechExpandRate",W);const Y=1e3*A(N,H,"insertedSamplesForDeceleration")/A(N,H,"totalSamplesCount");C(b,"preemptiveExpandRate",Y)}if(C(b,"preferredJitterBufferMs",1e3*N.jitterBufferTargetDelay/N.jitterBufferEmittedCount),C(b,"secondaryDecodedRate",N.fecPacketsReceived-N.fecPacketsDiscarded),C(b,"secondaryDiscardedRate",N.fecPacketsDiscarded),C(b,"lastPacketReceivedTimestamp",N.timestamp-N.lastPacketReceivedTimestamp),C(b,"nackCount",N.nackCount),C(b,"silentConcealedSamples",N.silentConcealedSamples),b.packetsLost=N.packetsLost,b.packetsReceived=N.packetsReceived,H&&w==="recv"){const W=.008*A(N,H,"bytesReceived");C(b,"bitsReceivedPerSecond",W);const Y=A(N,H,"packetsReceived");C(b,"packetsReceivedPerSecond",Y);const te=A(N,H,"packetsLost"),re=te/(Y+te||50)*100;re>=0?C(b,"packetsLostRate",re):b.packetsLostRate=0;const G=1e3*A(N,H,"jitterBufferDelay")/A(N,H,"jitterBufferEmittedCount");C(b,"jitterBufferMs",G)}}else if(N.kind==="video"){E.bytesReceived=N.bytesReceived+N.headerBytesReceived,C(E,"lastPacketReceivedTimestamp",N.timestamp-N.lastPacketReceivedTimestamp),C(E,"estimatedPlayoutTimestamp",N.estimatedPlayoutTimestamp-N.timestamp),E.firCount=N.firCount,E.nackCount=N.nackCount,E.pliCount=N.pliCount,E.framesDecoded=N.framesDecoded,C(E,"framesDropped",N.framesDropped),C(E,"framesReceived",N.framesReceived),E.packetsReceived=N.packetsReceived,E.packetsLost=N.packetsLost,C(E,"pauseCount",N.pauseCount),C(E,"totalPausesDuration",1e3*N.totalPausesDuration),C(E,"freezeCount",N.freezeCount),C(E,"totalFreezesDuration",1e3*N.totalFreezesDuration),C(E,"frameRateReceived",N.framesPerSecond),C(E,"frameWidthReceived",N.frameWidth),C(E,"frameHeightReceived",N.frameHeight);const W=N.decoderImplementation;if(E.powerEfficientDecoder=W==="OpenH264"?2:W?1:0,C(E,"jitterBufferDelay",1e3*N.jitterBufferDelay),H&&w==="recv"){const Y=.008*A(N,H,"bytesReceived");C(E,"bitsReceivedPerSecond",Y);const te=A(N,H,"packetsReceived");C(E,"packetsReceivedPerSecond",te);const re=A(N,H,"packetsLost"),G=re/(te+re)*100;G>=0&&C(E,"packetsLostRate",G);const K=1e3*A(N,H,"totalDecodeTime"),de=A(N,H,"framesDecoded");C(E,"decodeMs",K/de);const B=A(N,H,"framesDecoded");C(E,"frameRateDecoded",B);const $=A(N,H,"framesDropped");C(E,"frameRateOutput",B-$);const z=1e3*A(N,H,"jitterBufferDelay")/A(N,H,"jitterBufferEmittedCount");C(E,"jitterBufferMs",z)}}}else if(N.type=="remote-outbound-rtp")N.kind==="audio"?(N.jitter&&C(b,"jitter",1e3*N.jitter),N.roundTripTime&&C(b,"rtt",1e3*N.roundTripTime)):N.kind;else if(N.type=="track")w==="recv"&&N.kind==="audio"&&C(b,"audioOutputLevel",32768*N.audioLevel),N.kind==="audio"?"ended"in N&&(b.active=N.ended?0:1):N.kind==="video"&&"ended"in N&&(E.active=N.ended?0:1);else if(N.type==="candidate-pair")C(b,"rtt",1e3*N.currentRoundTripTime),C(E,"rtt",1e3*N.currentRoundTripTime),this.statsInfo[w].cpStats=N,(L=this.formativeStatsReport)===null||L===void 0||L.formatTransportDataChrome117(N,w);else if(N.type==="codec"&&N.mimeType){const[W,Y]=N.mimeType.split("/");W==="audio"?N.mimeType==="audio/opus"?b.CodecType="Opus":b.CodecType=Y:W==="video"?N.mimeType&&(E.CodecName=Y):(b.CodecType=N.mimeType,E.CodecName=N.mimeType)}var j});const D=(k=this==null?void 0:this.adapterRef)===null||k===void 0?void 0:k.instance.getUidAndKindBySsrc(x);if(!x||!D)return{};let F=D==null?void 0:D.kind;if(w==="recv"&&(F==="audio"||F==="audioSlave"?(b.jitterBufferMs&&C(b,"currentDelayMs",b.jitterBufferMs+(b.playoutDelayMs||0)),b.rtt&&(b.End2EndDelay=b.rtt+(b.jitterBufferMs||0))):F!=="video"&&F!=="screen"||(E.jitterBufferMs&&C(E,"currentDelayMs",E.jitterBufferMs),E.rtt&&(E.End2EndDelay=E.rtt+(E.jitterBufferMs||0)))),w==="send"){const N=this.adapterRef.localStream;if(F==="video"||F==="screen"){if(E.streamType=(D==null?void 0:D.streamType)||"high",this.chromeLegecy!=="supported"&&E.streamType==="high"){(I=this.formativeStatsReport)===null||I===void 0||I.formatSendData(E,F),E.LayerType=F==="video"?1:2,E.CaptureFrameRate=E.frameRateInput,E.CaptureResolutionHeight=E.frameHeightInput,E.CaptureResolutionWidth=E.frameWidthInput,E.EncodeDelay=E.avgEncodeMs,N&&(E.MuteState=N.getMuteStatus(F).muted),E.SendBitrate=E.bitsSentPerSecond,E.SendFrameRate=E.frameRateSent,E.SendResolutionHeight=E.frameHeightSent,E.SendResolutionWidth=E.frameWidthSent,E.TargetSendBitrate=E.targetBitrate,E.TotalFreezeTime=E.totalFreezeTime,F==="video"&&this.adapterRef.state.startPubVideoTime&&(E.TotalDuration=(Date.now()-this.adapterRef.state.startPubVideoTime)/1e3),F==="screen"&&this.adapterRef.state.startPubScreenTime&&(E.TotalDuration=(Date.now()-this.adapterRef.state.startPubScreenTime)/1e3);const L={LayerType:E.LayerType,CodecName:E.CodecName,CodecImplementationName:E.CodecImplementationName,CaptureFrameRate:E.CaptureFrameRate,CaptureResolutionHeight:E.CaptureResolutionHeight,CaptureResolutionWidth:E.CaptureResolutionWidth,EncodeDelay:E.EncodeDelay,MuteState:E.MuteState,SendBitrate:E.SendBitrate,SendFrameRate:E.SendFrameRate,SendResolutionHeight:E.SendResolutionHeight,SendResolutionWidth:E.SendResolutionWidth,TargetSendBitrate:E.TargetSendBitrate,TotalDuration:E.TotalDuration,TotalFreezeTime:E.TotalFreezeTime},U=F==="video"?this.adapterRef.localVideoStats:this.adapterRef.localScreenStats;E.streamType==="high"?U[0]=L:U[1]=L}}else if((F==="audio"||F==="audioSlave")&&this.chromeLegecy!=="supported"){(M=this.formativeStatsReport)===null||M===void 0||M.formatSendData(b,F),N&&(b.MuteState=N.getMuteStatus(F).muted,F==="audio"&&N.audioLevelHelper?b.RecordingLevel=Math.round(32768*N.audioLevelHelper.volume):F==="audioSlave"&&N.audioLevelHelperSlave?b.RecordingLevel=Math.round(32768*N.audioLevelHelperSlave.volume):b.RecordingLevel=b.audioInputLevel,b.SamplingRate=T(N.audioProfile),b.SendBitrate=b.bitsSentPerSecond,b.SendLevel=b.audioInputLevel);const L={CodecType:b.CodecType,rtt:b.rtt,MuteState:b.MuteState,RecordingLevel:b.RecordingLevel,SamplingRate:b.SamplingRate,SendBitrate:b.SendBitrate,SendLevel:b.SendLevel};F==="audio"?this.adapterRef.localAudioStats[0]=L:F==="audioSlave"&&(this.adapterRef.localAudioSlaveStats[0]=L)}}const V={};if(w==="recv"){const N=D!=null&&D.uid?this.adapterRef.remoteStreamMap[D==null?void 0:D.uid]:null;if(F==="video"||F==="screen"){E.remoteuid=""+(D==null?void 0:D.uid);const L=(P=N==null?void 0:N._play[F])===null||P===void 0?void 0:P.dom;if(this.chromeLegecy!=="supported"){(S=this.formativeStatsReport)===null||S===void 0||S.formatRecvData(E,F),E.LayerType=F==="video"?1:2,N&&(E.MuteState=N.getMuteStatus(F).muted),E.PacketLossRate=E.packetsLostRate,E.RecvBitrate=E.bitsReceivedPerSecond,E.RecvResolutionHeight=E.frameHeightReceived,E.RecvResolutionWidth=E.frameWidthReceived,E.RenderFrameRate=E.frameRateReceived,L&&(E.RenderResolutionHeight=L.videoHeight,E.RenderResolutionWidth=L.videoWidth,!((y=L.played)===null||y===void 0)&&y.length&&L.played.end&&(E.TotalPlayDuration=L.played.end(0))),E.TotalFreezeTime=E.totalFreezeTime,E.TransportDelay=E.rtt;const U={LayerType:E.LayerType,CodecName:E.CodecName,End2EndDelay:E.End2EndDelay,MuteState:E.MuteState,PacketLossRate:E.PacketLossRate,RecvBitrate:E.RecvBitrate,RecvResolutionHeight:E.RecvResolutionHeight,RecvResolutionWidth:E.RecvResolutionWidth,RenderFrameRate:E.RenderFrameRate,RenderResolutionHeight:E.RenderResolutionHeight,RenderResolutionWidth:E.RenderResolutionWidth,TotalFreezeTime:E.TotalFreezeTime,TotalPlayDuration:E.TotalPlayDuration,TransportDelay:E.TransportDelay};F==="video"?this.adapterRef.remoteVideoStats[E.remoteuid]=U:this.adapterRef.remoteScreenStats[E.remoteuid]=U}}else if(F==="audio"||F==="audioSlave"){if(b.remoteuid=""+(D==null?void 0:D.uid),this.chromeLegecy!=="supported"){(_=this.formativeStatsReport)===null||_===void 0||_.formatRecvData(b,F),N&&(b.MuteState=N.getMuteStatus(F).muted),b.PacketLossRate=b.packetsLostRate,b.RecvBitrate=b.bitsReceivedPerSecond,b.RecvLevel=b.audioOutputLevel,b.TotalFreezeTime=b.totalFreezeTime,b.TotalPlayDuration=b.totalSamplesDuration,b.TransportDelay=b.rtt;const L={CodecType:b.CodecType,End2EndDelay:b.End2EndDelay,MuteState:b.MuteState,PacketLossRate:b.PacketLossRate,RecvBitrate:b.RecvBitrate,RecvLevel:b.RecvLevel,TotalFreezeTime:b.TotalFreezeTime,TotalPlayDuration:b.TotalPlayDuration,TransportDelay:b.TransportDelay};F==="audio"?this.adapterRef.remoteAudioStats[b.remoteuid]=L:F==="audioSlave"&&(this.adapterRef.remoteAudioSlaveStats[b.remoteuid]=L)}if(b.audioOutputLevel){const L=F&&(N==null?void 0:N.isPlaying(F))||!1;this.audioLevel.push({uid:b.remoteuid,level:L&&+b.audioOutputLevel||0,type:F})}}}return F!=null&&F.includes("audio")?V[F+"_ssrc"]=[b]:F!=="video"&&F!=="screen"||(V[F+"_ssrc"]=[E]),V}async safari(R,w){var k,I;if(!R.getTransceivers)return{};let M={audio_ssrc:[],audioSlave_ssrc:[],video_ssrc:[],screen_ssrc:[]};const P=R.getTransceivers();for(let S=0;S<P.length;S++){let y=null;const _=P[S];_.direction==="sendonly"?_.sender&&_.sender.getStats&&(this.markStatsStart(w),y=await _.sender.getStats(),y=this.formatSafariStandardizedStats(y,w,((k=_.sender.track)===null||k===void 0?void 0:k.kind)||""),y.video_ssrc&&M.video_ssrc?(M.video_ssrc.push(y.video_ssrc[0]),M.video_ssrc.length>1&&(M.video_ssrc[0]||{}).streamType==="low"&&([M.video_ssrc[0],M.video_ssrc[1]]=[M.video_ssrc[1],M.video_ssrc[0]])):y.screen_ssrc&&M.screen_ssrc?(M.screen_ssrc.push(y.screen_ssrc[0]),M.screen_ssrc.length>1&&(M.screen_ssrc[0]||{}).streamType==="low"&&([M.screen_ssrc[0],M.screen_ssrc[1]]=[M.screen_ssrc[1],M.screen_ssrc[0]])):Object.assign(M,y)):_.direction==="recvonly"&&_.receiver&&_.receiver.getStats&&(this.markStatsStart(w),y=await _.receiver.getStats(),y=this.formatSafariStandardizedStats(y,w,((I=_.receiver.track)===null||I===void 0?void 0:I.kind)||""),y.audio_ssrc&&M.audio_ssrc?M.audio_ssrc.push(y.audio_ssrc[0]):y.audioSlave_ssrc&&M.audioSlave_ssrc?M.audioSlave_ssrc.push(y.audioSlave_ssrc[0]):y.video_ssrc&&M.video_ssrc?M.video_ssrc.push(y.video_ssrc[0]):y.screen_ssrc&&M.screen_ssrc?M.screen_ssrc.push(y.screen_ssrc[0]):Object.assign(M,y))}return M}formatSafariStandardizedStats(R,w,k){var I,M,P,S,y,_,b;const E={},x={};let D=0;R.forEach(L=>{L.type=="track"?L.kind==="audio"||k==="audio"?("ended"in L&&(E.active=L.ended?0:1),L.audioLevel!==void 0&&(E.audioOutputLevel=Math.round(32768*L.audioLevel))):L.kind!=="video"&&k!=="video"||("ended"in L&&(x.active=L.ended?0:1),w==="send"?(x.frameWidthInput=L.width||L.frameWidth,x.frameHeightInput=L.height||L.frameHeight,L.framesSent!==void 0&&(x.framesSent=L.framesSent)):w==="recv"&&(x.frameWidthReceived=L.width||L.frameWidth,x.frameHeightReceived=L.height||L.frameHeight,L.framesDecoded!==void 0&&(x.framesDecoded=L.framesDecoded),L.framesReceived!==void 0&&(x.framesReceived=L.framesReceived),L.framesDropped!==void 0&&(x.framesDropped=L.framesDropped))):L.type=="outbound-rtp"?(D=L.ssrc,L.kind==="audio"||L.mediaType==="audio"||k==="audio"?(E.bytesSent=(L.headerBytesSent||0)+L.bytesSent,E.packetsSent=L.packetsSent,L.nackCount!==void 0&&(E.nackCount=L.nackCount),"active"in L&&(E.active=L.active)):L.kind!=="video"&&L.mediaType!=="video"&&k!=="video"||("active"in L&&(x.active=L.active),x.bytesSent=(L.headerBytesSent||0)+L.bytesSent,x.firCount=L.firCount,x.nackCount=L.nackCount,x.pliCount=L.pliCount,x.framesEncoded=L.framesEncoded,L.hugeFramesSent!==void 0&&(x.hugeFramesSent=L.hugeFramesSent),x.packetsSent=L.packetsSent,"qpSum"in L&&(x.qpSum=L.qpSum),L.qualityLimitationResolutionChanges!==void 0&&(x.qualityLimitationResolutionChanges=L.qualityLimitationResolutionChanges),L.totalEncodeTime!==void 0&&(x.avgEncodeMs=Math.round(1e3*L.totalEncodeTime/L.framesEncoded)),L.framesPerSecond!==void 0&&(x.frameRateSent=L.framesPerSecond),L.frameWidth!==void 0&&(x.frameWidthSent=L.frameWidth),L.frameHeight!==void 0&&(x.frameHeightSent=L.frameHeight),c.IS_ANY_SAFARI&&c.SAFARI_MAJOR_VERSION&&c.SAFARI_MAJOR_VERSION>=17&&(x.frameWidthInput=L.frameWidth,x.frameHeightInput=L.frameHeight,L.framesSent!==void 0&&(x.framesSent=L.framesSent)))):L.type=="remote-inbound-rtp"?L.kind==="audio"?(L.jitter!==void 0&&(E.jitterReceived=Math.round(1e3*L.jitter)),L.packetsLost!==void 0&&(E.packetsLost=L.packetsLost),E.rtt=Math.round(1e3*L.roundTripTime)):L.kind==="video"&&(L.jitter!==void 0&&(x.jitter=Math.round(1e3*L.jitter)),L.packetsLost!==void 0&&(x.packetsLost=L.packetsLost),x.rtt=Math.round(1e3*L.roundTripTime)):L.type=="inbound-rtp"?(D=L.ssrc,L.kind==="audio"||L.mediaType==="audio"||k==="audio"?(L.audioLevel!==void 0&&(E.audioOutputLevel=Math.round(32768*L.audioLevel)),L.totalAudioEnergy!==void 0&&(E.totalAudioEnergy=Math.round(32768*L.totalAudioEnergy)),L.totalSamplesReceived!==void 0&&(E.totalSamplesDuration=Math.round(L.totalSamplesReceived/48e3)),E.bytesReceived=(L.headerBytesReceived||0)+L.bytesReceived,L.concealedSamples!==void 0&&(E.concealedSamples=L.concealedSamples),L.estimatedPlayoutTimestamp!==void 0&&(E.estimatedPlayoutTimestamp=L.estimatedPlayoutTimestamp),L.jitter!==void 0&&(E.jitter=Math.round(1e3*L.jitter)),L.jitterBufferDelay!==void 0&&(E.jitterBufferDelay=Math.round(1e3*L.jitterBufferDelay/L.jitterBufferEmittedCount)),L.lastPacketReceivedTimestamp!==void 0&&(E.lastPacketReceivedTimestamp=L.lastPacketReceivedTimestamp),L.nackCount!==void 0&&(E.nackCount=L.nackCount),L.silentConcealedSamples!==void 0&&(E.silentConcealedSamples=L.silentConcealedSamples),E.packetsLost=L.packetsLost,E.packetsReceived=L.packetsReceived,L.jitter!==void 0&&(E.jitter=Math.round(1e3*L.jitter))):L.kind!=="video"&&L.mediaType!=="video"&&k!=="video"||(x.bytesReceived=L.bytesReceived+(L.headerBytesReceived||0),L.estimatedPlayoutTimestamp!==void 0&&(x.estimatedPlayoutTimestamp=L.estimatedPlayoutTimestamp),L.lastPacketReceivedTimestamp!==void 0&&(x.lastPacketReceivedTimestamp=L.lastPacketReceivedTimestamp),x.firCount=L.firCount,x.nackCount=L.nackCount,x.pliCount=L.pliCount,L.framesDecoded!==void 0&&(x.framesDecoded=L.framesDecoded),L.framesDropped!==void 0&&(x.framesDropped=L.framesDropped),L.framesReceived!==void 0&&(x.framesReceived=L.framesReceived),x.packetsReceived=L.packetsReceived,x.packetsLost=L.packetsLost,L.framesPerSecond!==void 0&&(x.frameRateReceived=L.framesPerSecond),L.frameWidth!==void 0&&(x.frameWidthReceived=L.frameWidth),L.frameHeight!==void 0&&(x.frameHeightReceived=L.frameHeight),L.jitter!==void 0&&(x.jitter=Math.round(1e3*L.jitter)),L.jitterBufferDelay!==void 0&&(x.jitterBufferDelay=Math.round(1e3*L.jitterBufferDelay/L.jitterBufferEmittedCount)),c.IS_ANY_SAFARI&&c.SAFARI_MAJOR_VERSION&&c.SAFARI_MAJOR_VERSION>=17&&(x.frameWidthReceived=L.frameWidth,x.frameHeightReceived=L.frameHeight,L.framesDecoded!==void 0&&(x.framesDecoded=L.framesDecoded),L.framesReceived!==void 0&&(x.framesReceived=L.framesReceived),L.framesDropped!==void 0&&(x.framesDropped=L.framesDropped)))):L.type=="remote-outbound-rtp"?L.kind==="audio"?(L.jitter!==void 0&&(E.jitter=Math.round(1e3*L.jitter)),L.roundTripTime!==void 0&&(E.rtt=Math.round(1e3*L.roundTripTime))):L.kind:L.type=="media-source"&&(w!=="send"||L.kind!=="audio"&&k!=="audio"||(L.audioLevel!==void 0&&(E.audioOutputLevel=Math.round(32768*L.audioLevel)),L.totalAudioEnergy!==void 0&&(E.totalAudioEnergy=Math.round(32768*L.totalAudioEnergy)),L.totalSamplesDuration!==void 0&&(E.totalSamplesDuration=Math.round(L.totalSamplesDuration))))});const F=(I=this==null?void 0:this.adapterRef)===null||I===void 0?void 0:I.instance.getUidAndKindBySsrc(D);let V=F==null?void 0:F.kind;JSON.stringify(x)!=="{}"&&w==="send"&&(x.streamType=(F==null?void 0:F.streamType)||"high");const N={};if(w==="recv"){if((M=this.formativeStatsReport)===null||M===void 0||M.clearFirstRecvData(F==null?void 0:F.uid),JSON.stringify(x)!=="{}")x.remoteuid=F==null?void 0:F.uid,(P=this.formativeStatsReport)===null||P===void 0||P.formatRecvData(x,V);else if(JSON.stringify(E)!=="{}"&&(E.remoteuid=F==null?void 0:F.uid,(S=this.formativeStatsReport)===null||S===void 0||S.formatRecvData(E,V),E.audioOutputLevel)){const L=(y=this==null?void 0:this.adapterRef)===null||y===void 0?void 0:y.remoteStreamMap[E.remoteuid],U=V&&(L==null?void 0:L.isPlaying(V))||!1;this.audioLevel.push({uid:E.remoteuid,level:U&&+E.audioOutputLevel||0,type:V})}}return V!=null&&V.includes("audio")?(w==="send"&&((_=this.formativeStatsReport)===null||_===void 0||_.formatSendData(E,V)),c.IS_ANY_SAFARI&&c.SAFARI_MAJOR_VERSION&&c.SAFARI_MAJOR_VERSION<17?typeof E.active=="number"&&(N[V+"_ssrc"]=[E]):w==="send"?typeof E.bitsSentPerSecond=="number"&&typeof E.packetsSentPerSecond=="number"&&(N[V+"_ssrc"]=[E]):N[V+"_ssrc"]=[E]):V!=="video"&&V!=="screen"||((F==null?void 0:F.streamType)==="high"&&w==="send"&&((b=this.formativeStatsReport)===null||b===void 0||b.formatSendData(x,V)),c.IS_ANY_SAFARI&&c.SAFARI_MAJOR_VERSION&&c.SAFARI_MAJOR_VERSION<17?typeof x.active=="number"&&(N[V+"_ssrc"]=[x]):w==="send"?x.frameWidthInput&&typeof x.frameWidthInput=="number"&&x.frameHeightInput&&typeof x.frameHeightInput=="number"&&(N[V+"_ssrc"]=[x]):N[V+"_ssrc"]=[x]),N}async firefox(R,w){if(!R.getTransceivers)return{};let k={audio_ssrc:[],audioSlave_ssrc:[],video_ssrc:[],screen_ssrc:[]};const I=R.getTransceivers();for(let M=0;M<I.length;M++){let P=null;const S=I[M];S.direction==="sendonly"?S.sender&&S.sender.getStats&&(this.markStatsStart(w),P=await S.sender.getStats(),P=this.formatFirefoxStandardizedStats(P,w),Object.assign(k,P)):S.direction==="recvonly"&&S.receiver&&S.receiver.getStats&&(this.markStatsStart(w),P=await S.receiver.getStats(),P=this.formatFirefoxStandardizedStats(P,w),P.audio_ssrc&&k.audio_ssrc?k.audio_ssrc.push(P.audio_ssrc[0]):P.audioSlave_ssrc&&k.audioSlave_ssrc?k.audioSlave_ssrc.push(P.audioSlave_ssrc[0]):P.video_ssrc&&k.video_ssrc?k.video_ssrc.push(P.video_ssrc[0]):P.screen_ssrc&&k.screen_ssrc?k.screen_ssrc.push(P.screen_ssrc[0]):Object.assign(k,P))}return k}formatFirefoxStandardizedStats(R,w){var k,I,M,P,S,y,_;const b={},E={};let x=0;R.forEach(N=>{N.type=="outbound-rtp"?(x=N.ssrc,N.kind==="audio"?(b.bytesSent=(N.headerBytesSent||0)+N.bytesSent,b.packetsSent=N.packetsSent,b.nackCount=N.nackCount):N.kind==="video"&&(E.bytesSent=(N.headerBytesSent||0)+N.bytesSent,E.firCount=N.firCount,E.nackCount=N.nackCount,E.pliCount=N.pliCount,N.hugeFramesSent!==void 0&&(E.hugeFramesSent=N.hugeFramesSent),E.packetsSent=N.packetsSent,"qpSum"in N&&(E.qpSum=N.qpSum),N.framesEncoded!==void 0&&(E.framesEncoded=N.framesEncoded),N.framesSent!==void 0&&(E.framesSent=N.framesSent),N.totalEncodeTime!==void 0&&N.framesEncoded!==void 0&&(E.avgEncodeMs=Math.round(1e3*N.totalEncodeTime/N.framesEncoded)),N.framesPerSecond!==void 0&&(E.frameRateSent=N.framesPerSecond),N.frameWidth!==void 0&&(E.frameWidthSent=N.frameWidth),N.frameHeight!==void 0&&(E.frameHeightSent=N.frameHeight))):N.type=="remote-inbound-rtp"?N.kind==="video"&&(E.fractionLost=N.fractionLost,E.jitter=Math.round(1e3*N.jitter),E.packetsLost=N.packetsLost,E.rtt=Math.round(1e3*N.roundTripTime)):N.type=="inbound-rtp"&&(x=N.ssrc,N.kind==="audio"?(N.audioLevel!==void 0&&(b.audioOutputLevel=Math.round(32768*N.audioLevel)),N.insertedSamplesForDeceleration!==void 0&&(b.preemptiveExpandRate=parseInt(N.insertedSamplesForDeceleration)),N.removedSamplesForAcceleration!==void 0&&(b.speechExpandRate=parseInt(N.removedSamplesForAcceleration)),b.bytesReceived=N.bytesReceived+(N.headerBytesReceived||0),b.concealedSamples=N.concealedSamples,b.jitter=Math.round(1e3*N.jitter),b.jitterBufferDelay=Math.round(1e3*N.jitterBufferDelay/N.jitterBufferEmittedCount),b.silentConcealedSamples=N.silentConcealedSamples,b.packetsLost=N.packetsLost,b.packetsReceived=N.packetsReceived,N.totalSamplesReceived!==void 0&&(b.totalSamplesDuration=Math.round(N.totalSamplesReceived/48e3)),N.totalAudioEnergy!==void 0&&(b.totalAudioEnergy=Math.round(32768*N.totalAudioEnergy)),N.totalSamplesReceived!==void 0&&(b.totalSamplesDuration=Math.round(N.totalSamplesReceived/48e3))):N.kind==="video"&&(E.bytesReceived=N.bytesReceived+(N.headerBytesReceived||0),E.firCount=N.firCount,E.nackCount=N.nackCount,E.pliCount=N.pliCount,E.framesDecoded=N.framesDecoded,E.framesDropped=N.framesReceived-N.framesDecoded,E.framesReceived=N.framesReceived,E.packetsReceived=N.packetsReceived,E.packetsLost=N.packetsLost,E.frameRateReceived=N.framesPerSecond||0,E.frameWidthReceived=N.frameWidth,E.frameHeightReceived=N.frameHeight,E.jitterBufferDelay=Math.round(1e3*N.jitterBufferDelay/N.jitterBufferEmittedCount),N.estimatedPlayoutTimestamp!==void 0&&(E.estimatedPlayoutTimestamp=N.estimatedPlayoutTimestamp),N.lastPacketReceivedTimestamp!==void 0&&(E.lastPacketReceivedTimestamp=N.lastPacketReceivedTimestamp)))});const D=(k=this==null?void 0:this.adapterRef)===null||k===void 0?void 0:k.instance.getUidAndKindBySsrc(x);let F=D==null?void 0:D.kind;JSON.stringify(E)!=="{}"&&w==="send"&&(E.streamType=(D==null?void 0:D.streamType)||"high");const V={};if(w==="recv"){if((I=this.formativeStatsReport)===null||I===void 0||I.clearFirstRecvData(D==null?void 0:D.uid),JSON.stringify(E)!=="{}")E.remoteuid=D==null?void 0:D.uid,(M=this.formativeStatsReport)===null||M===void 0||M.formatRecvData(E,F);else if(JSON.stringify(b)!=="{}"&&(b.remoteuid=D==null?void 0:D.uid,(P=this.formativeStatsReport)===null||P===void 0||P.formatRecvData(b,F),b.audioOutputLevel)){const N=(S=this==null?void 0:this.adapterRef)===null||S===void 0?void 0:S.remoteStreamMap[b.remoteuid],L=F&&(N==null?void 0:N.isPlaying(F))||!1;this.audioLevel.push({uid:b.remoteuid,level:L&&+b.audioOutputLevel||0,type:F})}}return F!=null&&F.includes("audio")?(w==="send"&&((y=this.formativeStatsReport)===null||y===void 0||y.formatSendData(b,F)),V[F+"_ssrc"]=[b]):F!=="video"&&F!=="screen"||((D==null?void 0:D.streamType)==="high"&&w==="send"&&((_=this.formativeStatsReport)===null||_===void 0||_.formatSendData(E,F)),V[F+"_ssrc"]=[E]),V}stop(){this._reset()}destroy(){this._reset()}}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.FormativeStatsReport=void 0,e.FormativeStatsReport=class{constructor(i){this.adapterRef=i.adapterRef,this.firstData={recvFirstData:{},sendFirstAudioPackage:!1,sendFirstVideoPackage:!1,sendFirstScreenPackage:!1},this.statsCatch={upAudioCache:{},upAudioSlaveCache:{},upVideoCache:{},upScreenCache:{},downAudioCache:{},downAudioSlaveCache:{},downVideoCache:{},downScreenCache:{},upTransportCache:{},downTransportCache:{},upCandidatePairStatsCache:{},downCandidatePairStatsCache:{}}}_reset(){this.firstData={recvFirstData:{},sendFirstAudioPackage:!1,sendFirstVideoPackage:!1,sendFirstScreenPackage:!1},this.statsCatch={upAudioCache:{},upAudioSlaveCache:{},upVideoCache:{},upScreenCache:{},downAudioCache:{},downAudioSlaveCache:{},downVideoCache:{},downScreenCache:{},upTransportCache:{},downTransportCache:{},upCandidatePairStatsCache:{},downCandidatePairStatsCache:{}}}clearFirstRecvData(i){const a=this.adapterRef.remoteStreamMap[i],l=this.firstData.recvFirstData[i];a&&l&&(a.pubStatus.audio.consumerId===""&&(l.recvFirstAudioFrame=l.recvFirstAudioPackage=!1,this.statsCatch.downAudioCache[i]=null),a.pubStatus.audioSlave.consumerId===""&&(this.statsCatch.downAudioSlaveCache[i]=null),a.pubStatus.video.consumerId===""&&(l.recvFirstVideoFrame=l.recvFirstVideoPackage=!1,this.statsCatch.downVideoCache[i]=null),a.pubStatus.screen.consumerId===""&&(l.recvFirstScreenFrame=l.recvFirstScreenPackage=!1,this.statsCatch.downScreenCache[i]=null))}formatTransportData(i,a){let l;a==="send"?(this.adapterRef.transportStats.rxRtt=i.googRtt-0,this.adapterRef.transportStats.txRtt=i.googRtt-0,this.adapterRef.sessionStats.SendBytes=i.bytesSent-0,this.statsCatch.upTransportCache&&(l=this.statsCatch.upTransportCache),this.statsCatch.upTransportCache=i,l&&(this.adapterRef.sessionStats.SendBitrate=Math.round(8*(i.bytesSent-l.bytesSent)/1e3))):(this.adapterRef.sessionStats.RecvBytes=i.bytesReceived-0,this.statsCatch.downTransportCache&&(l=this.statsCatch.downTransportCache),this.statsCatch.downTransportCache=i,l&&(this.adapterRef.sessionStats.RecvBitrate=Math.round(8*(i.bytesReceived-l.bytesReceived)/1e3)))}formatTransportDataChrome117(i,a){var l,n;if(a==="send"){const c=this.statsCatch.upCandidatePairStatsCache;if(c&&c.timestamp&&i.timestamp-c.timestamp<900)return;this.adapterRef.transportStats.txRtt=Math.round(1e3*i.currentRoundTripTime);const s=(l=this.statsCatch.downCandidatePairStatsCache)===null||l===void 0?void 0:l.timestamp;(!s||i.timestamp-s>2e3)&&(this.adapterRef.transportStats.rxRtt=this.adapterRef.transportStats.txRtt),this.adapterRef.sessionStats.SendBytes=i.bytesSent,this.adapterRef.transportStats.OutgoingAvailableBandwidth=i.availableOutgoingBitrate/1e3,this.statsCatch.upCandidatePairStatsCache=i,c&&c.timestamp&&(this.adapterRef.sessionStats.SendBitrate=Math.round(8*(i.bytesSent-(c.bytesSent||0))/1e3))}else{const c=this.statsCatch.downCandidatePairStatsCache;if(c&&c.timestamp&&i.timestamp-c.timestamp<900)return;this.adapterRef.transportStats.rxRtt=Math.round(1e3*i.currentRoundTripTime),this.adapterRef.transportStats.txRtt<1&&(this.adapterRef.transportStats.txRtt=this.adapterRef.transportStats.rxRtt);const s=(n=this.statsCatch.upCandidatePairStatsCache)===null||n===void 0?void 0:n.timestamp;(!s||i.timestamp-s>2e3)&&(this.adapterRef.transportStats.txRtt=this.adapterRef.transportStats.rxRtt),this.adapterRef.sessionStats.RecvBytes=i.bytesReceived,this.statsCatch.downCandidatePairStatsCache=i,c&&c.timestamp&&(this.adapterRef.sessionStats.RecvBitrate=Math.round(8*(i.bytesReceived-(c.bytesReceived||0))/1e3))}}formatSendData(i,a){var l,n,c,s,d,u,h,o;let f;if(a==="audio"){if(!(!((n=(l=this==null?void 0:this.adapterRef)===null||l===void 0?void 0:l._mediasoup)===null||n===void 0)&&n._micProducer))return this.firstData.sendFirstAudioPackage=!1,void(this.statsCatch.upAudioCache={});i.packetsSent>0&&!this.firstData.sendFirstAudioPackage&&(this.firstData.sendFirstAudioPackage=!0,this.adapterRef.instance.apiEventReport("setSendFirstPackage",{media_type:0})),this.statsCatch.upAudioCache&&(f=this.statsCatch.upAudioCache),this.statsCatch.upAudioCache=i}else if(a==="audioSlave"){if(!(!((s=(c=this==null?void 0:this.adapterRef)===null||c===void 0?void 0:c._mediasoup)===null||s===void 0)&&s._audioSlaveProducer))return void(this.statsCatch.upAudioSlaveCache={});this.statsCatch.upAudioSlaveCache&&(f=this.statsCatch.upAudioSlaveCache),this.statsCatch.upAudioSlaveCache=i,this.dispatchExceptionEventSendAudio(f,i)}else if(a==="video"){if(!(!((u=(d=this==null?void 0:this.adapterRef)===null||d===void 0?void 0:d._mediasoup)===null||u===void 0)&&u._webcamProducer))return this.firstData.sendFirstVideoPackage=!1,void(this.statsCatch.upVideoCache={});i.packetsSent>0&&!this.firstData.sendFirstVideoPackage&&(this.firstData.sendFirstVideoPackage=!0,this.adapterRef.instance.apiEventReport("setSendFirstPackage",{media_type:1})),this.statsCatch.upVideoCache&&(f=this.statsCatch.upVideoCache),this.statsCatch.upVideoCache=i,this.dispatchExceptionEventSendVideo(f,i)}else if(a==="screen"){if(!(!((o=(h=this==null?void 0:this.adapterRef)===null||h===void 0?void 0:h._mediasoup)===null||o===void 0)&&o._screenProducer))return this.firstData.sendFirstScreenPackage=!1,void(this.statsCatch.upScreenCache={});i.packetsSent>0&&!this.firstData.sendFirstScreenPackage&&(this.firstData.sendFirstScreenPackage=!0,this.adapterRef.instance.apiEventReport("setSendFirstPackage",{media_type:2})),this.statsCatch.upScreenCache&&(f=this.statsCatch.upScreenCache),this.statsCatch.upScreenCache=i}if(i.bitsSentPerSecond||(i.bitsSentPerSecond=Math.round(8*(i.bytesSent-(f.bytesSent||0))/1e3)),i.packetsSentPerSecond||(i.packetsSentPerSecond=i.packetsSent-(f.packetsSent||0)),i.packetsLostRate||i.packetsLost!==void 0&&(i.packetsLostRate=this.getPacketLossRate(f,i,!0)),i.streamType){i.framesEncodedPerSecond||i.framesEncoded>=f.framesEncoded&&(i.framesEncodedPerSecond=i.framesEncoded-f.framesEncoded),i.qpPercentage||(i.qpPercentage=this.getQpPercentage(f,i)),i.frameRateSent||(i.frameRateSent=i.framesSent-f.framesSent);let m={freezeTime:0,totalFreezeTime:0};a==="video"?m=this.getLocalVideoFreezeStats(i):a==="screen"&&(m=this.getLocalScreenFreezeStats(i)),i.freezeTime||(i.freezeTime=m.freezeTime),i.totalFreezeTime||(i.totalFreezeTime=m.totalFreezeTime)}}formatRecvData(i,a){let l;const n=i.remoteuid||0;if(this.clearFirstRecvData(n),this.firstData.recvFirstData[n]||(this.firstData.recvFirstData[n]={recvFirstAudioFrame:!1,recvFirstVideoFrame:!1,recvFirstScreenFrame:!1,recvFirstAudioPackage:!1,recvFirstVideoPackage:!1,recvFirstScreenPackage:!1}),a==="audio"?(!this.firstData.recvFirstData[n].recvFirstAudioPackage&&i.packetsReceived>0&&(this.firstData.recvFirstData[n].recvFirstAudioPackage=!0,this.adapterRef.instance.apiEventReport("setRecvFirstPackage",{media_type:0,pull_uid:n})),i.decodingNormal&&i.decodingNormal>0&&!this.firstData.recvFirstData[n].recvFirstAudioFrame&&(this.firstData.recvFirstData[n].recvFirstAudioFrame=!0,this.adapterRef.instance.apiEventReport("setRecvFirstFrame",{media_type:0,pull_uid:n})),this.statsCatch.downAudioCache&&(l=this.statsCatch.downAudioCache[n]),this.statsCatch.downAudioCache[n]=i,this.dispatchExceptionEventRecvAudio(l,i,n)):a==="audioSlave"?(this.statsCatch.downAudioSlaveCache&&(l=this.statsCatch.downAudioSlaveCache[n]),this.statsCatch.downAudioSlaveCache[n]=i):a==="video"?(!this.firstData.recvFirstData[n].recvFirstVideoPackage&&i.packetsReceived>0&&(this.firstData.recvFirstData[n].recvFirstVideoPackage=!0,this.adapterRef.instance.apiEventReport("setRecvFirstPackage",{media_type:1,pull_uid:n})),!this.firstData.recvFirstData[n].recvFirstVideoFrame&&i.framesDecoded>0&&(this.firstData.recvFirstData[n].recvFirstVideoFrame=!0,this.adapterRef.instance.apiEventReport("setRecvFirstFrame",{media_type:1,pull_uid:n})),this.statsCatch.downVideoCache&&(l=this.statsCatch.downVideoCache[n]),this.statsCatch.downVideoCache[n]=i,this.dispatchExceptionEventRecvVideo(l,i,n)):a==="screen"&&(!this.firstData.recvFirstData[n].recvFirstScreenPackage&&i.packetsReceived>0&&(this.firstData.recvFirstData[n].recvFirstScreenPackage=!0,this.adapterRef.instance.apiEventReport("setRecvFirstPackage",{media_type:2,pull_uid:n})),!this.firstData.recvFirstData[n].recvFirstScreenFrame&&i.framesDecoded>0&&(this.firstData.recvFirstData[n].recvFirstScreenFrame=!0,this.adapterRef.instance.apiEventReport("setRecvFirstFrame",{media_type:2,pull_uid:n})),this.statsCatch.downScreenCache&&(l=this.statsCatch.downScreenCache[n]),this.statsCatch.downScreenCache[n]=i,this.dispatchExceptionEventRecvScreen(l,i,n)),!l||i.bytesReceived<l.bytesReceived)return;let c={freezeTime:0,totalFreezeTime:0};i.bitsReceivedPerSecond||(i.bitsReceivedPerSecond=Math.round(8*(i.bytesReceived-l.bytesReceived)/1e3)),i.packetsReceivedPerSecond||(i.packetsReceivedPerSecond=i.packetsReceived-l.packetsReceived),i.packetsLost||i.packetsLost!==void 0&&(i.packetsLostRate=this.getPacketLossRate(l,i)),a==="video"||a==="screen"?(i.frameRateReceived||(i.frameRateReceived=i.framesReceived-l.framesReceived),i.frameRateDecoded||(i.frameRateDecoded=i.framesDecoded-l.framesDecoded),a==="video"?c=this.getRemoteVideoFreezeStats(l,i,n):a==="screen"&&(c=this.getRemoteScreenFreezeStats(l,i,n))):i.decodingCTN&&(c=this.getRemoteAudioFreezeStats(l,i,n)),i.freezeTime||(i.freezeTime=c.freezeTime),i.totalFreezeTime||(i.totalFreezeTime=c.totalFreezeTime)}getQpPercentage(i,a){if(!(i&&i.framesEncoded&&i.qpSum&&a&&a.framesEncoded&&a.qpSum))return 0;const l=a.qpSum-i.qpSum,n=a.framesEncoded-i.framesEncoded;return l<=0||n<=0?0:l>n?100:Math.round(l/n*100)}getPacketLossRate(i,a,l=!1){if(!i||!a)return 0;const n=parseInt(i.packetsLost)||0,c=parseInt(a.packetsLost)||0;if(c<=n)return 0;const s=l?i.packetsSent:i.packetsReceived,d=l?a.packetsSent:a.packetsReceived,u=parseInt(s||"")||0,h=parseInt(d||"")||0;return h<=u?0:Math.round(l?(c-n)/(h-u)*100:(c-n)/(c-n+(h-u))*100)}getLocalVideoFreezeStats(i){let a=0;if(!i||!i.frameRateSent)return{totalFreezeTime:a,freezeTime:0};let l=0,n=parseInt(i.frameRateSent);if(n<=0)return{totalFreezeTime:2e3,freezeTime:6};if(n>10)return{totalFreezeTime:0,freezeTime:0};l=Math.abs(10-n),a=parseInt(2e3*(l/10));let c=0;return a<300?(a=0,c=0):c=a>1500?6:parseInt(a/300),{totalFreezeTime:a,freezeTime:c}}getLocalScreenFreezeStats(i){let a=0;if(!i||!i.frameRateSent)return{totalFreezeTime:a,freezeTime:0};let l=parseInt(i.framesEncoded)||0,n=parseInt(i.framesSent)||0;if(l<=0||n<=0)return{totalFreezeTime:2e3,freezeTime:6};let c=Math.abs(l-n);a=parseInt(2e3*(c/l));let s=0;return a<300?(a=0,s=0):s=a>1500?6:parseInt(a/300),{totalFreezeTime:a,freezeTime:s}}getRemoteAudioFreezeStats(i,a,l){if(!i||!a)return{totalFreezeTime:0,freezeTime:0};let n=parseInt(i.decodingPLC)+parseInt(i.decodingCNG)+parseInt(i.decodingPLCCNG),c=parseInt(i.decodingCTN),s=parseInt(i.decodingPLC)+parseInt(i.decodingCNG)+parseInt(i.decodingPLCCNG),d=parseInt(a.decodingCTN);if(d<=n)return{totalFreezeTime:0,freezeTime:0};let u=(s-n)/(d-c);return{totalFreezeTime:parseInt(1e3*u),freezeTime:10*u>1?parseInt(10*u):u>0?1:0}}getRemoteVideoFreezeStats(i,a,l){let n=0;if(!a||a.framesDecoded==0)return{totalFreezeTime:n,freezeTime:0};if(a&&a.framesDecoded&&a.frameRateDecoded==0)return{totalFreezeTime:2e3,freezeTime:6};let c=parseInt(a.frameRateReceived)||0,s=parseInt(a.frameRateDecoded);if(c<=0||s<=0)return{totalFreezeTime:2e3,freezeTime:6};let d=0;if(c>10)return{totalFreezeTime:0,freezeTime:0};d=Math.abs(10-c),n=parseInt(2e3*(d/10)),n>2e3&&(n=2e3);let u=0;return n<300?(n=0,u=0):u=n>1500?6:parseInt(n/300),{totalFreezeTime:n,freezeTime:u}}getRemoteScreenFreezeStats(i,a,l){let n=0;if(!a)return{totalFreezeTime:n,freezeTime:0};let c=parseInt(a.frameRateReceived),s=parseInt(a.frameRateDecoded);if(c<=0||s<=0)return{totalFreezeTime:2e3,freezeTime:6};let d=Math.abs(s-c);n=parseInt(2e3*(d/c))||0;let u=0;return n<300?(n=0,u=0):u=n>1500?6:parseInt(n/300),{totalFreezeTime:n,freezeTime:u}}dispatchExceptionEventSendAudio(i,a){var l,n,c,s;if(!i||!a)return;const d=(l=this.adapterRef.localStream)===null||l===void 0?void 0:l.muteStatus.audio.send,u=(n=this.adapterRef.localStream)===null||n===void 0?void 0:n.pubStatus.audio.audio;d===!0||u===!1||(a.audioInputLevel===0&&this.adapterRef.instance.safeEmit("exception",{msg:"AUDIO_INPUT_LEVEL_TOO_LOW",code:2001,uid:((c=this.adapterRef)===null||c===void 0?void 0:c.channelInfo.uid)||0}),parseInt(a.bytesSent)-parseInt(i.bytesSent)===0&&this.adapterRef.instance.safeEmit("exception",{msg:"SEND_AUDIO_BITRATE_TOO_LOW",code:2003,uid:((s=this.adapterRef)===null||s===void 0?void 0:s.channelInfo.uid)||0}))}dispatchExceptionEventSendVideo(i,a){var l,n,c,s;if(!i||!a)return;const d=(l=this.adapterRef.localStream)===null||l===void 0?void 0:l.muteStatus.video.send,u=(n=this.adapterRef.localStream)===null||n===void 0?void 0:n.pubStatus.video.video;d===!0||u===!1||(a.frameRateInput&&parseInt(a.frameRateInput)>5&&parseInt(a.frameRateSent)<=1&&this.adapterRef.instance.safeEmit("exception",{msg:"FRAMERATE_SENT_TOO_LOW",code:1002,uid:((c=this.adapterRef)===null||c===void 0?void 0:c.channelInfo.uid)||0}),parseInt(a.bytesSent)-parseInt(i.bytesSent)===0&&this.adapterRef.instance.safeEmit("exception",{msg:"FRAMERATE_VIDEO_BITRATE_TOO_LOW",code:1003,uid:((s=this.adapterRef)===null||s===void 0?void 0:s.channelInfo.uid)||0}))}dispatchExceptionEventRecvAudio(i,a,l){if(!i||!a||!a.googDecodingNormal)return;const n=this.adapterRef.remoteStreamMap[l],c=n&&(n.muteStatus.audio.send||n.muteStatus.audio.recv);if(n&&c||!n||!n.Play||!n.Play.audio.dom||!n.Play.audio.dom.srcObject||n.Play.audio.dom.muted)return;let s=parseInt(a.bytesReceived)-parseInt(i.bytesReceived),d=parseInt(a.decodingNormal)-parseInt(i.decodingNormal);if(s>0&&d===0&&this.adapterRef.instance.safeEmit("exception",{msg:"RECV_AUDIO_DECODE_FAILED",code:2005,uid:l}),s>0&&d>0&&+(a.audioOutputLevel||a.audioLevel)==0){const u=n&&n.Play&&n.Play.audio.dom&&n.Play.audio.dom.volume;u&&u>0&&this.adapterRef.instance.safeEmit("exception",{msg:"AUDIO_OUTPUT_LEVEL_TOO_LOW",code:2002,uid:l})}}dispatchExceptionEventRecvVideo(i,a,l){if(!i||!a)return;const n=this.adapterRef.remoteStreamMap[l],c=n&&(n.muteStatus.video.send||n.muteStatus.video.recv);n&&c||parseInt(a.bytesReceived)-parseInt(i.bytesReceived)>0&&parseInt(a.frameRateDecoded)===0&&this.adapterRef.instance.safeEmit("exception",{msg:"RECV_VIDEO_DECODE_FAILED",code:1005,uid:l})}dispatchExceptionEventRecvScreen(i,a,l){if(!i||!a)return;const n=this.adapterRef.remoteStreamMap[l],c=n&&(n.muteStatus.screen.send||n.muteStatus.screen.recv);n&&c||parseInt(a.bytesReceived)-parseInt(i.bytesReceived)>0&&parseInt(a.frameRateDecoded)===0&&this.adapterRef.instance.safeEmit("exception",{msg:"RECV_SCREEN_DECODE_FAILED",code:1005,uid:l})}destroy(){this._reset()}}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.FormativeStatsVideo=e.FormativeStatsAudio=void 0,e.FormativeStatsAudio=class{constructor(){this.echoReturnLoss="",this.echoReturnLossEnhancement="",this.CodecType="",this.totalFreezeTime=0,this.remoteuid=""}},e.FormativeStatsVideo=class{constructor(){this.totalFreezeTime=0,this.qualityLimitationReason="",this.streamType="",this.CodecName="",this.CodecImplementationName="",this.remoteuid=""}}},function(module,exports,__webpack_require__){(function(process,global){var __WEBPACK_AMD_DEFINE_RESULT__;/*
 * [js-sha1]{@link https://github.com/emn178/js-sha1}
 *
 * @version 0.6.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */(function(){var root=typeof window=="object"?window:{},NODE_JS=!root.JS_SHA1_NO_NODE_JS&&typeof process=="object"&&process.versions&&process.versions.node;NODE_JS&&(root=global);var COMMON_JS=!root.JS_SHA1_NO_COMMON_JS&&typeof module=="object"&&module.exports,AMD=__webpack_require__(280),HEX_CHARS="0123456789abcdef".split(""),EXTRA=[-2147483648,8388608,32768,128],SHIFT=[24,16,8,0],OUTPUT_TYPES=["hex","array","digest","arrayBuffer"],blocks=[],createOutputMethod=function(t){return function(e){return new Sha1(!0).update(e)[t]()}},createMethod=function(){var t=createOutputMethod("hex");NODE_JS&&(t=nodeWrap(t)),t.create=function(){return new Sha1},t.update=function(i){return t.create().update(i)};for(var e=0;e<OUTPUT_TYPES.length;++e){var r=OUTPUT_TYPES[e];t[r]=createOutputMethod(r)}return t},nodeWrap=function(method){var crypto=eval("require('crypto')"),Buffer=eval("require('buffer').Buffer"),nodeMethod=function(t){if(typeof t=="string")return crypto.createHash("sha1").update(t,"utf8").digest("hex");if(t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(t.length===void 0)return method(t);return crypto.createHash("sha1").update(new Buffer(t)).digest("hex")};return nodeMethod};function Sha1(t){t?(blocks[0]=blocks[16]=blocks[1]=blocks[2]=blocks[3]=blocks[4]=blocks[5]=blocks[6]=blocks[7]=blocks[8]=blocks[9]=blocks[10]=blocks[11]=blocks[12]=blocks[13]=blocks[14]=blocks[15]=0,this.blocks=blocks):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Sha1.prototype.update=function(t){if(!this.finalized){var e=typeof t!="string";e&&t.constructor===root.ArrayBuffer&&(t=new Uint8Array(t));for(var r,i,a=0,l=t.length||0,n=this.blocks;a<l;){if(this.hashed&&(this.hashed=!1,n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),e)for(i=this.start;a<l&&i<64;++a)n[i>>2]|=t[a]<<SHIFT[3&i++];else for(i=this.start;a<l&&i<64;++a)(r=t.charCodeAt(a))<128?n[i>>2]|=r<<SHIFT[3&i++]:r<2048?(n[i>>2]|=(192|r>>6)<<SHIFT[3&i++],n[i>>2]|=(128|63&r)<<SHIFT[3&i++]):r<55296||r>=57344?(n[i>>2]|=(224|r>>12)<<SHIFT[3&i++],n[i>>2]|=(128|r>>6&63)<<SHIFT[3&i++],n[i>>2]|=(128|63&r)<<SHIFT[3&i++]):(r=65536+((1023&r)<<10|1023&t.charCodeAt(++a)),n[i>>2]|=(240|r>>18)<<SHIFT[3&i++],n[i>>2]|=(128|r>>12&63)<<SHIFT[3&i++],n[i>>2]|=(128|r>>6&63)<<SHIFT[3&i++],n[i>>2]|=(128|63&r)<<SHIFT[3&i++]);this.lastByteIndex=i,this.bytes+=i-this.start,i>=64?(this.block=n[16],this.start=i-64,this.hash(),this.hashed=!0):this.start=i}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},Sha1.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var t=this.blocks,e=this.lastByteIndex;t[16]=this.block,t[e>>2]|=EXTRA[3&e],this.block=t[16],e>=56&&(this.hashed||this.hash(),t[0]=this.block,t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.hBytes<<3|this.bytes>>>29,t[15]=this.bytes<<3,this.hash()}},Sha1.prototype.hash=function(){var t,e,r=this.h0,i=this.h1,a=this.h2,l=this.h3,n=this.h4,c=this.blocks;for(t=16;t<80;++t)e=c[t-3]^c[t-8]^c[t-14]^c[t-16],c[t]=e<<1|e>>>31;for(t=0;t<20;t+=5)r=(e=(i=(e=(a=(e=(l=(e=(n=(e=r<<5|r>>>27)+(i&a|~i&l)+n+1518500249+c[t]<<0)<<5|n>>>27)+(r&(i=i<<30|i>>>2)|~r&a)+l+1518500249+c[t+1]<<0)<<5|l>>>27)+(n&(r=r<<30|r>>>2)|~n&i)+a+1518500249+c[t+2]<<0)<<5|a>>>27)+(l&(n=n<<30|n>>>2)|~l&r)+i+1518500249+c[t+3]<<0)<<5|i>>>27)+(a&(l=l<<30|l>>>2)|~a&n)+r+1518500249+c[t+4]<<0,a=a<<30|a>>>2;for(;t<40;t+=5)r=(e=(i=(e=(a=(e=(l=(e=(n=(e=r<<5|r>>>27)+(i^a^l)+n+1859775393+c[t]<<0)<<5|n>>>27)+(r^(i=i<<30|i>>>2)^a)+l+1859775393+c[t+1]<<0)<<5|l>>>27)+(n^(r=r<<30|r>>>2)^i)+a+1859775393+c[t+2]<<0)<<5|a>>>27)+(l^(n=n<<30|n>>>2)^r)+i+1859775393+c[t+3]<<0)<<5|i>>>27)+(a^(l=l<<30|l>>>2)^n)+r+1859775393+c[t+4]<<0,a=a<<30|a>>>2;for(;t<60;t+=5)r=(e=(i=(e=(a=(e=(l=(e=(n=(e=r<<5|r>>>27)+(i&a|i&l|a&l)+n-1894007588+c[t]<<0)<<5|n>>>27)+(r&(i=i<<30|i>>>2)|r&a|i&a)+l-1894007588+c[t+1]<<0)<<5|l>>>27)+(n&(r=r<<30|r>>>2)|n&i|r&i)+a-1894007588+c[t+2]<<0)<<5|a>>>27)+(l&(n=n<<30|n>>>2)|l&r|n&r)+i-1894007588+c[t+3]<<0)<<5|i>>>27)+(a&(l=l<<30|l>>>2)|a&n|l&n)+r-1894007588+c[t+4]<<0,a=a<<30|a>>>2;for(;t<80;t+=5)r=(e=(i=(e=(a=(e=(l=(e=(n=(e=r<<5|r>>>27)+(i^a^l)+n-899497514+c[t]<<0)<<5|n>>>27)+(r^(i=i<<30|i>>>2)^a)+l-899497514+c[t+1]<<0)<<5|l>>>27)+(n^(r=r<<30|r>>>2)^i)+a-899497514+c[t+2]<<0)<<5|a>>>27)+(l^(n=n<<30|n>>>2)^r)+i-899497514+c[t+3]<<0)<<5|i>>>27)+(a^(l=l<<30|l>>>2)^n)+r-899497514+c[t+4]<<0,a=a<<30|a>>>2;this.h0=this.h0+r<<0,this.h1=this.h1+i<<0,this.h2=this.h2+a<<0,this.h3=this.h3+l<<0,this.h4=this.h4+n<<0},Sha1.prototype.hex=function(){this.finalize();var t=this.h0,e=this.h1,r=this.h2,i=this.h3,a=this.h4;return HEX_CHARS[t>>28&15]+HEX_CHARS[t>>24&15]+HEX_CHARS[t>>20&15]+HEX_CHARS[t>>16&15]+HEX_CHARS[t>>12&15]+HEX_CHARS[t>>8&15]+HEX_CHARS[t>>4&15]+HEX_CHARS[15&t]+HEX_CHARS[e>>28&15]+HEX_CHARS[e>>24&15]+HEX_CHARS[e>>20&15]+HEX_CHARS[e>>16&15]+HEX_CHARS[e>>12&15]+HEX_CHARS[e>>8&15]+HEX_CHARS[e>>4&15]+HEX_CHARS[15&e]+HEX_CHARS[r>>28&15]+HEX_CHARS[r>>24&15]+HEX_CHARS[r>>20&15]+HEX_CHARS[r>>16&15]+HEX_CHARS[r>>12&15]+HEX_CHARS[r>>8&15]+HEX_CHARS[r>>4&15]+HEX_CHARS[15&r]+HEX_CHARS[i>>28&15]+HEX_CHARS[i>>24&15]+HEX_CHARS[i>>20&15]+HEX_CHARS[i>>16&15]+HEX_CHARS[i>>12&15]+HEX_CHARS[i>>8&15]+HEX_CHARS[i>>4&15]+HEX_CHARS[15&i]+HEX_CHARS[a>>28&15]+HEX_CHARS[a>>24&15]+HEX_CHARS[a>>20&15]+HEX_CHARS[a>>16&15]+HEX_CHARS[a>>12&15]+HEX_CHARS[a>>8&15]+HEX_CHARS[a>>4&15]+HEX_CHARS[15&a]},Sha1.prototype.toString=Sha1.prototype.hex,Sha1.prototype.digest=function(){this.finalize();var t=this.h0,e=this.h1,r=this.h2,i=this.h3,a=this.h4;return[t>>24&255,t>>16&255,t>>8&255,255&t,e>>24&255,e>>16&255,e>>8&255,255&e,r>>24&255,r>>16&255,r>>8&255,255&r,i>>24&255,i>>16&255,i>>8&255,255&i,a>>24&255,a>>16&255,a>>8&255,255&a]},Sha1.prototype.array=Sha1.prototype.digest,Sha1.prototype.arrayBuffer=function(){this.finalize();var t=new ArrayBuffer(20),e=new DataView(t);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),t};var exports=createMethod();COMMON_JS?module.exports=exports:(root.sha1=exports,AMD&&(__WEBPACK_AMD_DEFINE_RESULT__=(function(){return exports}).call(exports,__webpack_require__,exports,module),__WEBPACK_AMD_DEFINE_RESULT__===void 0||(module.exports=__WEBPACK_AMD_DEFINE_RESULT__)))})()}).call(this,__webpack_require__(80),__webpack_require__(70))},function(t,e){(function(r){t.exports=r}).call(this,{})},function(t,e,r){var i=this&&this.__importDefault||function(A){return A&&A.__esModule?A:{default:A}};Object.defineProperty(e,"__esModule",{value:!0}),e.Signalling=void 0;const a=r(3),l=r(282),n=r(26),c=r(48),s=i(r(6)),d=i(r(8)),u=r(295),h=r(71),o=r(77),f=r(145),m=r(1),g=r(140),v=r(7),O=r(297);let T=0;class C extends a.EventEmitter{constructor(R){super(),this.signallingId=T++,this._reconnectionTimer=null,this.reconnectionMaxTimeoutTimer=null,this._protoo=null,this._url=null,this._resolve=null,this._reject=null,this.consumers={},this.keepAliveTimer=null,this.joinTimestamps=[],this.joinFailedServers=[],this.reconnectionReason=c.ReconnectReason.Unknown,this.reconnectionControl={current:null,next:null,copynext:null},this.autoMask={timer:null,data:[]},this.logger=R.logger.getChild(()=>{var w,k;let I="signal";return this.signallingId&&(I+=this.signallingId),this._protoo?(this._protoo.id&&(I+="#"+this._protoo.id+"_"+((w=this._protoo._transport)===null||w===void 0?void 0:w.wsid)),this._protoo.connected||(I+="!connected")):I+=" PROTOO_UNINIT",((k=R.adapterRef._signalling)===null||k===void 0?void 0:k.signallingId)!==this.signallingId&&(I+=" DETACHED"),I}),this._reset(),this.adapterRef=R.adapterRef,this.browserDevice=o.getOSInfo().osName+"-"+o.getBrowserInfo().browserName+"-"+o.getBrowserInfo().browserVersion}_reset(){this._reconnectionTimer&&clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null,this.reconnectionMaxTimeoutTimer&&clearTimeout(this.reconnectionMaxTimeoutTimer),this.reconnectionMaxTimeoutTimer=null,this._destroyProtoo(),this.reconnectionControl.current=null,this.reconnectionControl.next=null,this.reconnectionControl.copynext=null,this._resolve=null,this._reject=null,this.joinFailedServers.length=0}init(R,w){return this._reconnectionTimer?Promise.resolve():new Promise(async(k,I)=>{var M;R||(this._resolve=k),R||(this._reject=I);let P=this.reconnectionControl.next||{timeout:w?m.getParameters().reconnectionFirstTimeout:m.getParameters().joinFirstTimeout,url:this.adapterRef.channelInfo.wssArr[0],serverIndex:0,times:w?1:0,isJoinRetry:R,isReconnection:w,isLastTry:!1};if(P.isJoinRetry=R,P.isReconnection=w,w&&this.adapterRef.signalProbeManager.online!=="unknown"&&P.times===1&&m.getParameters().reconnectionWaitTimeout>0&&this.adapterRef.signalProbeManager.getActiveServerCount().cnt===0){const y=m.getParameters().reconnectionWaitTimeout;this.logger.warn(`目前所有服务端不在线，判断为网络断开。等待服务端起上线或 ${y}ms`);const _=await this.adapterRef.signalProbeManager.waitForServerActive(y);if(((M=this.adapterRef._signalling)===null||M===void 0?void 0:M.signallingId)!==this.signallingId)return;this.logger.warn("恢复重连过程。reason:"+_)}for(let y=0;y<6;y++){const _=this.adapterRef.signalProbeManager.getServerState(P.url);if(!_||P.isLastTry)break;if(this.adapterRef.signalProbeManager.getActiveServerCount().cnt>0)if(_.active){if(!(2*_.ping.rtt>P.timeout))break;this.logger.warn(`重连跳过：当前服务器rtt过长：${P.url} ${P.serverIndex+1}/${this.adapterRef.channelInfo.wssArr.length} timeout: ${P.timeout}ms, rtt x2: ${_.ping.rtt}x2=${2*_.ping.rtt}ms`),P=this._getNextConnConfig(P)}else this.logger.error(`重连跳过：当前服务器不可用：${P.url} ${P.serverIndex+1}/${this.adapterRef.channelInfo.wssArr.length} ${P.timeout}ms`),P=this._getNextConnConfig(P)}this.adapterRef.channelInfo.wssArrIndex=P.serverIndex,R?(w?this.adapterRef.logger.error(`Signalling 开始尝试第 ${P.serverIndex+1}/${this.adapterRef.channelInfo.wssArr.length} 台服务器的第 ${P.times}/${m.getParameters().reconnectionMaxRetry} 次重连，退避时间：${P.timeout}毫秒，服务器地址：${P.url}`):this.adapterRef.logger.error(`join() 正在尝试第 ${P.serverIndex+1}/${this.adapterRef.channelInfo.wssArr.length} 台服务器的第 ${P.times}/${m.getParameters().joinMaxRetry} 次重连，退避时间：${P.timeout}毫秒，服务器地址：${P.url}`),this.joinFailedServers.push({addr:P.url,code:-1,err_msg:"reconnection timeout",time_elapsed_for_signaling_connect:P.timeout,signalling_rtt:-1,server_type:0,time:Date.now(),network_type:"unknown"})):this.adapterRef.logger.log(`join() 正在尝试第 ${P.serverIndex+1} / ${this.adapterRef.channelInfo.wssArr.length} 个服务器的第 ${P.times} / ${m.getParameters().joinMaxRetry} 次连接`),this.reconnectionControl.current=P,this.reconnectionControl.next=null,this._init(P.url);let S=this._getNextConnConfig(P);this.reconnectionControl.next=this.reconnectionControl.copynext=S,this._reconnectionTimer&&clearTimeout(this._reconnectionTimer),this._reconnectionTimer=setTimeout(()=>{var y;this._reconnectionTimer&&clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null,((y=this.adapterRef._signalling)===null||y===void 0?void 0:y.signallingId)===this.signallingId&&(this._destroyProtoo(),w?(this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-error"),this._reconnection()):this._connection())},S.timeout)})}_getNextConnConfig(R){let w=Object.assign({},R);return R.times?w.serverIndex++:(w.times=1,w.serverIndex=1),w.serverIndex>=this.adapterRef.channelInfo.wssArr.length&&(w.times++,w.serverIndex=0),R.isJoinRetry?w.timeout=m.getParameters().joinFirstTimeout+2e3*(w.times-1):R.isReconnection&&(w.timeout=m.getParameters().reconnectionFirstTimeout+2e3*(w.times-1)),w.isJoinRetry=R.isJoinRetry,w.isReconnection=R.isReconnection,w.isJoinRetry&&w.times>=m.getParameters().joinMaxRetry&&(m.getParameters().reconnectionMaxTimeout?w.times>m.getParameters().joinMaxRetry&&(w.times=0):w.isLastTry=!0),w.isReconnection&&w.times>=m.getParameters().reconnectionMaxRetry&&(m.getParameters().reconnectionMaxTimeout?w.times>m.getParameters().reconnectionMaxRetry&&(w.times=0):w.isLastTry=!0),w.url=this.adapterRef.channelInfo.wssArr[w.serverIndex],w}joinConnectTimeout(){this.adapterRef.logger.error("join() 所有的服务器地址都连接失败, 主动离开房间");const R=Date.now(),w=this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2;this.adapterRef.instance.apiEventReport("setLogin",{a_record:this.adapterRef.channelInfo.sessionConfig.recordAudio,v_record:this.adapterRef.channelInfo.sessionConfig.recordVideo,record_type:this.adapterRef.channelInfo.sessionConfig.recordType,host_speaker:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,permKey:this.adapterRef.channelInfo.permKey,result:-2,server_ip:this.adapterRef.channelInfo._protooUrl,signalling_rtt:this.adapterRef.state.signalJoinMsgRtt,signalling_time:w.startWssTime-w.startJoinTime,time_elapsed:R-w.startJoinTime,join_failed_server:this.joinFailedServers,model:this.browserDevice,desc:"signalling server connection failed(timeout)"}),this.joinFailedServers.length=0,this.adapterRef.channelInfo.wssArrIndex=0,this.adapterRef.instance.leave(s.default.SIGNAL_CONNECTION_DISCONNECTED),this.adapterRef.instance.safeEmit("error","SOCKET_ERROR"),this._reject&&this._reject(new d.default({code:s.default.NETWORK_ERROR,message:"join() 所有的服务器地址都连接失败"}))}async _connection(){m.getParameters().reconnectionMaxTimeout&&(this.adapterRef.logger.warn("connection 设置了最大重连时间 reconnectionMaxTimeout: ",m.getParameters().reconnectionMaxTimeout),this.reconnectionMaxTimeoutTimer||(this.reconnectionMaxTimeoutTimer=setTimeout(()=>{this.joinConnectTimeout()},1e3*m.getParameters().reconnectionMaxTimeout))),this._destroyProtoo();const R=this.reconnectionControl.current,w=this.reconnectionControl.next;w?!R||w.times<=m.getParameters().joinMaxRetry?this.init(!0,!1):this.joinConnectTimeout():this.adapterRef.logger.error("Join() 结束")}async _reconnection(){var R,w;if(!this._reconnectionTimer){m.getParameters().reconnectionMaxTimeout&&(this.adapterRef.logger.warn("reconnection 设置了最大重连时间 reconnectionMaxTimeout: ",m.getParameters().reconnectionMaxTimeout),this.reconnectionMaxTimeoutTimer||(this.reconnectionMaxTimeoutTimer=setTimeout(()=>{this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-skip"),this.adapterRef.logger.error("所有的服务器地址都连接失败, 主动离开房间"),this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"socketError",ext:"signalling server reconnection failed(timeout)"}),this.adapterRef.channelInfo.wssArrIndex=0,this.adapterRef.instance.leave(s.default.SIGNAL_CONNECTION_DISCONNECTED),this.adapterRef.instance.safeEmit("error","SOCKET_ERROR")},1e3*m.getParameters().reconnectionMaxTimeout))),this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="CONNECTING",this.adapterRef.connectState.reconnect=!0,this.adapterRef.connectState.prevState!==this.adapterRef.connectState.curState&&this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-start"),this._destroyProtoo(),!((R=this.adapterRef._mediasoup)===null||R===void 0)&&R._sendTransportTimeoutTimer&&(clearTimeout(this.adapterRef._mediasoup._sendTransportTimeoutTimer),this.adapterRef._mediasoup._sendTransportTimeoutTimer=null),!((w=this.adapterRef._mediasoup)===null||w===void 0)&&w._recvTransportTimeoutTimer&&(clearTimeout(this.adapterRef._mediasoup._recvTransportTimeoutTimer),this.adapterRef._mediasoup._recvTransportTimeoutTimer=null),this.adapterRef.connectState.prevState==="CONNECTED"&&(this.adapterRef.netStatusList.forEach(k=>{k.uplinkNetworkQuality=0,k.downlinkNetworkQuality=0}),this.adapterRef.instance.safeEmit("network-quality",this.adapterRef.netStatusList));for(let k in this.adapterRef.remoteStreamMap){const I=this.adapterRef.remoteStreamMap[k];I._play&&(this.logger.warn("Destroy Remote Player",k),I._play.destroy())}this.reconnectionControl.next&&this.reconnectionControl.next.times>m.getParameters().reconnectionMaxRetry?(this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-skip"),this.adapterRef.logger.error("所有的服务器地址都连接失败, 主动离开房间"),this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"socketError",ext:"signalling server reconnection failed(timeout)"}),this.adapterRef.channelInfo.wssArrIndex=0,this.adapterRef.instance.leave(s.default.SIGNAL_CONNECTION_DISCONNECTED),this.adapterRef.instance.safeEmit("error","SOCKET_ERROR")):this.init(!0,!0)}}_init(R){R.indexOf("?")===-1&&(R+="?"),this.logger.log("Signalling: init url = ",R),this.adapterRef.channelInfo._protooUrl=R,this._url=`${R.indexOf("://")===-1?"wss://":""}${R}&cid=${this.adapterRef.channelInfo.cid}&uid=${this.adapterRef.channelInfo.uid}&deviceid=${this.adapterRef.deviceId}`,this.logger.log("Signalling: 连接 url  ",this._url);const w=new O.WebSocketTransport(this._url,{retry:{retries:0,factor:2,minTimeout:1e3,maxTimeout:2e3,forever:!1,maxRetryTime:2e3}}),k=new O.Peer(w);this._protoo=k,k.signalling=this,this.adapterRef.state.signalEstablishTime=Date.now(),this._bindEvent()}_bindEvent(){var R,w,k,I,M;(R=this._protoo)===null||R===void 0||R.on("failed",this._handleFailed.bind(this)),(w=this._protoo)===null||w===void 0||w.on("close",this._handleClose.bind(this)),(k=this._protoo)===null||k===void 0||k.on("open",this._handleOpen.bind(this,this._protoo)),(I=this._protoo)===null||I===void 0||I.on("notification",this._handleMessage.bind(this,this._protoo)),(M=this._protoo)===null||M===void 0||M.on("disconnected",this._handleDisconnected.bind(this,this._protoo))}_destroyProtoo(){var R;if(this._protoo){this.logger.debug(`信令通道#${this._protoo.id}_${(R=this._protoo._transport)===null||R===void 0?void 0:R.wsid} 被主动关闭。`),this._protoo.removeAllListeners();try{this._protoo&&this._protoo.close()}catch{}this._protoo=null}}async _handleMessage(R,w){var k,I,M,P,S,y,_;if(!(R&&this._isProtooDetached(R)||this.adapterRef.channelStatus==="connectioning"))switch(w.method){case"OnPeerJoin":{const{requestId:b,externData:E}=w.data;this.logger.log("收到OnPeerJoin成员加入消息 uid =",E.uid);let x=E.uid;this.adapterRef.channelInfo.uidType==="string"&&(x=x.toString());let D=this.adapterRef.remoteStreamMap[x];D?D.active=!0:(D=new l.RemoteStream({uid:x,audio:!1,audioSlave:!1,video:!1,screen:!1,videoThird:!1,videoFourth:!1,client:this.adapterRef.instance,platformType:E.platformType}),this.adapterRef.remoteStreamMap[x]=D,this.adapterRef.memberMap[x]=x),this.adapterRef.instance._roleInfo.audienceList[x]=!1,this.adapterRef.instance.safeEmit("peer-online",{uid:x}),E.customData&&this.adapterRef.instance.safeEmit("custom-data",{uid:x,customData:E.customData});break}case"OnPeerLeave":{const{requestId:b,externData:E}=w.data;this.logger.log("OnPeerLeave externData =",JSON.stringify(E,null,"")),E.userList&&E.userList.forEach(x=>{var D;let F=x.uid;this.adapterRef.channelInfo.uidType==="string"&&(F=F.toString());const V=x.reason;(D=this.adapterRef._mediasoup)===null||D===void 0||D.removeUselessConsumeRequest(F,"all"),this.adapterRef.instance.clearMember(F,V),this.adapterRef.instance.removeSsrc(F),delete this.adapterRef.instance._roleInfo.audienceList[F]});break}case"OnNewProducer":{const{externData:b}=w.data;this.logger.log("收到OnNewProducer发布消息 externData =",JSON.stringify(b.producerInfo));let E,{uid:x,producerId:D,mediaType:F,mute:V,simulcastEnable:N,spatialLayerCount:L}=b.producerInfo;switch(this.adapterRef.channelInfo.uidType==="string"&&(x=x.toString()),F){case"screenShare":E="screen";break;case"subAudio":E="audioSlave";break;case"audio":case"video":case"videoThird":case"videoFourth":E=F;break;default:return void this.logger.warn(`OnNewProducer 不支持的媒体类型:${F}, uid ${x}`)}let U=this.adapterRef.remoteStreamMap[x];U?U.active=!0:(U=new l.RemoteStream({uid:x,audio:E==="audio",audioSlave:E==="audioSlave",video:E==="video",screen:E==="screen",videoThird:E==="videoThird",videoFourth:E==="videoFourth",client:this.adapterRef.instance,platformType:b.platformType}),this.adapterRef.remoteStreamMap[x]=U,this.adapterRef.memberMap[x]=x),U.muteStatus[E].send=b.producerInfo.mute,U.pubStatus[E].consumerId?(k=this.adapterRef._mediasoup)===null||k===void 0||k.destroyConsumer(U.pubStatus[E].consumerId,U,E):(I=this.adapterRef._mediasoup)===null||I===void 0||I.removeUselessConsumeRequest(x,F),U[E]=!0,U.pubStatus[E][E]=!0,U.pubStatus[E].producerId=D,U.pubStatus[E].mute=V,U.pubStatus[E].simulcastEnable=N,U.pubStatus[E].consumerId="",E!=="video"&&E!=="screen"&&E!=="videoThird"&&E!=="videoFourth"||(U.spatialLayerCount[E]=L),this.adapterRef.instance.safeEmit("stream-added",{stream:U,mediaType:E,dualStream:L>1}),V&&(E==="audioSlave"?this.adapterRef.instance.safeEmit("mute-audio-slave",{uid:U.getId()}):E==="videoThird"?this.adapterRef.instance.safeEmit("mute-video-thrid",{uid:U.getId()}):E==="videoFourth"?this.adapterRef.instance.safeEmit("mute-video-fourth",{uid:U.getId()}):this.adapterRef.instance.safeEmit("mute-"+E,{uid:U.getId()}));break}case"OnProducerClose":{const{code:b,errMsg:E,externData:x}=w.data;let{uid:D,producerId:F,mediaType:V}=x;this.adapterRef.channelInfo.uidType==="string"&&(D=D.toString());let N,L=this.adapterRef.remoteStreamMap[D];if(!L)return void this.logger.warn(`收到OnProducerClose消息，但是当前没有该Producer： code = ${b}, errMsg = ${E}, uid = ${D}, mediaType = ${V}, producerId: ${F}`);switch(this.logger.log(`收到OnProducerClose消息 code = ${b}, errMsg = ${E}, uid = ${D}, mediaType = ${V}, producerId: ${F}`),V){case"screenShare":N="screen";break;case"subAudio":N="audioSlave";break;case"audio":case"video":case"videoThird":case"videoFourth":N=V;break;default:return void this.logger.warn(`OnProducerClose 不支持的媒体类型:${V}, uid ${D}`)}if(L.pubStatus[N].producerId!==F)return void this.logger.log("该 producerId 已经无效，不处理");(M=this.adapterRef._mediasoup)===null||M===void 0||M.removeUselessConsumeRequest(D,V),L.pubStatus[N].consumerId&&((P=this.adapterRef._mediasoup)===null||P===void 0||P.destroyConsumer(L.pubStatus[N].consumerId,L,N),L.pubStatus[N].consumerId=""),this.adapterRef.instance.removeSsrc(D,N),L.subStatus[N]=!1,L.pubStatus[N][N]=!1,L[N]=!1,L.pubStatus[N].consumerId="",L.pubStatus[N].producerId="",N!=="video"&&N!=="screen"&&N!=="videoThird"&&N!=="videoFourth"||(L.spatialLayerCount[N]=0),N==="audio"?(L.mediaHelper.audio.micTrack=null,h.emptyStreamWith(L.mediaHelper.audio.audioStream,null)):N==="audioSlave"?(L.mediaHelper.screenAudio.screenAudioTrack=null,h.emptyStreamWith(L.mediaHelper.screenAudio.screenAudioStream,null)):N==="video"?(L.mediaHelper.video.cameraTrack=null,h.emptyStreamWith(L.mediaHelper.video.videoStream,null)):N==="screen"?(L.mediaHelper.screen.screenVideoTrack=null,h.emptyStreamWith(L.mediaHelper.screen.screenVideoStream,null)):N==="videoThird"?(L.mediaHelper.videoThird.videoThirdTrack=null,h.emptyStreamWith(L.mediaHelper.videoThird.videoThirdStream,null)):N==="videoFourth"&&(L.mediaHelper.videoFourth.videoFourthTrack=null,h.emptyStreamWith(L.mediaHelper.videoFourth.videoFourthStream,null)),this.adapterRef.instance.safeEmit("stream-removed",{stream:L,mediaType:N});break}case"OnConsumerClose":{const{requestId:b,code:E,errMsg:x,consumerId:D,producerId:F}=w.data;this.logger.log(`chence OnConsumerClose code = ${E} errMsg = ${x} producerId = ${F}`);const V=this.consumers[D];if(!V)break;V.close();break}case"consumerPaused":{const{consumerId:b}=w.data;if(!this.consumers[b])break;break}case"consumerResumed":case"consumerScore":break;case"OnTransportClose":{const{requestId:b,code:E,errMsg:x,transportId:D}=w.data;this.logger.warn(`chence OnTransportClose: code = ${E}, errMsg = ${x}, transportId = ${D}`),!((S=this.adapterRef._mediasoup)===null||S===void 0)&&S._sendTransport||!((y=this.adapterRef._mediasoup)===null||y===void 0)&&y._recvTransport?(this.logger.warn("服务器媒体进程crash，上行媒体和下行媒体同时重连"),this.adapterRef.channelStatus="connectioning",this.reconnectionReason=c.ReconnectReason.OnTransportClose,this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"OnTransportClose",ext:""}),this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startWssTime=Date.now(),this._reconnection()):this.logger.warn("服务器发送了错误信息");break}case"OnSignalRestart":{const{requestId:b,code:E,errMsg:x}=w.data;this.logger.warn(`chence OnSignalRestart code = ${E} errMsg = ${x}`),this.logger.warn("服务器信令进程crash，重连"),this.reconnectionReason=c.ReconnectReason.OnSignalRestart,this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"OnSignalRestart",ext:""}),!((_=this._protoo)===null||_===void 0)&&_.connected&&this.adapterRef.connectState.curState==="CONNECTED"||(this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startWssTime=Date.now(),this._reconnection());break}case"OnPermKeyTimeout":this.adapterRef.instance.safeEmit("permkey-will-expire");break;case"OnPeerClose":this.logger.warn("相同UID在其他地方登录，您被踢出房间"),this.adapterRef.instance.safeEmit("uid-duplicate"),this.adapterRef.instance.leave(s.default.UID_DUPLICATE);break;case"OnKickOff":{let{reason:b}=w.data.externData;this._handleKickedNotify(b);break}case"OnUserData":{let{type:b,data:E}=w.data.externData;if(b==="StreamStatus")this.logger.log("StreamStatus变更: ",JSON.stringify(E,null,"")),this._handleStreamStatusNotify(E);else if(b==="NetStatus")this._handleNetStatusNotify(E);else if(b==="Mute")this.logger.log("mute变更: ",JSON.stringify(E,null,"")),this._handleMuteNotify(E);else if(b==="UserRole")this.logger.log("UserRole变更: ",JSON.stringify(E,null,"")),this._handleUserRoleNotify(w.data.externData);else if(b==="RtmpTaskStatus")this.logger.log("RtmpTaskStatus变更: ",JSON.stringify(E,null,"")),this.adapterRef.instance.safeEmit("rtmp-state",E);else if(b==="AutoMaskUid"){const x=E;this.logger.log("收到打码通知：",x.maskUid,"时长",x.duration,"秒"),x.maskUid&&x.duration&&(x.targetEndMs=Date.now()+1e3*x.duration,this.autoMask.data.push(x),this.updateMaskStatus())}else if(b==="MediaCapability"){if(this.logger.warn("MediaCapability房间能力变更: ",JSON.stringify(E,null,"")),this.adapterRef.mediaCapability.parseRoom(E),this.adapterRef.instance.safeEmit("@mediaCapabilityChange"),this.adapterRef._mediasoup&&this.adapterRef.mediaCapability.room.videoCodecType&&this.adapterRef.localStream){const x=this.adapterRef.mediaCapability.getCodecSend("video",this.adapterRef._mediasoup._sendTransport.handler._sendingRtpParametersByKind.video),D=this.adapterRef.mediaCapability.getCodecSend("screen",this.adapterRef._mediasoup._sendTransport.handler._sendingRtpParametersByKind.video),F=this.adapterRef._mediasoup._webcamProducerCodec&&this.adapterRef._mediasoup._webcamProducerCodec!==x.codecName;F&&(this.logger.warn("将视频的Codec切走：",this.adapterRef._mediasoup._webcamProducerCodec,"=>",x.codecName),x.codecName&&(v.IS_FIREFOX?this.logger.warn("Firefox不支持动态切换Codec，触发重连"):(this.logger.log("尝试切换Codec"),await this.adapterRef._mediasoup.setRemoteRecvSdp(x.codecName,"video"))));const V=this.adapterRef._mediasoup._screenProducerCodec&&this.adapterRef._mediasoup._screenProducerCodec!==x.codecName;V&&(this.logger.warn("将辅流的Codec切走：",this.adapterRef._mediasoup._screenProducerCodec,"=>",D.codecName),x.codecName&&(v.IS_FIREFOX?this.logger.warn("Firefox不支持动态切换Codec，触发重连"):(this.logger.log("尝试切换Codec"),await this.adapterRef._mediasoup.setRemoteRecvSdp(x.codecName,"screenShare")))),F||V?v.IS_FIREFOX&&(this.adapterRef.channelStatus="connectioning",this.reconnectionReason=c.ReconnectReason.MediaCapability,this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"MediaCapability",ext:""}),this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startWssTime=Date.now(),this._reconnection()):this.logger.log("Codec保持不动。video:",this.adapterRef._mediasoup._webcamProducerCodec,", screen:",this.adapterRef._mediasoup._screenProducerCodec)}}else if(b==="Ability")this._handleAbility(w.data.externData.data);else if(b==="ChangeRight"){let x=E.uid;if(E.audioRight===1?(this.adapterRef.isAudioBanned=!0,this.adapterRef.instance.safeEmit("audioVideoBanned",{uid:x,mediaType:"audio",state:!0,duration:E.audioDuration})):E.audioRight===2&&(this.adapterRef.isAudioBanned=!1,this.adapterRef.instance.safeEmit("audioVideoBanned",{uid:x,mediaType:"audio",state:!1,duration:E.audioDuration})),E.videoRight===1?(this.adapterRef.isVideoBanned=!0,this.adapterRef.instance.safeEmit("audioVideoBanned",{uid:x,mediaType:"video",state:!0,duration:E.videoDuration})):E.videoRight===2&&(this.adapterRef.isVideoBanned=!1,this.adapterRef.instance.safeEmit("audioVideoBanned",{uid:x,mediaType:"video",state:!1,duration:E.videoDuration})),this.adapterRef.isAudioBanned&&this.adapterRef.isVideoBanned&&this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!0,isVideoBanned:!0}),!this.adapterRef.isAudioBanned&&this.adapterRef.isVideoBanned&&this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!1,isVideoBanned:!0}),this.adapterRef.isAudioBanned&&!this.adapterRef.isVideoBanned&&this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!0,isVideoBanned:!1}),this.adapterRef.isAudioBanned||this.adapterRef.isVideoBanned||this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!1,isVideoBanned:!1}),!this.adapterRef.localStream)return}else this.logger.error(`收到OnUserData通知消息 type = ${b}, data: `,E);break}case"OnAsrData":{const{externData:b}=w.data;this.adapterRef.instance.safeEmit("asr-captions",b);break}}}_handleFailed(){this.logger.log("Signalling:_handleFailed")}_handleClose(){}_isProtooDetached(R){var w,k,I;return this._protoo?this._protoo.id!==R.id?(this.logger.warn(`Protoo is detached: ${R.id} => ${this._protoo.id}`),!0):((w=this.adapterRef._signalling)===null||w===void 0?void 0:w.signallingId)!==this.signallingId&&(this.logger.warn(`Protoo.signaling is detached: ${this._protoo.id} => ${(I=(k=this.adapterRef._signalling)===null||k===void 0?void 0:k._protoo)===null||I===void 0?void 0:I.id}`),!0):(this.logger.warn("Protoo is destroyed: "+R.id),!0)}_handleDisconnected(R){var w,k,I,M;this.logger.log("Signalling:_handleDisconnected"),this.adapterRef.instance.outOfConnect||(!this._reconnectionTimer||this.adapterRef.channelStatus!=="connectioning"&&this.adapterRef.channelStatus!=="join"?(this.logger.warn(`信令通道#${R.id}_${(M=R._transport)===null||M===void 0?void 0:M.wsid} 收到关闭信号，即将开始重连过程。`),this.adapterRef.channelStatus="connectioning",this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startWssTime=Date.now(),this._reconnection()):R.closed?this.logger.warn(`信令通道#${R.id}_${(w=R._transport)===null||w===void 0?void 0:w.wsid} 在建立过程中被关闭。当前正在重连中，等待下次重连过程。`):this.logger.warn(`信令通道#${R.id}_${(k=R._transport)===null||k===void 0?void 0:k.wsid} 在建立过程中被关闭。信令通道会自动重试。连接地址：${(I=R._transport)===null||I===void 0?void 0:I._url}`),this.reconnectionReason=c.ReconnectReason.WebsocketDisconnect,this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"websocketDisconnect",ext:""}))}async _handleOpen(R){var w,k,I,M;if(R&&this._isProtooDetached(R))return;if(this.joinTimestamps.push(Date.now()),this.joinTimestamps.length>4&&this.joinTimestamps.shift(),this.joinTimestamps.length>=4&&this.joinTimestamps[3]-this.joinTimestamps[0]<1e3)return void this.logger.error("signaling.join: 在1秒以内连续发生了 4 次Join事件, 异常退出。");let P;this.adapterRef.state.signalOpenTime=Date.now(),this.adapterRef.state.signalWebsocketOpenRtt=this.adapterRef.state.signalOpenTime-this.adapterRef.state.signalEstablishTime,this._reconnectionTimer&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null),this.reconnectionMaxTimeoutTimer&&clearTimeout(this.reconnectionMaxTimeoutTimer),this.reconnectionMaxTimeoutTimer=null,P=!!this.adapterRef.encryption.encryptionSecret&&this.adapterRef.encryption.encryptionMode!=="none";const S={method:"Join",permKeySecret:this.adapterRef.channelInfo.permKey,requestId:""+Math.ceil(1e9*Math.random()),supportStdRed:!0,supportTurn:!this.adapterRef.proxyServer.enable,externData:{requestStunServers:!(!v.ANDROID_VERSION||v.ANDROID_VERSION.indexOf("11")!==0),userName:""+this.adapterRef.channelInfo.uid,token:this.adapterRef.channelInfo.token,cname:""+this.adapterRef.channelInfo.channelName,subType:"select",role:"part",version:"2.0",sessionMode:"meeting",engineVersion:n.ENGINE_VERSION,userRole:this.adapterRef.instance._roleInfo.userRole,userType:m.getParameters().userType,platformType:16,rtmp:{support:this.adapterRef.channelInfo.sessionConfig.liveEnable},record:{host:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,supportVideo:this.adapterRef.channelInfo.sessionConfig.recordVideo,supportAuido:this.adapterRef.channelInfo.sessionConfig.recordAudio,recordType:this.adapterRef.channelInfo.sessionConfig.recordType-0},mediaCapabilitySet:this.adapterRef.mediaCapability.stringify(),browser:{name:o.getBrowserInfo().browserName,version:""+o.getBrowserInfo().browserVersion},customData:this.adapterRef.channelInfo.customData||"",gmEnable:P,gmMode:f.encryptionModeToInt(this.adapterRef.encryption.encryptionMode),gmKey:this.adapterRef.encryption.encryptionSecret,customEncryption:!m.getParameters().forceCustomEncryptionOff&&this.adapterRef.encryption.encodedInsertableStreams,userPriority:this.adapterRef.userPriority,supportTmmbrFeedback:!0}};if(((w=this.adapterRef._signalling)===null||w===void 0?void 0:w.signallingId)===this.signallingId){this.logger.log("signaling.join: socket连接成功，开始发送Join请求"),(k=this._protoo)===null||k===void 0||k.clear();try{let y=null,_=this._protoo;const b=Date.now();try{const V=(I=this._protoo)===null||I===void 0?void 0:I.request("Join",S);this.adapterRef.channelStatus==="connectioning"?this.adapterRef.instance.apiEventReport("setConnectionStateChange",{state:c.ConStateChange_state.ChannelRejoining,reason:c.ConStateChange_reason.Join}):this.adapterRef.channelStatus==="join"&&this.adapterRef.instance.apiEventReport("setConnectionStateChange",{state:c.ConStateChange_state.ChannelJoining,reason:c.ConStateChange_reason.Join}),!this.adapterRef.signalProbeManager.worker&&m.getParameters().signalProbeEnabled&&this.adapterRef.signalProbeManager.start(this.adapterRef.channelInfo.wssArr),y=await V,this.adapterRef.state.signalJoinResTime=Date.now(),this.adapterRef.state.signalJoinMsgRtt=this.adapterRef.state.signalJoinResTime-b}catch(V){if(_!==this._protoo)return void this.logger.warn(`Signalling.Join 过期的信令通道消息：【${V.name}】`,V.message);throw this.logger.warn("Signalling.Join Login request error: ",V.message),this.adapterRef.instance.apiEventReport("setConnectionStateChange",{state:c.ConStateChange_state.ChannelJoinFailed,reason:c.ConStateChange_reason.JoinChannelFailed}),new d.default({code:s.default.LOGIN_REQUEST_ERROR,message:V.message})}if(this._isProtooDetached(R))return;if(this.logger.log("Signalling.Join 请求收到response"),y.code!=200){let V="Unknown Error";return y.externData?V=y.externData.errMsg:y.errMsg&&(V=y.errMsg),this.logger.error(`Signalling.Join: 加入房间失败, code = ${y.code}, reason = ${V}`),this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-error"),this.adapterRef.instance.apiEventReport("setConnectionStateChange",{state:c.ConStateChange_state.ChannelJoinFailed,reason:c.ConStateChange_reason.RequestChannelFailed}),void this._joinFailed(y.code,V)}let E=this.adapterRef.channelInfo.uid;y.PermKey&&(this.adapterRef.permKeyInfo=y.PermKey),y.externData.audioRight===1?(this.adapterRef.isAudioBanned=!0,this.adapterRef.instance.safeEmit("audioVideoBanned",{uid:E,mediaType:"audio",state:!0})):this.adapterRef.isAudioBanned=!1,y.externData.videoRight===1?(this.adapterRef.isVideoBanned=!0,this.adapterRef.isAudioBanned=!0,this.adapterRef.instance.safeEmit("audioVideoBanned",{uid:E,mediaType:"audio",state:!0})):this.adapterRef.isVideoBanned=!1,this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!!this.adapterRef.isAudioBanned,isVideoBanned:!!this.adapterRef.isVideoBanned}),this.adapterRef.isAudioBanned&&this.adapterRef.isVideoBanned&&this.logger.warn("Signalling.Join 服务器禁止发送音频流"),this.reconnectionControl.next=null,this.logger.log("Signalling.Join: 加入房间成功",this.adapterRef.channelStatus),this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="CONNECTED",m.getParameters().forceBWE==="no"?y.preferRemb?(this.logger.log("Signalling.Join 服务端配置bwe：上行使用remb"),this.adapterRef.preferRemb=!0):(this.logger.log("Signalling.Join 服务端配置bwe：上行使用transport-cc"),this.adapterRef.preferRemb=!1):(this.adapterRef.preferRemb||y.preferRemb)&&m.getParameters().forceBWE==="transport-cc"?(this.logger.warn("Signalling.Join 强行使用transport-cc。忽略服务端配置bwe：preferRemb: "+y.preferRemb),this.adapterRef.preferRemb=!1):m.getParameters().forceBWE==="remb"&&(this.logger.warn("Signalling.Join 强行使用REMB。忽略服务端配置bwe：preferRemb: "+y.preferRemb),this.adapterRef.preferRemb=!0),this.adapterRef.audioAsl.enabled=y.supportWebAsl?"yes":"no",this.adapterRef.audioAsl.aslActiveNum=y.aslActiveNum,y.supportWebAsl?y.aslActiveNum?this.logger.log("Signalling.Join aslActiveNum数量: "+y.aslActiveNum):this.logger.warn("Signalling.Join 服务端支持ASL但没有返回ASL数量"):this.logger.log("Signalling.Join 服务端未开启ASL"),this.adapterRef.instance.safeEmit("aslStatus",{enabled:!!y.supportWebAsl,aslActiveNum:y.aslActiveNum});const x=this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2;if(this.joinFailedServers.pop(),this.adapterRef.channelStatus==="connectioning"){if(this.adapterRef.instance.apiEventReport("setConnectionStateChange",{state:c.ConStateChange_state.ChannelJoined,reason:c.ConStateChange_reason.ReJoinSucceed}),this.adapterRef.connectState.reconnect=!0,this.logger.log("Signalling.Join: 重连成功, 清除之前的媒体的通道"),(M=this._protoo)===null||M===void 0||M.clear(),this.adapterRef.channelStatus="join",this.adapterRef.instance.apiEventReport("setRelogin",{a_record:this.adapterRef.channelInfo.sessionConfig.recordAudio,v_record:this.adapterRef.channelInfo.sessionConfig.recordVideo,record_type:this.adapterRef.channelInfo.sessionConfig.recordType,host_speaker:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,permKey:this.adapterRef.channelInfo.permKey,result:0,reason:this.reconnectionReason,server_ip:this.adapterRef.channelInfo._protooUrl,signalling_rtt:this.adapterRef.state.signalJoinMsgRtt,time_elapsed_for_signaling_connect:b-x.startWssTime,join_failed_server:this.joinFailedServers}),this.joinFailedServers.length=0,this.adapterRef.instance.resetChannel(),!this.adapterRef._mediasoup)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"signalling_join: 媒体服务异常 1"});this.adapterRef._mediasoup._edgeRtpCapabilities=y.edgeRtpCapabilities,this.adapterRef.mediaCapability.parseRoom(y.externData.roomCapability),this.adapterRef.instance.safeEmit("@mediaCapabilityChange"),await this.adapterRef._mediasoup.init(y.stunServers),this.adapterRef.asrCaptionConfig.enable&&(this.logger.log(`Signalling.Join 重连后再次发送startCaptions, source: ${this.adapterRef.asrCaptionConfig.source}, target: ${this.adapterRef.asrCaptionConfig.target}`),this.adapterRef.instance.startAsrCaptions(this.adapterRef.asrCaptionConfig.source,this.adapterRef.asrCaptionConfig.target)),this.adapterRef.localStream?this.adapterRef.localStream.audio||this.adapterRef.localStream.video||this.adapterRef.localStream.screen||this.adapterRef.localStream.screenAudio||m.getParameters().allowEmptyMedia||this.adapterRef.localStream.audioSlave?(this.logger.log(`Signalling.Join 重连成功, 重新publish本端流: audio ${this.adapterRef.localStream.hasAudio()}, video ${this.adapterRef.localStream.hasVideo()}, screen ${this.adapterRef.localStream.hasScreen()}, audioSlave ${this.adapterRef.localStream.hasAudioSlave()}`),this.adapterRef.instance.doPublish(this.adapterRef.localStream,"all")):this.logger.log("Signalling.Join 重连成功，当前没有媒体流，无需发布"):this.logger.log("Signalling.Join 重连成功, 当前在未发布状态, 无需发布")}else{this.adapterRef.instance.apiEventReport("setConnectionStateChange",{state:c.ConStateChange_state.ChannelJoined,reason:c.ConStateChange_reason.JoinSucceed}),this.adapterRef.connectState.reconnect=!1;const V=Date.now();if(this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.joinedSuccessedTime=V,this.adapterRef.instance.apiEventReport("setLogin",{a_record:this.adapterRef.channelInfo.sessionConfig.recordAudio,v_record:this.adapterRef.channelInfo.sessionConfig.recordVideo,record_type:this.adapterRef.channelInfo.sessionConfig.recordType,host_speaker:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,permKey:this.adapterRef.channelInfo.permKey,result:0,server_ip:this.adapterRef.channelInfo._protooUrl,signalling_rtt:this.adapterRef.state.signalJoinMsgRtt,signalling_time:this.adapterRef.state.getChannelInfoRtt,time_elapsed_for_signaling_connect:b-x.startWssTime,time_elapsed:V-x.startJoinTime,model:this.browserDevice,join_failed_server:this.joinFailedServers}),this.joinFailedServers.length=0,!this.adapterRef._mediasoup)throw new d.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"signalling_join: 媒体服务异常 2"});this.adapterRef._mediasoup._edgeRtpCapabilities=y.edgeRtpCapabilities,this.adapterRef.mediaCapability.parseRoom(y.externData.roomCapability),this.adapterRef.instance.safeEmit("@mediaCapabilityChange"),await this.adapterRef._mediasoup.init(y.stunServers)}this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.logger.log("Signalling.Join 查看房间其他人的发布信息: "+JSON.stringify(y.externData.userList));const D=[];if(y.externData!==void 0&&y.externData.userList&&y.externData.userList.length){let V=this;for(const N of y.externData.userList){let L=N.uid;this.adapterRef.channelInfo.uidType==="string"&&(L=L.toString());let U=this.adapterRef.remoteStreamMap[L];if(U?(U.active=!0,this.adapterRef.memberMap[L]=""+L,D.push({eventName:"peer-online",eventData:{uid:L}})):(U=new l.RemoteStream({uid:L,audio:!1,audioSlave:!1,video:!1,screen:!1,videoThird:!1,videoFourth:!1,client:this.adapterRef.instance,platformType:N.platformType}),this.adapterRef.remoteStreamMap[L]=U,this.adapterRef.memberMap[L]=""+L,D.push({eventName:"peer-online",eventData:{uid:L}})),N.customData&&D.push({eventName:"custom-data",eventData:{uid:L,customData:N.customData}}),N.producerInfoList)for(const H of N.producerInfoList){const{mediaType:j,producerId:W,mute:Y,simulcastEnable:te,spatialLayerCount:re}=H;let G;switch(j){case"screenShare":G="screen";break;case"subAudio":G="audioSlave";break;case"audio":case"video":case"videoThird":case"videoFourth":G=j;break;default:return void this.logger.warn(`OnNewProducer 不支持的媒体类型:${j}, uid ${L}`)}if(U[G]=!0,U.pubStatus[G][G]=!0,U.pubStatus[G].producerId=W,U.pubStatus[G].mute=Y,U.muteStatus[G].send=Y,U.pubStatus[G].simulcastEnable=te,G!=="video"&&G!=="screen"&&G!=="videoThird"&&G!=="videoFourth"||(U.spatialLayerCount[G]=re),V.logger.log(`Signalling.Join: 通知 ${U.getId()} 发布信息: ${JSON.stringify(U.pubStatus,null,"")}`),(U.pubStatus.audio.audio||U.pubStatus.video.video||U.pubStatus.screen.screen||U.pubStatus.audioSlave.audioSlave||U.pubStatus.videoThird.videoThird||U.pubStatus.videoFourth.videoFourth)&&D.push({eventName:"stream-added",eventData:{stream:U,mediaType:G,dualStream:re>1}}),Y){let K="";K=G==="audioSlave"?"mute-audio-slave":G==="videoThird"?"mute-video-thrid":G==="videoFourth"?"mute-video-fourth":"mute-"+G,D.push({eventName:K,eventData:{uid:U.getId()}})}}}for(let N in this.adapterRef.remoteStreamMap)this.adapterRef.remoteStreamMap[N].active||(this.logger.warn("Signalling.Join 重连期间远端流停止发布："+N),delete this.adapterRef.remoteStreamMap[N])}const F=this.adapterRef.instance;setTimeout(()=>{for(let V=0;V<D.length;V++){const N=D[V].eventName,L=D[V].eventData;F&&(N==="stream-added"&&(L.mediaType==="audio"?F.adapterRef.state.signalAudioAddedTime<F.adapterRef.state.signalOpenTime&&(F.adapterRef.state.signalAudioAddedTime=Date.now()):L.mediaType==="video"&&F.adapterRef.state.signalVideoAddedTime<F.adapterRef.state.signalOpenTime&&(F.adapterRef.state.signalVideoAddedTime=Date.now())),F.safeEmit(N,L))}},0),this.adapterRef.state.signalJoinSuccessTime=Date.now(),this._resolve?(this.logger.log("Signalling.Join 加入房间成功, 反馈通知"),this._resolve(y),this._resolve=null,this._reject=null):this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-success"),this.doSendKeepAliveTask()}catch(y){this.logger.error("Signalling.Join: 登录流程内部错误: ",y.message),this._joinFailed(-1,y.message||"LOGIN_ERROR")}}}_joinFailed(R,w){this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.channelStatus="init",this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),R===4009&&this.adapterRef.instance.safeEmit("crypt-error",{cryptType:this.adapterRef.encryption.encryptionMode});const k=Date.now(),I=this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2;if(this.adapterRef.instance.apiEventReport("setLogin",{a_record:this.adapterRef.channelInfo.sessionConfig.recordAudio,v_record:this.adapterRef.channelInfo.sessionConfig.recordVideo,record_type:this.adapterRef.channelInfo.sessionConfig.recordType,host_speaker:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,permKey:this.adapterRef.channelInfo.permKey,result:R,server_ip:this.adapterRef.channelInfo._protooUrl,signalling_rtt:this.adapterRef.state.signalJoinMsgRtt,signalling_time:I.startWssTime-I.startJoinTime,time_elapsed:k-I.startJoinTime,join_failed_server:this.joinFailedServers,model:this.browserDevice,desc:w||""}),this.joinFailedServers.length=0,this._reject)this.logger.error("Signalling.Join 加入房间失败, 反馈通知"),this._reject(new d.default({code:s.default.SERVER_AUTH_ERROR,extraCode:R,message:w||"join failed"})),this._resolve=null,this._reject=null,this.keepAliveTimer&&(clearInterval(this.keepAliveTimer),this.keepAliveTimer=null),this.adapterRef.channelStatus="leave",this.adapterRef.instance.stopSession();else{switch(w){case"room not found":this.logger.error("Signalling.Join 网络重连时，加入房间失败，主动离开。重连失败原因：",w,"，这通常是因为房间内其他人都已离开，房间关闭引起的");break;default:this.logger.error("Signalling.Join 网络重连时，加入房间失败，主动离开。重连失败原因：",w)}this.adapterRef.instance.safeEmit("error","RELOGIN_ERROR"),this.adapterRef.instance.leave(s.default.LOGIN_FAILED)}}doSendKeepAliveTask(){this.keepAliveTimer&&(clearInterval(this.keepAliveTimer),this.keepAliveTimer=null);let R=!1;this.keepAliveTimer=setInterval(async()=>{R||(R=!0,await this.doSendKeepAlive(),R=!1)},6e3)}async doSendKeepAlive(){var R,w;if(!(!((R=this._protoo)===null||R===void 0)&&R.connected))return;this._protoo.id,(w=this._protoo._transport)===null||w===void 0||w.wsid;const k=Date.now();try{await this._protoo.request("Heartbeat")}catch(I){this.logger.error(`信令包保活失败, reason: ${I.message}, ${Date.now()-k}ms`)}}async updatePermKey(R){var w;if(this.logger.log("updatePermKey newwork isConnect: ",(w=this._protoo)===null||w===void 0?void 0:w.connected),!this._protoo||!this._protoo.connected)return;const k=await this._protoo.request("PermKeyUpdate",{requestId:""+Math.ceil(1e9*Math.random()),permKeySecret:R});k.code!==200?new d.default({code:s.default.UPDATE_PERMKEY_ERROR,extraCode:k.code,message:"update permkey 认证错误"}):this.adapterRef.permKeyInfo=k.PermKey}updateMaskStatus(){var R,w,k;let I=Date.now();for(let P=this.autoMask.data.length-1;P>=0;P--){let S=this.autoMask.data[P];if(I>=S.targetEndMs){if(this.adapterRef.channelInfo.uid===S.maskUid&&this.adapterRef.localStream)this.logger.log("updateMaskStatus 本地用户去除打码",S.maskUid),(R=this.adapterRef.localStream._play)===null||R===void 0||R.disableMask();else{const y=this.adapterRef.remoteStreamMap[S.maskUid];y&&(!((w=y._play)===null||w===void 0)&&w.mask.enabled)&&(this.logger.log("updateMaskStatus 远端用户去除打码",S.maskUid),y._play.disableMask())}this.autoMask.data.splice(P,1)}}let M=Number.MAX_SAFE_INTEGER;for(let P=0;P<this.autoMask.data.length;P++){let S=this.autoMask.data[P];if(M=Math.min(M,S.targetEndMs),this.adapterRef.channelInfo.uid==S.maskUid&&this.adapterRef.localStream)this.logger.log("updateMaskStatus 本地用户增加打码",S.maskUid),(k=this.adapterRef.localStream._play)===null||k===void 0||k.enableMask();else{const y=this.adapterRef.remoteStreamMap[S.maskUid];y?y._play&&!y._play.mask.enabled&&(this.logger.log("updateMaskStatus 远端用户增加打码",S.maskUid,"打码时长",S.duration,"秒"),y._play.enableMask()):this.logger.log("updateMaskStatus 远端用户不在频道中",S.maskUid,"打码时长",S.duration,"秒")}}this.autoMask.timer&&clearTimeout(this.autoMask.timer),this.autoMask.timer=setTimeout(()=>{this.updateMaskStatus()},M-I)}async doSendLogout(){if(this.logger.log("doSendLogout() begin"),this.keepAliveTimer&&(clearInterval(this.keepAliveTimer),this.keepAliveTimer=null),!this._protoo||!this._protoo.connected)return;let R={requestId:""+Math.ceil(1e9*Math.random()),externData:{reason:0}};this._protoo.notify("Leave",R),this.logger.log("doSendLogout() success")}_handleStreamStatusNotify(R){}_handleNetStatusNotify(R){const w=R.netStatusList;let k=u.parseBase64(w).toString(),I=[],M=k.substr(2,2)+k.substr(0,2);M=parseInt(M,16),k=k.substr(4);for(let b=0;b<M;b++){let E=k.substr(0,16);E=P(E);const x=k.substr(16,2),D=k.substr(18,2);let F=0;if(k.substr(20,2)!="00"){const N=k.substr(22,2);F=parseInt(N,16),k.substr(24,F),F++}const V={uid:this.adapterRef.channelInfo.uidType==="string"?g.SimpleBig.fromHex(E).toString():parseInt(E,16),downlinkNetworkQuality:parseInt(x,16),uplinkNetworkQuality:parseInt(D,16),receiveTs:Date.now()};I.push(V),k=k.substr(22+F)}function P(b){let E=[];for(var x=b.length;x>=1;x-=2)E.push(b[x-2],b[x-1]);return E.join("")}let S=!0,y=[];I=I.filter(b=>b.uid!=0),this.adapterRef.netStatusList.map(b=>{S=!0,I.map(E=>{b.uid!=E.uid&&E.uid!=0||(S=!1)}),S&&y.push(b)});let _=y.concat(I);_=_.filter(b=>this.adapterRef.memberMap[b.uid]||b.uid==this.adapterRef.channelInfo.uid),this.adapterRef.netStatusList=_,this.adapterRef.instance.safeEmit("network-quality",this.adapterRef.netStatusList)}_handleMuteNotify(R){const w=R.producerId,k=R.mute;Object.values(this.adapterRef.remoteStreamMap).forEach(I=>{c.MediaTypeList.forEach(M=>{I.pubStatus[M].producerId===w&&(I.muteStatus[M].send=k,k?M==="audioSlave"?this.adapterRef.instance.safeEmit("mute-audio-slave",{uid:I.getId()}):this.adapterRef.instance.safeEmit("mute-"+M,{uid:I.getId()}):M==="audioSlave"?this.adapterRef.instance.safeEmit("unmute-audio-slave",{uid:I.getId()}):this.adapterRef.instance.safeEmit("unmute-"+M,{uid:I.getId()}))})})}_handleUserRoleNotify(R){let w=R.uid;this.adapterRef.channelInfo.uidType==="string"&&(w=w.toString());const k=R.data&&R.data.userRole;if(this.logger.warn(`用户${w}角色变为${k?"观众":"主播"}`),w&&k===1&&(this.adapterRef.instance.clearMember(w,0),this.adapterRef.instance.removeSsrc(w),this.adapterRef.instance._roleInfo.audienceList[w]=!0),w&&k===0){this.adapterRef.instance.safeEmit("peer-online",{uid:w});let I=this.adapterRef.remoteStreamMap[w];I?I.active=!0:(I=new l.RemoteStream({uid:w,audio:!1,audioSlave:!1,video:!1,screen:!1,videoThird:!1,videoFourth:!1,client:this.adapterRef.instance,platformType:R.platformType}),this.adapterRef.remoteStreamMap[w]=I,this.adapterRef.memberMap[w]=w),this.adapterRef.instance._roleInfo.audienceList[w]=!1}}_handleAbility(R){this.adapterRef.instance.safeEmit("warning",{code:R.code,msg:R.msg})}_handleKickedNotify(R,w=this.adapterRef.channelInfo.uid){this.adapterRef.channelInfo.uidType==="string"&&(w=w.toString()),R==1?(this.logger.warn("房间被关闭"),this.adapterRef.instance.outOfConnect=!0,this.adapterRef.instance.apiEventReport("setConnectionStateChange",{state:c.ConStateChange_state.ChannelLeave,reason:c.ConStateChange_reason.Closed}),this.adapterRef.instance.leave(s.default.CHANNEL_CLOSED),this.adapterRef.instance.safeEmit("channel-closed",{})):R==2?(this.logger.warn(w+"被踢出房间"),this.adapterRef.instance.outOfConnect=!0,w.toString()==this.adapterRef.channelInfo.uid.toString()&&(this.adapterRef.instance.apiEventReport("setConnectionStateChange",{state:c.ConStateChange_state.ChannelLeave,reason:c.ConStateChange_reason.BeKicked}),this.adapterRef.instance.leave(s.default.CLIENT_BANNED)),this.adapterRef.instance.safeEmit("client-banned",{uid:w})):R==5&&(this.logger.warn(w+" permKey 超时被踢出房间"),this.adapterRef.instance.outOfConnect=!0,w.toString()==this.adapterRef.channelInfo.uid.toString()&&(this.adapterRef.instance.apiEventReport("setConnectionStateChange",{state:c.ConStateChange_state.ChannelLeave,reason:c.ConStateChange_reason.TimeOut}),this.adapterRef.instance.leave(s.default.PERMKEY_TIMEOUT)),this.adapterRef.instance.safeEmit("permkey-timeout",{uid:w}))}destroy(){this.logger.log("清除 Signalling"),this._destroyProtoo(),this._reset()}}e.Signalling=C},function(module,exports,__webpack_require__){var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.RemoteStream=void 0;const videoQuality_1=__webpack_require__(69),alerter_1=__webpack_require__(142),media_1=__webpack_require__(193),parameters_1=__webpack_require__(1),play_1=__webpack_require__(195),record_1=__webpack_require__(147),types_1=__webpack_require__(48),errorCode_1=__importDefault(__webpack_require__(6)),rtcError_1=__importDefault(__webpack_require__(8)),param_1=__webpack_require__(49),RTCEventEmitter_1=__webpack_require__(46),webAudio_1=__webpack_require__(47),Config_1=__webpack_require__(26),StageAIProcessing_1=__webpack_require__(198),plugin_1=__webpack_require__(200),plugin_list_1=__webpack_require__(155);let remoteStreamCnt=0;class RemoteStream extends RTCEventEmitter_1.RTCEventEmitter{constructor(t){if(super(),this.audioLevelHelper=null,this.platformType=types_1.PlatformType.unknown,this.isRemote=!0,this.__v_skip=parameters_1.getParameters().enableVSkip,this.pubStatus={audio:{audio:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},audioSlave:{audioSlave:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},video:{video:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},screen:{screen:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},videoThird:{videoThird:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},videoFourth:{videoFourth:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1}},this.subStatus={audio:!1,audioSlave:!1,video:!1,screen:!1,videoThird:!1,videoFourth:!1},this.muteStatus={audio:{send:!1,recv:!1},audioSlave:{send:!1,recv:!1},video:{send:!1,recv:!1},screen:{send:!1,recv:!1},videoThird:{send:!1,recv:!1},videoFourth:{send:!1,recv:!1}},this.active=!0,this.destroyed=!1,this.spatialPosition={x:0,y:0},this.spatialLayerCount={video:0,screen:0,videoThird:0,videoFourth:0},this.supportWasm=!0,this.supportAIAudioEffects=!0,this.canEnableAIAudioEffects=!0,this.remoteStreamId=remoteStreamCnt++,this.streamID=t.uid,this.stringStreamID=this.streamID.toString(),this.platformType=t.platformType,this.logger=t.client.adapterRef.logger.getChild(()=>{var e;let r="remote#"+this.stringStreamID;return types_1.PlatformTypeMap[this.platformType]&&(r+=" "+types_1.PlatformTypeMap[this.platformType]),r+=this.remoteStreamId,this.pubStatus.audio.consumerId?r+="M":this.pubStatus.audio.producerId&&(r+="m"),this.pubStatus.video.consumerId?r+="C":this.pubStatus.video.producerId&&(r+="c"),this.pubStatus.screen.consumerId?r+="S":this.pubStatus.screen.producerId&&(r+="s"),((e=t.client.adapterRef.remoteStreamMap[this.streamID])===null||e===void 0?void 0:e.remoteStreamId)!==this.remoteStreamId&&(r+=" DETACHED"),r}),typeof t.uid=="string")t.client.adapterRef.channelInfo.uidType="string";else{if(typeof t.uid!="number")throw this.logger.error("remoteSteram: uid参数格式非法"),new rtcError_1.default({code:errorCode_1.default.STREAM_UID_ERROR,message:"remoteSteram: uid参数格式非法"});if(t.client.adapterRef.channelInfo.uidType="number",t.uid>Number.MAX_SAFE_INTEGER)throw this.logger.error("remoteSteram: uid超出number类型精度"),new rtcError_1.default({code:errorCode_1.default.STREAM_UID_ERROR,message:"Number 类型的 uid 最大值是 2^53 - 1， 请输入正确的参数"})}this.videoView=null,this.screenView=null,this.renderMode={remote:{video:{},screen:{},videoThird:{},videoFourth:{}}},this.subConf={audio:!0,audioSlave:!0,video:!0,screen:!0,videoThird:!0,videoFourth:!0,highOrLow:{video:videoQuality_1.STREAM_TYPE.HIGH,screen:videoQuality_1.STREAM_TYPE.HIGH,videoThird:videoQuality_1.STREAM_TYPE.HIGH,videoFourth:videoQuality_1.STREAM_TYPE.HIGH}},this.renderMode={remote:{video:{},screen:{},videoThird:{},videoFourth:{}}},this._reset(),this.streamID=t.uid,this.stringStreamID=this.streamID.toString(),this.audio=t.audio,this.audioSlave=t.audioSlave||!1,this.video=t.video||!1,this.screen=t.screen||!1,this.videoThird=t.videoThird||!1,this.videoFourth=t.videoFourth||!1,this.client=t.client,this.mediaHelper=new media_1.MediaHelper({stream:this}),this._play=new play_1.Play({stream:this}),this._record=new record_1.Record({logger:this.logger,client:this.client}),parameters_1.getParameters().enableAlerter!=="never"&&alerter_1.alerter.watchRemoteStream(this),this.client.apiFrequencyControl({name:"createRemoteStream",code:0,param:{streamID:this.stringStreamID,isRemote:!0,clientUid:this.client.adapterRef.channelInfo.uid||""}})}_reset(){var t,e,r;this.audio=!1,this.audioSlave=!1,this.video=!1,this.screen=!1,this.videoView=null,this.screenView=null,this.renderMode={remote:{video:{},screen:{},videoThird:{},videoFourth:{}}},this.pubStatus={audio:{audio:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},audioSlave:{audioSlave:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},video:{video:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},screen:{screen:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},videoThird:{videoThird:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},videoFourth:{videoFourth:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1}},this.subConf={audio:!0,audioSlave:!0,video:!0,screen:!0,videoThird:!0,videoFourth:!0,highOrLow:{video:videoQuality_1.STREAM_TYPE.HIGH,screen:videoQuality_1.STREAM_TYPE.HIGH,videoThird:videoQuality_1.STREAM_TYPE.HIGH,videoFourth:videoQuality_1.STREAM_TYPE.HIGH}},this.subStatus={audio:!1,audioSlave:!1,video:!1,screen:!1,videoThird:!1,videoFourth:!1},this.muteStatus={audio:{send:!1,recv:!1},audioSlave:{send:!1,recv:!1},video:{send:!1,recv:!1},screen:{send:!1,recv:!1},videoThird:{send:!1,recv:!1},videoFourth:{send:!1,recv:!1}},this.renderMode={remote:{video:{},screen:{},videoThird:{},videoFourth:{}}},this.mediaHelper&&this.mediaHelper.destroy(),this._play&&this._play.destroy(),this._record&&this._record.destroy(),this._record=null,!((r=(e=(t=this.mediaHelper)===null||t===void 0?void 0:t.audio)===null||e===void 0?void 0:e.stageAIProcessing)===null||r===void 0)&&r.hasWorkingPlugin()&&this.unregisterPlugin("AIAudioEffects")}get Play(){return this._play}get Record(){return this._record}getId(){return this.client.adapterRef.channelInfo.uidType==="string"?this.stringStreamID:this.streamID}doSetSubscribeConfig(t){const e=Object.assign({},this.subConf);e.highOrLow=Object.assign({},this.subConf.highOrLow);for(let a of types_1.MediaTypeListAudio){const l=t[a];typeof l=="boolean"&&(this.subConf[a]=l)}for(let a of types_1.MediaTypeListVideo){const l=t[a];t.highOrLow&&(this.subConf.highOrLow[a]=t.highOrLow),l==="high"||l==="low"?(this.subConf[a]=!0,this.subConf.highOrLow[a]=videoQuality_1.STREAM_TYPE[l==="high"?"HIGH":"LOW"]):typeof l=="boolean"&&(this.subConf[a]=l)}this.pubStatus.audio.audio&&this.subConf.audio?(this.subConf.audio=!0,this.audio=!0):this.subConf.audio=!1,this.pubStatus.audioSlave.audioSlave&&this.subConf.audioSlave?(this.subConf.audioSlave=!0,this.audioSlave=!0):this.subConf.audioSlave=!1,this.pubStatus.video.video&&this.subConf.video?(this.subConf.video=!0,this.video=!0):this.subConf.video=!1,this.pubStatus.screen.screen&&this.subConf.screen?(this.subConf.screen=!0,this.screen=!0):this.subConf.screen=!1;let r="doSetSubscribeConfig",i=!1;for(let a of types_1.MediaTypeList)r+=` ${a}:${e[a]}`,e[a]!==this.subConf[a]&&(r+="=>"+this.subConf[a],i=!0),a!=="video"&&a!=="screen"||(r+=" "+videoQuality_1.STREAM_TYPE_REV[e.highOrLow[a]],e.highOrLow[a]!==this.subConf.highOrLow[a]&&(r+="=>"+videoQuality_1.STREAM_TYPE_REV[this.subConf.highOrLow[a]],i=!0));i||(r+="【Unchanged】"),this.logger.log(r)}setSubscribeConfig(t){if(this.logger.log(`setSubscribeConfig() 设置 ${this.stringStreamID} 订阅规则：${JSON.stringify(t)}`),this.doSetSubscribeConfig(t),this.logger.log(`setSubscribeConfig() 设置 ${this.stringStreamID} 订阅规则结果：${JSON.stringify(this.subConf)}`),this.client.apiFrequencyControl({name:"setSubscribeConfig",code:0,param:{streamID:this.stringStreamID,isRemote:!0,conf:Object.assign({},this.subConf)}}),this.pubStatus.screen.screen){const e={uid:this.client.adapterRef.channelInfo.uidType==="string"?this.stringStreamID:this.streamID,subscribe:this.subConf.screen};this.client.apiFrequencyControl({name:"subscribeRemoteSubStreamVideo",code:0,param:JSON.stringify(e,null," ")})}}getAudioStream(){return this.client.apiFrequencyControl({name:"getAudioStream",code:0,param:JSON.stringify({isRemote:!0,streamID:this.getId()},null," ")}),this.mediaHelper.audio.audioStream}getAudioTrack(){return this.mediaHelper.audio.audioStream.getAudioTracks()[0]||null}getVideoTrack(){return this.mediaHelper.video.videoStream.getVideoTracks()[0]||null}getScreenTrack(){return this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0]||null}getAudioSlaveTrack(){return this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks()[0]||null}getVideoThirdTrack(){return this.mediaHelper.videoThird.videoThirdStream.getVideoTracks()[0]||null}getVideoFourthTrack(){return this.mediaHelper.videoFourth.videoFourthStream.getVideoTracks()[0]||null}async play(t,e={}){var r,i,a;if((e.video||e.screen||e.videoThird||e.videoFourth)&&!t)throw this.logger.warn(`play() remoteStream ${this.getId()} 播放视频没有指定div标签`),new rtcError_1.default({code:errorCode_1.default.STREAM_PLAY_ARGUMENT_ERROR,message:"play() 播放视频没有指定div标签"});if(param_1.isExistOptions({tag:"Stream.playOptions.audio",value:e.audio}).result||(e.audio=!0),param_1.isExistOptions({tag:"Stream.playOptions.audioSlave",value:e.audioSlave}).result||(e.audioSlave=!0),param_1.isExistOptions({tag:"Stream.playOptions.video",value:e.video}).result||(e.video=!0),param_1.isExistOptions({tag:"Stream.playOptions.screen",value:e.screen}).result||(e.screen=!0),param_1.isExistOptions({tag:"Stream.playOptions.videoThird",value:e.videoThird}).result||(e.videoThird=!0),param_1.isExistOptions({tag:"Stream.playOptions.videoFourth",value:e.videoFourth}).result||(e.videoFourth=!0),this.logger.log(`play() uid ${this.stringStreamID} 播放, playOptions:${JSON.stringify(e)}`),e.audio&&this._play&&this.mediaHelper.audio.audioStream.getTracks().length)if(this.client.spatialManager)this.logger.log("[play] 启用了空间音频，跳过本地音频播放。");else{this.logger.log(`[play] uid ${this.stringStreamID} 开始播放远端音频`);try{this.client.adapterRef.enableMixAudio?!((r=this.client.adapterRef.audioMixer)===null||r===void 0)&&r.getAudioContext()?await((i=this.client.adapterRef.audioMixer)===null||i===void 0?void 0:i.addStream(this.mediaHelper.audio.audioStream)):this.logger.error("play() 未找到AudioContext"):await this._play.playAudioStream("audio",this.mediaHelper.audio.audioStream,e.muted)}catch(n){this.client.emit("notAllowedError",n),this.client.emit("NotAllowedError",n),this.safeEmit("notAllowedError",n)}}if(e.audioSlave&&this._play&&this.mediaHelper.screenAudio.screenAudioStream.getTracks().length)if(this.client.spatialManager)this.logger.log("[play] 启用了空间音频，跳过本地音频辅流播放。");else{this.logger.log(`[play] uid ${this.stringStreamID} 开始播放远端音频辅流`);try{this.client.adapterRef.enableMixAudio?await((a=this.client.adapterRef.audioMixer)===null||a===void 0?void 0:a.addStream(this.mediaHelper.screenAudio.screenAudioStream)):await this._play.playAudioStream("audioSlave",this.mediaHelper.screenAudio.screenAudioStream,e.muted)}catch(n){this.client.emit("notAllowedError",n),this.client.emit("NotAllowedError",n),this.safeEmit("notAllowedError",n)}}let l;if(l=typeof t=="string"?document.getElementById(t):t||null,l){if(e.video&&(this.videoView=l,this._play&&this.mediaHelper.video.videoStream.getVideoTracks().length)){this.logger.log(`[play] uid ${this.stringStreamID} 开始启动视频播放 主流 远端`);try{await this._play.playVideoStream("video",this.mediaHelper.video.renderStream,l),"width"in this.renderMode.remote.video&&this._play.setRender("video",this.renderMode.remote.video)}catch(n){this.client.emit("notAllowedError",n),this.client.emit("NotAllowedError",n),this.safeEmit("notAllowedError",n)}}if(e.screen&&(this.screenView=l,this._play&&this.mediaHelper&&this.mediaHelper.screen.screenVideoStream.getVideoTracks().length)){this.logger.log(`[play] uid ${this.stringStreamID} 开始启动视频播放 辅流 远端`);try{await this._play.playVideoStream("screen",this.mediaHelper.screen.renderStream,l),"width"in this.renderMode.remote.screen&&this._play.setRender("screen",this.renderMode.remote.screen)}catch(n){this.client.emit("notAllowedError",n),this.client.emit("NotAllowedError",n),this.safeEmit("notAllowedError",n)}}if(e.videoThird&&(this.videoThirdView=l,this._play&&this.mediaHelper&&this.mediaHelper.videoThird.videoThirdStream.getVideoTracks().length)){this.logger.log(`[play] uid ${this.stringStreamID} 开始播放第三路视频远端`);try{await this._play.playVideoStream("videoThird",this.mediaHelper.videoThird.renderStream,l),"width"in this.renderMode.remote.videoThird&&this._play.setRender("videoThird",this.renderMode.remote.videoThird)}catch(n){this.client.emit("notAllowedError",n),this.client.emit("NotAllowedError",n),this.safeEmit("notAllowedError",n)}}if(e.videoFourth&&(this.videoFourthView=l,this._play&&this.mediaHelper&&this.mediaHelper.videoFourth.videoFourthStream.getVideoTracks().length)){this.logger.log(`[play] uid ${this.stringStreamID} 开始播放第四路视频远端`);try{await this._play.playVideoStream("videoFourth",this.mediaHelper.videoFourth.renderStream,l),"width"in this.renderMode.remote.videoFourth&&this._play.setRender("videoFourth",this.renderMode.remote.videoFourth)}catch(n){this.client.emit("notAllowedError",n),this.client.emit("NotAllowedError",n),this.safeEmit("notAllowedError",n)}}}this.client.apiFrequencyControl({name:"play",code:0,param:JSON.stringify({streamID:this.stringStreamID,playOptions:e,isRemote:!0},null," ")})}async resume(){var t;this.client.adapterRef.enableMixAudio?(this.logger.log("尝试恢复混流播放 uid: ",this.stringStreamID),await((t=this.client.adapterRef.audioMixer)===null||t===void 0?void 0:t.resume())):(webAudio_1.tryResumeAudioContext()&&this.logger.log("正在尝试恢复AudioContext自动播放受限"),this._play&&(this.logger.log("resume() uid: ",this.stringStreamID),await this._play.resume())),this.client.apiFrequencyControl({name:"resume",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0},null," ")})}setRemoteRenderMode(t,e){if(!t||!Number.isInteger(t.width)||!Number.isInteger(t.height))throw this.logger.warn("setRemoteRenderMode 参数宽高错误"),this.client.apiFrequencyControl({name:"setRemoteRenderMode",code:-1,param:Object.assign({streamID:this.stringStreamID,isRemote:!0,mediaType:e},t)}),new rtcError_1.default({code:errorCode_1.default.STREAM_RENDER_ARGUMENT_ERROR,message:"setLocalRenderMode() 参数宽高错误"});this.client&&this._play&&(this.logger.log(`uid ${this.stringStreamID} 设置远端视频播放窗口大小: `,e||"video+screen",JSON.stringify(t)),e&&e!=="video"||(this._play&&this._play.setRender("video",t),this.renderMode.remote.video=t),e&&e!=="screen"||(this.renderMode.remote.screen=t,this._play&&this._play.setRender("screen",t)),e&&e!=="videoThird"||(this.renderMode.remote.videoThird=t,this._play&&this._play.setRender("videoThird",t)),e&&e!=="videoFourth"||(this.renderMode.remote.videoFourth=t,this._play&&this._play.setRender("videoFourth",t)),this.client.apiFrequencyControl({name:"setRemoteRenderMode",code:0,param:Object.assign(Object.assign({},t),{mediaType:e,isRemote:!0,streamID:this.stringStreamID})}))}stop(t){var e,r;if(this.logger.log(`stop() uid ${this.stringStreamID}, 停止播放 ${t||"音视频流"}`),this.client.adapterRef.enableMixAudio)t&&t!="audio"||(e=this.client.adapterRef.audioMixer)===null||e===void 0||e.removeStream(this.mediaHelper.audio.audioStream),t&&t!="audioSlave"||(r=this.client.adapterRef.audioMixer)===null||r===void 0||r.removeStream(this.mediaHelper.screenAudio.screenAudioStream);else{if(!this._play)return;types_1.MediaTypeList.forEach(i=>{t&&i!==t||this._play.stopPlayStream(i)}),t&&t!="audio"||!this.mediaHelper.audio.audioDom||(this.mediaHelper.audio.audioDom.srcObject=null,this.mediaHelper.audio.audioDom=null)}this.client.apiFrequencyControl({name:"stop",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,audio:this.audio,video:this.video,screen:this.screen,type:t},null," ")})}isPlaying(t){if(this._play){if(types_1.MediaTypeList.indexOf(t)>-1)return this._play.isPlaying(t);throw this.logger.warn("isPlaying() unknown type"),new rtcError_1.default({code:errorCode_1.default.STREAM_ISPLAYING_ARGUMENT_ERROR,message:"isPlaying() type 参数类型非法"})}return this.client.apiFrequencyControl({name:"isPlaying",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,type:t},null," ")}),this.logger.log(`检查${this.stringStreamID}的${t}播放状态: false`),!1}canPlay(t){return types_1.MediaTypeList.indexOf(t)===-1?null:this._play.canPlay(t)}hasAudio(){return this.mediaHelper.audio.audioStream.getAudioTracks().length>0}hasAudioSlave(){return this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length>0}getAudioLevel(t="audio"){const e=this.mediaHelper.getOrCreateAudioPipeline(t);if(!e)return 0;{let r=0;if(!e.audioLevelNode){const a=webAudio_1.getAudioContext();if(a&&a.audioWorklet&&a.audioWorklet.addModule||(this.logger.error("getAudioLevel is not supported in this browser"),this.client.safeEmit("error","AUDIOLEVEL_NOT_SUPPORTED")),(a==null?void 0:a.state)==="suspended"){const l=new rtcError_1.default({code:errorCode_1.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:"playVideoStream: 浏览器自动播放受限: AudioContext is Suspended"});this.client.safeEmit("notAllowedError",l),this.safeEmit("notAllowedError",l)}else this.client.apiFrequencyControl({name:"getAudioLevel",code:0,param:{mediaType:t,isRemote:!0,streamID:this.stringStreamID}})}const i=e.getAudioLevel();switch(i?r=i.volume:(this.logger.log("getAudioLevel() 正在加载音频模块"),r=0),parameters_1.getParameters().audioLevelFittingAlgorithm){case"classic":return r;case"linear":return Math.max(0,Math.min(100,parameters_1.getParameters().audioLevelRatioRemote*Math.round(200*r)));case"log2":return Math.max(0,Math.min(100,parameters_1.getParameters().audioLevelRatioRemote*Math.round(8.638*Math.log2(r)+97.244)))}}}setAudioVolume(t=100){var e;let r,i;(!Number.isInteger(t)||t<0||t>100)&&(r=errorCode_1.default.SET_AUDIO_VOLUME_ARGUMENTS_ERROR,i="setAudioVolume() volume 应该为 0 - 100 的整数");const a=t/100;if(this.client.adapterRef.enableMixAudio){if(this.client.adapterRef.audioMixer?(this.logger.log(`setAudioVolume() 调节${this.stringStreamID}的音量大小: ${2.55*t} (normalized: ${a})`),this.client.adapterRef.audioMixer.setVolume(a,this.mediaHelper.audio.audioStream)):(i="setAudioVolume() 未找到AudioMixer",r=errorCode_1.default.SET_AUDIO_VOLUME_ERROR),this.client.apiFrequencyControl({name:"setAudioVolume",code:r?-1:0,param:{streamID:this.stringStreamID,isRemote:!0,volume:2.55*t,normalizedVolume:a,reason:i,isMixAudio:!0}}),r)throw this.logger.error(i),new rtcError_1.default({code:r,message:i})}else{if(this.audio&&this._play&&this._play.audio&&this._play.audio.dom||(i="setAudioVolume() 没有音频流，请检查是否有订阅播放过音频",r=errorCode_1.default.SET_AUDIO_VOLUME_ERROR),this.client.apiFrequencyControl({name:"setAudioVolume",code:r?-1:0,param:{streamID:this.stringStreamID,isRemote:!0,volume:2.55*t,normalizedVolume:a,reason:i}}),r)throw this.logger.error(i),new rtcError_1.default({code:r,message:i});this.logger.log(`setAudioVolume() 调节${this.stringStreamID}的音量大小: ${2.55*t} (normalized: ${a})`),(e=this._play)===null||e===void 0||e.setPlayVolume("audio",a)}}setAudioSlaveVolume(t=100){var e;let r,i;Number.isInteger(t)?t<0?t=0:t>100&&(t=100):(r=errorCode_1.default.SET_AUDIO_VOLUME_ARGUMENTS_ERROR,i="setAudioSlaveVolume() volume 应该为 0 - 100 的整数");const a=t/100;if(this.client.adapterRef.enableMixAudio){if(this.client.adapterRef.audioMixer?(this.logger.log(`setAudioSlaveVolume() 调节${this.stringStreamID}的音量大小: ${2.55*t} (normalized: ${a})`),this.client.adapterRef.audioMixer.setVolume(a,this.mediaHelper.screenAudio.screenAudioStream)):(i="setAudioSlaveVolume() 未找到AudioMixer",r=errorCode_1.default.SET_AUDIO_VOLUME_ERROR),this.client.apiFrequencyControl({name:"setAudioSlaveVolume",code:r?-1:0,param:{streamID:this.stringStreamID,isRemote:!0,volume:2.55*t,normalizedVolume:a,reason:i||"",isMixAudio:!0}}),r)throw this.logger.error(i),new rtcError_1.default({code:r,message:i})}else{if(this.audio&&this._play&&this._play.audioSlave&&this._play.audioSlave.dom||(i="setAudioSlaveVolume() 没有音频流，请检查是否有订阅播放过音频辅流",r=errorCode_1.default.SET_AUDIO_VOLUME_ERROR),this.client.apiFrequencyControl({name:"setAudioSlaveVolume",code:r?-1:0,param:{streamID:this.stringStreamID,isRemote:!0,volume:2.55*t,normalizedVolume:a,reason:i||""}}),r)throw this.logger.error(i),new rtcError_1.default({code:r,message:i});this.logger.log(`setAudioSlaveVolume() 调节${this.stringStreamID}的音量大小: ${2.55*t} (normalized: ${a})`),(e=this._play)===null||e===void 0||e.setPlayVolume("audioSlave",a)}}async setAudioOutput(t,e){if(this.client.adapterRef.enableMixAudio){if(!this.client.adapterRef.audioMixer)throw e&&setTimeout(()=>{e("未找到AudioMixer")},0),this.logger.error("设置输出设备失败, setAudioOutput() 未找到AudioMixer"),new rtcError_1.default({code:errorCode_1.default.SET_AUDIO_OUTPUT_ERROR,message:"设置输出设备失败, setAudioOutput() 未找到AudioMixer"});this.client.adapterRef.audioMixer.setAudioOutput(t),e&&setTimeout(e,0)}else if(this._play){try{await this._play.setAudioOutput(t)}catch(r){throw e&&setTimeout(()=>{e(r)},0),this.logger.error("设置输出设备失败",r.name,r.message),new rtcError_1.default({code:errorCode_1.default.SET_AUDIO_OUTPUT_ERROR,message:r.message||"系统内部错误"})}e&&setTimeout(e,0)}this.client.apiFrequencyControl({name:"setAudioOutput",code:0,param:JSON.stringify({streamID:this.stringStreamID,deviceId:t,isRemote:!0},null," ")})}async unmuteAudio(){var t;let e,r;if(this.muteStatus.audio.recv||(e=errorCode_1.default.STREAM_NOT_MUTE_AUDIO_YET,r="remoteStream.unmuteAudio: 当前没有mute音频, 不支持unmute"),this._play.audio.dom&&(!((t=this.mediaHelper.audio.audioStream)===null||t===void 0)&&t.active)||(e=errorCode_1.default.STREAM_UNMUTE_AUDIO_WITHOUT_STREAM,r="remoteStream.unmuteAudio: 没有音频流, 无法执行unmute操作"),this.client.apiFrequencyControl({name:"unmuteAudio",code:e?-1:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,reason:r||""},null," ")}),e)throw this.logger.error(r),new rtcError_1.default({code:e,message:r});try{this.logger.log("unmuteAudio() 启用音频轨道: ",this.stringStreamID),this.muteStatus.audio.recv=!1,this.mediaHelper.audio.audioStream.getAudioTracks().length&&(this.mediaHelper.audio.audioStream.getAudioTracks()[0].enabled=!0),this._play.playAudioStream("audio",this.mediaHelper.audio.audioStream,!1)}catch(i){this.logger.error("unmuteAudio() 异常: ",i.name,i.message),this.client.apiFrequencyControl({name:"unmuteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,reason:i},null," ")})}}async muteAudio(){var t,e,r,i,a,l;if(this.logger.log("禁用音频轨道: ",this.stringStreamID),!(!((r=(e=(t=this._play)===null||t===void 0?void 0:t.audio)===null||e===void 0?void 0:e.dom)===null||r===void 0)&&r.srcObject)||!(!((l=(a=(i=this.mediaHelper)===null||i===void 0?void 0:i.audio)===null||a===void 0?void 0:a.audioStream)===null||l===void 0)&&l.active))throw this.logger.log("muteAudio() 之前没有播放过音频, 不支持unmute: ",this.stringStreamID),new rtcError_1.default({code:errorCode_1.default.STREAM_MUTE_AUDIO_ERROR,message:"remoteStream.muteAudio: 之前没有播放过音频, 不支持muteAudio"});try{this.muteStatus.audio.recv=!0,this.mediaHelper.audio.audioStream.getAudioTracks().length&&(this.mediaHelper.audio.audioStream.getAudioTracks()[0].enabled=!1),this._play.stopPlayStream("audio"),this.client.apiFrequencyControl({name:"muteAudio",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0},null," ")})}catch(n){this.logger.error("API调用失败: Stream:muteAudio",n.name,n.message,n),this.client.apiFrequencyControl({name:"muteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,reason:n.message},null," ")})}}async unmuteAudioSlave(){var t;let e,r;if(this.muteStatus.audioSlave.recv||(e=errorCode_1.default.STREAM_NOT_MUTE_AUDIO_SLAVE_YET,r="remoteStream.unmuteAudioSlave: 当前没有mute音频辅流, 不支持unmute"),this._play.audioSlave.dom&&(!((t=this.mediaHelper.screenAudio.screenAudioStream)===null||t===void 0)&&t.active)||(e=errorCode_1.default.STREAM_UNMUTE_AUDIO_SLAVE_WITHOUT_STREAM,r="remoteStream.unmuteAudioSlave: 没有音频辅流, 无法执行unmute操作"),this.client.apiFrequencyControl({name:"unmuteAudioSlave",code:e?-1:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:r||""},null," ")}),e)throw this.logger.error(r),new rtcError_1.default({code:e,message:r});try{this.logger.log("unmuteAudioSlave() 启用音频辅流轨道: ",this.stringStreamID),this.muteStatus.audioSlave.recv=!1,this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length&&(this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks()[0].enabled=!0),this._play.playAudioStream("audioSlave",this.mediaHelper.screenAudio.screenAudioStream,!1)}catch(i){this.logger.error("Stream:unmuteAudioSlave 异常: ",i.name,i.message,i),this.client.apiFrequencyControl({name:"unmuteAudioSlave",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:i.message},null," ")})}}async muteAudioSlave(){var t,e,r,i,a,l;if(!(!((r=(e=(t=this._play)===null||t===void 0?void 0:t.audioSlave)===null||e===void 0?void 0:e.dom)===null||r===void 0)&&r.srcObject)||!(!((l=(a=(i=this.mediaHelper)===null||i===void 0?void 0:i.screenAudio)===null||a===void 0?void 0:a.screenAudioStream)===null||l===void 0)&&l.active))throw this.logger.error("muteAudioSlave() 之前没有播放过音频辅流, 不支持unmute: ",this.stringStreamID),new rtcError_1.default({code:errorCode_1.default.STREAM_MUTE_AUDIO_SLAVE_ERROR,message:"remoteStream.muteAudioSlave: 之前没有播放过音频辅流, 不支持mute"});try{this.logger.log("muteAudioSlave() 禁用音频辅流轨道: ",this.stringStreamID),this.muteStatus.audioSlave.recv=!0,this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length&&(this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks()[0].enabled=!1),this._play.stopPlayStream("audioSlave"),this.client.apiFrequencyControl({name:"muteAudioSlave",code:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID},null," ")})}catch(n){this.logger.error("Stream:muteAudioSlave 异常: ",n.name,n.message,n),this.client.apiFrequencyControl({name:"muteAudioSlave",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,reason:n},null," ")})}}async unmuteVideo(){let t,e;if(this.muteStatus.video.recv||(t=errorCode_1.default.STREAM_NOT_MUTE_VIDEO_YET,e="remoteStream.unmuteVideo: 当前没有mute视频, 不支持unmute"),this.mediaHelper.video.cameraTrack||(t=errorCode_1.default.STREAM_UNMUTE_VIDEO_WITHOUT_STREAM,e="remoteStream.unmuteVideo: 没有视频流, 无法执行unmute操作"),this.client.apiFrequencyControl({name:"unmuteVideo",code:t?-1:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:e||""},null," ")}),t)throw this.logger.error(e),new rtcError_1.default({code:t,message:e});try{this.logger.log(`unmuteVideo() 启用 ${this.stringStreamID} 的视频轨道`),this.muteStatus.video.recv=!1,this.mediaHelper&&this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!0)}catch(r){this.logger.error("API调用失败：Stream:unmuteVideo",r.name,r.message,r),this.client.apiFrequencyControl({name:"unmuteVideo",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:r.message},null," ")})}}async muteVideo(){var t,e,r,i,a;if(!(!((r=(e=(t=this._play)===null||t===void 0?void 0:t.video)===null||e===void 0?void 0:e.dom)===null||r===void 0)&&r.srcObject)||!(!((a=(i=this.mediaHelper)===null||i===void 0?void 0:i.video)===null||a===void 0)&&a.cameraTrack))throw this.logger.log("muteVideo() 之前没有播放过视频, 不支持unmute: ",this.stringStreamID),new rtcError_1.default({code:errorCode_1.default.STREAM_MUTE_VIDEO_ERROR,message:"remoteStream.muteVideo: 之前没有播放过视频, 不支持mute"});try{this.logger.log(`muteVideo() 禁用 ${this.stringStreamID} 的视频轨道`),this.muteStatus.video.recv=!0,this.mediaHelper&&this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!1),this.client.apiFrequencyControl({name:"muteVideo",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0},null," ")})}catch(l){this.logger.error("API调用失败：Stream:muteVideo",l.name,l.message,l),this.client.apiFrequencyControl({name:"muteVideo",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,reason:l.message},null," ")})}}async unmuteScreen(){let t,e;if(this.muteStatus.screen.recv||(t=errorCode_1.default.STREAM_NOT_MUTE_SCREEN_YET,e="remoteStream.unmuteScreen: 当前没有mute屏幕共享, 不支持unmute"),this.mediaHelper.screen.screenVideoTrack||(t=errorCode_1.default.STREAM_UNMUTE_SCREEN_WITHOUT_STREAM,e="remoteStream.unmuteScreen: 没有屏幕共享流, 无法执行unmute操作"),this.client.apiFrequencyControl({name:"unmuteScreen",code:t?-1:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:e||""},null," ")}),t)throw this.logger.error(e),new rtcError_1.default({code:t,message:e});try{this.logger.log(`unmuteScreen() 启用 ${this.stringStreamID} 的屏幕共享轨道`),this.muteStatus.screen.recv=!1,this.mediaHelper&&this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!0),this.client.apiFrequencyControl({name:"unmuteScreen",code:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID},null," ")})}catch(r){this.logger.error("unmuteScreen() 异常: ",r.name,r.message,r),this.client.apiFrequencyControl({name:"unmuteScreen",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:r.message},null," ")})}}async muteScreen(){var t,e,r,i;if(!(!((r=(e=(t=this._play)===null||t===void 0?void 0:t.screen)===null||e===void 0?void 0:e.dom)===null||r===void 0)&&r.srcObject)||!(!((i=this.mediaHelper)===null||i===void 0)&&i.screen.screenVideoTrack))throw this.logger.log("muteScreen() 之前没有播放过屏幕共享, 不支持unmute: ",this.stringStreamID),new rtcError_1.default({code:errorCode_1.default.STREAM_MUTE_SCREEN_ERROR,message:"remoteStream.muteScreen: 之前没有播放过屏幕共享, 不支持mute"});try{this.logger.log(`muteScreen() 禁用 ${this.stringStreamID} 的屏幕共享轨道`),this.mediaHelper&&this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!1),this.muteStatus.screen.recv=!0,this.client.apiFrequencyControl({name:"muteScreen",code:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID},null," ")})}catch(a){this.logger.error("muteScreen() 异常: ",a,...arguments),this.client.apiFrequencyControl({name:"muteScreen",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:a.message},null," ")})}}async unmuteVideoThird(){let t,e;if(this.muteStatus.videoThird.recv||(t=errorCode_1.default.STREAM_NOT_MUTE_VIDEO_THIRD_YET,e="remoteStream.unmuteVideoThird: 当前没有mute第三路视频流, 不支持unmute"),this.mediaHelper.videoThird.videoThirdTrack||(t=errorCode_1.default.STREAM_UNMUTE_VIDEO_THIRD_WITHOUT_STREAM,e="remoteStream.unmuteVideoThird: 没有第三路视频流,, 无法执行unmute操作"),this.client.apiFrequencyControl({name:"unmuteVideoThird",code:t?-1:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:e||""},null," ")}),t)throw this.logger.error(e),new rtcError_1.default({code:t,message:e});try{this.logger.log(`unmuteVideoThird() 启用 ${this.stringStreamID} 的第三路视频流`),this.muteStatus.videoThird.recv=!1,this.mediaHelper&&this.mediaHelper.videoThird.videoThirdTrack&&(this.mediaHelper.videoThird.videoThirdTrack.enabled=!0),this.client.apiFrequencyControl({name:"unmuteVideoThird",code:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID},null," ")})}catch(r){this.logger.error("unmuteVideoThird() 异常: ",r.name,r.message,r),this.client.apiFrequencyControl({name:"unmuteVideoThird",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:r.message},null," ")})}}async muteVideoThird(){var t,e,r,i;if(!(!((r=(e=(t=this._play)===null||t===void 0?void 0:t.videoThird)===null||e===void 0?void 0:e.dom)===null||r===void 0)&&r.srcObject)||!(!((i=this.mediaHelper)===null||i===void 0)&&i.videoThird.videoThirdTrack))throw this.logger.log("muteVideoThird() 之前没有播放过第三路视频流, 不支持unmute: ",this.stringStreamID),new rtcError_1.default({code:errorCode_1.default.STREAM_MUTE_VIDEO_THIRD_ERROR,message:"remoteStream.muteVideoThird: 之前没有播放过第三路视频流, 不支持mute"});try{this.logger.log(`muteVideoThird() 禁用 ${this.stringStreamID} 的第三路视频流`),this.mediaHelper&&this.mediaHelper.videoThird.videoThirdTrack&&(this.mediaHelper.videoThird.videoThirdTrack.enabled=!1),this.muteStatus.videoThird.recv=!0,this.client.apiFrequencyControl({name:"muteVideoThird",code:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID},null," ")})}catch(a){this.logger.error("muteVideoThird() 异常: ",a,...arguments),this.client.apiFrequencyControl({name:"muteVideoThird",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:a.message},null," ")})}}async unmuteVideoFourth(){let t,e;if(this.muteStatus.videoFourth.recv||(t=errorCode_1.default.STREAM_NOT_MUTE_VIDEO_FOURTH_YET,e="remoteStream.unmuteVideoFourth: 当前没有mute第四路视频流 不支持unmute"),this.mediaHelper.videoFourth.videoFourthTrack||(t=errorCode_1.default.STREAM_UNMUTE_VIDEO_THIRD_WITHOUT_STREAM,e="remoteStream.unmuteVideoFourth: 没有第四路视频流, 无法执行unmute操作"),this.client.apiFrequencyControl({name:"unmuteVideoFourth",code:t?-1:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:e||""},null," ")}),t)throw this.logger.error(e),new rtcError_1.default({code:t,message:e});try{this.logger.log(`unmuteVideoFourth() 启用 ${this.stringStreamID} 的第四路视频流`),this.muteStatus.videoFourth.recv=!1,this.mediaHelper&&this.mediaHelper.videoFourth.videoFourthTrack&&(this.mediaHelper.videoFourth.videoFourthTrack.enabled=!0),this.client.apiFrequencyControl({name:"unmuteVideoFourth",code:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID},null," ")})}catch(r){this.logger.error("unmuteVideoFourth() 异常: ",r.name,r.message,r),this.client.apiFrequencyControl({name:"unmuteVideoFourth",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:r.message},null," ")})}}async muteVideoFourth(){var t,e,r,i;if(!(!((r=(e=(t=this._play)===null||t===void 0?void 0:t.videoFourth)===null||e===void 0?void 0:e.dom)===null||r===void 0)&&r.srcObject)||!(!((i=this.mediaHelper)===null||i===void 0)&&i.videoFourth.videoFourthTrack))throw this.logger.log("muteVideoFourth() 之前没有播放过第四路视频流, 不支持unmute: ",this.stringStreamID),new rtcError_1.default({code:errorCode_1.default.STREAM_MUTE_SCREEN_ERROR,message:"remoteStream.muteVideoFourth: 之前没有播放过第四路视频流, 不支持mute"});try{this.logger.log(`muteVideoFourth() 禁用 ${this.stringStreamID} 的第四路视频流`),this.mediaHelper&&this.mediaHelper.videoFourth.videoFourthTrack&&(this.mediaHelper.videoFourth.videoFourthTrack.enabled=!1),this.muteStatus.videoFourth.recv=!0,this.client.apiFrequencyControl({name:"muteVideoFourth",code:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID},null," ")})}catch(a){this.logger.error("muteVideoFourth() 异常: ",a,...arguments),this.client.apiFrequencyControl({name:"muteVideoFourth",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:a.message},null," ")})}}hasVideo(){this.logger.log("获取视频 flag"),this.mediaHelper.video.videoStream.getVideoTracks().length}hasScreen(){this.logger.log("获取屏幕共享 flag"),this.mediaHelper.screen.screenVideoStream.getVideoTracks().length}hasVideoThird(){this.logger.log("获取第三路视频 flag"),this.mediaHelper.videoThird.videoThirdStream.getVideoTracks().length}hasVideoFourth(){this.logger.log("获取第四路视频 flag"),this.mediaHelper.videoFourth.videoFourthStream.getVideoTracks().length}async takeSnapshot(t){var e,r,i,a,l,n,c,s;let d,u;const h=this.video&&((r=(e=this._play)===null||e===void 0?void 0:e.video)===null||r===void 0?void 0:r.dom),o=this.screen&&((a=(i=this.Play)===null||i===void 0?void 0:i.screen)===null||a===void 0?void 0:a.dom),f=this.videoThird&&((n=(l=this._play)===null||l===void 0?void 0:l.videoThird)===null||n===void 0?void 0:n.dom),m=this.videoFourth&&((s=(c=this.Play)===null||c===void 0?void 0:c.videoFourth)===null||s===void 0?void 0:s.dom);if(h||o||f||m?(await this._play.takeSnapshot(t,"download",this.streamID),this.client.apiFrequencyControl({name:"takeSnapshot",code:0,param:Object.assign(Object.assign({},t),{streamID:this.stringStreamID,isRemote:!0})})):(u="takeSnapshot(): 没有视频流, 请检查视频是否正在播放",d=errorCode_1.default.STREAM_TAKE_SNAPSHOT_ERROR),d)throw this.logger.error(u),this.client.apiFrequencyControl({name:"takeSnapshot",code:-1,param:JSON.stringify(Object.assign(Object.assign({streamID:this.stringStreamID,isRemote:!0},t),{reason:u}),null," ")}),new rtcError_1.default({code:d,message:u})}takeSnapshotBase64(t){var e,r,i,a,l,n,c,s;let d,u;const h=this.video&&((r=(e=this._play)===null||e===void 0?void 0:e.video)===null||r===void 0?void 0:r.dom),o=this.screen&&((a=(i=this.Play)===null||i===void 0?void 0:i.screen)===null||a===void 0?void 0:a.dom),f=this.videoThird&&((n=(l=this._play)===null||l===void 0?void 0:l.videoThird)===null||n===void 0?void 0:n.dom),m=this.videoFourth&&((s=(c=this.Play)===null||c===void 0?void 0:c.videoFourth)===null||s===void 0?void 0:s.dom);if(h||o||f||m){let g=this._play.takeSnapshot(t,"base64");return this.client.apiFrequencyControl({name:"takeSnapshotBase64",code:0,param:Object.assign({streamID:this.stringStreamID,isRemote:!0},t)}),g}if(u="takeSnapshotBase64(): 没有视频流, 请检查视频是否正在播放",d=errorCode_1.default.STREAM_TAKE_SNAPSHOT_ERROR,d)throw this.logger.error(u),this.client.apiFrequencyControl({name:"takeSnapshotBase64",code:-1,param:JSON.stringify(Object.assign(Object.assign({streamID:this.stringStreamID,isRemote:!0},t),{reason:u}),null," ")}),new rtcError_1.default({code:d,message:u})}getCurrentFrameData(t={mediaType:"video"}){return this._play.getCurrentFrameData(t)}async startMediaRecording(t){const e=[];switch(t.type){case"screen":e.push(this.mediaHelper.screen.screenVideoStream),e.push(this.mediaHelper.audio.audioStream);break;case"camera":case"video":e.push(this.mediaHelper.video.videoStream),e.push(this.mediaHelper.audio.audioStream);break;case"audio":e.push(this.mediaHelper.audio.audioStream)}if(e.length!==0){if(!this._record||!this.streamID||!e)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_ERROR,message:"remoteStream_startMediaRecording: 开始录制时参数异常"});return this._record&&this._record.start({uid:this.client.adapterRef.channelInfo.uidType==="string"?this.stringStreamID:this.streamID,type:t.type,reset:t.reset,stream:e})}this.logger.log("未发现要录制的媒体流")}stopMediaRecording(t){if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"remoteStream.stopMediaRecording: 录制未开始"});return this._record.stop({})}playMediaRecording(t){if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"remoteStream.playMediaRecording: 录制未开始"});return this._record.play(t.view)}listMediaRecording(){let t=[];if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"remoteStream.listMediaRecording: 录制未开始"});const e=this._record.getRecordStatus();return e.status!=="init"&&t.push(e),t}cleanMediaRecording(t){if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"remoteStream.cleanMediaRecording: 录制未开始"});return this._record.clean()}downloadMediaRecording(t){if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"remoteStream.downloadMediaRecording: 录制未开始"});return this._record.download()}clearRemotePubStatus(){for(let t of types_1.MediaTypeList)this[t]=!1,this.pubStatus[t][t]=!1,this.pubStatus[t].producerId="",this.pubStatus[t].consumerId="",this.pubStatus[t].consumerStatus="init",this.pubStatus[t].stopconsumerStatus="init"}setCanvasWatermarkConfigs(t){if(this._play){let e=this._play[t.mediaType].canvasWatermark;if(!e)return void this.logger.error("setCanvasWatermarkConfigs：播放器未初始化",t.mediaType);const r={TEXT:10,IMAGE:4};if(t.textWatermarks&&t.textWatermarks.length>r.TEXT)throw this.logger.error(`目前的文字水印数量：${t.textWatermarks.length}。允许的数量：${r.TEXT}`),new rtcError_1.default({code:errorCode_1.default.WATERMARKS_EXCEEDED_ERROR,message:"最多可以设置 10 个文字水印"});if(t.imageWatermarks&&t.imageWatermarks.length>r.IMAGE)throw this.logger.error(`目前的图片水印数量：${t.imageWatermarks.length}。允许的数量：${r.IMAGE}`),new rtcError_1.default({code:errorCode_1.default.WATERMARKS_EXCEEDED_ERROR,message:"最多可以设置 4 个图片水印"});e.checkWatermarkParams(t),e.updateWatermarks(t),Object.assign({uid:this.stringStreamID},t),this.client.apiFrequencyControl({name:"setRemoteCanvasWatermarkConfigs",code:0,param:{isRemote:!0,streamID:this.stringStreamID,mediaType:t.mediaType}})}else this.logger.error("setCanvasWatermarkConfigs：播放器未初始化")}async registerPlugin(options){if(options.async)return this.registerPluginAsync(options);if(this.logger.log("register plugin:"+options.key),!this.supportWasm)throw this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:"unsupportWasm"}}),new rtcError_1.default({code:errorCode_1.default.WEBGL_NOT_SUPPORT_ERROR,message:`该浏览器不支持WebAssembly，注册 ${options.key} 失败。`});const stageAIProcessing=this.mediaHelper.audio.stageAIProcessing;if(stageAIProcessing!=null&&stageAIProcessing.getPluginConfig(options.key))return this.logger.warn(`plugin ${options.key} already exists.`),!1;let plugin=null;options.adapterRef=this.client.adapterRef;try{if(options.pluginUrl?(await plugin_1.loadPlugin(options.key,options.pluginUrl),plugin=eval(`new window.${options.key}(options)`)):options.pluginObj&&(plugin=new options.pluginObj(options)),!plugin)throw new rtcError_1.default({code:errorCode_1.default.PLUGIN_LOADED_ERROR,message:"unsupport plugin "+options.key});plugin.once("plugin-load",()=>{if(plugin.version!==Config_1.SDK_VERSION)throw this.logger.error(`插件 ${options.key} 版本不匹配，当前SDK版本为 ${Config_1.SDK_VERSION}，插件版本为 ${plugin.version}。`),new rtcError_1.default({code:errorCode_1.default.PLUGIN_VERSION_ERROR,message:`插件 ${options.key} 版本不匹配，当前SDK版本为 ${Config_1.SDK_VERSION}，插件版本为 ${plugin.version}。`});if(this.logger.log(`plugin ${options.key} loaded`),plugin_list_1.videoPlugins.indexOf(options.key)===-1){if(plugin_list_1.audioPlugins.indexOf(options.key)===-1)throw new Error("unsupport plugin "+options.key+JSON.stringify(options));{let t;if(this.mediaHelper.audio.stageAIProcessing)t=this.mediaHelper.audio.stageAIProcessing;else{const r=webAudio_1.getAudioContext();if(!r)return this.logger.error("当前环境不支持AudioContext"),!1;t=new StageAIProcessing_1.StageAIProcessing(r,this.logger),this.mediaHelper.audio.stageAIProcessing=t}options.key=="AIAudioEffects"&&(this.supportAIAudioEffects=!0);const e=Object.assign(Object.assign({},options),{blobUrl:plugin.url,wasmBinary:plugin.wasmBinary});t.registerPlugin(e),t.once("error",r=>{const{msg:i,key:a}=r;this.logger.error(`plugin ${options.key} error: ${a} ${i}`),a=="AIAudioEffects"&&(this.supportAIAudioEffects=!1),this.unregisterPlugin(a),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:`插件 ${options.key} 内部错误：${i}。`}})}),t.on("plugin-process-unstable",r=>{this.emit("plugin-process-unstable",Object.assign({streamID:this.stringStreamID},r))})}}this.emit("plugin-load",options.key),this.client.apiFrequencyControl({name:"registerPlugin",code:0,param:{streamID:this.stringStreamID,plugin:options.key}})}),plugin.once("plugin-load-error",t=>{this.emit("plugin-load-error",{key:options.key,msg:`load ${options.wasmUrl} error.`}),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:`load ${options.wasmUrl} error.`}})}),plugin.once("error",t=>{options.key=="AIAudioEffects"&&(this.supportAIAudioEffects=!1),this.unregisterPlugin(options.key),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:`插件 ${options.key} 内部错误：${t}。`}})})}catch(t){throw this.emit("plugin-load-error",{key:options.key,msg:t}),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:t}}),new rtcError_1.default({code:errorCode_1.default.PLUGIN_LOADED_ERROR,message:t.message})}}async registerPluginAsync(options){return new Promise(async(resolve,reject)=>{if(this.logger.log("register plugin:"+options.key),!this.supportWasm)throw this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:"unsupportWasm"}}),new rtcError_1.default({code:errorCode_1.default.WEBGL_NOT_SUPPORT_ERROR,message:`该浏览器不支持WebAssembly，注册 ${options.key} 失败。`});const stageAIProcessing=this.mediaHelper.audio.stageAIProcessing;if(stageAIProcessing!=null&&stageAIProcessing.getPluginConfig(options.key))return this.logger.warn(`plugin ${options.key} already exists.`),void resolve(`plugin ${options.key} already exists.`);let plugin=null;options.adapterRef=this.client.adapterRef;try{if(options.pluginUrl?(await plugin_1.loadPlugin(options.key,options.pluginUrl),plugin=eval(`new window.${options.key}(options)`)):options.pluginObj&&(plugin=new options.pluginObj(options)),!plugin)throw new rtcError_1.default({code:errorCode_1.default.PLUGIN_LOADED_ERROR,message:"unsupport plugin "+options.key});plugin.once("plugin-load",()=>{if(plugin.version!==Config_1.SDK_VERSION)throw this.logger.error(`插件 ${options.key} 版本不匹配，当前SDK版本为 ${Config_1.SDK_VERSION}，插件版本为 ${plugin.version}。`),new rtcError_1.default({code:errorCode_1.default.PLUGIN_VERSION_ERROR,message:`插件 ${options.key} 版本不匹配，当前SDK版本为 ${Config_1.SDK_VERSION}，插件版本为 ${plugin.version}。`});if(this.logger.log(`plugin ${options.key} loaded`),plugin_list_1.videoPlugins.indexOf(options.key)===-1){if(plugin_list_1.audioPlugins.indexOf(options.key)===-1)throw new Error(`unsupport plugin ${options.key} ${options.wasmUrl}`);{let t;if(this.mediaHelper.audio.stageAIProcessing)t=this.mediaHelper.audio.stageAIProcessing;else{const r=webAudio_1.getAudioContext();if(!r)return this.logger.error("当前环境不支持AudioContext"),!1;t=new StageAIProcessing_1.StageAIProcessing(r,this.logger),this.mediaHelper.audio.stageAIProcessing=t}options.key=="AIAudioEffects"&&(this.supportAIAudioEffects=!0);const e=Object.assign(Object.assign({},options),{blobUrl:plugin.url,wasmBinary:plugin.wasmBinary});t.registerPlugin(e),t.once("error",r=>{const{msg:i,key:a}=r;this.logger.error(`plugin ${options.key} error: ${a} ${i}`),a=="AIAudioEffects"&&(this.supportAIAudioEffects=!1),this.unregisterPlugin(a),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:`插件 ${options.key} 内部错误：${i}。`}})}),t.on("plugin-process-unstable",r=>{this.emit("plugin-process-unstable",Object.assign({streamID:this.stringStreamID},r))})}this.emit("plugin-load",options.key),this.client.apiFrequencyControl({name:"registerPlugin",code:0,param:{streamID:this.stringStreamID,plugin:options.key}}),resolve(void 0)}else reject("unsupport video plugin")}),plugin.once("plugin-load-error",t=>{this.emit("plugin-load-error",{key:options.key,msg:`load ${options.wasmUrl} error.`}),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:`load ${options.wasmUrl} error.`}}),reject(new rtcError_1.default({code:errorCode_1.default.PLUGIN_LOADED_ERROR,message:t}))}),plugin.once("error",t=>{options.key=="AIAudioEffects"&&(this.supportAIAudioEffects=!1),this.unregisterPlugin(options.key),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:`插件 ${options.key} 内部错误：${t}。`}}),reject(new rtcError_1.default({code:errorCode_1.default.PLUGIN_ERROR,message:t}))})}catch(t){throw this.emit("plugin-load-error",{key:options.key,msg:t}),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:t}}),new rtcError_1.default({code:errorCode_1.default.PLUGIN_LOADED_ERROR,message:t.message||t.msg||"unsupport plugin "+options.key})}})}async unregisterPlugin(t){var e;if(this.logger.log("unRegister plugin:"+t),plugin_list_1.audioPlugins.indexOf(t)!==-1){const r=this.mediaHelper.audio.stageAIProcessing;if(t==="AIAudioEffects"){const i=r==null?void 0:r.getProcessor("AIAudioEffects");i!=null&&i.getState("AudioEffect")&&this.disableAudioEffect()}r==null||r.unregisterPlugin(t),r!=null&&r.hasWorkingPlugin()||((e=this.mediaHelper.audio.stageAIProcessing)===null||e===void 0||e.destroy(),this.mediaHelper.audio.stageAIProcessing=null)}this.client.apiFrequencyControl({name:"unregisterPlugin",code:0,param:{streamID:this.stringStreamID,plugin:t}})}async enableAudioEffect(){if(!this.canEnableAIAudioEffects)return this.logger.error("请先关闭伴音功能"),!1;if(!this.supportAIAudioEffects)throw new rtcError_1.default({code:errorCode_1.default.PLUGIN_NOT_SUPPORT,message:"Unsupport Plugin, Please check your plugin version"});let t;if(this.logger.log("start audio effect."),this.mediaHelper.audio.stageAIProcessing)t=this.mediaHelper.audio.stageAIProcessing;else{const r=webAudio_1.getAudioContext();if(!r)return this.logger.error("当前环境不支持AudioContext"),!1;t=new StageAIProcessing_1.StageAIProcessing(r,this.logger),this.mediaHelper.audio.stageAIProcessing=t}if(!t.getPluginConfig("AIAudioEffects"))throw this.logger.error("AudioEffects plugin is not register."),new rtcError_1.default({code:errorCode_1.default.PLUGIN_NOT_REGISTER,message:"ai audio effect plugin is not register"});t.enabled=!0;const e=t.getProcessor("AIAudioEffects");return e?(e.getState("AudioEffect")?this.logger.warn("audio effect is already opened."):(e.setState("AudioEffect",!0),this.emit("audio-effect-enabled"),this.client.apiFrequencyControl({name:"enableAudioEffect",code:0,param:{streamID:this.stringStreamID}})),!0):(t.once("effects-load",async()=>{var r,i,a,l;this.logger.log("ai audio effects loaded");const n=t.getProcessor("AIAudioEffects");if(n==null||n.setState("AudioEffect",!0),this.emit("audio-effect-enabled"),this.client.apiFrequencyControl({name:"enableAudioEffect",code:0,param:{streamID:this.stringStreamID}}),this.mediaHelper.audio.audioRoutingEnabled||this.mediaHelper.enableAudioRouting(),this.mediaHelper.updateWebAudio(),this.client.adapterRef.enableMixAudio){(r=this.client.adapterRef.audioMixer)===null||r===void 0||r.disconnectStream(this.mediaHelper.audio.audioStream);const c=(a=(i=this.mediaHelper.audio.webAudio)===null||i===void 0?void 0:i.destination)===null||a===void 0?void 0:a.stream;c&&((l=this.client.adapterRef.audioMixer)===null||l===void 0||l.addStream(c))}}),await t.initProcessor("AIAudioEffects"),!0)}async disableAudioEffect(){var t,e,r,i;this.logger.log("close audio effect.");const a=this.mediaHelper.audio.stageAIProcessing,l=a==null?void 0:a.getProcessor("AIAudioEffects");if(!a)return this.logger.warn("disableAudioEffect: audio process is not created"),!0;if(!l)return this.logger.warn("ai audio effect is already closed."),!0;if(l==null||l.setState("AudioEffect",!1),l!=null&&l.getState("AIDenoise")||l!=null&&l.getState("AudioEffect")||a.destroyProcessor("AIAudioEffects"),!a.hasWorkingPlugin()){if(this.client.adapterRef.enableMixAudio){const n=(e=(t=this.mediaHelper.audio.webAudio)===null||t===void 0?void 0:t.destination)===null||e===void 0?void 0:e.stream;n&&((r=this.client.adapterRef.audioMixer)===null||r===void 0||r.removeStream(n)),(i=this.client.adapterRef.audioMixer)===null||i===void 0||i.connectStream(this.mediaHelper.audio.audioStream)}a.enabled=!1,this.mediaHelper.updateWebAudio(),this.mediaHelper.canDisableAudioRouting()&&this.mediaHelper.disableAudioRouting()}return this.client.apiFrequencyControl({name:"disableAudioEffect",code:0,param:{streamID:this.stringStreamID}}),!0}setAudioEffect(t,e){this.logger.log(`setAudioEffect:${t} `,JSON.stringify(e));const r=this.mediaHelper.audio.stageAIProcessing,i=r==null?void 0:r.getProcessor("AIAudioEffects");i!=null&&i.getState("AudioEffect")?(i.setAudioEffect(t,e),this.client.apiFrequencyControl({name:"setAudioEffect",code:0,param:{streamID:this.stringStreamID,type:t,value:JSON.stringify(e)}})):this.logger.warn("audio effect is not opened.")}getMuteStatus(t){if(types_1.MediaTypeList.indexOf(t)>-1)return{send:this.muteStatus[t].send,recv:this.muteStatus[t].recv,muted:this.muteStatus[t].send||this.muteStatus[t].recv};throw new Error("getMuteStatus Invalid Media "+t)}getAdapterRef(){var t;return((t=this.client.adapterRef.remoteStreamMap[this.streamID])===null||t===void 0?void 0:t.remoteStreamId)===this.remoteStreamId?this.client.adapterRef:null}getNativeDom(t){var e;const r=this[t],i=(e=this._play[t])===null||e===void 0?void 0:e.dom;return r&&i||this.logger.warn("No remote "+t),i}destroy(){this.client&&(this.client.apiFrequencyControl({name:"destroy",code:0,param:{streamID:this.stringStreamID,isRemote:!0}}),this.logger.log(`uid ${this.stringStreamID} 销毁 Stream 实例`),this.stop(),this._reset())}}exports.RemoteStream=RemoteStream},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.pcCloneTrack=void 0,e.pcCloneTrack=function(i){const a=new RTCPeerConnection,l=new RTCPeerConnection;window.pcLocal=a,window.pcRemote=l,a.onicecandidate=c=>{c.candidate&&l.addIceCandidate(c.candidate)},a.onnegotiationneeded=async c=>{const s=await a.createOffer();await a.setLocalDescription(s),await l.setRemoteDescription(s);const d=await l.createAnswer();await l.setLocalDescription(d),await a.setRemoteDescription(d)};const n=a.addTransceiver("video",{direction:"recvonly"});return l.addTrack(i),i.addEventListener("neTrackEnded",()=>{l.close(),n.receiver.track.stop()}),n.receiver.track}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.preProcessingPureColor=e.preProcessingCopy=e.preProcessingSyncState=e.disablePreProcessing=e.canDisablePreProcessing=e.enablePreProcessing=void 0;const i=r(71),a=r(174),l=r(150);function n(s,d,u){u.videoTrack&&u.videoTrack.enabled!==u.canvasTrack.enabled&&(s.logger.log(`preProcessingCopy: 更改mute状态 ${d} ${u.canvasTrack.enabled} => ${u.videoTrack.enabled}`),u.canvasTrack.enabled=u.videoTrack.enabled)}function c(s,d,u){u.videoTrack&&u.videoTrack.enabled!==u.canvasTrack.enabled&&(s.logger.log(`preProcessingCopy: 更改mute状态 ${d} ${u.canvasTrack.enabled} => ${u.videoTrack.enabled}`),u.canvasTrack.enabled=u.videoTrack.enabled),u.canvasCtx.drawImage(u.videoElem,0,0)}e.enablePreProcessing=async function(s,d,u){let h;if(u||(u=s[d].captureConfig.high.frameRate),h=d==="video"?s.video.cameraTrack||s.video.videoSource:s.screen.screenVideoTrack||s.screen.screenVideoSource,!h)return void s.logger.warn("enablePreProcessing：当前没有视频输入 "+d);let o,f=s[d].preProcessing;if(!f){s.logger.log("enablePreProcessing:初始化 mediaType "+d);const v=document.createElement("video");let O=new l.RTCCanvas("canvas"),T=O._canvas,C=O._ctx;if(!C)throw new Error("无法创建canvasCtx 2d");const A=T.captureStream();v.onresize=()=>{O.setSize(v.videoWidth,v.videoHeight),v.play()},f={canvasTrack:A.getVideoTracks()[0],canvasCtx:C,videoTrack:null,videoElem:v,canvasElem:T,handlers:[{name:"syncState",enabled:!0,func:n},{name:"copy",enabled:!0,func:c},{name:"mirror",enabled:!1,func:()=>{}},s.stream._play[d].encoderWatermark.handler],history:[],timer:null},s[d].preProcessing=f}if(!f)return;d==="video"?i.emptyStreamWith(s.video.videoStream,f.canvasTrack):i.emptyStreamWith(s.screen.screenVideoStream,f.canvasTrack),f.videoElem.srcObject=new MediaStream([h]),f.videoTrack=h,s.stream.isRemote||(o=s.stream.getSender(d,"high")),o&&(o.replaceTrack(f.canvasTrack),s.logger.log(`enablePreProcessing ${d} 成功替换上行`));const m=async()=>{if(f)if(f.videoElem.videoWidth&&f.videoElem.videoHeight&&(f.videoElem.videoWidth===f.canvasElem.width&&f.videoElem.videoHeight===f.canvasElem.height||(s.logger.warn(`前处理宽高变化 ${d} ${f.canvasElem.width}x${f.canvasElem.height} => ${f.videoElem.videoWidth}x${f.videoElem.videoHeight}`),f.canvasElem.width=f.videoElem.videoWidth,f.canvasElem.height=f.videoElem.videoHeight)),f.handlers.length){const v=Date.now(),O=[];for(let A of f.handlers)if(A&&A.enabled){const R=v;await A.func(s,d,f);const w=Date.now()-R;O.push({name:A.name,spent:w})}const T=Date.now();let C=0;for(;C<f.history.length&&T-f.history[C].endTs>5e3;C++);f.history.splice(0,C),f.history.push({startTs:v,endTs:T,handlerTs:O})}else c(s,d,f)};f.timer&&clearInterval(f.timer);const g=Math.floor(1e3/u);try{m()}catch(v){s.logger.error("drawFrame",v.name,v.message,v.stack)}f.timer=a.getRTCTimer().setInterval(m,g),s[d].preProcessingEnabled=!0,s.emit("preProcessChange",{mediaType:d,isOn:!0})},e.canDisablePreProcessing=function(s,d){const u=s[d].preProcessing;return!(!u||!u.timer)&&u.handlers.filter(h=>h&&h.enabled&&h.name!=="syncState"&&h.name!=="copy").length===0},e.disablePreProcessing=async function(s,d="video",u=!1){s.logger.log("disablePreProcessing "+d);const h=s[d].preProcessing;if(!h)return void s.logger.warn(`disablePreProcessing ${d}:当前没有前处理配置`);let o,f;h.canvasCtx.clearRect(0,0,h.canvasElem.width,h.canvasElem.height),h!=null&&h.timer&&(a.getRTCTimer().clearInterval(h.timer),h.timer=null),d==="video"?(o=s.video.cameraTrack||s.video.videoSource,i.emptyStreamWith(s.video.videoStream,o)):(o=s.screen.screenVideoTrack||s.screen.screenVideoSource,i.emptyStreamWith(s.screen.screenVideoStream,o)),h.videoElem.srcObject&&(h.videoElem.srcObject=null),s.stream.isRemote||(f=s.stream.getSender(d,"high")),f&&((o==null?void 0:o.readyState)==="live"?(f.replaceTrack(o),s.logger.log(`disablePreProcessing ${d} 成功替换上行为【${o.label}】`)):(f.replaceTrack(null),s.logger.warn("disablePreProcessing 删除上行"))),u||(s[d].preProcessingEnabled=!1),s.emit("preProcessChange",{mediaType:d,isOn:!1})},e.preProcessingSyncState=n,e.preProcessingCopy=c,e.preProcessingPureColor=function(s,d,u){u.canvasCtx.fillStyle="green",u.canvasCtx.fillRect(0,0,u.canvasElem.width,u.canvasElem.height)}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.AudioPipeline=void 0;const i=r(286),a=r(72),l=r(287),n=r(288),c=r(289),s=r(290);let d=0;e.AudioPipeline=class{constructor(u){this.id=++d,this.inputs={local:{track:null,node:null,label:""},remote:{track:null,node:null,label:""}},this.audioLevelNode=null,this.stages=[],this.mixins={},this.output={track:null,stream:new MediaStream,destination:null,directOutput:!0},this.context=u.context,this.logger=u.logger.getChild(()=>{let h="AudioPipeline#"+this.id;this.inputs.local.track&&(h+=" LOCAL",this.inputs.local.track===this.output.track&&(h+=`[${this.inputs.local.label}]`)),this.inputs.remote.track&&(h+=" REMOTE",this.inputs.remote.track===this.output.track&&(h+=`[${this.inputs.remote.label}]`));let o="";for(let f in this.mixins)this.output.destination&&this.mixins[f].node.isConnectedTo(this.output.destination)&&(o+=" m"+f);o&&(h+=" "+o);for(let f in this.stages)this.stages[f].enabled&&(h+="/"+this.stages[f].type);return h}),this.stageInputVolume=new n.StageInputVolume(this.context),this.stageDelay=new c.StageDelay(this.context),this.stages=[this.stageInputVolume,this.stageDelay],this.output.stream=u.outputStream,this.pluginList=[],this.logger.log("Audio Pipeline Init")}getMixin(u){return this.mixins[u]||(this.mixins[u]=new s.AudioMix(this)),this.mixins[u]}getEnabledStages(){return this.stages.filter(u=>u.enabled)}setInput(u,h,o){this.inputs[u].track=h,this.updateConnection()}getInputVolume(){return this.stageInputVolume.volume}setInputVolume(u){this.stageInputVolume.setVolume(u),this.stageInputVolume.isTransparent()?this.stageInputVolume.enabled&&(this.stageInputVolume.enabled=!1,this.updateConnection()):this.stageInputVolume.enabled||(this.stageInputVolume.enabled=!0,this.updateConnection())}setDelay(u){this.stageDelay.setDelay(u),this.stageDelay.isTransparent()?this.stageDelay.enabled&&(this.stageDelay.enabled=!1,this.updateConnection()):this.stageDelay.enabled||(this.stageDelay.enabled=!0,this.updateConnection())}getAudioLevel(){return this.audioLevelNode||(this.initAudioLevelNode(),this.updateConnection()),this.audioLevelNode?(this.audioLevelNode.audioNode&&!this.audioLevelNode.audioNode.port.onmessage&&(this.audioLevelNode.logger.warn("Rebinding Audio Worklet Node"),this.audioLevelNode.bindAudioWorkletNode(this.audioLevelNode.audioNode)),this.audioLevelNode.getAudioLevel()):0}initAudioLevelNode(){this.audioLevelNode?this.logger.log("initAudioLevelNode: audioLevelNode Already Inited"):(this.audioLevelNode=new i.AudioLevelNode({logger:this.logger,context:this.context}),this.updateConnection())}hasWorkingMixin(){for(let u in this.mixins)if(this.mixins[u].mixAudioConf.state==="MIX_PLAYING")return!0;return!1}updateConnection(){var u,h,o,f,m,g;const v=this.getInputsInfo();let O=null;switch(v.cnt){case 0:this.output.directOutput=!0,this.output.stream.getTracks().length&&(this.output.stream.getTracks().forEach(T=>{this.output.stream.removeTrack(T)}),this.logger.log("updateConnection:NoInput"),this.output.stream.dispatchEvent(new Event("neTrackUpdated")),this.output.track=null),this.audioLevelNode&&this.audioLevelNode.disconnectFromAll();break;case 1:if(this.getEnabledStages().length||this.hasWorkingMixin()){this.output.destination||(this.logger.log("updateConnection: Creating output destination"),this.output.destination=new a.NeAudioNode("destination",this.context.createMediaStreamDestination())),this.output.track=this.output.destination.audioNode.stream.getTracks()[0],this.output.stream.getTracks()[0]!==this.output.track&&(this.output.stream.getTracks().forEach(C=>{var A;this.logger.log(`updateConnection: Updating output track ${C.label} => ${(A=this.output.track)===null||A===void 0?void 0:A.label}`),this.output.stream.removeTrack(C)}),this.output.stream.addTrack(this.output.track),this.output.stream.dispatchEvent(new Event("neTrackUpdated")));let T=!1;for(let C in this.mixins){const A=this.mixins[C];A.mixAudioConf.state==="MIX_PLAYING"?(A.mixAudioConf.replace&&(T=!0),A.node.isConnectedTo(this.output.destination)||(this.logger.log(`connect ${C} to destination`),A.node.connect(this.output.destination))):A.node.isConnectedTo(this.output.destination)&&A.node.disconnect(this.output.destination)}if(this.stages){let C=this.output.destination;for(let A=this.stages.length-1;A>=0;A--){const R=this.stages[A];R.enabled&&R.node?(O||(O=R.node),T&&C===this.output.destination?R.node.isConnectedTo(C)&&R.node.disconnect(C):R.node.isConnectedTo(C)||(R.node.disconnectToAll(),R.node.connect(C)),C=R.node):R.enabled||((o=R.node)===null||o===void 0||o.disconnectToAll(),(f=R.node)===null||f===void 0||f.disconnectFromAll())}v.singleInput&&(v.singleInput.track&&(v.singleInput.node=l.getMediaStreamSourceNode(this.context,v.singleInput.track,v.singleInput===this.inputs.remote)),T&&C===this.output.destination?!((m=v.singleInput.node)===null||m===void 0)&&m.isConnectedTo(C)&&((g=v.singleInput.node)===null||g===void 0||g.disconnect(C)):v.singleInput.node&&!v.singleInput.node.isConnectedTo(C)&&(v.singleInput.node.disconnectToAll(),v.singleInput.node.connect(C)))}}else this.output.directOutput=!0,!((u=v.singleInput)===null||u===void 0)&&u.track&&(this.output.track=v.singleInput.track,this.output.stream.getTracks()[0]!==this.output.track&&(this.output.stream.getTracks().forEach(T=>{this.output.stream.removeTrack(T)}),this.output.stream.addTrack(this.output.track),this.logger.log("updateConnection: DIRECT",this.output.track.label),this.output.stream.dispatchEvent(new Event("neTrackUpdated"))),this.audioLevelNode&&(v.singleInput.node=l.getMediaStreamSourceNode(this.context,v.singleInput.track,v.singleInput===this.inputs.remote),O=v.singleInput.node)),!((h=v.singleInput)===null||h===void 0)&&h.node&&v.singleInput.node.disconnectToAll()}this.audioLevelNode&&O&&(O.isConnectedTo(this.audioLevelNode)||(this.audioLevelNode.disconnectFromAll(),O.connect(this.audioLevelNode)))}getInputsInfo(){let u=0,h=null;return this.inputs.local.track&&(u++,h=this.inputs.local),this.inputs.remote.track&&(u++,h=this.inputs.remote),{cnt:u,singleInput:u===1?h:null}}}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.AudioLevelNode=void 0;const i=r(90),a=r(72),l=r(47);let n="NOTREADY",c=null;class s extends a.NeAudioNodeNullable{constructor(u){super("AudioLevelNode",null),this.volume=0,this.volumeTs=Date.now(),this.left=null,this.right=null,this.channelState="balance",this.stateChangeCnt=0,this.context=u.context,this.logger=u.logger.getChild(()=>{let h="AudioLevelNode#"+this.id;return h+=n!=="READY"?" "+n:" "+this.channelState,this.stateChangeCnt&&(h+=" change"+this.stateChangeCnt),h}),this.initAudioWorklet()}async initAudioWorklet(){if(this.logger.log("AudioLevelNode initAudioWorklet"),!this.context.audioWorklet)return void this.logger.error("该环境不支持音频处理");c?n==="LOADING"&&await c:(n="LOADING",this.logger.log("正在载入音量模块"),c=this.context.audioWorklet.addModule(i.getBlobUrl("volumeProcessor")),await c,n="READY",this.logger.log("载入音量模块成功"));const u=new AudioWorkletNode(this.context,"vumeter");this.bindAudioWorkletNode(u);const h=l.getAudioLevelDestination();h&&u.connect(h),this.connectedFrom.forEach(o=>{o.connect(this)}),this.connectedTo.forEach(o=>{this.connect(o)})}bindAudioWorkletNode(u){this.audioNode=u,u.port.onmessage=h=>{var o,f;if(this.audioNode!==u)return;const m=Date.now(),g=Math.floor(m);if(h.data.volume>-1){if(this.volume=h.data.volume,this.volumeTs=m,h.data.left>-1)this.left||(this.left={volume:0,history:[]}),this.left.history.length&&this.left.history[0].sec===g||this.left.history.unshift({sec:g,sum:0}),this.left.volume=h.data.left,this.left.history[0].sum+=h.data.left,this.left.history.length>2&&this.left.history.pop();else{const v=this.channelState;this.channelState="mono",v!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${v} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:v}))}if(h.data.right>-1&&(this.right||(this.right={volume:0,history:[]}),this.right.history.length&&this.right.history[0].sec===g||this.right.history.unshift({sec:g,sum:0}),this.right.volume=h.data.right,this.right.history[0].sum+=h.data.right,this.right.history.length>2&&this.right.history.pop()),((o=this.left)===null||o===void 0?void 0:o.history[1])&&((f=this.right)===null||f===void 0?void 0:f.history[1]))if(this.left.history[1].sum>4*this.right.history[1].sum){const v=this.channelState;this.channelState="leftLoud",v!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${v} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:v}))}else if(this.right.history[1].sum>4*this.left.history[1].sum){const v=this.channelState;this.channelState="rightLoud",v!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${v} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:v}))}else{if(this.left.history[1].sum>this.right.history[1].sum&&this.channelState!=="leftLoud"){const v=this.channelState;this.channelState="balance",v!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${v} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:v}))}if(this.right.history[1].sum>this.left.history[1].sum&&this.channelState!=="rightLoud"){const v=this.channelState;this.channelState="balance",v!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${v} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:v}))}}}else this.logger.error("Unsupported message",h.data)}}getAudioLevel(){var u,h;return Date.now()-this.volumeTs>1e3?{volume:0}:{volume:this.volume,left:(u=this.left)===null||u===void 0?void 0:u.volume,right:(h=this.right)===null||h===void 0?void 0:h.volume}}}e.AudioLevelNode=s},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.getMediaStreamSourceNode=void 0;const i=r(72),a=[];e.getMediaStreamSourceNode=function(l,n,c){const s=a.find(d=>d.ctx===l&&d.track===n);if(s){if(c){if(!s.audioElem){const d=document.createElement("audio");d.muted=!0,d.volume=0,d.autoplay=!0,d.controls=!0,s.audioElem=d}s.audioElem.srcObject=s.stream,s.audioElem.play().catch(d=>{})}return s.node}{const d=new MediaStream([n]),u=l.createMediaStreamSource(d),h=new i.NeAudioNode("MediaStreamSource",u);let o=null;c&&(o=document.createElement("audio"),o.muted=!0,o.volume=0,o.autoplay=!0,o.controls=!0,o.srcObject=d,o.play().catch(m=>{}));const f={track:n,stream:d,source:u,ctx:l,node:h,audioElem:o};return a.push(f),h}}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.StageInputVolume=void 0;const i=r(194),a=r(72);class l extends i.StageBase{constructor(c){super(c),this.type="stageInputVolume",this.node=null,this.volume=1}async init(){this.state==="UNINIT"&&(this.node=new a.NeAudioNode("gain",this.context.createGain()),this.state="INITED")}isTransparent(){return Math.abs(this.volume-1)<.01}setVolume(c){this.state==="UNINIT"&&this.init(),this.node&&c<=this.node.audioNode.gain.maxValue&&c>=this.node.audioNode.gain.minValue&&(this.node.audioNode.gain.value=c,this.volume=c)}}e.StageInputVolume=l},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.StageDelay=void 0;const i=r(194),a=r(72);class l extends i.StageBase{constructor(c){super(c),this.type="stageDelay",this.node=null,this.delayTime=1}async init(){this.state==="UNINIT"&&(this.node=new a.NeAudioNode("delay",this.context.createDelay(10)),this.state="INITED",this.node.audioNode.delayTime.value=this.delayTime)}isTransparent(){return this.delayTime<.01}setDelay(c){this.state==="UNINIT"&&this.init(),this.node&&(this.delayTime=c,this.node.audioNode.delayTime.value=c)}}e.StageDelay=l},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.AudioMix=void 0;const i=r(72),a=r(46),l=r(154);class n extends a.RTCEventEmitter{constructor(s){super(),this.pipeline=s,this.context=s.context;const d=new i.NeAudioNode("AudioMixingGain",this.context.createGain());this.node=d,this.mixAudioConf={audioFilePath:"",state:"MIX_UNSTART",buffer:null,cachedBuffers:{},audioSource:null,gainFilter:d,replace:!1,loopback:!1,cycle:0,pauseTime:0,startTime:0,totalTime:0,volume:1,playStartTime:0,setPlayStartTime:0,auidoMixingEnd:null},this.logger=s.logger.getChild(()=>"AudioMix "+this.mixAudioConf.state)}async startAudioMixing(s){if(s!=null&&s.audioFilePath?this.logger.log("即将开始伴音:",JSON.stringify(s,null," ")):this.logger.error("startAudioMixing:未指定伴音文件"),Object.assign(this.mixAudioConf,s),this.mixAudioConf.audioFilePath){if(this.mixAudioConf.cachedBuffers[this.mixAudioConf.audioFilePath])return this.mixAudioConf.buffer=this.mixAudioConf.cachedBuffers[this.mixAudioConf.audioFilePath],this.logger.log("即将从缓存播放伴音",this.mixAudioConf.audioFilePath),this.startMix();{this.logger.log("即将加载云端音乐",this.mixAudioConf.audioFilePath),this.mixAudioConf.state="MIX_STARTING";const d=await this.loadAudioBuffer(this.mixAudioConf.audioFilePath);if(this.mixAudioConf.state==="MIX_STARTING")return this.mixAudioConf.buffer=d,this.startMix();this.logger.warn("startAudioMixing: 播放行为被覆盖")}}}stopAudioMixing(s=!1){return this.mixAudioConf.audioSource?(this.logger.log("即将停止混音"),this.mixAudioConf.audioSource.audioNode.onended=null,this.mixAudioConf.audioSource.disconnect(this.mixAudioConf.gainFilter),this.mixAudioConf.audioSource.audioNode.stop(),this.mixAudioConf.audioSource=null):this.logger.warn("stopAudioMixing:当前没有在混音"),this.mixAudioConf.startTime=0,this.mixAudioConf.pauseTime=0,this.mixAudioConf.playStartTime=0,s&&this.resetMixConf(),this.mixAudioConf.state="MIX_STOPED",this.pipeline.updateConnection(),this.logger.log("混音已停止"),Promise.resolve()}pauseAudioMixing(){if(!this.mixAudioConf.audioSource)return void this.logger.error("pauseAudioMixing:参数不够");this.logger.log("暂停混音"),this.mixAudioConf.audioSource.audioNode.onended=null,this.mixAudioConf.audioSource.disconnect(this.mixAudioConf.gainFilter),this.mixAudioConf.audioSource.audioNode.stop(),this.mixAudioConf.audioSource.disconnectToAll(),this.mixAudioConf.audioSource=null,this.mixAudioConf.pauseTime=Date.now(),this.mixAudioConf.state="MIX_PAUSED";let s=(this.mixAudioConf.pauseTime-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return this.logger.log("已经播放的时间: ",s),s>this.mixAudioConf.totalTime&&(s%=this.mixAudioConf.totalTime),this.logger.log("暂停位置:",s),Promise.resolve()}resumeAudioMixing(){let s,d=(this.mixAudioConf.pauseTime-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return d>this.mixAudioConf.totalTime&&(this.logger.log("播放过的圈数 playedCycle: ",Math.floor(d/this.mixAudioConf.totalTime)),this.mixAudioConf.cycle=this.mixAudioConf.cycle-Math.floor(d/this.mixAudioConf.totalTime)),this.mixAudioConf.setPlayStartTime?(this.logger.log("暂停期间，用户设置混音播放时间: ",this.mixAudioConf.setPlayStartTime),s=this.mixAudioConf.setPlayStartTime,this.mixAudioConf.setPlayStartTime=0):(this.logger.log("恢复混音:",this.mixAudioConf),this.logger.log("已经播放的时间: ",d),d>this.mixAudioConf.totalTime&&(d%=this.mixAudioConf.totalTime),s=d),this.logger.log("回复重置的时间点：",s),this.mixAudioConf.playStartTime=s,this.startMix()}setAudioMixingVolume(s){if(s<=255&&s>=0){const d=s/255;this.logger.log(`setAudioMixingVolume ${this.mixAudioConf.gainFilter.audioNode.gain.value} => ${d}`),this.mixAudioConf.gainFilter.audioNode.gain.value=s/255,this.mixAudioConf.volume=this.mixAudioConf.gainFilter.audioNode.gain.value}else this.logger.error("setAudioMixingVolume: volume不在0~255范围内：",s)}getAudioMixingPlayedTime(){let s=Date.now();this.mixAudioConf.state=="MIX_PAUSED"&&this.mixAudioConf.pauseTime&&(this.logger.log("当前是暂停状态"),s=this.mixAudioConf.pauseTime);let d=(s-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return d>this.mixAudioConf.totalTime&&(d%=this.mixAudioConf.totalTime),{playedTime:d}}getAudioMixingTotalTime(){return{totalTime:this.mixAudioConf.totalTime}}startMix(){if(this.logger.log("startMix: ",this.mixAudioConf),this.mixAudioConf.buffer){if(this.mixAudioConf.audioSource&&this.mixAudioConf.audioSource.disconnectToAll(),this.mixAudioConf.audioSource=new i.NeAudioNode("AudioMixBufferSource",this.pipeline.context.createBufferSource()),this.mixAudioConf.audioSource.audioNode.buffer=this.mixAudioConf.buffer,this.mixAudioConf.audioSource.connect(this.mixAudioConf.gainFilter),this.mixAudioConf.audioSource.audioNode.onended=s=>{this.audioEnd(s)},this.mixAudioConf.totalTime=this.mixAudioConf.buffer.duration,(this.mixAudioConf.playStartTime<0||this.mixAudioConf.playStartTime>=this.mixAudioConf.totalTime)&&(this.mixAudioConf.playStartTime=0),this.logger.log("设置音量:",this.mixAudioConf.volume),this.mixAudioConf.gainFilter.audioNode.gain.value=this.mixAudioConf.volume,this.mixAudioConf.loopback&&this.mixAudioConf.cycle>1){this.mixAudioConf.audioSource.audioNode.loop=this.mixAudioConf.loopback;const s=this.mixAudioConf.cycle*this.mixAudioConf.totalTime-this.mixAudioConf.playStartTime;this.logger.log("循环播放: options.playStartTime: ",this.mixAudioConf.playStartTime),this.logger.log("循环播放: totalTime: ",s),this.mixAudioConf.audioSource.audioNode.start(0,this.mixAudioConf.playStartTime,s-1)}else this.mixAudioConf.loopback&&this.mixAudioConf.cycle==1?(this.mixAudioConf.audioSource.audioNode.loop=!1,this.mixAudioConf.audioSource.audioNode.start(0,this.mixAudioConf.playStartTime)):(this.logger.log("无限循环播放 loop: ",this.mixAudioConf.loopback),this.mixAudioConf.audioSource.audioNode.loop=this.mixAudioConf.loopback,this.mixAudioConf.audioSource.audioNode.start(0,this.mixAudioConf.playStartTime));return this.mixAudioConf.state="MIX_PLAYING",this.mixAudioConf.startTime=Date.now(),this.pipeline.updateConnection(),Promise.resolve()}this.logger.error("startMix: 缺少 mixAudioConf.buffer")}audioEnd(s){return this.mixAudioConf.state!=="MIX_PLAYING"?void this.logger.error("audioEnd:状态不对"):this.mixAudioConf.audioSource&&this.mixAudioConf.audioSource.audioNode.loop&&this.mixAudioConf.cycle<=0?void this.logger.log("无限循环时，伴音播放完成event: ",s):(this.logger.log("伴音播放完成: ",this.mixAudioConf),this.mixAudioConf.audioSource&&(this.mixAudioConf.audioSource.audioNode.onended=null),this.mixAudioConf.auidoMixingEnd&&(this.mixAudioConf.auidoMixingEnd(s),this.mixAudioConf.auidoMixingEnd=null),this.resetMixConf(),this.pipeline.updateConnection(),Promise.resolve())}async loadAudioBuffer(s){let d,u;this.mixAudioConf.cachedBuffers[s]?this.logger.warn(`loadAudioBuffer: 该文件已有缓存，长度：${this.mixAudioConf.cachedBuffers[s].duration} 秒。即将更新该文件地址：${s}`):this.logger.warn("loadAudioBuffer: 开始加载文件。地址："+s);try{d=await l.ajax({url:s,type:"GET",dataType:"arraybuffer"})}catch(h){throw this.logger.error("loadAudioBuffer 加载云端音乐失败: ",h),h}this.logger.log(`loadAudioBuffer 文件下载成功。大小：${Math.floor(d.byteLength/1024)} KB`);try{u=await this.pipeline.context.decodeAudioData(d)}catch(h){throw this.logger.log("loadAudioBuffer 解码失败:",h),h}return this.logger.log(`loadAudioBuffer 解码成功。长度：${u.duration} 秒。`),this.mixAudioConf.cachedBuffers[s]=u,u}resetMixConf(){this.mixAudioConf.audioSource&&(this.mixAudioConf.audioSource.disconnect(this.mixAudioConf.gainFilter),this.mixAudioConf.audioSource=null),this.mixAudioConf.audioFilePath="",this.mixAudioConf.buffer=null,this.mixAudioConf.state="MIX_UNSTART",this.mixAudioConf.replace=!1,this.mixAudioConf.cycle=0,this.mixAudioConf.pauseTime=0,this.mixAudioConf.startTime=0,this.mixAudioConf.totalTime=0,this.mixAudioConf.volume=1,this.mixAudioConf.playStartTime=0,this.mixAudioConf.setPlayStartTime=0,this.mixAudioConf.auidoMixingEnd=null,this.emit("audioFilePlaybackCompleted")}}e.AudioMix=n},function(t,e,r){var i=this&&this.__importDefault||function(u){return u&&u.__esModule?u:{default:u}};Object.defineProperty(e,"__esModule",{value:!0}),e.createCanvasWatermarkControl=e.CanvasWatermarkControl=void 0;const a=i(r(196)),l=r(3),n=r(49),c=r(197);class s extends l.EventEmitter{constructor(h){super(),this.logger=h,this.settings={defaultStyle:{background:"rgba(128,128,128, 0.5)",overflow:"hidden","white-space":"break-spaces",position:"absolute",wordBreak:"break-all",color:"white",fontSize:"10pt"}},this.watermarks=[],this.div=null}checkWatermarkParams(h){h.textWatermarks&&h.textWatermarks.forEach(o=>{const f={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.fontSize",value:o.fontSize,min:1};n.isExistOptions(f).result&&n.checkValidInteger(f);const m={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.fontColor",value:o.fontColor,min:0};n.isExistOptions(m).result&&n.checkValidInteger(m);const g={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.wmWidth",value:o.wmWidth,min:0};n.isExistOptions(g).result&&n.checkValidInteger(g);const v={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.wmHeight",value:o.wmHeight,min:0};n.isExistOptions(v).result&&n.checkValidInteger(v);const O={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.offsetX",value:o.offsetX};n.isExistOptions(O).result&&n.checkValidInteger(O);const T={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.offsetY",value:o.offsetY};n.isExistOptions(T).result&&n.checkValidInteger(T)}),h.timestampWatermarks&&[h.timestampWatermarks].forEach(o=>{const f={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.fontSize",value:o.fontSize,min:1};n.isExistOptions(f).result&&n.checkValidInteger(f);const m={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.fontColor",value:o.fontColor,min:0};n.isExistOptions(m).result&&n.checkValidInteger(m);const g={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.wmWidth",value:o.wmWidth,min:0};n.isExistOptions(g).result&&n.checkValidInteger(g);const v={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.wmHeight",value:o.wmHeight,min:0};n.isExistOptions(v).result&&n.checkValidInteger(v);const O={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.offsetX",value:o.offsetX};n.isExistOptions(O).result&&n.checkValidInteger(O);const T={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.offsetY",value:o.offsetY};n.isExistOptions(T).result&&n.checkValidInteger(T)}),h.imageWatermarks&&h.imageWatermarks.forEach(o=>{const f={tag:"Stream.setCanvasWatermarkConfigs.imageWatermarks.wmWidth",value:o.wmWidth,min:0};n.isExistOptions(f).result&&n.checkValidInteger(f);const m={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.wmHeight",value:o.wmHeight,min:0};n.isExistOptions(m).result&&n.checkValidInteger(m);const g={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.offsetX",value:o.offsetX};n.isExistOptions(g).result&&n.checkValidInteger(g);const v={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.offsetY",value:o.offsetY};n.isExistOptions(v).result&&n.checkValidInteger(v);const O={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.imageUrls",value:o.imageUrls};n.checkExists(O);const T={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.imageUrls.length",value:o.imageUrls.length,min:1};n.checkValidInteger(T);const C={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.fps",value:o.fps,min:0};n.isExistOptions(C).result&&n.checkValidFloat(C)})}updateWatermarks(h){this.clear(),this.watermarks=[],h.imageWatermarks&&h.imageWatermarks.forEach(o=>{const f=Object.assign({},this.settings.defaultStyle,{background:"none"});let m;typeof o.offsetX=="number"?f.left=o.offsetX+"px":o.offsetX&&typeof o.offsetX=="string"&&(f.left=o.offsetX),typeof o.offsetY=="number"?f.top=o.offsetY+"px":o.offsetY&&typeof o.offsetY=="string"&&(f.top=o.offsetY),o.wmWidth!==0&&o.wmHeight!==0||(delete o.wmWidth,delete o.wmHeight),o.wmWidth&&(typeof o.wmWidth=="number"?f.width=o.wmWidth+"px":typeof o.wmWidth=="string"&&(f.width=o.wmWidth)),o.wmHeight&&(typeof o.wmHeight=="number"?f.height=o.wmHeight+"px":typeof o.wmHeight=="string"&&(f.height=o.wmHeight)),typeof o.wmHeight=="number"?f.height=o.wmHeight+"px":o.wmHeight&&typeof o.wmHeight=="string"&&(f.height=o.wmHeight),m=o.fps?{type:"image",content:"",imageUrls:o.imageUrls,loop:o.loop!==!1,loopIndex:0,interval:1e3/(o.fps||1),elem:null,style:f}:{type:"image",content:"",imageUrls:[o.imageUrls[o.imageUrls.length-1]],loop:!1,loopIndex:0,interval:0,elem:null,style:f},this.watermarks.push(m)}),h.textWatermarks&&h.textWatermarks.forEach(o=>{let f=o.content||"";const m=Object.assign({},this.settings.defaultStyle);typeof o.fontColor=="number"?m.color=c.numberToRGBA(o.fontColor):o.fontColor&&typeof o.fontColor=="string"&&(m.color=o.fontColor),typeof o.fontSize=="number"?m.fontSize=o.fontSize+"pt":o.fontSize&&typeof o.fontSize=="string"&&(m.fontSize=o.fontSize),typeof o.offsetX=="number"?m.left=o.offsetX+"px":o.offsetX&&typeof o.offsetX=="string"&&(m.left=o.offsetX),typeof o.offsetY=="number"?m.top=o.offsetY+"px":o.offsetY&&typeof o.offsetY=="string"&&(m.top=o.offsetY),!o.wmWidth&&!o.wmHeight||o.wmWidth===0||o.wmHeight===0?m.background="":typeof o.wmColor=="number"?m.background=c.numberToRGBA(o.wmColor):o.wmColor&&typeof o.wmColor=="string"&&(m.background=o.wmColor),o.wmWidth,typeof o.wmWidth=="number"?o.wmWidth>0&&(m.width=o.wmWidth+"px"):typeof o.wmWidth=="string"&&(m.width=o.wmWidth),o.wmHeight&&(typeof o.wmHeight=="number"?(o.wmHeight>0&&(m.wmHeight=o.wmWidth+"px"),m.height=o.wmHeight+"px"):typeof o.wmHeight=="string"&&(m.height=o.wmHeight));const g={type:"text",content:f,loop:!1,elem:null,loopIndex:0,style:m};this.watermarks.push(g)}),h.timestampWatermarks&&[h.timestampWatermarks].forEach(o=>{const f=Object.assign({},this.settings.defaultStyle);typeof o.fontColor=="number"?f.color=c.numberToRGBA(o.fontColor):o.fontColor&&typeof o.fontColor=="string"&&(f.color=o.fontColor),typeof o.fontSize=="number"?f.fontSize=o.fontSize+"pt":o.fontSize&&typeof o.fontSize=="string"&&(f.fontSize=o.fontSize),typeof o.offsetX=="number"?f.left=o.offsetX+"px":o.offsetX&&typeof o.offsetX=="string"&&(f.left=o.offsetX),typeof o.offsetY=="number"?f.top=o.offsetY+"px":o.offsetY&&typeof o.offsetY=="string"&&(f.top=o.offsetY),!o.wmWidth&&!o.wmHeight||o.wmWidth===0||o.wmHeight===0?f.background="":typeof o.wmColor=="number"?f.background=c.numberToRGBA(o.wmColor):o.wmColor&&typeof o.wmColor=="string"&&(f.background=o.wmColor),o.wmWidth&&(typeof o.wmWidth=="number"?f.width=o.wmWidth+"px":typeof o.wmWidth=="string"&&(f.width=o.wmWidth)),o.wmHeight&&(typeof o.wmHeight=="number"?f.height=o.wmHeight+"px":typeof o.wmHeight=="string"&&(f.height=o.wmHeight));const m={type:"timestamp",content:"yyyy-mm-dd HH:MM:ss",loop:!1,loopIndex:0,elem:null,style:f};this.watermarks.push(m)}),this.div&&this.start(this.div)}start(h){this.clear(),this.div=h,this.watermarks.forEach(o=>{let f;switch(o.type){case"text":f=document.createElement("pre"),f.className="nim-watermark nim-watermark-text",f.innerText=o.content||"",Object.assign(f.style,o.style);break;case"timestamp":f=document.createElement("pre"),f.className="nim-watermark nim-watermark-timestamp",f.innerText="",Object.assign(f.style,o.style);break;case"image":!o.imageUrls&&o.content&&(o.imageUrls=[o.content]),f=document.createElement("div"),f.className="nim-watermark nim-watermark-image-container",o.imgElems=[],o.imageUrls&&o.imageUrls.length&&o.imageUrls.forEach((g,v)=>{const O=document.createElement("img");O.className="nim-watermark nim-watermark-image nim-watermark-image-"+v,O.src=g,O.style.width="100%",o.style.height&&(O.style.height="100%"),O.style.overflow="hidden",o.imgElems&&o.imgElems.push(O),f.appendChild(O),v>0&&(O.style.display="none")}),o.loopIndex=-1;const m=()=>{if(!o.interval&&o.imgElems&&o.loopIndex>=0)o.imgElems[o.loopIndex].style.display="";else{if(o.imgElems&&o.imgElems[o.loopIndex]&&(o.imgElems[o.loopIndex].style.display="none"),o.loopIndex++,o.imgElems&&o.loopIndex>=o.imgElems.length){if(!o.loop)return void(o.loopTimer&&clearInterval(o.loopTimer));o.loopIndex=0}o.imgElems&&(o.imgElems[o.loopIndex].style.display="")}};m(),o.interval&&(o.loopTimer=setInterval(m,o.interval)),Object.assign(f.style,o.style)}o.elem=f,h.appendChild(o.elem)})}clear(){this.div&&this.watermarks.forEach(h=>{h.elem&&(h.elem.remove(),h.elem=null),h.loopTimer&&clearTimeout(h.loopTimer)})}}e.CanvasWatermarkControl=s;const d=new class{constructor(){this.controls=[],this.timer=setInterval(()=>{this.updateTimestamps()},1e3)}updateTimestamps(){this.controls.forEach(u=>{u.watermarks.filter(h=>h.type==="timestamp").forEach(h=>{h.elem&&(h.elem.innerText=a.default(new Date,h.content||"yyyy-mm-dd HH:MM:ss"))})})}};e.createCanvasWatermarkControl=function(u){const h=new s(u);return d.controls.push(h),h}},function(t,e,r){var i=this&&this.__importDefault||function(u){return u&&u.__esModule?u:{default:u}};Object.defineProperty(e,"__esModule",{value:!0}),e.createEncoderWatermarkControl=e.EncoderWatermarkControl=void 0;const a=i(r(196)),l=r(3),n=r(49),c=r(1),s=r(197);class d extends l.EventEmitter{constructor(h){super(),this.logger=h,this.settings={defaultStyle:{left:0,top:0,textWidth:0,textHeight:0,fontSize:"15pt",fontFamily:c.getParameters().encoderWatermarkFontFamily,fillStyle:"white",textBaseline:"hanging",bgWidth:-1,bgHeight:-1,bgFillStyle:"rgba(136, 136, 136, 0.5)"}},this.watermarks=[],this.handler={name:"watermark",enabled:!1,func:this.handleFrame.bind(this)}}handleFrame(h,o,f){this.watermarks.forEach(m=>{if(m.type==="text"||m.type==="timestamp"){let g="";g=m.type==="timestamp"?a.default(new Date,m.content||"yyyy-mm-dd HH:MM:ss"):m.content||"",f.canvasCtx.font=`${m.style.fontSize} ${m.style.fontFamily}`,f.canvasCtx.textBaseline=m.style.textBaseline,m.content,m.style.bgWidth===-1&&m.style.bgHeight===-1&&(m.style.bgWidth=m.style.textWidth,m.style.bgHeight=m.style.textHeight),m.style.bgWidth&&m.style.bgHeight&&(f.canvasCtx.fillStyle=m.style.bgFillStyle,f.canvasCtx.fillRect(m.style.left,m.style.top,m.style.bgWidth,m.style.bgHeight)),f.canvasCtx.fillStyle=m.style.fillStyle,f.canvasCtx.fillText(g,m.style.left,m.style.top)}if(m.type==="image"&&m.imgElems){let g;if(m.interval){if(m.startMs&&m.interval){const v=Date.now()-m.startMs,O=Math.floor(v/m.interval);for(let T=O;T<O+m.imgElems.length;T++){const C=m.imgElems[m.loop?T%m.imgElems.length:T];if(C&&C.complete&&C.naturalWidth&&C.naturalHeight){g=C;break}}}}else m.imgElems[0].complete&&m.imgElems[0].naturalWidth&&m.imgElems[0].naturalHeight&&(g=m.imgElems[0]);if(g){let v,O;m.style.bgWidth>0&&m.style.bgHeight>0?(v=m.style.bgWidth,O=m.style.bgHeight):(v=g.naturalWidth,O=g.naturalHeight),f.canvasCtx.drawImage(g,m.style.left,m.style.top,v,O)}}})}checkWatermarkParams(h){var o,f;const m={tag:"Stream.setEncoderWatermarkConfigs:watermarks.count",value:(((o=h.textWatermarks)===null||o===void 0?void 0:o.length)||0)+(h.timestampWatermarks?1:0)+(((f=h.imageWatermarks)===null||f===void 0?void 0:f.length)||0),max:c.getParameters().encoderWatermarkLimit};n.checkValidInteger(m),h.textWatermarks&&h.textWatermarks.forEach(g=>{const v={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.fontSize",value:g.fontSize,min:1,max:128};n.isExistOptions(v).result&&n.checkValidInteger(v);const O={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.fontColor",value:g.fontColor,min:0,max:4294967295};n.isExistOptions(O).result&&n.checkValidInteger(O);const T={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.wmWidth",value:g.wmWidth,min:0};n.isExistOptions(T).result&&n.checkValidInteger(T);const C={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.wmHeight",value:g.wmHeight,min:0};n.isExistOptions(C).result&&n.checkValidInteger(C);const A={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.offsetX",value:g.offsetX};n.isExistOptions(A).result&&n.checkValidInteger(A);const R={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.offsetY",value:g.offsetY};n.isExistOptions(R).result&&n.checkValidInteger(R)}),h.timestampWatermarks&&[h.timestampWatermarks].forEach(g=>{const v={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.fontSize",value:g.fontSize,min:1,max:128};n.isExistOptions(v).result&&n.checkValidInteger(v);const O={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.fontColor",value:g.fontColor,min:0,max:4294967295};n.isExistOptions(O).result&&n.checkValidInteger(O);const T={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.wmWidth",value:g.wmWidth,min:0};n.isExistOptions(T).result&&n.checkValidInteger(T);const C={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.wmHeight",value:g.wmHeight,min:0};n.isExistOptions(C).result&&n.checkValidInteger(C);const A={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.offsetX",value:g.offsetX};n.isExistOptions(A).result&&n.checkValidInteger(A);const R={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.offsetY",value:g.offsetY};n.isExistOptions(R).result&&n.checkValidInteger(R)}),h.imageWatermarks&&h.imageWatermarks.forEach(g=>{const v={tag:"Stream.setEncoderWatermarkConfigs.imageWatermarks.wmWidth",value:g.wmWidth,min:0};n.isExistOptions(v).result&&n.checkValidInteger(v);const O={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.wmHeight",value:g.wmHeight,min:0};n.isExistOptions(O).result&&n.checkValidInteger(O);const T={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.offsetX",value:g.offsetX};n.isExistOptions(T).result&&n.checkValidInteger(T);const C={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.offsetY",value:g.offsetY};n.isExistOptions(C).result&&n.checkValidInteger(C);const A={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.imageUrls",value:g.imageUrls};n.checkExists(A);const R={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.imageUrls.length",value:g.imageUrls.length,min:1,max:10};n.checkValidInteger(R);const w={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.fps",value:g.fps,min:0,max:30};n.isExistOptions(w).result&&n.checkValidFloat(w)})}updateWatermarks(h){this.watermarks=[],h.imageWatermarks&&h.imageWatermarks.forEach(o=>{const f=Object.assign({},this.settings.defaultStyle,{background:"none"});let m;if(typeof o.offsetX=="number"?f.left=o.offsetX:o.offsetX,typeof o.offsetY=="number"?f.top=o.offsetY:o.offsetY,o.wmWidth!==0&&o.wmHeight!==0||(delete o.wmWidth,delete o.wmHeight),o.wmWidth&&typeof o.wmWidth=="number"&&(f.bgWidth=o.wmWidth),o.wmHeight&&typeof o.wmHeight=="number"&&(f.bgHeight=o.wmHeight),o.loop!==!1&&(o.loop=!0),m=o.fps?{type:"image",content:"",imageUrls:o.imageUrls,loop:o.loop!==!1,loopIndex:0,interval:1e3/(o.fps||1),style:f}:{type:"image",content:"",imageUrls:[o.imageUrls[o.imageUrls.length-1]],loop:!1,loopIndex:0,interval:0,style:f},m.startMs=Date.now(),m.imgElems=[],m.imageUrls)for(let g=0;g<m.imageUrls.length;g++){const v=new Image;v.src=m.imageUrls[g],m.imgElems.push(v)}this.watermarks.push(m)}),h.textWatermarks&&h.textWatermarks.forEach(o=>{let f=o.content||"";const m=Object.assign({},this.settings.defaultStyle);typeof o.fontColor=="number"?m.fillStyle=s.numberToRGBA(o.fontColor):o.fontColor&&typeof o.fontColor=="string"&&(m.fillStyle=o.fontColor),typeof o.fontSize=="number"?m.fontSize=o.fontSize+"pt":o.fontSize&&typeof o.fontSize=="string"&&(m.fontSize=o.fontSize);const g=s.measureText(o.content,m.fontSize,m.fontFamily);m.textWidth=g.width,m.textHeight=g.height,o.offsetX&&(m.left=o.offsetX),o.offsetY&&(m.top=o.offsetY),o.wmColor,o.wmWidth>=0&&(m.bgWidth=o.wmWidth),o.wmHeight>=0&&(m.bgHeight=o.wmHeight),typeof o.wmColor=="number"?m.bgFillStyle=s.numberToRGBA(o.wmColor):o.wmColor&&typeof o.wmColor=="string"&&(m.bgFillStyle=o.wmColor);const v={type:"text",content:f,loop:!1,loopIndex:0,style:m};this.watermarks.push(v)}),h.timestampWatermarks&&[h.timestampWatermarks].forEach(o=>{const f=Object.assign({},this.settings.defaultStyle);typeof o.fontColor=="number"?f.fillStyle=s.numberToRGBA(o.fontColor):o.fontColor&&typeof o.fontColor=="string"&&(f.fillStyle=o.fontColor),typeof o.fontSize=="number"?f.fontSize=o.fontSize+"pt":o.fontSize&&typeof o.fontSize=="string"&&(f.fontSize=o.fontSize);const m=s.measureText("yyyy-mm-dd HH:MM:ss",f.fontSize,f.fontFamily);f.textWidth=m.width,f.textHeight=m.height,o.offsetX&&(f.left=o.offsetX),o.offsetY&&(f.top=o.offsetY),o.wmWidth>=0&&(f.bgWidth=o.wmWidth),o.wmHeight>=0&&(f.bgHeight=o.wmHeight),typeof o.wmColor=="number"?f.bgFillStyle=s.numberToRGBA(o.wmColor):o.wmColor&&o.wmColor==="string"&&(f.bgFillStyle=o.wmColor);const g={type:"timestamp",content:"yyyy-mm-dd HH:MM:ss",loop:!1,loopIndex:0,style:f};this.watermarks.push(g)})}}e.EncoderWatermarkControl=d,e.createEncoderWatermarkControl=function(u){return new d(u)}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0});const i=r(3),a=r(199);function l(d){let u=0;const h=d.toString().split(".")[1];return h&&(u=h.length),u}function n(d,u,h,o){let f=!1;return(isNaN(d)||d<u||d>h||l(d)>l(o))&&(f=!0),f}const c={Pitch:{min:.5,max:2,step:.1},EQ:{min:-15,max:15,step:1},Reverb:{wetGain:{min:0,max:1,step:.1},dryGain:{min:0,max:1,step:.1},damping:{min:0,max:1,step:.1},roomSize:{min:.1,max:2,step:.1},decayTime:{min:0,max:20,step:.1},preDelay:{min:0,max:1,step:.1}}};class s extends i.EventEmitter{constructor(u,h){super(),this.audioWorkletAgent=null,this.node=null,this.key="AIAudioEffects",this.enableAIDenoise=!1,this.enableAudioEffect=!1,this.stageAIProcessing=u,this.logger=u.logger.getChild(()=>"AIAudioEffectsProcess"),this.context=h}async init(){if(!this.audioWorkletAgent){this.audioWorkletAgent=new a.AudioWorkletAgent({logger:this.logger,context:this.context,pluginType:this.key}),this.node=this.audioWorkletAgent.node;const u=this.stageAIProcessing.getPluginConfig(this.key);u?await this.audioWorkletAgent.init(u):this.logger.error("pluginConfig is not found"),this.bindEvents()}}getAudioNode(){return this.node}bindEvents(){var u,h,o;(u=this.audioWorkletAgent)===null||u===void 0||u.on("effects-load",()=>{this.emit("effects-load")}),(h=this.audioWorkletAgent)===null||h===void 0||h.on("error",f=>{this.emit("error",f)}),(o=this.audioWorkletAgent)===null||o===void 0||o.on("plugin-process-unstable",f=>{this.emit("plugin-process-unstable",f)})}setAudioEffect(u,h){var o;let f=!1;switch(u){case 0:(typeof h!="number"||h<0||h>8)&&(f=!0);break;case 1:(typeof h!="number"||h<0||h>11)&&(f=!0);break;case"Pitch":f=n(h,c.Pitch.min,c.Pitch.max,c.Pitch.step);break;case"EQ":if(Array.isArray(h)){h.length!==10&&(f=!0);for(let m=0;m<h.length;m++)if(n(h[m],c.EQ.min,c.EQ.max,c.EQ.step)){f=!0;break}}else f=!0;break;case"Reverb":if(typeof h!="object"||Array.isArray(h))f=!0;else for(const m in h)if(h.hasOwnProperty(m)){if(n(h[m],c.Reverb[m].min,c.Reverb[m].max,c.Reverb[m].step)){f=!0;break}}else f=!0;break;default:f=!0}f?this.logger.error("setAudioEffect fail! outlimit:",u,h):(o=this.audioWorkletAgent)===null||o===void 0||o.postMessage({type:"effect",effect:{type:u,value:h}})}setState(u,h){this.logger.log(`setAIAudioEffects enable: ${u}, ${h}`),this.audioWorkletAgent?(this.audioWorkletAgent.postMessage({type:"setState",option:{type:u,enable:h}}),u==="AIDenoise"?this.enableAIDenoise=h:u==="AudioEffect"&&(this.enableAudioEffect=h)):this.logger.error("audioWorkletAgent is not init")}getState(u){return u==="AIDenoise"?this.enableAIDenoise:u==="AudioEffect"?this.enableAudioEffect:void 0}setAIVadEnable(u={vad_enable:!1,vad_noise_enable:!1,noise_gate_enable:!1}){var h;(h=this.audioWorkletAgent)===null||h===void 0||h.postMessage({type:"AIVadEnable",option:Object.assign({},u)})}destroy(){var u,h;this.logger.log("destroy AIAudioEffectsProcess"),(u=this.audioWorkletAgent)===null||u===void 0||u.removeAllListeners(),(h=this.audioWorkletAgent)===null||h===void 0||h.destroy(),this.audioWorkletAgent=null,this.node=null}}e.default=s},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0});const i=r(3),a=r(199);class l extends i.EventEmitter{constructor(c,s){super(),this.audioWorkletAgent=null,this.node=null,this.key="AIhowling",this.enableAIDenoise=!1,this.enableAudioEffect=!1,this.stageAIProcessing=c,this.logger=c.logger.getChild(()=>"AIhowlingProcess"),this.context=s}async init(){if(!this.audioWorkletAgent){this.audioWorkletAgent=new a.AudioWorkletAgent({logger:this.logger,context:this.context,pluginType:this.key}),this.node=this.audioWorkletAgent.node;const c=this.stageAIProcessing.getPluginConfig(this.key);c?await this.audioWorkletAgent.init(c):this.logger.error("pluginConfig is not found"),this.bindEvents()}}getAudioNode(){return this.node}bindEvents(){var c,s;(c=this.audioWorkletAgent)===null||c===void 0||c.on("aihowling-load",()=>{this.emit("aihowling-load")}),(s=this.audioWorkletAgent)===null||s===void 0||s.on("error",d=>{this.emit("error",d)})}setHowlingCallback(c){var s;(s=this.audioWorkletAgent)===null||s===void 0||s.setHowlingCallback(c)}destroy(){var c;this.logger.log("destroy AIhowlingProcess"),(c=this.audioWorkletAgent)===null||c===void 0||c.destroy(),this.audioWorkletAgent=null,this.node=null}}e.default=l},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.parseBase64=void 0;const i=r(296);let a;e.parseBase64=function(l){var n=l.length,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(!a){a=[];for(var s=0;s<c.length;s++)a[c.charCodeAt(s)]=s}var d=c.charAt(64);if(d){var u=l.indexOf(d);u!==-1&&(n=u)}return function(h,o,f){for(var m=[],g=0,v=0;v<o;v++)if(v%4){var O=f[h.charCodeAt(v-1)]<<v%4*2,T=f[h.charCodeAt(v)]>>>6-v%4*2,C=O|T;m[g>>>2]|=C<<24-g%4*8,g++}return new i.WordArray(m,g)}(l,n,a)}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.WordArray=e.Hex=void 0,e.Hex={stringify(i){for(var a=i.words,l=i.sigBytes,n=[],c=0;c<l;c++){var s=a[c>>>2]>>>24-c%4*8&255;n.push((s>>>4).toString(16)),n.push((15&s).toString(16))}return n.join("")}},e.WordArray=class{constructor(i,a){i=this.words=i||[],this.sigBytes=a??4*i.length}toString(i){return(i||e.Hex).stringify(this)}concat(i){var a=this.words,l=i.words,n=this.sigBytes,c=i.sigBytes;if(this.clamp(),n%4)for(var s=0;s<c;s++){var d=l[s>>>2]>>>24-s%4*8&255;a[n+s>>>2]|=d<<24-(n+s)%4*8}else for(var u=0;u<c;u+=4)a[n+u>>>2]=l[u>>>2];return this.sigBytes+=c,this}clamp(){var i=this.words,a=this.sigBytes;i[a>>>2]&=4294967295<<32-a%4*8,i.length=Math.ceil(a/4)}}},function(t,e,r){var i=r(298),a=r(300);e.Peer=i,e.WebSocketTransport=a},function(t,e,r){var i=n(r(73)),a=n(r(74)),l=r(28);function n(o){return o&&o.__esModule?o:{default:o}}var c=r(201),s=r(202),d=r(1).getParameters,u=new l.Logger({tagGen:function(){return"Peer"}}),h=0;t.exports=class extends c{constructor(o){super(u),u.debug("constructor()"),this._closed=!1,this.id=h++,this._transport=o,this._connected=!1,this._data={createTs:Date.now()},this._sents=new Map,this._notificationId=0,this._handleTransport()}get closed(){return this._closed}get connected(){return this._connected}get data(){return this._data}set data(o){throw new Error("cannot override data object")}close(){if(!this._closed){u.debug("close()"),this._closed=!0,this._connected=!1,this._notificationId=0,this._transport.close(),this._transport=null;var o=!0,f=!1,m=void 0;try{for(var g,v=this._sents.values()[Symbol.iterator]();!(o=(g=v.next()).done);o=!0)g.value.close()}catch(O){f=!0,m=O}finally{try{!o&&v.return&&v.return()}finally{if(f)throw m}}this._sents.clear()}}clear(){var o=!0,f=!1,m=void 0;try{for(var g,v=this._sents.values()[Symbol.iterator]();!(o=(g=v.next()).done);o=!0)g.value.close()}catch(O){f=!0,m=O}finally{try{!o&&v.return&&v.return()}finally{if(f)throw m}}this._sents.clear()}request(o){var f=this,m=arguments.length>1&&arguments[1]!==void 0?arguments[1]:void 0;return(0,a.default)(i.default.mark(function g(){var v;return i.default.wrap(function(O){for(;;)switch(O.prev=O.next){case 0:return v=s.createRequest(o,m),o!="Heartbeat"&&f._logger.debug("request() [method: "+o+", id: "+v.id+"]"),O.next=4,f._transport.send(v);case 4:return O.abrupt("return",new Promise(function(T,C){var A=d().protooMessageTimeout,R={id:v.id,method:v.method,startTs:Date.now(),resolve:function(w){f._sents.delete(v.id)&&(f._closed||(clearTimeout(R.timer),T(w)))},reject:function(w){f._sents.delete(v.id)&&(clearTimeout(R.timer),C(w))},timer:setTimeout(function(){f._sents.delete(v.id)&&C(new Error("request timeout"))},A),close:function(){var w=new Error;w.name="peer closed",R.method&&(w.message="向edge的 "+R.method+" 请求被取消：连接 #"+f.id+" 已被关闭。连接建立时间："+(f._data.openTs-f._data.createTs)+"ms, 请求时间："+(Date.now()-R.startTs)+"ms"),C(w)}};f._sents.set(v.id,R)}));case 5:case"end":return O.stop()}},g,f)}))()}notify(o){var f=this,m=arguments.length>1&&arguments[1]!==void 0?arguments[1]:void 0;return(0,a.default)(i.default.mark(function g(){var v;return i.default.wrap(function(O){for(;;)switch(O.prev=O.next){case 0:return v=s.createNotification(o,m),f._logger.debug("notify() [method:%s]",o),O.next=4,f._transport.send(v);case 4:case"end":return O.stop()}},g,f)}))()}_handleTransport(){var o=this;if(this._transport.closed)return this._closed=!0,void setTimeout(function(){o._closed||(o._connected=!1,o.safeEmit("close"))});this._transport.on("open",function(){o._closed||(u.debug('emit "open"'),o._connected=!0,o._data.openTs=Date.now(),o.safeEmit("open"))}),this._transport.on("disconnected",function(){o._closed||(u.debug('emit "disconnected"'),o._connected=!1,o.safeEmit("disconnected"))}),this._transport.on("failed",function(f){o._closed||(u.debug('emit "failed" [currentAttempt:%s]',f),o._connected=!1,o.safeEmit("failed",f))}),this._transport.on("close",function(){o._closed||(o._closed=!0,u.debug('emit "close"'),o._connected=!1,o.safeEmit("close"))}),this._transport.on("message",function(f){f.request?o._handleRequest(f):f.response?o._handleResponse(f):f.notification&&o._handleNotification(f)})}_handleRequest(o){var f=this;try{this.emit("request",o,function(g){var v=s.createSuccessResponse(o,g);f._transport.send(v).catch(function(){})},function(g,v){g instanceof Error?(g=500,v=String(g)):typeof g=="number"&&v instanceof Error&&(v=String(v));var O=s.createErrorResponse(o,g,v);f._transport.send(O).catch(function(){})})}catch(g){var m=s.createErrorResponse(o,500,String(g));this._transport.send(m).catch(function(){})}}_handleResponse(o){var f=this._sents.get(o.id);if(f)if(o.ok)f.resolve(o.data);else{var m=new Error(o.errorReason);m.code=o.errorCode,f.reject(m)}else u.error("received response does not match any sent request",o.id,JSON.stringify(o))}_handleNotification(o){if(this._handleNotification>o.id)u.warn("忽略重复的通知消息: ",JSON.stringify(o,null," "));else{this._notificationId=o.id;var f=s.createSuccessResponse(o,{});this._transport.send(f).catch(function(){}),this.safeEmit("notification",o)}}}},function(t,e,r){e.generateRandomNumber=function(){return Math.round(1e7*Math.random())}},function(t,e,r){var i=n(r(73)),a=n(r(74)),l=r(28);function n(g){return g&&g.__esModule?g:{default:g}}var c=r(301),s=r(201),d=r(202),u=r(81).JSONBigStringify,h=r(1).getParameters,o={retries:10,factor:2,minTimeout:1e3,maxTimeout:8e3},f=new l.Logger({tagGen:function(){return"WebSocketTransport"}}),m=0;t.exports=class extends s{constructor(g,v){super(f),f.debug("constructor() [url:%s, options:%o]",g,v),this._closed=!1,this._url=g,this._options=v||{},this._ws=null,this.wsid=0,this.skipReconnection=!1,this._runWebSocket()}get closed(){return this._closed}close(){if(!this._closed){f.debug("close()"),this._closed=!0,this.safeEmit("close");try{this._ws.onopen=null,this._ws.onclose=null,this._ws.onerror=null,this._ws.onmessage=null,this._ws.close()}catch(g){f.error("close() | error closing the WebSocket: %o",g)}}}send(g){var v=this;return(0,a.default)(i.default.mark(function O(){return i.default.wrap(function(T){for(;;)switch(T.prev=T.next){case 0:if(!v._closed){T.next=2;break}throw new Error("transport closed");case 2:T.prev=2,v._ws.send(u(g)),T.next=10;break;case 6:throw T.prev=6,T.t0=T.catch(2),f.warn("send() failed:",T.t0.name,T.t0.message),T.t0;case 10:case"end":return T.stop()}},O,v,[[2,6]])}))()}_runWebSocket(){var g=this,v=c.operation(this._options.retry||o),O=!1;v.attempt(function(T){g._closed?v.stop():(f.debug("_runWebSocket() [currentAttempt:%s]",T),g._ws=new WebSocket(g._url,["protoo"]),m++,g.wsid=m,g._ws.onopen=function(){g._closed||(O=!0,g.safeEmit("open"))},g._ws.onclose=function(C){if(!g._closed)if(f.warn('WebSocket "close" event [wasClean:%s, code:%s, reason:"%s"]',C.wasClean,C.code,C.reason),O){if(v.stop(),g.safeEmit("disconnected"),g._closed||g.skipReconnection)return;g._runWebSocket()}else g.safeEmit("failed",T),g._closed||v.retry(!0)||(g._closed=!0,g.safeEmit("close"))},g._ws.onerror=function(){g._closed||f.error('WebSocket "error" event')},g._ws.onmessage=function(C){if(!g._closed){var A=d.parse(C.data);A&&(g.listenerCount("message")!==0?h().signalingMessageDelay?setTimeout(function(){g._closed||g.safeEmit("message",A)},h().signalingMessageDelay):g.safeEmit("message",A):f.error('no listeners for WebSocket "message" event, ignoring received message'))}})})}}},function(t,e,r){t.exports=r(302)},function(t,e,r){var i=r(303);e.operation=function(a){var l=e.timeouts(a);return new i(l,{forever:a&&a.forever,unref:a&&a.unref,maxRetryTime:a&&a.maxRetryTime})},e.timeouts=function(a){if(a instanceof Array)return[].concat(a);var l={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var n in a)l[n]=a[n];if(l.minTimeout>l.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var c=[],s=0;s<l.retries;s++)c.push(this.createTimeout(s,l));return a&&a.forever&&!c.length&&c.push(this.createTimeout(s,l)),c.sort(function(d,u){return d-u}),c},e.createTimeout=function(a,l){var n=l.randomize?Math.random()+1:1,c=Math.round(n*l.minTimeout*Math.pow(l.factor,a));return c=Math.min(c,l.maxTimeout)},e.wrap=function(a,l,n){if(l instanceof Array&&(n=l,l=null),!n)for(var c in n=[],a)typeof a[c]=="function"&&n.push(c);for(var s=0;s<n.length;s++){var d=n[s],u=a[d];a[d]=(function(h){var o=e.operation(l),f=Array.prototype.slice.call(arguments,1),m=f.pop();f.push(function(g){o.retry(g)||(g&&(arguments[0]=o.mainError()),m.apply(this,arguments))}),o.attempt(function(){h.apply(a,f)})}).bind(a,u),a[d].options=l}}},function(t,e){function r(i,a){typeof a=="boolean"&&(a={forever:a}),this._originalTimeouts=JSON.parse(JSON.stringify(i)),this._timeouts=i,this._options=a||{},this._maxRetryTime=a&&a.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}t.exports=r,r.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts},r.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timeouts=[],this._cachedTimeouts=null},r.prototype.retry=function(i){if(this._timeout&&clearTimeout(this._timeout),!i)return!1;var a=new Date().getTime();if(i&&a-this._operationStart>=this._maxRetryTime)return this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(i);var l=this._timeouts.shift();if(l===void 0){if(!this._cachedTimeouts)return!1;this._errors.splice(this._errors.length-1,this._errors.length),this._timeouts=this._cachedTimeouts.slice(0),l=this._timeouts.shift()}var n=this,c=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},l);return this._options.unref&&c.unref(),!0},r.prototype.attempt=function(i,a){this._fn=i,a&&(a.timeout&&(this._operationTimeout=a.timeout),a.cb&&(this._operationTimeoutCb=a.cb));var l=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){l._operationTimeoutCb()},l._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},r.prototype.try=function(i){console.log("Using RetryOperation.try() is deprecated"),this.attempt(i)},r.prototype.start=function(i){console.log("Using RetryOperation.start() is deprecated"),this.attempt(i)},r.prototype.start=r.prototype.try,r.prototype.errors=function(){return this._errors},r.prototype.attempts=function(){return this._attempts},r.prototype.mainError=function(){if(this._errors.length===0)return null;for(var i={},a=null,l=0,n=0;n<this._errors.length;n++){var c=this._errors[n],s=c.message,d=(i[s]||0)+1;i[s]=d,d>=l&&(a=c,l=d)}return a}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.peerLeaveReasonCode=void 0,e.peerLeaveReasonCode={LEAVE_NORMAL:0,LEAVE_FOR_FAIL_OVER:1,LEAVE_FOR_KICK:2,LEAVE_TIMEOUT:3,LEAVE_FOR_RECONNECT:4}},function(t,e,r){var i=this&&this.__importDefault||function(g){return g&&g.__esModule?g:{default:g}};Object.defineProperty(e,"__esModule",{value:!0}),e.LBSManager=void 0;const a=r(26),l=r(154),n=i(r(6)),c=i(r(8)),s=r(42),d=r(1),u=r(81),h=r(204),o=r(26);var f;(function(g){g[g.UNKNOWN_ERROR=99999]="UNKNOWN_ERROR",g[g.TIMEOUT=70100]="TIMEOUT",g[g.JSON_ERROR=70101]="JSON_ERROR",g[g.FORMAT_ERROR=70102]="FORMAT_ERROR"})(f||(f={}));let m=0;e.LBSManager=class{constructor(g){this.lbsManagerId=m++,this.urlBackupMap={},this.requestCnt=0,this.localStorageKey="LBS_CONFIG",this.builtinConfig=h.geofenceArea.getBuiltinConfig(),this.updateTimer=null,this.lastUpdateStartAt=0,this.lastUpdate=null,this.tagToMainDomain={},this.lbsState="uninit",this.lbsStateWillChangeTimer=null,this.client=g,this.logger=g.logger.getChild(()=>{let v="LBSManager "+this.lbsState;return this.client.adapterRef.lbsManager.lbsManagerId!==this.lbsManagerId&&(v+="DETACHED"),v}),window.addEventListener("online",()=>{this.client.adapterRef.connectState.curState!=="DISCONNECTED"&&this.client.adapterRef.lbsManager.lbsManagerId===this.lbsManagerId&&Date.now()-this.lastUpdateStartAt>3e3&&(this.logger.log("侦测到网络连接恢复，尝试更新LBS配置"),this.startUpdate("online"))})}async startUpdate(g){var v,O,T,C,A,R;if(d.getParameters().disableLBSService||d.getParameters().lbsUseBuiltinOnly)return;if(!this.client._params.appkey)return void this.logger.error("startUpdate() 无法更新域名配置: 缺少appkey");let w=a.lbsUrl;if(!((T=(O=(v=this.client)===null||v===void 0?void 0:v._params)===null||O===void 0?void 0:O.neRtcServerAddresses)===null||T===void 0)&&T.channelServer){if(!(!((R=(A=(C=this.client)===null||C===void 0?void 0:C._params)===null||A===void 0?void 0:A.neRtcServerAddresses)===null||R===void 0)&&R.lbsServer))return void this.logger.log("startUpdate() 忽略更新LBS配置请求, 当前为私有化配置");w=this.client._params.neRtcServerAddresses.lbsServer,this.logger.log("startUpdate() 私有化配置的 lbsServer: ",w)}const k=Date.now(),I=k-this.lastUpdateStartAt;if(I<3e3)return void this.logger.log(`startUpdate() 忽略更新请求 ${g}: 上次更新于 ${I} 毫秒前`);this.lastUpdateStartAt=k,this.logger.log("startUpdate(): 开始更新LBS配置。原因："+g);let M=null;try{M=await this.ajax({url:`${w}?reason=${g}&sdkVersion=${encodeURIComponent(a.SDK_VERSION)}&appKey=${encodeURIComponent(this.client._params.appkey)}&business=rtc&clientType=16`,type:"GET",header:{}})}catch(P){this.logger.error("startUpdate() LBS更新失败！",P)}if(this.getReportField("lbs").forEach(P=>{this.client.apiEventReport("setRequestLbs",P)}),M&&M.nrtc&&M.call&&M.tracking)return M.ttl&&(this.updateTimer&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout(()=>{this.logger.log("startUpdate() LBS已到过期时间，正在回滚至内建设置"),this.loadBuiltinConfig("expire")},1e3*M.ttl)),this.lastUpdate={activeFrom:Date.now(),res:M},this.handleLbsStateWillChange(g),this.addUrlBackup(this.tagToMainDomain.nrtc,M.nrtc,"nrtc","lbs"),this.addUrlBackup(this.tagToMainDomain.call,M.call,"call","lbs"),this.addUrlBackup(this.tagToMainDomain.tracking,M.tracking,"tracking","lbs"),this.lbsState="remote",this.logger.log(`startUpdate() 成功加载远端配置。过期时间：${M.ttl}秒后。preloadTimeSec:${M.preloadTimeSec}：`),this.client.safeEmit("@lbs-config-update",{reason:g}),this.saveConfig(M),M;this.logger.error("startUpdate() startUpdate更新失败: 无效的 LBS 返回 ",M)}async loadBuiltinConfig(g){if(!d.getParameters().disableLBSService){this.builtinConfig=h.geofenceArea.getBuiltinConfig(),this.lbsState!=="uninit"&&this.handleLbsStateWillChange(g);for(let v in this.builtinConfig)if(this.builtinConfig[v].length){const O=o.TAGS_TO_MAIN_DOMAIN[v]||this.builtinConfig[v][0];this.addUrlBackup(O,this.builtinConfig[v],v,"builtin"),this.tagToMainDomain[v]=O}this.lbsState="builtin",this.client.safeEmit("@lbs-config-update",{reason:g}),g!=="oninit"&&this.logger.log(`成功加载内建配置 ${g}。`)}}handleLbsStateWillChange(g){this.lbsStateWillChangeTimer&&clearTimeout(this.lbsStateWillChangeTimer);const v={lbsState:this.lbsState,settings:this.getSettings()};this.lbsStateWillChangeTimer=setTimeout(()=>{const O={lbsState:this.lbsState,settings:this.getSettings()};this.client.adapterRef.connectState.curState!=="DISCONNECTED"&&this.client.apiFrequencyControl({name:"_lbsStateChange",code:0,param:{reason:g,before:v,after:O}})},0)}getSettings(){const g=Object.keys(this.urlBackupMap),v={};return g.forEach(O=>{v[O]=this.urlBackupMap[O].map(T=>{const C=T.lastRequest?{status:T.lastRequest.status,rtt:T.lastRequest.rtt}:void 0;return{domain:T.domain,successCount:T.successCount,failCount:T.failCount,lastResult:C}})}),v}getReportField(g){const v=[];for(let C in this.urlBackupMap)for(let A=0;A<this.urlBackupMap[C].length;A++){const R=this.urlBackupMap[C][A];R.tag===g&&v.push(R)}let O=[],T=0;return v.forEach(C=>{if(C.lastRequest&&C.lastRequest.status!=="inprogress"){if(C.lastRequest.requestId>T&&(T=C.lastRequest.requestId,O=[]),C.lastRequest.requestId!==T)return;g==="lbs"?O.push({app_key:this.client._params.appkey,request_id:C.lastRequest.uuid,err_code:C.lastRequest.errCode,err_msg:C.lastRequest.errMsg,rtt:C.lastRequest.rtt,time:C.lastRequest.finishiedAt}):g==="nrtc"?O.push({domain:C.domain,type:1,code:C.lastRequest.status==="success"?0:1}):g==="call"?O.push({domain:C.domain,type:1,code:C.lastRequest.status==="success"?0:1,status:C.lastRequest.status,lbsFrom:this.lbsState,rtt:C.lastRequest.rtt}):O.push({domain:C.domain,requestId:C.lastRequest.uuid,addr:"",type:1,code:C.lastRequest.status==="success"?0:1,status:C.lastRequest.status,lbsFrom:this.lbsState,rtt:C.lastRequest.rtt})}}),O}saveConfig(g){if(!this.client._params.appkey)return void this.logger.error("saveConfig: 缺少appkey");const v={ts:Date.now(),appKey:this.client._params.appkey,sdkVersion:a.SDK_VERSION,sdkBuild:a.BUILD,areaCode:h.geofenceArea.areaCode,config:g};try{localStorage.setItem(this.localStorageKey,u.JSONBigStringify(v))}catch(O){this.logger.error("saveConfig：无法存储LBS设置",O.name,O.message)}}loadLocalConfig(g){var v,O;if(!this.client._params.appkey)return this.logger.error("loadLocalConfig: 缺少appkey"),{reason:"appkeyNotFound",config:null};if(!((O=(v=this.client._params)===null||v===void 0?void 0:v.neRtcServerAddresses)===null||O===void 0)&&O.channelServer)return this.logger.log("忽略 loadLocalConfig 请求：当前为私有化配置"),{reason:"privilization",config:null};let T=null;try{const R=window.localStorage.getItem(this.localStorageKey);if(!R)return this.logger.log("本地未发现LBS配置"),{reason:"configNotFound",config:null};T=u.JSONBigParse(R)}catch(R){this.logger.error("无法读取本地配置：",R.name,R.message)}if(!T)return{reason:"configError",config:null};const C=Date.now(),A=T.ts+1e3*T.config.ttl-C;return A<0?(this.logger.log(`LBS不使用本地配置：ttl已过期${Math.floor(-A/1e3)} 秒。`),{reason:"expire",config:null}):T.sdkVersion!==a.SDK_VERSION||T.sdkBuild!==a.BUILD?(this.logger.warn(`LBS不使用本地配置：版本不匹配。${T.sdkVersion}/${T.sdkBuild} ${a.SDK_VERSION}/${a.BUILD}。`),{reason:"version",config:null}):T.appKey!==this.client._params.appkey?(this.logger.warn(`LBS不使用本地配置：appKey不匹配。${T.appKey} ${this.client._params.appkey}。`),{reason:"appkey",config:null}):T.areaCode!==h.geofenceArea.areaCode?(this.logger.warn(`LBS不使用本地配置：areaCode不匹配。${T.areaCode} ${h.geofenceArea.areaCode}。`),{reason:"areaCode",config:null}):(this.lastUpdate={activeFrom:T.ts,res:T.config},this.handleLbsStateWillChange(g),this.addUrlBackup(this.tagToMainDomain.call,T.config.call,"call","localstorage"),this.addUrlBackup(this.tagToMainDomain.nrtc,T.config.nrtc,"nrtc","localstorage"),this.addUrlBackup(this.tagToMainDomain.tracking,T.config.tracking,"tracking","localstorage"),this.lbsState="local",this.logger.log(`成功加载本地配置。过期时间：${Math.floor(A/1e3)} 秒后。`),this.client.safeEmit("@lbs-config-update",{reason:g}),{reason:"success",config:T})}addUrlBackup(g,v,O,T){const C=this.urlBackupMap[g]||[];this.urlBackupMap[g]=[];const A=this.urlBackupMap[g],R=Date.now();v.forEach(w=>{let k=C.find(I=>I.domain===w&&I.mainDomain===g);k?(k.updatedAt=R,k.tag=O,k.source=T):k={id:A.length,domain:w,mainDomain:g,successCount:0,failCount:0,updatedAt:R,tag:O,source:T},A.push(k)})}getURLSettings(g){const v=/(\/\/)([^\/]+)(\/)/,O=g.match(v);let T="";T=O?O[2]:g,this.urlBackupMap[T]||this.addUrlBackup(T,[T],"extra","extra");const C=this.requestCnt++;return this.urlBackupMap[T].map((A,R)=>{const w=g.replace(v,`$1${A.domain}$3`);return{seqId:`${C}_${R}`,state:"uninit",requestId:C,url:w,item:A}})}markSuccess(g,v){var O;(v==null?void 0:v.status)==="inprogress"&&(v.finishiedAt=Date.now(),v.rtt=v.finishiedAt-v.startAt,v.status="success",this.logger.debug(`markFinish success seqId:${g.seqId} source:${g.item.source} rtt:${v.rtt}ms url:${g.url}`)),g.item.successCount++,g.state="success";const T=this.urlBackupMap[g.item.mainDomain];if(T&&((O=T[0].lastRequest)===null||O===void 0?void 0:O.status)==="fail"){const C=T.findIndex(A=>A===g.item);C>-1&&(this.logger.warn(`主备域名互换。${T[0].domain} => ${g.item.domain}`),this.handleLbsStateWillChange("domainDown:"+T[0].domain),T.splice(C,1),T.unshift(g.item))}}markFail(g,v,O,T){(v==null?void 0:v.status)==="inprogress"&&(v.finishiedAt=Date.now(),v.rtt=v.finishiedAt-v.startAt,v.status="fail",v.errCode=O,v.errMsg=T,this.logger.debug(`markFinish fail seqId:${g.seqId} source:${g.item.source} rtt:${v.rtt}ms url:${g.url}`,O,T)),g.item.failCount++,g.state="fail",this.logger.error("markFail：",g.item.domain,O,T)}isAllRequestsFinished(g){for(let v in g){const O=g[v];if(O.state==="uninit"||O.state==="sent")return!1}return!0}ajax(g){if(d.getParameters().disableLBSService)return l.ajax(g);const v=this.getURLSettings(g.url);let O=!1;return new Promise((T,C)=>{let A=0,R=0;const w=(P,S,y)=>{var _,b,E,x,D,F,V;if(R=Date.now()-A,g.url.indexOf("getChannelInfos.action")>-1&&(this.client.adapterRef.state.getChannelInfoRtt=R),P.status>=400){if(this.markFail(y,S,P.status,typeof P.response=="string"?P.response:u.JSONBigStringify(P.response)),v[1]&&v[1].fire&&v[1].timer)this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${y.url} 】【备 ${v[1].url} 】`,P.status),v[1].fire();else if(this.isAllRequestsFinished(v))return C(new c.default({code:n.default.LBS_REQUEST_ERROR,message:"LBS: 网络请求错误"}))}else if(P.responseType!=="json"||P.response)if(((_=P.response)===null||_===void 0?void 0:_.code)===500){if(this.markFail(y,S,f.UNKNOWN_ERROR,u.JSONBigStringify(P.response)),v[1]&&v[1].fire&&v[1].timer)this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${y.url} 】【备 ${v[1].url} 】`,P.response),v[1].fire();else if(this.isAllRequestsFinished(v)){var N=P.response;T(N)}}else if(y.item.tag!=="lbs"||!((E=(b=P.response)===null||b===void 0?void 0:b.call)===null||E===void 0)&&E.length&&(!((D=(x=P.response)===null||x===void 0?void 0:x.nrtc)===null||D===void 0)&&D.length)&&(!((V=(F=P.response)===null||F===void 0?void 0:F.tracking)===null||V===void 0)&&V.length)){if(this.markSuccess(y,S),v.forEach(L=>{L.timer&&(clearTimeout(L.timer),L.timer=void 0),L.fire=void 0}),O)return void this.logger.log(`${y.url} 已忽略返回值：${P.status}`);k(P),N=P.response,T(N)}else{if(this.markFail(y,S,f.FORMAT_ERROR,u.JSONBigStringify(P.response)),!(v[1]&&v[1].fire&&v[1].timer))return T(P.response);this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${y.url} 】【备 ${v[1].url} 】`,"FORMAT_ERROR"),v[1].fire()}else if(this.markFail(y,S,f.JSON_ERROR,"JSON_ERROR"),v[1]&&v[1].fire&&v[1].timer)this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${y.url} 】【备 ${v[1].url} 】`,P),v[1].fire();else if(this.isAllRequestsFinished(v))return C(new c.default({code:n.default.LBS_JSON_ERROR,message:"LBS: 结果json解析错误"}))},k=P=>{O=!0,P.onload=null,P.onerror=null,P.ontimeout=null},I=(P,S,y,_)=>{if(this.markFail(y,S,f.UNKNOWN_ERROR,`${_.type||u.JSONBigStringify(_)}:${y.url}`),v[1]&&v[1].fire&&v[1].timer)this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${y.url} 】【备 ${v[1].url} 】`,_),v[1].fire();else if(this.isAllRequestsFinished(v))return k(P),C(new c.default({code:n.default.LBS_REQUEST_ERROR,message:"LBS: 主线路请求发生错误(onerror)"}))},M=(P,S,y,_)=>{if(this.markFail(y,S,f.TIMEOUT,"TIMEOUT"),v[1]&&v[1].fire&&v[1].timer)this.logger.warn(`主线路请求超时，启用备用线路 【主 ${y.url}】【备 ${v[1].url}】`,_),v[1].fire();else if(this.isAllRequestsFinished(v))return k(P),C(new c.default({code:n.default.LBS_REQUEST_ERROR,message:"LBS: 主线路请求发生错误(ontimeout)"}))};v.forEach((P,S)=>{P.fire=()=>{P.fire=void 0,P.timer&&(clearTimeout(P.timer),P.timer=void 0),P.state="sent";const y={status:"inprogress",startAt:Date.now(),requestId:P.requestId,seqId:P.seqId,uuid:"",finishiedAt:0,errCode:0,errMsg:"",rtt:-1};P.item.lastRequest=y,((_,b)=>{const E=new XMLHttpRequest;_.xhr=E,E.open(g.type||"GET",b.url,!0),E.responseType=g.dataType||"json";const x=g.contentType||"application/json;charset=UTF-8";if(E.setRequestHeader("Content-Type",x),g.header&&Object.keys(g.header).map(D=>{g.header&&g.header[D]&&E.setRequestHeader(D,g.header[D])}),b.item.tag==="lbs"){const D=s.generateUUID();b.item.lastRequest&&(b.item.lastRequest.uuid=D),E.setRequestHeader("X-Request-Id",D)}E.onload=w.bind(E,E,_,b),E.onerror=I.bind(E,E,_,b),E.ontimeout=M.bind(E,E,_,b),A=Date.now(),x.indexOf("x-www-form-urlencoded")>=0?g.data?E.send(l.getFormData(g.data)):E.send():g.data?E.send(u.JSONBigStringify(g.data)):E.send()})(y,P),S&&(P.timer=setTimeout(()=>(P.timer&&(clearTimeout(P.timer),P.timer=void 0),C(new c.default({code:n.default.LBS_REQUEST_ERROR,message:"LBS: 网络请求错误(无响应)"}))),d.getParameters().fireBackupDelay*S))},S&&(P.timer=setTimeout(()=>{P.fire&&(v[0].state="fail",this.logger.warn("主线路请求超时，发起备用线路请求："+P.url),P.fire())},d.getParameters().fireBackupDelay*S))}),v[0].fire&&v[0].fire()})}}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.SignalProbeManager=void 0;const i=r(90),a=r(1);e.SignalProbeManager=class{constructor(l){this.worker=null,this.signalStates={},this.online="unknown",this.serverActiveWaiters=[],this.adapterRef=l,this.logger=this.adapterRef.instance.logger.getChild(()=>"SignalProbe online:"+this.online)}start(l){this.signalStates={},this.online="unknown",l.forEach((n,c)=>{this.signalStates[n]={index:c,wsUrl:n,active:!1,connect:{startCnt:0,successCnt:0,failCnt:0,failCntFromLastSuccess:0,initAt:-1,connectAt:-1},ping:{sendIndex:0,recvIndex:0,lastSentAt:-1,lastSentMsg:"",rtt:-1}}}),this.logger.log("start",this.signalStates),this.worker&&this.worker.terminate();try{const n=i.getBlobUrl("signalProbeWorker"),c=new Worker(n);this.worker=c,c.onmessage=s=>{this.processWorkerMessage(s)}}catch(n){this.logger.warn("Failed to start SignalProbeManager:",n.name,n.message)}}stop(){var l;(l=this.worker)===null||l===void 0||l.terminate(),this.worker=null,this.signalStates={},this.online="unknown"}getServerState(l){return this.signalStates[l]||null}getActiveServerCount(){let l=0,n=0,c=0;for(let s in this.signalStates)n++,this.signalStates[s].ping.rtt>0?l++:c++;return l===0&&(c=-1),{cnt:l,total:n,code:c}}waitForServerActive(l=1e4){return new Promise(n=>{const c={res:n,resolved:!1,timer:setTimeout(()=>{c.resolved||(c.resolved=!0,this.clearWaiters(),n("timeout"))},l)};this.serverActiveWaiters.push(c)})}processWorkerMessage(l){if(!this.worker||!l.data)return;const n=l.data;switch(n.cmd){case"ohayo":try{const c=JSON.parse(JSON.stringify(this.signalStates)),s={cmd:"init",data:{signalStates:c,pingInterval:2e3,reconnectionInterval:1e4,maxRtt:a.getParameters().joinFirstTimeout+4e3,wsTimeout:a.getParameters().joinFirstTimeout+8e3}};this.worker.postMessage(s)}catch(c){this.logger.warn("无法启动通道探测：",c)}break;case"sync":this.processCmdSync(n.data);break;case"log":this.logger.log(n.data);break;case"error":this.logger.error(n.data);break;default:this.logger.error("msg",n)}}clearWaiters(){this.serverActiveWaiters=this.serverActiveWaiters.filter(l=>!l.resolved)}processCmdSync(l){const n=this.signalStates;this.signalStates=l;let c=!1;for(let s in n){const d=n[s],u=l[s];d&&u?d.active&&!u.active?(c=!0,this.online!=="no"&&this.getActiveServerCount().cnt===0&&(this.online="no",this.logger.error("所有服务端的ping均在下线状态，请检查网络")),this.logger.warn("[sync]Turns into inactive: "+u.wsUrl,u)):!d.active&&u.active&&(c=!0,this.getActiveServerCount().cnt===1&&this.online!=="unknown"&&this.logger.warn("已有服务端上线，网络恢复"),this.online="yes",this.logger.log(`[sync]Turns into active. RTT: ${u.ping.rtt}ms. ${u.wsUrl}`)):this.logger.warn("[sync]Unrecognized signal",s,d,u)}if(c){const s={name:"onPingStateChange",code:this.getActiveServerCount().code,param:{online:this.online}};for(let d in this.signalStates){const u=this.signalStates[d];u&&(s.param[d]={active:u.active,rtt:u.ping.rtt,successCnt:u.connect.successCnt,failCnt:u.connect.failCnt})}this.adapterRef.instance.apiFrequencyControl(s)}this.serverActiveWaiters.length&&this.getActiveServerCount().cnt>0&&this.serverActiveWaiters.forEach(s=>{s.resolved||(s.resolved=!0,this.clearWaiters(),clearTimeout(s.timer),s.res("active"))})}}},function(t,e,r){var i=this&&this.__importDefault||function(u){return u&&u.__esModule?u:{default:u}};Object.defineProperty(e,"__esModule",{value:!0}),e.AudioMixer=void 0;const a=r(143),l=r(1),n=r(46),c=i(r(8)),s=i(r(6));class d extends n.RTCEventEmitter{constructor(h){super(),this.context=null,this.sources=[],this.audioDom=null,this.decodeAudioDom=null,this.streamDestination=null,this.supports={WebAudio:!1,MediaStream:!1},this.sinkId=null,this.adapterRef=h,this.logger=h.logger.getChild(()=>"AudioMixer"),this.supports=a.RtcSupport.checkWebAudio()}initWebAudio(){try{this.context=new window.AudioContext,this.streamDestination=this.context.createMediaStreamDestination(),this._bindAudioContextEvent(),this.logger.log("WebAudio: initWebAudio success")}catch(h){this.context=null,this.logger.error("WebAudio: initWebAudio failed",h)}}addStream(h){return new Promise(async(o,f)=>{if(!this.context||!this.streamDestination)return void o(void 0);if(this.sources.findIndex(v=>v.sourceNode.mediaStream===h)!==-1)return this.logger.log(`WebAudio: addMs: ${h.id} 已存在, 不重复添加`),void o(void 0);const m=this.context.createMediaStreamSource(h),g=this.context.createGain();if(m.connect(g),g.connect(this.streamDestination),this.sources.push({sourceNode:m,gainNode:g}),this.logger.log(`WebAudio: addMs: 添加 ${h.id} 成功`),!this.decodeAudioDom)try{await this._keepDecodeTrack(h),await this._initAudioDom()}catch{return void f(new c.default({code:s.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:"WebAudio: 浏览器自动播放受限"}))}this.context.state!=="running"?this.context.resume().then(()=>{this.logger.log("addStream: 播放成功"),o(void 0)}).catch(v=>{this.logger.error("addStream: 播放失败",v),f(new c.default({code:s.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:"WebAudio: 浏览器自动播放受限"}))}):o(void 0)})}removeStream(h){if(!this.context||!this.streamDestination)return void this.logger.log("WebAudio: removeMs: AudioContext 不存在");const o=this.sources.findIndex(f=>f.sourceNode.mediaStream===h);o!==-1?(this.sources[o].sourceNode.disconnect(),this.sources[o].gainNode.disconnect(),this.sources.splice(o,1),this.logger.log(`WebAudio: removeMs: 删除${h.id}成功`),this.sources.length!==0?this._updateDecodeAudioDom(this.sources[0].sourceNode.mediaStream):(this._destroyDecodeAudioDom(),this._destroyAudioDom())):this.logger.log(`WebAudio: removeMs: ${h.id} 不存在，无需删除`)}connectStream(h){if(!this.context||!this.streamDestination)return void this.logger.log("WebAudio: connectStream: AudioContext 不存在");const o=this.sources.findIndex(f=>f.sourceNode.mediaStream===h);o!==-1?(this.sources[o].gainNode.connect(this.streamDestination),this.logger.log(`WebAudio: connectStream: connect ${h.id} 成功`)):this.logger.log(`WebAudio: connectStream: ${h.id} 不存在，无需链接`)}disconnectStream(h){if(!this.context||!this.streamDestination)return void this.logger.log("WebAudio: disconnectStream: AudioContext 不存在");const o=this.sources.findIndex(f=>f.sourceNode.mediaStream===h);o!==-1?(this.sources[o].gainNode.disconnect(),this.logger.log(`WebAudio: disconnectStream: disconnect ${h.id} 成功`)):this.logger.log(`WebAudio: disconnectStream: ${h.id} 不存在，无需断开链接`)}async resume(){if(this.context?this.context.resume().then(()=>{this.logger.log("[Resume]: resume: resume audio context success")}).catch(h=>{this.logger.error("[Resume]: resume audio context failed",h)}):this.logger.error("[Resume]: resume: audio context is not exist"),this.audioDom)try{await this.audioDom.play(),this.logger.log("[Resume]: resume: resume audio dom success")}catch(h){this.logger.error("[Resume]: resume audio dom failed",h)}if(this.decodeAudioDom)try{await this.decodeAudioDom.play(),this.logger.log("[Resume]: resume: resume decode audio dom success")}catch(h){this.logger.error("[Resume]: resume decode audio dom failed",h)}}setVolume(h,o){if(!this.context||!this.streamDestination)return void this.logger.log("WebAudio: setVolume: AudioContext 不存在");const f=this.sources.findIndex(m=>m.sourceNode.mediaStream===o);f!==-1?(this.sources[f].gainNode.gain.value=h,this.logger.log(`WebAudio: setVolume: ${o.id} 设置音量为 ${h}`)):this.logger.log(`WebAudio: setVolume: ${o.id} 不存在`)}async setAudioOutput(h){this.logger.log("setAudioOutput() audioSinkId: ",h),this.sinkId=h,this.adapterRef.instance.outputDeviceId=h,this.audioDom&&this.audioDom.srcObject&&this.audioDom.sinkId!==void 0?this.audioDom.srcObject.getAudioTracks().length&&(await this.audioDom.setSinkId(h),this.logger.log("setAudioOutput() 设置通话音频输出设备成功")):this.logger.warn("setAudioOutput() Browser does not support output device selection.")}destroy(){this._destroyDecodeAudioDom(),this._destroyAudioDom(),this.context&&(this.context.close(),this.context=null),this.sources=[]}async _initAudioDom(){if(!this.audioDom){if(this.logger.log("WebAudio: initAudioDom",this.streamDestination.stream.id),this.audioDom=document.createElement("audio"),this.audioDom.srcObject=this.streamDestination.stream,this._bindAudioEvent(this.audioDom),this.sinkId&&this.audioDom.sinkId!==void 0){this.logger.log("音频尝试使用输出设备",this.sinkId);try{await this.audioDom.setSinkId(this.sinkId),this.logger.log("音频使用输出设备成功",this.sinkId)}catch(h){this.logger.error("音频输出设备切换失败",h.name,h.message,h)}}await this.audioDom.play()}}async _keepDecodeTrack(h){this.decodeAudioDom||(this.logger.log("WebAudio: initDecodeAudioDom",this.streamDestination.stream.id),this.decodeAudioDom=document.createElement("audio"),this.decodeAudioDom.srcObject=h,this.decodeAudioDom.volume=1e-4,this.decodeAudioDom.volume=0,this.decodeAudioDom.muted=!0,this._bindAudioEvent(this.decodeAudioDom),await this.decodeAudioDom.play())}_updateDecodeAudioDom(h){this.decodeAudioDom&&(this.decodeAudioDom.srcObject=h)}_destroyDecodeAudioDom(){this.decodeAudioDom&&(this.logger.log("WebAudio: destroyDecodeAudioDom"),this.decodeAudioDom.pause(),this.decodeAudioDom.srcObject=null,this.decodeAudioDom=null)}_destroyAudioDom(){this.audioDom&&(this.logger.log("WebAudio: destroyAudioDom"),this.audioDom.pause(),this.audioDom.srcObject=null,this.audioDom=null)}_bindAudioEvent(h){h.addEventListener("pause",o=>{this.logger.log(`[Play] 音频侦测到pause，当前播放状态 played: ${h.played.length}, readyState: ${h.readyState}, currentTime: ${h.currentTime}`),this.logger.log("[Play] 可能遇到了播放问题, 尝试主动恢复播放 audio"),h.play().then(()=>{this.logger.log("[Play] 主动恢复播放: audio 成功")}).catch(f=>{this.logger.error("[Play] 主动恢复播放 audio 出现问题:",f.name,f.message)})}),h.addEventListener("canplay",o=>{this.logger.log(`[Play] 音频侦测到canplay，当前播放状态 played: ${h.played.length}, readyState: ${h.readyState}, currentTime: ${h.currentTime}`)})}_bindAudioContextEvent(){this.context&&(this.context.onstatechange=h=>{var o;((o=this.context)===null||o===void 0?void 0:o.state)==="suspended"&&(this.logger.log(`[AudioContext] 状态改变: ${this.context.state}，尝试恢复`),this.context.resume().then(()=>{this.logger.log("[AudioContext] 恢复成功")}).catch(f=>{this.logger.error("[AudioContext] 恢复失败",f)}))})}getAudioContext(){return this.context?this.context:l.getParameters().disableWebAudio?(this.logger.warn("WebAudio: getParameters().disableWebAudio is true"),null):this.supports.WebAudio&&this.supports.MediaStream?(this.initWebAudio(),this.context):(this.logger.warn("WebAudio or MediaStream is not supported"),null)}}e.AudioMixer=d},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.SpatialManager=void 0;const i=r(76),a=r(1);e.SpatialManager=class{constructor(l){this.elem=document.createElement("audio"),this.fakeElem=document.createElement("audio"),this.data={},this.__v_skip=a.getParameters().enableVSkip,this.context=l.context,this.client=l.client,this.options=l.options,this.logger=l.client.adapterRef.logger.getChild(()=>"spatial");try{this.destination=new MediaStreamAudioDestinationNode(this.context)}catch(n){if(n.name!=="TypeError")throw n;this.destination=this.context.createMediaStreamDestination()}this.elem.setAttribute("playsinline","playsinline"),this.elem.setAttribute("autoplay","autoplay"),this.elem.className="nertc-panner-manager",this.elem.srcObject=this.destination.stream,this.fakeElem.muted=!0,this.fakeElem.volume=0,this.fakeElem.autoplay=!0,this.fakeElem.controls=!0}getUserData(l){const n=""+l;""+parseInt(n)!==n&&this.logger.warn("getUserData:异常的uid：",l);let c=this.data[n];return c||(c={position:{x:0,y:0}},this.data[n]=c),c}shouldSubscribe(l){const n=this.getUserData(l);return Math.abs(n.position.x)<=64&&Math.abs(n.position.y)<=64}async updatePosition(l,n){const c=this.getUserData(l),s=this.client.adapterRef.remoteStreamMap[l];if(s){const d=this.client.getSubStatus(s,"all");if(this.shouldSubscribe(l))if(d.subscribable)this.logger.log(`[remote#${l} status:${d.status}]界内，【即将订阅】: (${c.position.x}, ${c.position.y}) => (${n.x}, ${n.y})`),c.position.x=n.x,c.position.y=n.y,await this.client.doSubscribe(s),this.updatePosition(l,c.position);else{if(c.position.x===n.x&&c.position.y===n.y)return;this.logger.log(`[remote#${l} status:${d.status}]界内，即将更新remoteStream位置: (${c.position.x}, ${c.position.y}) => (${n.x}, ${n.y})`),c.position.x=n.x,c.position.y=n.y,c.audioNodes&&(c.audioNodes.pannerNode.positionX.value=n.x,c.audioNodes.pannerNode.positionY.value=n.y)}else if(d.status==="subscribed")this.logger.log(`[remote#${l} status:${d.status}]界外，【即将取消订阅】:  (${c.position.x}, ${c.position.y}) => (${n.x}, ${n.y})`),c.position.x=n.x,c.position.y=n.y,await this.client.doUnsubscribe(s),this.updatePosition(l,c.position);else{if(c.position.x===n.x&&c.position.y===n.y)return;this.logger.log(`[remote#${l} status:${d.status}]界外，即将更新remoteStream位置:  (${c.position.x}, ${c.position.y}) => (${n.x}, ${n.y})`),c.position.x=n.x,c.position.y=n.y,c.audioNodes&&(c.audioNodes.pannerNode.positionX.value=n.x,c.audioNodes.pannerNode.positionY.value=n.y)}}else this.logger.log(`updatePosition: 更新位置的stream: ${l} ( ${n.x}, ${n.y})`),c.position.x=n.x,c.position.y=n.y}init(){this.client.addListener("@stream-added",l=>{const n=this.getUserData(l.stream.getId());l.stream.setSubscribeConfig(this.options.subConfig),this.updatePosition(l.stream.getId(),n.position)}),this.client.addListener("@stream-unsubscribed",l=>{const n=this.getUserData(l.stream.getId());this.updatePosition(l.stream.getId(),n.position)}),this.client.addListener("@stream-subscribed",async l=>{this.logger.log("Subscribed to",l.stream.streamID,l.mediaType);const n=this.getUserData(l.stream.getId());l.mediaType==="audio"&&(n.audioNodes&&(n.audioNodes.pannerNode.disconnect(),n.audioNodes.source.disconnect(),n.audioNodes.gainNode.disconnect()),n.audioNodes={source:this.context.createMediaStreamSource(l.stream.mediaHelper.audio.audioStream),gainNode:this.context.createGain(),pannerNode:new PannerNode(this.context,{panningModel:"HRTF",distanceModel:"linear",rolloffFactor:1,coneInnerAngle:360,positionX:n.position.x,positionY:n.position.y,positionZ:0,maxDistance:100})},n.audioNodes.source.connect(n.audioNodes.gainNode),n.audioNodes.gainNode.connect(n.audioNodes.pannerNode),n.audioNodes.pannerNode.connect(this.destination),this.fakeElem.srcObject=l.stream.mediaHelper.audio.audioStream,this.fakeElem.play().catch(c=>{i.Device.onUserGestureNeeded&&(i.Device.onUserGestureNeeded(c),i.Device.once("user-gesture-fired",()=>{this.fakeElem.play()}))}),this.logger.log("Connected",l.stream.getId,l.stream.mediaHelper.audio.audioStream.getAudioTracks()[0])),this.updatePosition(l.stream.getId(),n.position)})}play(){this.elem.controls=!0,this.context.state==="suspended"&&i.Device.onUserGestureNeeded&&(i.Device.onUserGestureNeeded(new Error("恢复AudioContext")),i.Device.once("user-gesture-fired",()=>{this.context.resume()})),this.elem.play().catch(l=>{i.Device.onUserGestureNeeded&&(i.Device.onUserGestureNeeded(l),i.Device.once("user-gesture-fired",()=>{this.elem.play()}))})}}},function(module,exports,__webpack_require__){var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,r,i){i===void 0&&(i=r),Object.defineProperty(t,i,{enumerable:!0,get:function(){return e[r]}})}:function(t,e,r,i){i===void 0&&(i=r),t[i]=e[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)r!=="default"&&Object.prototype.hasOwnProperty.call(t,r)&&__createBinding(e,t,r);return __setModuleDefault(e,t),e},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LocalStream=void 0;const videoQuality_1=__webpack_require__(69),alerter_1=__webpack_require__(142),audioLevel_1=__webpack_require__(175),media_1=__webpack_require__(193),parameters_1=__webpack_require__(1),play_1=__webpack_require__(195),record_1=__webpack_require__(147),video_post_processing_1=__importDefault(__webpack_require__(310)),advanced_beauty_1=__importDefault(__webpack_require__(333)),basic_beauty_1=__importDefault(__webpack_require__(334)),virtual_background_1=__importDefault(__webpack_require__(335)),plugin_1=__webpack_require__(200),plugin_list_1=__webpack_require__(155),param_1=__webpack_require__(49),types_1=__webpack_require__(48),errorCode_1=__importDefault(__webpack_require__(6)),rtcError_1=__importDefault(__webpack_require__(8)),gum_1=__webpack_require__(71),param_2=__webpack_require__(49),applyResolution_1=__webpack_require__(336),env=__importStar(__webpack_require__(7)),RTCEventEmitter_1=__webpack_require__(46),utils_1=__webpack_require__(42),webAudio_1=__webpack_require__(47),StageAIProcessing_1=__webpack_require__(198),wasmDetect_1=__webpack_require__(337),audioProfile_1=__webpack_require__(338),Config_1=__webpack_require__(26);let localStreamCnt=0;class LocalStream extends RTCEventEmitter_1.RTCEventEmitter{constructor(t){if(super(),this.safariVideoSizeChange=!1,this._advancedBeautyProcessor=null,this.pluginConfigList={howlingCallback:null},this.videoPostProcessTags={isBeautyTrack:!1,isBodySegmentTrack:!1,isAdvBeautyTrack:!1},this.replaceTags={videoPost:!1,waterMark:!1,isMuted:!1},this.audioLevelHelper=null,this.audioLevelHelperSlave=null,this.__v_skip=parameters_1.getParameters().enableVSkip,this.videoProfile={frameRate:videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL,resolution:videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p},this.screenProfile={frameRate:videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_5,resolution:videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p},this.state="UNINIT",this.videoView=null,this.screenView=null,this.renderMode={local:{video:{},screen:{}}},this.inSwitchDevice={audio:!1,video:!1},this.pubStatus={audio:{audio:!1},audioSlave:{audio:!1},video:{video:!1},screen:{screen:!1}},this.muteStatus={audio:{send:!1},audioSlave:{send:!1},video:{send:!1},screen:{send:!1},videoThird:{send:!1},videoFourth:{send:!1}},this.isRemote=!1,this.active=!0,this.destroyed=!1,this.canvasWatermarkOptions=null,this.encoderWatermarkOptions=null,this.supportWasm=!0,this.supportAIAudioEffects=!0,this.supportHowling=!0,this.canEnableAIAudioEffects=!0,this.constraintSettings={audio:{},audioSlave:{},video:{},screen:{},videoThird:{},videoFourth:{}},this.basicBeautyStaticRes=e=>{this.logger.log("config basic beauty static resources."),this.WebGLSupportError(),basic_beauty_1.default.configStaticRes(e)},this.advBeautyStaticRes=e=>{this.logger.log("config advanced beauty static resources."),this.WebGLSupportError(),advanced_beauty_1.default.configStaticRes(e)},this.setAdvBeautyEffect=(...e)=>{this.logger.log("set advanced beauty parameters:"+JSON.stringify(e)),this.videoPostProcess.availableCode<1||(this.advancedBeauty.isEnable||this.logger.warn("advanced beauty is not opened."),this.advancedBeauty.setAdvEffect(...e))},this.presetAdvBeautyEffect=(...e)=>{this.logger.log("preset advanced beauty parameters:"+JSON.stringify(e)),this.videoPostProcess.availableCode<1||(this.advancedBeauty.isEnable||this.logger.warn("advanced beauty is not opened."),this.advancedBeauty.presetAdvEffect(...e))},this.localStreamId=localStreamCnt++,this.logger=t.client.adapterRef.logger.getChild(()=>{var e;let r=this.localStreamId?"local"+this.localStreamId:"localStream";if(this.mediaHelper){let i="";this.mediaHelper.audio.micTrack&&(i+="m"),this.mediaHelper.video.cameraTrack&&(i+="c"),this.mediaHelper.screen.screenVideoTrack&&(i+="s"),this.mediaHelper.screenAudio.screenAudioTrack&&(i+="t"),i&&(r+=" "+i)}return this.state!=="INITED"&&(r+=" "+this.state),this.state==="INITED"&&this.client&&((e=this.client.adapterRef.localStream)===null||e===void 0?void 0:e.localStreamId)!==this.localStreamId&&(r+=" DETACHED"),this.destroyed&&(r+=" DESTROYED"),r}),t.uid)if(typeof t.uid=="string"){if(this.logger.log("createStream: uid是string类型"),t.client.adapterRef.channelInfo.uidType="string",!/^[1-9]\d*$/.test(t.uid))throw this.logger.log("join(): uid不是数字字符串格式"),new rtcError_1.default({code:errorCode_1.default.JOIN_UID_TYPE_ERROR,message:"createStream: uid不是数字字符串格式"})}else{if(typeof t.uid!="number")throw this.logger.error("createStream: uid参数格式非法"),new rtcError_1.default({code:errorCode_1.default.STREAM_UID_ERROR,message:"createStream: uid参数格式非法"});if(this.logger.log("createStream: uid是number类型"),t.client.adapterRef.channelInfo.uidType="number",t.uid>Number.MAX_SAFE_INTEGER)throw new rtcError_1.default({code:errorCode_1.default.STREAM_UID_ERROR,message:"Number 类型的 uid 最大值是 2^53 - 1, 请输入正确的参数"})}else t.uid="local_"+this.localStreamId;this._reset(),this.streamID=t.uid,this.stringStreamID=this.streamID.toString(),this.audio=t.audio,t.audioProcessing&&(this.constraintSettings.audio=Object.assign({},t.audioProcessing)),this.microphoneId=t.microphoneId||"",this.cameraId=t.cameraId||"",this.video=t.video||!1,this.screen=t.screen||!1,this.screenAudio=t.screenAudio||!1,this.sourceId=t.sourceId||"",this.facingMode=t.facingMode||"",this.client=t.client,this.audioSource=t.audioSource||null,this.videoSource=t.videoSource||null,this.screenAudioSource=t.screenAudioSource||null,this.screenVideoSource=t.screenVideoSource||null,this._segmentProcessor=null,this._cameraTrack=null,this._transformedTrack=null,this.mediaHelper=new media_1.MediaHelper({stream:this}),this._play=new play_1.Play({stream:this}),this._record=new record_1.Record({logger:this.logger,client:this.client}),this.client._params&&this.client._params.mode==="live"?this.audioProfile="music_standard":this.audioProfile="speech_low_quality",parameters_1.getParameters().enableAlerter!=="never"&&alerter_1.alerter.watchLocalStream(this),this.logger.log("创建本地Stream: ",JSON.stringify({streamID:this.stringStreamID,audio:t.audio,video:t.video})),this.client.apiFrequencyControl({name:"createLocalStream",code:0,param:{streamID:this.stringStreamID,videoProfile:this.videoProfile,audio:this.audio,audioProfile:this.audioProfile,video:this.video,screen:this.screen,screenProfile:this.screenProfile}}),this.supportWasm=wasmDetect_1.webassemblySupported(),this.videoPostProcess=new video_post_processing_1.default(this.logger),this.basicBeauty=new basic_beauty_1.default(this.videoPostProcess),this.virtualBackground=new virtual_background_1.default(this.videoPostProcess),this.advancedBeauty=new advanced_beauty_1.default(this.videoPostProcess),env.IS_ANY_SAFARI&&this.videoPostProcess.on("safariVideoSizeChange",()=>{this.safariVideoSizeChange=!0,this.loseContext()}),this.videoPostProcess.on("contextLost",()=>{this.suspendVideoPostProcess(),this.safariVideoSizeChange?setTimeout(()=>{this.restoreContext()},0):this.emit("video-post-context-lost")}),this.videoPostProcess.on("contextRestored",e=>{this.resumeVideoPostProcess(),this.safariVideoSizeChange?this.safariVideoSizeChange=!1:(this.emit("video-post-context-restored",e),this.logger.log("webgl context restored, try to reinitialize webgl pipeline."))}),this.videoPostProcess.on("beautyResComplete",e=>{this.emit("basic-beauty-res-complete",e)}),this.videoPostProcess.on("advBeautyResComplete",e=>{this.emit("adv-beauty-res-complete",e)}),this.videoPostProcess.on("taskSwitch",e=>{if(this.replaceTags.videoPost=e,this.replaceCanvas(),e&&env.IS_ANY_SAFARI){const r=parseFloat(env.SAFARI_VERSION||"0");r<15.4&&this.logger.warn("It is detected that you are using safari and the version is lower than 15.4. For a better experience, it is recommended to use version 15.4 and above."),r===15.3&&this.logger.warn("In the current version of Safari, enabling video post-processing related functions will cause memory leaks (Safari kernel bug: capturing video streams from WebGL will cause memory leaks)."),r===15&&this.logger.warn("In the current version of Safari, enabling video post-processing related functions will cause the page to crash (Safari kernel bug: WebGL rendering WebCam will cause the page to crash).")}}),env.IS_ANY_SAFARI&&env.SAFARI_MAJOR_VERSION<15&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&this.replaceTags.videoPost&&this.logger.warn("In the current version of Safari, the page with the video post-processing function is restored from the background, the sending frame rate will slowly return to the normal frame rate from a lower value.")}),this.mediaHelper.on("preProcessChange",e=>{e.mediaType==="video"&&(this.replaceTags.waterMark=e.isOn,this.replaceCanvas())})}getAdapterRef(){var t;return((t=this.client.adapterRef.localStream)===null||t===void 0?void 0:t.localStreamId)===this.localStreamId?this.client.adapterRef:null}_reset(){this.streamID="",this.stringStreamID="",this.state="UNINIT",this.videoProfile={frameRate:videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL,resolution:videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p},this.audioProfile="speech_low_quality",this.screenProfile={frameRate:videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_5,resolution:videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p},this.audio=!1,this.microphoneId="",this.video=!1,this.cameraId="",this.screen=!1,this.screenAudio=!1,this.sourceId="",this.facingMode="",this.videoView=null,this.screenView=null,this.renderMode={local:{video:{},screen:{}}},this.inSwitchDevice={audio:!1,video:!1},this.pubStatus={audio:{audio:!1},audioSlave:{audio:!1},video:{video:!1},screen:{screen:!1}},this.muteStatus={audio:{send:!1},audioSlave:{send:!1},video:{send:!1},screen:{send:!1},videoThird:{send:!1},videoFourth:{send:!1}},this.renderMode={local:{video:{},screen:{}}},this.mediaHelper&&this.mediaHelper.destroy(),this._play&&this._play.destroy(),this._record&&this._record.destroy(),this._record=null,this.audioLevelHelper&&this.audioLevelHelper.destroy(),this.audioLevelHelper=null,this.audioLevelHelperSlave&&this.audioLevelHelperSlave.destroy(),this.audioLevelHelperSlave=null}get segmentProcessor(){return this._segmentProcessor}get Play(){return this._play}get Record(){return this._record}getId(){return this.client.adapterRef.channelInfo.uidType==="string"?this.stringStreamID:this.streamID}getAudioStream(){return this.mediaHelper?(this.client.apiFrequencyControl({name:"getAudioStream",code:0,param:JSON.stringify({streamID:this.getId()},null," ")}),this.mediaHelper.audio.audioStream):null}async init(){const t=await this.client.operationQueue.enqueue({caller:this,method:"init",options:null}),e=()=>{t();const i={audio:this.audio,video:this.video,screen:this.screen,screenAudio:this.screenAudio};(this.audio||this.screenAudio)&&(i.audioProfile=this.audioProfile,i.audioProcessing=this.constraintSettings.audio,i.audioSlaveProcessing=this.constraintSettings.audioSlave),this.video&&(i.videoProfile=this.mediaHelper.video.captureConfig.high,i.videoEncoder=this.mediaHelper.video.encoderConfig.high),this.screen&&(i.screenProfile=this.mediaHelper.screen.captureConfig.high,i.screenEncoder=this.mediaHelper.screen.encoderConfig.high),this.initVideoPostProcess(),this.client.apiFrequencyControl({name:"init",code:0,param:Object.assign({streamID:this.stringStreamID},i)}),this.client.apiFrequencyControl({name:"_trackSettings",code:0,param:JSON.stringify(this.mediaHelper.getTrackSettings())})};let r=null;this.state="INITING",this.logger.log("init() 初始化音视频流对象"),this.client.adapterRef.channelInfo.sessionConfig.maxVideoQuality=videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p,this.videoProfile&&(this.client.adapterRef.channelInfo.sessionConfig.videoQuality=this.videoProfile.resolution,this.client.adapterRef.channelInfo.sessionConfig.videoFrameRate=this.videoProfile.frameRate);try{this.audio&&await this.mediaHelper.getStream({audio:this.audio,audioDeviceId:this.microphoneId,audioSource:this.audioSource})}catch(i){this.logger.log("init() 打开mic失败: "+i.message),r=i,this.audio=!1}try{this.video&&(await this.mediaHelper.getStream({video:this.video,videoSource:this.videoSource,videoDeviceId:this.cameraId,facingMode:this.facingMode}),this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"))}catch(i){this.logger.log("init() 打开camera失败: "+i.message),r=i,this.video=!1}try{if(this.screen){const i={sourceId:this.sourceId,screen:this.screen,screenVideoSource:this.screenVideoSource,screenAudio:this.screenAudio,screenAudioSource:this.screenAudioSource};await this.mediaHelper.getStream(i),this.mediaHelper.screen.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("screen")}}catch(i){this.logger.log("init() 打开screen失败: "+i.message),r=i,this.screen=this.mediaHelper.screen.screenVideoStream.getVideoTracks().length>0,this.screenAudio=this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length>0}try{!this.screen&&this.screenAudio&&this.screenAudioSource&&await this.mediaHelper.getStream({screenAudioSource:this.screenAudioSource})}catch(i){this.logger.log("init() 打开自定义音频辅流失败: "+i.message),r=i,this.screenAudio=!1}if(this.audio||this.video||this.screen||this.screenAudio)this.state="INITED";else{if(r)throw this.state="UNINIT",this.logger.error("localStream.init失败:",r.name,r.message,r),e(),r;if(!parameters_1.getParameters().allowEmptyMedia)throw this.state="UNINIT",this.logger.warn("init() localStream不允许初始化时无任何音视频"),e(),new rtcError_1.default({code:errorCode_1.default.STREAM_PROFILE_ERROR,message:"init() localStream不允许初始化时无任何音视频"});this.logger.log("init() 当前模式下localStream允许初始化时无任何音视频"),this.state="INITED"}e()}initVideoPostProcess(){var t;(t=this.videoPostProcess)===null||t===void 0||t.init()}getAudioTrack(t="audio"){if(this.mediaHelper)return t==="audio"?this.mediaHelper.getAudioInputTracks()[0]:t==="audioSlave"?this.mediaHelper.getAudioSlaveInputTracks()[0]:null}getVideoTrack(t="video"){if(this.mediaHelper)return t==="video"?this.mediaHelper.video.cameraTrack||this.mediaHelper.video.videoSource:t==="screen"?this.mediaHelper.screen.screenVideoTrack||this.mediaHelper.screen.screenVideoSource:null}getScreenTrack(){return this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0]||null}getAudioSlaveTrack(){return this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks()[0]||null}async play(t,e={}){if((e.video||e.screen)&&!t)throw this.logger.warn(`play() localStream ${this.getId()} 播放视频没有指定div标签`),new rtcError_1.default({code:errorCode_1.default.STREAM_PLAY_ARGUMENT_ERROR,message:"play() 播放视频没有指定div标签"});param_2.isExistOptions({tag:"Stream.playOptions.audio",value:e.audio}).result||(e.audio=!1),e.audio&&!e.audioType&&(e.audioType="mixing"),param_2.isExistOptions({tag:"Stream.playOptions.video",value:e.video}).result||(e.video=!0),param_2.isExistOptions({tag:"Stream.playOptions.screen",value:e.screen}).result||(e.screen=!0),this.logger.log(`play() uid: ${this.stringStreamID}, playOptions: ${JSON.stringify(e)}`),e.audio&&this._play&&this.mediaHelper.getAudioInputTracks().length>0&&(this.logger.log(`play() uid ${this.stringStreamID} 开始播放本地音频: `,e.audioType),e.audioType==="voice"?this._play.playAudioStream("audio",this.mediaHelper.audio.micStream,e.muted):e.audioType==="music"?this._play.playAudioStream("audio",this.mediaHelper.audio.musicStream,e.muted):e.audioType==="mixing"&&this._play.playAudioStream("audio",this.mediaHelper.audio.audioStream,e.muted));let r=null;if(typeof t=="string"?r=document.getElementById(t):t&&(r=t),r){if(e.video&&(this.videoView=r,this._play&&this.mediaHelper.video.videoStream.getVideoTracks().length)){this.logger.log(`play() uid ${this.stringStreamID} 开始启动视频播放 主流 本地`);try{await this._play.playVideoStream("video",this.mediaHelper.video.renderStream,r),"width"in this.renderMode.local.video&&this._play.setRender("video",this.renderMode.local.video)}catch(i){throw this.logger.log("play() 视频播放异常: ",i),i}await this.resumeVideoPostProcess()}if(e.screen&&(this.screenView=r,this._play&&this.mediaHelper.screen.screenVideoStream.getVideoTracks().length)){this.logger.log(`play() uid ${this.stringStreamID} 开始启动视频播放 辅流 本地`);try{await this._play.playVideoStream("screen",this.mediaHelper.screen.renderStream,r),"width"in this.renderMode.local.screen&&this._play.setRender("screen",this.renderMode.local.screen)}catch(i){throw this.logger.log("play() 屏幕共享播放异常: ",i),i}}}if(e.audio){const i={enable:!0};this.client.apiFrequencyControl({name:"enableEarback",code:0,param:JSON.stringify(i,null," ")})}this.client.apiFrequencyControl({name:"play",code:0,param:JSON.stringify({streamID:this.stringStreamID,playOptions:e,isRemote:!1},null," ")})}async resume(){this._play&&(this.logger.log("resume() uid: ",this.stringStreamID),await this._play.resume()),this.client.apiFrequencyControl({name:"resume",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")})}setLocalRenderMode(t,e){if(!t||!param_1.isNumber(t.width)||!param_1.isNumber(t.height)||t.width<0||t.height<0)throw this.logger.warn("setLocalRenderMode() 参数宽高错误"),this.client.apiFrequencyControl({name:"setLocalRenderMode",code:-1,param:Object.assign({streamID:this.stringStreamID,mediaType:e},t)}),new rtcError_1.default({code:errorCode_1.default.STREAM_RENDER_ARGUMENT_ERROR,message:"setLocalRenderMode() 参数宽高错误"});this.logger.log(`setLocalRenderMode() uid ${this.stringStreamID} 设置本地视频播放窗口大小: `,e||"video+screen",JSON.stringify(t)),e&&e!=="video"||(this._play&&this._play.setRender("video",t),this.renderMode.local.video=t,this.replaceCanvas()),e&&e!=="screen"||(this.renderMode.local.screen=t,this._play&&this._play.setRender("screen",t)),this.client.apiFrequencyControl({name:"setLocalRenderMode",code:0,param:Object.assign({streamID:this.stringStreamID,mediaType:e},t)})}stop(t){this.logger.log(`stop() uid ${this.stringStreamID} 停止播放 ${t||"音视频流"}`),this._play&&(types_1.MediaTypeList.forEach(e=>{t&&e!==t||this._play.stopPlayStream(e)}),this.client.apiFrequencyControl({name:"stop",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,audio:this.audio,video:this.video,screen:this.screen,type:t},null," ")}))}isPlaying(t){if(this._play){if(types_1.MediaTypeList.indexOf(t)>-1)return this._play.isPlaying(t);throw this.logger.warn("isPlaying() unknown type"),new rtcError_1.default({code:errorCode_1.default.STREAM_ISPLAYING_ARGUMENT_ERROR,message:"isPlaying() type 参数类型非法"})}return this.client.apiFrequencyControl({name:"isPlaying",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,type:t},null," ")}),this.logger.log(`检查${this.stringStreamID}的${t}播放状态: false`),!1}canPlay(t){return types_1.MediaTypeList.indexOf(t)===-1?null:this._play.canPlay(t)}async open(t){var e,r,i,a,l,n,c;let{type:s,deviceId:d,sourceId:u,facingMode:h,screenAudio:o,audioSource:f,videoSource:m,screenAudioSource:g,screenVideoSource:v,enableMediaPub:O}=t,T=typeof O!="boolean"||O!==!1;const C=await this.client.operationQueue.enqueue({caller:this,method:"open",options:t}),A=R=>{C();const w=utils_1.makePrintable(Object.assign({},t,R.param),1);this.client.apiFrequencyControl({name:"open",code:R.code,param:Object.assign({streamID:this.stringStreamID},w)}),this.client.apiFrequencyControl({name:"_trackSettings",code:R.code,param:JSON.stringify(this.mediaHelper.getTrackSettings())})};try{switch(this.getAdapterRef()||(this.logger.log("open(): 绑定 localStream ",s),this.client.bindLocalStream(this)),s){case"audio":if(this.logger.log("open(): 开启 "+(f?f.label:"mic设备")),this.mediaHelper.audio.micTrack||this.mediaHelper.audio.audioSource)return this.logger.warn("open(): 请先关闭麦克风"),A({code:-1,param:{reason:"重复打开麦克风",type:s}}),Promise.reject(new rtcError_1.default({code:errorCode_1.default.REPEAT_OPEN_MIC_ERROR,message:"open() 重复打开麦克风"}));if(this.audio=!0,this.mediaHelper){const w={audio:!0,audioDeviceId:d,audioSource:f};await this.mediaHelper.getStream(w),this.audioLevelHelper&&this.mediaHelper.audio.audioStream&&this.audioLevelHelper.updateStream(this.mediaHelper.audio.audioStream),d&&(this.microphoneId=d),this.audioSource=f||null,this.client.adapterRef.connectState.curState!=="CONNECTED"?this.logger.log("Stream.open:client不在频道中，无需发布。",w):T&&(this.logger.log("Stream.open:开始发布",w),await((e=this.client.adapterRef._mediasoup)===null||e===void 0?void 0:e.createProduce(this,"audio"))),!((r=this.mediaHelper.audio.stageAIProcessing)===null||r===void 0)&&r.enabled&&(this.mediaHelper.audio.audioRoutingEnabled||this.mediaHelper.enableAudioRouting(),this.mediaHelper.updateWebAudio()),!((a=(i=this.mediaHelper.audio.webAudio)===null||i===void 0?void 0:i.Jungle)===null||a===void 0)&&a.connected&&(this.mediaHelper.audio.audioRoutingEnabled||this.mediaHelper.enableAudioRouting(),this.mediaHelper.updateWebAudio(),this.mediaHelper.audio.webAudio.createPitchShifter())}break;case"screenAudio":if(!g)return void this.logger.warn("open(): 不允许单独开启屏幕共享音频功能。");if(this.logger.log("open(): 开启自定义屏幕共享音频 "+g.label),this.mediaHelper.screenAudio.screenAudioTrack||this.mediaHelper.screenAudio.screenAudioSource)return this.logger.warn("请先关闭屏幕共享音频"),A({code:-1,param:{reason:"请先关闭屏幕共享音频",type:s}}),Promise.reject(new rtcError_1.default({code:errorCode_1.default.REPEAT_OPEN_AUDIO_SLAVE_ERROR,message:"open() 重复打开屏幕共享音频"}));if(this.screenAudio=!0,this.mediaHelper){const w={screenAudio:!0,screenAudioSource:g};await this.mediaHelper.getStream(w),this.audioLevelHelperSlave&&this.mediaHelper.screenAudio.screenAudioStream&&this.audioLevelHelperSlave.updateStream(this.mediaHelper.screenAudio.screenAudioStream),this.client.adapterRef.connectState.curState!=="CONNECTED"?this.logger.log("Stream.open:client不在频道中，无需发布。",w):T&&(this.logger.log("Stream.open:开始发布",w),await((l=this.client.adapterRef._mediasoup)===null||l===void 0?void 0:l.createProduce(this,"audioSlave")))}break;case"video":case"screen":if(this.logger.log(`开启${s==="video"?"camera":"screen"}设备`),this[s]){const w=s==="video";return this.logger.warn("open() 请先关闭"+(w?"摄像头":"屏幕共享")),this.client.apiFrequencyControl({name:"open",code:-1,param:JSON.stringify({reason:"open() 重复打开"+(w?"摄像头":"屏幕共享"),type:s},null," ")}),A({code:-1,param:{reason:"open() 重复打开"+(w?"摄像头":"屏幕共享"),type:s}}),Promise.reject(new rtcError_1.default({code:w?errorCode_1.default.REPEAT_OPEN_CAMERA_ERROR:errorCode_1.default.REPEAT_OPEN_SCREEN_ERROR,message:"open() 重复打开"+(w?"摄像头":"屏幕共享")}))}if(t.screenAudio&&(this.mediaHelper.screenAudio.screenAudioTrack||this.mediaHelper.screenAudio.screenAudioSource))return this.logger.warn("open() 重复开启屏幕共享音频"),A({code:-1,param:{reason:"open() 重复开启屏幕共享音频",type:s}}),Promise.reject(new rtcError_1.default({code:errorCode_1.default.REPEAT_OPEN_AUDIO_SLAVE_ERROR,message:"open() 重复开启屏幕共享音频"}));this[s]=!0;const R={videoDeviceId:d,sourceId:u,videoSource:m,screenAudioSource:g,screenVideoSource:v,facingMode:h};R[s]=!0,s==="screen"&&t.screenAudio&&(R.screenAudio=!0,this.screenAudio=!0),await this.mediaHelper.getStream(R),this.videoSource=m||null,this.screenAudio&&this.audioLevelHelperSlave&&this.mediaHelper.screenAudio.screenAudioStream&&this.audioLevelHelperSlave.updateStream(this.mediaHelper.screenAudio.screenAudioStream),s==="video"&&this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"),s==="screen"&&this.mediaHelper.screen.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("screen"),d&&s==="video"&&(this.cameraId=d),this.client.adapterRef.connectState.curState!=="CONNECTED"?this.logger.log("Stream.open:client不在频道中, 无需发布。",R):T&&(this.logger.log("Stream.open:开始发布",R),await((n=this.client.adapterRef._mediasoup)===null||n===void 0?void 0:n.createProduce(this,s)),t.screenAudio&&await((c=this.client.adapterRef._mediasoup)===null||c===void 0?void 0:c.createProduce(this,"audioSlave")));break;default:throw this.logger.warn("open() 非法参数"),new rtcError_1.default({code:errorCode_1.default.STREAM_OPTN_NO_TYPE_ERROR,message:"open() type 参数类型非法"})}A({code:0,param:{type:s}})}catch(R){throw["audio","video","screen"].indexOf(s)>-1&&(this[s]=!1,s==="screen"&&t.screenAudio&&(this.screenAudio=!1)),this.logger.log(s+" 开启失败: ",R.name,R.message),A({code:-1,param:{type:s,reason:R.message}}),new rtcError_1.default({code:R.code||errorCode_1.default.MEDIA_DEVICE_ERROR,message:`${R.name} ${R.message}`})}}async switchScreenStream(t){var e;let r=null,i=!1,a=null,l="";((e=t.screenVideoSource)===null||e===void 0?void 0:e.kind)==="video"?(r=t.screenVideoSource,i=!0):r=(await this.mediaHelper.getScreenSource({screen:this.screen})).getVideoTracks()[0],r?(a=await this.replaceTrack({mediaType:"screen",track:r,external:i}),a?(this.client.adapterRef.logger.log(`switchScreenStream: 已从 ${a.external?"自定义辅流":"屏幕共享"} 切换到 ${i?"自定义辅流":"屏幕共享"}`),a.external||a.oldTrack.stop()):(l="当前没有screen流",this.client.adapterRef.logger.error(`switchScreenStream: 无法切换到${i?"自定义辅流":"屏幕共享"}: ${l}`))):(l="无法获得新的screenVideoTrack",this.client.adapterRef.logger.error("switchScreenStream: ",l)),this.client.adapterRef.instance.apiEventReport("setFunction",{name:"switch_to_custom_screen",oper:"1",param:l||"success"}),this.client.apiFrequencyControl({name:"switchScreenStream",code:l?-1:0,param:JSON.stringify({external:i,reason:l},null," ")})}async close(t){var e,r,i,a,l,n;t||(t={type:"all"});const c=await this.client.operationQueue.enqueue({caller:this,method:"close",options:t});let s,d,u=t.type;switch(u){case"audio":if(this.logger.log("close() 关闭mic设备"),!this.audio){s=errorCode_1.default.STREAM_CLOSE_AUDIO_ERROR,d="close() 没有开启过麦克风";break}this.audio=!1,this.mediaHelper.stopStream("audio"),this.getAdapterRef()?this.mediaHelper.getAudioInputTracks().length>0?this.logger.log("close() 关闭音频，保留发布：",u):(this.logger.log("close() 停止发布音频"),await((e=this.client.adapterRef._mediasoup)===null||e===void 0?void 0:e.destroyProduce("audio"))):this.logger.log("close() 未发布音频，无需停止发布"),this.audioSource=null,!((i=(r=this.mediaHelper.audio.webAudio)===null||r===void 0?void 0:r.Jungle)===null||i===void 0)&&i.connected&&(this.mediaHelper.audio.webAudio.disconnectJungle(),this.mediaHelper.disableAudioRouting());break;case"screenAudio":if(this.logger.log("close() 关闭屏幕共享音频"),!this.screenAudio){s=errorCode_1.default.STREAM_CLOSE_AUDIO_SLAVE_ERROR,d="close() 没有开启过屏幕共享音频";break}this.screenAudio=!1,this.mediaHelper.stopStream("screenAudio"),this.getAdapterRef()?(this.logger.log("close() 停止发布音频辅流"),await((a=this.client.adapterRef._mediasoup)===null||a===void 0?void 0:a.destroyProduce("audioSlave"))):this.logger.log("close() 未发布音频，无需停止发布");break;case"video":if(this.logger.log("close() 关闭camera设备"),!this.video){s=errorCode_1.default.STREAM_CLOSE_CAMERA_ERROR,d="close() 没有开启过摄像头";break}await this.suspendVideoPostProcess(),this._transformedTrack&&this._cameraTrack&&(this._cameraTrack.stop(),this._cameraTrack=null),this._transformedTrack&&(this._transformedTrack.stop(),this._transformedTrack=null),this.video=!1,this.mediaHelper.stopStream("video"),this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.disablePreProcessing("video",!0),this==null||this._play.stopPlayStream("video"),this.getAdapterRef()?(this.logger.log("close() 停止发布视频"),await((l=this.client.adapterRef._mediasoup)===null||l===void 0?void 0:l.destroyProduce("video"))):this.logger.log("close() 未发布视频，无需停止发布"),this.replaceTags.isMuted&&(this.replaceTags.isMuted=!1,this.virtualBackground.emptyFrame=!1),this.videoSource=null;break;case"screen":if(this.logger.log("close() 关闭屏幕共享"),!this.screen){s=errorCode_1.default.STREAM_CLOSE_SCREEN_ERROR,d="close() 没有开启过屏幕共享";break}this.screen=!1,this.mediaHelper.screen.preProcessingEnabled&&this.mediaHelper.disablePreProcessing("screen",!0),this.mediaHelper.stopStream("screen"),this==null||this._play.stopPlayStream("screen"),this.getAdapterRef()?(this.logger.log("Stream.close: 停止发布辅流"),await((n=this.client.adapterRef._mediasoup)===null||n===void 0?void 0:n.destroyProduce("screen"))):this.logger.log("Stream.close: 未发布辅流，无需停止发布");break;case"all":this.logger.log(`Stream.close:关闭所有设备: audio ${this.audio}, video ${this.video}, screen ${this.screen}, screenAudio ${this.screenAudio}`),this.audio&&await this.close({type:"audio"}),this.video&&await this.close({type:"video"}),this.screen&&await this.close({type:"screen"}),this.screenAudio&&await this.close({type:"screenAudio"}),this.logger.log(`Stream.close:关闭所有设备成功: audio ${this.audio}, video ${this.video}, screen ${this.screen}, screenAudio ${this.screenAudio}`);break;default:s=errorCode_1.default.STREAM_CLOSE_ARGUMENT_ERROR,d="close() Unknown Type"}if(s)throw this.logger.error(d),this.client.apiFrequencyControl({name:"close",code:-1,param:JSON.stringify({reason:d,streamID:this.stringStreamID,audio:this.audio,video:this.video,screen:this.screen,type:t.type},null," ")}),c(),new rtcError_1.default({code:s,message:d});return c(),void this.client.apiFrequencyControl({name:"close",code:0,param:JSON.stringify({reason:s,streamID:this.stringStreamID,audio:this.audio,video:this.video,screen:this.screen,screenAudio:this.screenAudio,type:t.type},null," ")})}async unmuteAudio(){var t,e;this.logger.log("unmuteAudio() 启用音频轨道: ",this.stringStreamID);try{this.getAdapterRef()&&await((t=this.client.adapterRef._mediasoup)===null||t===void 0?void 0:t.unmuteAudio());const r=this.mediaHelper.audio.audioStream.getAudioTracks();r&&r.length&&r.forEach(i=>{i.enabled=!0}),this.mediaHelper.getAudioInputTracks().forEach(i=>{i.enabled=!0}),!((e=this.mediaHelper.audio.webAudio)===null||e===void 0)&&e.gainFilter&&(this.mediaHelper.audio.webAudio.gainFilter.gain.value=1),this.muteStatus.audio.send=!1,this.client.apiFrequencyControl({name:"unmuteAudio",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")})}catch(r){this.logger.error("unmuteAudio() 异常: ",r.name,r.message,r),this.client.apiFrequencyControl({name:"unmuteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:r.message},null," ")})}}async muteAudio(){var t,e;this.logger.log("muteAudio() 禁用音频轨道: ",this.stringStreamID);try{this.getAdapterRef()&&await((t=this.client.adapterRef._mediasoup)===null||t===void 0?void 0:t.muteAudio());const r=this.mediaHelper.audio.audioStream.getAudioTracks();r&&r.length&&r.forEach(i=>{i.enabled=!1}),this.mediaHelper.getAudioInputTracks().forEach(i=>{i.enabled=!1}),!((e=this.mediaHelper.audio.webAudio)===null||e===void 0)&&e.gainFilter&&(this.mediaHelper.audio.webAudio.gainFilter.gain.value=0),this.muteStatus.audio.send=!0,this.client.apiFrequencyControl({name:"muteAudio",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")})}catch(r){this.logger.error("muteAudio() 异常: ",r.name,r.message,r),this.client.apiFrequencyControl({name:"muteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:r.message},null," ")})}}async unmuteAudioSlave(){var t;this.logger.log("unmuteAudioSlave() 启用音频辅流轨道: ",this.stringStreamID);try{this.getAdapterRef()&&await((t=this.client.adapterRef._mediasoup)===null||t===void 0?void 0:t.unmuteAudioSlave());const e=this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks();e&&e.length&&e.forEach(r=>{r.enabled=!0}),this.muteStatus.audioSlave.send=!1,this.client.apiFrequencyControl({name:"unmuteAudioSlave",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("unmuteAudioSlave() 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteAudioSlave",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}async muteAudioSlave(){var t;this.logger.log("muteAudioSlave() 禁用音频辅流轨道: ",this.stringStreamID);try{this.getAdapterRef()&&await((t=this.client.adapterRef._mediasoup)===null||t===void 0?void 0:t.muteAudioSlave());const e=this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks();e&&e.length&&e.forEach(r=>{r.enabled=!1}),this.muteStatus.audioSlave.send=!0,this.client.apiFrequencyControl({name:"muteAudioSlave",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("muteAudioSlave() 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteAudioSlave",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}hasAudio(){return this.mediaHelper.getAudioInputTracks().length>0}hasAudioSlave(){return this.mediaHelper.getAudioSlaveInputTracks().length>0}getAudioLevel(t="audio"){var e,r;let i=0;switch(i=t==="audio"?((e=this.AudioLevelHelper)===null||e===void 0?void 0:e.getAudioLevel())||i:((r=this.AudioLevelHelperSlave)===null||r===void 0?void 0:r.getAudioLevel())||i,parameters_1.getParameters().audioLevelFittingAlgorithm){case"classic":return i;case"linear":return Math.max(0,Math.min(100,Math.round(200*i)));case"log2":return Math.max(0,Math.min(100,Math.round(8.638*Math.log2(i)+97.244)))}}getAudioSlaveLevel(){return this.mediaHelper.getGain()}enableAudioFrame(t=1e3){if(this.logger.log(`enableAudioFrame() 音频数据时长:  ${t} ms, mediaType: audio`),t<100||t>1e5)return this.logger.error("enableAudioFrame() 音频数据时长应该在 100 - 100000 毫秒之间"),!1;if(!this.AudioLevelHelper)return this.logger.warn("enableAudioFrame() 音频数据回调开启失败，AudioLevelHelper未初始化"),!1;if(this.AudioLevelHelper.enableAudioData)return this.logger.warn("enableAudioFrame() 音频数据回调已开启,请勿重复开启"),!0;this.AudioLevelHelper.enableAudioData=!0,this.logger.log("enableAudioFrame() 开启音频数据回调");const e=this._setAudioFrameDuration(t);return this.client.apiFrequencyControl({name:"enableAudioFrame",code:e?0:-1,param:{streamID:this.stringStreamID,duration:t,mediaType:"audio"}}),e}disableAudioFrame(){var t;return!((t=this.AudioLevelHelper)===null||t===void 0)&&t.enableAudioData?(this.AudioLevelHelper.enableAudioData=!1,this.logger.log("disableAudioFrame() 关闭音频数据回调, mediaType: audio"),this.client.apiFrequencyControl({name:"disableAudioFrame",code:0,param:{streamID:this.stringStreamID,mediaType:"audio"}}),!0):(this.logger.log("disableAudioFrame() 音频数据回调未开启,请勿重复关闭"),!1)}_setAudioFrameDuration(t=1e3){var e;return!!(!((e=this.AudioLevelHelper)===null||e===void 0)&&e.setBufferTime(t))}get AudioLevelHelper(){if(!this.audioLevelHelper&&this.mediaHelper.audio.audioStream.getAudioTracks().length){const t=webAudio_1.getAudioContext();t&&t.audioWorklet&&t.audioWorklet.addModule||(this.logger.error("AudioContext is not supported in this browser"),this.client.safeEmit("error","AUDIOLEVEL_NOT_SUPPORTED")),this.audioLevelHelper=new audioLevel_1.AudioLevel({stream:this.mediaHelper.audio.audioStream,logger:this.logger}),this.audioLevelHelper.on("audio-data",e=>{this.emit("audio-data",e)})}return this.audioLevelHelper}get AudioLevelHelperSlave(){return!this.audioLevelHelperSlave&&this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length&&(this.audioLevelHelperSlave=new audioLevel_1.AudioLevel({stream:this.mediaHelper.screenAudio.screenAudioStream,logger:this.logger})),this.audioLevelHelperSlave}setAudioProfile(t){param_1.checkValidEnum({tag:"LocalStream.setAudioProfile",value:t,enums:audioProfile_1.AudioProfile}),this.logger.log("setAudioProfile() 设置音频属性: ",t),this.audioProfile=t,this.client.apiFrequencyControl({name:"setAudioProfile",code:0,param:{streamID:this.stringStreamID,profile:t}})}setAudioProcessing(t,e){param_1.checkValidEnum({tag:"LocalStream.setAudioProcessing",value:t,enums:types_1.MediaTypeList});const r=this.constraintSettings[t],i=Object.assign({},r,e);return this.constraintSettings[t]=i,this.logger.log(`setAudioProcessing ${t} ${JSON.stringify(r)} => ${JSON.stringify(i)}`),t==="audio"&&this.mediaHelper.getAudioInputTracks().length||t==="audioSlave"&&this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length?(this.logger.warn("setAudioProcessing：当前已有开启音频。3A开关设置仅在重启音频后生效"),this.client.apiFrequencyControl({name:"setAudioProcessing",code:-1,param:JSON.stringify(e)})):this.client.apiFrequencyControl({name:"setAudioProcessing",code:0,param:JSON.stringify(e)}),this.mediaHelper.getAudioConstraints(t)}setAudioVolume(t=100){var e;let r,i;(!Number.isInteger(t)||t<0||t>100)&&(r=errorCode_1.default.SET_AUDIO_VOLUME_ARGUMENTS_ERROR,i="setAudioVolume() volume 应该为 0 - 100 的整数");const a=t/100;if(this.logger.log(`setAudioVolume() 调节${this.stringStreamID}的音量大小: ${2.55*t} (normalized: ${a})`),this.audio?(e=this._play)===null||e===void 0||e.setPlayVolume("audio",a):(i="setAudioVolume() 没有音频流，请检查是否有发布过音频",r=errorCode_1.default.SET_AUDIO_VOLUME_ERROR),this.client.apiFrequencyControl({name:"setAudioVolume",code:r?-1:0,param:{streamID:this.stringStreamID,isRemote:!1,volume:2.55*t,normalizedVolume:a,reason:i}}),r)throw this.logger.error(i),new rtcError_1.default({code:r,message:i})}setCaptureVolume(t,e){let r,i;if(Number.isInteger(t)?(t<0||t>1e3)&&(r=errorCode_1.default.STREAM_SET_CAPTURE_VOLUME_ARGUMENT_ERROR,i="setCaptureVolume() volume 应该为 0 - 1000 的整数"):(r=errorCode_1.default.SET_CAPTURE_VOLUME_ARGUMENTS_ERROR,i="setCaptureVolume() volume 应该为 0 - 1000 的整数"),this.client.apiFrequencyControl({name:"setCaptureVolume",code:r?-1:0,param:JSON.stringify({streamID:this.stringStreamID,audioType:e,volume:t},null," ")}),r)throw this.logger.error(i),new rtcError_1.default({code:r,message:i});this.logger.log(`setCaptureVolume() 调节${this.stringStreamID}的音量大小: ${t}`),this.mediaHelper.audio.audioRoutingEnabled||this.mediaHelper.enableAudioRouting(),this.mediaHelper.setGain(t/100,e)}setAudioEffectLite(t,e){this.logger.log(`setAudioEffectLite: ${t}  ${e}`),this.mediaHelper.audio.audioRoutingEnabled||this.mediaHelper.enableAudioRouting(),this.mediaHelper.setAudioEffectLite(t,e),this.client.apiFrequencyControl({name:"setAudioEffectLite",code:0,param:JSON.stringify({streamID:this.stringStreamID,type:t,value:e,isRemote:!1})})}disableAudioEffectLite(){this.logger.log("disableAudioEffectLite() 关闭音效"),this.mediaHelper.setAudioEffectLite("close",0),this.mediaHelper.audio.audioRoutingEnabled&&this.mediaHelper.disableAudioRouting(),this.client.apiFrequencyControl({name:"disableAudioEffectLite",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1})})}async setAudioOutput(t,e){if(this._play){try{await this._play.setAudioOutput(t)}catch(r){throw e&&setTimeout(()=>{e(r)},0),this.logger.error("设置输出设备失败",r.name,r.message),new rtcError_1.default({code:errorCode_1.default.SET_AUDIO_OUTPUT_ERROR,message:r.message||"系统内部错误"})}e&&setTimeout(e,0)}this.client.apiFrequencyControl({name:"setAudioOutput",code:0,param:JSON.stringify({streamID:this.stringStreamID,deviceId:t,isRemote:!1},null," ")})}async switchDevice(t,e){var r,i,a,l;this.logger.log(`switchDevice() 切换媒体输入设备: ${t}, deviceId: ${e}`);let n,c,s={};if(this.inSwitchDevice[t]?(c="switchDevice() 正在切换中, 重复切换 "+t,n=errorCode_1.default.SWITCH_DEVICE_REPEAT_ERROR):this.inSwitchDevice[t]=!0,t==="audio"){const d=this.mediaHelper.audio.micTrack;let u;if(u="getSettings"in MediaStreamTrack.prototype?d==null?void 0:d.getSettings().deviceId:(i=(r=d==null?void 0:d.getConstraints())===null||r===void 0?void 0:r.deviceId)===null||i===void 0?void 0:i.exact,(d==null?void 0:d.readyState)==="live"&&u===e)return this.logger.warn("switchDevice() 切换相同的麦克风设备，不处理"),void(this.inSwitchDevice[t]=!1);if(this.hasAudio()?this.audioSource&&(c="switchDevice() 自定义音频输入不支持，无法切换",n=errorCode_1.default.SWITCH_DEVICE_NO_SUPPORT_AUDIO):(c="switchDevice() 当前没有开启音频输入设备，无法切换",n=errorCode_1.default.SWITCH_DEVICE_NO_MIC_ERROR),n)throw this.logger.error(c),this.inSwitchDevice[t]=!1,this.client.apiFrequencyControl({name:"switchDevice",code:-1,param:{reason:c,type:t,deviceId:e,streamID:this.stringStreamID}}),new rtcError_1.default({code:n,message:c});this.mediaHelper.audio.micConstraint&&this.mediaHelper.audio.micConstraint.audio?this.mediaHelper.audio.micConstraint.audio.deviceId={exact:e}:this.mediaHelper.audio.micConstraint?(this.mediaHelper.audio.micConstraint.audio={},this.mediaHelper.audio.micConstraint.audio.deviceId={exact:e}):this.mediaHelper.audio.micConstraint={audio:{deviceId:{exact:e}}},s=this.mediaHelper.audio.micConstraint,this.microphoneId=e}else{if(t!=="video")return this.logger.error("switchDevice() type参数错误: "+t),Promise.reject(new rtcError_1.default({code:errorCode_1.default.SWITCH_DEVICE_REPEAT_ARGUMENTS_ERROR,message:"switchDevice() type参数错误: "+t}));{const d=this.mediaHelper.video.cameraTrack;let u;if(await this.suspendVideoPostProcess(),this._transformedTrack&&(this._transformedTrack.stop(),this._transformedTrack=null),u="getSettings"in MediaStreamTrack.prototype?d==null?void 0:d.getSettings().deviceId:(l=(a=d==null?void 0:d.getConstraints())===null||a===void 0?void 0:a.deviceId)===null||l===void 0?void 0:l.exact,(d==null?void 0:d.readyState)==="live"&&u===e)return this.logger.log("switchDevice() 切换相同的摄像头设备，不处理"),void(this.inSwitchDevice[t]=!1);if(this.hasVideo()?this.videoSource&&(c="switchDevice() 自定义视频输入不支持切换",n=errorCode_1.default.SWITCH_DEVICE_NO_SUPPORT_VIDEO):(c="switchDevice() 当前没有开启视频输入设备，无法切换",n=errorCode_1.default.SWITCH_DEVICE_NO_CAMERA_ERROR),n)return this.logger.error(c),this.inSwitchDevice[t]=!1,this.client.apiFrequencyControl({name:"switchDevice",code:-1,param:{reason:c,type:t,deviceId:e,streamID:this.stringStreamID}}),Promise.reject(new rtcError_1.default({code:n,message:c}));this.mediaHelper.video.cameraConstraint&&this.mediaHelper.video.cameraConstraint.video&&(this.mediaHelper.video.cameraConstraint.video.deviceId={exact:e},s=this.mediaHelper.video.cameraConstraint),this.cameraId=e,this.replaceTags.isMuted&&(this.replaceTags.isMuted=!1,this.virtualBackground.emptyFrame=!1)}}try{const d=this.mediaHelper.video.preProcessingEnabled;d&&this.mediaHelper.disablePreProcessing("video"),await this.mediaHelper.getSecondStream(s),this.inSwitchDevice[t]=!1,d&&this.mediaHelper.enablePreProcessing("video"),t==="video"&&await this.resumeVideoPostProcess(),t==="audio"&&this.audioLevelHelper&&this.audioLevelHelper.updateStream(this.mediaHelper.audio.audioStream),this.client.apiFrequencyControl({name:"switchDevice",code:0,param:{type:t,deviceId:e,streamID:this.stringStreamID}}),this.client.apiFrequencyControl({name:"_trackSettings",code:0,param:JSON.stringify(this.mediaHelper.getTrackSettings())}),this._play.resume()}catch(d){throw this.logger.error("switchDevice() 异常：",d.name,d.message,d),this.inSwitchDevice[t]=!1,this.client.apiFrequencyControl({name:"switchDevice",code:-1,param:{reason:d.message,type:t,deviceId:e,streamID:this.stringStreamID}}),this.client.apiFrequencyControl({name:"_trackSettings",code:0,param:JSON.stringify(this.mediaHelper.getTrackSettings())}),new rtcError_1.default({code:d.code||errorCode_1.default.UNKNOWN_TYPE_ERROR,message:d.message||d.name})}}async unmuteVideo(){var t,e;this.logger.log(`unmuteVideo() 启用 ${this.stringStreamID} 的视频轨道`);try{if(this.virtualBackground&&(this.virtualBackground.emptyFrame=!1),this.getAdapterRef()&&((t=this.client.adapterRef._mediasoup)===null||t===void 0||t.unmuteVideo()),this.mediaHelper.video.videoSource&&(this.mediaHelper.video.videoSource.enabled=!0),this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!0),this.videoPostProcess.sourceTrack&&(this.videoPostProcess.sourceTrack.enabled=!0),env.IS_SAFARI){const r=(e=this._play)===null||e===void 0?void 0:e.video.containerDom;r&&(r.style.backgroundColor="")}this.muteStatus.video.send=!1,this.client.apiFrequencyControl({name:"unmuteVideo",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")}),this.replaceTags.isMuted=!1}catch(r){this.logger.error("unmuteVideo() 异常: ",r.name,r.message,r),this.client.apiFrequencyControl({name:"unmuteVideo",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:r.message},null," ")})}}async muteVideo(){var t,e;this.logger.log(`muteVideo() 禁用 ${this.stringStreamID} 的视频轨道`);try{if(this.virtualBackground&&(this.virtualBackground.emptyFrame=!0),env.IS_SAFARI){const r=(t=this._play)===null||t===void 0?void 0:t.video.dom;r&&(r.style.backgroundColor="black")}this.getAdapterRef()&&await((e=this.client.adapterRef._mediasoup)===null||e===void 0?void 0:e.muteVideo()),this.mediaHelper.video.videoSource&&(this.mediaHelper.video.videoSource.enabled=!1),this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!1),this.videoPostProcess.sourceTrack&&(this.videoPostProcess.sourceTrack.enabled=!1),this.muteStatus.video.send=!0,this.client.apiFrequencyControl({name:"muteVideo",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")}),this.replaceTags.isMuted=!0}catch(r){this.logger.error("muteVideo() 异常: ",r.name,r.message,r),this.client.apiFrequencyControl({name:"muteVideo",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:r.message},null," ")}),this.replaceTags.isMuted=!1}}async unmuteScreen(){var t;this.logger.log(`unmuteScreen() 启用 ${this.stringStreamID} 的视频轨道`);try{this.getAdapterRef()&&((t=this.client.adapterRef._mediasoup)===null||t===void 0||t.unmuteScreen()),this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!0),this.mediaHelper.screen.screenVideoSource&&(this.mediaHelper.screen.screenVideoSource.enabled=!0),this.muteStatus.screen.send=!1,this.client.apiFrequencyControl({name:"unmuteScreen",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")})}catch(e){this.logger.error("unmuteScreen() 异常: ",e.name,e.message),this.client.apiFrequencyControl({name:"unmuteScreen",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")})}}async muteScreen(){var t;this.logger.log(`muteScreen() 禁用 ${this.stringStreamID} 的辅流轨道`);try{this.getAdapterRef()&&await((t=this.client.adapterRef._mediasoup)===null||t===void 0?void 0:t.muteScreen()),this.mediaHelper.screen.screenVideoSource&&(this.mediaHelper.screen.screenVideoSource.enabled=!1),this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!1),this.muteStatus.screen.send=!0,this.client.apiFrequencyControl({name:"muteScreen",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")})}catch(e){this.logger.error("muteScreen() ",e.message),this.client.apiFrequencyControl({name:"muteScreen",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")})}}hasVideo(){return this.logger.log("hasVideo()"),this.mediaHelper.video.videoStream.getVideoTracks().length>0}async setVideoProfile(t){t.resolution>-1&&(this.videoProfile.resolution=t.resolution),t.frameRate>-1&&(this.videoProfile.frameRate=t.frameRate),this.mediaHelper.video.captureConfig.high=this.mediaHelper.convert(this.videoProfile),this.mediaHelper.video.encoderConfig.high.maxBitrate=this.getVideoBW(this.videoProfile)||this.mediaHelper.video.encoderConfig.high.maxBitrate,this.logger.log(`setVideoProfile() options: ${JSON.stringify(t)}, 视频采集参数: ${JSON.stringify(this.mediaHelper.video.captureConfig.high)}, 编码参数: ${JSON.stringify(this.mediaHelper.video.encoderConfig.high)}`),this.client.adapterRef.channelInfo.sessionConfig.maxVideoQuality=videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p,this.client.adapterRef.channelInfo.sessionConfig.videoQuality=this.videoProfile.resolution,this.client.adapterRef.channelInfo.sessionConfig.videoFrameRate=this.videoProfile.frameRate;let e=this.mediaHelper.video.cameraTrack;if(this.videoPostProcess.hasAnyTask&&(this.logger.log("setVideoProfile() 侦测到美颜在开启状态"),e=this.videoPostProcess.sourceTrack),e)try{let i;this.logger.log(`setVideoProfile() 尝试动态修改分辨率【${e.label}】`),await applyResolution_1.applyResolution({track:e,targetWidth:this.mediaHelper.video.captureConfig.high.width,targetHeight:this.mediaHelper.video.captureConfig.high.height,keepAspectRatio:parameters_1.getParameters().keepAspectRatio,logger:this.logger}),i=e&&"getSettings"in MediaStreamTrack.prototype?e.getSettings():e.getConstraints(),i.width&&i.height&&(this.mediaHelper.video.cameraConstraint.video.width=i.width,this.mediaHelper.video.cameraConstraint.video.height=i.height)}catch(i){this.logger.error("setVideoProfile() 无法设置动态分辨率:",i.name,i.message)}const r=this.getSender("video","high");if(r){const i=r.getParameters(),a=i.encodings&&i.encodings[0];if((a==null?void 0:a.maxBitrate)!==this.mediaHelper.video.encoderConfig.high.maxBitrate){this.logger.log(`setVideoProfile() 调整上行码率 ${a.maxBitrate} => ${this.mediaHelper.video.encoderConfig.high.maxBitrate}`),a.maxBitrate=this.mediaHelper.video.encoderConfig.high.maxBitrate;try{r.setParameters(i)}catch(l){this.logger.warn("setVideoProfile() 无法调整上行码率: ",l.name,l.message)}}}this.client.apiFrequencyControl({name:"setVideoProfile",code:0,param:Object.assign({streamID:this.stringStreamID},t)}),this.replaceCanvas()}setVideoEncoderConfiguration(t){if(t.mediaType=t.mediaType||"video",t.streamType=t.streamType||"high",this.logger.log("setVideoEncoderConfiguration() 自定义视频编码配置: ",t),this.mediaHelper[t.mediaType].encoderConfig[t.streamType]){if(t.maxBitrate){const e=1e3*t.maxBitrate;this.logger.log(`setVideoEncoderConfiguration() 设置maxBitrate ${t.mediaType} ${t.streamType} ${this.mediaHelper[t.mediaType].encoderConfig[t.streamType].maxBitrate} => ${e}`),this.mediaHelper[t.mediaType].encoderConfig[t.streamType].maxBitrate=e}else this.logger.log("setVideoEncoderConfiguration:未设定maxBitrate。保留目前的值: ",t.mediaType,t.streamType,this.mediaHelper[t.mediaType].encoderConfig[t.streamType].maxBitrate);typeof t.contentHint=="string"?(this.logger.log(`setVideoEncoderConfiguration: 应用 contentHint ${t.mediaType} ${t.streamType} ${this.mediaHelper[t.mediaType].encoderConfig[t.streamType].contentHint} => ${t.contentHint}`),this.mediaHelper[t.mediaType].encoderConfig[t.streamType].contentHint=t.contentHint):this.logger.log("setVideoEncoderConfiguration: 未设定 contentHint。保留目前的值：",t.mediaType,t.streamType,this.mediaHelper[t.mediaType].encoderConfig[t.streamType].contentHint)}else this.logger.warn("setVideoEncoderConfiguration() 无法识别的媒体类型：",t.mediaType,t.streamType);this.getSender(t.mediaType,t.streamType)&&this.applyEncoderConfig(t.mediaType,t.streamType),this.client.apiFrequencyControl({name:"setVideoEncoderConfiguration",code:0,param:{streamID:this.stringStreamID,options:t}})}async replaceTrack(t){let e,r=!1,i=!1,a="video";if(t.mediaType==="screen")i=this.mediaHelper.screen.preProcessingEnabled,a=t.mediaType,i&&this.mediaHelper.disablePreProcessing("screen"),this.mediaHelper.screen.screenVideoTrack?(e=this.mediaHelper.screen.screenVideoTrack,this.mediaHelper.screen.screenVideoTrack=null):this.mediaHelper.screen.screenVideoSource&&(r=!0,e=this.mediaHelper.screen.screenVideoSource,this.mediaHelper.screen.screenVideoSource=null),e&&(t.external?this.mediaHelper.screen.screenVideoSource=t.track:this.mediaHelper.screen.screenVideoTrack=t.track,gum_1.emptyStreamWith(this.mediaHelper.screen.screenVideoStream,t.track),gum_1.emptyStreamWith(this.mediaHelper.screen.renderStream,t.track),this.mediaHelper.screen.screenVideoStream.getVideoTracks().length&&typeof this.mediaHelper.screen.encoderConfig.high.contentHint=="string"&&this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.mediaHelper.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.mediaHelper.screen.encoderConfig.high.contentHint),this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.mediaHelper.screen.encoderConfig.high.contentHint));else if(t.mediaType==="video"){const l=this.mediaHelper.video.preProcessingEnabled;a=t.mediaType,l&&this.mediaHelper.disablePreProcessing("video"),this.mediaHelper.video.cameraTrack?(e=this.mediaHelper.video.cameraTrack,this.mediaHelper.video.cameraTrack=null):this.mediaHelper.video.videoSource&&(r=!0,e=this.mediaHelper.video.videoSource,this.mediaHelper.video.videoSource=null),e&&(t.external?this.mediaHelper.video.videoSource=t.track:this.mediaHelper.video.cameraTrack=t.track,gum_1.emptyStreamWith(this.mediaHelper.video.videoStream,t.track),gum_1.emptyStreamWith(this.mediaHelper.video.renderStream,t.track),this.mediaHelper.video.videoStream.getVideoTracks().length&&typeof this.mediaHelper.video.encoderConfig.high.contentHint=="string"&&this.mediaHelper.video.videoStream.getVideoTracks()[0].contentHint!==this.mediaHelper.video.encoderConfig.high.contentHint&&(this.logger.log("replaceTrack() 应用 contentHint video high",this.mediaHelper.video.encoderConfig.high.contentHint),this.mediaHelper.video.videoStream.getVideoTracks()[0].contentHint=this.mediaHelper.video.encoderConfig.high.contentHint),this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"))}if(!e)return this.logger.error(`replaceTrack() ${t.mediaType} 当前没有可替换的流`),null;if(this.logger.log(`replaceTrack ${t.mediaType}【external: ${r} ${e.label}】=>【external: ${t.external} ${t.track.label}】`),gum_1.watchTrack(t.track),this.mediaHelper.listenToTrackEnded(t.track),i)this.mediaHelper.enablePreProcessing(a);else{const l=this.getSender(t.mediaType,"high");l&&(l.replaceTrack(t.track),this.logger.log(`replaceTrack() ${t.mediaType} 成功替换上行`))}return this.replaceTags.isMuted&&this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!1),{oldTrack:e,external:r}}hasScreen(){return this.mediaHelper.screen.screenVideoStream.getVideoTracks().length>0}setScreenProfile(t){t.frameRate>-1&&(this.screenProfile.frameRate=t.frameRate),t.resolution>-1&&(this.screenProfile.resolution=t.resolution),this.mediaHelper.screen.captureConfig.high=this.mediaHelper.convert(this.screenProfile),this.mediaHelper.screen.encoderConfig.high.maxBitrate=this.getVideoBW(this.screenProfile),this.logger.log(`setScreenProfile() profile: ${JSON.stringify(t)}, 屏幕共享采集参数: ${JSON.stringify(this.mediaHelper.screen.captureConfig.high)}, 编码参数: ${JSON.stringify(this.mediaHelper.screen.encoderConfig.high)}`),this.client.adapterRef.channelInfo.sessionConfig.screenQuality=t,this.mediaHelper.screen.screenVideoTrack&&applyResolution_1.applyResolution({track:this.mediaHelper.screen.screenVideoTrack,targetWidth:this.mediaHelper.screen.captureConfig.high.width,targetHeight:this.mediaHelper.screen.captureConfig.high.height,keepAspectRatio:parameters_1.getParameters().keepAspectRatio,logger:this.logger});const e=this.getSender("screen","high");if(e){const r=e.getParameters(),i=r.encodings&&r.encodings[0];if((i==null?void 0:i.maxBitrate)!==this.mediaHelper.screen.encoderConfig.high.maxBitrate){this.logger.log(`setScreenProfile() 调整上行码率 ${i.maxBitrate} => ${this.mediaHelper.screen.encoderConfig.high.maxBitrate}`),i.maxBitrate=this.mediaHelper.screen.encoderConfig.high.maxBitrate;try{e.setParameters(r)}catch(a){this.logger.error("setScreenProfile() 无法调整上行码率",a.name,a.message)}}}this.client.apiFrequencyControl({name:"setScreenProfile",code:0,param:Object.assign({streamID:this.stringStreamID},t)})}getSender(t,e){var r,i,a;const l=(a=(i=(r=this.getAdapterRef())===null||r===void 0?void 0:r._mediasoup)===null||i===void 0?void 0:i._sendTransport)===null||a===void 0?void 0:a.handler._pc;let n=null;return l&&(t==="audio"&&(n=e==="high"?l.audioSender:null),t==="video"?n=e==="high"?l.videoSender:l.videoSenderLow:t==="screen"?n=e==="high"?l.screenSender:l.screenSenderLow:t==="audioSlave"&&(n=l.audioSlaveSender)),n||null}applyEncoderConfig(t,e){let r=this.mediaHelper[t].encoderConfig[e].maxBitrate;if(!r)return;let i=this.getSender(t,e);if(!i)return void this.logger.error("localStream.applyEncoderConfig: cannot find sender for ",t,e);let a=this.mediaHelper[t].encoderConfig[e].contentHint;typeof a=="string"&&i.track&&i.track.contentHint!==a&&(this.logger.log(`applyEncoderConfig 应用 contentHint：${t} ${e} ${i.track.contentHint} => ${a}`),i.track.contentHint=a);const l=i.getParameters();let n;l.encodings&&l.encodings.length?(n=l.encodings[0].maxBitrate,l.encodings[0].maxBitrate=r):l.encodings=[{maxBitrate:r}],i.setParameters(l).then(()=>{this.logger.log(`最大编码码率：${t} ${e} ${n?n+"=>":""}${r}`)}).catch(c=>{this.logger.error(`应用最大编码码率失败：${t} ${e} ${r}`,l,c.name,c.message)})}getVideoBW(t){return t.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_180p?t.frameRate<=videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15?14e4:22e4:t.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p?t.frameRate<=videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15?5e5:75e4:t.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_720p?t.frameRate<=videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15?113e4:171e4:t.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p?t.frameRate<=videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15?208e4:315e4:(this.logger.warn("发现不支持的 NERTC_VIDEO_QUALITY "+t.resolution),8e5)}async takeSnapshot(t){var e,r,i,a;let l,n;const c=this.video&&((r=(e=this._play)===null||e===void 0?void 0:e.video)===null||r===void 0?void 0:r.dom),s=this.screen&&((a=(i=this.Play)===null||i===void 0?void 0:i.screen)===null||a===void 0?void 0:a.dom);if(c||s?(this.logger.log("takeSnapshot() options: "+JSON.stringify(t)),await this._play.takeSnapshot(t,"download",this.streamID),this.client.apiFrequencyControl({name:"takeSnapshot",code:0,param:Object.assign({streamID:this.stringStreamID,isRemote:!1},t)})):(n="takeSnapshot(): 没有视频流, 请检查视频是否正在播放",l=errorCode_1.default.STREAM_TAKE_SNAPSHOT_ERROR),l)throw this.logger.error(n),this.client.apiFrequencyControl({name:"takeSnapshot",code:-1,param:JSON.stringify(Object.assign(Object.assign({streamID:this.stringStreamID,isRemote:!1},t),{reason:n}),null," ")}),new rtcError_1.default({code:l,message:n})}takeSnapshotBase64(t){var e,r,i,a;let l,n;const c=this.video&&((r=(e=this._play)===null||e===void 0?void 0:e.video)===null||r===void 0?void 0:r.dom),s=this.screen&&((a=(i=this.Play)===null||i===void 0?void 0:i.screen)===null||a===void 0?void 0:a.dom);if(c||s){let d=this._play.takeSnapshot(t,"base64");return this.client.apiFrequencyControl({name:"takeSnapshotBase64",code:0,param:Object.assign({streamID:this.stringStreamID,isRemote:!1},t)}),d}if(n="takeSnapshotBase64(): 没有视频流, 请检查视频是否正在播放",l=errorCode_1.default.STREAM_TAKE_SNAPSHOT_ERROR,l)throw this.logger.error(n),this.client.apiFrequencyControl({name:"takeSnapshotBase64",code:-1,param:JSON.stringify(Object.assign(Object.assign({streamID:this.stringStreamID,isRemote:!1},t),{reason:n}),null," ")}),new rtcError_1.default({code:l,message:n})}getCurrentFrameData(t={mediaType:"video"}){return this._play.getCurrentFrameData(t)}async startMediaRecording(t){const e=[];switch(t.type){case"screen":e.push(this.mediaHelper.screen.screenVideoStream),e.push(this.mediaHelper.audio.audioStream);break;case"camera":case"video":e.push(this.mediaHelper.video.videoStream),e.push(this.mediaHelper.audio.audioStream);break;case"audio":if(e.push(this.mediaHelper.audio.audioStream),this.client.adapterRef.remoteStreamMap)for(var r in this.client.adapterRef.remoteStreamMap){const i=this.client.adapterRef.remoteStreamMap[r];e.push(i.mediaHelper.audio.audioStream)}}if(e.length!==0){if(!this._record||!this.streamID||!e)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_ERROR,message:"localStream_startMediaRecording: 开始录制时参数异常"});return this._record&&this._record.start({uid:this.client.adapterRef.channelInfo.uidType==="string"?this.stringStreamID:this.streamID,type:t.type,reset:t.reset,stream:e})}this.logger.log("未发现要录制的媒体流")}stopMediaRecording(t){if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"localStream.stopMediaRecording: 录制未开始"});return this._record.stop({})}playMediaRecording(t){if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"localStream.playMediaRecording: 录制未开始"});return this._record.play(t.view)}listMediaRecording(){let t=[];if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"localStream.listMediaRecording: 录制未开始"});const e=this._record.getRecordStatus();return e.status!=="init"&&t.push(e),t}cleanMediaRecording(t){if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"localStream.cleanMediaRecording: 录制未开始"});return this._record.clean()}downloadMediaRecording(t){if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"localStream.downloadMediaRecording: 录制未开始"});return this._record.download()}startAudioMixing(t){if(this.logger.log("startAudioMixing() 开始伴音"),t.replace&&(this.canEnableAIAudioEffects=!1),t.auidoMixingEnd){const e=this,r=t.auidoMixingEnd;t.auidoMixingEnd=function(){e.canEnableAIAudioEffects=!0,r.apply(this,arguments)}}return this.mediaHelper.startAudioMixing(t)}stopAudioMixing(){return this.logger.log("stopAudioMixing() 停止伴音"),this.canEnableAIAudioEffects=!0,this.mediaHelper.stopAudioMixing()}pauseAudioMixing(){return this.logger.log("pauseAudioMixing() 暂停伴音"),this.mediaHelper.pauseAudioMixing()}resumeAudioMixing(){return this.logger.log("resumeAudioMixing() 恢复伴音"),this.mediaHelper.resumeAudioMixing()}adjustAudioMixingVolume(t){return this.logger.log("adjustAudioMixingVolume() 调节伴音音量: ",t),this.mediaHelper.setAudioMixingVolume(t)}getAudioMixingDuration(){return this.logger.log("getAudioMixingDuration() 获取伴音总时长"),this.mediaHelper.getAudioMixingTotalTime()}getAudioMixingCurrentPosition(){return this.mediaHelper.getAudioMixingPlayedTime()}setAudioMixingPosition(t){return this.logger.log("setAudioMixingPosition() 设置伴音音频文件的播放位置: ",t),this.mediaHelper.setAudioMixingPlayTime(t)}async playEffect(t){return this.logger.log("playEffect() 开始播放音效: ",JSON.stringify(t,null," ")),this.mediaHelper.playEffect(t)}async stopEffect(t){return this.logger.log("stopEffect() 停止播放音效: ",t),this.mediaHelper.stopEffect(t)}async pauseEffect(t){return this.logger.log("pauseEffect() 暂停播放音效：",t),this.mediaHelper.pauseEffect(t)}async resumeEffect(t){return this.logger.log("resumeEffect() 恢复播放音效文件: ",t),this.mediaHelper.resumeEffect(t)}async setVolumeOfEffect(t,e){return this.logger.log(`setVolumeOfEffect() 调节 ${t} 音效文件音量为: ${e}`),this.mediaHelper.setVolumeOfEffect(t,e)}async preloadEffect(t,e){return this.logger.log(`preloadEffect() 预加载 ${t} 音效文件地址: ${e}`),this.mediaHelper.preloadEffect(t,e)}async unloadEffect(t){return this.logger.log("unloadEffect() 释放指定音效文件 "+t),this.mediaHelper.unloadEffect(t)}getEffectsVolume(){return this.logger.log("getEffectsVolume() 获取所有音效文件播放音量"),this.mediaHelper.getEffectsVolume()}setEffectsVolume(t){return this.logger.log("setEffectsVolume() 设置所有音效文件播放音量:",t),this.mediaHelper.setEffectsVolume(t)}async stopAllEffects(){return this.logger.log("stopAllEffects() 停止播放所有音效文件"),this.mediaHelper.stopAllEffects()}async pauseAllEffects(){return this.logger.log("pauseAllEffects() 暂停播放所有音效文件"),this.mediaHelper.pauseAllEffects()}async resumeAllEffects(){return this.logger.log("resumeAllEffects() 恢复播放所有音效文件"),this.mediaHelper.resumeAllEffects()}getAudioEffectsDuration(t){return this.logger.log("getAudioEffectsDuration() 获取音效总时长"),this.mediaHelper.getAudioEffectsTotalTime(t)}getAudioEffectsCurrentPosition(t){return this.mediaHelper.getAudioEffectsPlayedTime(t)}setCanvasWatermarkConfigs(t){if(this._play){let e=t.mediaType==="screen"?this._play.screen.canvasWatermark:this._play.video.canvasWatermark;if(!e)return void this.logger.error("setCanvasWatermarkConfigs：播放器未初始化",t.mediaType);const r={TEXT:10,IMAGE:4};if(t.textWatermarks&&t.textWatermarks.length>r.TEXT)throw this.logger.error(`目前的文字水印数量：${t.textWatermarks.length}。允许的数量：${r.TEXT}`),new rtcError_1.default({code:errorCode_1.default.WATERMARKS_EXCEEDED_ERROR,message:"最多可以设置 10 个文字水印"});if(t.imageWatermarks&&t.imageWatermarks.length>r.IMAGE)throw this.logger.error(`目前的图片水印数量：${t.imageWatermarks.length}。允许的数量：${r.IMAGE}`),new rtcError_1.default({code:errorCode_1.default.WATERMARKS_EXCEEDED_ERROR,message:"最多可以设置 4 个图片水印"});e.checkWatermarkParams(t),e.updateWatermarks(t),this.canvasWatermarkOptions=t,this.client.apiFrequencyControl({name:"setLocalCanvasWatermarkConfigs",code:0,param:{streamID:this.stringStreamID,isRemote:!1,mediaType:t.mediaType}})}else this.logger.error("setCanvasWatermarkConfigs: 播放器未初始化")}setEncoderWatermarkConfigs(t){var e,r;if(this._play&&this._play){const i=t.mediaType||"video",a=this._play[i].encoderWatermark;if(!a)return void this.logger.error("setEncoderWatermarkConfigs: 播放器未初始化",t.mediaType);!((e=t.textWatermarks)===null||e===void 0)&&e.length||t.timestampWatermarks||!((r=t.imageWatermarks)===null||r===void 0)&&r.length?(a.handler.enabled=!0,this.mediaHelper[i].preProcessingEnabled||this.mediaHelper.enablePreProcessing(i)):(a.handler.enabled=!1,this.mediaHelper.canDisablePreProcessing(i)&&this.mediaHelper.disablePreProcessing(i));const l={TEXT:10,IMAGE:4};if(t.textWatermarks&&t.textWatermarks.length>l.TEXT)throw this.logger.error(`目前的文字水印数量：${t.textWatermarks.length}。允许的数量：${l.TEXT}`),new rtcError_1.default({code:errorCode_1.default.WATERMARKS_EXCEEDED_ERROR,message:"最多可以设置 10 个文字水印"});if(t.imageWatermarks&&t.imageWatermarks.length>l.IMAGE)throw this.logger.error(`目前的图片水印数量：${t.imageWatermarks.length}。允许的数量：${l.IMAGE}`),new rtcError_1.default({code:errorCode_1.default.WATERMARKS_EXCEEDED_ERROR,message:"最多可以设置 4 个图片水印"});a.checkWatermarkParams(t),a.updateWatermarks(t),this.encoderWatermarkOptions=t,this.client.apiFrequencyControl({name:"setEncoderWatermarkConfigs",code:0,param:JSON.stringify(t,null,2)})}else this.logger.error("setEncoderWatermarkConfigs: 播放器未初始化")}getMuteStatus(t){if(types_1.MediaTypeList.indexOf(t)>-1)return{muted:this.muteStatus[t].send};throw new Error("getMuteStatus Invalid Media "+t)}WebGLSupportError(){if(this.videoPostProcess.availableCode===0)throw new rtcError_1.default({code:errorCode_1.default.WEBGL_NOT_SUPPORT_ERROR,message:"当前环境不支持 WebGL"});if(this.videoPostProcess.availableCode===-2)throw new rtcError_1.default({code:errorCode_1.default.WEBGL_NOT_INIT,message:"WebGL 未初始化"})}setBeautyEffectOptions(t){if(this.logger.log("set basic beauty parameters:",t),!(this.videoPostProcess.availableCode<1)){this.basicBeauty.isEnable||this.logger.warn("basic beauty is not opened.");for(const e in t)try{t[e]=Math.min(Math.max(parseFloat(t[e]+""),0),1)}catch(r){t[e]=0,this.logger.error("setBeautyEffectOptions:"+r.message)}this.lastEffects=Object.assign(Object.assign({},this.lastEffects),t),this.basicBeauty.setBeautyOptions(t)}}async setBeautyEffect(t,e=!1){if(this.logger.log((t?"start":"close")+" basic beauty."),this.WebGLSupportError(),t&&this.videoPostProcess.availableCode<2)return this.logger.error(this.videoPostProcess.glErrorTip);const r=this.basicBeauty;if(!e){if(t&&r.isEnable)return this.logger.warn("basic beauty is already opened");if(!t&&!r.isEnable)return this.logger.warn("basic beauty is already closed")}if(this.videoPostProcessTags.isBeautyTrack=t,this.mediaHelper&&this.mediaHelper.video.cameraTrack){this.replaceTags.waterMark&&this.mediaHelper.disablePreProcessing("video",!0),this._cameraTrack=this.mediaHelper.video.cameraTrack;let i=0;try{this._transformedTrack=await r.setBeauty(t,this._cameraTrack),await this.replacePluginTrack({mediaType:"video",track:this._transformedTrack,external:!1})}catch(a){i=-1,this.logger.error("setBeautyEffect:"+a.message)}if(this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"),t&&i===0){let a;a=this.lastEffects?this.lastEffects:{brightnessLevel:0,rednessLevel:0,smoothnessLevel:0},r.setBeautyOptions(a)}e||this.client.apiFrequencyControl({name:"setBeautyEffect",code:i,param:{streamID:this.stringStreamID,isRemote:!1,isEnable:t}})}else this.logger.log("setBeautyEffect:video track not ready.")}setFilter(t,e){if(this.logger.log("set beauty filter parameters:"+JSON.stringify([t,e])),!(this.videoPostProcess.availableCode<1)){this.basicBeauty.isEnable||this.logger.warn("basic beauty is not opened.");try{e!==void 0&&(e=Math.min(Math.max(parseFloat(e+""),0),1))}catch(r){e=void 0,this.logger.error("setFilter:"+r.message)}this.lastFilter=t,this.basicBeauty.setFilter(t,e)}}enableBodySegment(){return new Promise((t,e)=>{if(this.logger.log("start virtual background."),this.WebGLSupportError(),this.videoPostProcess.availableCode<2)throw this.logger.error(this.videoPostProcess.glErrorTip),new rtcError_1.default({code:errorCode_1.default.WEBGL_NOT_INIT,message:this.videoPostProcess.glErrorTip});if(!this.videoPostProcess.getPlugin("VirtualBackground"))throw this.logger.error("virtual background plugin is not register."),new rtcError_1.default({code:errorCode_1.default.PLUGIN_NOT_REGISTER,message:"virtual background plugin is not register"});if(this._segmentProcessor)return this.logger.warn("virtual background is already opened."),t(0);env.IS_ANY_SAFARI&&parseFloat(env.SAFARI_VERSION||"0")<15&&this.logger.warn("In the current version of Safari, wasm has low execution efficiency, which will result in low frame rate when background-segmentation is enabled."),this._initSegmentProcessor(t,e)})}_initSegmentProcessor(t,e){this._segmentProcessor=this.virtualBackground,this._segmentProcessor.init(),this._segmentProcessor.once("segment-load",async()=>{var r;let i=0;try{await this._startBodySegment(),this.client.apiFrequencyControl({name:"enableBodySegment",code:i,param:{streamID:this.stringStreamID}}),t()}catch(a){(r=this._segmentProcessor)===null||r===void 0||r.destroy(),this._segmentProcessor=null,i=-1,this.logger.error("enableBodySegment:"+a.message),this.client.apiFrequencyControl({name:"enableBodySegment",code:i,param:{streamID:this.stringStreamID}}),e(a)}})}async disableBodySegment(){if(this.logger.log("close virtual background."),this.WebGLSupportError(),this._segmentProcessor){let t=0;try{await this._cancelBodySegment(),this._segmentProcessor.destroy(),this._segmentProcessor=null}catch(e){t=-1,this.logger.error("disableBodySegment:"+e.message)}this.client.apiFrequencyControl({name:"disableBodySegment",code:t,param:{streamID:this.stringStreamID}})}else this.logger.warn("virtual background is already closed.")}async _startBodySegment(){this.videoPostProcess.availableCode<2||this._segmentProcessor&&(await this.transformTrack(!0,this._segmentProcessor),this.videoPostProcessTags.isBodySegmentTrack=!0)}async _cancelBodySegment(){this.videoPostProcess.availableCode<1||this._segmentProcessor&&(await this.transformTrack(!1,this._segmentProcessor),this.videoPostProcessTags.isBodySegmentTrack=!1)}setBackground(t){this.logger.log("set virtual background parameters:"+JSON.stringify(t)),this.videoPostProcess.availableCode<1||(this.virtualBackground.isEnable||this.logger.warn("virtual background is not opened."),this.virtualBackground.setVirtualBackGround(t))}setBackGround(t){this.setBackground(t)}enableAdvancedBeauty(t){return new Promise((e,r)=>{if(this.logger.log("start advanced beauty."),this.WebGLSupportError(),this.videoPostProcess.availableCode<2)throw this.logger.error(this.videoPostProcess.glErrorTip),new rtcError_1.default({code:errorCode_1.default.WEBGL_NOT_INIT,message:this.videoPostProcess.glErrorTip});if(!this.videoPostProcess.getPlugin("AdvancedBeauty"))throw this.logger.error("advanced beauty plugin is not register."),new rtcError_1.default({code:errorCode_1.default.PLUGIN_NOT_REGISTER,message:"advanced beauty plugin is not register"});if(this._advancedBeautyProcessor)return this.logger.warn("advanced beauty is already opened."),e(0);env.IS_ANY_SAFARI&&parseFloat(env.SAFARI_VERSION||"0")<15&&this.logger.warn("In the current version of Safari, wasm has low execution efficiency, which will result in low frame rate when advanced-beauty is enabled."),this._initAdvancedBeautyProcessor(e,r,t)})}_initAdvancedBeautyProcessor(t,e,r){this._advancedBeautyProcessor=this.advancedBeauty,this._advancedBeautyProcessor.init(r),this._advancedBeautyProcessor.once("facePoints-load",async()=>{var i;let a=0;try{await this._startAdvancedBeauty(),this.client.apiFrequencyControl({name:"enableAdvancedBeauty",code:a,param:{streamID:this.stringStreamID}}),t()}catch(l){(i=this._advancedBeautyProcessor)===null||i===void 0||i.destroy(),this._advancedBeautyProcessor=null,a=-1,this.logger.error("enableAdvancedBeauty:"+l.message),this.client.apiFrequencyControl({name:"enableAdvancedBeauty",code:a,param:{streamID:this.stringStreamID}}),e(l)}})}async disableAdvancedBeauty(){if(this.logger.log("close advanced beauty."),this.WebGLSupportError(),this._advancedBeautyProcessor){let t=0;try{await this._cancelAdvancedBeauty(),this._advancedBeautyProcessor.destroy(),this._advancedBeautyProcessor=null}catch(e){t=-1,this.logger.error("disableAdvancedBeauty:"+e.message)}this.client.apiFrequencyControl({name:"disableAdvancedBeauty",code:t,param:{streamID:this.stringStreamID}})}else this.logger.warn("advanced beauty is already closed.")}async _startAdvancedBeauty(){this.videoPostProcess.availableCode<2||this._advancedBeautyProcessor&&(await this.transformTrack(!0,this._advancedBeautyProcessor),this.videoPostProcessTags.isAdvBeautyTrack=!0)}async _cancelAdvancedBeauty(){this.videoPostProcess.availableCode<1||this._advancedBeautyProcessor&&(await this.transformTrack(!1,this._advancedBeautyProcessor),this.videoPostProcessTags.isAdvBeautyTrack=!1)}async enableAIDenoise(){if(!this.canEnableAIAudioEffects)return this.logger.error("请先关闭伴音功能"),!1;if(!this.supportAIAudioEffects)throw new rtcError_1.default({code:errorCode_1.default.PLUGIN_NOT_SUPPORT,message:"Unsupport Plugin, Please check your plugin version"});let t;if(this.logger.log("start denoise."),this.mediaHelper.audio.stageAIProcessing)t=this.mediaHelper.audio.stageAIProcessing;else{const r=webAudio_1.getAudioContext();if(!r)return this.logger.error("当前环境不支持AudioContext"),!1;t=new StageAIProcessing_1.StageAIProcessing(r,this.logger),this.mediaHelper.audio.stageAIProcessing=t}if(!t.getPluginConfig("AIAudioEffects"))throw this.logger.error("AIAudioEffects plugin is not register."),new rtcError_1.default({code:errorCode_1.default.PLUGIN_NOT_REGISTER,message:"AIAudioEffects plugin is not register"});t.enabled=!0;const e=t.getProcessor("AIAudioEffects");return e?(e.getState("AIDenoise")?this.logger.warn("ai denoise is already opened."):(e.setState("AIDenoise",!0),this.emit("ai-denoise-enabled"),this.client.apiFrequencyControl({name:"enableAIDenoise",code:0,param:{streamID:this.stringStreamID}})),!0):(t.once("effects-load",async()=>{this.logger.log("ai audio effects loaded");const r=t.getProcessor("AIAudioEffects");r==null||r.setState("AIDenoise",!0),this.emit("ai-denoise-enabled"),this.client.apiFrequencyControl({name:"enableAIDenoise",code:0,param:{streamID:this.stringStreamID}}),this.mediaHelper.audio.audioRoutingEnabled||this.mediaHelper.enableAudioRouting(),this.mediaHelper.updateWebAudio()}),await t.initProcessor("AIAudioEffects"),!0)}async disableAIDenoise(){this.logger.log("close ai denoise.");const t=this.mediaHelper.audio.stageAIProcessing,e=t==null?void 0:t.getProcessor("AIAudioEffects");return t?e?(e.setState("AIDenoise",!1),e.getState("AIDenoise")||e.getState("AudioEffect")||(this.logger.log("AIDenoise and AudioEffect are both closed. destroy AIAudioEffects Processor"),t.destroyProcessor("AIAudioEffects")),t.hasWorkingPlugin()||(t.enabled=!1,this.mediaHelper.updateWebAudio(),this.mediaHelper.canDisableAudioRouting()&&this.mediaHelper.disableAudioRouting()),this.client.apiFrequencyControl({name:"disableAIDenoise",code:0,param:{streamID:this.stringStreamID}}),!1):(this.logger.warn("ai denoise is already closed."),!0):(this.logger.warn("disableAIDenoise: audio process is not created"),!0)}setAIVadEnable(t){var e;this.logger.log("setAIVadEnable:"+JSON.stringify(t));const r=(e=this.mediaHelper.audio.stageAIProcessing)===null||e===void 0?void 0:e.getProcessor("AIAudioEffects");r?r.getState("AIDenoise")?(r.setAIVadEnable(t),this.client.apiFrequencyControl({name:"setAIVadEnable",code:0,param:{streamID:this.stringStreamID,options:JSON.stringify(t)}})):this.logger.warn("ai denoise is not opened."):this.logger.warn("audioEffectsProcessor is not created.")}async enableAudioEffect(){if(!this.canEnableAIAudioEffects)return this.logger.error("请先关闭伴音功能"),!1;if(!this.supportAIAudioEffects)throw new rtcError_1.default({code:errorCode_1.default.PLUGIN_NOT_SUPPORT,message:"Unsupport Plugin, Please check your plugin version"});let t;if(this.logger.log("start audio effect."),this.mediaHelper.audio.stageAIProcessing)t=this.mediaHelper.audio.stageAIProcessing;else{const r=webAudio_1.getAudioContext();if(!r)return this.logger.error("当前环境不支持AudioContext"),!1;t=new StageAIProcessing_1.StageAIProcessing(r,this.logger),this.mediaHelper.audio.stageAIProcessing=t}if(!t.getPluginConfig("AIAudioEffects"))throw this.logger.error("AudioEffects plugin is not register."),new rtcError_1.default({code:errorCode_1.default.PLUGIN_NOT_REGISTER,message:"ai audio effect plugin is not register"});t.enabled=!0;const e=t.getProcessor("AIAudioEffects");return e?(e.getState("AudioEffect")?this.logger.warn("audio effect is already opened."):(e.setState("AudioEffect",!0),this.emit("audio-effect-enabled"),this.client.apiFrequencyControl({name:"enableAudioEffect",code:0,param:{streamID:this.stringStreamID}})),!0):(t.once("effects-load",async()=>{this.logger.log("ai audio effects loaded");const r=t.getProcessor("AIAudioEffects");r==null||r.setState("AudioEffect",!0),this.emit("audio-effect-enabled"),this.client.apiFrequencyControl({name:"enableAudioEffect",code:0,param:{streamID:this.stringStreamID}}),this.mediaHelper.audio.audioRoutingEnabled||this.mediaHelper.enableAudioRouting(),this.mediaHelper.updateWebAudio()}),await t.initProcessor("AIAudioEffects"),!0)}async disableAudioEffect(){this.logger.log("close audio effect.");const t=this.mediaHelper.audio.stageAIProcessing,e=t==null?void 0:t.getProcessor("AIAudioEffects");return t?e?(e==null||e.setState("AudioEffect",!1),e!=null&&e.getState("AIDenoise")||e!=null&&e.getState("AudioEffect")||(this.logger.log("AIDenoise and AudioEffect are both closed. destroy AIAudioEffects Processor"),t.destroyProcessor("AIAudioEffects")),t.hasWorkingPlugin()||(t.enabled=!1,this.mediaHelper.updateWebAudio(),this.mediaHelper.canDisableAudioRouting()&&this.mediaHelper.disableAudioRouting()),this.client.apiFrequencyControl({name:"disableAudioEffect",code:0,param:{streamID:this.stringStreamID}}),!0):(this.logger.warn("ai audio effect is already closed."),!0):(this.logger.warn("disableAudioEffect: audio process is not created"),!0)}setAudioEffect(t,e){this.logger.log(`setAudioEffect:${t} `,JSON.stringify(e));const r=this.mediaHelper.audio.stageAIProcessing,i=r==null?void 0:r.getProcessor("AIAudioEffects");i!=null&&i.getState("AudioEffect")?(i.setAudioEffect(t,e),this.client.apiFrequencyControl({name:"setAudioEffect",code:0,param:{streamID:this.stringStreamID,type:t,value:JSON.stringify(e)}})):this.logger.warn("audio effect is not opened.")}async enableAIhowling(){if(!this.canEnableAIAudioEffects)return this.logger.error("请先关闭伴音功能"),!1;if(!this.supportHowling)throw new rtcError_1.default({code:errorCode_1.default.PLUGIN_NOT_SUPPORT,message:"Unsupport Plugin, Please check your plugin version"});let t;if(this.logger.log("start ai howling."),this.mediaHelper.audio.stageAIProcessing)t=this.mediaHelper.audio.stageAIProcessing;else{const e=webAudio_1.getAudioContext();if(!e)return this.logger.error("当前环境不支持AudioContext"),!1;t=new StageAIProcessing_1.StageAIProcessing(e,this.logger),this.mediaHelper.audio.stageAIProcessing=t}if(!t.getPluginConfig("AIhowling"))throw this.logger.error("AIhowling plugin is not register."),new rtcError_1.default({code:errorCode_1.default.PLUGIN_NOT_REGISTER,message:"aihowling plugin is not register"});return t.enabled=!0,t.getProcessor("AIhowling")?(this.logger.warn("ai howling is already opened."),!0):(t.once("aihowling-load",async()=>{this.logger.log("ai howling loaded"),this.pluginConfigList.howlingCallback&&(this.onAudioHasHowling(this.pluginConfigList.howlingCallback),this.pluginConfigList.howlingCallback=null),this.emit("ai-howling-enabled"),this.mediaHelper.audio.audioRoutingEnabled||this.mediaHelper.enableAudioRouting(),this.mediaHelper.updateWebAudio()}),await t.initProcessor("AIhowling"),this.client.apiFrequencyControl({name:"enableAIhowling",code:0,param:{streamID:this.stringStreamID}}),!0)}async disableAIhowling(){this.logger.log("close ai howling.");const t=this.mediaHelper.audio.stageAIProcessing,e=t==null?void 0:t.getProcessor("AIhowling");return t?e?(t.destroyProcessor("AIhowling"),t.hasWorkingPlugin()||(t.enabled=!1,this.mediaHelper.updateWebAudio(),this.mediaHelper.canDisableAudioRouting()&&this.mediaHelper.disableAudioRouting()),this.client.apiFrequencyControl({name:"disableAIhowling",code:0,param:{streamID:this.stringStreamID}}),!0):(this.logger.warn("aihowling is already closed."),!0):(this.logger.warn("disableAIhowling: audio process is not created"),!0)}onAudioHasHowling(t){this.logger.log("set onAudioHasHowling callback");const e=this.mediaHelper.audio.stageAIProcessing,r=e==null?void 0:e.getProcessor("AIhowling");r?(r.setHowlingCallback(t),this.client.apiFrequencyControl({name:"onAudioHasHowling",code:0,param:{streamID:this.stringStreamID}})):(this.pluginConfigList.howlingCallback=t,this.logger.warn("onAudioHasHowling: audio process is not created"))}async replacePluginTrack(t){if(this.videoPostProcess.availableCode<1)return;let e,r=!1;if(t.mediaType==="screen"?(this.mediaHelper.screen.screenVideoTrack?(e=this.mediaHelper.screen.screenVideoTrack,this.mediaHelper.screen.screenVideoTrack=null):this.mediaHelper.screen.screenVideoSource&&(r=!0,e=this.mediaHelper.screen.screenVideoSource,this.mediaHelper.screen.screenVideoSource=null),e&&(t.external?this.mediaHelper.screen.screenVideoSource=t.track:this.mediaHelper.screen.screenVideoTrack=t.track,gum_1.emptyStreamWith(this.mediaHelper.screen.screenVideoStream,t.track),gum_1.emptyStreamWith(this.mediaHelper.screen.renderStream,t.track),this.mediaHelper.screen.screenVideoStream.getVideoTracks().length&&typeof this.mediaHelper.screen.encoderConfig.high.contentHint=="string"&&this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.mediaHelper.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.mediaHelper.screen.encoderConfig.high.contentHint),this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.mediaHelper.screen.encoderConfig.high.contentHint))):t.mediaType==="video"&&(this.mediaHelper.video.cameraTrack?(e=this.mediaHelper.video.cameraTrack,this.mediaHelper.video.cameraTrack=null):this.mediaHelper.video.videoSource&&(r=!0,e=this.mediaHelper.video.videoSource,this.mediaHelper.video.videoSource=null),e&&(t.external?this.mediaHelper.video.videoSource=t.track:this.mediaHelper.video.cameraTrack=t.track,gum_1.emptyStreamWith(this.mediaHelper.video.videoStream,t.track),gum_1.emptyStreamWith(this.mediaHelper.video.renderStream,t.track),this.mediaHelper.video.videoStream.getVideoTracks().length&&typeof this.mediaHelper.video.encoderConfig.high.contentHint=="string"&&this.mediaHelper.video.videoStream.getVideoTracks()[0].contentHint!==this.mediaHelper.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.mediaHelper.video.encoderConfig.high.contentHint),this.mediaHelper.video.videoStream.getVideoTracks()[0].contentHint=this.mediaHelper.video.encoderConfig.high.contentHint))),!e)return this.logger.error(`replaceTrack ${t.mediaType} 当前没有可替换的流`),null;this.logger.log(`replaceTrack ${t.mediaType}【external: ${r} ${e.label}】=>【external: ${t.external} ${t.track.label}】`),gum_1.watchTrack(t.track),this.mediaHelper.listenToTrackEnded(t.track);const i=this.getSender(t.mediaType,"high");return i&&(i.replaceTrack(t.track),this.logger.log(`replaceTrack ${t.mediaType} 成功替换上行`)),this.replaceTags.isMuted&&this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!1),{oldTrack:e,external:r}}async transformTrack(t,e){if(!(this.videoPostProcess.availableCode<1)&&e)if(this.mediaHelper&&this.mediaHelper.video.cameraTrack){this.replaceTags.waterMark&&this.mediaHelper.disablePreProcessing("video",!0),this._cameraTrack=this.mediaHelper.video.cameraTrack;let r=null;try{this._transformedTrack=await e.setTrack(t,this._cameraTrack),this._transformedTrack&&await this.replacePluginTrack({mediaType:"video",track:this._transformedTrack,external:!1})}catch(i){r=i}if(this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"),r)throw r}else this.logger.log("transformTrack:video track not ready.")}async registerPlugin(options){if(this.logger.log("register plugin: "+options.key),options.async)return this.registerPluginAsync(options);if(!this.supportWasm)throw this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:"unsupportWasm"}}),new rtcError_1.default({code:errorCode_1.default.WEBGL_NOT_SUPPORT_ERROR,message:`该浏览器不支持WebAssembly，注册 ${options.key} 失败。`});if(options.key==="AIhowling"&&env.CHROME_MAJOR_VERSION&&env.CHROME_MAJOR_VERSION<77)throw this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:"unsupportChromeVersion: "+env.CHROME_MAJOR_VERSION}}),new rtcError_1.default({code:errorCode_1.default.PLUGIN_NOT_SUPPORT_BROWSER,message:`该浏览器版本不支持插件 ${options.key}，请升级浏览器。`});if(this.videoPostProcess.getPlugin(options.key))return this.logger.warn(`plugin ${options.key} already exists.`);const stageAIProcessing=this.mediaHelper.audio.stageAIProcessing;if(stageAIProcessing!=null&&stageAIProcessing.getPluginConfig(options.key))return this.logger.warn(`plugin ${options.key} already exists.`),!1;let plugin=null;options.adapterRef=this.client.adapterRef;try{if(options.pluginUrl?(await plugin_1.loadPlugin(options.key,options.pluginUrl),plugin=eval(`new window.${options.key}(options)`)):options.pluginObj&&(plugin=new options.pluginObj(options)),!plugin)throw new rtcError_1.default({code:errorCode_1.default.PLUGIN_LOADED_ERROR,message:"unsupport plugin "+options.key});plugin.once("plugin-load",()=>{if(plugin.version!==Config_1.SDK_VERSION)throw this.logger.error(`插件 ${options.key} 版本不匹配，当前SDK版本为 ${Config_1.SDK_VERSION}，插件版本为 ${plugin.version}。`),new rtcError_1.default({code:errorCode_1.default.PLUGIN_VERSION_ERROR,message:`插件 ${options.key} 版本不匹配，当前SDK版本为 ${Config_1.SDK_VERSION}，插件版本为 ${plugin.version}。`});if(this.logger.log(`plugin ${options.key} loaded`),plugin_list_1.videoPlugins.indexOf(options.key)!==-1)this.WebGLSupportError(),this.videoPostProcess.registerPlugin(options.key,plugin);else{if(plugin_list_1.audioPlugins.indexOf(options.key)===-1)throw new Error("unsupport plugin "+options.key+JSON.stringify(options));{let t;if(this.mediaHelper.audio.stageAIProcessing)t=this.mediaHelper.audio.stageAIProcessing;else{const r=webAudio_1.getAudioContext();if(!r)return this.logger.error("当前环境不支持AudioContext"),!1;t=new StageAIProcessing_1.StageAIProcessing(r,this.logger),this.mediaHelper.audio.stageAIProcessing=t}options.key=="AIAudioEffects"&&(this.supportAIAudioEffects=!0),options.key=="AIhowling"&&(this.supportHowling=!0);const e=Object.assign(Object.assign({},options),{blobUrl:plugin.url,wasmBinary:plugin.wasmBinary});t.registerPlugin(e),t.once("error",r=>{const{msg:i,key:a}=r;this.logger.error(`plugin ${options.key} error: ${a} ${i}`),a=="AIAudioEffects"&&(this.supportAIAudioEffects=!1),a=="AIhowling"&&(this.supportHowling=!1),this.unregisterPlugin(a),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:`插件 ${options.key} 内部错误：${i}。`}})}),t.on("plugin-process-unstable",r=>{this.emit("plugin-process-unstable",Object.assign({streamID:this.stringStreamID},r))})}}this.emit("plugin-load",options.key),this.client.apiFrequencyControl({name:"registerPlugin",code:0,param:{streamID:this.stringStreamID,plugin:options.key}})}),plugin.once("plugin-load-error",t=>{this.emit("plugin-load-error",{key:options.key,msg:`load ${options.wasmUrl} error.`}),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:`load ${options.wasmUrl} error.`}})}),plugin.once("error",t=>{options.key=="AIAudioEffects"&&(this.supportAIAudioEffects=!1),options.key=="AIhowling"&&(this.supportHowling=!1),this.unregisterPlugin(options.key),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:`插件 ${options.key} 内部错误：${t}。`}})})}catch(t){throw this.emit("plugin-load-error",{key:options.key,msg:t}),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:t}}),new rtcError_1.default({code:errorCode_1.default.PLUGIN_LOADED_ERROR,message:t.message})}}async registerPluginAsync(options){return new Promise(async(resolve,reject)=>{if(this.logger.log("register plugin:"+options.key),!this.supportWasm)throw this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:"unsupportWasm"}}),new rtcError_1.default({code:errorCode_1.default.WEBGL_NOT_SUPPORT_ERROR,message:`该浏览器不支持WebAssembly，注册 ${options.key} 失败。`});if(options.key==="AIhowling"&&env.CHROME_MAJOR_VERSION&&env.CHROME_MAJOR_VERSION<77)throw this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:"unsupportChromeVersion: "+env.CHROME_MAJOR_VERSION}}),new rtcError_1.default({code:errorCode_1.default.PLUGIN_NOT_SUPPORT_BROWSER,message:`该浏览器版本不支持插件 ${options.key}，请升级浏览器。`});if(this.videoPostProcess.getPlugin(options.key))return this.logger.warn(`plugin ${options.key} already exists.`),void resolve(`plugin ${options.key} already exists.`);const stageAIProcessing=this.mediaHelper.audio.stageAIProcessing;if(stageAIProcessing!=null&&stageAIProcessing.getPluginConfig(options.key))return this.logger.warn(`plugin ${options.key} already exists.`),void resolve(`plugin ${options.key} already exists.`);let plugin=null;options.adapterRef=this.client.adapterRef;try{if(options.pluginUrl?(await plugin_1.loadPlugin(options.key,options.pluginUrl),plugin=eval(`new window.${options.key}(options)`)):options.pluginObj&&(plugin=new options.pluginObj(options)),!plugin)throw new rtcError_1.default({code:errorCode_1.default.PLUGIN_LOADED_ERROR,message:"unsupport plugin "+options.key});plugin.once("plugin-load",()=>{if(plugin.version!==Config_1.SDK_VERSION)throw this.logger.error(`插件 ${options.key} 版本不匹配，当前SDK版本为 ${Config_1.SDK_VERSION}，插件版本为 ${plugin.version}。`),new rtcError_1.default({code:errorCode_1.default.PLUGIN_VERSION_ERROR,message:`插件 ${options.key} 版本不匹配，当前SDK版本为 ${Config_1.SDK_VERSION}，插件版本为 ${plugin.version}。`});if(this.logger.log(`plugin ${options.key} loaded`),plugin_list_1.videoPlugins.indexOf(options.key)!==-1)this.WebGLSupportError(),this.videoPostProcess.registerPlugin(options.key,plugin);else{if(plugin_list_1.audioPlugins.indexOf(options.key)===-1)throw new Error(`unsupport plugin ${options.key} ${options.wasmUrl}`);{let t;if(this.mediaHelper.audio.stageAIProcessing)t=this.mediaHelper.audio.stageAIProcessing;else{const r=webAudio_1.getAudioContext();if(!r)return this.logger.error("当前环境不支持AudioContext"),!1;t=new StageAIProcessing_1.StageAIProcessing(r,this.logger),this.mediaHelper.audio.stageAIProcessing=t}options.key=="AIAudioEffects"&&(this.supportAIAudioEffects=!0),options.key=="AIhowling"&&(this.supportHowling=!0);const e=Object.assign(Object.assign({},options),{blobUrl:plugin.url,wasmBinary:plugin.wasmBinary});t.registerPlugin(e),t.once("error",r=>{const{msg:i,key:a}=r;this.logger.error(`plugin ${options.key} error: ${a} ${i}`),a=="AIAudioEffects"&&(this.supportAIAudioEffects=!1),a=="AIhowling"&&(this.supportHowling=!1),this.unregisterPlugin(a),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:`插件 ${options.key} 内部错误：${i}。`}})}),t.on("plugin-process-unstable",r=>{this.emit("plugin-process-unstable",Object.assign({streamID:this.stringStreamID},r))})}}this.emit("plugin-load",options.key),this.client.apiFrequencyControl({name:"registerPlugin",code:0,param:{streamID:this.stringStreamID,plugin:options.key}}),resolve(void 0)}),plugin.once("plugin-load-error",t=>{this.emit("plugin-load-error",{key:options.key,msg:`load ${options.wasmUrl} error.`}),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:`load ${options.wasmUrl} error.`}}),reject(new rtcError_1.default({code:errorCode_1.default.PLUGIN_LOADED_ERROR,message:t}))}),plugin.once("error",t=>{options.key=="AIAudioEffects"&&(this.supportAIAudioEffects=!1),options.key=="AIhowling"&&(this.supportHowling=!1),this.unregisterPlugin(options.key),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:`插件 ${options.key} 内部错误：${t}。`}}),reject(new rtcError_1.default({code:errorCode_1.default.PLUGIN_ERROR,message:t}))})}catch(t){throw this.emit("plugin-load-error",{key:options.key,msg:t}),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:t}}),new rtcError_1.default({code:errorCode_1.default.PLUGIN_LOADED_ERROR,message:t.message||t.msg||"unsupport plugin "+options.key})}})}async unregisterPlugin(t){var e;if(this.logger.log("unRegister plugin: "+t),plugin_list_1.audioPlugins.indexOf(t)!==-1){const r=this.mediaHelper.audio.stageAIProcessing;if(t==="AIAudioEffects"){const i=r==null?void 0:r.getProcessor("AIAudioEffects");i!=null&&i.getState("AIDenoise")&&this.disableAIDenoise(),i!=null&&i.getState("AudioEffect")&&this.disableAudioEffect()}t==="AIhowling"&&this.disableAIhowling(),r==null||r.unregisterPlugin(t),r!=null&&r.hasWorkingPlugin()||((e=this.mediaHelper.audio.stageAIProcessing)===null||e===void 0||e.destroy(),this.mediaHelper.audio.stageAIProcessing=null)}else this.WebGLSupportError(),this.videoPostProcess&&(t==="VirtualBackground"&&this._segmentProcessor?await this.disableBodySegment():t==="AdvancedBeauty"&&this._advancedBeautyProcessor&&await this.disableAdvancedBeauty(),this.videoPostProcess.unregisterPlugin(t));this.client.apiFrequencyControl({name:"unregisterPlugin",code:0,param:{streamID:this.stringStreamID,plugin:t}})}async suspendVideoPostProcess(){if(this.videoPostProcess.availableCode<1)return;const{isBeautyTrack:t,isBodySegmentTrack:e,isAdvBeautyTrack:r}=this.videoPostProcessTags;t&&(await this.setBeautyEffect(!1,!0),this.videoPostProcessTags.isBeautyTrack=!0),e&&(await this._cancelBodySegment(),this.videoPostProcessTags.isBodySegmentTrack=!0),r&&(await this._cancelAdvancedBeauty(),this.videoPostProcessTags.isAdvBeautyTrack=!0)}async resumeVideoPostProcess(){if(!(this.videoPostProcess.availableCode<1))try{const{isBeautyTrack:t,isBodySegmentTrack:e,isAdvBeautyTrack:r}=this.videoPostProcessTags;t&&(await this.setBeautyEffect(!0,!0),this.lastEffects&&this.setBeautyEffectOptions(this.lastEffects),this.lastFilter&&this.setFilter(this.lastFilter)),e&&await this._startBodySegment(),r&&await this._startAdvancedBeauty()}catch(t){this.logger.log("开启失败: "+t)}}async replaceCanvas(){var t;if(this.videoPostProcess.availableCode<1||!this._play||!env.IS_ANY_SAFARI||env.SAFARI_VERSION&&parseFloat(env.SAFARI_VERSION)>15.2)return;const e=this._play.video.dom,r=this._play.video.containerDom;if(e&&r){const i=this.videoPostProcess.filters,a=this.videoPostProcess.video,l=this.replaceTags.videoPost,n=this.replaceTags.waterMark;if(l){const c=i.canvas;if(c.style.height="0px",c.style.width="0px",document.body.appendChild(c),env.SAFARI_MAJOR_VERSION<14&&a&&(a.style.height="0px",a.style.width="0px",document.body.appendChild(a)),n||i.canvas.parentElement===r)n&&(e.style.display="");else{const s=i.canvas;e.style.display="none",s.style.position="absolute";const d=r.getBoundingClientRect(),u=d.width/d.height,h=s.width/s.height,{width:o,height:f,cut:m}=this.renderMode.local.video,g=o/f;if(m)if(g>h){s.style.width="100%",s.style.left="0px";const v=d.width/h/d.height;s.style.height=100*v+"%",s.style.top=50*-(v-1)+"%"}else{s.style.height="100%",s.style.top="0px";const v=d.height*h/d.width;s.style.width=100*v+"%",s.style.left=50*-(v-1)+"%"}else if(u>h){s.style.height="100%",s.style.top="0px";const v=d.height*h/d.width;s.style.width=100*v+"%",s.style.left=50*(1-v)+"%"}else{s.style.width="100%",s.style.left="0px";const v=d.width/h/d.height;s.style.height=100*v+"%",s.style.top=50*(1-v)+"%"}r.appendChild(i.canvas)}}else e.style.display="",(t=i.canvas.parentNode)===null||t===void 0||t.removeChild(i.canvas)}}loseContext(){var t,e;try{(e=(t=this.videoPostProcess.filters)===null||t===void 0?void 0:t.webglLostContext)===null||e===void 0||e.loseContext()}catch{}}restoreContext(){var t,e;try{(e=(t=this.videoPostProcess.filters)===null||t===void 0?void 0:t.webglLostContext)===null||e===void 0||e.restoreContext()}catch{}}getNativeDom(t){const e=this[t],r=this._play[t].dom;return e&&r||this.logger.warn("No local "+t),r}delay(t){return new Promise(e=>setTimeout(e,t))}async destroy(){this.client&&(this.client.apiFrequencyControl({name:"destroy",code:0,param:{streamID:this.stringStreamID,isRemote:!1}}),this.logger.log(`uid ${this.stringStreamID} 销毁 Stream 实例`),this.stop(),env.ANY_CHROME_MAJOR_VERSION&&env.ANY_CHROME_MAJOR_VERSION<62&&await this.delay(100),this._reset(),this.destroyed=!0,this.lastEffects=null,this.lastFilter=null,this._segmentProcessor&&(this._segmentProcessor.destroy(),this._segmentProcessor=null),this._advancedBeautyProcessor&&(this._advancedBeautyProcessor.destroy(),this._advancedBeautyProcessor=null),this._cameraTrack&&(this._cameraTrack.stop(),this._cameraTrack=null),this._transformedTrack&&(this._transformedTrack.stop(),this._transformedTrack=null),this.videoPostProcess.destroy())}}exports.LocalStream=LocalStream},function(t,e,r){var i=this&&this.__createBinding||(Object.create?function(o,f,m,g){g===void 0&&(g=m),Object.defineProperty(o,g,{enumerable:!0,get:function(){return f[m]}})}:function(o,f,m,g){g===void 0&&(g=m),o[g]=f[m]}),a=this&&this.__setModuleDefault||(Object.create?function(o,f){Object.defineProperty(o,"default",{enumerable:!0,value:f})}:function(o,f){o.default=f}),l=this&&this.__importStar||function(o){if(o&&o.__esModule)return o;var f={};if(o!=null)for(var m in o)m!=="default"&&Object.prototype.hasOwnProperty.call(o,m)&&i(f,o,m);return a(f,o),f},n=this&&this.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(e,"__esModule",{value:!0});const c=r(3),s=l(r(7)),d=n(r(311)),u=r(312);class h extends c.EventEmitter{constructor(f){super(),this.pluginModules={VirtualBackground:null,AdvancedBeauty:null},this.isAlive=!0,this.filters=null,this.video=null,this.frameRate=15,this.timerId=-1,this.taskSet=new Set,this.taskSnapshot=new Set,this.readyTaskSet=new Set(["BasicBeauty"]),this.sourceMap=null,this.maskData=null,this.advBeautyData=[],this.sourceTrack=null,this.trackInstance=null,this.videoSizeTag="",this.frameCount=[0,0],this.update=(m=!0)=>{if(this.availableCode<2||s.IS_ANY_SAFARI&&document.visibilityState==="hidden")return;const g=this.filters;if(!this.taskSet.size)return g?g.update(!1):d.default.clearTimeout(this.timerId);if(m&&(this.frameCount[0]+=1),this.taskReady){let v=!1,O=!1;if(this.taskSet.has("VirtualBackground")&&(g.virtualBackground.setMaskMap(this.maskData),this.maskData=null,v=!0,O=!0),this.taskSet.has("AdvancedBeauty")?(g.advBeauty.setAdvData(this.advBeautyData),this.advBeautyData=[],v=!0):O=!1,this.taskSnapshot=new Set(this.taskSet),this.readyTaskSet.clear(),this.readyTaskSet.add("BasicBeauty"),this.frameCount[1]=this.frameCount[0],v?(g.update(!1),this.sourceMap=g.normal.getImageData(g.srcMap)):g.update(!0),this.taskSet.has("VirtualBackground")){const T=this.pluginModules.VirtualBackground;if(T){const{width:C,height:A}=g.canvas;C>16&&A>16?T.process(O?this.sourceMap.slice():this.sourceMap,C,A,R=>{const w=(R.data||R).length;this.maskData=this.taskSet.has("VirtualBackground")&&w>0?R:null,this.readyTaskSet.add("VirtualBackground"),this.frameCount[1]<this.frameCount[0]&&(this.updateTimer(),this.update(!1))},s.IS_CHROME&&(s.CHROME_MAJOR_VERSION||0)>=104):this.readyTaskSet.add("VirtualBackground")}}if(this.taskSet.has("AdvancedBeauty")){const T=this.pluginModules.AdvancedBeauty;if(T){const{width:C,height:A}=g.canvas;T.process(this.sourceMap,C,A,R=>{this.advBeautyData=this.taskSet.has("AdvancedBeauty")?R:[],this.readyTaskSet.add("AdvancedBeauty"),this.frameCount[1]<this.frameCount[0]&&(this.updateTimer(),this.update(!1))},s.IS_CHROME&&(s.CHROME_MAJOR_VERSION||0)>=104)}}}},this.setTaskAndTrack=(m,g,v)=>new Promise((O,T)=>{if(this.availableCode<1)return T(this.glErrorTip);if(g){if(this.hasTask(m))return O(this.track);this.createTrack(v).then(C=>{this.addTask(m),setTimeout(()=>{O(this.track)},C)}).catch(C=>{T(C)})}else{if(!this.hasTask(m))return O(this.track);this.removeTask(m),O(this.track)}}),this.logger=f}registerPlugin(f,m){this.pluginModules[f]=m}getPlugin(f){return this.pluginModules[f]}unregisterPlugin(f){this.pluginModules[f]=null}init(){try{this.filters=new u.Filters;const f=this.filters.canvas;f.addEventListener("webglcontextlost",m=>{m.preventDefault(),this.emit("contextLost")},!1),f.addEventListener("webglcontextrestored",m=>{var g;m.preventDefault();let v=!0;this.filters=((g=this.filters)===null||g===void 0?void 0:g.clone())||null,this.filters||(v=!1),this.emit("contextRestored",v)},!1)}catch{}}get availableCode(){return this.isAlive?this.filters?this.filters.gl?this.filters.gl.isContextLost()?1:2:0:-2:-1}get glErrorTip(){switch(this.availableCode){case-1:return"localStream is already destroyed.";case 0:return"the current environment does not support webgl.";case-2:return"filters is not initialized.";case 1:return"webgl context has been lost."}return""}get taskReady(){for(const f of this.taskSnapshot)if(!this.readyTaskSet.has(f))return!1;return!0}addTask(f){this.taskSet.has(f)||(this.taskSet.add(f),this.logger.log(`task ${f} is added.`),this.update(),this.taskSet.size===1&&(this.updateTimer(),this.emit("taskSwitch",!0)))}removeTask(f){var m;this.taskSet.delete(f),this.logger.log(`task ${f} is removed.`),this.taskSet.size===0&&(d.default.clearTimeout(this.timerId),this.timerId=-1,this.sourceMap=null,(m=this.trackInstance)===null||m===void 0||m.stop(),this.trackInstance=null,this.emit("taskSwitch",!1)),this.update(),this.taskSnapshot.delete(f)}hasTask(f){return this.taskSet.has(f)}get hasAnyTask(){return this.taskSet.size>0}videoSizeChange(f,m){if(s.IS_ANY_SAFARI&&this.filters){const g=`${f}-${m}`;this.videoSizeTag!==g&&(this.videoSizeTag=g,this.emit("safariVideoSizeChange"))}}createTrack(f){return new Promise((m,g)=>{var v,O;if(this.trackInstance&&this.trackInstance===f)return this.logger.log("VideoPostProcess track transform unnecessary"),m(0);this.logger.log("VideoPostProcess track transform");const T=f.getSettings();this.frameRate=T.frameRate||15,this.frameRate>30&&(this.logger.warn("In chrome, webgl drawing video which framerate greater than 30fps may cause memory leak."),this.frameRate=30),this.sourceTrack=f,this.trackInstance&&(this.trackInstance.stop(),this.trackInstance=null),T.width&&T.height&&((v=this.filters)===null||v===void 0||v.setSize(T.width,T.height),this.videoSizeTag||(this.videoSizeTag=`${T.width}-${T.height}`));const C=((O=this.filters)===null||O===void 0?void 0:O.canvas).captureStream(this.frameRate);this.trackInstance=C.getVideoTracks()[0],this.video=this.video||document.createElement("video");const A=new MediaStream([this.sourceTrack]);this.video.srcObject=A;const R=w=>{var k;const{videoWidth:I,videoHeight:M}=w;(k=this.filters)===null||k===void 0||k.setSize(I,M),this.videoSizeChange(I,M)};this.video.onloadedmetadata=()=>{this.video.play().then(()=>{this.filters.mapSource=this.video,R(this.video),m(0)}).catch(w=>{g(w)})},this.video.onresize=()=>{R(this.video)}})}get track(){return this.taskSet.size?(this.logger.log("return video post procss track."),this.trackInstance):(this.logger.log("return origin track."),this.sourceTrack)}updateTimer(){d.default.clearTimeout(this.timerId),this.timerId=d.default.setTimeout(()=>{this.updateTimer(),this.update()},1e3/(1.1*this.frameRate),null)}destroy(){var f,m,g;this.isAlive=!1,d.default.clearTimeout(this.timerId),this.removeAllListeners(),this.taskSet.clear(),this.readyTaskSet.clear(),this.taskSnapshot.clear(),(f=this.sourceTrack)===null||f===void 0||f.stop(),this.sourceTrack=null,(m=this.trackInstance)===null||m===void 0||m.stop(),this.trackInstance=null,this.video=null,(g=this.filters)===null||g===void 0||g.destroy(),this.filters=null,this.sourceMap=null,this.maskData=null,this.advBeautyData=null,this.pluginModules=null,this.frameCount=[0,0]}}e.default=h},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0});const i=r(90),a=new class{constructor(){this.id=0,this.callbacks={},this.worker=null}getWorker(){return this.worker||(this.worker=new Worker(i.getBlobUrl("webWorkerTimer")),this.worker.onmessage=l=>{switch(l.data.message){case"interval:tick":case"timeout:tick":{const n=this.callbacks[l.data.id];n&&n.fn&&n.fn.apply(n.context);break}case"interval:cleared":case"timeout:cleared":delete this.callbacks[l.data.id]}}),this.worker}setInterval(l,n,c){this.id++;const s=this.id;return this.callbacks[s]={fn:l,context:c},this.getWorker().postMessage({command:"interval:start",interval:n,id:s}),s}setTimeout(l,n,c){this.id++;const s=this.id;return this.callbacks[s]={fn:l,context:c},this.getWorker().postMessage({command:"timeout:start",timeout:n,id:s}),s}clearInterval(l){this.getWorker().postMessage({command:"interval:clear",id:l})}clearTimeout(l){this.getWorker().postMessage({command:"timeout:clear",id:l})}};e.default=a},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.Filters=void 0;const i=r(156),a=r(313),l=r(75),n=r(205),c=r(322),s=r(326),d=r(327),u=r(328),h=r(329);class o{constructor(m){this._alive=!0,this.time=-1,this.lastTimer=performance.now(),this.webglLostContext=null,this._renderer=new a.Renderer({canvas:m,antialias:!0}),this.map=l.createTexture(this._renderer.gl,null);const g=this._renderer.gl;this.webglLostContext=g.getExtension("WEBGL_lose_context");const{posArray:v,uvArray:O,advBeautyIndicesArray:T,advBeautyPosArray:C,advBeautyZindexArray:A,advFaceMaskUVArray:R,advEyeTeethPosArray:w,advEyeTeethIndicesArray:k,advEyeTeethZindexArray:I,advEyeTeethUVArray:M}=u.typedArray,P=i.createAttributeBuffer(g,"position",v,2),S=i.createAttributeBuffer(g,"uv",O,2),y=i.createAttributeBuffer(g,"position",C,2),_=i.createAttributeBuffer(g,"zIndex",A,1),b=i.createAttributeBuffer(g,"indices",T,1,"ELEMENT_ARRAY_BUFFER"),E=i.createAttributeBuffer(g,"uv",R,2),x=i.createAttributeBuffer(g,"tPosition",w,2),D=i.createAttributeBuffer(g,"indices",k,1,"ELEMENT_ARRAY_BUFFER"),F=i.createAttributeBuffer(g,"zIndex",I,1),V=i.createAttributeBuffer(g,"uv",M,2);this.advBeauty=new n.AdvBeautyFilter(this._renderer,this.map,y,_,b,E,P,S,x,D,F,V),this.beauty=new c.BeautyFilter(this._renderer,this.map,P,S),this.lut=new s.LutFilter(this._renderer,this.map,P,S),this.normal=new d.NormalFilter(this._renderer,this.map,P,S),this.virtualBackground=new h.VirtualBackFilter(this._renderer,this.map,P,S)}clone(){var m;try{const g=new o(this._renderer.canvas);g.mapSource=((m=this.srcMap)===null||m===void 0?void 0:m.source)||null,this.advBeauty.remove(),g.advBeauty.presetAdvEffect(Object.assign({},this.advBeauty.params));const v=this.virtualBackground.lastSetInfo;return v.type==="bk"?g.virtualBackground.setBackground(v.value):v.type==="blur"&&g.virtualBackground.setBlurIntensity(v.value),g}catch{return null}}get filters(){return[this.advBeauty,this.beauty,this.lut,this.virtualBackground,this.normal]}get canvas(){return this._renderer.canvas}get gl(){return this._renderer.gl}get srcMap(){return this.map}set mapSource(m){const g=this.map;g&&(g.source=m,g.refresh())}get isAlive(){return this._alive}setSize(m,g){this._renderer.setSize(m,g),this.filters.forEach(v=>{v.updateSize()})}render(){const m=this.filters;m[0].map=this.map,m[0].render(),m[1].faceMask=m[0].faceMask,m[1].featureParas=m[0].featureParas;for(let g=1;g<m.length;g++)m[g].map=m[g-1].output,m[g].render()}update(m=!0){var g;if(this._alive){if(this.time<0)this.time=0,this.lastTimer=performance.now();else{const v=performance.now(),O=Math.min(v-this.lastTimer,100);this.lastTimer=v,this.time+=O/1e3}m&&((g=this.map)===null||g===void 0||g.refresh()),this.render()}}destroy(){this._alive=!1,this.time=-1;const m=this._renderer.gl;this.filters.forEach(g=>{g.destroy()}),m==null||m.deleteTexture(this.map.glTexture)}}e.Filters=o},function(t,e,r){var i=this&&this.__rest||function(l,n){var c={};for(var s in l)Object.prototype.hasOwnProperty.call(l,s)&&n.indexOf(s)<0&&(c[s]=l[s]);if(l!=null&&typeof Object.getOwnPropertySymbols=="function"){var d=0;for(s=Object.getOwnPropertySymbols(l);d<s.length;d++)n.indexOf(s[d])<0&&Object.prototype.propertyIsEnumerable.call(l,s[d])&&(c[s[d]]=l[s[d]])}return c};Object.defineProperty(e,"__esModule",{value:!0}),e.Renderer=void 0;const a=r(85);e.Renderer=class{constructor(l){this._gl=null,this._pixelRatio=1,this._viewport={x:0,y:0,width:640,height:480};const n=Object.assign({preserveDrawingBuffer:!0,powerPreference:"high-performance"},l),{canvas:c=document.createElement("canvas"),width:s=640,height:d=480}=n,u=i(n,["canvas","width","height"]);this._canvas=c,this._gl=a.getWebGLContext(c,u);const h=this.setSize(s,d);this.setViewport(0,0,h.width,h.height)}get canvas(){return this._canvas}get gl(){return this._gl}getPixelRatio(){var l;return(l=this._pixelRatio)!==null&&l!==void 0?l:1}setPixelRatio(l){const n=this.getPixelRatio();if(n===l)return;const c=this.getSize();c.width/=n,c.height/=n,this._pixelRatio=l,this.setSize(c.width,c.height)}getSize(){return{width:this.canvas.width,height:this.canvas.height}}setSize(l,n,c=!1){const s=this.canvas,d=this.getPixelRatio();return s.width=l*d,c&&(s.style.width=l+"px"),s.height=n*d,c&&(s.style.height=n+"px"),this.getSize()}getViewport(){return this._viewport}setViewport(l,n,c,s){var d;this._viewport={x:l,y:n,width:c,height:s},(d=this.gl)===null||d===void 0||d.viewport(l,n,c,s)}resize(l,n,c,s){const d=this.setSize(l,n);c&&this.setPixelRatio(c),s?this.setViewport(s.x,s.y,s.width,s.height):this.setViewport(0,0,d.width,d.height)}render(l){if(!this.gl)return;const n=this.gl;n.enable(n.CULL_FACE),l.render()}}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.defaultShader=void 0,e.defaultShader={vShader:`
    attribute vec4 position;
    void main() {
        gl_Position = position;
    }
`,fShader:`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
        precision highp float;
    #else
        precision mediump float;
    #endif

    void main() {
        gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);
    }
`}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.createShader=void 0,e.createShader=function(i,a,l){const n=i.createShader({VERTEX:i.VERTEX_SHADER,FRAGMENT:i.FRAGMENT_SHADER}[l]);if(!n)return console.error(l+"Shader was not created successfully."),null;if(i.shaderSource(n,a),i.compileShader(n),i.getShaderParameter(n,i.COMPILE_STATUS))return n;const c=a.split(`
`).map((s,d)=>`${d+1}${s}`).join(`
`);return console.error(`${i.getShaderInfoLog(n)}
%cshader source code
${c}
`,"color: #008040"),i.deleteShader(n),null}},function(t,e,r){function i(a,l,n,c,s,d){var u;if(n===a.FLOAT)return c?g=>a.uniform1fv(l,g):g=>a.uniform1f(l,g);const h={[a.FLOAT_VEC2]:g=>a.uniform2fv(l,g),[a.FLOAT_VEC3]:g=>a.uniform3fv(l,g),[a.FLOAT_VEC4]:g=>a.uniform4fv(l,g)}[n];if(h)return h;if(n===a.INT||n===a.BOOL)return c?g=>a.uniform1iv(l,g):g=>a.uniform1i(l,g);const o={[a.BOOL_VEC2]:a.INT_VEC2,[a.BOOL_VEC3]:a.INT_VEC3,[a.BOOL_VEC4]:a.INT_VEC4},f={[a.INT_VEC2]:g=>a.uniform2iv(l,g),[a.INT_VEC3]:g=>a.uniform3iv(l,g),[a.INT_VEC4]:g=>a.uniform4iv(l,g)}[(u=o[n])!==null&&u!==void 0?u:n];if(f)return f;const m={[a.FLOAT_MAT2]:g=>a.uniformMatrix2fv(l,!1,g),[a.FLOAT_MAT3]:g=>a.uniformMatrix3fv(l,!1,g),[a.FLOAT_MAT4]:g=>a.uniformMatrix4fv(l,!1,g)}[n];if(m)return m;if(n===a.SAMPLER_2D||n===a.SAMPLER_CUBE){const g=n===a.SAMPLER_2D?a.TEXTURE_2D:a.TEXTURE_CUBE_MAP;if(c){const v=[];for(let O=0;O<s;O++)v.push(d.value++);return O=>{a.uniform1iv(l,v),O.forEach((T,C)=>{var A;a.activeTexture(a.TEXTURE0+v[C]),a.bindTexture(g,(A=T==null?void 0:T.glTexture)!==null&&A!==void 0?A:null)})}}{const v=d.value++;return O=>{var T;a.uniform1i(l,v),a.activeTexture(a.TEXTURE0+v),a.bindTexture(g,(T=O==null?void 0:O.glTexture)!==null&&T!==void 0?T:null)}}}return()=>{console.warn("no matching uniform setter.")}}Object.defineProperty(e,"__esModule",{value:!0}),e.parseUniforms=void 0,e.parseUniforms=function(a,l){const n={value:0},c=a.getProgramParameter(l,a.ACTIVE_UNIFORMS),s={};for(let d=0;d<c;d++){const u=a.getActiveUniform(l,d);if(u){const h=u.size>1,o=h?u.name.replace("[0]",""):u.name,f=u.type,m=a.getUniformLocation(l,o);if(m!==null){const g=i(a,m,f,h,u.size,n);s[o]={type:f,size:u.size,value:null,setter:v=>{v!==void 0?s[o].value=v:g(s[o].value)}}}else console.warn(`uniform:[${o}] is null.`)}}return s}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.advBeautyEyeShader=void 0,e.advBeautyEyeShader={fShader:`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
        precision highp float;
    #else
        precision mediump float;
    #endif

    uniform sampler2D map;
    uniform vec2 eyeCenter;
    uniform vec2 rdDir;
    uniform float rdIntensity;
    uniform float lgIntensity;
    uniform float intensRatio;
    uniform float range;

    varying vec2 vuv;

    mat3 scaleByNormal(vec2 normal, float k, float refx, float refy){
        float a = 1.0 + (k - 1.0) * normal.x * normal.x;
        float b = (k - 1.0) * normal.x * normal.y;
        float c = 1.0 + (k - 1.0) * normal.y * normal.y;
        return mat3(
            a, b, 0.0,
            b, c, 0.0,
            (1.0 - a) * refx - b * refy, (1.0 - c) * refy - b * refx, 1.0
        );
    }

    vec2 lgEye(vec2 uv, vec2 center, float range, float strength, float powRatio) {
        float dist = distance(uv, center);
        if(dist > range){
            return uv;
        }
        vec2 dir = normalize(uv - center);
        float scale = 1. - strength + strength * pow(smoothstep(0., 1., dist / range), powRatio);
        float newDist = dist * scale;
        return center + newDist * dir;
    }

    vec2 rdEye(vec2 uv, vec2 center, float range, float strength, float powRatio){
        float dist = distance(uv, center);
        if(dist > range){
            return uv;
        }
        float scale = 1. - strength + strength * pow(smoothstep(0., 1., dist / range), powRatio);
        return (scaleByNormal(rdDir, scale, center.x, center.y) * vec3(uv, 1.0)).xy;
    }

    void main() {
        vec2 uv = vuv;
        if(intensRatio > 0.0){
            if(rdIntensity > 0.0){
                float maxRdIntens = mix(1.0, 0.5, lgIntensity);
                float rdIntens = mix(0.0, maxRdIntens, rdIntensity * intensRatio);
                uv = lgEye(uv, eyeCenter, range * 2.0, rdIntens, 0.075);
                uv = rdEye(uv, eyeCenter, range * 2.0, rdIntens, 0.1);
            }
            if(lgIntensity > 0.0){
                float lgIntens = lgIntensity * intensRatio;
                uv = lgEye(uv, eyeCenter, range * 2.5, lgIntens, 0.1);
                uv = rdEye(uv, eyeCenter, range * 2.5, lgIntens, 0.05);
            }
        }
        gl_FragColor = texture2D(map, uv);
    }
`}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.advBeautyShader=void 0,e.advBeautyShader={vShader:`
    uniform vec2 size;

    attribute vec2 position;
    attribute vec2 tPosition;
    attribute float zIndex;

    varying vec2 vuv;

    vec2 npos(vec2 pos){
        return pos / size;
    }

    float ndcx(float x){
        return (x - 1.0) * 2.0 + 1.0;
    }

    float ndcy(float y){
        return (1.0 - y) * 2.0 - 1.0;
    }

    vec2 ndcpos(vec2 pos){
        return vec2(ndcx(pos.x), ndcy(pos.y));
    }

    void main() {
        vec2 nPos = position;
        vec2 ntPos = tPosition;
        if(zIndex > -0.000001){
            nPos = npos(nPos);
            ntPos = npos(ntPos);
        }
        vec2 ndcPos = ndcpos(ntPos);
        gl_Position = vec4(ndcPos, zIndex, 1.0);

        vuv = nPos;
        vuv.y = 1.0 - vuv.y;
    }
`,fShader:`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
        precision highp float;
    #else
        precision mediump float;
    #endif

    uniform float showWire;
    uniform vec2 size;
    uniform sampler2D map;
    uniform sampler2D wireMap;
    uniform sampler2D eyeTeethMaskMap;
    uniform sampler2D teethLut;
    uniform float eyeIntensity;
    uniform float teethIntensity;
    varying vec2 vuv;

    vec3 lut64(vec3 color, sampler2D lut){
        float blue = color.b * 63.0;

        vec2 q1;
        float fb = floor(blue);
        q1.y = floor(fb * 0.125);
        q1.x = fb - (q1.y * 8.0);

        vec2 q2;
        float cb = ceil(blue);
        q2.y = floor(cb * 0.125);
        q2.x = cb - (q2.y * 8.0);

        vec2 t = 0.123 * color.rg + vec2(0.000976563);
        vec2 t1 = q1 * 0.125 + t;
        vec3 p1 = texture2D(lut, t1).rgb;

        vec2 t2 = q2 * 0.125 + t;
        vec3 p2 = texture2D(lut, t2).rgb;

        return mix(p1, p2, fract(blue));
    }

    void main() {
        vec4 color = texture2D(map, vuv);
        if(eyeIntensity > 0.0 || teethIntensity > 0.0){
            vec4 eyeTeethMask = texture2D(eyeTeethMaskMap, vuv);
            float teethInten = eyeTeethMask.r > 0.0 ? teethIntensity * eyeTeethMask.a : 0.0;
            float eyeInten = eyeTeethMask.g > 0.0 ? eyeIntensity * eyeTeethMask.a : 0.0;
            if(teethInten>0.0){
                color.rgb = mix(color.rgb, lut64(color.rgb, teethLut), teethInten);
            }
            if(eyeInten>0.0){
                vec2 step1 = vec2(size.x / 640.0 / size.x, 0.0);
                vec2 step2 = vec2(0.0, size.y / 480.0 /size.y);
                vec3 sumColor = vec3(0.0, 0.0, 0.0);
                sumColor += texture2D(map, vuv - 2.0 * step1 - 2.0 * step2).rgb;
                sumColor += texture2D(map, vuv - 2.0 * step1 - 1.0 * step2).rgb;
                sumColor += texture2D(map, vuv - 2.0 * step1).rgb;
                sumColor += texture2D(map, vuv - 2.0 * step1 + 1.0 * step2).rgb;
                sumColor += texture2D(map, vuv - 2.0 * step1 + 2.0 * step2).rgb;
                sumColor += texture2D(map, vuv - 1.0 * step1 - 2.0 * step2).rgb;
                sumColor += texture2D(map, vuv - 1.0 * step1 - 1.0 * step2).rgb;
                sumColor += texture2D(map, vuv - 1.0 * step1).rgb;
                sumColor += texture2D(map, vuv - 1.0 * step1 + 1.0 * step2).rgb;
                sumColor += texture2D(map, vuv - 1.0 * step1 + 2.0 * step2).rgb;
                sumColor += texture2D(map, vuv - 2.0 * step2).rgb;
                sumColor += texture2D(map, vuv - 1.0 * step2).rgb;
                sumColor += texture2D(map, vuv).rgb;
                sumColor += texture2D(map, vuv + 1.0 * step2).rgb;
                sumColor += texture2D(map, vuv + 2.0 * step2).rgb;
                sumColor += texture2D(map, vuv + 1.0 * step1 - 2.0 * step2).rgb;
                sumColor += texture2D(map, vuv + 1.0 * step1 - 1.0 * step2).rgb;
                sumColor += texture2D(map, vuv + 1.0 * step1).rgb;
                sumColor += texture2D(map, vuv + 1.0 * step1 + 1.0 * step2).rgb;
                sumColor += texture2D(map, vuv + 1.0 * step1 + 2.0 * step2).rgb;
                sumColor += texture2D(map, vuv + 2.0 * step1 - 2.0 * step2).rgb;
                sumColor += texture2D(map, vuv + 2.0 * step1 - 1.0 * step2).rgb;
                sumColor += texture2D(map, vuv + 2.0 * step1).rgb;
                sumColor += texture2D(map, vuv + 2.0 * step1 + 1.0 * step2).rgb;
                sumColor += texture2D(map, vuv + 2.0 * step1 + 2.0 * step2).rgb;

                sumColor = sumColor * 0.04;
                sumColor = clamp(sumColor + (color.rgb - sumColor) * 2.0, 0.0, 1.0);
                sumColor = max(color.rgb, sumColor);
                color.rgb = mix(color.rgb, sumColor, eyeInten);
                eyeInten = 1.0 + eyeInten * 0.25;
                color.rgb = (color.rgb - vec3(0.5)) * eyeInten + vec3(0.5);
            }
        }
        if(showWire > 0.5){
            vec4 wire = texture2D(wireMap, vuv);
            gl_FragColor = mix(color, wire, wire.a);
        }else{
            gl_FragColor = color;
        }
    }
`}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.advBeautyWireShader=void 0,e.advBeautyWireShader={vShader:`
    uniform vec2 size;

    attribute vec2 position;

    vec2 npos(vec2 pos){
        return pos / size;
    }

    float ndcx(float x){
        return (x - 1.0) * 2.0 + 1.0;
    }

    float ndcy(float y){
        return (1.0 - y) * 2.0 - 1.0;
    }

    vec2 ndcpos(vec2 pos){
        return vec2(ndcx(pos.x), ndcy(pos.y));
    }

    void main() {
        vec2 nPos = npos(position);
        vec2 ndcPos = ndcpos(nPos);
        gl_Position = vec4(ndcPos, 0.0, 1.0);
    }
`,fShader:`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
        precision highp float;
    #else
        precision mediump float;
    #endif
    void main() {
        gl_FragColor = vec4(0.0, 1.0, 0.0, 1.0);
    }
`}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.advFaceMaskShader=void 0,e.advFaceMaskShader={vShader:`
    uniform vec2 size;

    attribute vec2 tPosition;
    attribute vec2 uv;
    attribute float zIndex;

    varying vec2 vuv;

    vec2 npos(vec2 pos){
        return pos / size;
    }

    float ndcx(float x){
        return (x - 1.0) * 2.0 + 1.0;
    }

    float ndcy(float y){
        return (1.0 - y) * 2.0 - 1.0;
    }

    vec2 ndcpos(vec2 pos){
        return vec2(ndcx(pos.x), ndcy(pos.y));
    }

    void main() {
        vec2 nPos = tPosition;
        if(zIndex > -0.000001){
            nPos = npos(nPos);
        }
        vec2 ndcPos = ndcpos(nPos);
        gl_Position = vec4(ndcPos, zIndex, 1.0);
        vuv = uv;
    }
`,fShader:`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
        precision highp float;
    #else
        precision mediump float;
    #endif

    uniform sampler2D map;
    uniform sampler2D maskMap;
    uniform int index;
    varying vec2 vuv;

    void main() {
      vec4 color = index == 0 ? vec4(0.0) : texture2D(map, vuv);
      vec4 mask = texture2D(maskMap, vuv);
      float a = 1.0 - (1.0 - color.a) * (1.0 - mask.a);
      vec3 rgb = max(color.rgb, mask.rgb);
      gl_FragColor = vec4(rgb, a);
    }
`}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.handlers=e.preHandle=e.Matrix3x3=e.Vector2=void 0;class i{constructor(d,u){this.value=[0,0],this.value=[d,u]}get x(){return this.value[0]}set x(d){this.value[0]=d}get y(){return this.value[1]}set y(d){this.value[1]=d}get lengthPow2(){return Math.pow(this.x,2)+Math.pow(this.y,2)}get length(){return Math.sqrt(this.lengthPow2)}static getVec(d,u){const h=2*u;if(h<0)throw new Error("index out range");const o=h+1;if(o>=d.length)throw new Error("index out range");return new i(d[h],d[o])}static setPoint(d,u,h){const o=2*u;if(o<0)throw new Error("index out range");const f=o+1;if(f>=d.length)throw new Error("index out range");d[o]=h.value[0],d[f]=h.value[1]}static normalize(d){const u=Math.sqrt(d.value[0]*d.value[0]+d.value[1]*d.value[1]);return new i(d.value[0]/u,d.value[1]/u)}static add(d,u){return new i(d.value[0]+u.value[0],d.value[1]+u.value[1])}static sub(d,u){return new i(d.value[0]-u.value[0],d.value[1]-u.value[1])}static scale(d,u){return new i(d.value[0]*u,d.value[1]*u)}static scaleByAxis(d,u,h){return new i(d.x*u,d.y*h)}static disPow2(d,u){const h=d.value,o=u.value,f=h[0]-o[0],m=h[1]-o[1];return f*f+m*m}static dis(d,u){return Math.sqrt(i.disPow2(d,u))}static lerp(d,u,h){if(!d||!u)return d||u;const o=d.value,f=u.value;return new i(o[0]+(f[0]-o[0])*h,o[1]+(f[1]-o[1])*h)}static intersectPoint(d,u,h,o){const f=d.value,m=u.value,g=h.value,v=o.value,O=g[0]-v[0],T=f[0]-m[0],C=g[1]-v[1],A=f[1]-m[1],R=T*C-A*O;if(R==0)return null;const w=f[0]*m[1]-f[1]*m[0],k=g[0]*v[1]-g[1]*v[0];return new i((w*O-T*k)/R,(w*C-A*k)/R)}static center(...d){const u=d.length;if(!u)return new i(0,0);if(u===1)return new i(...d[0].value);if(u===2)return new i((d[0].value[0]+d[1].value[0])/2,(d[0].value[1]+d[1].value[1])/2);let h=0,o=0,f=0;for(let v=u-1,O=0;O<u;v=O,O++){const T=d[v].value,C=d[O].value,A=T[0]*C[1]-C[0]*T[1];h+=A,o+=(C[0]+T[0])*A,f+=(C[1]+T[1])*A}let m=0,g=0;return h!=0&&(m=o/(3*h),g=f/(3*h)),new i(m,g)}static dot(d,u){return d.x*u.x+d.y*u.y}static cross(d,u){return d.x*u.y-u.x*d.y}static angle(d,u){const h=i.normalize(d),o=i.normalize(u);return Math.acos(Math.min(1,Math.max(-1,i.dot(h,o))))}static fromToAngle(d,u){return i.cross(d,u)<0?-i.angle(d,u):i.angle(d,u)}}e.Vector2=i;class a{constructor(d,u,h,o,f,m,g,v,O){this.matrix=[[d,u,h],[o,f,m],[g,v,O]]}get a(){return this.matrix[0][0]}set a(d){this.matrix[0][0]=d}get b(){return this.matrix[1][0]}set b(d){this.matrix[1][0]=d}get c(){return this.matrix[0][1]}set c(d){this.matrix[0][1]=d}get d(){return this.matrix[1][1]}set d(d){this.matrix[1][1]=d}get e(){return this.matrix[0][2]}set e(d){this.matrix[0][2]=d}get f(){return this.matrix[1][2]}set f(d){this.matrix[1][2]=d}get transpose(){let d=this.matrix;return new a(d[0][0],d[1][0],d[2][0],d[0][1],d[1][1],d[2][1],d[0][2],d[1][2],d[2][2])}multiplyPoint(d){let u=d.x,h=d.y,o=u*this.matrix[0][0]+h*this.matrix[0][1]+this.matrix[0][2],f=u*this.matrix[1][0]+h*this.matrix[1][1]+this.matrix[1][2],m=u*this.matrix[2][0]+h*this.matrix[2][1]+this.matrix[2][2];return new i(o/m,f/m)}multiplyVector(d){let u=d.x,h=d.y,o=u*this.matrix[0][0]+h*this.matrix[0][1],f=u*this.matrix[1][0]+h*this.matrix[1][1];return new i(o,f)}static identity(){return new a(1,0,0,0,1,0,0,0,1)}static rotate(d,u,h){let o=Math.cos(d),f=Math.sin(d),m=a.identity();return m.matrix[0][0]=o,m.matrix[0][1]=-f,m.matrix[1][0]=f,m.matrix[1][1]=o,m.matrix[0][2]=u*(1-o)+h*f,m.matrix[1][2]=h*(1-o)-u*f,m}static scaleByNormal(d,u,h,o){d=i.normalize(d);let f=1+(u-1)*Math.pow(d.x,2),m=(u-1)*d.x*d.y,g=1+(u-1)*Math.pow(d.y,2);return new a(f,m,(1-f)*h-m*o,m,g,(1-g)*o-m*h,0,0,1)}}e.Matrix3x3=a;let l,n,c=!0;e.preHandle=s=>{l=i.getVec(s,74),n=i.getVec(s,77)},e.handlers={eyeAngle:(s,d)=>{const u=.06*(d-.5)*Math.PI,h=a.rotate(u,l.x,l.y);[52,53,54,55,56,57,72,73].forEach(f=>{const m=h.multiplyPoint(i.getVec(s,f));i.setPoint(s,f,m)});const o=a.rotate(-u,n.x,n.y);[58,59,60,61,62,63,75,76].forEach(f=>{const m=o.multiplyPoint(i.getVec(s,f));i.setPoint(s,f,m)})},openCanthus:(s,d)=>{d*=.05;const u=i.getVec(s,43),h=i.getVec(s,46);let o=i.getVec(s,55),f=i.getVec(s,58);const m=i.intersectPoint(u,h,o,f)||u;o=i.lerp(o,m,d),f=i.lerp(f,m,d),i.setPoint(s,55,o),i.setPoint(s,58,f),[54,56,59,63].forEach(g=>{let v=i.getVec(s,g);v=i.lerp(v,g<57?o:f,.05*d),i.setPoint(s,g,v)})},eyeDistance:(s,d)=>{d=.1*(d-.5);const u=i.getVec(s,43),h=i.scale(i.sub(l,u),d),o=i.scale(i.sub(n,u),d);[52,53,54,55,56,57,72,73,74].forEach(f=>{const m=i.add(i.getVec(s,f),h);i.setPoint(s,f,m)}),[58,59,60,61,62,63,75,76,77].forEach(f=>{const m=i.add(i.getVec(s,f),o);i.setPoint(s,f,m)}),l=i.getVec(s,74),n=i.getVec(s,77)},roundedEye:(s,d)=>(c=!1,l=i.center(...[52,53,54,55,56,57,72,73].map(u=>i.getVec(s,u))),n=i.center(...[58,59,60,61,62,63,75,76].map(u=>i.getVec(s,u))),{lEyeCenter:l,rEyeCenter:n}),enlargeEye:(s,d)=>(c?(l=i.center(...[52,53,54,55,56,57,72,73].map(u=>i.getVec(s,u))),n=i.center(...[58,59,60,61,62,63,75,76].map(u=>i.getVec(s,u)))):c=!0,{lEyeCenter:l,rEyeCenter:n}),shrinkNose:(s,d)=>{d*=.15;const u=i.getVec(s,46);[80,81,82,83].forEach(o=>{i.setPoint(s,o,i.lerp(i.getVec(s,o),u,d))});const h=i.getVec(s,49);[47,51].forEach(o=>{i.setPoint(s,o,i.lerp(i.getVec(s,o),h,d))})},lengthenNose:(s,d)=>{d=.25*(d-.5);const u=[80,81,82,83,47,51],h=i.getVec(s,46),o=[];u.forEach(O=>{o.push(i.sub(i.getVec(s,O),h))});const f=i.getVec(s,49),m=i.lerp(f,i.getVec(s,87),d);i.setPoint(s,49,m);const g=i.sub(m,f),v=i.add(h,g);i.setPoint(s,46,v),o.forEach((O,T)=>{const C=i.add(v,O);i.setPoint(s,u[T],C)})},shrinkMouth:(s,d)=>{const u=1+.25*(d-=.65),h=1+.2*d,o=[1,.7,.2,0,.2,.7,1,.66,.33,0,.33,.66],f=[1,.66,0,.66,1,.66,0,.66],m=[84,85,86,87,88,89,90,91,92,93,94,95],g=[96,97,98,99,100,101,102,103],v=[],O=[];m.forEach(C=>{v.push(i.getVec(s,C))}),g.forEach(C=>{O.push(i.getVec(s,C))});const T=i.center(...v);v.forEach((C,A)=>{const R=o[A],w=u*R+h*(1-R);i.setPoint(s,m[A],i.add(T,i.scale(i.sub(C,T),w)))}),O.forEach((C,A)=>{const R=f[A],w=u*R+h*(1-R);i.setPoint(s,g[A],i.add(T,i.scale(i.sub(C,T),w)))})},widenMouth:(s,d)=>{d-=.5,d*=d<0?.3:.2;const u=i.getVec(s,90),h=i.getVec(s,84),o=i.getVec(s,87),f=i.getVec(s,93),m=i.intersectPoint(u,h,o,f)||i.center(o,f),g=a.scaleByNormal(i.sub(m,h),d+1,m.x,m.y),v=a.scaleByNormal(i.sub(m,u),d+1,m.x,m.y);[84,96,85,95,97,103,86,94].forEach(O=>{i.setPoint(s,O,g.multiplyPoint(i.getVec(s,O)))}),[90,100,89,91,99,101,88,92].forEach(O=>{i.setPoint(s,O,v.multiplyPoint(i.getVec(s,O)))})},mouthCorners:(s,d)=>{const u=.06*(d-.5)*Math.PI,h=i.center(...[84,85,86,87,88,89,90,91,92,93,94,95].map(O=>i.getVec(s,O)));let o=a.rotate(u,h.value[0],h.value[1]),f=a.rotate(.66*u,h.value[0],h.value[1]),m=a.rotate(.33*u,h.value[0],h.value[1]),g=a.rotate(.1*u,h.value[0],h.value[1]),v=[o,f,g,m,f,o,f,f];[84,85,86,94,95,96,97,103].forEach((O,T)=>{const C=v[T].multiplyPoint(i.getVec(s,O));i.setPoint(s,O,C)}),o=a.rotate(-u,h.value[0],h.value[1]),f=a.rotate(.66*-u,h.value[0],h.value[1]),m=a.rotate(.33*-u,h.value[0],h.value[1]),g=a.rotate(.1*-u,h.value[0],h.value[1]),v=[o,f,g,m,f,o,f,f],[90,89,88,92,91,100,99,101].forEach((O,T)=>{const C=v[T].multiplyPoint(i.getVec(s,O));i.setPoint(s,O,C)})},adjustPhiltrum:(s,d)=>{d=.25*(d-.5);const u=i.getVec(s,87),h=i.scale(i.sub(i.getVec(s,49),u),d);for(let o=84;o<104;o++)i.setPoint(s,o,i.add(i.getVec(s,o),h))},shrinkUnderjaw:(s,d)=>{const u=d*=.1,h=d,o=i.getVec(s,16),f=i.getVec(s,49),m=i.getVec(s,0),g=i.getVec(s,32),v=[[6,26],[8,24],[10,22],[12,20],[14,18]],O=[],T=[],C=[];v.forEach(R=>{const w=i.getVec(s,R[0]),k=i.getVec(s,R[1]);O.push([w,k]),T.push(i.intersectPoint(w,f,m,o)),C.push(i.intersectPoint(k,f,g,o))});const A=[.33,.66,1,.66,.33];O.forEach((R,w)=>{const k=i.lerp(R[0],T[w],u*A[w]),I=i.lerp(R[1],C[w],h*A[w]);i.setPoint(s,v[w][0],k),i.setPoint(s,v[w][1],I)})},shrinkCheekbone:(s,d)=>{const u=d*=.08,h=d,o=i.getVec(s,43),f=i.getVec(s,49),m=[[0,32],[2,30],[4,28],[6,26],[8,24]],g=[],v=[];m.forEach(T=>{const C=i.getVec(s,T[0]),A=i.getVec(s,T[1]);g.push([C,A]),v.push(i.intersectPoint(C,A,o,f))});const O=[.33,.66,.33,.22,.11];g.forEach((T,C)=>{const A=i.lerp(T[0],v[C],u*O[C]),R=i.lerp(T[1],v[C],h*O[C]);i.setPoint(s,m[C][0],A),i.setPoint(s,m[C][1],R)})},lengthenJaw:(s,d)=>{d=.1*(.5-d);const u=i.getVec(s,16),h=i.sub(i.getVec(s,49),u),o=[.5,.5];[12,20,14,16,18].forEach((f,m)=>{i.setPoint(s,f,i.add(i.getVec(s,f),i.scale(h,d*(o[m]||1))))})},narrowedFace:(s,d)=>{const u=d*=.05,h=d,o=i.getVec(s,43),f=i.getVec(s,16),m=[.33,.66,1];[[106,111],[0,32],[2,30],[4,28],[6,26],[8,24],[10,22],[12,20],[14,18]].forEach((g,v)=>{let O=i.getVec(s,g[0]),T=i.getVec(s,g[1]),C=i.intersectPoint(O,T,o,f);const A=m[v]||1;O=i.lerp(O,C,u*A),T=i.lerp(T,C,h*A),i.setPoint(s,g[0],O),i.setPoint(s,g[1],T)})},shrinkFace:(s,d)=>{const u=d*=.1,h=d,o=i.getVec(s,43),f=i.getVec(s,16);let m=[[2,30],[4,28],[6,26],[8,24],[10,22],[12,20],[14,18]],g=[.1,.325,.55,.775,1,.9,.8,.7];m.forEach((O,T)=>{let C=i.getVec(s,O[0]),A=i.getVec(s,O[1]),R=i.intersectPoint(C,A,o,f);C=i.lerp(C,R,u*g[T]),A=i.lerp(A,R,h*g[T]),i.setPoint(s,O[0],C),i.setPoint(s,O[1],A)});const v=i.getVec(s,93);m=[[14,18],[12,20]],g=[.4,.2],m.forEach((O,T)=>{let C=i.getVec(s,O[0]),A=i.getVec(s,O[1]);C=i.lerp(C,v,u*g[T]),A=i.lerp(A,v,h*g[T]),i.setPoint(s,O[0],C),i.setPoint(s,O[1],A)}),i.setPoint(s,16,i.lerp(i.getVec(s,16),v,.6*Math.max(u,h)))},vShapedFace:(s,d)=>{const u=d*=.2,h=d,o=i.getVec(s,16),f=i.getVec(s,2),m=i.getVec(s,30),g=[[4,28],[6,26],[8,24],[10,22],[12,20],[14,18]],v=[],O=[],T=[];g.forEach(A=>{const R=i.getVec(s,A[0]),w=i.getVec(s,A[1]);v.push([R,w]),O.push(i.intersectPoint(R,w,f,o)),T.push(i.intersectPoint(w,R,m,o))});const C=[.33,.66];v.forEach((A,R)=>{const w=i.lerp(A[0],O[R],u*(C[R]||1)),k=i.lerp(A[1],T[R],h*(C[R]||1));i.setPoint(s,g[R][0],w),i.setPoint(s,g[R][1],k)})},minifyFace:(s,d)=>{d*=.1;const u=i.getVec(s,43),h=i.getVec(s,49),o=i.getVec(s,2),f=i.getVec(s,30),m=i.lerp(i.intersectPoint(u,h,o,f),u,d);let g=[.1,.25,.4,.55,.7,.85];[4,6,8,10,12,14,84,85,86,94,95,96,97,103,47,80,82].forEach((v,O)=>{const T=i.lerp(i.getVec(s,v),m,d*(g[O]||.65));i.setPoint(s,v,T)}),[28,26,24,22,20,18,88,89,90,91,92,99,100,101,51,81,83].forEach((v,O)=>{const T=i.lerp(i.getVec(s,v),m,d*(g[O]||.65));i.setPoint(s,v,T)}),g=[1],[16,93,102,98,87,49,46].forEach((v,O)=>{const T=i.lerp(i.getVec(s,v),m,d*(g[O]||.65));i.setPoint(s,v,T)})},shortenFace:(s,d)=>{d*=.1;const u=i.getVec(s,43),h=i.getVec(s,49),o=i.center(u,h)||i.getVec(s,45),f=a.scaleByNormal(i.sub(u,h),1-d,o.x,o.y);for(let m=4;m<30;m+=2)i.setPoint(s,m,f.multiplyPoint(i.getVec(s,m)));for(let m=80;m<84;m++)i.setPoint(s,m,f.multiplyPoint(i.getVec(s,m)));for(let m=46;m<52;m++)i.setPoint(s,m,f.multiplyPoint(i.getVec(s,m)));for(let m=84;m<104;m++)i.setPoint(s,m,f.multiplyPoint(i.getVec(s,m)))},whitenTeeth:(s,d)=>{let u=i.dis(i.getVec(s,98),i.getVec(s,102))/(i.dis(i.getVec(s,96),i.getVec(s,100))||1);return d*Math.max(0,Math.min(1,Math.pow(5*u,2)))}}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.BeautyFilter=void 0;const i=r(134),a=r(135),l=r(75),n=r(136),c=r(323),s=r(324),d=r(325),u=r(206),h=r(137),o={};class f extends h.Filter{constructor(g,v,O,T){super(g,v,O,T),this._smooth=0,this._whiten=0,this._redden=0,this._faceMask=null,this._featureParas={forehead:0,eyeRim:0,noseLine:0},this.featureEnable=!1,this.whitenMap=l.createTexture(g.gl,null,{flipY:!1}),this.reddenMap=l.createTexture(g.gl,null,{flipY:!1});const{programs:C,framebuffers:A}=this.initProgramsBuffers();this.programs=C,this.framebuffers=A,this.initUniforms()}initProgramsBuffers(){const g=this.renderer.gl,v=this.renderer.getSize(),O={},T={},C={blurX:{vShader:s.beautyBlurShader.vShader,fShader:s.beautyBlurShader.fShader,size:{width:v.width>>1,height:v.height>>1}},blurY:{vShader:s.beautyBlurShader.vShader,fShader:s.beautyBlurShader.fShader,size:{width:v.width>>1,height:v.height>>1}},highPass:{vShader:n.baseTextureShader.vShader,fShader:d.beautyHighPassShader.fShader,size:v},hBlurX:{vShader:s.beautyBlurShader.vShader,fShader:s.beautyBlurShader.fShader,size:v},hBlurY:{vShader:s.beautyBlurShader.vShader,fShader:s.beautyBlurShader.fShader,size:v},beauty:{vShader:n.baseTextureShader.vShader,fShader:c.beautyShader.fShader,size:v},whiten:{vShader:n.baseTextureShader.vShader,fShader:u.lutShader.fShader,size:v},redden:{vShader:n.baseTextureShader.vShader,fShader:u.lutShader.fShader,size:v}};for(const A in C){const{vShader:R,fShader:w,size:k}=C[A],I=new a.Program(g);I.setShader(R,"VERTEX"),I.setShader(w,"FRAGMENT"),I.setAttributeBuffer(this.posBuffer),I.setAttributeBuffer(this.uvBuffer),O[A]=I;const M=i.createFrameBuffer(g,k.width,k.height);T[A]=M}return{programs:O,framebuffers:T}}initUniforms(){const g=this.programs,v=this.framebuffers,O=this.map,{width:T,height:C}=this.renderer.getSize(),A=[T,C],R=[T>>1,C>>1];g.blurX.setUniform("map",O),g.blurX.setUniform("size",R),g.blurY.setUniform("map",v.blurX.targetTexture),g.blurY.setUniform("size",R),g.blurY.setUniform("isVertical",1),g.highPass.setUniform("map",O),g.highPass.setUniform("blurMap",v.blurY.targetTexture),g.hBlurX.setUniform("map",v.highPass.targetTexture),g.hBlurX.setUniform("size",A),g.hBlurY.setUniform("map",v.hBlurX.targetTexture),g.hBlurY.setUniform("size",A),g.hBlurY.setUniform("isVertical",1),g.beauty.setUniform("size",A),g.beauty.setUniform("map",O),g.beauty.setUniform("blurMap",v.blurY.targetTexture),g.beauty.setUniform("highPassMap",v.hBlurY.targetTexture),g.beauty.setUniform("intensity",0);const w=this.featureParas;for(const k in w)g.beauty.setUniform(k+"Inten",this._featureParas[k]);g.whiten.setUniform("map",O),g.whiten.setUniform("lut",this.whitenMap),g.whiten.setUniform("intensity",0),g.redden.setUniform("map",O),g.redden.setUniform("lut",this.reddenMap),g.redden.setUniform("intensity",0)}get map(){return super.map}set map(g){g!==this._map&&(this._map=g,["blurX","highPass","beauty"].forEach(v=>{this.programs[v].setUniform("map",this._map)}),this.mapChange())}setLutsSrc(g,v){const{whiten:O,redden:T}=g;let C=2;const A=[],R=()=>{C-=1,C<=0&&(v==null||v(A))};if(o.whiten){this.whitenMap.source=o.whiten,this.whitenMap.refresh();const w=this._whiten;this._whiten=0,this.whiten=w,R()}else l.retryLoadImage(O,3,w=>{o.whiten=w,this.whitenMap.source=w,this.whitenMap.refresh();const k=this._whiten;this._whiten=0,this.whiten=k,R()},()=>{A.push(O),R()});if(o.redden){this.reddenMap.source=o.redden,this.reddenMap.refresh();const w=this._redden;this._redden=0,this.redden=w,R()}else l.retryLoadImage(T,3,w=>{o.redden=w,this.reddenMap.source=w,this.reddenMap.refresh();const k=this._redden;this._redden=0,this.redden=k,R()},()=>{A.push(T),R()})}get smoothOut(){return this.smooth||this.featureEnable?this.framebuffers.beauty.targetTexture:this.map}get whitenOut(){return this.whiten?this.framebuffers.whiten.targetTexture:this.smoothOut}mapChange(){this.programs.whiten.setUniform("map",this.smoothOut),this.programs.redden.setUniform("map",this.whitenOut)}get smooth(){return this._smooth}set smooth(g){this._smooth!==g&&(this._smooth=g,this.programs.beauty.setUniform("intensity",this._smooth),this.mapChange())}get whiten(){return this._whiten}set whiten(g){this._whiten!==g&&(this._whiten=g,this.programs.whiten.setUniform("intensity",this.whitenMap&&this.whitenMap.source?this._whiten:0),this.mapChange())}get redden(){return this._redden}set redden(g){this._redden!==g&&(this._redden=g,this.programs.redden.setUniform("intensity",this.reddenMap&&this.reddenMap.source?this._redden:0))}set faceMask(g){this._faceMask!==g&&(this.programs.beauty.setUniform("maskMap",g),this.programs.beauty.setUniform("hasMask",g?1:0),this._faceMask=g)}set featureParas(g){let v=0;for(const O in g){const T=g[O];v+=T,this._featureParas[O]!==T&&(this.programs.beauty.setUniform(O+"Inten",T),this._featureParas[O]=T)}this.featureEnable=v>0,this.mapChange()}get output(){return this.redden?this.framebuffers.redden.targetTexture:this.whiten?this.framebuffers.whiten.targetTexture:this.smooth||this.featureEnable?this.framebuffers.beauty.targetTexture:super.output}updateSize(){const g=this.renderer.getSize(),v=[g.width,g.height],O=[g.width>>1,g.height>>1];["blurX","blurY"].forEach(T=>{const C=this.framebuffers[T];C.targetTexture.opts.width=O[0],C.targetTexture.opts.height=O[1],C.targetTexture.refresh(),this.programs[T].setUniform("size",O)}),["highPass","hBlurX","hBlurY","beauty","whiten","redden"].forEach(T=>{const C=this.framebuffers[T];C.targetTexture.opts.width=v[0],C.targetTexture.opts.height=v[1],C.targetTexture.refresh(),["highPass","whiten","redden"].indexOf(T)<0&&this.programs[T].setUniform("size",v)})}render(){const g=this.renderer,{width:v,height:O}=g.getSize(),T=this.programs,C=this.framebuffers;(this.smooth||this.featureEnable)&&(g.setViewport(0,0,v>>1,O>>1),C.blurX.bind(),g.render(T.blurX),C.blurY.bind(),g.render(T.blurY),g.setViewport(0,0,v,O),C.highPass.bind(),g.render(T.highPass),C.hBlurX.bind(),g.render(T.hBlurX),C.hBlurY.bind(),g.render(T.hBlurY),C.beauty.bind(),g.render(T.beauty)),this.whiten&&(C.whiten.bind(),g.render(T.whiten)),this.redden&&(C.redden.bind(),g.render(T.redden))}destroy(){super.destroy();const g=this.renderer.gl;g==null||g.deleteTexture(this.whitenMap.glTexture),g==null||g.deleteTexture(this.reddenMap.glTexture)}}e.BeautyFilter=f},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.beautyShader=void 0,e.beautyShader={fShader:`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
        precision highp float;
    #else
        precision mediump float;
    #endif

    uniform vec2 size;

    uniform sampler2D map;
    uniform sampler2D blurMap;
    uniform sampler2D highPassMap;
    uniform sampler2D maskMap;
    uniform int hasMask;

    // 磨皮度
    uniform float intensity;
    uniform float foreheadInten;
    uniform float eyeRimInten;
    uniform float noseLineInten;

    varying vec2 vuv;

    void main() {
        vec4 originColor = texture2D(map, vuv);
        float _intensity = intensity;
        if(hasMask > 0){
            vec4 mask = texture2D(maskMap, vuv);
            float intens = max(max(mask.r * noseLineInten, mask.g * foreheadInten), mask.b * eyeRimInten);
            if(intens > 0.0){
              _intensity = mix(_intensity, 1.5, intens);
            }else{
              _intensity *= mask.a;
            }
        }
        if(_intensity > 0.0){
            vec2 stepOffset = 0.5 / size;
            float uOffsetX = stepOffset.x;
            float uOffsetY = stepOffset.y;
            float strength = _intensity * 1.0;

            vec4 meanColor = texture2D(blurMap, vuv);
            vec4 varColor = texture2D(highPassMap, vuv);

            float value = clamp((min(originColor.r, meanColor.r - 0.1) - 0.2) * 4.0, 0.0, 1.0);
            float meanValue = (varColor.r + varColor.g + varColor.b) / 3.0;
            float currentIntensity = (1.0 - meanValue / (meanValue + 0.1)) * value * strength;
            vec3 resultColor = mix(originColor.rgb, meanColor.rgb, currentIntensity);
            float sum = 0.25*originColor.g;
            sum += 0.125 *texture2D(map,vec2(vuv.x-uOffsetX, vuv.y)).g;
            sum += 0.125 *texture2D(map,vec2(vuv.x+uOffsetX, vuv.y)).g;
            sum += 0.125 *texture2D(map,vec2(vuv.x, vuv.y-uOffsetY)).g;
            sum += 0.125 *texture2D(map,vec2(vuv.x, vuv.y+uOffsetY)).g;
            sum += 0.0625*texture2D(map,vec2(vuv.x+uOffsetX, vuv.y+uOffsetY)).g;
            sum += 0.0625*texture2D(map,vec2(vuv.x+uOffsetX, vuv.y-uOffsetY)).g;
            sum += 0.0625*texture2D(map,vec2(vuv.x-uOffsetX, vuv.y+uOffsetY)).g;
            sum += 0.0625*texture2D(map,vec2(vuv.x-uOffsetX, vuv.y-uOffsetY)).g;

            float hPass = originColor.g - sum + 0.5;
            float flag = step(0.5, hPass);
            vec3 color = mix(max(vec3(0.0), (2.0*hPass + resultColor - 1.0)), min(vec3(1.0), (resultColor + 2.0*hPass - 1.0)), flag);

            gl_FragColor = vec4(mix(resultColor.rgb, color.rgb, _intensity), 1.0);
        }else{
            gl_FragColor = originColor;
        }
    }`}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.beautyBlurShader=void 0,e.beautyBlurShader={vShader:`
    uniform vec2 size;
    uniform float isVertical;

    attribute vec4 position;
    attribute vec2 uv;

    varying vec2 vuv;
    varying vec4 vTextureShift1;
	varying vec4 vTextureShift2;
	varying vec4 vTextureShift3;
	varying vec4 vTextureShift4;

    void main() {
        gl_Position = position;
        vuv = uv;
        // 偏移步距
        vec2 stepOffset = 1.0 / size;
        if(isVertical> 0.5){
            stepOffset.x = 0.0;
        }else{
            stepOffset.y = 0.0;
        }

        vTextureShift1 = vec4(uv - stepOffset, uv + stepOffset);
		vTextureShift2 = vec4(uv- 2.0 * stepOffset, uv + 2.0 * stepOffset);
		vTextureShift3 = vec4(uv - 3.0 * stepOffset, uv + 3.0 * stepOffset);
		vTextureShift4 = vec4(uv - 4.0 * stepOffset, uv + 4.0 * stepOffset);
    }
`,fShader:`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
        precision highp float;
    #else
        precision mediump float;
    #endif

    uniform sampler2D map;

    varying vec2 vuv;
    varying vec4 vTextureShift1;
	varying vec4 vTextureShift2;
	varying vec4 vTextureShift3;
	varying vec4 vTextureShift4;

    void main() {
        vec4 color = texture2D(map, vuv);

        vec3 sum = color.rgb;
        sum += texture2D(map, vTextureShift1.xy).rgb;
		sum += texture2D(map, vTextureShift1.zw).rgb;
		sum += texture2D(map, vTextureShift2.xy).rgb;
		sum += texture2D(map, vTextureShift2.zw).rgb;
		sum += texture2D(map, vTextureShift3.xy).rgb;
		sum += texture2D(map, vTextureShift3.zw).rgb;
		sum += texture2D(map, vTextureShift4.xy).rgb;
		sum += texture2D(map, vTextureShift4.zw).rgb;

        gl_FragColor = vec4(sum * 0.1111, 1.0);
    }
`}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.beautyHighPassShader=void 0,e.beautyHighPassShader={fShader:`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
        precision highp float;
    #else
        precision mediump float;
    #endif

    uniform sampler2D map;
    uniform sampler2D blurMap;

    varying vec2 vuv;

    void main() {
        vec4 color = texture2D(map, vuv);
        vec4 blurColor = texture2D(blurMap, vuv);
        vec3 diffColor = (color.rgb - blurColor.rgb) * 6.0;
        diffColor = diffColor * diffColor;
        diffColor = min(diffColor, 1.0);
        gl_FragColor = vec4(diffColor, 1.0);
    }
`}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.LutFilter=void 0;const i=r(134),a=r(135),l=r(75),n=r(136),c=r(206),s=r(137),d={};class u extends s.Filter{constructor(o,f,m,g){super(o,f,m,g),this.lutImgs={},this.curLutName=null,this.lutMap=l.createTexture(o.gl,null,{flipY:!1});const{program:v,framebuffer:O}=this.initProgramBuffer();this.programs.main=v,this.framebuffers.main=O}initProgramBuffer(){const o=this.renderer.gl,f=this.renderer.getSize(),m=new a.Program(o);m.setShader(n.baseTextureShader.vShader,"VERTEX"),m.setShader(c.lutShader.fShader,"FRAGMENT"),m.setAttributeBuffer(this.posBuffer),m.setAttributeBuffer(this.uvBuffer);const g=i.createFrameBuffer(o,f.width,f.height);return m.setUniform("map",this.map),m.setUniform("lut",this.lutMap),m.setUniform("intensity",0),{program:m,framebuffer:g}}getLutImg(o){var f;return o&&(f=this.lutImgs[o])!==null&&f!==void 0?f:null}get map(){return this._map}set map(o){this._map!==o&&(this._map=o,this.programs.main.setUniform("map",this._map))}setLutsSrc(o,f){let m=Object.keys(o).length;const g=[],v=()=>{m-=1,m<=0&&(f==null||f(g))};for(const O in o){const{src:T,intensity:C=.5}=o[O];this.lutImgs[O]={img:null,intensity:C},d[O]?(this.lutImgs[O].img=d[O],O===this.curLutName&&(this.curLutName=null,this.setlut(O)),v()):l.retryLoadImage(T,3,A=>{d[O]=A,this.lutImgs[O].img=A,O===this.curLutName&&(this.curLutName=null,this.setlut(O)),v()},()=>{g.push(T),v()})}}get output(){return this.intensity?this.framebuffers.main.targetTexture:super.output}updateSize(){const o=this.renderer.getSize(),f=this.framebuffers.main;f.targetTexture.opts.width=o.width,f.targetTexture.opts.height=o.height,f.targetTexture.refresh()}setlut(o,f){if(o!==this.curLutName){this.curLutName=o;const m=this.getLutImg(this.curLutName);m&&(this.lutMap.source=m.img,this.lutMap.refresh())}f=f??this.intensity,this.intensity=f}get intensity(){const o=this.getLutImg(this.curLutName);return o?o.intensity:0}set intensity(o){const f=this.getLutImg(this.curLutName);f?(f.intensity=o,f.img?this.programs.main.setUniform("intensity",this.intensity):this.programs.main.setUniform("intensity",0)):this.programs.main.setUniform("intensity",0)}render(){this.intensity&&(this.framebuffers.main.bind(),this.renderer.render(this.programs.main))}destroy(){var o;super.destroy(),(o=this.renderer.gl)===null||o===void 0||o.deleteTexture(this.lutMap.glTexture)}}e.LutFilter=u},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.NormalFilter=void 0;const i=r(134),a=r(135),l=r(136),n=r(137);class c extends n.Filter{constructor(d,u,h,o){super(d,u,h,o),this._srcMap=null,this.pixels=null,this.initProgram()}initProgram(){const d=this.renderer.gl;let u=this.renderer.getSize();const h=new a.Program(d);h.setShader(l.baseTextureShader.vShader,"VERTEX"),h.setShader(l.baseTextureShader.yFlipFShader,"FRAGMENT"),h.setAttributeBuffer(this.posBuffer),h.setAttributeBuffer(this.uvBuffer);const o=i.createFrameBuffer(d,u.width,u.height);h.setUniform("map",this._srcMap),this.programs.imgData=h,this.framebuffers.imgData=o;const f=new a.Program(d);f.setShader(l.baseTextureShader.vShader,"VERTEX"),f.setShader(l.baseTextureShader.fShader,"FRAGMENT"),f.setAttributeBuffer(this.posBuffer),f.setAttributeBuffer(this.uvBuffer),f.setUniform("map",this._map),this.programs.main=f}getImageData(d){d!==this._srcMap&&(this._srcMap=d,this.programs.imgData.setUniform("map",this._srcMap)),this._srcMap&&this._srcMap.refresh();const u=this.renderer,{width:h,height:o}=u.getSize(),f=u.gl;return this.framebuffers.imgData.bind(),u.render(this.programs.imgData),this.pixels&&this.pixels.length===h*o*4||(this.pixels=new Uint8Array(h*o*4)),f.readPixels(0,0,h,o,f.RGBA,f.UNSIGNED_BYTE,this.pixels),this.framebuffers.imgData.bind(!0),this.pixels}get map(){return this._map}set map(d){this._map!==d&&(this._map=d,this.programs.main.setUniform("map",this._map))}updateSize(){const d=this.renderer.getSize(),u=this.framebuffers.imgData;u&&(u.targetTexture.opts.width=d.width,u.targetTexture.opts.height=d.height,u.targetTexture.refresh())}render(){const d=this.renderer,{width:u,height:h}=d.getSize(),o=d.gl;d.setViewport(0,0,u,h),o.bindFramebuffer(o.FRAMEBUFFER,null),d.render(this.programs.main)}}e.NormalFilter=c},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.typedArray=void 0,e.typedArray={posArray:new Int8Array([-1,1,-1,-1,1,1,1,-1]),uvArray:new Uint8Array([0,1,0,0,1,1,1,0]),advBeautyPosArray:new Int16Array((()=>{const i=[];for(let a=0;a<145;a++)i.push(0,0);return i.push(0,0,0,1,1,1,1,0),i})()),advBeautyZindexArray:new Int16Array((()=>{const i=[];for(let a=0;a<145;a++)i.push(0);return i.push(-1,-1,-1,-1),i})()),advBeautyIndicesArray:new Uint16Array([145,146,147,145,147,148,0,2,52,52,2,57,57,2,4,57,4,73,73,4,80,73,80,56,56,80,55,55,80,43,67,55,43,67,54,55,66,54,67,66,72,54,65,72,66,65,53,72,64,53,65,64,52,53,33,52,64,0,52,33,33,64,34,34,64,65,34,65,35,35,65,66,35,66,36,36,66,67,36,67,37,53,52,57,53,57,73,53,73,72,72,73,56,72,56,54,54,56,55,37,67,43,37,43,38,38,43,68,68,43,58,58,43,81,43,46,81,81,46,83,46,51,83,46,49,51,46,47,49,46,82,47,80,82,46,43,80,46,43,55,80,67,55,43,38,68,39,39,68,69,39,69,40,40,69,70,40,70,41,41,70,71,41,71,42,32,61,30,30,61,62,30,62,28,62,76,28,76,81,28,63,81,76,58,81,63,43,81,58,43,58,68,68,58,59,68,59,69,69,59,75,69,75,70,70,75,60,70,60,71,71,60,61,71,61,42,42,61,32,59,58,63,59,63,76,59,76,75,75,76,62,75,62,60,60,62,61,4,82,80,4,6,82,6,8,82,82,8,84,8,10,84,84,10,12,84,12,95,95,12,14,95,14,94,94,14,93,93,14,16,93,16,18,93,18,92,92,18,20,92,20,91,91,20,90,90,20,22,90,22,24,90,24,83,83,24,26,83,26,28,83,28,81,106,0,33,106,33,34,107,106,34,107,34,35,108,107,35,108,35,36,109,108,36,109,36,37,110,109,37,116,110,37,116,37,38,115,116,38,114,115,38,114,38,39,113,114,39,113,39,40,112,113,40,112,40,41,111,112,41,111,41,42,111,42,32,82,84,47,47,84,85,47,85,86,47,86,49,49,86,87,49,87,88,49,88,51,51,88,89,51,89,90,83,51,90,85,84,96,85,96,97,85,97,86,86,97,87,87,97,98,87,98,99,87,99,88,88,99,89,89,99,100,89,100,90,100,91,90,101,91,100,101,92,91,102,92,101,102,93,92,102,94,93,103,94,102,103,95,94,96,95,103,84,95,96,96,103,97,97,103,102,97,102,98,98,102,99,99,102,101,99,101,100,0,117,118,0,118,2,2,118,119,2,119,4,4,119,120,4,120,6,6,120,121,6,121,8,8,121,122,8,122,10,10,122,123,10,123,12,12,123,124,12,124,14,14,124,125,14,125,16,16,125,126,16,126,18,18,126,127,18,127,20,20,127,128,20,128,22,22,128,129,22,129,24,24,129,130,24,130,26,26,130,131,26,131,28,28,131,132,28,132,30,30,132,133,30,133,32,106,134,117,106,117,0,107,135,134,107,134,106,108,136,135,108,135,107,109,137,136,109,136,108,110,138,137,110,137,109,116,144,138,116,138,110,115,143,144,115,144,116,114,142,143,114,143,115,113,141,142,113,142,114,112,140,141,112,141,113,111,139,140,111,140,112,32,133,139,32,139,111]),advFaceMaskUVArray:new Float32Array([.30859375,.58203125,.30859375,.5546875,.310546875,.52734375,.3125,.5,.314453125,.47265625,.318359375,.4453125,.322265625,.41796875,.330078125,.392578125,.337890625,.369140625,.349609375,.34765625,.365234375,.328125,.380859375,.310546875,.400390625,.296875,.419921875,.28515625,.44140625,.27734375,.46484375,.271484375,.486328125,.26953125,.509765625,.271484375,.533203125,.275390625,.5546875,.283203125,.578125,.29296875,.59765625,.306640625,.6171875,.32421875,.634765625,.341796875,.650390625,.36328125,.662109375,.388671875,.669921875,.4140625,.67578125,.44140625,.6796875,.46875,.68359375,.49609375,.685546875,.525390625,.6875,.552734375,.6875,.580078125,.33984375,.634765625,.36328125,.66796875,.392578125,.673828125,.421875,.671875,.451171875,.6640625,.521484375,.666015625,.55078125,.671875,.58203125,.673828125,.611328125,.666015625,.63671875,.634765625,.486328125,.60546875,.484375,.568359375,.482421875,.533203125,.482421875,.498046875,.443359375,.47265625,.462890625,.46875,.484375,.46484375,.505859375,.470703125,.52734375,.474609375,.369140625,.599609375,.384765625,.611328125,.421875,.611328125,.4375,.59765625,.419921875,.591796875,.384765625,.591796875,.537109375,.59765625,.552734375,.611328125,.591796875,.611328125,.607421875,.59765625,.591796875,.591796875,.5546875,.591796875,.36328125,.646484375,.392578125,.650390625,.421875,.6484375,.451171875,.642578125,.521484375,.642578125,.55078125,.6484375,.580078125,.6484375,.611328125,.64453125,.40234375,.615234375,.400390625,.58984375,.40234375,.6015625,.57421875,.615234375,.57421875,.58984375,.572265625,.6015625,.4609375,.6015625,.51171875,.6015625,.443359375,.521484375,.5234375,.5234375,.431640625,.490234375,.537109375,.4921875,.416015625,.392578125,.44140625,.41796875,.470703125,.427734375,.486328125,.427734375,.5,.4296875,.53125,.419921875,.55859375,.39453125,.537109375,.375,.51171875,.36328125,.484375,.361328125,.4609375,.36328125,.4375,.375,.421875,.392578125,.453125,.408203125,.484375,.412109375,.51953125,.41015625,.552734375,.39453125,.51953125,.388671875,.484375,.38671875,.453125,.38671875,.40234375,.599609375,.57421875,.599609375,.3046875,.634765625,.31640625,.685546875,.341796875,.734375,.380859375,.7734375,.431640625,.802734375,.6875,.638671875,.671875,.693359375,.642578125,.7421875,.599609375,.78125,.546875,.806640625,.48828125,.81640625,.25390625,.576171875,.2578125,.50390625,.26171875,.43359375,.271484375,.36328125,.29296875,.298828125,.328125,.24609375,.373046875,.205078125,.427734375,.1796875,.486328125,.169921875,.546875,.177734375,.60546875,.19921875,.65625,.240234375,.69921875,.291015625,.724609375,.357421875,.736328125,.427734375,.744140625,.501953125,.74609375,.57421875,.25,.64453125,.263671875,.7109375,.296875,.7734375,.34765625,.82421875,.4140625,.86328125,.74609375,.650390625,.7265625,.720703125,.689453125,.783203125,.6328125,.833984375,.564453125,.8671875,.48828125,.880859375,0,0,0,0,0,0,0,0]),advEyeTeethPosArray:new Int16Array(48),advEyeTeethZindexArray:new Int16Array(24),advEyeTeethUVArray:new Float32Array([.927,.789,.772,.877,.49,.91,.269,.872,.078,.764,.272,.61,.506,.559,.738,.611,.927,.789,.772,.877,.49,.91,.269,.872,.078,.764,.272,.61,.506,.559,.738,.611,.067,.28,.267,.389,.512,.364,.754,.389,.933,.29,.76,.159,.497,.112,.243,.156]),advEyeTeethIndicesArray:new Uint16Array([1,0,7,1,7,6,1,6,2,2,6,5,2,5,3,3,5,4,11,12,13,11,13,14,11,14,10,10,14,15,10,15,9,9,15,8,16,23,17,17,23,22,17,22,18,18,22,19,19,22,21,19,21,20]),advForeheadPosArray:new Int16Array(98),advForeheadZindexArray:new Int16Array(49),advForeheadUVArray:new Float32Array([.12,.564,.181,.619,.26,.628,.341,.616,.41,.592,.597,.592,.666,.616,.747,.628,.827,.619,.887,.564,.051,.638,.101,.753,.154,.853,.236,.933,.355,.955,.504,.956,.652,.955,.771,.933,.853,.853,.907,.753,.956,.638,.155,.266,.281,.306,.441,.371,.598,.395,.694,.334,.763,.247,.134,.379,.242,.427,.401,.49,.604,.522,.749,.455,.87,.3,.306,.251,.397,.232,.497,.217,.593,.23,.673,.262,.356,.104,.491,.024,.652,.11,.306,.251,.397,.232,.497,.217,.593,.23,.673,.262,.356,.104,.491,.024,.652,.11]),advForeheadIndicesArray:new Uint16Array([18,0,1,11,18,1,11,1,2,12,11,2,12,2,3,13,12,3,13,3,4,14,13,4,14,4,15,15,4,5,16,15,5,17,16,5,17,5,6,17,6,18,18,6,7,19,18,7,19,7,8,20,19,8,20,8,9,27,21,28,28,21,22,29,28,22,29,22,23,30,29,23,30,23,24,31,30,24,31,24,25,32,31,25,32,25,26])}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.VirtualBackFilter=void 0;const i=r(134),a=r(330),l=r(135),n=r(75),c=r(136),s=r(331),d=r(332),u=r(137);class h extends u.Filter{constructor(f,m,g,v){super(f,m,g,v),this.intensity=.1,this.lastSetInfo={},this.sourceMap=m,this.maskMap=n.createTexture(f.gl,null),this.bkColor=new a.GlColor("#e7ad3c"),this.bkMap=n.createTexture(f.gl,null),this.initProgramBuffer()}initProgramBuffer(){const f=this.renderer.gl,m=this.renderer.getSize(),g=[n.toNthPower(m.width),n.toNthPower(m.height)],v=new l.Program(f);v.setShader(c.baseTextureShader.vShader,"VERTEX"),v.setShader(c.baseTextureShader.fShader,"FRAGMENT"),v.setAttributeBuffer(this.posBuffer),v.setAttributeBuffer(this.uvBuffer);const O=i.createFrameBuffer(f,g[0],g[1],!0);v.setUniform("map",this.sourceMap),this.programs.mip=v,this.framebuffers.mip=O;const T=new l.Program(f);T.setShader(c.baseTextureShader.vShader,"VERTEX"),T.setShader(s.mipMapBlurShader.fShader,"FRAGMENT"),T.setAttributeBuffer(this.posBuffer),T.setAttributeBuffer(this.uvBuffer);const C=i.createFrameBuffer(f,m.width,m.height);T.setUniform("map",O.targetTexture),T.setUniform("radius",.25*Math.max(m.width,m.height)),T.setUniform("intensity",.1),this.programs.blur=T,this.framebuffers.blur=C;const A=new l.Program(f);A.setShader(c.baseTextureShader.vShader,"VERTEX"),A.setShader(d.virtualBackShader.fShader,"FRAGMENT"),A.setAttributeBuffer(this.posBuffer),A.setAttributeBuffer(this.uvBuffer);const R=i.createFrameBuffer(f,m.width,m.height);A.setUniform("map",this.map),A.setUniform("maskMap",this.maskMap),A.setUniform("backColor",this.bkColor.value),A.setUniform("backMap",this.bkMap),A.setUniform("size",[m.width,m.height]),A.setUniform("bkSize",[0,0]),A.setUniform("backType",0),A.setUniform("emptyFrame",0),this.programs.main=A,this.framebuffers.main=R}get map(){return this._map}set map(f){this._map!==f&&(this._map=f,this.programs.main.setUniform("map",this._map))}set emptyFrame(f){this.programs.main.setUniform("emptyFrame",f?1:0)}setMaskMap(f){const m=this.maskMap;m&&(m.source=f,m.refresh())}setBkColor(f){this.bkColor.setValue(f||"#e7ad3c"),this.programs.main.setUniform("backColor",this.bkColor.value)}getBkInfo(){const f=this.bkMap,m=f?f.source:null,g={type:"color",size:[0,0]};return m&&("videoWidth"in m?(g.type="video",g.size=[m.videoWidth,m.videoHeight]):m instanceof Image&&(g.type="image",g.size=[m.naturalWidth,m.naturalHeight])),g}setBkMap(f){const m=this.bkMap;m&&(f instanceof Image||f===null?(m.source=f,m.refresh()):"readyState"in f&&(f.readyState<2?setTimeout(()=>{this.setBkMap(f)},16.7):(m.source=f,m.refresh())))}setBackground(f){const m=typeof f;m==="string"||f===null?(this.setBkColor(f),this.setBkMap(null)):m==="object"&&(this.setBkColor(null),this.setBkMap(f));const g=this.getBkInfo();this.programs.main.setUniform("backType",g.type==="color"?0:1),g.type!=="color"&&(this.programs.main.setUniform("backMap",this.bkMap),this.programs.main.setUniform("bkSize",g.size)),this.lastSetInfo={type:"bk",value:f}}setBlurIntensity(f){const m=this.renderer.getSize();f=Math.max(.1,Math.min(1,f)),this.programs.blur.setUniform("intensity",f),this.programs.main.setUniform("backMap",this.framebuffers.blur.targetTexture),this.programs.main.setUniform("bkSize",[m.width,m.height]),this.programs.main.setUniform("backType",1),this.lastSetInfo={type:"blur",value:f}}get output(){return this.maskMap&&this.maskMap.source?this.framebuffers.main.targetTexture:super.output}updateSize(){const f=this.renderer.getSize(),m=[n.toNthPower(f.width),n.toNthPower(f.height)];["blur","main"].forEach(v=>{const O=this.framebuffers[v];O.targetTexture.opts.width=f.width,O.targetTexture.opts.height=f.height,O.targetTexture.refresh()});const g=this.framebuffers.mip;g.targetTexture.opts.width=m[0],g.targetTexture.opts.height=m[1],g.targetTexture.refresh(),this.programs.main.setUniform("size",[f.width,f.height]),this.programs.blur.setUniform("radius",.25*Math.max(f.width,f.height)),this.programs.main.getUniform("backMap").value===g.targetTexture&&this.programs.main.setUniform("bkSize",m)}render(){var f;if(this.maskMap&&this.maskMap.source){const m=this.renderer;if(this.programs.main.getUniform("backMap").value===this.framebuffers.blur.targetTexture){const g=m.getSize(),v=this.framebuffers.mip.targetTexture;m.setViewport(0,0,v.opts.width,v.opts.height),this.framebuffers.mip.bind(),this.programs.mip.render(),this.framebuffers.mip.targetTexture.updateMipMap(),m.setViewport(0,0,g.width,g.height),this.framebuffers.blur.bind(),this.programs.blur.render()}else this.getBkInfo().type==="video"&&((f=this.bkMap)===null||f===void 0||f.refresh());this.framebuffers.main.bind(),this.programs.main.render()}}destroy(){var f,m;super.destroy(),(f=this.renderer.gl)===null||f===void 0||f.deleteTexture(this.maskMap.glTexture),(m=this.renderer.gl)===null||m===void 0||m.deleteTexture(this.bkMap.glTexture)}}e.VirtualBackFilter=h},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.GlColor=void 0,e.GlColor=class{constructor(i){this._color=[1,1,1,1],this.convert(i)}convert(i){if(typeof i=="string"){if(/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/i.test(i)){if(i.length===4){let l="#";for(let n=1;n<4;n+=1)l+=i.slice(n,n+1).concat(i.slice(n,n+1));i=l}const a=[];for(let l=1;l<7;l+=2)a.push(parseInt("0x"+i.slice(l,l+2)));return void this.convert(a)}console.error(`color:[${i}] format is error.`)}else this._color=i.map((a,l)=>l<3?Math.min(Math.max(Number(a),0),255)/255:Math.min(Math.max(Number(Number(a??1)),0),1))}get value(){return this._color}setValue(i){this.convert(i)}}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.mipMapBlurShader=void 0,e.mipMapBlurShader={fShader:`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
        precision highp float;
    #else
        precision mediump float;
    #endif

    uniform sampler2D map;
    uniform float intensity;
    uniform float radius;
    varying vec2 vuv;

    float weight(float t, float log2radius, float gamma)
    {
        return exp(-gamma*pow(log2radius-t,2.));
    }

    vec3 sample_blured(vec2 uv, float radius, float gamma)
    {
        vec3 pix = vec3(0.);
        float norm = 0.;
        for(float i = 0.; i < 10.; i += 0.5)
        {
            float k = weight(i, log2(radius), gamma);
            pix += k * texture2D(map, uv, i).rgb;
            norm += k;
        }
        return pix*pow(norm,-0.95);
    }

    void main() {
        gl_FragColor = vec4(sample_blured(vuv, mix(8.0, radius, intensity), intensity), 1.0);
    }
`}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.virtualBackShader=void 0,e.virtualBackShader={fShader:`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
        precision highp float;
    #else
        precision mediump float;
    #endif

    uniform sampler2D map;
    uniform sampler2D maskMap;
    uniform sampler2D backMap;
    uniform vec3 backColor;
    uniform vec2 size;
    uniform vec2 bkSize;
    uniform int backType;
    uniform int emptyFrame;

    varying vec2 vuv;

    void main() {
        if(emptyFrame > 0){
            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
        }else{
            vec3 color = texture2D(map, vuv).rgb;
            float alpha = texture2D(maskMap, vuv).a;

            vec3 bk = backColor;
            // 背景图
            if(backType == 1){
                float ratio = size.x / size.y;
                float bkRatio = bkSize.x / bkSize.y;
                vec2 suv = vuv;
                if(ratio > bkRatio){
                    suv.y = (suv.y - 0.5) * bkRatio / ratio + 0.5;
                }else{
                    suv.x = (suv.x - 0.5) * ratio / bkRatio + 0.5;
                }
                bk = texture2D(backMap, suv).rgb;
            }

            gl_FragColor = vec4(mix(bk, color, alpha), 1.0);
        }
    }
`}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0});const i=r(3),a=r(205);class l extends i.EventEmitter{constructor(c){var s;super(),this.setAdvEffect=(...d)=>{var u;this.videPostProcess.availableCode<1||(this.logger.log(`set advbeauty effect：[${d[0]}, ${d[1]}]`),(u=this.videPostProcess.filters)===null||u===void 0||u.advBeauty.setAdvEffect(...d))},this.presetAdvEffect=(...d)=>{var u;this.videPostProcess.availableCode<1||(this.logger.log("preset advbeauty effect："+JSON.stringify(d[0])),(u=this.videPostProcess.filters)===null||u===void 0||u.advBeauty.presetAdvEffect(...d))},this.videPostProcess=c,(s=this.videPostProcess.filters)===null||s===void 0||s.advBeauty.on("advBeautyResComplete",d=>{this.videPostProcess.emit("advBeautyResComplete",d)})}get advancedBeautyProcess(){const c=this.videPostProcess.getPlugin("AdvancedBeauty");return c||this.logger.error("Can not get AdvancedBeauty plugin"),c}init(c){this.videPostProcess.availableCode<1||(this.advancedBeautyProcess.on("facePoints-load",()=>{this.emit("facePoints-load"),this.advancedBeautyProcess.setFaceSize(Math.min(5,Math.max(1,c||1)))}),this.advancedBeautyProcess.init())}destroy(){this.videPostProcess.availableCode<1||(this.advancedBeautyProcess.removeAllListeners(),this.advancedBeautyProcess.destroy())}get logger(){return this.videPostProcess.logger}setTrack(c,s){var d;return c&&l.configStaticRes(a.resSet,(d=this.videPostProcess.filters)===null||d===void 0?void 0:d.advBeauty),new Promise((u,h)=>{this.videPostProcess.setTaskAndTrack("AdvancedBeauty",c,s).then(o=>{var f;c||(f=this.videPostProcess.filters)===null||f===void 0||f.advBeauty.setAdvData([]),u(o)}).catch(o=>{h(o)})})}get isEnable(){return this.videPostProcess.hasTask("AdvancedBeauty")}}e.default=l,l.configStaticRes=(n,c)=>{a.AdvBeautyFilter.configStaticRes(n,c)}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0});const i={beauty:{whiten:"https://yx-web-nosdn.netease.im/common/cab8e4f0696d3d8e29ee10d6dccc1204/meibai.png",redden:"https://yx-web-nosdn.netease.im/common/c614e2af82da88807067926d7ff3be3d/hongrun.png"},filters:{ziran:{src:"https://yx-web-nosdn.netease.im/common/c89328281947fceabdc71d5fa08b2345/ziran.png",intensity:1},baixi:{src:"https://yx-web-nosdn.netease.im/common/3a22a55384b0bd5b07fca3509bfc981a/baixi.png",intensity:.5},fennen:{src:"https://yx-web-nosdn.netease.im/common/db5befdae1f46dad2e5a6d702bad19ea/fennen.png",intensity:.5},weimei:{src:"https://yx-web-nosdn.netease.im/common/cf8bfec70d7998bb0033757276c6559a/weimei.png",intensity:.5},langman:{src:"https://yx-web-nosdn.netease.im/common/1c50a14532bfa3ad503a82ddd13f0ec8/langman.png",intensity:.5},rixi:{src:"https://yx-web-nosdn.netease.im/common/c414819383913b5db0d9b686276e3d57/rixi.png",intensity:.5},landiao:{src:"https://yx-web-nosdn.netease.im/common/4c77522852dc14448603be21abc571c8/landiao.png",intensity:.5},qingliang:{src:"https://yx-web-nosdn.netease.im/common/1150e94f831d24148239001588a7ca7d/qingliang.png",intensity:.5},huaijiu:{src:"https://yx-web-nosdn.netease.im/common/6a38caeab164d1b5cc086391d6a11a74/huaijiu.png",intensity:.5},qingcheng:{src:"https://yx-web-nosdn.netease.im/common/3b3332c5ae4306312b6f3c4c552a464a/qingcheng.png",intensity:1},wuhou:{src:"https://yx-web-nosdn.netease.im/common/200fc7a12177774f4eb23f55d72643ee/wuhou.png",intensity:1},zhigan:{src:"https://yx-web-nosdn.netease.im/common/848bd44506cf8e10ecabf564e3d74809/zhigan.png",intensity:1},mopian:{src:"https://yx-web-nosdn.netease.im/common/c454efa119520f0793ce51327951ed0a/mopian.png",intensity:1},dianying:{src:"https://yx-web-nosdn.netease.im/common/3a6a22adad29c5844fc829f4f889a79f/dianying.png",intensity:1},heibai:{src:"https://yx-web-nosdn.netease.im/common/941270f2948218ea19f2d79db5e7d349/heibai.png",intensity:1}}},a=new Set;e.default=class{constructor(l){this.lutLoaded=!1,this.videPostProcess=l,this.videPostProcess.on("contextLost",()=>{this.lutLoaded=!1}),a.add(this)}startLut(){if(this.lutLoaded)return;const l=this.videPostProcess.filters;if(!l)return;let n=2;const c=[],s=()=>{n-=1,n<=0&&this.videPostProcess.emit("beautyResComplete",c)};l.beauty.setLutsSrc(i.beauty,d=>{c.push(...d),s()}),l.lut.setLutsSrc(i.filters,d=>{c.push(...d),s()}),this.lutLoaded=!0}setFilter(l,n){var c;(c=this.videPostProcess.filters)===null||c===void 0||c.lut.setlut(l,n)}setBeauty(l,n){return l&&this.startLut(),new Promise((c,s)=>{this.videPostProcess.setTaskAndTrack("BasicBeauty",l,n).then(d=>{if(!l){const u=this.videPostProcess.filters;if(!u)return;u.beauty.whiten=0,u.beauty.redden=0,u.beauty.smooth=0,u.lut.setlut(null)}c(d)}).catch(d=>{s(d)})})}setBeautyOptions(l){const n=this.videPostProcess.filters;n&&("smoothnessLevel"in l&&(n.beauty.smooth=l.smoothnessLevel),"brightnessLevel"in l&&(n.beauty.whiten=l.brightnessLevel),"rednessLevel"in l&&(n.beauty.redden=l.rednessLevel))}get isEnable(){return this.videPostProcess.hasTask("BasicBeauty")}static configStaticRes(l){let n=!1;l.beauty&&(i.beauty=Object.assign({},l.beauty),n=!0),l.filters&&(i.filters=Object.assign({},l.filters),n=!0),n&&a.forEach(c=>{try{c.lutLoaded=!1,c.startLut()}catch{}})}}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0});const i=r(3),a=r(75);class l extends i.EventEmitter{constructor(c){super(),this.bgOption={type:"color",color:"#e7ad3c"},this.videPostProcess=c}get segmentProcess(){return this.videPostProcess.getPlugin("VirtualBackground")}init(){this.segmentProcess.on("segment-load",()=>{this.emit("segment-load")}),this.segmentProcess.init()}destroy(){this.segmentProcess.removeAllListeners(),this.segmentProcess.destroy()}setVirtualBackGround(c){this.bgOption=c;const{type:s}=c;switch(s){case"image":const{source:d}=c;if(typeof d=="object")this.setBackGround(d);else if(typeof d=="string")if(d.includes("data:image")){const u=new Image;u.onload=()=>{this.setBackGround(u)},u.src=d}else if(d.includes("http"))a.loadImage(d,u=>{this.setBackGround(u)});else{const u=new Image;u.onload=()=>{this.setBackGround(u)},u.src=d}break;case"color":this.setBackGround(c.color);break;case"blur":this.setBlurIntensity(c.level/10)}}setTrack(c,s){return new Promise((d,u)=>{this.videPostProcess.setTaskAndTrack("VirtualBackground",c,s).then(h=>{var o;c||(o=this.videPostProcess.filters)===null||o===void 0||o.virtualBackground.setMaskMap(null),d(h)}).catch(h=>{u(h)})})}setBackGround(c){var s;(s=this.videPostProcess.filters)===null||s===void 0||s.virtualBackground.setBackground(c)}setBlurIntensity(c){var s;(s=this.videPostProcess.filters)===null||s===void 0||s.virtualBackground.setBlurIntensity(c)}get isEnable(){return this.videPostProcess.hasTask("VirtualBackground")}set emptyFrame(c){this.videPostProcess.filters.virtualBackground.emptyFrame=c}}e.default=l},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.applyResolution=void 0,e.applyResolution=async function(i){const{track:a,targetWidth:l,targetHeight:n,keepAspectRatio:c,logger:s}=i;let d;if(d="getSettings"in MediaStreamTrack.prototype?a.getSettings():a.getConstraints(),d.width&&d.height)if(d.width!==l||d.height!==n){let u;c?(u={aspectRatio:d.width/d.height},d.width/d.height>=l/n?u.width=l:u.height=n):u={width:l,height:n},await a.applyConstraints(u),await new Promise(o=>{setTimeout(o,100)});const h=a.getSettings();d.width!==h.width||d.height!==h.height?s.log(`applyResolution 成功修改分辨率 保留长宽比：${c} ${d.width}x${d.height} => ${h.width}x${h.height} (constraints: ${JSON.stringify(u)})【${a.label}】`):s.warn(`applyResolution 无法修改分辨率为${l}x${n}，目前的分辨率：${d.width}x${d.height} (constraints: ${JSON.stringify(u)})【${a.label}】`)}else s.log(`applyResolution 无需修改分辨率 ${d.width}x${d.height} 【${a.label}】`);else s.log(`applyResolution 摄像头不支持动态修改分辨率 【${a.label}】`)}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.webassemblySupported=void 0,e.webassemblySupported=function(){try{if(typeof WebAssembly=="object"&&typeof WebAssembly.instantiate=="function"){const i=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(i instanceof WebAssembly.Module)return new WebAssembly.Instance(i)instanceof WebAssembly.Instance}}catch{return!1}return!1}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.AudioProfile=void 0,e.AudioProfile=["speech_low_quality","speech_standard","music_standard","standard_stereo","high_quality","high_quality_stereo"]},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.serverError=e.clientNotYetPublished=e.STREAM_HAS_NO_MEDIA_ATTRIBUTES=e.clientNotYetUninitialized=e.invalidArguments=e.ok=void 0,e.ok={name:"OK",code:200,desc:"success"},e.invalidArguments={name:"invalid arguments",code:1,desc:"请检查参数的有效性"},e.clientNotYetUninitialized={name:"client not yet uninitialized",code:2,desc:"请先调用createClient创建Client"},e.STREAM_HAS_NO_MEDIA_ATTRIBUTES={name:"STREAM_HAS_NO_MEDIA_ATTRIBUTES",code:10,desc:"stream不合法，没有audio、video或者screen属性"},e.clientNotYetPublished={name:"client not yet published",code:11,desc:"请先publish"},e.serverError={name:"server error code",code:414,desc:""}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.LIVE_STREAM_AUDIO_CODEC_PROFILE=e.LIVE_STREAM_AUDIO_SAMPLE_RATE=void 0,e.LIVE_STREAM_AUDIO_SAMPLE_RATE={SAMPLE_RATE_32000:32e3,SAMPLE_RATE_44100:44100,SAMPLE_RATE_48000:48e3},e.LIVE_STREAM_AUDIO_CODEC_PROFILE={LC_AAC:0,HE_AAC:1}},function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0}),e.NETWORK_STATUS=void 0,e.NETWORK_STATUS={0:"UNKNOWN",1:"EXCELLENT",2:"GOOD",3:"POOR",4:"BAD",5:"VERYBAD",6:"DOWN"}}])})})(NERTC$1);var NERTCExports=NERTC$1.exports;const NERTC=getDefaultExportFromCjs(NERTCExports),_export_sfc=(t,e)=>{const r=t.__vccOpts||t;for(const[i,a]of e)r[i]=a;return r},_hoisted_1={class:"main-container"},_hoisted_2={class:"poetry-sidebar"},_sfc_main={__name:"App",setup(t){const e=ref(""),r=ref(""),i=reactive({client:null});function a(){console.log("执行初始化操作"),i.client=NERTC.createClient({appkey:"4727023efa991d31d61b3b32e819bd5b",debug:!0})}function l(){console.log("加入房间操作"),i.client.join({channelName:e.value,uid:r.value,token:""}).then(d=>{console.info("加入房间成功..."),n()}),i.client.on("peer-online",d=>{console.log(`${d.uid} 加入房间`)}),i.client.on("stream-added",d=>{var u=d.stream;console.log("收到别人的发布消息: ",u.streamID,"mediaType: ",d.mediaType),u.setSubscribeConfig({audio:!0,audioSlave:!0,video:!0,screenShare:!0,highOrLow:NERTC.STREAM_TYPE.HIGH}),i.client.subscribe(u).then(()=>{console.log("发起订阅对端成功")})}),i.client.on("stream-subscribed",d=>{console.warn("订阅别人的流成功的通知");var u=d.stream;let h=document.getElementById("remote-container");const o=h.clientWidth,f=h.clientHeight;u.play(h).then(()=>{console.log("播放对端的流成功"),u.setRemoteRenderMode({width:o,height:f,cut:!0})})})}async function n(){var h,o;const d=await NERTC.getCameras(),u=await NERTC.getMicrophones();i.localStream=NERTC.createStream({uid:r.value,audio:!0,microphoneId:(h=u[0])==null?void 0:h.deviceId,video:!1,cameraId:(o=d[0])==null?void 0:o.deviceId}),i.localStream.init().then(()=>{let f=document.getElementById("local-container");const m=f.clientWidth,g=f.clientHeight;i.localStream.play(f),i.localStream.setLocalRenderMode({width:m,height:g,cut:!0}),i.client.publish(i.localStream).then(()=>{console.warn("本地 publish 成功")})})}async function c(){if(i.localStream.isPlaying("video"))console.log("=== 关闭视频"),i.localStream.close({type:"video"});else{console.log("=== 打开视频"),await i.localStream.open({type:"video"});let d=document.getElementById("local-container");const u=d.clientWidth,h=d.clientHeight;i.localStream.play(d),i.localStream.setLocalRenderMode({width:u,height:h,cut:!0})}}function s(){i.client.leave(),i.localStream.stop()}return(d,u)=>(openBlock(),createElementBlock("div",_hoisted_1,[createBaseVNode("div",_hoisted_2,[createBaseVNode("button",{onClick:a,class:"load-btn"},"初始化"),withDirectives(createBaseVNode("input",{"onUpdate:modelValue":u[0]||(u[0]=h=>e.value=h),placeholder:"请输入房间名",class:"sidebar-input"},null,512),[[vModelText,e.value]]),withDirectives(createBaseVNode("input",{"onUpdate:modelValue":u[1]||(u[1]=h=>r.value=h),placeholder:"请输入uid",class:"sidebar-input"},null,512),[[vModelText,r.value]]),createBaseVNode("button",{onClick:l,class:"load-btn"},"加入房间"),createBaseVNode("button",{onClick:c,class:"load-btn"},"开关视频"),createBaseVNode("button",{onClick:s,class:"load-btn"},"离开房间")]),u[2]||(u[2]=createBaseVNode("div",{class:"container"},[createBaseVNode("div",{class:"color-block1",id:"local-container"}),createBaseVNode("div",{class:"color-block2",id:"remote-container"})],-1))]))}},App=_export_sfc(_sfc_main,[["__scopeId","data-v-5cae4d95"]]);createApp(App).mount("#app");
